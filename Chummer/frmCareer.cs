/*  This file is part of Chummer5a.
 *
 *  Chummer5a is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  Chummer5a is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with Chummer5a.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  You can obtain the full source code for Chummer5a at
 *  https://github.com/chummer5a/chummer5a
 */
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Windows.Forms.DataVisualization.Charting;
using System.Windows.Forms;
using System.Xml;
using System.Xml.XPath;
using Chummer.Backend;
using Chummer.Backend.Equipment;
using Chummer.Skills;
using System.Drawing.Imaging;
using Chummer.UI.Attributes;
using System.Collections.ObjectModel;
using Chummer.Backend.Attributes;
using System.Collections.Specialized;
using System.Threading.Tasks;

namespace Chummer
{
    [DesignerCategory("Form")]
    public partial class frmCareer : CharacterShared
    {
        // Set the default culture to en-US so we work with decimals correctly.
        private bool _blnSkipRefresh = false;
        private bool _blnSkipUpdate = false;
        private bool _blnLoading = false;
        private bool _blnIsDirty = false;
        private bool _blnSkipToolStripRevert = false;
        private bool _blnReapplyImprovements = false;
        private bool _blnRequestCharacterUpdate = false;
        private int _intDragLevel = 0;
        private MouseButtons _objDragButton = new MouseButtons();
        private bool _blnDraggingGear = false;
        private List<TreeNode> lstExpandSpellCategories = new List<TreeNode>();
        ObservableCollection<CharacterAttrib> lstPrimaryAttributes = new ObservableCollection<CharacterAttrib>();
        ObservableCollection<CharacterAttrib> lstSpecialAttributes = new ObservableCollection<CharacterAttrib>();

        private readonly ListViewColumnSorter _lvwKarmaColumnSorter;
        private readonly ListViewColumnSorter _lvwNuyenColumnSorter;

        public Action<object> DiceRollerOpened;
        public Action<Chummer.Character, int> DiceRollerOpenedInt;

        #region Form Events
        [Obsolete("This constructor is for use by form designers only.", true)]
        public frmCareer() : base()
        {
            InitializeComponent();
        }
        public frmCareer(Character objCharacter) : base(objCharacter)
        {
            InitializeComponent();

            // Add EventHandlers for the MAG and RES enabled events and tab enabled events.
            _objCharacter.MAGEnabledChanged += objCharacter_MAGEnabledChanged;
            _objCharacter.RESEnabledChanged += objCharacter_RESEnabledChanged;
            _objCharacter.DEPEnabledChanged += objCharacter_DEPEnabledChanged;
            _objCharacter.AmbidextrousChanged += objCharacter_AmbidextrousChanged;
            _objCharacter.AdeptTabEnabledChanged += objCharacter_AdeptTabEnabledChanged;
            _objCharacter.MagicianTabEnabledChanged += objCharacter_MagicianTabEnabledChanged;
            _objCharacter.AdeptTabEnabledChanged += objCharacter_MagicianTabEnabledChanged;
            _objCharacter.TechnomancerTabEnabledChanged += objCharacter_TechnomancerTabEnabledChanged;
            _objCharacter.AdvancedProgramsTabEnabledChanged += objCharacter_AdvancedProgramsTabEnabledChanged;
            _objCharacter.CyberwareTabDisabledChanged += objCharacter_CyberwareTabDisabledChanged;
            _objCharacter.CritterTabEnabledChanged += objCharacter_CritterTabEnabledChanged;
            _objCharacter.FameChanged += objCharacter_FameChanged;

            tabPowerUc.ChildPropertyChanged += PowerPropertyChanged;
            tabSkillsUc.ChildPropertyChanged += SkillPropertyChanged;

            GlobalOptions.MRUChanged += PopulateMRU;
            GlobalOptions.MainForm.OpenCharacters.Add(_objCharacter);
            LanguageManager.Load(GlobalOptions.Language, this);

            ContextMenuStrip[] lstCMSToTranslate = new ContextMenuStrip[]
            {
                cmsAdvancedLifestyle,
                cmsAdvancedProgram,
                cmsAmmoExpense,
                cmsArmor,
                cmsArmorGear,
                cmsArmorLocation,
                cmsArmorMod,
                cmsBioware,
                cmsComplexForm,
                cmsComplexFormPlugin,
                cmsCritterPowers,
                cmsCyberware,
                cmsCyberwareGear,
                cmsDeleteArmor,
                cmsDeleteCyberware,
                cmsDeleteGear,
                cmsDeleteVehicle,
                cmsDeleteWeapon,
                cmsGear,
                cmsGearButton,
                cmsGearLocation,
                cmsGearPlugin,
                cmsImprovement,
                cmsImprovementLocation,
                cmsInitiationNotes,
                cmsLifestyle,
                cmsLifestyleNotes,
                cmsLimitModifier,
                cmsMartialArtManeuver,
                cmsMartialArts,
                cmsMetamagic,
                cmsQuality,
                cmsSpell,
                cmsSpellButton,
                cmsTechnique,
                cmsUndoKarmaExpense,
                cmsUndoNuyenExpense,
                cmsVehicle,
                cmsVehicleGear,
                cmsVehicleLocation,
                cmsVehicleWeapon,
                cmsVehicleWeaponAccessory,
                cmsVehicleWeaponAccessoryGear,
                cmsVehicleWeaponMod,
                cmsWeapon,
                cmsWeaponAccessory,
                cmsWeaponAccessoryGear,
                cmsWeaponLocation,
                cmsWeaponMod,
                cmsWeaponMount,
            };
            // Update the text in the Menus so they can be merged with frmMain properly.
            foreach (ToolStripMenuItem objItem in mnuCreateMenu.Items.OfType<ToolStripMenuItem>())
            {
                if (objItem.Tag != null)
                {
                    objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
                }
            }
            foreach (ContextMenuStrip objCMS in lstCMSToTranslate)
            {
                if (objCMS != null)
                {
                    foreach (ToolStripMenuItem objItem in objCMS.Items.OfType<ToolStripMenuItem>())
                    {
                        if (objItem.Tag != null)
                        {
                            objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
                        }
                    }
                }
            }

            _lvwKarmaColumnSorter = new ListViewColumnSorter();
            _lvwKarmaColumnSorter.SortColumn = 0;
            _lvwKarmaColumnSorter.Order = SortOrder.Descending;
            lstKarma.ListViewItemSorter = _lvwKarmaColumnSorter;
            _lvwNuyenColumnSorter = new ListViewColumnSorter();
            _lvwNuyenColumnSorter.SortColumn = 0;
            _lvwNuyenColumnSorter.Order = SortOrder.Descending;
            lstNuyen.ListViewItemSorter = _lvwNuyenColumnSorter;

            SetTooltips();
            MoveControls();
        }

        /// <summary>
        /// Set the form to Loading mode so that certain events do not fire while data is being populated.
        /// </summary>
        public bool Loading
        {
            set
            {
                _blnLoading = value;
            }
        }

        private void TreeView_MouseDown(object sender, MouseEventArgs e)
        {
            // Generic event for all TreeViews to allow right-clicking to select a TreeNode so the proper ContextMenu is shown.
            //if (e.Button == System.Windows.Forms.MouseButtons.Right)
            //{
                TreeView objTree = (TreeView)sender;
                objTree.SelectedNode = objTree.HitTest(e.X, e.Y).Node;
            //}
            if (ModifierKeys == Keys.Control)
            {
                if (!objTree.SelectedNode.IsExpanded)
                {
                    foreach (TreeNode objNode in objTree.SelectedNode.Nodes)
                    {
                        objNode.ExpandAll();
        }
                }
                else
                {
                    foreach (TreeNode objNode in objTree.SelectedNode.Nodes)
                    {
                        objNode.Collapse();
                    }
                }
            }
        }

        private void frmCareer_Load(object sender, EventArgs e)
        {
            Timekeeper.Finish("load_free");

            Timekeeper.Start("load_frm_career");
            _blnLoading = true;

            _objCharacter.PropertyChanged += _objCharacter_PropertyChanged;

            _objCharacter_PropertyChanged(null, null);

            tabPowerUc.ObjCharacter = _objCharacter;
            // Remove the Magician, Adept, and Technomancer tabs since they are not in use until the appropriate Quality is selected.
            if (!_objCharacter.MagicianEnabled && !_objCharacter.AdeptEnabled)
                tabCharacterTabs.TabPages.Remove(tabMagician);
            if (!_objCharacter.AdeptEnabled)
                tabCharacterTabs.TabPages.Remove(tabAdept);
            if (!_objCharacter.TechnomancerEnabled)
                tabCharacterTabs.TabPages.Remove(tabTechnomancer);
            if (!_objCharacter.AdvancedProgramsEnabled)
                tabCharacterTabs.TabPages.Remove(tabAdvancedPrograms);
            if (_objCharacter.CyberwareDisabled)
                tabCharacterTabs.TabPages.Remove(tabCyberware);
            if (!_objCharacter.CritterEnabled)
                tabCharacterTabs.TabPages.Remove(tabCritter);

            mnuSpecialAddBiowareSuite.Visible = _objCharacter.Options.AllowBiowareSuites;

            // Remove the Improvements Tab.
            //tabCharacterTabs.TabPages.Remove(tabImprovements);

            // Remove the Initiation tab if the character does not have access to MAG or RES.
            if (!_objCharacter.MAGEnabled && !_objCharacter.RESEnabled)
                tabCharacterTabs.TabPages.Remove(tabInitiation);
            else
            {
                if (_objCharacter.MAGEnabled)
                {
                    tabInitiation.Text = LanguageManager.GetString("Tab_Initiation");
                    tsMetamagicAddMetamagic.Text = LanguageManager.GetString("Button_AddMetamagic");
                    cmdAddMetamagic.Text = LanguageManager.GetString("Button_AddInitiateGrade");
                    chkJoinGroup.Text = LanguageManager.GetString("Checkbox_JoinedGroup");
                    chkJoinGroup.Checked = _objCharacter.GroupMember;
                    txtGroupName.Text = _objCharacter.GroupName;
                    txtGroupNotes.Text = _objCharacter.GroupNotes;
                    string strInitTip = LanguageManager.GetString("Tip_ImproveInitiateGrade").Replace("{0}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{1}", (_objOptions.KarmaInititationFlat + ((_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation)).ToString());
                    tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
                }
                else
                {
                    tabInitiation.Text = LanguageManager.GetString("Tab_Submersion");
                    tsMetamagicAddMetamagic.Text = LanguageManager.GetString("Button_AddEcho");
                    cmdAddMetamagic.Text = LanguageManager.GetString("Button_AddSubmersionGrade");
                    chkInitiationOrdeal.Text = LanguageManager.GetString("Checkbox_SubmersionTask");
                    chkInitiationGroup.Visible = false;
                    chkInitiationSchooling.Visible = false;
                    tsMetamagicAddArt.Visible = false;
                    tsMetamagicAddEnchantment.Visible = false;
                    tsMetamagicAddEnhancement.Visible = false;
                    tsMetamagicAddRitual.Visible = false;
                    treMetamagic.Top = cmdAddMetamagic.Top + cmdAddMetamagic.Height + 6;
                    cmdAddMetamagic.Left = treMetamagic.Left + treMetamagic.Width - cmdAddMetamagic.Width;
                    txtGroupName.Text = _objCharacter.GroupName;
                    txtGroupNotes.Text = _objCharacter.GroupNotes;
                    string strInitTip = LanguageManager.GetString("Tip_ImproveSubmersionGrade").Replace("{0}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{1}", (_objOptions.KarmaInititationFlat + ((_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation)).ToString());
                    tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
                }
            }

            // If the character has a mugshot, decode it and put it in the PictureBox.
            if (_objCharacter.Mugshots.Count > 0)
            {
                nudMugshotIndex.Minimum = 1;
                nudMugshotIndex.Maximum = _objCharacter.Mugshots.Count;
                decimal value = _objCharacter.MainMugshotIndex + 1;
                if (value > nudMugshotIndex.Maximum)
                {
                    value = nudMugshotIndex.Maximum;
            }
                nudMugshotIndex.Value = value;
            }
            else
            {
                nudMugshotIndex.Minimum = 0;
                nudMugshotIndex.Maximum = 0;
                nudMugshotIndex.Value = 0;
            }
            lblNumMugshots.Text = "/ " + _objCharacter.Mugshots.Count.ToString();

            // Populate character information fields.
            XmlDocument objMetatypeDoc = XmlManager.Load("metatypes.xml");
            XmlNode objMetatypeNode = objMetatypeDoc.SelectSingleNode("/chummer/metatypes/metatype[name = \"" + _objCharacter.Metatype + "\"]");
            if (objMetatypeNode == null)
            {
                objMetatypeDoc = XmlManager.Load("critters.xml");
                objMetatypeNode = objMetatypeDoc.SelectSingleNode("/chummer/metatypes/metatype[name = \"" + _objCharacter.Metatype + "\"]");
            }
            string strMetatype = objMetatypeNode["translate"]?.InnerText ?? _objCharacter.Metatype;
            string strBook = _objOptions.LanguageBookShort(objMetatypeNode["source"].InnerText);
            string strPage = objMetatypeNode["altpage"]?.InnerText ?? objMetatypeNode["page"].InnerText;

            if (!string.IsNullOrEmpty(_objCharacter.Metavariant))
            {
                objMetatypeNode = objMetatypeNode.SelectSingleNode("metavariants/metavariant[name = \"" + _objCharacter.Metavariant + "\"]");
                strMetatype += $" ({objMetatypeNode?["translate"]?.InnerText ?? _objCharacter.Metavariant})";

                strBook = _objOptions.LanguageBookShort(objMetatypeNode["source"].InnerText);
                strPage = objMetatypeNode["altpage"]?.InnerText ?? objMetatypeNode["page"].InnerText;
            }
            lblMetatype.Text = strMetatype;
            lblMetatypeSource.Text = strBook + " " + strPage;
            if (_objCharacter.Possessed)
                lblPossessed.Text = LanguageManager.GetString("String_Possessed");
            else
                lblPossessed.Visible = false;
            tipTooltip.SetToolTip(lblMetatypeSource, _objOptions.LanguageBookLong(objMetatypeNode["source"].InnerText) + " " + LanguageManager.GetString("String_Page") + " " + strPage);

            txtCharacterName.Text = _objCharacter.Name;
            txtSex.Text = _objCharacter.Sex;
            txtAge.Text = _objCharacter.Age;
            txtEyes.Text = _objCharacter.Eyes;
            txtHeight.Text = _objCharacter.Height;
            txtWeight.Text = _objCharacter.Weight;
            txtSkin.Text = _objCharacter.Skin;
            txtHair.Text = _objCharacter.Hair;
            txtDescription.Text = _objCharacter.Description;
            txtBackground.Text = _objCharacter.Background;
            txtConcept.Text = _objCharacter.Concept;
            txtNotes.Text = _objCharacter.Notes;
            txtAlias.Text = _objCharacter.Alias;
            txtPlayerName.Text = _objCharacter.PlayerName;
            txtGameNotes.Text = _objCharacter.GameNotes;
            nudStreetCred.Value = _objCharacter.StreetCred;
            nudNotoriety.Value = _objCharacter.Notoriety;
            nudPublicAware.Value = _objCharacter.PublicAwareness;

            // Check for Special Attributes.
            lblFoci.Visible = _objCharacter.MAGEnabled;
            treFoci.Visible = _objCharacter.MAGEnabled;
            cmdCreateStackedFocus.Visible = _objCharacter.MAGEnabled;

            if (_objCharacter.BuildMethod == CharacterBuildMethod.LifeModule)
            {
                treQualities.Nodes.Add(new TreeNode("Life Modules"));
            }

            RefreshQualities(treQualities,cmsQuality, true);

            objCharacter_AmbidextrousChanged();

            // Populate the Magician Traditions list.
            XmlDocument objXmlDocument = XmlManager.Load("traditions.xml");
            List<ListItem> lstTraditions = new List<ListItem>();
            foreach (XmlNode objXmlTradition in objXmlDocument.SelectNodes("/chummer/traditions/tradition[" + _objOptions.BookXPath() + "]"))
            {
                ListItem objItem = new ListItem();
                objItem.Value = objXmlTradition["name"].InnerText;
                objItem.Name = objXmlTradition["translate"]?.InnerText ?? objXmlTradition["name"].InnerText;
                lstTraditions.Add(objItem);
            }
            SortListItem objSort = new SortListItem();
            lstTraditions.Sort(objSort.Compare);
            ListItem objBlank = new ListItem();
            objBlank.Value = "None";
            objBlank.Name = LanguageManager.GetString("String_None");
            lstTraditions.Insert(0, objBlank);
            cboTradition.BeginUpdate();
            cboTradition.ValueMember = "Value";
            cboTradition.DisplayMember = "Name";
            cboTradition.DataSource = lstTraditions;
            cboTradition.EndUpdate();

            // Populate the Magician Custom Drain Options list.
            objXmlDocument = XmlManager.Load("traditions.xml");
            List<ListItem> lstDrainAttributes = new List<ListItem>();
            ListItem objDrainBlank = new ListItem();
            objDrainBlank.Value = string.Empty;
            objDrainBlank.Name = string.Empty;
            lstDrainAttributes.Add(objDrainBlank);
            foreach (XmlNode objXmlDrain in objXmlDocument.SelectNodes("/chummer/drainattributes/drainattribute"))
            {
                ListItem objItem = new ListItem();
                objItem.Value = objXmlDrain["name"].InnerText;
                objItem.Name = objXmlDrain["translate"]?.InnerText ?? objXmlDrain["name"].InnerText;
                lstDrainAttributes.Add(objItem);
            }
            SortListItem objDrainSort = new SortListItem();
            lstDrainAttributes.Sort(objDrainSort.Compare);
            cboDrain.BeginUpdate();
            cboDrain.ValueMember = "Value";
            cboDrain.DisplayMember = "Name";
            cboDrain.DataSource = lstDrainAttributes;
            cboDrain.EndUpdate();

            HashSet<string> limit = new HashSet<string>();
            foreach (Improvement improvement in _objCharacter.Improvements.Where(improvement => improvement.ImproveType == Improvement.ImprovementType.LimitSpiritCategory))
            {
                limit.Add(improvement.ImprovedName);
            }

            // Populate the Magician Custom Spirits lists - Combat.
            objXmlDocument = XmlManager.Load("traditions.xml");
            List<ListItem> lstSpirit = new List<ListItem>();
            ListItem objSpiritBlank = new ListItem();
            objSpiritBlank.Value = string.Empty;
            objSpiritBlank.Name = string.Empty;
            lstSpirit.Add(objSpiritBlank);
            foreach (XmlNode objXmlSpirit in objXmlDocument.SelectNodes("/chummer/spirits/spirit"))
            {
                if (limit.Count > 0 && limit.Contains(objXmlSpirit["name"].InnerText) || limit.Count == 0)
                {
                    ListItem objItem = new ListItem();
                    objItem.Value = objXmlSpirit["name"].InnerText;
                    if (objXmlSpirit["translate"] != null)
                        objItem.Name = objXmlSpirit["translate"].InnerText;
                    else
                        objItem.Name = objXmlSpirit["name"].InnerText;
                    lstSpirit.Add(objItem);
                }
            }
            SortListItem objSpiritSort = new SortListItem();
            lstSpirit.Sort(objSpiritSort.Compare);

            List<ListItem> lstCombat = new List<ListItem>(lstSpirit);
            cboSpiritCombat.BeginUpdate();
            cboSpiritCombat.ValueMember = "Value";
            cboSpiritCombat.DisplayMember = "Name";
            cboSpiritCombat.DataSource = lstCombat;
            cboSpiritCombat.EndUpdate();

            List<ListItem> lstDetection = new List<ListItem>(lstSpirit);
            cboSpiritDetection.BeginUpdate();
            cboSpiritDetection.ValueMember = "Value";
            cboSpiritDetection.DisplayMember = "Name";
            cboSpiritDetection.DataSource = lstDetection;
            cboSpiritDetection.EndUpdate();

            List<ListItem> lstHealth = new List<ListItem>(lstSpirit);
            cboSpiritHealth.BeginUpdate();
            cboSpiritHealth.ValueMember = "Value";
            cboSpiritHealth.DisplayMember = "Name";
            cboSpiritHealth.DataSource = lstHealth;
            cboSpiritHealth.EndUpdate();

            List<ListItem> lstIllusion = new List<ListItem>(lstSpirit);
            cboSpiritIllusion.BeginUpdate();
            cboSpiritIllusion.ValueMember = "Value";
            cboSpiritIllusion.DisplayMember = "Name";
            cboSpiritIllusion.DataSource = lstIllusion;
            cboSpiritIllusion.EndUpdate();

            List<ListItem> lstManip = new List<ListItem>(lstSpirit);
            cboSpiritManipulation.BeginUpdate();
            cboSpiritManipulation.ValueMember = "Value";
            cboSpiritManipulation.DisplayMember = "Name";
            cboSpiritManipulation.DataSource = lstManip;
            cboSpiritManipulation.EndUpdate();

            // Populate the Technomancer Streams list.
            objXmlDocument = XmlManager.Load("streams.xml");
            List<ListItem> lstStreams = new List<ListItem>
            {
                objBlank
            };
            foreach (XmlNode objXmlTradition in objXmlDocument.SelectNodes("/chummer/traditions/tradition[" + _objOptions.BookXPath() + "]"))
            {
                ListItem objItem = new ListItem();
                objItem.Value = objXmlTradition["name"].InnerText;
                objItem.Name = objXmlTradition["translate"]?.InnerText ?? objXmlTradition["name"].InnerText;
                lstStreams.Add(objItem);
            }
            lstStreams.Sort(objSort.Compare);
            cboStream.BeginUpdate();
            cboStream.ValueMember = "Value";
            cboStream.DisplayMember = "Name";
            cboStream.DataSource = lstStreams;
            cboStream.EndUpdate();

			cboAttributeCategory.Visible = _objCharacter.MetatypeCategory == "Shapeshifter";
			if (_objCharacter.MetatypeCategory == "Shapeshifter")
			{
				XmlDocument objDoc = XmlManager.Load("metatypes.xml");
				List<ListItem> lstAttributeCategories = new List<ListItem>();
				XmlNode node = objDoc.SelectSingleNode($"/chummer/metatypes/metatype[name = \"{_objCharacter.Metatype}\"]");
				ListItem objItem = new ListItem();
				objItem.Value = "Shapeshifter";
				objItem.Name = node["name"].Attributes["translate"] != null
					? node["name"].Attributes["translate"].InnerText
					: node["name"].InnerText;
				lstAttributeCategories.Add(objItem);
				
				node = objDoc.SelectSingleNode($"/chummer/metatypes/metatype[name = \"{_objCharacter.Metatype}\"]/metavariants/metavariant[name = \"{_objCharacter.Metavariant}\"]");

				objItem = new ListItem();
				objItem.Value = "Standard";
				objItem.Name = node["name"].Attributes["translate"] != null
					? node["name"].Attributes["translate"].InnerText
					: node["name"].InnerText;
				lstAttributeCategories.Add(objItem);

				lstAttributeCategories.Sort(objSort.Compare);
				cboAttributeCategory.BeginUpdate();
				cboAttributeCategory.ValueMember = "Value";
				cboAttributeCategory.DisplayMember = "Name";
				cboAttributeCategory.DataSource = lstAttributeCategories;
				cboAttributeCategory.EndUpdate();
				cboAttributeCategory.SelectedValue = "Standard";
			}

            // If the character is a Mystic Adept, set the values for the Mystic Adept NUD.
            if (_objCharacter.IsMysticAdept && !_objOptions.MysAdeptSecondMAGAttribute)
            {
                lblMysticAdeptMAGAdept.Text = _objCharacter.MysticAdeptPowerPoints.ToString();

                lblMysticAdeptAssignment.Visible = true;
                lblMysticAdeptMAGAdept.Visible = true;
                cmdIncreasePowerPoints.Visible = _objOptions.MysaddPPCareer;
            }
            else
                cmdIncreasePowerPoints.Visible = false;

            // Counter to keep track of the number of Controls that have been added to the Panel so we can determine their vertical positioning.
            int i = -1;
            
            // Populate Contacts and Enemies.
            int intContact = -1;
            int intEnemy = -1;
            foreach (Contact objContact in _objCharacter.Contacts)
            {
                if (objContact.EntityType == ContactType.Contact)
                {
                    intContact++;
                    ContactControl objContactControl = new ContactControl(_objCharacter);
                    // Attach an EventHandler for the ConnectionRatingChanged, LoyaltyRatingChanged, DeleteContact, and FileNameChanged Events.
                    objContactControl.ConnectionRatingChanged += objContact_ConnectionRatingChanged;
                    objContactControl.LoyaltyRatingChanged += objContact_LoyaltyRatingChanged;
                    objContactControl.DeleteContact += objContact_DeleteContact;
                    objContactControl.FileNameChanged += objContact_FileNameChanged;
                    objContactControl.FreeRatingChanged += objContact_OtherCostChanged;
                    objContactControl.MouseDown += panContactControl_MouseDown;
                    objContactControl.FamilyChanged += objContact_OtherCostChanged;
                    objContactControl.BlackmailChanged += objContact_OtherCostChanged;
                    
                    objContactControl.ContactObject = objContact;

                    objContactControl.Top = intContact * objContactControl.Height;
                    panContacts.Controls.Add(objContactControl);
                }
                if (objContact.EntityType == ContactType.Enemy)
                {
                    intEnemy++;
                    ContactControl objContactControl = new ContactControl(_objCharacter);
                    // Attach an EventHandler for the ConnectioNRatingChanged, LoyaltyRatingChanged, DeleteContact, and FileNameChanged Events.
                    objContactControl.ConnectionRatingChanged += objEnemy_ConnectionRatingChanged;
                    objContactControl.LoyaltyRatingChanged += objEnemy_LoyaltyRatingChanged;
                    objContactControl.DeleteContact += objEnemy_DeleteContact;
                    objContactControl.FileNameChanged += objEnemy_FileNameChanged;
                    objContactControl.FreeRatingChanged += objEnemy_FreeStatusChanged;
                    
                    objContactControl.ContactObject = objContact;

                    objContactControl.Top = intEnemy * objContactControl.Height;
                    panEnemies.Controls.Add(objContactControl);
                }
                if (objContact.EntityType == ContactType.Pet)
                {
                    PetControl objContactControl = new PetControl();
                    // Attach an EventHandler for the DeleteContact and FileNameChanged Events.
                    objContactControl.DeleteContact += objPet_DeleteContact;
                    objContactControl.FileNameChanged += objPet_FileNameChanged;

                    objContactControl.ContactObject = objContact;
                    objContactControl.ContactName = objContact.Name;
                    objContactControl.BackColor = objContact.Colour;

                    panPets.Controls.Add(objContactControl);
                }
            }

            // Populate Armor.
            // Start by populating Locations.
            foreach (string strLocation in _objCharacter.ArmorBundles)
            {
                TreeNode objLocation = new TreeNode();
                objLocation.Tag = strLocation;
                objLocation.Text = strLocation;
                objLocation.ContextMenuStrip = cmsArmorLocation;
                treArmor.Nodes.Add(objLocation);
            }
            foreach (Armor objArmor in _objCharacter.Armor)
            {
                CommonFunctions.CreateArmorTreeNode(objArmor, treArmor, cmsArmor, cmsArmorMod, cmsArmorGear);
            }

            // Populate Weapons.
            // Start by populating Locations.
            foreach (string strLocation in _objCharacter.WeaponLocations)
            {
                TreeNode objLocation = new TreeNode();
                objLocation.Tag = strLocation;
                objLocation.Text = strLocation;
                objLocation.ContextMenuStrip = cmsWeaponLocation;
                treWeapons.Nodes.Add(objLocation);
            }
            foreach (Weapon objWeapon in _objCharacter.Weapons)
            {
                CommonFunctions.CreateWeaponTreeNode(objWeapon, treWeapons.Nodes[0], cmsWeapon, cmsWeaponAccessory, cmsWeaponAccessoryGear);
            }

            PopulateCyberware();

            // Populate Spell list.
            foreach (Spell objSpell in _objCharacter.Spells)
            {
                TreeNode objNode = new TreeNode();
                objNode.Text = objSpell.DisplayName;
                objNode.Tag = objSpell.InternalId;
                objNode.ContextMenuStrip = cmsSpell;
                if (!string.IsNullOrEmpty(objSpell.Notes))
                    objNode.ForeColor = Color.SaddleBrown;
                objNode.ToolTipText = CommonFunctions.WordWrap(objSpell.Notes, 100);

                switch (objSpell.Category)
                {
                    case "Combat":
                        treSpells.Nodes[0].Nodes.Add(objNode);
                        treSpells.Nodes[0].Expand();
                        break;
                    case "Detection":
                        treSpells.Nodes[1].Nodes.Add(objNode);
                        treSpells.Nodes[1].Expand();
                        break;
                    case "Health":
                        treSpells.Nodes[2].Nodes.Add(objNode);
                        treSpells.Nodes[2].Expand();
                        break;
                    case "Illusion":
                        treSpells.Nodes[3].Nodes.Add(objNode);
                        treSpells.Nodes[3].Expand();
                        break;
                    case "Manipulation":
                        treSpells.Nodes[4].Nodes.Add(objNode);
                        treSpells.Nodes[4].Expand();
                        break;
                    case "Rituals":
                        /*
                        int intNode = 5;
                        if (_objCharacter.AdeptEnabled && !_objCharacter.MagicianEnabled)
                            intNode = 0;
                        treSpells.Nodes[intNode].Nodes.Add(objNode);
                        treSpells.Nodes[intNode].Expand();
                        */
                        treSpells.Nodes[5].Nodes.Add(objNode);
                        treSpells.Nodes[5].Expand();
                        break;
                    case "Enchantments":
                        treSpells.Nodes[6].Nodes.Add(objNode);
                        treSpells.Nodes[6].Expand();
                        break;
                }
            }

            // Populate Magician Spirits.
            i = -1;
            foreach (Spirit objSpirit in _objCharacter.Spirits)
            {
                if (objSpirit.EntityType == SpiritType.Spirit)
                {
                    i++;
                    SpiritControl objSpiritControl = new SpiritControl(true);
                    objSpiritControl.SpiritObject = objSpirit;

                    // Attach an EventHandler for the ServicesOwedChanged Event.
                    objSpiritControl.ServicesOwedChanged += objSpirit_ServicesOwedChanged;
                    objSpiritControl.ForceChanged += objSpirit_ForceChanged;
                    objSpiritControl.BoundChanged += objSpirit_BoundChanged;
                    objSpiritControl.FetteredChanged += objSpirit_FetteredChanged;
                    objSpiritControl.DeleteSpirit += objSpirit_DeleteSpirit;
                    objSpiritControl.FileNameChanged += objSpirit_FileNameChanged;

                    objSpiritControl.SpiritName = objSpirit.Name;
                    objSpiritControl.ServicesOwed = objSpirit.ServicesOwed;
                    int intMAG = 0;
                    if (_objOptions.SpiritForceBasedOnTotalMAG)
                        intMAG = _objCharacter.MAG.TotalValue;
                    else
                        intMAG = _objCharacter.MAG.Value;
                    objSpiritControl.ForceMaximum = intMAG * 2;
                    objSpiritControl.CritterName = objSpirit.CritterName;
                    objSpiritControl.Force = objSpirit.Force;
                    objSpiritControl.Bound = objSpirit.Bound;
                    objSpiritControl.RebuildSpiritList(_objCharacter.MagicTradition);

                    objSpiritControl.Top = i * objSpiritControl.Height;
                    panSpirits.Controls.Add(objSpiritControl);
                }
            }


            // Populate Technomancer Sprites.
            i = -1;
            foreach (Spirit objSpirit in _objCharacter.Spirits)
            {
                if (objSpirit.EntityType == SpiritType.Sprite)
                {
                    i++;
                    SpiritControl objSpiritControl = new SpiritControl(true);
                    objSpiritControl.SpiritObject = objSpirit;
                    objSpiritControl.EntityType = SpiritType.Sprite;

                    // Attach an EventHandler for the ServicesOwedChanged Event.
                    objSpiritControl.ServicesOwedChanged += objSprite_ServicesOwedChanged;
                    objSpiritControl.ForceChanged += objSprite_ForceChanged;
                    objSpiritControl.BoundChanged += objSprite_BoundChanged;
                    objSpiritControl.DeleteSpirit += objSprite_DeleteSpirit;
                    objSpiritControl.FileNameChanged += objSprite_FileNameChanged;

                    objSpiritControl.SpiritName = objSpirit.Name;
                    objSpiritControl.ServicesOwed = objSpirit.ServicesOwed;
                    objSpiritControl.ForceMaximum = _objCharacter.RES.TotalValue * 2;
                    objSpiritControl.CritterName = objSpirit.CritterName;
                    objSpiritControl.Force = objSpirit.Force;
                    objSpiritControl.Bound = objSpirit.Bound;
                    objSpiritControl.RebuildSpiritList(_objCharacter.TechnomancerStream);

                    objSpiritControl.Top = i * objSpiritControl.Height;
                    panSprites.Controls.Add(objSpiritControl);
                }
            }

            // Populate Technomancer Complex Forms/Programs.
            foreach (ComplexForm objProgram in _objCharacter.ComplexForms)
            {
                TreeNode objNode = new TreeNode();
                objNode.Text = objProgram.DisplayName;
                objNode.Tag = objProgram.InternalId;
                if (!string.IsNullOrEmpty(objProgram.Notes))
                    objNode.ForeColor = Color.SaddleBrown;
                objNode.ToolTipText = CommonFunctions.WordWrap(objProgram.Notes, 100);
                treComplexForms.Nodes[0].Nodes.Add(objNode);
                treComplexForms.Nodes[0].Expand();
            }

            // Populate AI Programs and Advanced Programs.
            foreach (AIProgram objProgram in _objCharacter.AIPrograms)
            {
                TreeNode objNode = new TreeNode();
                objNode.Text = objProgram.DisplayName;
                objNode.Tag = objProgram.InternalId;
                if (!string.IsNullOrEmpty(objProgram.Notes))
                    objNode.ForeColor = Color.SaddleBrown;
                else if (!objProgram.CanDelete)
                    objNode.ForeColor = SystemColors.GrayText;
                else
                    objNode.ForeColor = SystemColors.WindowText;
                objNode.ToolTipText = CommonFunctions.WordWrap(objProgram.Notes, 100);
                objNode.ContextMenuStrip = cmsAdvancedProgram;
                treAIPrograms.Nodes[0].Nodes.Add(objNode);
                treAIPrograms.Nodes[0].Expand();
            }

            // Populate Martial Arts.
            foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
            {
                TreeNode objMartialArtNode = new TreeNode();
                objMartialArtNode.Text = objMartialArt.DisplayName;
                objMartialArtNode.Tag = objMartialArt.InternalId;
                objMartialArtNode.ContextMenuStrip = cmsMartialArts;
                if (!string.IsNullOrEmpty(objMartialArt.Notes))
                    objMartialArtNode.ForeColor = Color.SaddleBrown;
                objMartialArtNode.ToolTipText = CommonFunctions.WordWrap(objMartialArt.Notes, 100);

                foreach (MartialArtAdvantage objAdvantage in objMartialArt.Advantages)
                {
                    TreeNode objAdvantageNode = new TreeNode();
                    objAdvantageNode.Text = objAdvantage.DisplayName;
                    objAdvantageNode.Tag = objAdvantage.InternalId;
                    objAdvantageNode.ContextMenuStrip = cmsTechnique;

                    if (!string.IsNullOrEmpty(objAdvantage.Notes))
                        objAdvantageNode.ForeColor = Color.SaddleBrown;
                    else
                        objAdvantageNode.ForeColor = SystemColors.WindowText;

                    objAdvantageNode.ToolTipText = CommonFunctions.WordWrap(objAdvantage.Notes, 100);
                    objMartialArtNode.Nodes.Add(objAdvantageNode);
                    objMartialArtNode.Expand();
                }

                treMartialArts.Nodes[0].Nodes.Add(objMartialArtNode);
                treMartialArts.Nodes[0].Expand();
            }

            // Populate Martial Art Maneuvers.
            foreach (MartialArtManeuver objManeuver in _objCharacter.MartialArtManeuvers)
            {
                TreeNode objManeuverNode = new TreeNode();
                objManeuverNode.Text = objManeuver.DisplayName;
                objManeuverNode.Tag = objManeuver.InternalId;
                objManeuverNode.ContextMenuStrip = cmsMartialArtManeuver;
                if (!string.IsNullOrEmpty(objManeuver.Notes))
                    objManeuverNode.ForeColor = Color.SaddleBrown;
                objManeuverNode.ToolTipText = CommonFunctions.WordWrap(objManeuver.Notes, 100);

                treMartialArts.Nodes[1].Nodes.Add(objManeuverNode);
                treMartialArts.Nodes[1].Expand();
            }

            // Populate Limit Modifiers.
            foreach (LimitModifier objLimitModifier in _objCharacter.LimitModifiers)
            {
                TreeNode objLimitModifierNode = new TreeNode();
                objLimitModifierNode.Text = objLimitModifier.DisplayName;
                objLimitModifierNode.Tag = objLimitModifier.Name;
                objLimitModifierNode.ContextMenuStrip = cmsMartialArts;
                if (!string.IsNullOrEmpty(objLimitModifier.Notes))
                    objLimitModifierNode.ForeColor = Color.SaddleBrown;
                objLimitModifierNode.ToolTipText = CommonFunctions.WordWrap(objLimitModifier.Notes, 100);
                objLimitModifierNode.ContextMenuStrip = cmsLimitModifier;

                switch (objLimitModifier.Limit)
                {
                    case "Physical":
                        treLimit.Nodes[0].Nodes.Add(objLimitModifierNode);
                        treLimit.Nodes[0].Expand();
                        break;
                    case "Mental":
                        treLimit.Nodes[1].Nodes.Add(objLimitModifierNode);
                        treLimit.Nodes[1].Expand();
                        break;
                    case "Social":
                        treLimit.Nodes[2].Nodes.Add(objLimitModifierNode);
                        treLimit.Nodes[2].Expand();
                        break;
                }
            }

            // Populate Lifestyles.
            foreach (Lifestyle objLifestyle in _objCharacter.Lifestyles)
            {
                TreeNode objLifestyleNode = new TreeNode();
                objLifestyleNode.Text = objLifestyle.DisplayName;
                objLifestyleNode.Tag = objLifestyle.InternalId;
                if (objLifestyle.StyleType.ToString() != "Standard")
                    objLifestyleNode.ContextMenuStrip = cmsAdvancedLifestyle;
                else
                    objLifestyleNode.ContextMenuStrip = cmsLifestyleNotes;
                if (!string.IsNullOrEmpty(objLifestyle.Notes))
                    objLifestyleNode.ForeColor = Color.SaddleBrown;
                objLifestyleNode.ToolTipText = CommonFunctions.WordWrap(objLifestyle.Notes, 100);
                treLifestyles.Nodes[0].Nodes.Add(objLifestyleNode);
            }
            treLifestyles.Nodes[0].Expand();

            PopulateGearList();

            // Populate Foci.
            CommonFunctions.PopulateFocusList(_objCharacter, treFoci);

            // Populate Vehicles.
            foreach (Vehicle objVehicle in _objCharacter.Vehicles)
            {
                CommonFunctions.CreateVehicleTreeNode(objVehicle, treVehicles, cmsVehicle, cmsVehicleLocation, cmsVehicleWeapon, cmsVehicleWeaponAccessory, cmsVehicleWeaponAccessoryGear, cmsVehicleGear, cmsWeaponMount);
            }

            UpdateInitiationGradeTree();

            if (!string.IsNullOrEmpty(_objCharacter.MagicTradition))
            {
                objXmlDocument = XmlManager.Load("traditions.xml");
                XmlNode objXmlTradition = objXmlDocument.SelectSingleNode("/chummer/traditions/tradition[name = \"" + _objCharacter.MagicTradition + "\"]");
                lblDrainAttributes.Text = objXmlTradition["drain"].InnerText;
                string strDrainAtt = _objCharacter.TraditionDrain;
                
                StringBuilder objDrain = new StringBuilder(strDrainAtt);
                foreach (string strAttribute in AttributeSection.AttributeStrings)
                {
                    CharacterAttrib objAttrib = _objCharacter.GetAttribute(strAttribute);
                    objDrain.CheapReplace(strDrainAtt, objAttrib.Abbrev, () => objAttrib.TotalValue.ToString());
                }
                string strDrain = objDrain.ToString();
                if (string.IsNullOrEmpty(strDrain))
                {
                    strDrain = "0";
                }

                // Add any Improvements for Drain Resistance.
                int intDrain = Convert.ToInt32(CommonFunctions.EvaluateInvariantXPath(strDrain)) + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DrainResistance);
                lblDrainAttributesValue.Text = intDrain.ToString();
            }

            if (!string.IsNullOrEmpty(_objCharacter.TechnomancerStream))
            {
                objXmlDocument = XmlManager.Load("streams.xml");
                XmlNode objXmlTradition = objXmlDocument.SelectSingleNode("/chummer/traditions/tradition[name = \"" + _objCharacter.TechnomancerStream + "\"]");
                lblFadingAttributes.Text = objXmlTradition["drain"].InnerText;

                // Update the Fading CharacterAttribute Value.
                string strDrainAtt = _objCharacter.TechnomancerFading;
                
                StringBuilder objDrain = new StringBuilder(strDrainAtt);
                foreach (string strAttribute in AttributeSection.AttributeStrings)
                {
                    CharacterAttrib objAttrib = _objCharacter.GetAttribute(strAttribute);
                    objDrain.CheapReplace(strDrainAtt, objAttrib.Abbrev, () => objAttrib.TotalValue.ToString());
                }
                string strFading = objDrain.ToString();
                if (string.IsNullOrEmpty(strFading))
                {
                    strFading = "0";
                }
                int intFading = 0;
                try
                {
                    intFading = Convert.ToInt32(CommonFunctions.EvaluateInvariantXPath(strFading).ToString());
                }
                catch (XPathException) { }
                intFading += ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.FadingResistance);
                lblFadingAttributesValue.Text = intFading.ToString();
            }

            RefreshCritterPowers(treCritterPowers, cmsCritterPowers);

            _blnLoading = false;

            // Select the Magician's Tradition.
            if (!string.IsNullOrEmpty(_objCharacter.MagicTradition))
                cboTradition.SelectedValue = _objCharacter.MagicTradition;

            if (!string.IsNullOrEmpty(_objCharacter.TraditionName))
                txtTraditionName.Text = _objCharacter.TraditionName;

            if (!string.IsNullOrEmpty(_objCharacter.TraditionDrain))
                cboDrain.SelectedValue = _objCharacter.TraditionDrain;

            if (!string.IsNullOrEmpty(_objCharacter.SpiritCombat))
                cboSpiritCombat.SelectedValue = _objCharacter.SpiritCombat;

            if (!string.IsNullOrEmpty(_objCharacter.SpiritDetection))
                cboSpiritDetection.SelectedValue = _objCharacter.SpiritDetection;

            if (!string.IsNullOrEmpty(_objCharacter.SpiritHealth))
                cboSpiritHealth.SelectedValue = _objCharacter.SpiritHealth;

            if (!string.IsNullOrEmpty(_objCharacter.SpiritIllusion))
                cboSpiritIllusion.SelectedValue = _objCharacter.SpiritIllusion;

            if (!string.IsNullOrEmpty(_objCharacter.SpiritManipulation))
                cboSpiritManipulation.SelectedValue = _objCharacter.SpiritManipulation;

            // Update the Fading CharacterAttribute Value.
            if (_objCharacter.RESEnabled)
            {
                // Select the Technomancer's Stream.
                if (!string.IsNullOrEmpty(_objCharacter.TechnomancerStream))
                    cboStream.SelectedValue = _objCharacter.TechnomancerStream;
            }

            treGear.ItemDrag += treGear_ItemDrag;
            treGear.DragEnter += treGear_DragEnter;
            treGear.DragDrop += treGear_DragDrop;

            treLifestyles.ItemDrag += treLifestyles_ItemDrag;
            treLifestyles.DragEnter += treLifestyles_DragEnter;
            treLifestyles.DragDrop += treLifestyles_DragDrop;

            treArmor.ItemDrag += treArmor_ItemDrag;
            treArmor.DragEnter += treArmor_DragEnter;
            treArmor.DragDrop += treArmor_DragDrop;

            treWeapons.ItemDrag += treWeapons_ItemDrag;
            treWeapons.DragEnter += treWeapons_DragEnter;
            treWeapons.DragDrop += treWeapons_DragDrop;

            treVehicles.ItemDrag += treVehicles_ItemDrag;
            treVehicles.DragEnter += treVehicles_DragEnter;
            treVehicles.DragDrop += treVehicles_DragDrop;

            treImprovements.ItemDrag += treImprovements_ItemDrag;
            treImprovements.DragEnter += treImprovements_DragEnter;
            treImprovements.DragDrop += treImprovements_DragDrop;

            // Merge the ToolStrips.
            ToolStripManager.RevertMerge("toolStrip");
            ToolStripManager.Merge(toolStrip, "toolStrip");

            mnuSpecialConvertToFreeSprite.Visible = _objCharacter.IsSprite;

            if (_objCharacter.MetatypeCategory == "Cyberzombie")
                mnuSpecialCyberzombie.Visible = false;

            // Determine if the Critter should have access to the Possession menu item.
            bool blnAllowPossession = false;
            foreach (CritterPower objCritterPower in _objCharacter.CritterPowers)
            {
                if (objCritterPower.Name == "Inhabitation" || objCritterPower.Name == "Possession")
                {
                    blnAllowPossession = true;
                    break;
                }
            }
            mnuSpecialPossess.Visible = blnAllowPossession;

            tabSkillsUc.ObjCharacter = _objCharacter;

            // Set the visibility of the Armor Degradation buttons.
            cmdArmorDecrease.Visible = _objOptions.ArmorDegradation;
            cmdArmorIncrease.Visible = _objOptions.ArmorDegradation;

            treCyberware.SortCustom();
            treSpells.SortCustom();
            treComplexForms.SortCustom();
            treAIPrograms.SortCustom();
            treQualities.SortCustom();
            treCritterPowers.SortCustom();
            treMartialArts.SortCustom();
            UpdateMentorSpirits();
            UpdateInitiationGradeTree();
            PopulateCalendar();
            RefreshImprovements();

            ScheduleCharacterUpdate();
            // Directly calling here so that we can properly unset the dirty flag after the update
            UpdateCharacterInfo();

            lstPrimaryAttributes.CollectionChanged += AttributeCollectionChanged;
            lstSpecialAttributes.CollectionChanged += AttributeCollectionChanged;
            BuildAttributePanel();

            // Hacky, but necessary
            // UpdateCharacterInfo() needs to be run before BuildAttributesPanel() so that it can properly regenerate Essence Loss improvements based on options...
            // ...but BuildAttributePanel() ends up requesting a character update when it sets up the values of attribute NumericalUpDowns
            _blnRequestCharacterUpdate = false;

            // Now we can start checking for character updates
            Application.Idle += UpdateCharacterInfo;

            // Clear the Dirty flag which gets set when creating a new Character.
            _blnIsDirty = false;
            UpdateWindowTitle(false);
            RefreshPasteStatus();
            picMugshot_SizeChanged(sender, e);
            // Stupid hack to get the MDI icon to show up properly.
            Icon = Icon.Clone() as Icon;
            Timekeeper.Finish("load_frm_career");
            Timekeeper.Finish("loading");

            if (_objCharacter.InternalIdsNeedingReapplyImprovements.Count > 0)
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_ImprovementLoadError"),
                    LanguageManager.GetString("MessageTitle_ImprovementLoadError"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                {
                    DoReapplyImprovements(_objCharacter.InternalIdsNeedingReapplyImprovements);
                    _objCharacter.InternalIdsNeedingReapplyImprovements.Clear();
                }
            }
        }

        private void _objCharacter_PropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            //Self implemented one way databinding workaround. Ugly and should probably be done in a better way. (One day...)
            switch (e?.PropertyName)
            {
                case null:
                case nameof(Character.Karma):
                    tssKarma.Text = _objCharacter.Karma.ToString();
                    break;
            }
        }

        private void AttributeCollectionChanged(object sender, NotifyCollectionChangedEventArgs notifyCollectionChangedEventArgs)
        {
            switch (notifyCollectionChangedEventArgs.Action)
            {
                case NotifyCollectionChangedAction.Add:
                    foreach (CharacterAttrib objAttrib in notifyCollectionChangedEventArgs.NewItems)
                    {
                        AttributeControl objControl = new AttributeControl(objAttrib);
                        objControl.ValueChanged += objAttribute_ValueChanged;
                        pnlAttributes.Controls.Add(objControl);
                    }
                    break;
                case NotifyCollectionChangedAction.Remove:
                    foreach (CharacterAttrib objAttrib in notifyCollectionChangedEventArgs.OldItems)
                    {
                        foreach (AttributeControl objControl in pnlAttributes.Controls)
                        {
                            if (objControl.AttributeName == objAttrib.Abbrev)
                            {
                                objControl.ValueChanged -= objAttribute_ValueChanged;
                                pnlAttributes.Controls.Remove(objControl);
                                objControl.Dispose();
                            }
                        }
                    }
                    break;
            }
        }

        private void frmCareer_FormClosing(object sender, FormClosingEventArgs e)
        {
            // If there are unsaved changes to the character, as the user if they would like to save their changes.
            if (_blnIsDirty)
            {
                string strCharacterName = _objCharacter.Alias;
                if (string.IsNullOrWhiteSpace(strCharacterName))
                    strCharacterName = LanguageManager.GetString("String_UnnamedCharacter");
                DialogResult objResult = MessageBox.Show(LanguageManager.GetString("Message_UnsavedChanges").Replace("{0}", strCharacterName), LanguageManager.GetString("MessageTitle_UnsavedChanges"), MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (objResult == DialogResult.Yes)
                {
                    // Attempt to save the Character. If the user cancels the Save As dialogue that may open, cancel the closing event so that changes are not lost.
                    bool blnResult = SaveCharacter();
                    if (!blnResult)
                        e.Cancel = true;
                }
                else if (objResult == DialogResult.Cancel)
                {
                    e.Cancel = true;
                }
            }
            // Reset the ToolStrip so the Save button is removed for the currently closing window.
            if (!e.Cancel)
            {
                _blnLoading = true;
                Application.Idle -= UpdateCharacterInfo;
                GlobalOptions.MainForm.OpenCharacters.Remove(_objCharacter);
                if (!_blnSkipToolStripRevert)
                    ToolStripManager.RevertMerge("toolStrip");

                // Unsubscribe from events.
                _objCharacter.MAGEnabledChanged -= objCharacter_MAGEnabledChanged;
                _objCharacter.RESEnabledChanged -= objCharacter_RESEnabledChanged;
                _objCharacter.DEPEnabledChanged -= objCharacter_DEPEnabledChanged;
                _objCharacter.AdeptTabEnabledChanged -= objCharacter_AdeptTabEnabledChanged;
                _objCharacter.MagicianTabEnabledChanged -= objCharacter_MagicianTabEnabledChanged;
                _objCharacter.AdeptTabEnabledChanged -= objCharacter_MagicianTabEnabledChanged;
                _objCharacter.TechnomancerTabEnabledChanged -= objCharacter_TechnomancerTabEnabledChanged;
                _objCharacter.AdvancedProgramsTabEnabledChanged -= objCharacter_AdvancedProgramsTabEnabledChanged;
                _objCharacter.CyberwareTabDisabledChanged -= objCharacter_CyberwareTabDisabledChanged;
                _objCharacter.CritterTabEnabledChanged -= objCharacter_CritterTabEnabledChanged;
                GlobalOptions.MRUChanged -= PopulateMRU;

                treGear.ItemDrag -= treGear_ItemDrag;
                treGear.DragEnter -= treGear_DragEnter;
                treGear.DragDrop -= treGear_DragDrop;

                treLifestyles.ItemDrag -= treLifestyles_ItemDrag;
                treLifestyles.DragEnter -= treLifestyles_DragEnter;
                treLifestyles.DragDrop -= treLifestyles_DragDrop;

                treArmor.ItemDrag -= treArmor_ItemDrag;
                treArmor.DragEnter -= treArmor_DragEnter;
                treArmor.DragDrop -= treArmor_DragDrop;

                treWeapons.ItemDrag -= treWeapons_ItemDrag;
                treWeapons.DragEnter -= treWeapons_DragEnter;
                treWeapons.DragDrop -= treWeapons_DragDrop;

                treVehicles.ItemDrag -= treVehicles_ItemDrag;
                treVehicles.DragEnter -= treVehicles_DragEnter;
                treVehicles.DragDrop -= treVehicles_DragDrop;

                treImprovements.ItemDrag -= treImprovements_ItemDrag;
                treImprovements.DragEnter -= treImprovements_DragEnter;
                treImprovements.DragDrop -= treImprovements_DragDrop;

                foreach (ContactControl objContactControl in panContacts.Controls.OfType<ContactControl>())
                {
                    objContactControl.ConnectionRatingChanged -= objContact_ConnectionRatingChanged;
                    objContactControl.LoyaltyRatingChanged -= objContact_LoyaltyRatingChanged;
                    objContactControl.DeleteContact -= objContact_DeleteContact;
                    objContactControl.FileNameChanged -= objContact_FileNameChanged;
                    objContactControl.FreeRatingChanged -= objContact_OtherCostChanged;
                    objContactControl.FamilyChanged -= objContact_OtherCostChanged;
                    objContactControl.BlackmailChanged -= objContact_OtherCostChanged;
                }

                foreach (ContactControl objContactControl in panEnemies.Controls.OfType<ContactControl>())
                {
                    objContactControl.ConnectionRatingChanged -= objEnemy_ConnectionRatingChanged;
                    objContactControl.LoyaltyRatingChanged -= objEnemy_LoyaltyRatingChanged;
                    objContactControl.DeleteContact -= objEnemy_DeleteContact;
                    objContactControl.FileNameChanged -= objEnemy_FileNameChanged;
                    objContactControl.FreeRatingChanged += objEnemy_FreeStatusChanged;
                }

                foreach (PetControl objContactControl in panPets.Controls.OfType<PetControl>())
                {
                    objContactControl.DeleteContact -= objPet_DeleteContact;
                    objContactControl.FileNameChanged -= objPet_FileNameChanged;
                }

                foreach (SpiritControl objSpiritControl in panSpirits.Controls.OfType<SpiritControl>())
                {
                    objSpiritControl.ServicesOwedChanged -= objSpirit_ServicesOwedChanged;
                    objSpiritControl.ForceChanged -= objSpirit_ForceChanged;
                    objSpiritControl.BoundChanged -= objSpirit_BoundChanged;
                    objSpiritControl.FetteredChanged -= objSpirit_FetteredChanged;
                    objSpiritControl.DeleteSpirit -= objSpirit_DeleteSpirit;
                    objSpiritControl.FileNameChanged -= objSpirit_FileNameChanged;
                }

                foreach (SpiritControl objSpiritControl in panSprites.Controls.OfType<SpiritControl>())
                {
                    objSpiritControl.ServicesOwedChanged -= objSprite_ServicesOwedChanged;
                    objSpiritControl.ForceChanged -= objSprite_ForceChanged;
                    objSpiritControl.BoundChanged -= objSprite_BoundChanged;
                    objSpiritControl.DeleteSpirit -= objSprite_DeleteSpirit;
                    objSpiritControl.FileNameChanged -= objSprite_FileNameChanged;
                }

                // Trash the global variables and dispose of the Form.
                _objCharacter.Dispose();
                _objOptions = null;
                _objCharacter = null;
                Dispose(true);
            }
        }

        private void frmCareer_Activated(object sender, EventArgs e)
        {
            // Merge the ToolStrips.
            ToolStripManager.RevertMerge("toolStrip");
            ToolStripManager.Merge(toolStrip, "toolStrip");
        }

        private void frmCareer_Shown(object sender, EventArgs e)
        {
            // Clear all of the placeholder Labels.
            foreach (Label objLabel in tabCommon.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabMartialArts.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabMagician.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabTechnomancer.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabAdvancedPrograms.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabCyberware.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabLifestyle.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabArmor.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabWeapons.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabGear.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabVehicles.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabInitiation.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabCritter.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            foreach (Label objLabel in tabImprovements.Controls.OfType<Label>())
            {
                if (objLabel.Text.StartsWith('['))
                    objLabel.Text = string.Empty;
            }

            frmCareer_Resize(sender, e);
        }

        private void frmCareer_Resize(object sender, EventArgs e)
        {
            TabPage objPage = tabCharacterTabs.SelectedTab;
            // Reseize the form elements with the form.
            // Character Info Tab.
            int intHeight = ((objPage.Height - lblDescription.Top) / 4 - 20);
            txtDescription.Height = intHeight;
            lblBackground.Top = txtDescription.Top + txtDescription.Height + 3;
            txtBackground.Top = lblBackground.Top + lblBackground.Height + 3;
            txtBackground.Height = intHeight;
            lblConcept.Top = txtBackground.Top + txtBackground.Height + 3;
            txtConcept.Top = lblConcept.Top + lblConcept.Height + 3;
            txtConcept.Height = intHeight;
            lblNotes.Top = txtConcept.Top + txtConcept.Height + 3;
            txtNotes.Top = lblNotes.Top + lblNotes.Height + 3;
            txtNotes.Height = intHeight;
        }
        #endregion

        #region Character Events
        private void objCharacter_MAGEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            lblFoci.Visible = _objCharacter.MAGEnabled;
            treFoci.Visible = _objCharacter.MAGEnabled;
            cmdCreateStackedFocus.Visible = _objCharacter.MAGEnabled;

            if (_objCharacter.MAGEnabled)
            {
                // Show the Initiation Tab.
                if (!tabCharacterTabs.TabPages.Contains(tabInitiation))
                {
                    tabCharacterTabs.TabPages.Insert(3, tabInitiation);
                    tabInitiation.Text = LanguageManager.GetString("Tab_Initiation");
                    tsMetamagicAddMetamagic.Text = LanguageManager.GetString("Button_AddMetamagic");
                    chkJoinGroup.Text = LanguageManager.GetString("Checkbox_JoinedGroup");
                }

                if (!lstSpecialAttributes.Contains(_objCharacter.MAG))
                {
                    lstSpecialAttributes.Add(_objCharacter.MAG);
                }
                if (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && !lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Add(_objCharacter.MAGAdept);
                }
            }
            else
            {
                ClearInitiationTab();
                tabCharacterTabs.TabPages.Remove(tabInitiation);
                if (lstSpecialAttributes.Contains(_objCharacter.MAG))
                {
                    lstSpecialAttributes.Remove(_objCharacter.MAG);
                }
                if (lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Remove(_objCharacter.MAGAdept);
                }
            }

        }

        private void objCharacter_RESEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            if (_objCharacter.RESEnabled)
            {
                // Show the Initiation Tab.
                if (!tabCharacterTabs.TabPages.Contains(tabInitiation))
                {
                    tabCharacterTabs.TabPages.Insert(3, tabInitiation);
                    tabInitiation.Text = LanguageManager.GetString("Tab_Submersion");
                    tsMetamagicAddMetamagic.Text = LanguageManager.GetString("Button_AddEcho");
                    chkJoinGroup.Text = LanguageManager.GetString("Checkbox_JoinedNetwork");
                }
                if (!lstSpecialAttributes.Contains(_objCharacter.RES))
                {
                    lstSpecialAttributes.Add(_objCharacter.RES);
                }
            }
            else
            {
                ClearInitiationTab();
                tabCharacterTabs.TabPages.Remove(tabInitiation);
                if (lstSpecialAttributes.Contains(_objCharacter.RES))
                {
                    lstSpecialAttributes.Remove(_objCharacter.RES);
                }
            }
        }

        private void objCharacter_AmbidextrousChanged(object sender = null)
        {
            if (_blnReapplyImprovements)
                return;
            //Create the dropdown for the character's primary arm.
            List<ListItem> lstPrimaryArm = new List<ListItem>();
            ListItem objLeftHand = new ListItem();
            objLeftHand.Value = "Left";
            objLeftHand.Name = LanguageManager.GetString("String_Improvement_SideLeft");
            lstPrimaryArm.Add(objLeftHand);
            ListItem objRightHand = new ListItem();
            objRightHand.Value = "Right";
            objRightHand.Name = LanguageManager.GetString("String_Improvement_SideRight");
            lstPrimaryArm.Add(objRightHand);
            if (_objCharacter.Ambidextrous)
            {
                ListItem objAmbidextrous = new ListItem();
                objAmbidextrous.Value = "Ambidextrous";
                objAmbidextrous.Name = LanguageManager.GetString("String_Ambidextrous");
                lstPrimaryArm.Add(objAmbidextrous);
            }

            SortListItem objSortHand = new SortListItem();
            lstPrimaryArm.Sort(objSortHand.Compare);
            cboPrimaryArm.BeginUpdate();
            cboPrimaryArm.ValueMember = "Value";
            cboPrimaryArm.DisplayMember = "Name";
            cboPrimaryArm.DataSource = lstPrimaryArm;
            if (_objCharacter.Ambidextrous)
            {
                cboPrimaryArm.SelectedValue = "Ambidextrous";
                cboPrimaryArm.Enabled = false;
            }
            else
            {
                cboPrimaryArm.SelectedValue = _objCharacter.PrimaryArm;
                cboPrimaryArm.Enabled = true;
            }
            cboPrimaryArm.EndUpdate();
        }

        private void objCharacter_DEPEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;
        }

        private void objCharacter_AdeptTabEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change to the status of Adept being enabled.
            if (_objCharacter.AdeptEnabled)
            {
                if (!tabCharacterTabs.TabPages.Contains(tabAdept))
                    tabCharacterTabs.TabPages.Insert(3, tabAdept);
                if (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && !lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Add(_objCharacter.MAGAdept);
                }
            }
            else
            {
                _objCharacter.Powers.Clear();
                tabCharacterTabs.TabPages.Remove(tabAdept);
                if (lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Remove(_objCharacter.MAGAdept);
                }
            }

            // Show the Mystic Adept control if the character is a Mystic Adept, otherwise hide them.
            if (_objCharacter.IsMysticAdept && !_objOptions.MysAdeptSecondMAGAttribute)
            {
                lblMysticAdeptAssignment.Visible = true;
                lblMysticAdeptMAGAdept.Visible = true;
                // cmdIncreasePowerPoints.Visible = true;
            }
            else
            {
                lblMysticAdeptAssignment.Visible = false;
                lblMysticAdeptMAGAdept.Visible = false;
                // cmdIncreasePowerPoints.Visible = false;
            }
        }

        private void objCharacter_MagicianTabEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change to the status of Magician being enabled.
            if (_objCharacter.MagicianEnabled || _objCharacter.AdeptEnabled)
            {
                if (!tabCharacterTabs.TabPages.Contains(tabMagician))
                    tabCharacterTabs.TabPages.Insert(3, tabMagician);
                if (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && !lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Add(_objCharacter.MAGAdept);
                }
            }
            else
            {
                ClearSpellTab();
                tabCharacterTabs.TabPages.Remove(tabMagician);
                if (lstSpecialAttributes.Contains(_objCharacter.MAGAdept))
                {
                    lstSpecialAttributes.Remove(_objCharacter.MAGAdept);
                }
            }

            // Show the Mystic Adept control if the character is a Mystic Adept, otherwise hide them.
            if (_objCharacter.IsMysticAdept && !_objOptions.MysAdeptSecondMAGAttribute)
            {
                lblMysticAdeptAssignment.Visible = true;
                lblMysticAdeptMAGAdept.Visible = true;
                // cmdIncreasePowerPoints.Visible = true;
            }
            else
            {
                lblMysticAdeptAssignment.Visible = false;
                lblMysticAdeptMAGAdept.Visible = false;
                // cmdIncreasePowerPoints.Visible = false;
            }
        }

        private void objCharacter_TechnomancerTabEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change to the status of Technomancer being enabled.
            if (_objCharacter.TechnomancerEnabled)
            {
                if (!tabCharacterTabs.TabPages.Contains(tabTechnomancer))
                    tabCharacterTabs.TabPages.Insert(3, tabTechnomancer);
            }
            else
            {
                ClearTechnomancerTab();
                tabCharacterTabs.TabPages.Remove(tabTechnomancer);
            }
        }

        private void objCharacter_AdvancedProgramsTabEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change to the status of Technomancer being enabled.
            if (_objCharacter.AdvancedProgramsEnabled)
            {
                if (!tabCharacterTabs.TabPages.Contains(tabAdvancedPrograms))
                    tabCharacterTabs.TabPages.Insert(3, tabAdvancedPrograms);
            }
            else
            {
                ClearAdvancedProgramsTab();
                tabCharacterTabs.TabPages.Remove(tabAdvancedPrograms);
            }
        }

        private void objCharacter_CyberwareTabDisabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change to the status of Advanced Programs being enabled.
            if (_objCharacter.CyberwareDisabled)
            {
                ClearCyberwareTab();
                tabCharacterTabs.TabPages.Remove(tabCyberware);
            }
            else
            {
                if (!tabCharacterTabs.TabPages.Contains(tabCyberware))
                    tabCharacterTabs.TabPages.Insert(6, tabCyberware);
            }
        }

        private void objCharacter_CritterTabEnabledChanged(object sender)
        {
            if (_blnReapplyImprovements)
                return;

            // Change the status of Critter being enabled.
            if (_objCharacter.CritterEnabled)
            {
                if (!tabCharacterTabs.TabPages.Contains(tabCritter))
                    tabCharacterTabs.TabPages.Insert(3, tabCritter);
            }
            else
            {
                // Remove all Critter Powers.
                ClearCritterTab();
                tabCharacterTabs.TabPages.Remove(tabCritter);
            }
        }

        private void objCharacter_FameChanged(object sender)
        {
            //_objCharacter.TotalPublicAwareness
        }

        //TODO: UpdatePowerRelatedInfo method? Powers hook into so much stuff that it may need to wait for outbound improvement events?
        private Stopwatch PowerPropertyChanged_StopWatch = Stopwatch.StartNew();
        private void PowerPropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            _blnIsDirty = true;

            if (PowerPropertyChanged_StopWatch.ElapsedMilliseconds < 4) return;
            PowerPropertyChanged_StopWatch.Restart();
            tabPowerUc.CalculatePowerPoints();
            ScheduleCharacterUpdate();
        }

        private Stopwatch SkillPropertyChanged_StopWatch = Stopwatch.StartNew();
        private void SkillPropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            //HACK PERFORMANCE
            //So, skills tell if anything maybe intresting have happened, but this don't have any way to see if it is relevant. Instead of redrawing EVYER FYCKING THING we do it only every 5 ms
            if (SkillPropertyChanged_StopWatch.ElapsedMilliseconds < 4) return;
            SkillPropertyChanged_StopWatch.Restart();

            lblCareerKarma.Text = _objCharacter.CareerKarma.ToString();
            //UpdateSkillInfo();
            PopulateCalendar();
            ScheduleCharacterUpdate();
            
            _blnIsDirty = true;
            UpdateWindowTitle();
        }
        #endregion

        #region Menu Events
        private void mnuFileSave_Click(object sender, EventArgs e)
        {
            SaveCharacter();
        }

        private void mnuFileSaveAs_Click(object sender, EventArgs e)
        {
            SaveCharacterAs();
        }

        private void tsbSave_Click(object sender, EventArgs e)
        {
            mnuFileSave_Click(sender, e);
        }

        private void tsbPrint_Click(object sender, EventArgs e)
        {
            _objCharacter.Print(false);
        }

        private void mnuFileClose_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void mnuFilePrint_Click(object sender, EventArgs e)
        {
            _objCharacter.Print(false);
        }

        private void mnuFileExport_Click(object sender, EventArgs e)
        {
            // Write the Character information to a MemoryStream so we don't need to create any files.
            MemoryStream objStream = new MemoryStream();
            XmlTextWriter objWriter = new XmlTextWriter(objStream, Encoding.UTF8);

            // Being the document.
            objWriter.WriteStartDocument();

            // </characters>
            objWriter.WriteStartElement("characters");

#if DEBUG
            _objCharacter.PrintToStream(objStream, objWriter, GlobalOptions.CultureInfo);
#else
            _objCharacter.PrintToStream(objWriter, GlobalOptions.CultureInfo);
#endif

            // </characters>
            objWriter.WriteEndElement();

            // Finish the document and flush the Writer and Stream.
            objWriter.WriteEndDocument();
            objWriter.Flush();

            // Read the stream.
            StreamReader objReader = new StreamReader(objStream);
            objStream.Position = 0;
            XmlDocument objCharacterXML = new XmlDocument();

            // Put the stream into an XmlDocument and send it off to the Viewer.
            string strXML = objReader.ReadToEnd();
            objCharacterXML.LoadXml(strXML);

            objWriter.Close();

            frmExport frmExportCharacter = new frmExport(objCharacterXML);
            frmExportCharacter.ShowDialog(this);
        }

        private void mnuSpecialCyberzombie_Click(object sender, EventArgs e)
        {
            bool blnEssence = true;
            bool blnCyberware = false;
            string strMessage = LanguageManager.GetString("Message_CyberzombieRequirements");

            // Make sure the character has an Essence lower than 0.
            if (_objCharacter.Essence >= 0)
            {
                strMessage += "\n\t" + LanguageManager.GetString("Message_CyberzombieRequirementsEssence");
                blnEssence = false;
            }

            // Make sure the character has an Invoked Memory Stimulator.
            foreach (Cyberware objCyberware in _objCharacter.Cyberware)
            {
                if (objCyberware.Name == "Invoked Memory Stimulator")
                    blnCyberware = true;
            }

            if (!blnCyberware)
                strMessage += "\n\t" + LanguageManager.GetString("Message_CyberzombieRequirementsStimulator");

            if (!blnEssence || !blnCyberware)
            {
                MessageBox.Show(strMessage, LanguageManager.GetString("MessageTitle_CyberzombieRequirements"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (MessageBox.Show(LanguageManager.GetString("Message_CyberzombieConfirm"), LanguageManager.GetString("MessageTitle_CyberzombieConfirm"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                return;

            // Convert the character.
            // Characters lose access to Resonance.
            _objCharacter.RESEnabled = false;

            // Gain MAG that is permanently set to 1.
            _objCharacter.MAGEnabled = true;
            _objCharacter.MAG.MetatypeMinimum = 1;
            _objCharacter.MAG.MetatypeMaximum = 1;

            // Add the Cyberzombie Lifestyle if it is not already taken.
            bool blnHasLifestyle = false;
            foreach (Lifestyle objLifestyle in _objCharacter.Lifestyles)
            {
                if (objLifestyle.Name == "Cyberzombie Lifestyle Addition")
                    blnHasLifestyle = true;
            }
            if (!blnHasLifestyle)
            {
                XmlDocument objXmlLifestyleDocument = XmlManager.Load("lifestyles.xml");
                XmlNode objXmlLifestyle = objXmlLifestyleDocument.SelectSingleNode("/chummer/lifestyles/lifestyle[name = \"Cyberzombie Lifestyle Addition\"]");

                TreeNode objLifestyleNode = new TreeNode();
                Lifestyle objLifestyle = new Lifestyle(_objCharacter);
                objLifestyle.Create(objXmlLifestyle, objLifestyleNode);
                _objCharacter.Lifestyles.Add(objLifestyle);

                treLifestyles.Nodes[0].Nodes.Add(objLifestyleNode);
                treLifestyles.Nodes[0].Expand();
            }

            // Change the MetatypeCategory to Cyberzombie.
            _objCharacter.MetatypeCategory = "Cyberzombie";

            // Gain access to Critter Powers.
            _objCharacter.CritterEnabled = true;

            // Gain the Dual Natured Critter Power if it does not yet exist.
            bool blnHasPower = false;
            foreach (CritterPower objPower in _objCharacter.CritterPowers)
            {
                if (objPower.Name == "Dual Natured")
                    blnHasPower = true;
            }
            if (!blnHasPower)
            {
                XmlDocument objXmlPowerDocument = XmlManager.Load("critterpowers.xml");
                XmlNode objXmlPowerNode = objXmlPowerDocument.SelectSingleNode("/chummer/powers/power[name = \"Dual Natured\"]");

                TreeNode objNode = new TreeNode();
                CritterPower objCritterPower = new CritterPower(_objCharacter);
                objCritterPower.Create(objXmlPowerNode, objNode);
                _objCharacter.CritterPowers.Add(objCritterPower);

                treCritterPowers.Nodes[0].Nodes.Add(objNode);
                treCritterPowers.Nodes[0].Expand();
            }

            // Gain the Immunity (Normal Weapons) Critter Power if it does not yet exist.
            blnHasPower = false;
            foreach (CritterPower objPower in _objCharacter.CritterPowers)
            {
                if (objPower.Name == "Immunity" && objPower.Extra == "Normal Weapons")
                    blnHasPower = true;
            }
            if (!blnHasPower)
            {
                XmlDocument objXmlPowerDocument = XmlManager.Load("critterpowers.xml");
                XmlNode objXmlPowerNode = objXmlPowerDocument.SelectSingleNode("/chummer/powers/power[name = \"Immunity\"]");

                TreeNode objNode = new TreeNode();
                CritterPower objCritterPower = new CritterPower(_objCharacter);
                objCritterPower.Create(objXmlPowerNode, objNode, 0, "Normal Weapons");
                _objCharacter.CritterPowers.Add(objCritterPower);

                treCritterPowers.Nodes[0].Nodes.Add(objNode);
                treCritterPowers.Nodes[0].Expand();
            }

            mnuSpecialCyberzombie.Visible = false;

            _blnIsDirty = true;
            UpdateWindowTitle();

            ScheduleCharacterUpdate();
        }

        private void mnuSpecialReduceAttribute_Click(object sender, EventArgs e)
        {
            // Display the Select CharacterAttribute window and record which Skill was selected.
            frmSelectAttribute frmPickAttribute = new frmSelectAttribute();
            frmPickAttribute.Description = LanguageManager.GetString("String_CyberzombieReduceAttribute");
            if (_objCharacter.MAGEnabled)
                frmPickAttribute.AddMAG();
            if (_objCharacter.RESEnabled)
                frmPickAttribute.AddRES();
            if (_objCharacter.DEPEnabled)
                frmPickAttribute.AddDEP();
            frmPickAttribute.ShowMetatypeMaximum = true;
            frmPickAttribute.ShowDialog(this);

            if (frmPickAttribute.DialogResult == DialogResult.Cancel)
                return;

            // Create an Improvement to reduce the CharacterAttribute's Metatype Maximum.
            if (!frmPickAttribute.DoNotAffectMetatypeMaximum)
                ImprovementManager.CreateImprovement(_objCharacter, frmPickAttribute.SelectedAttribute, Improvement.ImprovementSource.AttributeLoss, "CharacterAttribute Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, -1);
            // Permanently reduce the CharacterAttribute's value.
            _objCharacter.GetAttribute(frmPickAttribute.SelectedAttribute).Degrade(1);

            _blnIsDirty = true;
            UpdateWindowTitle();

            ScheduleCharacterUpdate();
        }

        private void Menu_DropDownOpening(object sender, EventArgs e)
        {
            foreach (ToolStripMenuItem objItem in ((ToolStripMenuItem)sender).DropDownItems.OfType<ToolStripMenuItem>())
            {
                if (objItem.Tag != null)
                {
                    objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
                }
            }
        }

        private void mnuSpecialCloningMachine_Click(object sender, EventArgs e)
        {
            frmSelectNumber frmPickNumber = new frmSelectNumber(0);
            frmPickNumber.Description = LanguageManager.GetString("String_CloningMachineNumber");
            frmPickNumber.Minimum = 1;
            frmPickNumber.ShowDialog(this);

            if (frmPickNumber.DialogResult == DialogResult.Cancel)
                return;

            int intClones = decimal.ToInt32(frmPickNumber.SelectedValue);
            if (intClones <= 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CloningMachineNumberRequired"), LanguageManager.GetString("MessageTitle_CloningMachineNumberRequired"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            Cursor = Cursors.WaitCursor;
            Character[] lstClones = new Character[intClones];
            object lstClonesLock = new object();
            Parallel.For(0, intClones, i =>
            {
                Character objLoopCharacter = frmMain.LoadCharacter(_objCharacter.FileName, _objCharacter.Alias + " " + i.ToString(), true);
                lock (lstClonesLock)
                {
                    lstClones[i] = objLoopCharacter;
                }
            });
            Cursor = Cursors.Default;
            GlobalOptions.MainForm.OpenCharacterList(lstClones, false);
        }

        private void mnuSpecialReapplyImprovements_Click(object sender, EventArgs e)
        {
            // This only re-applies the Improvements for everything the character has. If a match is not found in the data files, the current Improvement information is left as-is.
            // Verify that the user wants to go through with it.
            if (MessageBox.Show(LanguageManager.GetString("Message_ConfirmReapplyImprovements"), LanguageManager.GetString("MessageTitle_ConfirmReapplyImprovements"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                return;

            DoReapplyImprovements();
        }

        private void DoReapplyImprovements(List<string> lstInternalIdFilter = null)
        {
            Cursor = Cursors.WaitCursor;

            string strOutdatedItems = string.Empty;

            // Record the status of any flags that normally trigger character events.
            bool blnMAGEnabled = _objCharacter.MAGEnabled;
            bool blnRESEnabled = _objCharacter.RESEnabled;
            bool blnDEPEnabled = _objCharacter.DEPEnabled;

            _blnReapplyImprovements = true;

            // Wipe all improvements that we will reapply, this is mainly to eliminate orphaned improvements caused by certain bugs and also for a performance increase
            if (lstInternalIdFilter == null)
                ImprovementManager.RemoveImprovements(_objCharacter, _objCharacter.Improvements.Where(x =>
                                                                        x.ImproveSource == Improvement.ImprovementSource.AIProgram ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Armor ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.ArmorMod ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Bioware ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.ComplexForm ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.CritterPower ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Cyberware ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Echo ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Gear ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.MartialArt ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.MartialArtAdvantage ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Metamagic ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Power ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Quality ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Spell ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.StackedFocus).ToList());
            else
                ImprovementManager.RemoveImprovements(_objCharacter, _objCharacter.Improvements.Where(x => lstInternalIdFilter.Contains(x.SourceName) &&
                                                                        (x.ImproveSource == Improvement.ImprovementSource.AIProgram ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Armor ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.ArmorMod ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Bioware ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.ComplexForm ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.CritterPower ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Cyberware ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Echo ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Gear ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.MartialArt ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.MartialArtAdvantage ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Metamagic ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Power ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Quality ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.Spell ||
                                                                        x.ImproveSource == Improvement.ImprovementSource.StackedFocus)).ToList());

            // Refresh Qualities.
            // We cannot use foreach because qualities can add more qualities
            for (int j = 0; j < _objCharacter.Qualities.Count; j++)
            {
                Quality objQuality = _objCharacter.Qualities[j];
                if (objQuality.OriginSource == QualitySource.Improvement)
                    continue;
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objQuality.InternalId))
                    continue;
                string strSelected = objQuality.Extra;

                XmlNode objNode = objQuality.MyXmlNode;
                if (objNode != null)
                {
                    objQuality.Bonus = objNode["bonus"];
                    if (objQuality.Bonus != null)
                    {
                        ImprovementManager.ForcedValue = strSelected;
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId, objQuality.Bonus, false, 1, objQuality.DisplayNameShort);
                        if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                        {
                            objQuality.Extra = ImprovementManager.SelectedValue;
                            TreeNode objTreeNode = CommonFunctions.FindNode(objQuality.InternalId, treQualities);
                            if (objTreeNode != null)
                                objTreeNode.Text = objQuality.DisplayName;
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objQuality.DisplayName + "\n";
                }
            }

            // Refresh Martial Art Advantages.
            foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
            {
                XmlNode objMartialArtNode = objMartialArt.MyXmlNode;
                if (objMartialArtNode != null)
                {
                    // We're only re-apply improvements a list of items, not all of them
                    if (lstInternalIdFilter == null || lstInternalIdFilter.Contains(objMartialArt.InternalId))
                    {
                        if (objMartialArtNode["bonus"] != null)
                        {
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.MartialArt, objMartialArt.InternalId, objMartialArtNode["bonus"], false, 1, objMartialArt.DisplayNameShort);
                        }
                    }
                    foreach (MartialArtAdvantage objAdvantage in objMartialArt.Advantages)
                    {
                        // We're only re-apply improvements a list of items, not all of them
                        if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objAdvantage.InternalId))
                            continue;
                        XmlNode objNode = objMartialArtNode.SelectSingleNode("techniques/technique[name = \"" + objAdvantage.Name + "\"]");
                        if (objNode != null)
                        {
                            if (objNode["bonus"] != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.MartialArtAdvantage, objAdvantage.InternalId, objNode["bonus"], false, 1, objAdvantage.DisplayName);
                        }
                        else
                        {
                            strOutdatedItems += objMartialArt.DisplayName + "\n";
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objMartialArt.DisplayName + "\n";
                }
            }

            // Refresh Spells.
            foreach (Spell objSpell in _objCharacter.Spells)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objSpell.InternalId))
                    continue;
                XmlNode objNode = objSpell.MyXmlNode;
                if (objNode != null)
                {
                    if (objNode["bonus"] != null)
                    {
                        ImprovementManager.ForcedValue = objSpell.Extra;
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Spell, objSpell.InternalId, objNode["bonus"], false, 1, objSpell.DisplayNameShort);
                        if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                            objSpell.Extra = ImprovementManager.SelectedValue;

                        foreach (TreeNode objParentNode in treSpells.Nodes)
                        {
                            foreach (TreeNode objChildNode in objParentNode.Nodes)
                            {
                                if (objChildNode.Tag.ToString() == objSpell.InternalId)
                                {
                                    objChildNode.Text = objSpell.DisplayName;
                                    break;
                                }
                            }
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objSpell.DisplayName + "\n";
                }
            }

            // Refresh Adept Powers.
            foreach (Power objPower in _objCharacter.Powers)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objPower.InternalId))
                    continue;
                XmlNode objNode = objPower.MyXmlNode;
                if (objNode != null)
                {
                    objPower.Bonus = objNode["bonus"];
                    if (objPower.Bonus != null)
                    {
                        ImprovementManager.ForcedValue = objPower.Extra;
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Power, objPower.InternalId, objPower.Bonus, false, Convert.ToInt32(objPower.TotalRating), objPower.DisplayNameShort);
                    }
                }
                else
                {
                    strOutdatedItems += objPower.DisplayName + "\n";
                }
            }

            // Refresh Complex Forms.
            foreach (ComplexForm objComplexForm in _objCharacter.ComplexForms)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objComplexForm.InternalId))
                    continue;
                XmlNode objNode = objComplexForm.MyXmlNode;
                if (objNode != null)
                {
                    if (objNode["bonus"] != null)
                    {
                        ImprovementManager.ForcedValue = objComplexForm.Extra;
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ComplexForm, objComplexForm.InternalId, objNode["bonus"], false, 1, objComplexForm.DisplayNameShort);
                        if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                            objComplexForm.Extra = ImprovementManager.SelectedValue;
                        foreach (TreeNode objParentNode in treComplexForms.Nodes)
                        {
                            foreach (TreeNode objChildNode in objParentNode.Nodes)
                            {
                                if (objChildNode.Tag.ToString() == objComplexForm.InternalId)
                                {
                                    objChildNode.Text = objComplexForm.DisplayName;
                                    break;
                                }
                            }
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objComplexForm.DisplayName + "\n";
                }
            }

            // Refresh AI Programs and Advanced Programs
            foreach (AIProgram objProgram in _objCharacter.AIPrograms)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objProgram.InternalId))
                    continue;
                XmlNode objNode = objProgram.MyXmlNode;
                if (objNode != null)
                {
                    if (objNode["bonus"] != null)
                    {
                        ImprovementManager.ForcedValue = objProgram.Extra;
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.AIProgram, objProgram.InternalId, objNode["bonus"], false, 1, objProgram.DisplayNameShort);
                        if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                            objProgram.Extra = ImprovementManager.SelectedValue;
                        foreach (TreeNode objParentNode in treAIPrograms.Nodes)
                        {
                            foreach (TreeNode objChildNode in objParentNode.Nodes)
                            {
                                if (objChildNode.Tag.ToString() == objProgram.InternalId)
                                {
                                    objChildNode.Text = objProgram.DisplayName;
                                    break;
                                }
                            }
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objProgram.DisplayName + "\n";
                }
            }

            // Refresh Critter Powers.
            foreach (CritterPower objPower in _objCharacter.CritterPowers)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objPower.InternalId))
                    continue;
                XmlNode objNode = objPower.MyXmlNode;
                if (objNode != null)
                {
                    objPower.Bonus = objNode["bonus"];
                    if (objPower.Bonus != null)
                    {
                        string strSelected = objPower.Extra;
                        int intRating = 0;
                        if (!int.TryParse(strSelected, out intRating))
                        {
                            intRating = 1;
                            ImprovementManager.ForcedValue = strSelected;
                        }
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.CritterPower, objPower.InternalId, objPower.Bonus, false, intRating, objPower.DisplayNameShort);
                        if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                            objPower.Extra = ImprovementManager.SelectedValue;

                        foreach (TreeNode objParentNode in treCritterPowers.Nodes)
                        {
                            foreach (TreeNode objChildNode in objParentNode.Nodes)
                            {
                                if (objChildNode.Tag.ToString() == objPower.InternalId)
                                {
                                    objChildNode.Text = objPower.DisplayName;
                                    break;
                                }
                            }
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objPower.DisplayName + "\n";
                }
            }

            // Refresh Metamagics and Echoes.
            // We cannot use foreach because metamagics/echoes can add more metamagics/echoes
            for (int j = 0; j < _objCharacter.Metamagics.Count; j++)
            {
                Metamagic objMetamagic = _objCharacter.Metamagics[j];
                if (objMetamagic.Grade < 0)
                    continue;
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objMetamagic.InternalId))
                    continue;
                XmlNode objNode = objMetamagic.MyXmlNode;
                if (objNode != null)
                {
                    objMetamagic.Bonus = objNode["bonus"];
                    if (objMetamagic.Bonus != null)
                    {
                        ImprovementManager.CreateImprovements(_objCharacter, objMetamagic.SourceType, objMetamagic.InternalId, objMetamagic.Bonus, false, 1, objMetamagic.DisplayNameShort);
                    }
                }
                else
                {
                    strOutdatedItems += objMetamagic.DisplayName + "\n";
                }
            }

            // Refresh Cyberware and Bioware.
            Dictionary<Cyberware, int> dicPairableCyberwares = new Dictionary<Cyberware, int>();
            foreach (Cyberware objCyberware in _objCharacter.Cyberware.DeepWhere(x => x.Children, x => lstInternalIdFilter != null && !lstInternalIdFilter.Contains(x.InternalId)))
            {
                XmlNode objNode = objCyberware.MyXmlNode;
                if (objNode != null)
                {
                    objCyberware.Bonus = objNode["bonus"];
                    objCyberware.WirelessBonus = objNode["wirelessbonus"];
                    objCyberware.PairBonus = objNode["pairbonus"];
                    if (objCyberware.IsModularCurrentlyEquipped)
                    {
                        if (!string.IsNullOrEmpty(objCyberware.Forced) && objCyberware.Forced != "Right" && objCyberware.Forced != "Left")
                            ImprovementManager.ForcedValue = objCyberware.Forced;
                        if (objCyberware.Bonus != null)
                        {
                            ImprovementManager.CreateImprovements(_objCharacter, objCyberware.SourceType, objCyberware.InternalId, objCyberware.Bonus, false, objCyberware.Rating, objCyberware.DisplayNameShort);
                            if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                                objCyberware.Extra = ImprovementManager.SelectedValue;
                        }
                        if (objCyberware.WirelessOn && objCyberware.WirelessBonus != null)
                        {
                            ImprovementManager.CreateImprovements(_objCharacter, objCyberware.SourceType, objCyberware.InternalId, objCyberware.WirelessBonus, false, objCyberware.Rating, objCyberware.DisplayNameShort);
                            if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue) && string.IsNullOrEmpty(objCyberware.Extra))
                                objCyberware.Extra = ImprovementManager.SelectedValue;
                        }
                        if (objCyberware.PairBonus != null)
                        {
                            Cyberware objMatchingCyberware = dicPairableCyberwares.Keys.FirstOrDefault(x => x.Name == objCyberware.Name && x.Extra == objCyberware.Extra);
                            if (objMatchingCyberware != null)
                                dicPairableCyberwares[objMatchingCyberware] = dicPairableCyberwares[objMatchingCyberware] + 1;
                            else
                                dicPairableCyberwares.Add(objCyberware, 1);
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objCyberware.DisplayName + "\n";
                }
                foreach (Gear objGear in objCyberware.Gear)
                {
                    CommonFunctions.ReaddGearImprovements(_objCharacter, objGear, treCyberware, ref strOutdatedItems, lstInternalIdFilter);
                }
                TreeNode objWareNode = CommonFunctions.FindNode(objCyberware.InternalId, treCyberware);
                if (objWareNode != null)
                    objWareNode.Text = objCyberware.DisplayName;
            }
            // Separate Pass for PairBonuses
            foreach (KeyValuePair<Cyberware, int> objItem in dicPairableCyberwares)
            {
                Cyberware objCyberware = objItem.Key;
                int intCyberwaresCount = objItem.Value;
                if (!string.IsNullOrEmpty(objCyberware.Location))
                {
                    intCyberwaresCount = Math.Min(intCyberwaresCount, _objCharacter.Cyberware.DeepCount(x => x.Children, x => x.Name == objCyberware.Name && x.Extra == objCyberware.Extra && x.Location != objCyberware.Location && x.IsModularCurrentlyEquipped));
                }
                if (intCyberwaresCount > 0)
                {
                    foreach (Cyberware objLoopCyberware in _objCharacter.Cyberware.DeepWhere(x => x.Children, x => x.Name == objCyberware.Name && x.Extra == objCyberware.Extra && x.IsModularCurrentlyEquipped))
                    {
                        if (intCyberwaresCount % 2 == 0)
                        {
                            if (!string.IsNullOrEmpty(objCyberware.Forced) && objCyberware.Forced != "Right" && objCyberware.Forced != "Left")
                                ImprovementManager.ForcedValue = objCyberware.Forced;
                            ImprovementManager.CreateImprovements(_objCharacter, objLoopCyberware.SourceType, objLoopCyberware.InternalId, objLoopCyberware.PairBonus, false, objLoopCyberware.Rating, objLoopCyberware.DisplayNameShort);
                            if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue) && string.IsNullOrEmpty(objCyberware.Extra))
                                objCyberware.Extra = ImprovementManager.SelectedValue;
                            TreeNode objNode = CommonFunctions.FindNode(objLoopCyberware.InternalId, treCyberware);
                            if (objNode != null)
                                objNode.Text = objCyberware.DisplayName;
                        }
                        intCyberwaresCount -= 1;
                        if (intCyberwaresCount <= 0)
                            break;
                    }
                }
            }

            // Refresh Armors.
            foreach (Armor objArmor in _objCharacter.Armor)
            {
                // We're only re-apply improvements a list of items, not all of them
                if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objArmor.InternalId))
                    continue;
                XmlNode objNode = objArmor.MyXmlNode;
                if (objNode != null)
                {
                    objArmor.Bonus = objNode["bonus"];
                    if (objArmor.Bonus != null)
                    {
                        if (objArmor.Equipped)
                        {
                            ImprovementManager.ForcedValue = objArmor.Extra;
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId, objArmor.Bonus, false, 1, objArmor.DisplayNameShort);
                            if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                            {
                                objArmor.Extra = ImprovementManager.SelectedValue;

                                TreeNode objArmorNode = CommonFunctions.FindNode(objArmor.InternalId, treArmor);
                                if (objArmorNode != null)
                                    objArmorNode.Text = objArmor.DisplayName;
                            }
                        }
                    }
                }
                else
                {
                    strOutdatedItems += objArmor.DisplayName + "\n";
                }

                foreach (ArmorMod objMod in objArmor.ArmorMods)
                {
                    // We're only re-apply improvements a list of items, not all of them
                    if (lstInternalIdFilter != null && !lstInternalIdFilter.Contains(objMod.InternalId))
                        continue;
                    XmlNode objChild = objMod.MyXmlNode;

                    if (objChild != null)
                    {
                        objMod.Bonus = objChild["bonus"];
                        if (objMod.Bonus != null)
                        {
                            if (objMod.Equipped)
                            {
                                ImprovementManager.ForcedValue = objMod.Extra;
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.Bonus, false, 1, objMod.DisplayNameShort);
                                if (!string.IsNullOrEmpty(ImprovementManager.SelectedValue))
                                {
                                    objMod.Extra = ImprovementManager.SelectedValue;

                                    TreeNode objPluginNode = CommonFunctions.FindNode(objMod.InternalId, treArmor);
                                    if (objPluginNode != null)
                                        objPluginNode.Text = objMod.DisplayName;
                                }
                            }
                        }
                    }
                    else
                    {
                        strOutdatedItems += objMod.DisplayName + "\n";
                    }
                    foreach (Gear objGear in objMod.Gear)
                    {
                        CommonFunctions.ReaddGearImprovements(_objCharacter, objGear, treArmor, ref strOutdatedItems, lstInternalIdFilter);
                    }
                }

                foreach (Gear objGear in objArmor.Gear)
                {
                    CommonFunctions.ReaddGearImprovements(_objCharacter, objGear, treArmor, ref strOutdatedItems, lstInternalIdFilter);
                }
            }

            // Refresh Gear.
            foreach (Gear objGear in _objCharacter.Gear)
            {
                CommonFunctions.ReaddGearImprovements(_objCharacter, objGear, treGear, ref strOutdatedItems, lstInternalIdFilter);
            }

            // Refresh Weapons Gear
            for (int i = 0; i < _objCharacter.Weapons.Count; i++)
            {
                Weapon objWeapon = _objCharacter.Weapons[i];
                foreach (WeaponAccessory objAccessory in objWeapon.WeaponAccessories)
                {
                    foreach (Gear objGear in objAccessory.Gear)
                    {
                        CommonFunctions.ReaddGearImprovements(_objCharacter, objGear, treWeapons, ref strOutdatedItems, lstInternalIdFilter);
                    }
                }
            }

            _blnReapplyImprovements = false;

            // If the status of any Character Event flags has changed, manually trigger those events.
            if (blnMAGEnabled != _objCharacter.MAGEnabled)
                objCharacter_MAGEnabledChanged(this);
            if (blnRESEnabled != _objCharacter.RESEnabled)
                objCharacter_RESEnabledChanged(this);
            if (blnDEPEnabled != _objCharacter.DEPEnabled)
                objCharacter_DEPEnabledChanged(this);

            RefreshQualities(treQualities, cmsQuality, true);
            treQualities.SortCustom();
            nudQualityLevel_UpdateValue(null);
            UpdateMentorSpirits();
            RefreshMartialArts();
            RefreshAIPrograms();
            RefreshLimitModifiers();
            RefreshSpells(treSpells, cmsSpell, _objCharacter);
            PopulateGearList();
            RefreshContacts();
            if (treCyberware.SelectedNode != null)
                RefreshSelectedCyberware();
            if (treArmor.SelectedNode != null)
                RefreshSelectedArmor();
            if (treGear.SelectedNode != null)
                RefreshSelectedGear();
            if (treLifestyles.SelectedNode != null)
                RefreshSelectedLifestyle();
            if (treVehicles.SelectedNode != null)
                RefreshSelectedVehicle();
            if (treWeapons.SelectedNode != null)
                RefreshSelectedWeapon();

            ScheduleCharacterUpdate();
            // Immediately call character update because it re-applies essence loss improvements
            UpdateCharacterInfo();

            Cursor = Cursors.Default;

            if (!string.IsNullOrEmpty(strOutdatedItems))
            {
                strOutdatedItems = LanguageManager.GetString("Message_ReapplyImprovementsFoundOutdatedItems_Top") + strOutdatedItems + LanguageManager.GetString("Message_ReapplyImprovementsFoundOutdatedItems_Bottom");
                MessageBox.Show(strOutdatedItems, LanguageManager.GetString("MessageTitle_ConfirmReapplyImprovements"), MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void mnuSpecialPossess_Click(object sender, EventArgs e)
        {
            // Make sure the Spirit has been saved first.
            if (_blnIsDirty)
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_PossessionSave"), LanguageManager.GetString("MessageTitle_Possession"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }

            // Prompt the user to select a save file to possess.
            OpenFileDialog openFileDialog = new OpenFileDialog();
            openFileDialog.Filter = "Chummer5 Files (*.chum5)|*.chum5|All Files (*.*)|*.*";

            if (openFileDialog.ShowDialog(this) == DialogResult.OK)
            {
                Cursor = Cursors.WaitCursor;
                Character objVessel = new Character();
                objVessel.FileName = openFileDialog.FileName;
                objVessel.Load();
                // Make sure the Vessel is in Career Mode.
                if (!objVessel.Created)
                {
                    Cursor = Cursors.Default;
                    MessageBox.Show(LanguageManager.GetString("Message_VesselInCareerMode"), LanguageManager.GetString("MessageTitle_Possession"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                    objVessel.Dispose();
                    objVessel = null;
                    return;
                }

                // Load the Spirit's save file into a new Merge character.
                Character objMerge = new Character();
                objMerge.FileName = _objCharacter.FileName;
                objMerge.Load();
                objMerge.Possessed = true;
                objMerge.Alias = objVessel.Alias + " (" + LanguageManager.GetString("String_Possessed") + ")";

                // Give the Critter the Immunity to Normal Weapons Power if they don't already have it.
                bool blnHasImmunity = false;
                foreach (CritterPower objCritterPower in objMerge.CritterPowers)
                {
                    if (objCritterPower.Name == "Immunity" && objCritterPower.Extra == "Normal Weapons")
                    {
                        blnHasImmunity = true;
                        break;
                    }
                }
                if (!blnHasImmunity)
                {
                    XmlDocument objPowerDoc = XmlManager.Load("critterpowers.xml");
                    XmlNode objPower = objPowerDoc.SelectSingleNode("/chummer/powers/power[name = \"Immunity\"]");

                    CritterPower objCritterPower = new CritterPower(objMerge);
                    TreeNode objDummy = new TreeNode();
                    objCritterPower.Create(objPower, objDummy, 0, "Normal Weapons");
                    objMerge.CritterPowers.Add(objCritterPower);
                }

                //TOD: Implement Possession attribute bonuses.
                /* Add the Vessel's Physical Attributes to the Spirit's Force.
                objMerge.BOD.MetatypeMaximum = objVessel.BOD.Value + objMerge.MAG.TotalValue;
                objMerge.BOD.Value = objVessel.BOD.Value + objMerge.MAG.TotalValue;
                objMerge.AGI.MetatypeMaximum = objVessel.AGI.Value + objMerge.MAG.TotalValue;
                objMerge.AGI.Value = objVessel.AGI.Value + objMerge.MAG.TotalValue;
                objMerge.REA.MetatypeMaximum = objVessel.REA.Value + objMerge.MAG.TotalValue;
                objMerge.REA.Value = objVessel.REA.Value + objMerge.MAG.TotalValue;
                objMerge.STR.MetatypeMaximum = objVessel.STR.Value + objMerge.MAG.TotalValue;
                objMerge.STR.Value = objVessel.STR.Value + objMerge.MAG.TotalValue;*/

                // Copy any Lifestyles the Vessel has.
                foreach (Lifestyle objLifestyle in objVessel.Lifestyles)
                    objMerge.Lifestyles.Add(objLifestyle);

                // Copy any Armor the Vessel has.
                foreach (Armor objArmor in objVessel.Armor)
                {
                    objMerge.Armor.Add(objArmor);
                    CopyArmorImprovements(objVessel, objMerge, objArmor);
                }

                // Copy any Gear the Vessel has.
                foreach (Gear objGear in objVessel.Gear)
                {
                    objMerge.Gear.Add(objGear);
                    CopyGearImprovements(objVessel, objMerge, objGear);
                }

                // Copy any Cyberware/Bioware the Vessel has.
                foreach (Cyberware objCyberware in objVessel.Cyberware)
                {
                    objMerge.Cyberware.Add(objCyberware);
                    CopyCyberwareImprovements(objVessel, objMerge, objCyberware);
                }

                // Copy any Weapons the Vessel has.
                foreach (Weapon objWeapon in objVessel.Weapons)
                    objMerge.Weapons.Add(objWeapon);

                // Copy and Vehicles the Vessel has.
                foreach (Vehicle objVehicle in objVessel.Vehicles)
                    objMerge.Vehicles.Add(objVehicle);

                // Copy the character info.
                objMerge.Sex = objVessel.Sex;
                objMerge.Age = objVessel.Age;
                objMerge.Eyes = objVessel.Eyes;
                objMerge.Hair = objVessel.Hair;
                objMerge.Height = objVessel.Height;
                objMerge.Weight = objVessel.Weight;
                objMerge.Skin = objVessel.Skin;
                objMerge.Name = objVessel.Name;
                objMerge.StreetCred = objVessel.StreetCred;
                objMerge.BurntStreetCred = objVessel.BurntStreetCred;
                objMerge.Notoriety = objVessel.Notoriety;
                objMerge.PublicAwareness = objVessel.PublicAwareness;
                objMerge.Mugshots = objVessel.Mugshots;

                // Now that everything is done, save the merged character and open them.
                SaveFileDialog saveFileDialog = new SaveFileDialog();
                saveFileDialog.Filter = "Chummer5 Files (*.chum5)|*.chum5|All Files (*.*)|*.*";

                string strShowFileName = Path.GetFileName(_objCharacter.FileName);

                if (string.IsNullOrEmpty(strShowFileName))
                    strShowFileName = _objCharacter.Alias;
                strShowFileName = strShowFileName.Replace(".chum5", string.Empty);

                strShowFileName += " (" + LanguageManager.GetString("String_Possessed") + ")";

                saveFileDialog.FileName = strShowFileName;

                Cursor = Cursors.Default;

                if (saveFileDialog.ShowDialog(this) == DialogResult.OK)
                {
                    Cursor = Cursors.WaitCursor;
                    objMerge.FileName = saveFileDialog.FileName;
                    if (objMerge.Save())
                    {
                        // Get the name of the file and destroy the references to the Vessel and the merged character.
                        string strOpenFile = objMerge.FileName;
                        objMerge.Dispose();
                        objMerge = null;
                        objVessel.Dispose();
                        objVessel = null;

                        Character objOpenCharacter = frmMain.LoadCharacter(strOpenFile);
                        Cursor = Cursors.Default;
                        GlobalOptions.MainForm.OpenCharacter(objOpenCharacter);
                    }
                    else
                    {
                        // The save process was canceled, so drop everything.
                        objMerge.Dispose();
                        objMerge = null;
                        objVessel.Dispose();
                        objVessel = null;
                        Cursor = Cursors.Default;
                    }
                }
                else
                {
                    // The save process was canceled, so drop everything.
                    objMerge.Dispose();
                    objMerge = null;
                    objVessel.Dispose();
                    objVessel = null;
                }
            }
        }

        private void mnuSpecialPossessInanimate_Click(object sender, EventArgs e)
        {
            // Make sure the Spirit has been saved first.
            if (_blnIsDirty)
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_PossessionSave"), LanguageManager.GetString("MessageTitle_Possession"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }

            // Prompt the user to select an inanimate Vessel.
            XmlDocument objVesselDoc = XmlManager.Load("vessels.xml");
            XmlNodeList objXmlMetatypeList = objVesselDoc.SelectNodes("/chummer/metatypes/metatype");
            List<ListItem> lstMetatype = new List<ListItem>();
            foreach (XmlNode objXmlMetatype in objXmlMetatypeList)
            {
                ListItem objItem = new ListItem();
                objItem.Value = objXmlMetatype["name"].InnerText;
                objItem.Name = objXmlMetatype["translate"]?.InnerText ?? objXmlMetatype["name"].InnerText;
                lstMetatype.Add(objItem);
            }

            frmSelectItem frmSelectVessel = new frmSelectItem();
            frmSelectVessel.GeneralItems = lstMetatype;
            frmSelectVessel.ShowDialog(this);

            if (frmSelectVessel.DialogResult == DialogResult.Cancel)
                return;

            Cursor = Cursors.WaitCursor;

            // Load the Spirit's save file into a new Merge character.
            Character objMerge = new Character();
            objMerge.FileName = _objCharacter.FileName;
            objMerge.Load();
            objMerge.Possessed = true;
            objMerge.Alias = frmSelectVessel.SelectedItem + " (" + LanguageManager.GetString("String_Possessed") + ")";

            // Get the Node for the selected Vessel.
            XmlNode objSelected = objVesselDoc.SelectSingleNode("/chummer/metatypes/metatype[name = \"" + frmSelectVessel.SelectedItem + "\"]");

            // Get the CharacterAttribute Modifiers for the Vessel.
            int intBOD = Convert.ToInt32(objSelected["bodmin"].InnerText);
            int intAGI = Convert.ToInt32(objSelected["agimin"].InnerText);
            int intREA = Convert.ToInt32(objSelected["reamin"].InnerText);
            int intSTR = Convert.ToInt32(objSelected["strmin"].InnerText);

            //TODO: Update spirit attribute values.
            /* Add the CharacterAttribute modifiers, making sure that none of them go below 1.
            int intSetBOD = objMerge.MAG.TotalValue + intBOD;
            int intSetAGI = objMerge.MAG.TotalValue + intAGI;
            int intSetREA = objMerge.MAG.TotalValue + intREA;
            int intSetSTR = objMerge.MAG.TotalValue + intSTR;

            objMerge.BOD.MetatypeMinimum += intBOD;
            if (objMerge.BOD.MetatypeMinimum < 1)
                objMerge.BOD.MetatypeMinimum = 1;
            objMerge.BOD.MetatypeMaximum += intBOD;
            if (objMerge.BOD.MetatypeMaximum < 1)
                objMerge.BOD.MetatypeMaximum = 1;
            objMerge.BOD.Value = intSetBOD;
            if (objMerge.BOD.Value < 1)
                objMerge.BOD.Value = 1;

            objMerge.AGI.MetatypeMinimum += intAGI;
            if (objMerge.AGI.MetatypeMinimum < 1)
                objMerge.AGI.MetatypeMinimum = 1;
            objMerge.AGI.MetatypeMaximum += intAGI;
            if (objMerge.AGI.MetatypeMaximum < 1)
                objMerge.AGI.MetatypeMaximum = 1;
            objMerge.AGI.Value = intSetAGI;
            if (objMerge.AGI.Value < 1)
                objMerge.AGI.Value = 1;

            objMerge.REA.MetatypeMinimum += intREA;
            if (objMerge.REA.MetatypeMinimum < 1)
                objMerge.REA.MetatypeMinimum = 1;
            objMerge.REA.MetatypeMaximum += intREA;
            if (objMerge.REA.MetatypeMaximum < 1)
                objMerge.REA.MetatypeMaximum = 1;
            objMerge.REA.Value = intSetREA;
            if (objMerge.REA.Value < 1)
                objMerge.REA.Value = 1;

            objMerge.STR.MetatypeMinimum += intSTR;
            if (objMerge.STR.MetatypeMinimum < 1)
                objMerge.STR.MetatypeMinimum = 1;
            objMerge.STR.MetatypeMaximum += intSTR;
            if (objMerge.STR.MetatypeMaximum < 1)
                objMerge.STR.MetatypeMaximum = 1;
            objMerge.STR.Value = intSetSTR;
            if (objMerge.STR.Value < 1)
                objMerge.STR.Value = 1;
            */

            // Update the Movement if the Vessel has one.
            if (objSelected["movement"] != null)
                objMerge.Movement = objSelected["movement"].InnerText;

            // Add any additional Critter Powers the Vessel grants.
            if (objSelected["powers"] != null)
            {
                XmlDocument objXmlPowerDoc = XmlManager.Load("critterpowers.xml");
                foreach (XmlNode objXmlPower in objSelected.SelectNodes("powers/power"))
                {
                    XmlNode objXmlCritterPower = objXmlPowerDoc.SelectSingleNode("/chummer/powers/power[name = \"" + objXmlPower.InnerText + "\"]");
                    CritterPower objPower = new CritterPower(objMerge);
                    string strSelect = string.Empty;
                    int intRating = 0;
                    if (objXmlPower.Attributes["select"] != null)
                        strSelect = objXmlPower.Attributes["select"].InnerText;
                    if (objXmlPower.Attributes["rating"] != null)
                        intRating = Convert.ToInt32(objXmlPower.Attributes["rating"].InnerText);

                    TreeNode objDummy = new TreeNode();
                    objPower.Create(objXmlCritterPower, objDummy, intRating, strSelect);

                    objMerge.CritterPowers.Add(objPower);
                }
            }

            // Give the Critter the Immunity to Normal Weapons Power if they don't already have it.
            bool blnHasImmunity = false;
            foreach (CritterPower objCritterPower in objMerge.CritterPowers)
            {
                if (objCritterPower.Name == "Immunity" && objCritterPower.Extra == "Normal Weapons")
                {
                    blnHasImmunity = true;
                    break;
                }
            }
            if (!blnHasImmunity)
            {
                XmlDocument objPowerDoc = XmlManager.Load("critterpowers.xml");
                XmlNode objPower = objPowerDoc.SelectSingleNode("/chummer/powers/power[name = \"Immunity\"]");

                CritterPower objCritterPower = new CritterPower(objMerge);
                TreeNode objDummy = new TreeNode();
                objCritterPower.Create(objPower, objDummy, 0, "Normal Weapons");
                objMerge.CritterPowers.Add(objCritterPower);
            }

            // Add any Improvements the Vessel grants.
            if (objSelected["bonus"] != null)
            {
                ImprovementManager.CreateImprovements(objMerge, Improvement.ImprovementSource.Metatype, frmSelectVessel.SelectedItem, objSelected["bonus"], false, 1, frmSelectVessel.SelectedItem);
            }

            // Now that everything is done, save the merged character and open them.
            SaveFileDialog saveFileDialog = new SaveFileDialog();
            saveFileDialog.Filter = "Chummer5 Files (*.chum5)|*.chum5|All Files (*.*)|*.*";

            string strShowFileName = string.Empty;
            string[] strFile = _objCharacter.FileName.Split(Path.DirectorySeparatorChar);
            strShowFileName = strFile[strFile.Length - 1];

            if (string.IsNullOrEmpty(strShowFileName))
                strShowFileName = _objCharacter.Alias;
            strShowFileName = strShowFileName.Replace(".chum5", string.Empty);

            strShowFileName += " (" + LanguageManager.GetString("String_Possessed") + ")";

            saveFileDialog.FileName = strShowFileName;

            Cursor = Cursors.Default;

            if (saveFileDialog.ShowDialog(this) == DialogResult.OK)
            {
                Cursor = Cursors.WaitCursor;
                objMerge.FileName = saveFileDialog.FileName;
                if (objMerge.Save())
                {
                    // Get the name of the file and destroy the references to the Vessel and the merged character.
                    string strOpenFile = objMerge.FileName;
                    objMerge.Dispose();
                    objMerge = null;

                    Character objOpenCharacter = frmMain.LoadCharacter(strOpenFile);
                    Cursor = Cursors.Default;
                    GlobalOptions.MainForm.OpenCharacter(objOpenCharacter);
                }
                else
                {
                    // The save process was canceled, so drop everything.
                    objMerge.Dispose();
                    objMerge = null;
                    Cursor = Cursors.Default;
                }
            }
            else
            {
                // The save process was canceled, so drop everything.
                objMerge.Dispose();
                objMerge = null;
            }
        }

        private void mnuEditCopy_Click(object sender, EventArgs e)
        {
            if (tabCharacterTabs.SelectedTab == tabStreetGear)
            {
                // Lifestyle Tab.
                if (tabStreetGearTabs.SelectedTab == tabLifestyle && treLifestyles.SelectedNode != null)
                {
                        // Copy the selected Lifestyle.
                    Lifestyle objCopyLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);

                    if (objCopyLifestyle == null)
                        return;

                    MemoryStream objStream = new MemoryStream();
                    XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                    objWriter.Formatting = Formatting.Indented;
                    objWriter.Indentation = 1;
                    objWriter.IndentChar = '\t';

                    objWriter.WriteStartDocument();

                    // </characters>
                    objWriter.WriteStartElement("character");

                    objCopyLifestyle.Save(objWriter);

                    // </characters>
                    objWriter.WriteEndElement();

                    // Finish the document and flush the Writer and Stream.
                    objWriter.WriteEndDocument();
                    objWriter.Flush();

                    // Read the stream.
                    StreamReader objReader = new StreamReader(objStream);
                    objStream.Position = 0;
                    XmlDocument objCharacterXML = new XmlDocument();

                    // Put the stream into an XmlDocument.
                    string strXML = objReader.ReadToEnd();
                    objCharacterXML.LoadXml(strXML);

                    objWriter.Close();

                    GlobalOptions.Clipboard = objCharacterXML;
                    GlobalOptions.ClipboardContentType = ClipboardContentType.Lifestyle;
                    //Clipboard.SetText(objCharacterXML.OuterXml);
                }

                // Armor Tab.
                else if (tabStreetGearTabs.SelectedTab == tabArmor && treArmor.SelectedNode != null)
                {
                    // Copy the selected Armor.
                    Armor objCopyArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

                    if (objCopyArmor != null)
                    {
                        MemoryStream objStream = new MemoryStream();
                        XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                        objWriter.Formatting = Formatting.Indented;
                        objWriter.Indentation = 1;
                        objWriter.IndentChar = '\t';

                        objWriter.WriteStartDocument();

                        // </characters>
                        objWriter.WriteStartElement("character");

                        objCopyArmor.Save(objWriter);

                        // </characters>
                        objWriter.WriteEndElement();

                        // Finish the document and flush the Writer and Stream.
                        objWriter.WriteEndDocument();
                        objWriter.Flush();

                        // Read the stream.
                        StreamReader objReader = new StreamReader(objStream);
                        objStream.Position = 0;
                        XmlDocument objCharacterXML = new XmlDocument();

                        // Put the stream into an XmlDocument.
                        string strXML = objReader.ReadToEnd();
                        objCharacterXML.LoadXml(strXML);

                        objWriter.Close();

                        GlobalOptions.Clipboard = objCharacterXML;
                        GlobalOptions.ClipboardContentType = ClipboardContentType.Armor;

                        RefreshPasteStatus();
                        return;
                    }

                        // Attempt to copy Gear.
                    Gear objCopyGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

                    if (objCopyGear != null)
                    {
                        MemoryStream objStream = new MemoryStream();
                        XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                        objWriter.Formatting = Formatting.Indented;
                        objWriter.Indentation = 1;
                        objWriter.IndentChar = '\t';

                        objWriter.WriteStartDocument();

                        // </characters>
                        objWriter.WriteStartElement("character");

                        if (objCopyGear.GetType() == typeof(Commlink))
                        {
                            Commlink objCommlink = (Commlink)objCopyGear;
                            objCommlink.Save(objWriter);
                            GlobalOptions.ClipboardContentType = ClipboardContentType.Commlink;
                        }
                        else
                        {
                            objCopyGear.Save(objWriter);
                            GlobalOptions.ClipboardContentType = ClipboardContentType.Gear;
                        }

                        if (objCopyGear.WeaponID != Guid.Empty.ToString())
                        {
                            // <weapons>
                            objWriter.WriteStartElement("weapons");
                            // Copy any Weapon that comes with the Gear.
                            foreach (Weapon objCopyWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objCopyGear.InternalId))
                            {
                                objCopyWeapon.Save(objWriter);
                            }
                            objWriter.WriteEndElement();
                        }

                        // </characters>
                        objWriter.WriteEndElement();

                        // Finish the document and flush the Writer and Stream.
                        objWriter.WriteEndDocument();
                        objWriter.Flush();

                        // Read the stream.
                        StreamReader objReader = new StreamReader(objStream);
                        objStream.Position = 0;
                        XmlDocument objCharacterXML = new XmlDocument();

                        // Put the stream into an XmlDocument.
                        string strXML = objReader.ReadToEnd();
                        objCharacterXML.LoadXml(strXML);

                        objWriter.Close();

                        GlobalOptions.Clipboard = objCharacterXML;

                        RefreshPasteStatus();
                        return;
                    }
                }

                // Weapons Tab.
                else if (tabStreetGearTabs.SelectedTab == tabWeapons && treWeapons.SelectedNode != null)
                {
                    // Copy the selected Weapon.
                    Weapon objCopyWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

                    if (objCopyWeapon != null)
                    {
                        // Do not let the user copy Gear or Cyberware Weapons.
                        if (objCopyWeapon.Category == "Gear" || objCopyWeapon.Cyberware)
                            return;

                        MemoryStream objStream = new MemoryStream();
                        XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                        objWriter.Formatting = Formatting.Indented;
                        objWriter.Indentation = 1;
                        objWriter.IndentChar = '\t';

                        objWriter.WriteStartDocument();

                        // </characters>
                        objWriter.WriteStartElement("character");

                        objCopyWeapon.Save(objWriter);

                        // </characters>
                        objWriter.WriteEndElement();

                        // Finish the document and flush the Writer and Stream.
                        objWriter.WriteEndDocument();
                        objWriter.Flush();

                        // Read the stream.
                        StreamReader objReader = new StreamReader(objStream);
                        objStream.Position = 0;
                        XmlDocument objCharacterXML = new XmlDocument();

                        // Put the stream into an XmlDocument.
                        string strXML = objReader.ReadToEnd();
                        objCharacterXML.LoadXml(strXML);

                        objWriter.Close();

                        GlobalOptions.Clipboard = objCharacterXML;
                        GlobalOptions.ClipboardContentType = ClipboardContentType.Weapon;

                        RefreshPasteStatus();
                        return;
                    }

                    Gear objCopyGear = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

                    if (objCopyGear != null)
                    {
                        MemoryStream objStream = new MemoryStream();
                        XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                        objWriter.Formatting = Formatting.Indented;
                        objWriter.Indentation = 1;
                        objWriter.IndentChar = '\t';

                        objWriter.WriteStartDocument();

                        // </characters>
                        objWriter.WriteStartElement("character");

                        if (objCopyGear.GetType() == typeof(Commlink))
                        {
                            Commlink objCommlink = (Commlink)objCopyGear;
                            objCommlink.Save(objWriter);
                            GlobalOptions.ClipboardContentType = ClipboardContentType.Commlink;
                        }
                        else
                        {
                            objCopyGear.Save(objWriter);
                            GlobalOptions.ClipboardContentType = ClipboardContentType.Gear;
                        }

                        if (objCopyGear.WeaponID != Guid.Empty.ToString())
                        {
                            // <weapons>
                            objWriter.WriteStartElement("weapons");
                            // Copy any Weapon that comes with the Gear.
                            foreach (Weapon objCopyGearWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objCopyGear.InternalId))
                            {
                                objCopyGearWeapon.Save(objWriter);
                            }
                            objWriter.WriteEndElement();
                        }

                        // </characters>
                        objWriter.WriteEndElement();

                        // Finish the document and flush the Writer and Stream.
                        objWriter.WriteEndDocument();
                        objWriter.Flush();

                        // Read the stream.
                        StreamReader objReader = new StreamReader(objStream);
                        objStream.Position = 0;
                        XmlDocument objCharacterXML = new XmlDocument();

                        // Put the stream into an XmlDocument.
                        string strXML = objReader.ReadToEnd();
                        objCharacterXML.LoadXml(strXML);

                        objWriter.Close();

                        GlobalOptions.Clipboard = objCharacterXML;

                        RefreshPasteStatus();
                        return;
                    }
                }
                // Gear Tab.
                else if (tabStreetGearTabs.SelectedTab == tabGear && treGear.SelectedNode != null)
                {
                    // Copy the selected Gear.
                    Gear objCopyGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);

                    if (objCopyGear == null)
                        return;

                    MemoryStream objStream = new MemoryStream();
                    XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                    objWriter.Formatting = Formatting.Indented;
                    objWriter.Indentation = 1;
                    objWriter.IndentChar = '\t';

                    objWriter.WriteStartDocument();

                    // </characters>
                    objWriter.WriteStartElement("character");

                    if (objCopyGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink)objCopyGear;
                        objCommlink.Save(objWriter);
                        GlobalOptions.ClipboardContentType = ClipboardContentType.Commlink;
                    }
                    else
                    {
                        objCopyGear.Save(objWriter);
                        GlobalOptions.ClipboardContentType = ClipboardContentType.Gear;
                    }

                    if (objCopyGear.WeaponID != Guid.Empty.ToString())
                    {
                        // <weapons>
                        objWriter.WriteStartElement("weapons");
                        // Copy any Weapon that comes with the Gear.
                        foreach (Weapon objCopyWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objCopyGear.InternalId))
                        {
                            objCopyWeapon.Save(objWriter);
                        }
                        objWriter.WriteEndElement();
                    }

                    // </characters>
                    objWriter.WriteEndElement();

                    // Finish the document and flush the Writer and Stream.
                    objWriter.WriteEndDocument();
                    objWriter.Flush();

                    // Read the stream.
                    StreamReader objReader = new StreamReader(objStream);
                    objStream.Position = 0;
                    XmlDocument objCharacterXML = new XmlDocument();

                    // Put the stream into an XmlDocument.
                    string strXML = objReader.ReadToEnd();
                    objCharacterXML.LoadXml(strXML);

                    objWriter.Close();

                    GlobalOptions.Clipboard = objCharacterXML;
                    //Clipboard.SetText(objCharacterXML.OuterXml);
                }
            }

            // Vehicles Tab.
            else if (tabCharacterTabs.SelectedTab == tabVehicles && treVehicles.SelectedNode != null)
            {
                if (treVehicles.SelectedNode != null)
                {
                    if (treVehicles.SelectedNode.Level == 1)
                    {
                        // Copy the selected Vehicle.
                        Vehicle objCopyVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

                        MemoryStream objStream = new MemoryStream();
                        XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                        objWriter.Formatting = Formatting.Indented;
                        objWriter.Indentation = 1;
                        objWriter.IndentChar = '\t';

                        objWriter.WriteStartDocument();

                        // </characters>
                        objWriter.WriteStartElement("character");

                        objCopyVehicle.Save(objWriter);

                        // </characters>
                        objWriter.WriteEndElement();

                        // Finish the document and flush the Writer and Stream.
                        objWriter.WriteEndDocument();
                        objWriter.Flush();

                        // Read the stream.
                        StreamReader objReader = new StreamReader(objStream);
                        objStream.Position = 0;
                        XmlDocument objCharacterXML = new XmlDocument();

                        // Put the stream into an XmlDocument.
                        string strXML = objReader.ReadToEnd();
                        objCharacterXML.LoadXml(strXML);

                        objWriter.Close();

                        GlobalOptions.Clipboard = objCharacterXML;
                        GlobalOptions.ClipboardContentType = ClipboardContentType.Vehicle;
                        //Clipboard.SetText(objCharacterXML.OuterXml);
                    }
                    else
                    {
                        Gear objCopyGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

                        if (objCopyGear != null)
                        {
                            MemoryStream objStream = new MemoryStream();
                            XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                            objWriter.Formatting = Formatting.Indented;
                            objWriter.Indentation = 1;
                            objWriter.IndentChar = '\t';

                            objWriter.WriteStartDocument();

                            // </characters>
                            objWriter.WriteStartElement("character");

                            if (objCopyGear.GetType() == typeof(Commlink))
                            {
                                Commlink objCommlink = (Commlink)objCopyGear;
                                objCommlink.Save(objWriter);
                                GlobalOptions.ClipboardContentType = ClipboardContentType.Commlink;
                            }
                            else
                            {
                                objCopyGear.Save(objWriter);
                                GlobalOptions.ClipboardContentType = ClipboardContentType.Gear;
                            }

                            if (objCopyGear.WeaponID != Guid.Empty.ToString())
                            {
                                // <weapons>
                                objWriter.WriteStartElement("weapons");
                                // Copy any Weapon that comes with the Gear.
                                foreach (Weapon objCopyWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objCopyGear.InternalId))
                                {
                                    objCopyWeapon.Save(objWriter);
                                }
                                objWriter.WriteEndElement();
                            }

                            // </characters>
                            objWriter.WriteEndElement();

                            // Finish the document and flush the Writer and Stream.
                            objWriter.WriteEndDocument();
                            objWriter.Flush();

                            // Read the stream.
                            StreamReader objReader = new StreamReader(objStream);
                            objStream.Position = 0;
                            XmlDocument objCharacterXML = new XmlDocument();

                            // Put the stream into an XmlDocument.
                            string strXML = objReader.ReadToEnd();
                            objCharacterXML.LoadXml(strXML);

                            objWriter.Close();

                            GlobalOptions.Clipboard = objCharacterXML;

                            RefreshPasteStatus();
                            return;
                        }

                        foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
                        {
                            foreach (VehicleMod objMod in objCharacterVehicle.Mods)
                            {
                                Weapon objCopyWeapon = CommonFunctions.DeepFindById(treVehicles.SelectedNode.Tag.ToString(), objMod.Weapons);
                                if (objCopyWeapon != null)
                                {
                                    // Do not let the user copy Gear or Cyberware Weapons.
                                    if (objCopyWeapon.Category == "Gear" || objCopyWeapon.Cyberware)
                                        return;

                                    MemoryStream objStream = new MemoryStream();
                                    XmlTextWriter objWriter = new XmlTextWriter(objStream, System.Text.Encoding.Unicode);
                                    objWriter.Formatting = Formatting.Indented;
                                    objWriter.Indentation = 1;
                                    objWriter.IndentChar = '\t';

                                    objWriter.WriteStartDocument();

                                    // </characters>
                                    objWriter.WriteStartElement("character");

                                    objCopyWeapon.Save(objWriter);

                                    // </characters>
                                    objWriter.WriteEndElement();

                                    // Finish the document and flush the Writer and Stream.
                                    objWriter.WriteEndDocument();
                                    objWriter.Flush();

                                    // Read the stream.
                                    StreamReader objReader = new StreamReader(objStream);
                                    objStream.Position = 0;
                                    XmlDocument objCharacterXML = new XmlDocument();

                                    // Put the stream into an XmlDocument.
                                    string strXML = objReader.ReadToEnd();
                                    objCharacterXML.LoadXml(strXML);

                                    objWriter.Close();

                                    GlobalOptions.Clipboard = objCharacterXML;
                                    GlobalOptions.ClipboardContentType = ClipboardContentType.Weapon;

                                    RefreshPasteStatus();
                                    return;
                                }
                            }
                        }
                    }
                }
            }
            RefreshPasteStatus();
        }

        private void tsbCopy_Click(object sender, EventArgs e)
        {
            mnuEditCopy_Click(sender, e);
        }

        private void mnuSpecialConvertToFreeSprite_Click(object sender, EventArgs e)
        {
            XmlDocument objXmlDocument = XmlManager.Load("critterpowers.xml");
            XmlNode objXmlPower = objXmlDocument.SelectSingleNode("/chummer/powers/power[name = \"Denial\"]");
            TreeNode objNode = new TreeNode();
            CritterPower objPower = new CritterPower(_objCharacter);
            objPower.Create(objXmlPower, objNode);
            objPower.CountTowardsLimit = false;
            objNode.ContextMenuStrip = cmsCritterPowers;
            if (objPower.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.CritterPowers.Add(objPower);

            treCritterPowers.Nodes[0].Nodes.Add(objNode);
            treCritterPowers.Nodes[0].Expand();

            _objCharacter.MetatypeCategory = "Free Sprite";
            mnuSpecialConvertToFreeSprite.Visible = false;

            treCritterPowers.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void mnuSpecialAddCyberwareSuite_Click(object sender, EventArgs e)
        {
            AddCyberwareSuite(Improvement.ImprovementSource.Cyberware);
        }

        private void mnuSpecialAddBiowareSuite_Click(object sender, EventArgs e)
        {
            AddCyberwareSuite(Improvement.ImprovementSource.Bioware);
        }
#endregion

#region AttributeControl Events
        private void objAttribute_ValueChanged(Object sender, EventArgs e)
        {
            // Handle the AttributeValueChanged Event for the AttributeControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region SpellDefense Events
        private void UpdateSpellDefence(Dictionary<string, int> dicAttributeTotalValues)
        {
            // Update the Spell Defence labels.
            string strSpellTooltip = string.Empty;
            string strModifiers = LanguageManager.GetString("Tip_Modifiers");
            string strCounterSpelling = LanguageManager.GetString("Label_CounterspellingDice");
            string strSpellResistance = LanguageManager.GetString("String_SpellResistanceDice");
            //Indirect Dodge
            lblSpellDefenceIndirectDodge.Text = (dicAttributeTotalValues["INT"] + dicAttributeTotalValues["REA"] + _objCharacter.TotalBonusDodgeRating).ToString();
            strSpellTooltip = $"{strModifiers}: " +
                              $"{_objCharacter.INT.DisplayAbbrev} ({dicAttributeTotalValues["INT"]}) + {_objCharacter.REA.DisplayAbbrev} ({dicAttributeTotalValues["REA"]}) + {strModifiers} ({_objCharacter.TotalBonusDodgeRating})";
            tipTooltip.SetToolTip(lblSpellDefenceIndirectDodge, strSpellTooltip);
            //Indirect Soak
            int intTotalArmor = _objCharacter.TotalArmorRating;
            lblSpellDefenceIndirectSoak.Text = (intTotalArmor + dicAttributeTotalValues["BOD"]).ToString();
            strSpellTooltip = $"{strModifiers}: " +
                              $"{LanguageManager.GetString("Tip_Armor")} ({intTotalArmor}) + {_objCharacter.BOD.DisplayAbbrev} ({dicAttributeTotalValues["BOD"]})";
            tipTooltip.SetToolTip(lblSpellDefenceIndirectSoak, strSpellTooltip);
            //Direct Soak - Mana
            lblSpellDefenceDirectSoakMana.Text = (dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: " +
                              $"{_objCharacter.WIL.DisplayAbbrev} ({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDirectSoakMana, strSpellTooltip);
            //Direct Soak - Physical
            lblSpellDefenceDirectSoakPhysical.Text = (dicAttributeTotalValues["BOD"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.BOD.DisplayAbbrev} ({dicAttributeTotalValues["BOD"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDirectSoakPhysical, strSpellTooltip);
            //Detection Spells
            lblSpellDefenceDetection.Text =
                (dicAttributeTotalValues["LOG"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DetectionSpellResist)).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: " +
                              $"{_objCharacter.LOG.DisplayAbbrev} ({dicAttributeTotalValues["LOG"]}) + {_objCharacter.WIL.DisplayAbbrev} ({dicAttributeTotalValues["WIL"]}) " +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance}) + {strModifiers} ({ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DetectionSpellResist)})";
            tipTooltip.SetToolTip(lblSpellDefenceDetection, strSpellTooltip);
            //Decrease Attribute - BOD
            lblSpellDefenceDecAttBOD.Text =
                (dicAttributeTotalValues["BOD"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.BOD.DisplayAbbrev} ({dicAttributeTotalValues["BOD"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttBOD, strSpellTooltip);
            //Decrease Attribute - AGI
            lblSpellDefenceDecAttAGI.Text =
                (dicAttributeTotalValues["AGI"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.AGI.DisplayAbbrev} ({dicAttributeTotalValues["AGI"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttAGI, strSpellTooltip);
            //Decrease Attribute - REA
            lblSpellDefenceDecAttREA.Text =
                (dicAttributeTotalValues["REA"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.REA.DisplayAbbrev} ({dicAttributeTotalValues["REA"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttREA, strSpellTooltip);
            //Decrease Attribute - STR
            lblSpellDefenceDecAttSTR.Text =
                (dicAttributeTotalValues["STR"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.STR.DisplayAbbrev} ({dicAttributeTotalValues["STR"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttSTR, strSpellTooltip);
            //Decrease Attribute - CHA
            lblSpellDefenceDecAttCHA.Text =
                (dicAttributeTotalValues["CHA"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.CHA.DisplayAbbrev} ({dicAttributeTotalValues["CHA"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttCHA, strSpellTooltip);
            //Decrease Attribute - INT
            lblSpellDefenceDecAttINT.Text =
                (dicAttributeTotalValues["INT"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.INT.DisplayAbbrev} ({dicAttributeTotalValues["INT"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttINT, strSpellTooltip);
            //Decrease Attribute - LOG
            lblSpellDefenceDecAttLOG.Text =
                (dicAttributeTotalValues["LOG"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.LOG.DisplayAbbrev} ({dicAttributeTotalValues["LOG"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttLOG, strSpellTooltip);
            //Decrease Attribute - WIL
            lblSpellDefenceDecAttWIL.Text =
                (dicAttributeTotalValues["WIL"] + dicAttributeTotalValues["WIL"] + nudCounterspellingDice.Value).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.WIL.DisplayAbbrev} ({dicAttributeTotalValues["WIL"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance})";
            tipTooltip.SetToolTip(lblSpellDefenceDecAttWIL, strSpellTooltip);
            //Illusion - Mana
            lblSpellDefenceIllusionMana.Text =
                (dicAttributeTotalValues["WIL"] + dicAttributeTotalValues["LOG"] + nudCounterspellingDice.Value + _objCharacter.SpellResistance + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.ManaIllusionResist)).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.LOG.DisplayAbbrev} ({dicAttributeTotalValues["LOG"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance}) + {strModifiers} ({ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.ManaIllusionResist)})";
            tipTooltip.SetToolTip(lblSpellDefenceIllusionMana, strSpellTooltip);
            //Illusion - Physical
            lblSpellDefenceIllusionPhysical.Text =
                (dicAttributeTotalValues["INT"] + dicAttributeTotalValues["LOG"] + nudCounterspellingDice.Value + _objCharacter.SpellResistance + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.PhysicalIllusionResist)).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.INT.DisplayAbbrev} ({dicAttributeTotalValues["INT"]}) +{_objCharacter.LOG.DisplayAbbrev} +({dicAttributeTotalValues["LOG"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance}) + {strModifiers} ({ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.PhysicalIllusionResist)})";
            tipTooltip.SetToolTip(lblSpellDefenceIllusionPhysical, strSpellTooltip);
            //Manipulation - Mental
            lblSpellDefenceManipMental.Text =
                (dicAttributeTotalValues["WIL"] + dicAttributeTotalValues["LOG"] + nudCounterspellingDice.Value + _objCharacter.SpellResistance + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.MentalManipulationResist)).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.LOG.DisplayAbbrev} ({dicAttributeTotalValues["LOG"]}) +{_objCharacter.WIL.DisplayAbbrev} +({dicAttributeTotalValues["WIL"]})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance}) + {strModifiers} ({ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.MentalManipulationResist)})";
            tipTooltip.SetToolTip(lblSpellDefenceManipMental, strSpellTooltip);
            //Manipulation - Physical
            lbllSpellDefenceManipPhysical.Text =
                (dicAttributeTotalValues["STR"] + dicAttributeTotalValues["BOD"] + nudCounterspellingDice.Value + _objCharacter.SpellResistance + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.PhysicalManipulationResist)).ToString(GlobalOptions.CultureInfo);
            strSpellTooltip = $"{strModifiers}: {_objCharacter.STR.DisplayAbbrev} ({dicAttributeTotalValues["STR"]}) +{_objCharacter.BOD.DisplayAbbrev} +({_objCharacter.BOD.TotalValue})" +
                              $" + {strCounterSpelling} ({nudCounterspellingDice.Value}) + {strSpellResistance} ({_objCharacter.SpellResistance}) + {strModifiers} ({ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.PhysicalManipulationResist)})";
            tipTooltip.SetToolTip(lbllSpellDefenceManipPhysical, strSpellTooltip);
        }

        private void nudCounterspellingDice_Changed(object sender, EventArgs e)
        {
            Dictionary<string, int> dicAttributeTotalValues = new Dictionary<string, int>(AttributeSection.AttributeStrings.Length);
            foreach (string strAttribute in AttributeSection.AttributeStrings)
            {
                dicAttributeTotalValues.Add(strAttribute, _objCharacter.GetAttribute(strAttribute).TotalValue);
            }
            UpdateSpellDefence(dicAttributeTotalValues);
        }
#endregion

#region ContactControl Events
        private void objContact_ConnectionRatingChanged(Object sender)
        {
            // Handle the ConnectionRatingChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void ObjContactGroupStatusChanged(Object sender)
        {
            // Handle the GroupStatusChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objContact_LoyaltyRatingChanged(Object sender)
        {
            // Handle the LoyaltyRatingChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objContact_OtherCostChanged(Object sender)
        {
            //Handle any other kind of change that changes contact cost
            //mostly a free contact but a few details in run faster changes it too
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objContact_DeleteContact(Object sender)
        {
            objContact_DeleteContact(sender, false);
        }

        private void objContact_DeleteContact(Object sender, bool force)
        {
            if (!force && !CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteContact")))
                return;

            // Handle the DeleteContact Event for the ContactControl object.
            ContactControl objSender = (ContactControl) sender;
            bool blnFound = false;
            foreach (ContactControl objContactControl in panContacts.Controls)
            {
                // Set the flag to show that we have found the Contact.
                if (objContactControl == objSender)
                {
                    blnFound = true;
                    _objCharacter.Contacts.Remove(objContactControl.ContactObject);
                }

                // Once the Contact has been found, all of the other ContactControls on the Panel should move up 25 pixels to fill in the gap that deleting this one will cause.
                if (blnFound)
                {
                    objContactControl.Top -= 25;
                }
            }
            // Remove the ContactControl that raised the Event.
            panContacts.Controls.Remove(objSender);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objContact_FileNameChanged(Object sender)
        {
            // Handle the FileNameChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region EnemyControl Events
        private void objEnemy_ConnectionRatingChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void ObjEnemyGroupStatusChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objEnemy_LoyaltyRatingChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objEnemy_FreeStatusChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objEnemy_DeleteContact(Object sender)
        {
            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteEnemy")))
                return;

            // Determine the Karam cost to remove the Enemy.
            ContactControl objSender = (ContactControl)sender;
            int intKarmaCost = (objSender.ConnectionRating + objSender.LoyaltyRating) * _objOptions.KarmaQuality;

            bool blnKarmaExpense = ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseEnemy").Replace("{0}", intKarmaCost.ToString()));

            if (blnKarmaExpense)
            {
                // Make sure the character has enough Karma.
                if (intKarmaCost > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseRemoveEnemy") + " " + objSender.ContactName, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaCost;
            }

            // Handle the DeleteContact Event for the ContactControl object.
            bool blnFound = false;
            foreach (ContactControl objContactControl in panEnemies.Controls)
            {
                // Set the flag to show that we have found the contact.
                if (objContactControl == objSender)
                    blnFound = true;

                // Once the Enemy has been found, all of the other ContactControls on the Panel should move up 25 pixels to fill in the gap that deleting this one will cause.
                if (blnFound)
                {
                    _objCharacter.Contacts.Remove(objContactControl.ContactObject);
                    objContactControl.Top -= 25;
                }
            }
            // Remove the ContactControl that raised the Event.
            panEnemies.Controls.Remove(objSender);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objEnemy_FileNameChanged(Object sender)
        {
            // Handle the FileNameChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region PetControl Events
        private void objPet_DeleteContact(Object sender)
        {
            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteContact")))
                return;

            // Handle the DeleteContact Event for the ContactControl object.
            PetControl objSender = (PetControl)sender;
            bool blnFound = false;
            foreach (PetControl objContactControl in panPets.Controls)
            {
                // Set the flag to show that we have found the Contact.
                if (objContactControl == objSender)
                    blnFound = true;

                // Once the Contact has been found, all of the other ContactControls on the Panel should move up 25 pixels to fill in the gap that deleting this one will cause.
                if (blnFound)
                    _objCharacter.Contacts.Remove(objContactControl.ContactObject);
            }
            // Remove the ContactControl that raised the Event.
            panPets.Controls.Remove(objSender);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objPet_FileNameChanged(Object sender)
        {
            // Handle the FileNameChanged Event for the ContactControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region SpiritControl Events
        private void objSpirit_ForceChanged(Object sender)
        {
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSpirit_BoundChanged(Object sender)
        {
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSpirit_FetteredChanged(Object sender)
        {
            SpiritControl Control = (SpiritControl) sender;
            Spirit thisSpirit = Control.SpiritObject;
            if (thisSpirit.Fettered)
            {
                int FetteringCost = thisSpirit.Force * 3;
                if (
                    !ConfirmKarmaExpense(
                        LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend")
                            .Replace("{0}", thisSpirit.Name)
                            .Replace("{1}", FetteringCost.ToString())))
                {
                    return;
                }

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(FetteringCost * -1,
                    LanguageManager.GetString("String_ExpenseFetteredSpirit") + " " + thisSpirit.Name,
                    ExpenseType.Karma, DateTime.Now);
                thisSpirit.CharacterObject.ExpenseEntries.Add(objExpense);
                thisSpirit.CharacterObject.Karma -= FetteringCost;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.SpiritFettering, thisSpirit.InternalId);
                objExpense.Undo = objUndo;
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSpirit_ServicesOwedChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSpirit_DeleteSpirit(Object sender)
        {
            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteSpirit")))
                return;

            // Handle the DeleteSpirit Event for the SpiritControl object.
            SpiritControl objSender = (SpiritControl)sender;
            bool blnFound = false;
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
            {
                // Set the flag to show that we have found the Spirit.
                if (objSpiritControl == objSender)
                    blnFound = true;

                // Once the Spirit has been found, all of the other SpiritControls on the Panel should move up 25 pixels to fill in the gap that deleting this one will cause.
                if (blnFound)
                {
                    _objCharacter.Spirits.Remove(objSpiritControl.SpiritObject);
                    objSpiritControl.Top -= 25;
                }
            }
            // Remove the SpiritControl that raised the Event.
            panSpirits.Controls.Remove(objSender);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSpirit_FileNameChanged(Object sender)
        {
            // Handle the FileNameChanged Event for the SpritControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region SpriteControl (SpiritControl) Events
        private void objSprite_ForceChanged(Object sender)
        {
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSprite_BoundChanged(Object sender)
        {
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSprite_ServicesOwedChanged(Object sender)
        {
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSprite_DeleteSpirit(Object sender)
        {
            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteSprite")))
                return;

            // Handle the DeleteSpirit Event for the SpiritControl object.
            SpiritControl objSender = (SpiritControl)sender;
            bool blnFound = false;
            foreach (SpiritControl objSpriteControl in panSprites.Controls)
            {
                // Set the flag to show that we have found the Sprite.
                if (objSpriteControl == objSender)
                    blnFound = true;

                // Once the Spirit has been found, all of the other SpiritControls on the Panel should move up 25 pixels to fill in the gap that deleting this one will cause.
                if (blnFound)
                {
                    _objCharacter.Spirits.Remove(objSpriteControl.SpiritObject);
                    objSpriteControl.Top -= 25;
                }
            }
            // Remove the SpiritControl that raised the Event.
            panSprites.Controls.Remove(objSender);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void objSprite_FileNameChanged(Object sender)
        {
            // Handle the FileNameChanged Event for the SpritControl object.
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Martial Tab Control Events
        private void treMartialArts_AfterSelect(object sender, TreeViewEventArgs e)
        {
            _blnSkipRefresh = true;
            if (treMartialArts.SelectedNode != null)
            {
                // The Rating NUD is only enabled if a Martial Art is currently selected.
                if (treMartialArts.SelectedNode.Level == 1 && treMartialArts.SelectedNode.Parent == treMartialArts.Nodes[0])
                {
                    MartialArt objMartialArt = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);

                    string strBook = _objOptions.LanguageBookShort(objMartialArt.Source);
                    string strPage = objMartialArt.Page;
                    lblMartialArtSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblMartialArtSource, _objOptions.LanguageBookLong(objMartialArt.Source) + " " + LanguageManager.GetString("String_Page") + " " + objMartialArt.Page);
                }

                // Display the Martial Art Advantage information.
                if (treMartialArts.SelectedNode.Level == 2)
                {
                    MartialArt objMartialArt = null;
                    MartialArtAdvantage objAdvantage = CommonFunctions.FindMartialArtAdvantage(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts, out objMartialArt);

                    string strBook = _objOptions.LanguageBookShort(objMartialArt.Source);
                    string strPage = objMartialArt.Page;
                    lblMartialArtSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblMartialArtSource, _objOptions.LanguageBookLong(objMartialArt.Source) + " page " + objMartialArt.Page);
                }

                // Display the Maneuver information.
                if (treMartialArts.SelectedNode.Level == 1 && treMartialArts.SelectedNode.Parent == treMartialArts.Nodes[1])
                {
                    MartialArtManeuver objManeuver = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArtManeuvers);

                    string strBook = _objOptions.LanguageBookShort(objManeuver.Source);
                    string strPage = objManeuver.Page;
                    lblMartialArtSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblMartialArtSource, _objOptions.LanguageBookLong(objManeuver.Source) + " page " + objManeuver.Page);
                }
            }
            _blnSkipRefresh = false;
        }
#endregion

#region Button Events
        private void treLimit_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteLimitModifier_Click(sender, e);
            }
        }
        private void panContacts_DragDrop(object sender, DragEventArgs e)
        {
            TransportWrapper wrapper = (TransportWrapper)e.Data.GetData(typeof(TransportWrapper));
            Control source = wrapper.Control;

            Point mousePosition = panContacts.PointToClient(new Point(e.X, e.Y));
            Control destination = panContacts.GetChildAtPoint(mousePosition);

            int indexDestination = panContacts.Controls.IndexOf(destination);
            if (panContacts.Controls.IndexOf(source) < indexDestination)
                indexDestination--;

            panContacts.Controls.SetChildIndex(source, indexDestination);

            foreach (ContactControl objControl in panContacts.Controls)
            {
                    objControl.BackColor = SystemColors.Control;
            }
        }

        private void panContacts_DragOver(object sender, DragEventArgs e)
        {
            Point mousePosition = panContacts.PointToClient(new Point(e.X, e.Y));
            Control destination = panContacts.GetChildAtPoint(mousePosition);

            if (destination == null)
                return;

            destination.BackColor = SystemColors.ControlDark;
            foreach (ContactControl objControl in panContacts.Controls)
            {
                if (objControl != (destination as ContactControl))
                {
                    objControl.BackColor = SystemColors.Control;
                }
            }
            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
        }

        void panContacts_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void panContactControl_MouseDown(object sender, MouseEventArgs e)
        {
            Control source = (Control)sender;
            source.DoDragDrop(new TransportWrapper(source), DragDropEffects.Move);
        }

        private void cmdAddContact_Click(object sender, EventArgs e)
        {
            Contact objContact = new Contact(_objCharacter);
            _objCharacter.Contacts.Add(objContact);

            int i = panContacts.Controls.Count;
            ContactControl objContactControl = new ContactControl(_objCharacter);
            objContactControl.ContactObject = objContact;
            objContactControl.EntityType = ContactType.Contact;

            // Attach an EventHandler for the ConnectionRatingChanged, LoyaltyRatingChanged, DeleteContact, and FileNameChanged Events.
            objContactControl.ConnectionRatingChanged += objContact_ConnectionRatingChanged;
            objContactControl.LoyaltyRatingChanged += objContact_LoyaltyRatingChanged;
            objContactControl.DeleteContact += objContact_DeleteContact;
            objContactControl.FileNameChanged += objContact_FileNameChanged;
            objContactControl.FreeRatingChanged += objContact_OtherCostChanged;
            objContactControl.MouseDown += panContactControl_MouseDown;
            objContactControl.FamilyChanged += objContact_OtherCostChanged;
            objContactControl.BlackmailChanged += objContact_OtherCostChanged;

            panContacts.Controls.Add(objContactControl);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddEnemy_Click(object sender, EventArgs e)
        {
            // Handle the ConnectionRatingChanged Event for the ContactControl object.
            Contact objContact = new Contact(_objCharacter);
            _objCharacter.Contacts.Add(objContact);

            int i = panEnemies.Controls.Count;
            ContactControl objContactControl = new ContactControl(_objCharacter);
            objContactControl.ContactObject = objContact;
            objContactControl.EntityType = ContactType.Enemy;

            // Attach an EventHandler for the ConnectioNRatingChanged, LoyaltyRatingChanged, DeleteContact, and FileNameChanged Events.
            objContactControl.ConnectionRatingChanged += objEnemy_ConnectionRatingChanged;
            objContactControl.LoyaltyRatingChanged += objEnemy_LoyaltyRatingChanged;
            objContactControl.DeleteContact += objEnemy_DeleteContact;
            objContactControl.FileNameChanged += objEnemy_FileNameChanged;
            objContactControl.FreeRatingChanged += objEnemy_FreeStatusChanged;

            panEnemies.Controls.Add(objContactControl);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddSpell_Click(object sender, EventArgs e)
        {
            int intSpellKarmaCost = _objCharacter.SpellKarmaCost;
            // Make sure the character has enough Karma before letting them select a Spell.
            if (_objCharacter.Karma < intSpellKarmaCost)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectSpell frmPickSpell = new frmSelectSpell(_objCharacter);
            frmPickSpell.ExpandedCategories = lstExpandSpellCategories;
            frmPickSpell.ShowDialog(this);
            // Make sure the dialogue window was not canceled.
            if (frmPickSpell.DialogResult == DialogResult.Cancel)
                return;

            lstExpandSpellCategories = frmPickSpell.ExpandedCategories;

            // Open the Spells XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("spells.xml");

            XmlNode objXmlSpell = objXmlDocument.SelectSingleNode("/chummer/spells/spell[id = \"" + frmPickSpell.SelectedSpell + "\"]");

            Spell objSpell = new Spell(_objCharacter);
            TreeNode objNode = new TreeNode();
            objSpell.Create(objXmlSpell, objNode, string.Empty, frmPickSpell.Limited, frmPickSpell.Extended, frmPickSpell.Alchemical);
            objNode.ContextMenuStrip = cmsSpell;
            if (objSpell.InternalId == Guid.Empty.ToString())
                return;
            objSpell.FreeBonus = frmPickSpell.FreeBonus;
            if (!objSpell.FreeBonus)
            {
                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend")
                    .Replace("{0}", objSpell.DisplayName).Replace("{1}", intSpellKarmaCost.ToString())))
                    return;
            }
            // Barehanded Adept
            else if (_objCharacter.AdeptEnabled && !_objCharacter.MagicianEnabled && objSpell.Range == "T")
            {
                objSpell.UsesUnarmed = true;
            }

            _objCharacter.Spells.Add(objSpell);

            switch (objSpell.Category)
            {
                case "Combat":
                    treSpells.Nodes[0].Nodes.Add(objNode);
                    treSpells.Nodes[0].Expand();
                    break;
                case "Detection":
                    treSpells.Nodes[1].Nodes.Add(objNode);
                    treSpells.Nodes[1].Expand();
                    break;
                case "Health":
                    treSpells.Nodes[2].Nodes.Add(objNode);
                    treSpells.Nodes[2].Expand();
                    break;
                case "Illusion":
                    treSpells.Nodes[3].Nodes.Add(objNode);
                    treSpells.Nodes[3].Expand();
                    break;
                case "Manipulation":
                    treSpells.Nodes[4].Nodes.Add(objNode);
                    treSpells.Nodes[4].Expand();
                    break;
                case "Rituals":
                    /*
                    int intNode = 5;
                    if (_objCharacter.AdeptEnabled && !_objCharacter.MagicianEnabled)
                        intNode = 0;
                    treSpells.Nodes[intNode].Nodes.Add(objNode);
                    treSpells.Nodes[intNode].Expand();
                    */
                    treSpells.Nodes[5].Nodes.Add(objNode);
                    treSpells.Nodes[5].Expand();
                    break;
                case "Enchantments":
                    treSpells.Nodes[6].Nodes.Add(objNode);
                    treSpells.Nodes[6].Expand();
                    break;
            }

            treSpells.SelectedNode = objNode;
            if (!objSpell.FreeBonus)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(-intSpellKarmaCost, LanguageManager.GetString("String_ExpenseLearnSpell") + " " + objSpell.Name, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);
                _objCharacter.Karma -= intSpellKarmaCost;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddSpell, objSpell.InternalId);
                objEntry.Undo = objUndo;
            }
            treSpells.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickSpell.AddAgain)
                cmdAddSpell_Click(sender, e);
        }

        private void cmdDeleteSpell_Click(object sender, EventArgs e)
        {
            // Delete the selected Spell.
            if (treSpells.SelectedNode != null)
            {
                if (treSpells.SelectedNode.Level > 0)
                {
                    // Locate the Spell that is selected in the tree.
                    Spell objSpell = CommonFunctions.FindByIdWithNameCheck(treSpells.SelectedNode.Tag.ToString(), _objCharacter.Spells);

                    // Cannot delete spells acquired through initiation
                    if (objSpell.Grade != 0 )
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveSpell"), LanguageManager.GetString("MessageTitle_CannotRemoveSpell"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteSpell")))
                        return;

                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Spell, objSpell.InternalId);

                    _objCharacter.Spells.Remove(objSpell);
                    treSpells.SelectedNode.Remove();
                }
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
            }

        private void cmdAddSpirit_Click(object sender, EventArgs e)
        {
            int i = panSpirits.Controls.Count;

            Spirit objSpirit = new Spirit(_objCharacter);
            _objCharacter.Spirits.Add(objSpirit);

            SpiritControl objSpiritControl = new SpiritControl(true);
            objSpiritControl.SpiritObject = objSpirit;
            objSpiritControl.EntityType = SpiritType.Spirit;

            // Attach an EventHandler for the ServicesOwedChanged Event.
            objSpiritControl.ServicesOwedChanged += objSpirit_ServicesOwedChanged;
            objSpiritControl.ForceChanged += objSpirit_ForceChanged;
            objSpiritControl.BoundChanged += objSpirit_BoundChanged;
            objSpiritControl.FetteredChanged += objSpirit_FetteredChanged;
            objSpiritControl.DeleteSpirit += objSpirit_DeleteSpirit;
            objSpiritControl.FileNameChanged += objSpirit_FileNameChanged;

            if (_objOptions.SpiritForceBasedOnTotalMAG)
            {
                int intMAGTotalValue = _objCharacter.MAG.TotalValue;
                objSpiritControl.ForceMaximum = intMAGTotalValue * 2;
                objSpiritControl.Force = intMAGTotalValue;
            }
            else
            {
                int intMAG = Convert.ToInt32(_objCharacter.MAG.Value);
                if (intMAG == 0)
                    intMAG = 1;
                objSpiritControl.ForceMaximum = intMAG * 2;
                objSpiritControl.Force = intMAG;
            }
            objSpiritControl.RebuildSpiritList(_objCharacter.MagicTradition);

            objSpiritControl.Top = i * objSpiritControl.Height;
            panSpirits.Controls.Add(objSpiritControl);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddSprite_Click(object sender, EventArgs e)
        {
            int i = panSprites.Controls.Count;

            Spirit objSprite = new Spirit(_objCharacter);
            _objCharacter.Spirits.Add(objSprite);

            SpiritControl objSpriteControl = new SpiritControl(true);
            objSpriteControl.SpiritObject = objSprite;
            objSpriteControl.EntityType = SpiritType.Sprite;

            // Attach an EventHandler for the ServicesOwedChanged Event.
            objSpriteControl.ServicesOwedChanged += objSprite_ServicesOwedChanged;
            objSpriteControl.ForceChanged += objSprite_ForceChanged;
            objSpriteControl.BoundChanged += objSprite_BoundChanged;
            objSpriteControl.DeleteSpirit += objSprite_DeleteSpirit;
            objSpriteControl.FileNameChanged += objSprite_FileNameChanged;

            objSpriteControl.ForceMaximum = _objCharacter.RES.TotalValue * 2;
            objSpriteControl.Force = Convert.ToInt32(_objCharacter.RES.Value);
            objSpriteControl.RebuildSpiritList(_objCharacter.TechnomancerStream);

            objSpriteControl.Top = i * objSpriteControl.Height;
            panSprites.Controls.Add(objSpriteControl);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddCyberware_Click(object sender, EventArgs e)
        {
            // Select the root Cyberware node then open the Select Cyberware window.
            treCyberware.SelectedNode = treCyberware.Nodes[0];
            bool blnAddAgain = PickCyberware();
            if (blnAddAgain)
                cmdAddCyberware_Click(sender, e);
        }

        private void cmdDeleteCyberware_Click(object sender, EventArgs e)
        {
            if (treCyberware.SelectedNode != null)
            {
                if (treCyberware.SelectedNode.Level > 0)
                {
                    Cyberware objParent = null;
                    XmlDocument objXmlDocument = null;
                    // Locate the piece of Cyberware that is selected in the tree.
                    Cyberware objCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);
                    if (objCyberware != null)
                    {
                        objParent = objCyberware.Parent;

                        if (objCyberware.SourceType == Improvement.ImprovementSource.Bioware)
                        {
                            objXmlDocument = XmlManager.Load("bioware.xml");
                        }
                        else
                        {
                            objXmlDocument = XmlManager.Load("cyberware.xml");
                        }

                        if (objCyberware.Capacity == "[*]" && treCyberware.SelectedNode.Level == 2)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveCyberware"), LanguageManager.GetString("MessageTitle_CannotRemoveCyberware"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        if (objCyberware.SourceType == Improvement.ImprovementSource.Cyberware)
                        {
                            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteCyberware")))
                                return;
                        }
                        if (objCyberware.SourceType == Improvement.ImprovementSource.Bioware)
                        {
                            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteBioware")))
                                return;
                        }

                        CommonFunctions.DeleteCyberware(_objCharacter, objCyberware, treWeapons, treVehicles);
                        // Remove the Children.
                        objCyberware.Children.Clear();

                        _objCharacter.Cyberware.Remove(objCyberware);

                        if (objCyberware.Parent == null)
                        {
                            //Add essence hole.
                            IncreaseEssenceHole((int) (objCyberware.CalculatedESS() * 100m));
                        }

                        // Open the Cyberware XML file and locate the selected piece.
                        XmlNode objXmlCyberware;
                        if (objCyberware.SourceType == Improvement.ImprovementSource.Bioware)
                        {
                            objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/biowares/bioware[name = \"" + objCyberware.Name + "\"]");
                        }
                        else
                        {
                            objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/cyberwares/cyberware[name = \"" + objCyberware.Name + "\"]");
                        }
                        
                        // Fix for legacy characters with old addqualities improvements. 
                        if (objXmlCyberware?["addqualities"] != null)
                        {
                            RemoveAddedQualities(objXmlCyberware.SelectNodes("addqualities/addquality"), treQualities);
                        }
                    }
                    else
                    {
                        // Find and remove the selected piece of Gear.
                        Gear objGear = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children), out objCyberware);
                        if (objGear.Parent == null)
                            objCyberware.Gear.Remove(objGear);
                        else
                        {
                            objGear.Parent.Children.Remove(objGear);
                            Commlink objParentCommlink = objGear.Parent as Commlink;
                            if (objParentCommlink?.CanSwapAttributes == true)
                            {
                                objParentCommlink.RefreshCyberdeckArray();
                            }
                        }
                        CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                    }

                    // Remove the item from the TreeView.
                    treCyberware.Nodes.Remove(treCyberware.SelectedNode);

                    // If the Parent is populated, remove the item from its Parent.
                    if (objParent != null)
                        objParent.Children.Remove(objCyberware);
                }

                ScheduleCharacterUpdate();
                RefreshSelectedCyberware();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void IncreaseEssenceHole(int centiessence)
        {
            //id of essence hole, get by id to avoid name confusions
            Guid essenceHoldID = Guid.Parse("b57eadaa-7c3b-4b80-8d79-cbbd922c1196");  //don't parse for every obj
            Cyberware objHole = _objCharacter.Cyberware.FirstOrDefault(x => x.SourceID == essenceHoldID);

            if (objHole == null)
            {
                XmlDocument xmlCyberware = XmlManager.Load("cyberware.xml");
                XmlNode xmlEssHole = xmlCyberware.SelectSingleNode("//id[.='b57eadaa-7c3b-4b80-8d79-cbbd922c1196']/..");
                objHole = new Cyberware(_objCharacter);
                TreeNode treNode = new TreeNode();

                objHole.Create(xmlEssHole, _objCharacter, CommonFunctions.GetGradeList(Improvement.ImprovementSource.Cyberware, _objCharacter.Options).FirstOrDefault(x => x.Name == "Standard"), Improvement.ImprovementSource.Cyberware, centiessence, treNode, new List<Weapon>(), new List<TreeNode>(), new List<Vehicle>(), new List<TreeNode>());
                treCyberware.Nodes.Add(treNode);
                _objCharacter.Cyberware.Add(objHole);
            }
            else  
            {
                objHole.Rating += centiessence;
            }

        }

        private void DecreaseEssenceHole(int centiessence)
        {
            //id of essence hole, get by id to avoid name confusions
            Guid essenceHoldID = Guid.Parse("b57eadaa-7c3b-4b80-8d79-cbbd922c1196");  //don't parse for every obj
            Cyberware objHole = _objCharacter.Cyberware.FirstOrDefault(x => x.SourceID == essenceHoldID);

            if (objHole != null)
            {
                if (objHole.Rating > centiessence)
                {
                    objHole.Rating -= centiessence;
                }
                else
                {
                    _objCharacter.Cyberware.Remove(objHole);
                    for (int i = treCyberware.Nodes.Count - 1; i >= 0; i--)
                    {
                        //Equals as Tag is exposed while obj, but not refequals
                        if (objHole.InternalId.Equals(treCyberware.Nodes[i].Tag))
                        {
                            treCyberware.Nodes.RemoveAt(i);
                            break;
                        }
                    }
                }
            }
        }

        private void cmdAddComplexForm_Click(object sender, EventArgs e)
        {
            // The number of Complex Forms cannot exceed the character's LOG.
            if (_objCharacter.ComplexForms.Count >= ((_objCharacter.RES.Value * 2) + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.ComplexFormLimit)))
            {
                MessageBox.Show(LanguageManager.GetString("Message_ComplexFormLimitCareer"), LanguageManager.GetString("MessageTitle_ComplexFormLimit"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            int intComplexFormKarmaCost = _objCharacter.ComplexFormKarmaCost;

            // Make sure the character has enough Karma before letting them select a Complex Form.
            if (_objCharacter.Karma < intComplexFormKarmaCost)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            // Let the user select a Program.
            frmSelectProgram frmPickProgram = new frmSelectProgram(_objCharacter);
            frmPickProgram.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickProgram.DialogResult == DialogResult.Cancel)
                return;

            XmlDocument objXmlDocument = XmlManager.Load("complexforms.xml");

            XmlNode objXmlProgram = objXmlDocument.SelectSingleNode("/chummer/complexforms/complexform[id = \"" + frmPickProgram.SelectedProgram + "\"]");

            // Check for SelectText.
            string strExtra = string.Empty;
            if (objXmlProgram["bonus"] != null)
            {
                if (objXmlProgram["bonus"]["selecttext"] != null)
                {
                    frmSelectText frmPickText = new frmSelectText();
                    frmPickText.Description = LanguageManager.GetString("String_Improvement_SelectText").Replace("{0}", objXmlProgram["translate"]?.InnerText ?? objXmlProgram["name"].InnerText);
                    frmPickText.ShowDialog(this);
                    strExtra = frmPickText.SelectedValue;
                }
            }

            TreeNode objNode = new TreeNode();
            ComplexForm objProgram = new ComplexForm(_objCharacter);
            objProgram.Create(objXmlProgram, objNode, strExtra);
            if (objProgram.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.ComplexForms.Add(objProgram);

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", objProgram.DisplayNameShort).Replace("{1}", intComplexFormKarmaCost.ToString())))
            {
                // Remove the Improvements created by the Complex Form.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ComplexForm, objProgram.InternalId);
                return;
            }

            treComplexForms.Nodes[0].Nodes.Add(objNode);
            treComplexForms.Nodes[0].Expand();

            // Create the Expense Log Entry.
            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(intComplexFormKarmaCost * -1, LanguageManager.GetString("String_ExpenseLearnComplexForm") + " " + objProgram.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Karma -= intComplexFormKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.AddComplexForm, objProgram.InternalId);
            objExpense.Undo = objUndo;

            treComplexForms.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickProgram.AddAgain)
                cmdAddComplexForm_Click(sender, e);
        }

        private void cmdAddArmor_Click(object sender, EventArgs e)
        {
            frmSelectArmor frmPickArmor = new frmSelectArmor(_objCharacter, true);
            frmPickArmor.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickArmor.DialogResult == DialogResult.Cancel)
                return;

            // Open the Armor XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("armor.xml");

            XmlNode objXmlArmor = objXmlDocument.SelectSingleNode("/chummer/armors/armor[name = \"" + frmPickArmor.SelectedArmor + "\"]");

            TreeNode objNode = new TreeNode();
            Armor objArmor = new Armor(_objCharacter);
            List<Weapon> objWeapons = new List<Weapon>();
            objArmor.Create(objXmlArmor, objNode, cmsArmorMod, cmsArmorGear, frmPickArmor.Rating, objWeapons);
            objArmor.DiscountCost = frmPickArmor.BlackMarketDiscount;

            if (objArmor.InternalId == Guid.Empty.ToString())
                return;

            decimal decCost = objArmor.TotalCost;
            // Apply a markup if applicable.
            if (frmPickArmor.Markup != 0)
            {
                decCost *= 1 + (frmPickArmor.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objArmor.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objArmor.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickArmor.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove the Improvements created by the Armor.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId);
                    if (frmPickArmor.AddAgain)
                        cmdAddArmor_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseArmor") + " " + objArmor.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddArmor, objArmor.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            _objCharacter.Armor.Add(objArmor);

            objNode.ContextMenuStrip = cmsArmor;
            treArmor.Nodes[0].Nodes.Add(objNode);
            treArmor.Nodes[0].Expand();
            treArmor.SelectedNode = objNode;

            foreach (Weapon objWeapon in objWeapons)
            {
                _objCharacter.Weapons.Add(objWeapon);
                CommonFunctions.CreateWeaponTreeNode(objWeapon, treWeapons.Nodes[0], cmsWeapon, cmsWeaponAccessory, cmsWeaponAccessoryGear, objArmor.WeaponID);
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickArmor.AddAgain)
                cmdAddArmor_Click(sender, e);
        }

        private void cmdDeleteArmor_Click(object sender, EventArgs e)
        {
            if (treArmor.SelectedNode.Level == 0)
            {
                if (treArmor.SelectedNode.Text == LanguageManager.GetString("Node_SelectedArmor"))
                    return;

                if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteArmorLocation")))
                    return;

                // Move all of the child nodes in the current parent to the Selected Armor parent node.
                foreach (TreeNode objNode in treArmor.SelectedNode.Nodes)
                {
                    Armor objArmor = CommonFunctions.FindByIdWithNameCheck(objNode.Tag.ToString(), _objCharacter.Armor);

                    // Change the Location for the Armor.
                    objArmor.Location = string.Empty;

                    TreeNode nodNewNode = new TreeNode();
                    nodNewNode.Text = objNode.Text;
                    nodNewNode.Tag = objNode.Tag;
                    nodNewNode.ContextMenuStrip = cmsArmor;

                    // Add child nodes.
                    foreach (ArmorMod objChild in objArmor.ArmorMods)
                    {
                        TreeNode nodChildNode = new TreeNode();
                        nodChildNode.Text = objChild.DisplayName;
                        nodChildNode.Tag = objChild.InternalId;
                        nodChildNode.ContextMenuStrip = string.IsNullOrEmpty(objChild.GearCapacity) ? cmsArmorMod : cmsArmorGear;
                        nodNewNode.Nodes.Add(nodChildNode);
                        nodNewNode.Expand();
                        foreach (Gear objGearChild in objChild.Gear)
                        {
                            TreeNode nodGearChildNode = new TreeNode();
                            nodGearChildNode.Text = objGearChild.DisplayName;
                            nodGearChildNode.Tag = objGearChild.InternalId;
                            nodGearChildNode.ContextMenuStrip = cmsArmorGear;
                            nodChildNode.Nodes.Add(nodGearChildNode);
                            nodChildNode.Expand();
                        }
                    }

                    foreach (Gear objChild in objArmor.Gear)
                    {
                        TreeNode nodChildNode = new TreeNode();
                        nodChildNode.Text = objChild.DisplayName;
                        nodChildNode.Tag = objChild.InternalId;
                        nodChildNode.ContextMenuStrip = cmsArmorGear;
                        nodNewNode.Nodes.Add(nodChildNode);
                        nodNewNode.Expand();
                    }

                    treArmor.Nodes[0].Nodes.Add(nodNewNode);
                    treArmor.Nodes[0].Expand();
                }

                // Remove the Location from the character, then remove the selected node.
                _objCharacter.ArmorBundles.Remove(treArmor.SelectedNode.Text);
                treArmor.SelectedNode.Remove();
                return;
            }

            CommonFunctions.DeleteArmor(_objCharacter, treArmor, treWeapons, treVehicles);
            ScheduleCharacterUpdate();
            RefreshSelectedArmor();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddBioware_Click(object sender, EventArgs e)
        {
            // Select the root Bioware node then open the Select Cyberware window.
            treCyberware.SelectedNode = treCyberware.Nodes[1];
            bool blnAddAgain = PickCyberware(Improvement.ImprovementSource.Bioware);
            if (blnAddAgain)
                cmdAddBioware_Click(sender, e);
        }

        private void cmdAddWeapon_Click(object sender, EventArgs e)
        {
            frmSelectWeapon frmPickWeapon = new frmSelectWeapon(_objCharacter, true);
            frmPickWeapon.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Open the Weapons XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");

            XmlNode objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/weapons/weapon[id = \"" + frmPickWeapon.SelectedWeapon + "\"]");

            List<TreeNode> lstNodes = new List<TreeNode>();
            Weapon objWeapon = new Weapon(_objCharacter);
            objWeapon.Create(objXmlWeapon, lstNodes, cmsWeapon, cmsWeaponAccessory, _objCharacter.Weapons, cmsWeaponAccessoryGear);
            objWeapon.DiscountCost = frmPickWeapon.BlackMarketDiscount;

            decimal decCost = objWeapon.TotalCost;
            // Apply a markup if applicable.
            if (frmPickWeapon.Markup != 0)
            {
                decCost *= 1 + (frmPickWeapon.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickWeapon.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeapon.AddAgain)
                        cmdAddWeapon_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeapon, objWeapon.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            _objCharacter.Weapons.Add(objWeapon);
            
            foreach (TreeNode objLoopNode in lstNodes)
            {
                objLoopNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objLoopNode);
            }
            treWeapons.Nodes[0].Expand();
            treWeapons.SelectedNode = lstNodes[0];

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickWeapon.AddAgain)
                cmdAddWeapon_Click(sender, e);
        }

        private void cmdDeleteWeapon_Click(object sender, EventArgs e)
        {
            // Delete the selected Weapon.
            if (treWeapons.SelectedNode != null)
            {
                if (treWeapons.SelectedNode.Level == 0)
                {
                    if (treWeapons.SelectedNode.Text == LanguageManager.GetString("Node_SelectedWeapons"))
                        return;

                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteWeaponLocation")))
                        return;

                    // Move all of the child nodes in the current parent to the Selected Weapons parent node.
                    foreach (TreeNode objNode in treWeapons.SelectedNode.Nodes)
                    {
                        Weapon objWeapon = CommonFunctions.DeepFindById(objNode.Tag.ToString(), _objCharacter.Weapons);

                        // Change the Location for the Weapon.
                        objWeapon.Location = string.Empty;
                    }

                    List<TreeNode> lstMoveNodes = new List<TreeNode>();
                    foreach (TreeNode objNode in treWeapons.SelectedNode.Nodes)
                        lstMoveNodes.Add(objNode);

                    foreach (TreeNode objNode in lstMoveNodes)
                    {
                        treWeapons.SelectedNode.Nodes.Remove(objNode);
                        treWeapons.Nodes[0].Nodes.Add(objNode);
                    }

                    // Remove the Weapon Location from the character, then remove the selected node.
                    _objCharacter.WeaponLocations.Remove(treWeapons.SelectedNode.Text);
                    treWeapons.SelectedNode.Remove();
                }

                if (treWeapons.SelectedNode.Level > 0)
                {
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteWeapon")))
                        return;

                    // Locate the Weapon that is selected in the tree.
                    Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
                    if (objWeapon != null)
                    {
                        // Cyberweapons cannot be removed through here and must be done by removing the piece of Cyberware.
                        if (objWeapon.Cyberware)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveCyberweapon"), LanguageManager.GetString("MessageTitle_CannotRemoveCyberweapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                        if (objWeapon.Category == "Gear")
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveGearWeapon"), LanguageManager.GetString("MessageTitle_CannotRemoveGearWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                        if (objWeapon.Category.StartsWith("Quality"))
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveQualityWeapon"), LanguageManager.GetString("MessageTitle_CannotRemoveQualityWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);

                        if (objWeapon.Parent != null)
                            objWeapon.Parent.Children.Remove(objWeapon);
                        else
                            _objCharacter.Weapons.Remove(objWeapon);
                        treWeapons.SelectedNode.Remove();
                    }
                    else
                    {
                        objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Parent.Tag.ToString(), _objCharacter.Weapons);

                        // Locate the Accessory that is selected in the tree.
                        WeaponAccessory objAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
                        if (objAccessory != null)
                        {
                            foreach (Gear objGear in objAccessory.Gear)
                                CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                            objWeapon.WeaponAccessories.Remove(objAccessory);
                            treWeapons.SelectedNode.Remove();
                        }
                        else
                        {
                            // Find the selected Gear.
                            Gear objGear = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons, out objAccessory);
                            CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                            if (objGear.Parent == null)
                                objAccessory.Gear.Remove(objGear);
                            else
                            {
                                objGear.Parent.Children.Remove(objGear);
                                Commlink objParentCommlink = objGear.Parent as Commlink;
                                if (objParentCommlink?.CanSwapAttributes == true)
                                {
                                    objParentCommlink.RefreshCyberdeckArray();
                                }
                            }
                            treWeapons.SelectedNode.Remove();
                        }
                    }
                }
                ScheduleCharacterUpdate();
                RefreshSelectedWeapon();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdAddLifestyle_Click(object sender, EventArgs e)
        {
            Lifestyle objLifestyle = new Lifestyle(_objCharacter);
            frmSelectLifestyle frmPickLifestyle = new frmSelectLifestyle(objLifestyle, _objCharacter);
            frmPickLifestyle.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                return;

            objLifestyle.Months = 0;
            _objCharacter.Lifestyles.Add(objLifestyle);

            TreeNode objNode = new TreeNode();
            objNode.Text = objLifestyle.DisplayName;
            objNode.Tag = objLifestyle.InternalId;
            objNode.ContextMenuStrip = cmsLifestyleNotes;
            treLifestyles.Nodes[0].Nodes.Add(objNode);
            treLifestyles.Nodes[0].Expand();
            treLifestyles.SelectedNode = objNode;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickLifestyle.AddAgain)
                cmdAddLifestyle_Click(sender, e);
        }

        private void cmdDeleteLifestyle_Click(object sender, EventArgs e)
        {
            // Delete the selected Lifestyle.
            if (treLifestyles.SelectedNode != null)
            {
                if (treLifestyles.SelectedNode.Level > 0)
                {
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteLifestyle")))
                        return;

                    Lifestyle objLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);
                    if (objLifestyle == null)
                        return;

                    _objCharacter.Lifestyles.Remove(objLifestyle);
                    treLifestyles.SelectedNode.Remove();
                }
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdAddGear_Click(object sender, EventArgs e)
        {
            // Select the root Gear node then open the Select Gear window.
            treGear.SelectedNode = treGear.Nodes[0];
            bool blnAddAgain = PickGear();
            if (blnAddAgain)
                cmdAddGear_Click(sender, e);
            CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
        }

        private void cmdDeleteGear_Click(object sender, EventArgs e)
        {
            // Delete the selected Gear.
            if (treGear.SelectedNode != null)
            {
                if (treGear.SelectedNode.Level == 0)
                {
                    if (treGear.SelectedNode.Text == LanguageManager.GetString("Node_SelectedGear"))
                        return;

                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteGearLocation")))
                        return;

                    // Move all of the child nodes in the current parent to the Selected Gear parent node.
                    foreach (TreeNode objNode in treGear.SelectedNode.Nodes)
                    {
                        Gear objGear = CommonFunctions.DeepFindById(objNode.Tag.ToString(), _objCharacter.Gear);

                        // Change the Location for the Gear.
                        objGear.Location = string.Empty;
                    }

                    List<TreeNode> lstMoveNodes = new List<TreeNode>();
                    foreach (TreeNode objNode in treGear.SelectedNode.Nodes)
                        lstMoveNodes.Add(objNode);

                    foreach (TreeNode objNode in lstMoveNodes)
                    {
                        treGear.SelectedNode.Nodes.Remove(objNode);
                        treGear.Nodes[0].Nodes.Add(objNode);
                    }

                    // Remove the Location from the character, then remove the selected node.
                    _objCharacter.Locations.Remove(treGear.SelectedNode.Text);
                    treGear.SelectedNode.Remove();
                }
                if (treGear.SelectedNode.Level > 0)
                {
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteGear")))
                        return;

                    Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
                    Gear objParent = CommonFunctions.DeepFindById(treGear.SelectedNode.Parent.Tag.ToString(), _objCharacter.Gear);

                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);

                    _objCharacter.Gear.Remove(objGear);
                    treGear.SelectedNode.Remove();

                    // If the Parent is populated, remove the item from its Parent.
                    if (objParent != null)
                    {
                        objParent.Children.Remove(objGear);
                        Commlink objParentCommlink = objGear.Parent as Commlink;
                        if (objParentCommlink?.CanSwapAttributes == true)
                        {
                            objParentCommlink.RefreshCyberdeckArray();
                        }
                    }
                }
                CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
                ScheduleCharacterUpdate();
                RefreshSelectedGear();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdAddVehicle_Click(object sender, EventArgs e)
        {
            frmSelectVehicle frmPickVehicle = new frmSelectVehicle(_objCharacter, true);
            frmPickVehicle.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickVehicle.DialogResult == DialogResult.Cancel)
                return;

            // Open the Vehicles XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("vehicles.xml");

            XmlNode objXmlVehicle = objXmlDocument.SelectSingleNode("/chummer/vehicles/vehicle[name = \"" + frmPickVehicle.SelectedVehicle + "\"]");

            TreeNode objNode = new TreeNode();
            Vehicle objVehicle = new Vehicle(_objCharacter);
            objVehicle.Create(objXmlVehicle, objNode, cmsVehicle, cmsVehicleGear, cmsVehicleWeapon, cmsVehicleWeaponAccessory, cmsVehicleWeaponAccessoryGear, cmsWeaponMount);
            // Update the Used Vehicle information if applicable.
            if (frmPickVehicle.UsedVehicle)
            {
                objVehicle.Avail = frmPickVehicle.UsedAvail;
                objVehicle.Cost = frmPickVehicle.UsedCost.ToString();
            }
            objVehicle.BlackMarketDiscount = frmPickVehicle.BlackMarketDiscount;

            decimal decCost = objVehicle.TotalCost;
            // Apply a markup if applicable.
            if (frmPickVehicle.Markup != 0)
            {
                decCost *= 1 + (frmPickVehicle.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objVehicle.CalculatedAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objVehicle.CalculatedAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickVehicle.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickVehicle.AddAgain)
                        cmdAddVehicle_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicle") + " " + objVehicle.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicle, objVehicle.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            objVehicle.BlackMarketDiscount = frmPickVehicle.BlackMarketDiscount;

            _objCharacter.Vehicles.Add(objVehicle);

            objNode.ContextMenuStrip = cmsVehicle;
            treVehicles.Nodes[0].Nodes.Add(objNode);
            treVehicles.Nodes[0].Expand();
            treVehicles.SelectedNode = objNode;

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickVehicle.AddAgain)
                cmdAddVehicle_Click(sender, e);
        }

        private void cmdDeleteVehicle_Click(object sender, EventArgs e)
        {
            // Delete the selected Vehicle.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level == 0)
            {
                return;
            }

            if (treVehicles.SelectedNode.Level != 2)
            {
                if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteVehicle")))
                    return;
            }

            // Weapons that are first-level children of vehicles cannot be removed (for some reason)
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                if (objCharacterVehicle.Weapons.DeepFirstOrDefault(x => x.Children, x => x.InternalId == treVehicles.SelectedNode.Tag.ToString()) != null)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveGearWeaponVehicle"), LanguageManager.GetString("MessageTitle_CannotRemoveGearWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
            }

            // Locate the Vehicle that is selected in the tree.
            Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            // Removing a Vehicle
            if (objVehicle != null)
            {
                // Remove any Gear Improvements from the character (primarily those provided by an Emotitoy).
                foreach (Gear objGear in objVehicle.Gear)
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);

                _objCharacter.Vehicles.Remove(objVehicle);
                foreach (Weapon objLoopWeapon in objVehicle.Weapons)
                {
                    CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                }
                foreach (VehicleMod objLoopMod in objVehicle.Mods)
                {
                    foreach (Weapon objLoopWeapon in objLoopMod.Weapons)
                    {
                        CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                    }
                    foreach (Cyberware objLoopCyberware in objLoopMod.Cyberware)
                    {
                        CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles);
                    }
                }
                treVehicles.SelectedNode.Remove();
            }
            else
            {
                // Locate the VehicleMod that is selected in the tree.
                VehicleMod objMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle);
                // Removing a Vehicle Mod
                if (objMod != null)
                {
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteVehicle")))
                        return;

                    // Check for Improved Sensor bonus.
                    if (objMod.Bonus?["improvesensor"] != null || (objMod.WirelessOn && objMod.WirelessBonus?["improvesensor"] != null))
                    {
                        ChangeVehicleSensor(objVehicle, false);
                    }

                    // If this is the Obsolete Mod, the user must select a percentage. This will create an Expense that costs X% of the Vehicle's base cost to remove the special Obsolete Mod.
                    if (objMod.Name == "Obsolete" || (objMod.Name == "Obsolescent" && _objOptions.AllowObsolescentUpgrade))
                    {
                        frmSelectNumber frmModPercent = new frmSelectNumber(2);
                        frmModPercent.Minimum = 0;
                        frmModPercent.Maximum = 1000000;
                        frmModPercent.Description = LanguageManager.GetString("String_Retrofit");
                        frmModPercent.ShowDialog(this);

                        if (frmModPercent.DialogResult == DialogResult.Cancel)
                            return;

                        decimal decPercentage = frmModPercent.SelectedValue;
                        decimal decVehicleCost = objVehicle.OwnCost;

                        // Make sure the character has enough Nuyen for the expense.
                        decimal decCost = decVehicleCost * decPercentage / 100;
                        if (decCost > _objCharacter.Nuyen)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        // Create a Vehicle Mod for the Retrofit.
                        VehicleMod objRetrofit = new VehicleMod(_objCharacter);

                        XmlDocument objVehiclesDoc = XmlManager.Load("vehicles.xml");
                        XmlNode objXmlNode = objVehiclesDoc.SelectSingleNode("/chummer/mods/mod[name = \"Retrofit\"]");
                        TreeNode objTreeNode = new TreeNode();
                        objRetrofit.Create(objXmlNode, objTreeNode, 0, objVehicle);
                        objRetrofit.Cost = decCost.ToString();
                        objVehicle.Mods.Add(objRetrofit);
                        treVehicles.SelectedNode.Parent.Nodes.Add(objTreeNode);

                        // Create an Expense Log Entry for removing the Obsolete Mod.
                        ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                        objEntry.Create(decCost * -1, LanguageManager.GetString("String_ExpenseVehicleRetrofit").Replace("{0}", objVehicle.DisplayName), ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objEntry);

                        // Adjust the character's Nuyen total.
                        _objCharacter.Nuyen += decCost * -1;
                    }

                    objVehicle.Mods.Remove(objMod);
                    foreach (Weapon objLoopWeapon in objMod.Weapons)
                    {
                        CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                    }
                    foreach (Cyberware objLoopCyberware in objMod.Cyberware)
                    {
                        CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles);
                    }
                    treVehicles.SelectedNode.Remove();
                }
                else
                {
                    Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle, out WeaponMount wm, out VehicleMod vm);
                    // Removing a Weapon
                    if (objWeapon != null)
                    {
                        CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                        if (objWeapon.Parent == null)
                        {
                            if (wm != null)
                                wm.Weapons.Remove(objWeapon);
                            // This bit here should never be reached, but I'm adding it for future-proofing in case we want people to be able to remove weapons attached directly to vehicles
                            else
                                objVehicle.Weapons.Remove(objWeapon);
                        }
                        else
                        {
                            objWeapon.Parent.Children.Remove(objWeapon);
                        }
                        treVehicles.SelectedNode.Remove();
                    }
                    else
                    {
                        WeaponAccessory objWeaponAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objWeapon);
                        // Removing a weapon accessory
                        if (objWeaponAccessory != null)
                        {
                            objWeapon.WeaponAccessories.Remove(objWeaponAccessory);
                            foreach (Gear objLoopGear in objWeaponAccessory.Gear)
                            {
                                CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles);
                            }
                            treVehicles.SelectedNode.Remove();
                        }
                        else
                        {
                            Cyberware objCyberware = CommonFunctions.FindVehicleCyberware(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objMod);
                            // Removing Cyberware
                            if (objCyberware != null)
                            {
                                if (objCyberware.Parent == null)
                                    objMod.Cyberware.Remove(objCyberware);
                                else
                                {
                                    objCyberware.Parent.Children.Remove(objCyberware);
                                }
                                treVehicles.SelectedNode.Remove();

                                CommonFunctions.DeleteCyberware(_objCharacter, objCyberware, treWeapons, treVehicles);
                            }
                            else
                            {
                                objVehicle = null;
                                objWeaponAccessory = null;
                                objCyberware = null;
                                Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle, out objWeaponAccessory, out objCyberware);
                                if (objGear != null)
                                {
                                    if (objGear.Parent == null)
                                    {
                                        if (objCyberware != null)
                                            objCyberware.Gear.Remove(objGear);
                                        else if (objWeaponAccessory != null)
                                            objWeaponAccessory.Gear.Remove(objGear);
                                        else
                                            objVehicle.Gear.Remove(objGear);
                                    }
                                    else
                                    {
                                        objGear.Parent.Children.Remove(objGear);
                                        Commlink objParentCommlink = objGear.Parent as Commlink;
                                        if (objParentCommlink?.CanSwapAttributes == true)
                                        {
                                            objParentCommlink.RefreshCyberdeckArray();
                                        }
                                    }
                                    treVehicles.SelectedNode.Remove();

                                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                                }
                            }
                        }
                    }
                }
            }

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddMartialArt_Click(object sender, EventArgs e)
        {
            int intKarmaCost = 7 * _objOptions.KarmaQuality;
            if (intKarmaCost > _objCharacter.Karma)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectMartialArt frmPickMartialArt = new frmSelectMartialArt(_objCharacter);
            frmPickMartialArt.ShowDialog(this);

            if (frmPickMartialArt.DialogResult == DialogResult.Cancel)
                return;

            // Open the Martial Arts XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("martialarts.xml");

            XmlNode objXmlArt = objXmlDocument.SelectSingleNode("/chummer/martialarts/martialart[name = \"" + frmPickMartialArt.SelectedMartialArt + "\"]");

            TreeNode objNode = new TreeNode();
            MartialArt objMartialArt = new MartialArt(_objCharacter);
            objMartialArt.Create(objXmlArt, objNode);
            _objCharacter.MartialArts.Add(objMartialArt);

            objNode.ContextMenuStrip = cmsMartialArts;

            // Create the Expense Log Entry.
            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseLearnMartialArt") + " " + frmPickMartialArt.SelectedMartialArt, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Karma -= intKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.AddMartialArt, objMartialArt.Name);
            objExpense.Undo = objUndo;

            treMartialArts.Nodes[0].Nodes.Add(objNode);
            treMartialArts.Nodes[0].Expand();

            treMartialArts.SelectedNode = objNode;

            treMartialArts.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdDeleteMartialArt_Click(object sender, EventArgs e)
        {
            if (treMartialArts.SelectedNode != null && treMartialArts.SelectedNode.Level > 0)
            {
                if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteMartialArt")))
                    return;

                if (treMartialArts.SelectedNode.Level == 1)
                {
                    // Delete the selected Martial Art.
                    MartialArt objMartialArt = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);

                    bool blnDoQualityRefresh = false;
                    if (objMartialArt.Name == "One Trick Pony")
                    {
                        Quality objQuality = _objCharacter.Qualities.FirstOrDefault(objLoopQuality => objLoopQuality.Name == "One Trick Pony");
                        if (objQuality != null)
                        {
                            _objCharacter.Qualities.Remove(objQuality);
                            if (!_objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objQuality.QualityId && objExistingQuality.Extra == objQuality.Extra))
                            {
                                foreach (TreeNode nodQuality in treQualities.Nodes[0].Nodes)
                                {
                                    if (nodQuality.Text.ToString() == "One Trick Pony")
                                        nodQuality.Remove();
                                }
                            }
                            else
                                blnDoQualityRefresh = true;
                        }
                    }

                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.MartialArt, objMartialArt.InternalId);
                    // Remove the Improvements for any Advantages for the Martial Art that is being removed.
                    foreach (MartialArtAdvantage objAdvantage in objMartialArt.Advantages)
                    {
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.MartialArtAdvantage, objAdvantage.InternalId);
                    }

                    _objCharacter.MartialArts.Remove(objMartialArt);
                    if (blnDoQualityRefresh)
                        RefreshQualityNames(treQualities);
                }
                if (treMartialArts.SelectedNode.Level == 2)
                {
                    // Find the selected Advantage object.
                    MartialArt objSelectedMartialArt = null;
                    MartialArtAdvantage objSelectedAdvantage = CommonFunctions.FindMartialArtAdvantage(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts, out objSelectedMartialArt);

                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.MartialArtAdvantage, objSelectedAdvantage.InternalId);
                    
                    objSelectedMartialArt.Advantages.Remove(objSelectedAdvantage);
                }
                treMartialArts.SelectedNode.Remove();
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdAddManeuver_Click(object sender, EventArgs e)
        {
            // Characters may only have 2 Maneuvers per Martial Art Rating.
            int intTotalRating = 0;
            foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
                intTotalRating += objMartialArt.Rating * 2;

            if (treMartialArts.Nodes[1].Nodes.Count >= intTotalRating)
            {
                MessageBox.Show(LanguageManager.GetString("Message_MartialArtManeuverLimit"), LanguageManager.GetString("MessageTitle_MartialArtManeuverLimit"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Make sure the character has enough Karma.
            int intKarmaCost = _objOptions.KarmaManeuver;


            if (intKarmaCost > _objCharacter.Karma)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectMartialArtManeuver frmPickMartialArtManeuver = new frmSelectMartialArtManeuver(_objCharacter);
            frmPickMartialArtManeuver.ShowDialog(this);

            if (frmPickMartialArtManeuver.DialogResult == DialogResult.Cancel)
                return;

            // Open the Martial Arts XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("martialarts.xml");

            XmlNode objXmlManeuver = objXmlDocument.SelectSingleNode("/chummer/maneuvers/maneuver[name = \"" + frmPickMartialArtManeuver.SelectedManeuver + "\"]");

            TreeNode objNode = new TreeNode();
            MartialArtManeuver objManeuver = new MartialArtManeuver(_objCharacter);
            objManeuver.Create(objXmlManeuver, objNode);
            objNode.ContextMenuStrip = cmsMartialArtManeuver;
            _objCharacter.MartialArtManeuvers.Add(objManeuver);

            treMartialArts.Nodes[1].Nodes.Add(objNode);
            treMartialArts.Nodes[1].Expand();

            treMartialArts.SelectedNode = objNode;

            // Create the Expense Log Entry.
            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseLearnManeuver") + " " + objManeuver.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Karma -= intKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.AddMartialArtManeuver, objManeuver.InternalId);
            objExpense.Undo = objUndo;

            treMartialArts.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddMugshot_Click(object sender, EventArgs e)
        {
            _blnIsDirty = AddMugshot();
            if (_blnIsDirty)
            {
                lblNumMugshots.Text = "/ " + _objCharacter.Mugshots.Count.ToString();
                nudMugshotIndex.Maximum += 1;
                nudMugshotIndex.Value = _objCharacter.Mugshots.Count;
            }
            UpdateWindowTitle();
        }

        private void cmdDeleteMugshot_Click(object sender, EventArgs e)
        {
            if (_objCharacter.Mugshots.Count > 0)
            {
                RemoveMugshot(decimal.ToInt32(nudMugshotIndex.Value) - 1);

                lblNumMugshots.Text = "/ " + _objCharacter.Mugshots.Count.ToString();
                nudMugshotIndex.Maximum -= 1;
                if (nudMugshotIndex.Value > nudMugshotIndex.Maximum)
                    nudMugshotIndex.Value = nudMugshotIndex.Maximum;
                else
                {
                    if (decimal.ToInt32(nudMugshotIndex.Value) - 1 == _objCharacter.MainMugshotIndex)
                        chkIsMainMugshot.Checked = true;
                    else if (chkIsMainMugshot.Checked == true)
                        chkIsMainMugshot.Checked = false;

                    UpdateMugshot(picMugshot, decimal.ToInt32(nudMugshotIndex.Value) - 1);
                }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
        }


        private void nudMugshotIndex_ValueChanged(object sender, EventArgs e)
        {
            if (_objCharacter.Mugshots.Count == 0)
            {
                nudMugshotIndex.Minimum = 0;
                nudMugshotIndex.Maximum = 0;
                nudMugshotIndex.Value = 0;
            }
            else
            {
                nudMugshotIndex.Minimum = 1;
                if (nudMugshotIndex.Value < nudMugshotIndex.Minimum)
                    nudMugshotIndex.Value = nudMugshotIndex.Maximum;
                else if (nudMugshotIndex.Value > nudMugshotIndex.Maximum)
                    nudMugshotIndex.Value = nudMugshotIndex.Minimum;
            }

            if (decimal.ToInt32(nudMugshotIndex.Value) - 1 == _objCharacter.MainMugshotIndex)
                chkIsMainMugshot.Checked = true;
            else if (chkIsMainMugshot.Checked == true)
                chkIsMainMugshot.Checked = false;

            UpdateMugshot(picMugshot, decimal.ToInt32(nudMugshotIndex.Value) - 1);
        }

        private void chkIsMainMugshot_CheckedChanged(object sender, EventArgs e)
        {
            bool blnStatusChanged = false;
            if (chkIsMainMugshot.Checked == true && _objCharacter.MainMugshotIndex != decimal.ToInt32(nudMugshotIndex.Value) - 1)
            {
                _objCharacter.MainMugshotIndex = decimal.ToInt32(nudMugshotIndex.Value) - 1;
                blnStatusChanged = true;
            }
            else if (chkIsMainMugshot.Checked == false && decimal.ToInt32(nudMugshotIndex.Value) - 1 == _objCharacter.MainMugshotIndex)
            {
                if (_objCharacter.MainMugshotIndex == 0)
                {
                    if (_objCharacter.Mugshots.Count > 1)
                    {
                        _objCharacter.MainMugshotIndex = 1;
                        blnStatusChanged = true;
                    }
                    else
                        chkIsMainMugshot.Checked = true;
                }
                else
                {
                    _objCharacter.MainMugshotIndex = 0;
                    blnStatusChanged = true;
                }
            }

            if (blnStatusChanged)
            {
                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdAddMetamagic_Click(object sender, EventArgs e)
        {
            if (_objCharacter.MAGEnabled)
            {
                // Make sure that the Initiate Grade is not attempting to go above the character's MAG CharacterAttribute.
                if (_objCharacter.InitiateGrade + 1 > _objCharacter.MAG.TotalValue ||
                    (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && _objCharacter.InitiateGrade + 1 > _objCharacter.MAGAdept.TotalValue))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotIncreaseInitiateGrade"), LanguageManager.GetString("MessageTitle_CannotIncreaseInitiateGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // Make sure the character has enough Karma.
                decimal decMultiplier = 1.0m;
                if (chkInitiationGroup.Checked)
                    decMultiplier -= 0.1m;
                if (chkInitiationOrdeal.Checked)
                    decMultiplier -= _objCharacter.TechnomancerEnabled ? 0.2m : 0.1m;
                if (chkInitiationSchooling.Checked)
                    decMultiplier -= 0.1m;

                int intKarmaExpense = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (chkInitiationSchooling.Checked && (10000 > _objCharacter.Nuyen))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (chkInitiationSchooling.Checked)
                {
                    if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaandNuyenExpense").Replace("{0}", LanguageManager.GetString("String_InitiateGrade")).Replace("{1}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{2}", intKarmaExpense.ToString()).Replace("{3}", (10000).ToString())))
                        return;
                }
                else
                {
                    if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpense").Replace("{0}", LanguageManager.GetString("String_InitiateGrade")).Replace("{1}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{2}", intKarmaExpense.ToString())))
                        return;
                }

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseInitiateGrade") + " " + _objCharacter.InitiateGrade.ToString() + " -> " + (_objCharacter.InitiateGrade + 1).ToString(), ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                // Create the Initiate Grade object.
                InitiationGrade objGrade = new InitiationGrade(_objCharacter);
                objGrade.Create(_objCharacter.InitiateGrade + 1, _objCharacter.RESEnabled, chkInitiationGroup.Checked, chkInitiationOrdeal.Checked, chkInitiationSchooling.Checked);
                _objCharacter.InitiationGrades.Add(objGrade);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ImproveInitiateGrade, objGrade.InternalId);
                objExpense.Undo = objUndo;

                if (chkInitiationSchooling.Checked)
                {
                    ExpenseLogEntry objNuyenExpense = new ExpenseLogEntry(_objCharacter);
                    objNuyenExpense.Create(-10000, LanguageManager.GetString("String_ExpenseInitiateGrade") + " " + _objCharacter.InitiateGrade.ToString() + " -> " + (_objCharacter.InitiateGrade + 1).ToString(), ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objNuyenExpense);
                    _objCharacter.Nuyen -= 10000;

                    ExpenseUndo objNuyenUndo = new ExpenseUndo();
                    objNuyenUndo.CreateNuyen(NuyenExpenseType.ImproveInitiateGrade, objGrade.InternalId, 10000);
                    objNuyenExpense.Undo = objNuyenUndo;
                }

                // Set the character's Initiate Grade.
                _objCharacter.InitiateGrade += 1;

                // Remove any existing Initiation Improvements.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Initiation, "Initiation");

                // Create the replacement Improvement.
                ImprovementManager.CreateImprovement(_objCharacter, "MAG", Improvement.ImprovementSource.Initiation, "Initiation", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.InitiateGrade);
                ImprovementManager.CreateImprovement(_objCharacter, "MAGAdept", Improvement.ImprovementSource.Initiation, "Initiation", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.InitiateGrade);
                ImprovementManager.Commit(_objCharacter);

                // Update any Metamagic Improvements the character might have.
                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                {
                    if (objMetamagic.Bonus != null)
                    {
                        // If the Bonus contains "Rating", remove the existing Improvement and create new ones.
                        if (objMetamagic.Bonus.InnerXml.Contains("Rating"))
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId, objMetamagic.Bonus, false, _objCharacter.InitiateGrade, objMetamagic.DisplayNameShort);
                        }
                    }
                }

                int intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                string strInitTip = LanguageManager.GetString("Tip_ImproveInitiateGrade").Replace("{0}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
                tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
            }
            else if (_objCharacter.RESEnabled)
            {

                // Make sure that the Initiate Grade is not attempting to go above the character's RES CharacterAttribute.
                if (_objCharacter.SubmersionGrade + 1 > _objCharacter.RES.TotalValue)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotIncreaseSubmersionGrade"), LanguageManager.GetString("MessageTitle_CannotIncreaseSubmersionGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // Make sure the character has enough Karma.
                decimal decMultiplier = 1.0m;
                if (chkInitiationOrdeal.Checked)
                    decMultiplier -= 0.1m;

                int intKarmaExpense = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpense").Replace("{0}", LanguageManager.GetString("String_SubmersionGrade")).Replace("{1}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{2}", intKarmaExpense.ToString())))
                    return;

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseSubmersionGrade") + " " + _objCharacter.SubmersionGrade.ToString() + " -> " + (_objCharacter.SubmersionGrade + 1).ToString(), ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                // Create the Initiate Grade object.
                InitiationGrade objGrade = new InitiationGrade(_objCharacter);
                objGrade.Create(_objCharacter.SubmersionGrade + 1, _objCharacter.RESEnabled, chkInitiationGroup.Checked, chkInitiationOrdeal.Checked, chkInitiationSchooling.Checked);
                _objCharacter.InitiationGrades.Add(objGrade);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ImproveInitiateGrade, objGrade.InternalId);
                objExpense.Undo = objUndo;

                // Set the character's Submersion Grade.
                _objCharacter.SubmersionGrade += 1;

                // Remove any existing Initiation Improvements.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Submersion, "Submersion");

                // Create the replacement Improvement.
                ImprovementManager.CreateImprovement(_objCharacter, "RES", Improvement.ImprovementSource.Submersion, "Submersion", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.SubmersionGrade);
                ImprovementManager.Commit(_objCharacter);

                // Update any Echo Improvements the character might have.
                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                {
                    if (objMetamagic.Bonus != null)
                    {
                        // If the Bonus contains "Rating", remove the existing Improvement and create new ones.
                        if (objMetamagic.Bonus.InnerXml.Contains("Rating"))
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Echo, objMetamagic.InternalId);
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Echo, objMetamagic.InternalId, objMetamagic.Bonus, false, _objCharacter.SubmersionGrade, objMetamagic.DisplayNameShort);
                        }
                    }
                }

                int intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                string strInitTip = LanguageManager.GetString("Tip_ImproveSubmersionGrade").Replace("{0}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
                tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
            }

            UpdateInitiationGradeTree();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdDeleteMetamagic_Click(object sender, EventArgs e)
        {
            if (treMetamagic.SelectedNode != null)
            {
                if (treMetamagic.SelectedNode.Level == 0)
                {
                    // Locate the selected Metamagic.
                    Metamagic objMetamagic = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Metamagics);
                    if (objMetamagic.Grade < 0)
                        return;

                    string strMessage = string.Empty;
                    if (_objCharacter.MAGEnabled)
                        strMessage = LanguageManager.GetString("Message_DeleteMetamagic");
                    else if (_objCharacter.RESEnabled)
                        strMessage = LanguageManager.GetString("Message_DeleteEcho");
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, strMessage))
                        return;

                    // Remove the Improvements created by the Metamagic.
                    ImprovementManager.RemoveImprovements(_objCharacter, objMetamagic.SourceType, objMetamagic.InternalId);

                    // Remove the Metamagic from the character.
                    _objCharacter.Metamagics.Remove(objMetamagic);

                    treMetamagic.SelectedNode.Remove();

                    ScheduleCharacterUpdate();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdKarmaGained_Click(object sender, EventArgs e)
        {
            frmExpense frmNewExpense = new frmExpense();
            frmNewExpense.KarmaNuyenExchangeString = LanguageManager.GetString("String_WorkingForThePeople");
            frmNewExpense.ShowDialog(this);

            if (frmNewExpense.DialogResult == DialogResult.Cancel)
                return;

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create(frmNewExpense.Amount, frmNewExpense.Reason, ExpenseType.Karma, frmNewExpense.SelectedDate, frmNewExpense.Refund);
            _objCharacter.ExpenseEntries.Add(objEntry);

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.ManualAdd, string.Empty);
            objEntry.Undo = objUndo;

            // Adjust the character's Karma total.
            _objCharacter.Karma += decimal.ToInt32(frmNewExpense.Amount);

            if (frmNewExpense.KarmaNuyenExchange)
            {
                // Create the Expense Log Entry.
                objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(frmNewExpense.Amount * 2000 * -1, frmNewExpense.Reason, ExpenseType.Nuyen, frmNewExpense.SelectedDate);
                _objCharacter.ExpenseEntries.Add(objEntry);

                objUndo = new ExpenseUndo();
                objUndo.CreateNuyen(NuyenExpenseType.ManualSubtract, string.Empty);
                objEntry.Undo = objUndo;

                // Adjust the character's Nuyen total.
                _objCharacter.Nuyen += frmNewExpense.Amount * 2000.0m * -1;
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdKarmaSpent_Click(object sender, EventArgs e)
        {
            frmExpense frmNewExpense = new frmExpense();
            frmNewExpense.KarmaNuyenExchangeString = LanguageManager.GetString("String_WorkingForTheMan");

            frmNewExpense.ShowDialog(this);

            if (frmNewExpense.DialogResult == DialogResult.Cancel)
                return;

            // Make sure the Karma expense would not put the character's remaining Karma amount below 0.
            if (_objCharacter.Karma - frmNewExpense.Amount < 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create(frmNewExpense.Amount * -1, frmNewExpense.Reason, ExpenseType.Karma, frmNewExpense.SelectedDate, frmNewExpense.Refund);
            _objCharacter.ExpenseEntries.Add(objEntry);

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.ManualSubtract, string.Empty);
            objEntry.Undo = objUndo;

            // Adjust the character's Karma total.
            _objCharacter.Karma += decimal.ToInt32(frmNewExpense.Amount) * -1;

            if (frmNewExpense.KarmaNuyenExchange)
            {
                // Create the Expense Log Entry.
                objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(frmNewExpense.Amount * 2000.0m, frmNewExpense.Reason, ExpenseType.Nuyen, frmNewExpense.SelectedDate);
                _objCharacter.ExpenseEntries.Add(objEntry);

                objUndo = new ExpenseUndo();
                objUndo.CreateNuyen(NuyenExpenseType.ManualSubtract, string.Empty);
                objEntry.Undo = objUndo;

                // Adjust the character's Nuyen total.
                _objCharacter.Nuyen += frmNewExpense.Amount * 2000.0m;
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdKarmaEdit_Click(object sender, EventArgs e)
        {
            lstKarma_DoubleClick(sender, e);
        }

        private void cmdNuyenGained_Click(object sender, EventArgs e)
        {
            frmExpense frmNewExpense = new frmExpense();
            frmNewExpense.Mode = ExpenseType.Nuyen;
            frmNewExpense.KarmaNuyenExchangeString = LanguageManager.GetString("String_WorkingForTheMan");
            frmNewExpense.ShowDialog(this);

            if (frmNewExpense.DialogResult == DialogResult.Cancel)
                return;

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create(frmNewExpense.Amount, frmNewExpense.Reason, ExpenseType.Nuyen, frmNewExpense.SelectedDate);
            objEntry.Refund = frmNewExpense.Refund;
            _objCharacter.ExpenseEntries.Add(objEntry);

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateNuyen(NuyenExpenseType.ManualAdd, string.Empty);
            objEntry.Undo = objUndo;

            // Adjust the character's Nuyen total.
            _objCharacter.Nuyen += frmNewExpense.Amount;

            if (frmNewExpense.KarmaNuyenExchange)
            {
                // Create the Expense Log Entry.
                objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(frmNewExpense.Amount / 2000.0m * -1, frmNewExpense.Reason, ExpenseType.Karma, frmNewExpense.SelectedDate, frmNewExpense.Refund);
                _objCharacter.ExpenseEntries.Add(objEntry);

                objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ManualSubtract, string.Empty);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma += decimal.ToInt32(frmNewExpense.Amount / 2000.0m) * -1;
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdNuyenSpent_Click(object sender, EventArgs e)
        {
            frmExpense frmNewExpense = new frmExpense();
            frmNewExpense.Mode = ExpenseType.Nuyen;
            frmNewExpense.KarmaNuyenExchangeString = LanguageManager.GetString("String_WorkingForThePeople");
            frmNewExpense.ShowDialog(this);

            if (frmNewExpense.DialogResult == DialogResult.Cancel)
                return;

            // Make sure the Nuyen expense would not put the character's remaining Nuyen amount below 0.
            if (_objCharacter.Nuyen - frmNewExpense.Amount < 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create(frmNewExpense.Amount * -1, frmNewExpense.Reason, ExpenseType.Nuyen, frmNewExpense.SelectedDate);
            _objCharacter.ExpenseEntries.Add(objEntry);

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateNuyen(NuyenExpenseType.ManualSubtract, string.Empty);
            objEntry.Undo = objUndo;

            // Adjust the character's Nuyen total.
            _objCharacter.Nuyen += frmNewExpense.Amount * -1;

            if (frmNewExpense.KarmaNuyenExchange)
            {
                // Create the Expense Log Entry.
                objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(frmNewExpense.Amount / 2000.0m, frmNewExpense.Reason, ExpenseType.Karma, frmNewExpense.SelectedDate, frmNewExpense.Refund);
                _objCharacter.ExpenseEntries.Add(objEntry);

                objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ManualSubtract, string.Empty);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma += decimal.ToInt32(frmNewExpense.Amount / 2000.0m);
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdNuyenEdit_Click(object sender, EventArgs e)
        {
            lstNuyen_DoubleClick(sender, e);
        }

        private void cmdDecreaseLifestyleMonths_Click(object sender, EventArgs e)
        {
                if (treLifestyles.SelectedNode == null)
                    return;

            // Locate the selected Lifestyle.
            Lifestyle objLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);
            if (objLifestyle == null)
                return;

            objLifestyle.Months -= 1;
            lblLifestyleMonths.Text = objLifestyle.Months.ToString();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdIncreaseLifestyleMonths_Click(object sender, EventArgs e)
        {
                if (treLifestyles.SelectedNode == null)
                    return;

            // Locate the selected Lifestyle.
            Lifestyle objLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);
            if (objLifestyle == null)
                return;

            // Create the Expense Log Entry.
            decimal decAmount = objLifestyle.TotalMonthlyCost;
            if (decAmount > _objCharacter.Nuyen)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(decAmount * -1, LanguageManager.GetString("String_ExpenseLifestyle") + " " + objLifestyle.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Nuyen -= decAmount;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateNuyen(NuyenExpenseType.IncreaseLifestyle, objLifestyle.Name);
            objExpense.Undo = objUndo;

            objLifestyle.Months += 1;
            lblLifestyleMonths.Text = objLifestyle.Months.ToString();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddCritterPower_Click(object sender, EventArgs e)
        {
            // Make sure the Critter is allowed to have Optional Powers.
            XmlDocument objXmlDocument = XmlManager.Load("critters.xml");
            XmlNode objXmlCritter = objXmlDocument.SelectSingleNode("/chummer/metatypes/metatype[name = \"" + _objCharacter.Metatype + "\"]");

            if (objXmlCritter == null)
            {
                objXmlDocument = XmlManager.Load("metatypes.xml");
                objXmlCritter = objXmlDocument.SelectSingleNode("/chummer/metatypes/metatype[name = \"" + _objCharacter.Metatype + "\"]");
            }

            frmSelectCritterPower frmPickCritterPower = new frmSelectCritterPower(_objCharacter);
            frmPickCritterPower.ShowDialog(this);

            if (frmPickCritterPower.DialogResult == DialogResult.Cancel)
                return;

            objXmlDocument = XmlManager.Load("critterpowers.xml");
            XmlNode objXmlPower = objXmlDocument.SelectSingleNode("/chummer/powers/power[id = \"" + frmPickCritterPower.SelectedPower + "\"]");
            TreeNode objNode = new TreeNode();
            CritterPower objPower = new CritterPower(_objCharacter);
            objPower.Create(objXmlPower, objNode, frmPickCritterPower.SelectedRating);
            objPower.PowerPoints = frmPickCritterPower.PowerPoints;
            objNode.ContextMenuStrip = cmsCritterPowers;
            if (objPower.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.CritterPowers.Add(objPower);

            if (objPower.Category != "Weakness")
            {
                treCritterPowers.Nodes[0].Nodes.Add(objNode);
                treCritterPowers.Nodes[0].Expand();
            }
            else
            {
                treCritterPowers.Nodes[1].Nodes.Add(objNode);
                treCritterPowers.Nodes[1].Expand();
            }
            if (objPower.Karma > 0)
            {
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(objPower.Karma * -1, LanguageManager.GetString("String_ExpensePurchaseCritterPower") + " " + objPower.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddCritterPower, objPower.InternalId);
                objExpense.Undo = objUndo;
            }
            // Determine if the Critter should have access to the Possession menu item.
            bool blnAllowPossession = false;
            foreach (CritterPower objCritterPower in _objCharacter.CritterPowers)
            {
                if (objCritterPower.Name == "Inhabitation" || objCritterPower.Name == "Possession")
                {
                    blnAllowPossession = true;
                    break;
                }
            }
            mnuSpecialPossess.Visible = blnAllowPossession;

            treCritterPowers.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickCritterPower.AddAgain)
                cmdAddCritterPower_Click(sender, e);
        }

        private void cmdDeleteCritterPower_Click(object sender, EventArgs e)
        {
            if (treCritterPowers.SelectedNode == null || treCritterPowers.SelectedNode.Level == 0)
                    return;

            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteCritterPower")))
                return;

            // Locate the selected Critter Power.
            CritterPower objPower = CommonFunctions.FindByIdWithNameCheck(treCritterPowers.SelectedNode.Tag.ToString(), _objCharacter.CritterPowers);

            // Remove any Improvements that were created by the Critter Power.
            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.CritterPower, objPower.InternalId);

            _objCharacter.CritterPowers.Remove(objPower);
            treCritterPowers.SelectedNode.Remove();

            // Determine if the Critter should have access to the Possession menu item.
            bool blnAllowPossession = false;
            foreach (CritterPower objCritterPower in _objCharacter.CritterPowers)
            {
                if (objCritterPower.Name == "Inhabitation" || objCritterPower.Name == "Possession")
                {
                    blnAllowPossession = true;
                    break;
                }
            }
            mnuSpecialPossess.Visible = blnAllowPossession;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdDeleteComplexForm_Click(object sender, EventArgs e)
        {
            // Delete the selected Complex Form.
            if (treComplexForms.SelectedNode != null)
            {
                if (treComplexForms.SelectedNode.Level == 1)
                {
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteComplexForm")))
                        return;

                    // Locate the Program that is selected in the tree.
                    ComplexForm objProgram = CommonFunctions.FindByIdWithNameCheck(treComplexForms.SelectedNode.Tag.ToString(), _objCharacter.ComplexForms);

                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ComplexForm, objProgram.InternalId);

                    _objCharacter.ComplexForms.Remove(objProgram);
                    treComplexForms.SelectedNode.Remove();
                }
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdImproveComplexForm_Click(object sender, EventArgs e)
        {
            if (treComplexForms.SelectedNode != null)
            {
            if (treComplexForms.SelectedNode.Level == 1)
            {
                // Locate the Program that is selected in the tree.
                    ComplexForm objProgram = CommonFunctions.FindByIdWithNameCheck(treComplexForms.SelectedNode.Tag.ToString(), _objCharacter.ComplexForms);

                // Make sure the character has enough Karma.
                int intKarmaCost = _objOptions.KarmaImproveComplexForm;

                if (intKarmaCost > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", intKarmaCost.ToString()).Replace("{1}", objProgram.DisplayNameShort)))
                    return;

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseComplexForm") + " " + objProgram.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaCost;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ImproveComplexForm, objProgram.InternalId);
                objExpense.Undo = objUndo;

                treComplexForms.SelectedNode.Text = objProgram.DisplayName;
            }

                ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
        }

        private void cmdGearReduceQty_Click(object sender, EventArgs e)
        {
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            Gear objParent = CommonFunctions.DeepFindById(treGear.SelectedNode.Parent.Tag.ToString(), _objCharacter.Gear);

            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_ReduceQty")))
                return;
                
            objGear.Quantity -= 1;

            if (objGear.Quantity > 0)
            {
                treGear.SelectedNode.Text = objGear.DisplayName;
                RefreshSelectedGear();
            }
            else
            {
                // Remove the Gear if its quantity has been reduced to 0.
                if (objParent == null)
                {
                    _objCharacter.Gear.Remove(objGear);
                    treGear.SelectedNode.Remove();
                }
                else
                {
                    objParent.Children.Remove(objGear);
                    treGear.SelectedNode.Remove();
                }

                // Remove any Weapons that came with it.
                if (objGear.WeaponID != Guid.Empty.ToString())
                {
                    List<string> lstNodesToRemoveIds = new List<string>();
                    foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objGear.InternalId))
                    {
                        lstNodesToRemoveIds.Add(objWeapon.InternalId);
                        CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                        // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                        if (objWeapon.Parent != null)
                            objWeapon.Parent.Children.Remove(objWeapon);
                        else
                            _objCharacter.Weapons.Remove(objWeapon);
                    }
                    foreach (string strNodeId in lstNodesToRemoveIds)
                    {
                        // Remove the Weapons from the TreeView.
                        CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                    }
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdGearSplitQty_Click(object sender, EventArgs e)
        {
            // This can only be done with the first level of Nodes.
            if (treGear.SelectedNode == null || treGear.SelectedNode.Level != 1)
                    return;

            Gear objSelectedGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);

            // Cannot split a stack of 1 item.
            if (objSelectedGear.Quantity <= (objSelectedGear.Category == "Currency" ? 0.01m : 1.0m))
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotSplitGear"), LanguageManager.GetString("MessageTitle_CannotSplitGear"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            frmSelectNumber frmPickNumber = new frmSelectNumber(objSelectedGear.Category == "Currency" ? 2 : 0);
            decimal decMinValue = (objSelectedGear.Category == "Currency" ? 0.01m : 1.0m);
            frmPickNumber.Minimum = decMinValue;
            frmPickNumber.Maximum = objSelectedGear.Quantity - decMinValue;
            frmPickNumber.Description = LanguageManager.GetString("String_SplitGear");
            frmPickNumber.ShowDialog(this);

            if (frmPickNumber.DialogResult == DialogResult.Cancel)
                return;

            // Create a new piece of Gear.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + objSelectedGear.Name + "\" and category = \"" + objSelectedGear.Category + "\"]");
            
            TreeNode objGearNode = new TreeNode();
            List<Weapon> lstWeapons = new List<Weapon>();
            List<TreeNode> lstWeaponNodes = new List<TreeNode>();
            Gear objGear = new Gear(_objCharacter);
            if (objSelectedGear.GetType() == typeof(Commlink))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);
                objGear = objCommlink;
            }
            else
                objGear.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);
            
            objGear.Quantity = frmPickNumber.SelectedValue;
            objGear.Equipped = objSelectedGear.Equipped;
            objGear.Location = objSelectedGear.Location;
            objGear.Notes = objSelectedGear.Notes;
            objGearNode.Text = objGear.DisplayName;
            objGearNode.ContextMenuStrip = treGear.SelectedNode.ContextMenuStrip;

            // Update the selected item.
            objSelectedGear.Quantity -= frmPickNumber.SelectedValue;
            treGear.SelectedNode.Text = objSelectedGear.DisplayName;

            treGear.SelectedNode.Parent.Nodes.Add(objGearNode);
            _objCharacter.Gear.Add(objGear);

            // Create any Weapons that came with this Gear.
            foreach (Weapon objWeapon in lstWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in lstWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdGearMergeQty_Click(object sender, EventArgs e)
        {
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            List<Gear> lstGear = new List<Gear>();

            foreach (Gear objCharacterGear in _objCharacter.Gear)
            {
                bool blnMatch = false;
                // Matches must happen on Name, Category, Rating, and Extra, plus all plugins.
                if (objCharacterGear.Name == objGear.Name && objCharacterGear.Category == objGear.Category && objCharacterGear.Rating == objGear.Rating && objCharacterGear.Extra == objGear.Extra && objCharacterGear.InternalId != objGear.InternalId)
                {
                    blnMatch = true;
                    if (objCharacterGear.Children.Count == objGear.Children.Count)
                    {
                        for (int i = 0; i <= objCharacterGear.Children.Count - 1; i++)
                        {
                            if (objCharacterGear.Children[i].Name != objGear.Children[i].Name || objCharacterGear.Children[i].Extra != objGear.Children[i].Extra || objCharacterGear.Children[i].Rating != objGear.Children[i].Rating)
                            {
                                blnMatch = false;
                                break;
                            }
                        }
                    }
                    else
                        blnMatch = false;
                }

                if (blnMatch)
                    lstGear.Add(objCharacterGear);
            }

            // If there were no matches, don't try to merge anything.
            if (lstGear.Count == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotMergeGear"), LanguageManager.GetString("MessageTitle_CannotMergeGear"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            // Show the Select Item window.
            frmSelectItem frmPickItem = new frmSelectItem();
            frmPickItem.Gear = lstGear;
            frmPickItem.ShowDialog(this);

            if (frmPickItem.DialogResult == DialogResult.Cancel)
                return;

            Gear objSelectedGear = CommonFunctions.DeepFindById(frmPickItem.SelectedItem, _objCharacter.Gear);

            frmSelectNumber frmPickNumber = new frmSelectNumber(objSelectedGear.Category == "Currency" ? 2 : 0);
            frmPickNumber.Minimum = (objSelectedGear.Category == "Currency" ? 0.01m : 1.0m);
            frmPickNumber.Maximum = objGear.Quantity;
            frmPickNumber.Description = LanguageManager.GetString("String_MergeGear");
            frmPickNumber.ShowDialog(this);

            if (frmPickNumber.DialogResult == DialogResult.Cancel)
                return;

            // Increase the quantity for the selected item.
            objSelectedGear.Quantity += frmPickNumber.SelectedValue;
            // Located the item in the Tree and update its display information.
            foreach (TreeNode objParent in treGear.Nodes)
            {
                foreach (TreeNode objNode in objParent.Nodes)
                {
                    if (objNode.Tag.ToString() == objSelectedGear.InternalId)
                    {
                        objNode.Text = objSelectedGear.DisplayName;
                        break;
                    }
                }
            }

            // Reduce the quantity for the selected item.
            objGear.Quantity -= frmPickNumber.SelectedValue;
            // If the quantity has reached 0, delete the item and any Weapons it created.
            if (objGear.Quantity <= 0)
            {
                // Remove the Gear Weapon created by the Gear if applicable.
                if (objGear.WeaponID != Guid.Empty.ToString())
                {
                    List<string> lstNodesToRemoveIds = new List<string>();
                    foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objGear.InternalId))
                    {
                        lstNodesToRemoveIds.Add(objWeapon.InternalId);
                        CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                        // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                        if (objWeapon.Parent != null)
                            objWeapon.Parent.Children.Remove(objWeapon);
                        else
                            _objCharacter.Weapons.Remove(objWeapon);
                    }
                    foreach (string strNodeId in lstNodesToRemoveIds)
                    {
                        // Remove the Weapons from the TreeView.
                        CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                    }
                }

                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);

                // Remove the Gear from the character.
                _objCharacter.Gear.Remove(objGear);
                treGear.SelectedNode.Remove();
            }
            else
                treGear.SelectedNode.Text = objGear.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdGearMoveToVehicle_Click(object sender, EventArgs e)
        {
            frmSelectItem frmPickItem = new frmSelectItem();
            frmPickItem.Vehicles = _objCharacter.Vehicles;
            frmPickItem.ShowDialog(this);

            if (frmPickItem.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected Vehicle.
            Vehicle objVehicle = null;
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                if (objCharacterVehicle.InternalId == frmPickItem.SelectedItem)
                {
                    objVehicle = objCharacterVehicle;
                    break;
                }
            }

            Gear objSelectedGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            decimal decMove = 0;
            decimal decMinAmount = (objSelectedGear.Category == "Currency" ? 0.01m : 1.0m);
            if (objSelectedGear.Quantity == decMinAmount)
                decMove = decMinAmount;
            else
            {
                frmSelectNumber frmPickNumber = new frmSelectNumber(objSelectedGear.Category == "Currency" ? 2 : 0);
                frmPickNumber.Minimum = decMinAmount;
                frmPickNumber.Maximum = objSelectedGear.Quantity;
                frmPickNumber.Description = LanguageManager.GetString("String_MoveGear");
                frmPickNumber.ShowDialog(this);

                if (frmPickNumber.DialogResult == DialogResult.Cancel)
                    return;

                decMove = frmPickNumber.SelectedValue;
            }

            // See if the Vehicle already has a matching piece of Gear.
            bool blnMatch = false;
            Gear objFoundGear = null;
            foreach (Gear objVehicleGear in objVehicle.Gear)
            {
                if (objVehicleGear.Name == objSelectedGear.Name && objVehicleGear.Category == objSelectedGear.Category && objVehicleGear.Rating == objSelectedGear.Rating && objVehicleGear.Extra == objSelectedGear.Extra && objVehicleGear.GearName == objSelectedGear.GearName && objVehicleGear.Notes == objSelectedGear.Notes)
                {
                    blnMatch = true;
                    objFoundGear = objVehicleGear;
                    if (objVehicleGear.Children.Count == objSelectedGear.Children.Count)
                    {
                        for (int i = 0; i <= objVehicleGear.Children.Count - 1; i++)
                        {
                            if (objVehicleGear.Children[i].Name != objSelectedGear.Children[i].Name || objVehicleGear.Children[i].Extra != objSelectedGear.Children[i].Extra || objVehicleGear.Children[i].Rating != objSelectedGear.Children[i].Rating)
                            {
                                blnMatch = false;
                                break;
                            }
                        }
                    }
                    else
                        blnMatch = false;
                }
            }

            if (!blnMatch)
            {
                // Create a new piece of Gear.
                TreeNode objGearNode = new TreeNode();
                List<Weapon> lstWeapons = new List<Weapon>();
                List<TreeNode> lstWeaponNodes = new List<TreeNode>();
                Gear objGear = new Gear(_objCharacter);
                if (objSelectedGear.GetType() == typeof(Commlink))
                {
                    Commlink objCommlink = new Commlink(_objCharacter);
                    objCommlink.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);
                    objGear = objCommlink;
                }
                else
                    objGear.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);

                objGear.Parent = null;
                objGear.Quantity = decMove;
                objGear.Location = string.Empty;
                objGearNode.Text = objGear.DisplayName;
                objGearNode.ContextMenuStrip = cmsVehicleGear;

                // Locate the Node for the selected Vehicle.
                TreeNode nodParent = new TreeNode();
                foreach (TreeNode nodNode in treVehicles.Nodes[0].Nodes)
                {
                    if (nodNode.Tag.ToString() == objVehicle.InternalId)
                    {
                        nodParent = nodNode;
                        break;
                    }
                }

                nodParent.Nodes.Add(objGearNode);
                objVehicle.Gear.Add(objGear);
            }
            else
            {
                // Everything matches up, so just increase the quantity.
                objFoundGear.Quantity += decMove;
                foreach (TreeNode nodVehicle in treVehicles.Nodes[0].Nodes)
                {
                    if (nodVehicle.Tag.ToString() == objVehicle.InternalId)
                    {
                        foreach (TreeNode nodGear in nodVehicle.Nodes)
                        {
                            if (nodGear.Tag.ToString() == objFoundGear.InternalId)
                                nodGear.Text = objFoundGear.DisplayName;
                        }
                    }
                }
            }

            // Update the selected item.
            objSelectedGear.Quantity -= decMove;
            if (objSelectedGear.Quantity <= 0)
            {
                if (objSelectedGear.Parent != null)
                {
                    objSelectedGear.Parent.Children.Remove(objSelectedGear);
                    Commlink objParentCommlink = objSelectedGear.Parent as Commlink;
                    if (objParentCommlink?.CanSwapAttributes == true)
                    {
                        objParentCommlink.RefreshCyberdeckArray();
                    }
                }
                else
                    _objCharacter.Gear.Remove(objSelectedGear);
                CommonFunctions.DeleteGear(_objCharacter, objSelectedGear, treWeapons, treVehicles);
                treGear.SelectedNode.Remove();
                ScheduleCharacterUpdate();
            }
            else
            {
                treGear.SelectedNode.Text = objSelectedGear.DisplayName;
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdVehicleMoveToInventory_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            bool blnFound = false;
            Weapon objWeapon = null;
            Vehicle objVehicle = null;
            VehicleMod objMod = null;

            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                foreach (Weapon objVehicleWeapon in objCharacterVehicle.Weapons)
                {
                    if (objVehicleWeapon.InternalId == treVehicles.SelectedNode.Tag.ToString())
                    {
                        objWeapon = objVehicleWeapon;
                        objVehicle = objCharacterVehicle;
                        blnFound = true;
                        break;
                    }
                }
                foreach (VehicleMod objVehicleMod in objCharacterVehicle.Mods)
                {
                    foreach (Weapon objVehicleWeapon in objVehicleMod.Weapons)
                    {
                        if (objVehicleWeapon.InternalId == treVehicles.SelectedNode.Tag.ToString())
                        {
                            objWeapon = objVehicleWeapon;
                            objVehicle = objCharacterVehicle;
                            objMod = objVehicleMod;
                            blnFound = true;
                            break;
                        }
                    }
                }
            }

            if (blnFound)
            {
                // Move the Weapons from the Vehicle Mod (or Vehicle) to the character.
                if (objMod != null)
                    objMod.Weapons.Remove(objWeapon);
                else
                    objVehicle.Weapons.Remove(objWeapon);

                _objCharacter.Weapons.Add(objWeapon);

                TreeNode objNode = new TreeNode();
                objNode = treVehicles.SelectedNode;

                treVehicles.SelectedNode.Remove();
                treWeapons.Nodes[0].Nodes.Add(objNode);
                objWeapon.VehicleMounted = false;
                objNode.Expand();
            }
            else
            {
                // Locate the selected Gear.
                Gear objSelectedGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

                decimal decMove = 0;
                decimal decMinAmount = (objSelectedGear.Category == "Currency" ? 0.01m : 1.0m);
                if (objSelectedGear.Quantity == decMinAmount)
                    decMove = decMinAmount;
                else
                {
                    frmSelectNumber frmPickNumber = new frmSelectNumber(objSelectedGear.Category == "Currency" ? 2 : 0);
                    frmPickNumber.Minimum = decMinAmount;
                    frmPickNumber.Maximum = objSelectedGear.Quantity;
                    frmPickNumber.Description = LanguageManager.GetString("String_MoveGear");
                    frmPickNumber.ShowDialog(this);

                    if (frmPickNumber.DialogResult == DialogResult.Cancel)
                        return;

                    decMove = frmPickNumber.SelectedValue;
                }

                // See if the character already has a matching piece of Gear.
                Gear objFoundGear = _objCharacter.Gear.FirstOrDefault(x => objSelectedGear.IsIdenticalToOtherGear(x));

                if (objFoundGear == null)
                {
                    // Create a new piece of Gear.
                    TreeNode objGearNode = new TreeNode();
                    List<Weapon> lstWeapons = new List<Weapon>();
                    List<TreeNode> lstWeaponNodes = new List<TreeNode>();
                    Gear objGear = new Gear(_objCharacter);
                    if (objSelectedGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = new Commlink(_objCharacter);
                        objCommlink.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);
                        objGear = objCommlink;
                    }
                    else
                        objGear.Copy(objSelectedGear, objGearNode, lstWeapons, lstWeaponNodes);

                    objGear.Parent = null;
                    objGear.Quantity = decMove;
                    objGearNode.Text = objGear.DisplayName;
                    objGearNode.ContextMenuStrip = cmsGear;

                    treGear.Nodes[0].Nodes.Add(objGearNode);
                    _objCharacter.Gear.Add(objGear);

                    // Create any Weapons that came with this Gear.
                    foreach (Weapon objGearWeapon in lstWeapons)
                        _objCharacter.Weapons.Add(objGearWeapon);

                    foreach (TreeNode objWeaponNode in lstWeaponNodes)
                    {
                        objWeaponNode.ContextMenuStrip = cmsWeapon;
                        treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                        treWeapons.Nodes[0].Expand();
                    }

                    AddGearImprovements(objGear);
                    ScheduleCharacterUpdate();
                }
                else
                {
                    // Everything matches up, so just increase the quantity.
                    objFoundGear.Quantity += decMove;
                    TreeNode nodGear = CommonFunctions.FindNode(objFoundGear.InternalId, treGear);
                    if (nodGear != null)
                    {
                        nodGear.Text = objFoundGear.DisplayName;
                        treGear.SelectedNode = nodGear;
                    }
                }

                // Update the selected item.
                objSelectedGear.Quantity -= decMove;
                if (objSelectedGear.Quantity <= 0)
                {
                    // The quantity has reached 0, so remove it entirely.
                    treVehicles.SelectedNode.Remove();
                    foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
                        objCharacterVehicle.Gear.Remove(objSelectedGear);
                }
                else
                    treVehicles.SelectedNode.Text = objSelectedGear.DisplayName;
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
        
        private void cmdGearIncreaseQty_Click(object sender, EventArgs e)
        {
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            
            // Select the root Gear node then open the Select Gear window.
            bool blnAddAgain = PickGear((objGear.Category == "Ammunition"), objGear, objGear.Name);
            if (blnAddAgain)
                cmdGearIncreaseQty_Click(sender, e);
            CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
        }

        private void cmdVehicleGearReduceQty_Click(object sender, EventArgs e)
        {
            Vehicle objVehicle = null;
            WeaponAccessory objWeaponAccessory = null;
            Cyberware objCyberware = null;
            // Locate the currently selected piece of Gear.
            Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle, out objWeaponAccessory, out objCyberware);
            Gear objParent = objGear?.Parent;

            if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_ReduceQty")))
                return;

            objGear.Quantity -= 1;

            if (objGear.Quantity > 0)
            {
                treVehicles.SelectedNode.Text = objGear.DisplayName;
                RefreshSelectedVehicle();
            }
            else
            {
                // Remove the Gear if its quantity has been reduced to 0.
                if (objParent == null)
                {
                    if (objWeaponAccessory != null)
                        objWeaponAccessory.Gear.Remove(objGear);
                    else if (objCyberware != null)
                        objCyberware.Gear.Remove(objGear);
                    else
                        objVehicle.Gear.Remove(objGear);
                    treVehicles.SelectedNode.Remove();
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treVehicles, treVehicles);
                }
                else
                {
                    objParent.Children.Remove(objGear);
                    Commlink objParentCommlink = objParent as Commlink;
                    if (objParentCommlink?.CanSwapAttributes == true)
                    {
                        objParentCommlink.RefreshCyberdeckArray();
                    }
                    treVehicles.SelectedNode.Remove();
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddQuality_Click(object sender, EventArgs e)
        {
            frmSelectQuality frmPickQuality = new frmSelectQuality(_objCharacter);
            frmPickQuality.ShowDialog(this);

            // Don't do anything else if the form was canceled.
            if (frmPickQuality.DialogResult == DialogResult.Cancel)
                return;

            XmlDocument objXmlDocument = XmlManager.Load("qualities.xml");
            XmlNode objXmlQuality = objXmlDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + frmPickQuality.SelectedQuality + "\"]");

            TreeNode objNode = new TreeNode();
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            Quality objQuality = new Quality(_objCharacter);

            objQuality.Create(objXmlQuality, _objCharacter, QualitySource.Selected, objNode, objWeapons, objWeaponNodes);
            if (objQuality.InternalId == Guid.Empty.ToString())
            {
                // If the Quality could not be added, remove the Improvements that were added during the Quality Creation process.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
                return;
            }
            objNode.ContextMenuStrip = cmsQuality;
            bool blnHasQualityAlready = _objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objQuality.QualityId && objExistingQuality.Extra == objQuality.Extra);

            if (frmPickQuality.FreeCost)
                objQuality.BP = 0;

            bool blnAddItem = true;
            int intKarmaCost = objQuality.BP * _objOptions.KarmaQuality;
            if (!_objCharacter.Options.DontDoubleQualityPurchases && objQuality.DoubleCost)
                intKarmaCost *= 2;

            // Make sure the character has enough Karma to pay for the Quality.
            if (objQuality.Type == QualityType.Positive)
            {
                if (intKarmaCost > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    blnAddItem = false;
                }

                if (blnAddItem && !frmPickQuality.FreeCost && objQuality.ContributeToBP)
                {
                    if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", objQuality.DisplayNameShort).Replace("{1}", intKarmaCost.ToString())))
                        blnAddItem = false;
                }

                if (blnAddItem && objQuality.ContributeToBP)
                {
                    // Create the Karma expense.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseAddPositiveQuality") + " " + objQuality.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Karma -= intKarmaCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.AddQuality, objQuality.InternalId);
                    objExpense.Undo = objUndo;
                }
            }
            else
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_AddNegativeQuality"), LanguageManager.GetString("MessageTitle_AddNegativeQuality"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    blnAddItem = false;

                if (blnAddItem)
                {
                    // Create a Karma Expense for the Negative Quality.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(0, LanguageManager.GetString("String_ExpenseAddNegativeQuality") + " " + objQuality.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.AddQuality, objQuality.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            if (blnAddItem)
            {
                // Add the Quality to the appropriate parent node.
                if (!blnHasQualityAlready)
                {
                    if (objQuality.Type == QualityType.Positive)
                    {
                        treQualities.Nodes[0].Nodes.Add(objNode);
                        treQualities.Nodes[0].Expand();
                    }
                    else
                    {
                        treQualities.Nodes[1].Nodes.Add(objNode);
                        treQualities.Nodes[1].Expand();
                    }
                }
                _objCharacter.Qualities.Add(objQuality);

                // Add any created Weapons to the character.
                foreach (Weapon objWeapon in objWeapons)
                    _objCharacter.Weapons.Add(objWeapon);

                // Create the Weapon Node if one exists.
                foreach (TreeNode objWeaponNode in objWeaponNodes)
                {
                    objWeaponNode.ContextMenuStrip = cmsWeapon;
                    treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                    treWeapons.Nodes[0].Expand();
                }

                // Add any additional Qualities that are forced on the character.
                if (objXmlQuality.SelectNodes("addqualities/addquality").Count > 0)
                {
                    
                }
            }
            else
            {
                // Remove the Improvements created by the Create method.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
            }

            treQualities.SortCustom();
            // If entry already exists in tree, just update the rating
            if (blnHasQualityAlready)
                RefreshQualityNames(treQualities);
            UpdateMentorSpirits();
            ScheduleCharacterUpdate();
            RefreshMartialArts();
            RefreshAIPrograms();
            RefreshLimitModifiers();
            RefreshContacts();
            RefreshCritterPowers(treCritterPowers, cmsCritterPowers);
            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickQuality.AddAgain)
                cmdAddQuality_Click(sender, e);
        }

        private void cmdDeleteQuality_Click(object sender, EventArgs e)
        {
            // Locate the selected Quality.
            if (treQualities.SelectedNode == null || treQualities.SelectedNode.Level <= 0)
                return;

            Quality objSelectedQuality = CommonFunctions.FindByIdWithNameCheck(treQualities.SelectedNode.Tag.ToString(), _objCharacter.Qualities);
            string strInternalIDToRemove = objSelectedQuality.QualityId;
            // Can't do a foreach because we're removing items, this is the next best thing
            bool blnFirstRemoval = true;
            for (int i = _objCharacter.Qualities.Count - 1; i >= 0; --i)
            {
                Quality objLoopQuality = _objCharacter.Qualities.ElementAt(i);
                if (objLoopQuality.QualityId == strInternalIDToRemove)
                {
                    if (!RemoveQuality(objLoopQuality, blnFirstRemoval))
                        break;
                    blnFirstRemoval = false;
                    if (i > _objCharacter.Qualities.Count)
                    {
                        i = _objCharacter.Qualities.Count;
                    }
                }
            }

            // Only refresh if at least one quality was removed
            if (!blnFirstRemoval)
            {
                RefreshQualities(treQualities, cmsQuality, true);
                treQualities.SortCustom();
                nudQualityLevel_UpdateValue(null);
                UpdateMentorSpirits();
                ScheduleCharacterUpdate();
                RefreshMartialArts();
                RefreshAIPrograms();
                RefreshLimitModifiers();
                RefreshSpells(treSpells, cmsSpell, _objCharacter);
                PopulateGearList();
                RefreshContacts();
                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdSwapQuality_Click(object sender, EventArgs e)
        {
            // Locate the selected Quality.
            if (treQualities.SelectedNode == null || treQualities.SelectedNode.Level == 0)
                return;

            Quality objQuality = CommonFunctions.FindByIdWithNameCheck(treQualities.SelectedNode.Tag.ToString(), _objCharacter.Qualities);
            if (objQuality.InternalId == Guid.Empty.ToString())
                return;

            // Qualities that come from a Metatype cannot be removed.
            if (objQuality.OriginSource == QualitySource.Metatype)
            {
                MessageBox.Show(LanguageManager.GetString("Message_MetavariantQualitySwap"), LanguageManager.GetString("MessageTitle_MetavariantQualitySwap"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            // Neither can qualities from Improvements
            if (objQuality.OriginSource == QualitySource.Improvement)
            {
                MessageBox.Show(LanguageManager.GetString("Message_ImprovementQuality").Replace("{0}", objQuality.SourceName), LanguageManager.GetString("MessageTitle_MetavariantQuality"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectQuality frmPickQuality = new frmSelectQuality(_objCharacter);
            frmPickQuality.ForceCategory = objQuality.Type.ToString();
            frmPickQuality.IgnoreQuality = objQuality.Name;
            frmPickQuality.ShowDialog(this);

            // Don't do anything else if the form was canceled.
            if (frmPickQuality.DialogResult == DialogResult.Cancel)
                return;

            XmlDocument objXmlDocument = XmlManager.Load("qualities.xml");
            XmlNode objXmlQuality = objXmlDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + frmPickQuality.SelectedQuality + "\"]");

            TreeNode objNode = new TreeNode();
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            Quality objNewQuality = new Quality(_objCharacter);

            objNewQuality.Create(objXmlQuality, _objCharacter, QualitySource.Selected, objNode, objWeapons, objWeaponNodes);
            objNode.ContextMenuStrip = cmsQuality;

            bool blnAddItem = true;
            int intKarmaCost = (objNewQuality.BP - objQuality.BP) * _objOptions.KarmaQuality;
            // Make sure the character has enough Karma to pay for the Quality.
            if (objNewQuality.Type == QualityType.Positive)
            {
                if (!_objOptions.DontDoubleQualityPurchases)
                {
                    intKarmaCost *= 2;
                }
                if (intKarmaCost > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    blnAddItem = false;
                }

                if (blnAddItem)
                {
                    if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_QualitySwap").Replace("{0}", objQuality.DisplayNameShort).Replace("{1}", objNewQuality.DisplayNameShort)))
                        blnAddItem = false;
                }

                if (blnAddItem)
                {
                    // Create the Karma expense.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseSwapPositiveQuality").Replace("{0}", objQuality.DisplayNameShort).Replace("{1}", objNewQuality.DisplayNameShort), ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Karma -= intKarmaCost;
                }
            }
            else
            {
                if (!_objOptions.DontDoubleQualityRefunds)
                {
                    intKarmaCost *= 2;
                }
                // This should only happen when a character is trading up to a less-costly Quality.
                if (intKarmaCost > 0)
                {
                    if (intKarmaCost > _objCharacter.Karma)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        blnAddItem = false;
                    }

                    if (blnAddItem)
                    {
                        if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_QualitySwap").Replace("{0}", objQuality.Name).Replace("{1}", objNewQuality.Name)))
                            blnAddItem = false;
                    }

                    if (blnAddItem)
                    {
                        // Create the Karma expense.
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseSwapNegativeQuality").Replace("{0}", objQuality.DisplayNameShort).Replace("{1}", objNewQuality.DisplayNameShort), ExpenseType.Karma, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Karma -= intKarmaCost;
                    }
                }
            }

            bool blnHasNewQualityAlready = _objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objNewQuality.QualityId && objExistingQuality.Extra == objNewQuality.Extra);
            if (blnAddItem)
            {
                // Add the Quality to the appropriate parent node.
                if (!blnHasNewQualityAlready)
                {
                    if (objNewQuality.Type == QualityType.Positive)
                    {
                        treQualities.Nodes[0].Nodes.Add(objNode);
                        treQualities.Nodes[0].Expand();
                    }
                    else
                    {
                        treQualities.Nodes[1].Nodes.Add(objNode);
                        treQualities.Nodes[1].Expand();
                    }
                }

                // Add any created Weapons to the character.
                foreach (Weapon objWeapon in objWeapons)
                    _objCharacter.Weapons.Add(objWeapon);

                // Create the Weapon Node if one exists.
                foreach (TreeNode objWeaponNode in objWeaponNodes)
                {
                    objWeaponNode.ContextMenuStrip = cmsWeapon;
                    treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                    treWeapons.Nodes[0].Expand();
                }

                // Remove any Improvements for the old Quality.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
                _objCharacter.Qualities.Remove(objQuality);
                if (!_objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objQuality.QualityId && objExistingQuality.Extra == objQuality.Extra))
                    treQualities.SelectedNode.Remove();

                // Remove any Weapons created by the old Quality if applicable.
                if (objQuality.WeaponID != Guid.Empty.ToString())
                {
                    List<string> lstNodesToRemoveIds = new List<string>();
                    foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objQuality.InternalId))
                    {
                        lstNodesToRemoveIds.Add(objWeapon.InternalId);
                        CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                        // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                        if (objWeapon.Parent != null)
                            objWeapon.Parent.Children.Remove(objWeapon);
                        else
                            _objCharacter.Weapons.Remove(objWeapon);
                    }
                    foreach (string strNodeId in lstNodesToRemoveIds)
                    {
                        // Remove the Weapons from the TreeView.
                        CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                    }
                }

                // Add the new Quality to the character.
                _objCharacter.Qualities.Add(objNewQuality);
            }

            // If entry already exists in tree, just update the rating
            if (blnHasNewQualityAlready)
                RefreshQualityNames(treQualities);
            UpdateMentorSpirits();
            ScheduleCharacterUpdate();
            RefreshContacts();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private bool RemoveQuality(Quality objSelectedQuality, bool blnConfirmDelete = true, bool blnCompleteDelete = true)
        {
            XmlDocument objXmlDocument = XmlManager.Load("qualities.xml");
            XmlNode objXmlDeleteQuality = objXmlDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + objSelectedQuality.Name + "\"]");
            bool blnMetatypeQuality = false;

            // Qualities that come from a Metatype cannot be removed.
            if (objSelectedQuality.OriginSource == QualitySource.Metatype)
            {
                MessageBox.Show(LanguageManager.GetString("Message_MetavariantQuality"), LanguageManager.GetString("MessageTitle_MetavariantQuality"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return false;
            }
            else if (objSelectedQuality.OriginSource == QualitySource.Improvement)
            {
                MessageBox.Show(LanguageManager.GetString("Message_ImprovementQuality").Replace("{0}", objSelectedQuality.SourceName), LanguageManager.GetString("MessageTitle_MetavariantQuality"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return false;
            }
            else if (objSelectedQuality.OriginSource == QualitySource.MetatypeRemovable)
            {
                // Look up the cost of the Quality.
                int intBP = Convert.ToInt32(objXmlDeleteQuality["karma"].InnerText) * _objOptions.KarmaQuality;
                if (blnCompleteDelete)
                    intBP *= objSelectedQuality.Levels;
                if (!_objOptions.DontDoubleQualityRefunds)
                {
                    intBP *= -2;
                }
                string strBP = intBP.ToString() + " " + LanguageManager.GetString("String_Karma");

                if (blnConfirmDelete && !CommonFunctions.ConfirmDelete(_objCharacter, blnCompleteDelete ?
                                                                        LanguageManager.GetString("Message_DeleteMetatypeQuality").Replace("{0}", strBP) :
                                                                        LanguageManager.GetString("Message_LowerMetatypeQualityLevel").Replace("{0}", strBP)))
                    return false;

                blnMetatypeQuality = true;
            }

            if (objSelectedQuality.Type == QualityType.Positive)
            {
                if (objXmlDeleteQuality["refundkarmaonremove"] != null)
                {
                    int intKarmaCost = objSelectedQuality.BP * _objOptions.KarmaQuality;
                    if (!_objCharacter.Options.DontDoubleQualityPurchases && objSelectedQuality.DoubleCost)
                        intKarmaCost *= 2;

                    ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                    objEntry.Create(intKarmaCost, LanguageManager.GetString("String_ExpenseSwapPositiveQuality").Replace("{0}", objSelectedQuality.DisplayNameShort).Replace("{1}", LanguageManager.GetString("String_Karma")), ExpenseType.Karma, DateTime.Now, true);
                    _objCharacter.ExpenseEntries.Add(objEntry);
                    _objCharacter.Karma += intKarmaCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.RemoveQuality, objSelectedQuality.Name);
                    objUndo.Extra = objSelectedQuality.Extra;
                    objEntry.Undo = objUndo;
                }
                else if (!blnMetatypeQuality)
                {
                    if (blnConfirmDelete && !CommonFunctions.ConfirmDelete(_objCharacter, blnCompleteDelete ?
                                                                        LanguageManager.GetString("Message_DeletePositiveQualityCareer") :
                                                                        LanguageManager.GetString("Message_LowerPositiveQualityLevelCareer")))
                        return false;
                }

                if (objSelectedQuality.Name == "One Trick Pony")
                {
                    if (treMartialArts.Nodes[1].Nodes.Count > 0)
                    {
                        foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
                        {
                            if (objMartialArt.Name == "One Trick Pony")
                            {
                                _objCharacter.MartialArts.Remove(objMartialArt);
                                treMartialArts.Nodes[1].Nodes[0].Remove();
                                break;
                            }
                        }
                    }
                }
            }
            else
            {
                // Make sure the character has enough Karma to buy off the Quality.
                int intKarmaCost = (objSelectedQuality.BP * _objOptions.KarmaQuality);
                if (!_objOptions.DontDoubleQualityRefunds)
                {
                    intKarmaCost = intKarmaCost * -2;
                }
                int intTotalKarmaCost = intKarmaCost;
                if (blnCompleteDelete)
                    intTotalKarmaCost *= objSelectedQuality.Levels;
                if (intTotalKarmaCost > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return false;
                }

                if (!blnMetatypeQuality)
                {
                    if (blnConfirmDelete && !ConfirmKarmaExpense((blnCompleteDelete ? LanguageManager.GetString("Message_ConfirmKarmaExpenseRemove") :
                        LanguageManager.GetString("Message_ConfirmKarmaExpenseLowerLevel")).Replace("{0}", objSelectedQuality.DisplayNameShort).Replace("{1}", intTotalKarmaCost.ToString())))
                        return false;
                }

                // Create the Karma expense.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseRemoveNegativeQuality") + " " + objSelectedQuality.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaCost;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.RemoveQuality, objSelectedQuality.Name);
                objUndo.Extra = objSelectedQuality.Extra;
                objExpense.Undo = objUndo;
            }

            // Remove the Improvements that were created by the Quality.
            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objSelectedQuality.InternalId);

            switch (objSelectedQuality.Name)
            {
                case "Changeling (Class I SURGE)":
                case "Changeling (Class II SURGE)":
                case "Changeling (Class III SURGE)":
                    _objCharacter.MetageneticLimit = 0;
                    break;
                default:
                    break;
            }

            // Remove any Critter Powers that are gained through the Quality (Infected).
            if (objXmlDeleteQuality.SelectNodes("powers/power").Count > 0)
            {
                objXmlDocument = XmlManager.Load("critterpowers.xml");
                foreach (XmlNode objXmlPower in objXmlDeleteQuality.SelectNodes("optionalpowers/optionalpower"))
                {
                    string strExtra = string.Empty;
                    if (objXmlPower.Attributes["select"] != null)
                        strExtra = objXmlPower.Attributes["select"].InnerText;

                    foreach (CritterPower objPower in _objCharacter.CritterPowers)
                    {
                        if (objPower.Name == objXmlPower.InnerText && objPower.Extra == strExtra)
                        {
                            // Remove any Improvements created by the Critter Power.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.CritterPower, objPower.InternalId);

                            // Remove the Critter Power from the character.
                            _objCharacter.CritterPowers.Remove(objPower);

                            // Remove the Critter Power from the Tree.
                            foreach (TreeNode objNode in treCritterPowers.Nodes[0].Nodes)
                            {
                                if (objNode.Tag.ToString() == objPower.InternalId)
                                {
                                    objNode.Remove();
                                    break;
                                }
                            }
                            foreach (TreeNode objNode in treCritterPowers.Nodes[1].Nodes)
                            {
                                if (objNode.Tag.ToString() == objPower.InternalId)
                                {
                                    objNode.Remove();
                                    break;
                                }
                            }
                            break;
                        }
                    }
                }
            }

            // Remove any Weapons created by the Quality if applicable.
            if (objSelectedQuality.WeaponID != Guid.Empty.ToString())
            {
                List<string> lstNodesToRemoveIds = new List<string>();
                foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objSelectedQuality.InternalId))
                {
                    lstNodesToRemoveIds.Add(objWeapon.InternalId);
                    CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                    // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                    if (objWeapon.Parent != null)
                        objWeapon.Parent.Children.Remove(objWeapon);
                    else
                        _objCharacter.Weapons.Remove(objWeapon);
                }
                foreach (string strNodeId in lstNodesToRemoveIds)
                {
                    // Remove the Weapons from the TreeView.
                    CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                }
            }

            // Fix for legacy characters with old addqualities improvements.
            if (objXmlDeleteQuality?["addqualities"] != null)
            {
                RemoveAddedQualities(objXmlDeleteQuality.SelectNodes("addqualities/addquality"), treQualities);
            }

            _objCharacter.Qualities.Remove(objSelectedQuality);
            return true;
        }

        private void nudQualityLevel_UpdateValue(Quality objSelectedQuality)
        {
            nudQualityLevel.Enabled = false;
            if (objSelectedQuality == null || objSelectedQuality.OriginSource == QualitySource.Improvement || objSelectedQuality.OriginSource == QualitySource.Metatype)
            {
                nudQualityLevel.Value = 1;
                return;
            }
            XmlDocument objXmlDocument = XmlManager.Load("qualities.xml");
            XmlNode objQualityNode = objXmlDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + objSelectedQuality.Name + "\"]");
            string strLimitString = objQualityNode?["limit"]?.InnerText;
            int intMaxRating = 0;
            if (!string.IsNullOrWhiteSpace(strLimitString) && objQualityNode?["nolevels"] == null && Int32.TryParse(strLimitString, out intMaxRating))
            {
                nudQualityLevel.Maximum = intMaxRating;
                nudQualityLevel.Value = objSelectedQuality.Levels;
                nudQualityLevel.Enabled = true;
            }
            else
            {
                nudQualityLevel.Value = 1;
            }
        }

        private void nudQualityLevel_ValueChanged(object sender, EventArgs e)
        {
            if (nudQualityLevel.Enabled && treQualities.SelectedNode != null && treQualities.SelectedNode.Level > 0)
            {
                // Locate the selected Quality.
                Quality objSelectedQuality = CommonFunctions.FindByIdWithNameCheck(treQualities.SelectedNode.Tag.ToString(), _objCharacter.Qualities);
                int intCurrentLevels = objSelectedQuality.Levels;

                bool blnRequireUpdate = false;
                bool blnRequireTreQualitiesRebuild = false;
                // Adding a new level
                for (; nudQualityLevel.Value > intCurrentLevels; ++intCurrentLevels)
                {
                    XmlDocument objXmlDocument = XmlManager.Load("qualities.xml");
                    XmlNode objXmlSelectedQuality = objXmlDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + objSelectedQuality + "\"]");
                    if (!Backend.Shared_Methods.SelectionShared.RequirementsMet(objXmlSelectedQuality, true, _objCharacter, null, null, objXmlDocument))
                    {
                        nudQualityLevel_UpdateValue(objSelectedQuality);
                        break;
                    }

                    TreeNode objNode = new TreeNode();
                    List<Weapon> objWeapons = new List<Weapon>();
                    List<TreeNode> objWeaponNodes = new List<TreeNode>();
                    Quality objQuality = new Quality(_objCharacter);

                    objQuality.Create(objXmlSelectedQuality, _objCharacter, QualitySource.Selected, objNode, objWeapons, objWeaponNodes, objSelectedQuality.Extra);
                    if (objQuality.InternalId == Guid.Empty.ToString())
                    {
                        // If the Quality could not be added, remove the Improvements that were added during the Quality Creation process.
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
                        nudQualityLevel_UpdateValue(objSelectedQuality);
                        break;
                    }
                    objNode.ContextMenuStrip = cmsQuality;

                    objQuality.BP = objSelectedQuality.BP;
                    objQuality.ContributeToLimit = objSelectedQuality.ContributeToLimit;

                    bool blnAddItem = false;
                    int intKarmaCost = objQuality.BP * _objOptions.KarmaQuality;
                    if (!_objCharacter.Options.DontDoubleQualityPurchases && objQuality.DoubleCost)
                        intKarmaCost *= 2;

                    // Make sure the character has enough Karma to pay for the Quality.
                    if (objQuality.Type == QualityType.Positive)
                    {
                        if (intKarmaCost > _objCharacter.Karma)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                        else if (objQuality.ContributeToBP && (objQuality.BP == 0 || ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", objQuality.DisplayNameShort).Replace("{1}", intKarmaCost.ToString()))))
                        {
                            // Create the Karma expense.
                            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                            objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseAddPositiveQuality") + " " + objQuality.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                            _objCharacter.ExpenseEntries.Add(objExpense);
                            _objCharacter.Karma -= intKarmaCost;

                            ExpenseUndo objUndo = new ExpenseUndo();
                            objUndo.CreateKarma(KarmaExpenseType.AddQuality, objQuality.InternalId);
                            objExpense.Undo = objUndo;
                            blnAddItem = true;
                        }
                    }
                    else
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_AddNegativeQuality"), LanguageManager.GetString("MessageTitle_AddNegativeQuality"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                        {
                            // Create a Karma Expense for the Negative Quality.
                            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                            objExpense.Create(0, LanguageManager.GetString("String_ExpenseAddNegativeQuality") + " " + objQuality.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                            _objCharacter.ExpenseEntries.Add(objExpense);

                            ExpenseUndo objUndo = new ExpenseUndo();
                            objUndo.CreateKarma(KarmaExpenseType.AddQuality, objQuality.InternalId);
                            objExpense.Undo = objUndo;
                            blnAddItem = true;
                        }
                    }

                    if (blnAddItem)
                    {
                        blnRequireUpdate = true;
                        // Add the Quality to the appropriate parent node.
                        _objCharacter.Qualities.Add(objQuality);

                        // Add any created Weapons to the character.
                        foreach (Weapon objWeapon in objWeapons)
                        {
                            _objCharacter.Weapons.Add(objWeapon);
                        }

                        // Create the Weapon Node if one exists.
                        foreach (TreeNode objWeaponNode in objWeaponNodes)
                        {
                            objWeaponNode.ContextMenuStrip = cmsWeapon;
                            treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                            treWeapons.Nodes[0].Expand();
                        }
                    }
                    else
                    {
                        // Remove the Improvements created by the Create method.
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
                        nudQualityLevel_UpdateValue(objSelectedQuality);
                        break;
                    }
                }
                // Removing a level
                for (; nudQualityLevel.Value < intCurrentLevels; --intCurrentLevels)
                {
                    Quality objInvisibleQuality = _objCharacter.Qualities.FirstOrDefault(x => x.QualityId == objSelectedQuality.QualityId && x.Extra == objSelectedQuality.Extra && x.SourceName == objSelectedQuality.SourceName && x.InternalId != objSelectedQuality.InternalId);
                    if (objInvisibleQuality != null && RemoveQuality(objInvisibleQuality, false, false))
                    {
                        blnRequireUpdate = true;
                    }
                    else if (RemoveQuality(objSelectedQuality, false, false))
                    {
                        blnRequireUpdate = true;
                        blnRequireTreQualitiesRebuild = true;
                        break;
                    }
                    else
                    {
                        nudQualityLevel_UpdateValue(objSelectedQuality);
                        break;
                    }
                }

                if (blnRequireUpdate)
                {
                    if (blnRequireTreQualitiesRebuild)
                        RefreshQualities(treQualities, cmsQuality, true);
                    else
                        RefreshQualityNames(treQualities);
                    UpdateMentorSpirits();
                    ScheduleCharacterUpdate();
                    RefreshMartialArts();
                    RefreshAIPrograms();
                    RefreshLimitModifiers();
                    RefreshSpells(treSpells, cmsSpell, _objCharacter);
                    PopulateGearList();
                    RefreshCritterPowers(treCritterPowers, cmsCritterPowers);
                    RefreshContacts();
                    RefreshSelectedCyberware();
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdAddLocation_Click(object sender, EventArgs e)
        {
            // Add a new location to the Gear Tree.
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel || string.IsNullOrEmpty(frmPickText.SelectedValue))
                return;

            string strLocation = frmPickText.SelectedValue;
            _objCharacter.Locations.Add(strLocation);

            TreeNode objLocation = new TreeNode();
            objLocation.Tag = strLocation;
            objLocation.Text = strLocation;
            objLocation.ContextMenuStrip = cmsGearLocation;
            treGear.Nodes.Add(objLocation);
            UpdateWindowTitle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddWeaponLocation_Click(object sender, EventArgs e)
        {
            // Add a new location to the Gear Tree.
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel || string.IsNullOrEmpty(frmPickText.SelectedValue))
                return;

            string strLocation = frmPickText.SelectedValue;
            _objCharacter.WeaponLocations.Add(strLocation);

            TreeNode objLocation = new TreeNode();
            objLocation.Tag = strLocation;
            objLocation.Text = strLocation;
            objLocation.ContextMenuStrip = cmsWeaponLocation;
            treWeapons.Nodes.Add(objLocation);
            UpdateWindowTitle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddWeek_Click(object sender, EventArgs e)
        {
            CalendarWeek objWeek = new CalendarWeek();
            if (_objCharacter.Calendar != null && _objCharacter.Calendar.LastOrDefault() != null)
            {
                objWeek.Year = _objCharacter.Calendar.Last().Year;
                objWeek.Week = _objCharacter.Calendar.Last().Week;
                objWeek.Week++;
                if (objWeek.Week > 52)
                {
                    objWeek.Week = 1;
                    objWeek.Year++;
                }
            }
            else
            {
                objWeek = new CalendarWeek();
                frmSelectCalendarStart frmPickStart = new frmSelectCalendarStart();
                frmPickStart.ShowDialog(this);

                if (frmPickStart.DialogResult == DialogResult.Cancel)
                    return;

                objWeek.Year = frmPickStart.SelectedYear;
                objWeek.Week = frmPickStart.SelectedWeek;
            }

            _objCharacter.Calendar.Add(objWeek);

            PopulateCalendar();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }


        private void cmdDeleteWeek_Click(object sender, EventArgs e)
        {
            ListViewItem objItem = null;
            if (lstCalendar != null && lstCalendar.SelectedItems.Count > 0)
            {
                objItem = lstCalendar.SelectedItems[0];
            }
            else
            {
                return;
            }

            CalendarWeek objWeek = new CalendarWeek();

            // Find the selected Calendar Week.
            foreach (CalendarWeek objCharacterWeek in _objCharacter.Calendar)
            {
                if (objCharacterWeek.InternalId == objItem.SubItems[2].Text)
                {
                    objWeek = objCharacterWeek;
                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteCalendarWeek")))
                        return;
                    _objCharacter.Calendar.Remove(objWeek);
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                    PopulateCalendar();
                    break;
                }
            }
        }

        private void cmdEditWeek_Click(object sender, EventArgs e)
        {
            ListViewItem objItem = null;
            if (lstCalendar != null && lstCalendar.SelectedItems.Count > 0)
            {
                objItem = lstCalendar.SelectedItems[0];
            }
            else
            {
                return;
            }

            CalendarWeek objWeek = new CalendarWeek();

            // Find the selected Calendar Week.
            foreach (CalendarWeek objCharacterWeek in _objCharacter.Calendar)
            {
                if (objCharacterWeek.InternalId == objItem.SubItems[2].Text)
                {
                    objWeek = objCharacterWeek;
                    break;
                }
            }

            frmNotes frmItemNotes = new frmNotes();
            frmItemNotes.Notes = objWeek.Notes;
            string strOldValue = objWeek.Notes;
            frmItemNotes.ShowDialog(this);

            if (frmItemNotes.DialogResult == DialogResult.OK)
            {
                objWeek.Notes = frmItemNotes.Notes;
                if (objWeek.Notes != strOldValue)
                {
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                    PopulateCalendar();
                }
            }
        }

        private void cmdChangeStartWeek_Click(object sender, EventArgs e)
        {
            // Find the first date.
            CalendarWeek objStart;
            if (_objCharacter.Calendar != null && _objCharacter.Calendar.FirstOrDefault() != null)
            {
                 objStart = _objCharacter.Calendar.First();
            }
            else
            {
                return;
            }

            frmSelectCalendarStart frmPickStart = new frmSelectCalendarStart(objStart);
            frmPickStart.ShowDialog(this);

            if (frmPickStart.DialogResult == DialogResult.Cancel)
                return;

            // Determine the difference between the starting value and selected values for year and week.
            int intYear = frmPickStart.SelectedYear;
            int intWeek = frmPickStart.SelectedWeek;
            int intYearDiff = intYear - objStart.Year;
            int intWeekDiff = intWeek - objStart.Week;

            // Update each of the CalendarWeek entries for the character.
            foreach (CalendarWeek objWeek in _objCharacter.Calendar)
            {
                objWeek.Week += intWeekDiff;
                objWeek.Year += intYearDiff;

                // If the date range goes outside of 52 weeks, increase or decrease the year as necessary.
                if (objWeek.Week < 1)
                {
                    objWeek.Year--;
                    objWeek.Week += 52;
                }
                if (objWeek.Week > 52)
                {
                    objWeek.Year++;
                    objWeek.Week -= 52;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
            PopulateCalendar();
        }

        private void cmdAddImprovement_Click(object sender, EventArgs e)
        {
            frmCreateImprovement frmPickImprovement = new frmCreateImprovement(_objCharacter);
            frmPickImprovement.ShowDialog(this);
            
            if (frmPickImprovement.DialogResult == DialogResult.Cancel)
                return;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdCreateStackedFocus_Click(object sender, EventArgs e)
        {
            int intFree = 0;
            List<Gear> lstGear = new List<Gear>();
            List<Gear> lstStack = new List<Gear>();

            // Run through all of the Foci the character has and count the un-Bonded ones.
            foreach (Gear objGear in _objCharacter.Gear)
            {
                if (objGear.Category == "Foci" || objGear.Category == "Metamagic Foci")
                {
                    if (!objGear.Bonded)
                    {
                        intFree++;
                        lstGear.Add(objGear);
                    }
                }
            }

            // If the character does not have at least 2 un-Bonded Foci, display an error and leave.
            if (intFree < 2)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotStackFoci"), LanguageManager.GetString("MessageTitle_CannotStackFoci"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectItem frmPickItem = new frmSelectItem();

            // Let the character select the Foci they'd like to stack, stopping when they either click Cancel or there are no more items left in the list.
            do
            {
                frmPickItem.Gear = lstGear;
                frmPickItem.AllowAutoSelect = false;
                frmPickItem.Description = LanguageManager.GetString("String_SelectItemFocus");
                frmPickItem.ShowDialog(this);

                if (frmPickItem.DialogResult == DialogResult.OK)
                {
                    // Move the item from the Gear list to the Stack list.
                    foreach (Gear objGear in lstGear)
                    {
                        if (objGear.InternalId == frmPickItem.SelectedItem)
                        {
                            objGear.Bonded = true;
                            lstStack.Add(objGear);
                            lstGear.Remove(objGear);
                            break;
                        }
                    }
                }
            } while (lstGear.Count > 0 && frmPickItem.DialogResult != DialogResult.Cancel);

            // Make sure at least 2 Foci were selected.
            if (lstStack.Count < 2)
            {
                MessageBox.Show(LanguageManager.GetString("Message_StackedFocusMinimum"), LanguageManager.GetString("MessageTitle_CannotStackFoci"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Make sure the combined Force of the Foci do not exceed 6.
            if (!_objOptions.AllowHigherStackedFoci)
            {
                int intCombined = 0;
                foreach (Gear objGear in lstStack)
                    intCombined += objGear.Rating;
                if (intCombined > 6)
                {
                    foreach (Gear objGear in lstStack)
                        objGear.Bonded = false;
                    MessageBox.Show(LanguageManager.GetString("Message_StackedFocusForce"), LanguageManager.GetString("MessageTitle_CannotStackFoci"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
            }

            // Create the Stacked Focus.
            StackedFocus objStack = new StackedFocus(_objCharacter);
            objStack.Gear = lstStack;
            _objCharacter.StackedFoci.Add(objStack);

            // Remove the Gear from the character and replace it with a Stacked Focus item.
            decimal decCost = 0.0m;
            foreach (Gear objGear in lstStack)
            {
                decCost += objGear.TotalCost;
                _objCharacter.Gear.Remove(objGear);

                // Remove the TreeNode from Gear.
                foreach (TreeNode nodRoot in treGear.Nodes)
                {
                    foreach (TreeNode nodItem in nodRoot.Nodes)
                    {
                        if (nodItem.Tag.ToString() == objGear.InternalId)
                        {
                            nodRoot.Nodes.Remove(nodItem);
                            break;
                        }
                    }
                }
            }

            Gear objStackItem = new Gear(_objCharacter);
            objStackItem.Category = "Stacked Focus";
            objStackItem.Name = "Stacked Focus: " + objStack.Name;
            objStackItem.MinRating = 0;
            objStackItem.MaxRating = 0;
            objStackItem.Source = "SM";
            objStackItem.Page = "84";
            objStackItem.Cost = decCost.ToString(GlobalOptions.CultureInfo);
            objStackItem.Avail = "0";

            TreeNode nodStackNode = new TreeNode();
            nodStackNode.Text = objStackItem.DisplayNameShort;
            nodStackNode.Tag = objStackItem.InternalId;

            treGear.Nodes[0].Nodes.Add(nodStackNode);

            _objCharacter.Gear.Add(objStackItem);

            objStack.GearId = objStackItem.InternalId;

            _blnIsDirty = true;
            CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        private void cmdBurnStreetCred_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show(LanguageManager.GetString("Message_BurnStreetCred"), LanguageManager.GetString("MessageTitle_BurnStreetCred"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                return;

            _objCharacter.BurntStreetCred += 2;
            
            _blnIsDirty = true;
            UpdateWindowTitle();
            UpdateReputation();
        }

        private void cmdEditImprovement_Click(object sender, EventArgs e)
        {
            treImprovements_DoubleClick(sender, e);
        }

        private void cmdDeleteImprovement_Click(object sender, EventArgs e)
        {
            if (treImprovements.SelectedNode != null)
            {
                if (treImprovements.SelectedNode.Level == 0)
                {
                    if (treImprovements.SelectedNode.Text == LanguageManager.GetString("Node_SelectedImprovements"))
                        return;

                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteImprovementGroup")))
                        return;

                    // Move all of the child nodes in the current parent to the Selected Improvements parent node.
                    foreach (TreeNode objNode in treImprovements.SelectedNode.Nodes)
                    {
                        Improvement objImprovement = null;
                        foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                        {
                            if (objCharacterImprovement.CustomGroup == treImprovements.SelectedNode.Text)
                            {
                                objImprovement = objCharacterImprovement;
                                break;
                            }
                        }

                        // Change the Location for the Armor.
                        objImprovement.CustomGroup = string.Empty;

                        TreeNode nodNewNode = new TreeNode();
                        nodNewNode.Text = objNode.Text;
                        nodNewNode.Tag = objNode.Tag;

                        treImprovements.Nodes[0].Nodes.Add(nodNewNode);
                        treImprovements.Nodes[0].Expand();
                    }

                    // Remove the Group from the character, then remove the selected node.
                    _objCharacter.ImprovementGroups.Remove(treImprovements.SelectedNode.Text);
                    treImprovements.SelectedNode.Remove();
                    return;
                }
                if (treImprovements.SelectedNode.Level > 0)
                {
                    Improvement objImprovement = null;
                    foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                    {
                        if (objCharacterImprovement.SourceName == treImprovements.SelectedNode.Tag.ToString())
                        {
                            objImprovement = objCharacterImprovement;
                            break;
                        }
                    }

                    if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteImprovement")))
                        return;

                    // Remove the Improvement from the character.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Custom, objImprovement.SourceName);
                    ScheduleCharacterUpdate();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdAddArmorBundle_Click(object sender, EventArgs e)
        {
            // Add a new location to the Armor Tree.
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel || string.IsNullOrEmpty(frmPickText.SelectedValue))
                return;

            string strLocation = frmPickText.SelectedValue;
            _objCharacter.ArmorBundles.Add(strLocation);

            TreeNode objLocation = new TreeNode();
            objLocation.Tag = strLocation;
            objLocation.Text = strLocation;
            objLocation.ContextMenuStrip = cmsArmorLocation;
            treArmor.Nodes.Add(objLocation);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdArmorEquipAll_Click(object sender, EventArgs e)
        {
            // Equip all of the Armor in the Armor Bundle.
            foreach (Armor objArmor in _objCharacter.Armor)
            {
                if (objArmor.Location == treArmor.SelectedNode.Tag.ToString() || (treArmor.SelectedNode == treArmor.Nodes[0] && string.IsNullOrEmpty(objArmor.Location)))
                {
                    objArmor.Equipped = true;
                    // Add the Armor's Improevments to the character.
                    if (objArmor.Bonus != null)
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId, objArmor.Bonus, false, 1, objArmor.DisplayNameShort);
                    if (objArmor.WirelessOn && objArmor.WirelessBonus != null)
                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId, objArmor.WirelessBonus, false, 1, objArmor.DisplayNameShort);
                    // Add the Improvements from any Armor Mods in the Armor.
                    foreach (ArmorMod objMod in objArmor.ArmorMods)
                    {
                        if (objMod.Equipped)
                        {
                            if (objMod.Bonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.Bonus, false, objMod.Rating, objMod.DisplayNameShort);
                            if (objMod.WirelessOn && objMod.WirelessBonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.WirelessBonus, false, objMod.Rating, objMod.DisplayNameShort);
                            // Add the Improvements from any Gear in the Armor.
                            foreach (Gear objGear in objMod.Gear)
                            {
                                if (objGear.Equipped)
                                {
                                    if (objGear.Bonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort);
                                    if (objGear.WirelessOn && objGear.WirelessBonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort);
                                }
                            }
                        }
                    }
                    // Add the Improvements from any Gear in the Armor.
                    foreach (Gear objGear in objArmor.Gear)
                    {
                        if (objGear.Equipped)
                        {
                            if (objGear.Bonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort);
                            if (objGear.WirelessOn && objGear.WirelessBonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort);
                        }
                    }
                }
            }
            RefreshSelectedArmor();

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        private void cmdArmorUnEquipAll_Click(object sender, EventArgs e)
        {
            // Un-equip all of the Armor in the Armor Bundle.
            foreach (Armor objArmor in _objCharacter.Armor)
            {
                if (objArmor.Location == treArmor.SelectedNode.Tag.ToString() || (treArmor.SelectedNode == treArmor.Nodes[0] && string.IsNullOrEmpty(objArmor.Location)))
                {
                    objArmor.Equipped = false;
                    // Remove any Improvements the Armor created.
                    if (objArmor.Bonus != null || (objArmor.WirelessOn && objArmor.WirelessBonus != null))
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId);
                    // Remove any Improvements from any Armor Mods in the Armor.
                    foreach (ArmorMod objMod in objArmor.ArmorMods)
                    {
                        if (objMod.Bonus != null || (objMod.WirelessOn && objMod.WirelessBonus != null))
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId);
                        // Remove any Improvements from any Gear in the Armor.
                        foreach (Gear objGear in objMod.Gear)
                        {
                            if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                        }
                    }
                    // Remove any Improvements from any Gear in the Armor.
                    foreach (Gear objGear in objArmor.Gear)
                    {
                        if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                    }
                }
            }
            RefreshSelectedArmor();

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        private void cmdImprovementsEnableAll_Click(object sender, EventArgs e)
        {
            // Enable all of the Improvements in the Improvement Group.
            if (treImprovements.SelectedNode != null && treImprovements.Nodes.Count > 0)
            {
                bool blnSelectedTop = treImprovements.SelectedNode == treImprovements.Nodes[0];
                List<Improvement> lstImprovementsEnabled = new List<Improvement>();
                foreach (Improvement objImprovement in _objCharacter.Improvements)
                {
                    if (objImprovement.CustomGroup == treImprovements.SelectedNode.Tag.ToString() || (blnSelectedTop && string.IsNullOrEmpty(objImprovement.CustomGroup)))
                    {
                        objImprovement.Enabled = true;
                        lstImprovementsEnabled.Add(objImprovement);
                    }
                }
                if (lstImprovementsEnabled.Count > 0)
                {
                    _objCharacter.ImprovementHook(lstImprovementsEnabled);

                    _blnIsDirty = true;
                    ScheduleCharacterUpdate();
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdImprovementsDisableAll_Click(object sender, EventArgs e)
        {
            // Disable all of the Improvements in the Improvement Group.
            if (treImprovements.SelectedNode != null && treImprovements.Nodes.Count > 0)
            {
                bool blnSelectedTop = treImprovements.SelectedNode == treImprovements.Nodes[0];
                List<Improvement> lstImprovementsDisabled = new List<Improvement>();
                foreach (Improvement objImprovement in _objCharacter.Improvements)
                {
                    if (objImprovement.CustomGroup == treImprovements.SelectedNode.Tag.ToString() || (blnSelectedTop && string.IsNullOrEmpty(objImprovement.CustomGroup)))
                    {
                        objImprovement.Enabled = false;
                        lstImprovementsDisabled.Add(objImprovement);
                    }
                }
                if (lstImprovementsDisabled.Count > 0)
                {
                    _objCharacter.ImprovementHook(lstImprovementsDisabled);

                    _blnIsDirty = true;
                    ScheduleCharacterUpdate();
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdRollSpell_Click(object sender, EventArgs e)
        {
            int intDice = 0;
            int.TryParse(lblSpellDicePool.Text, out intDice);
            DiceRollerOpenedInt(_objCharacter, intDice);
        }

        private void cmdRollDrain_Click(object sender, EventArgs e)
        {
            int intDice = 0;
            int.TryParse(lblDrainAttributesValue.Text, out intDice);
            DiceRollerOpenedInt(_objCharacter, intDice);
        }

        private void cmdRollFading_Click(object sender, EventArgs e)
        {
            int intDice = 0;
            int.TryParse(lblFadingAttributesValue.Text, out intDice);
            DiceRollerOpenedInt(_objCharacter, intDice);
        }

        private void cmdRollWeapon_Click(object sender, EventArgs e)
        {
            int intDice = 0;
            int.TryParse(lblWeaponDicePool.Text, out intDice);
            DiceRollerOpenedInt(_objCharacter, intDice);
        }

        private void cmdRollVehicleWeapon_Click(object sender, EventArgs e)
        {
            int intDice = 0;
            int.TryParse(lblVehicleWeaponDicePool.Text, out intDice);
            DiceRollerOpenedInt(_objCharacter, intDice);
        }

        private void cmdAddVehicleLocation_Click(object sender, EventArgs e)
        {
            // Make sure a Vehicle is selected.
            Vehicle objVehicle = null;
            if (treVehicles.SelectedNode != null)
            {
                if (treVehicles.SelectedNode.Level == 1)
                {
                    objVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                }
                if (objVehicle == null)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_SelectVehicleLocation"), LanguageManager.GetString("MessageTitle_SelectVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
            }
            else
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectVehicleLocation"), LanguageManager.GetString("MessageTitle_SelectVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Add a new location to the selected Vehicle.
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel || string.IsNullOrEmpty(frmPickText.SelectedValue))
                return;

            string strLocation = frmPickText.SelectedValue;
            objVehicle.Locations.Add(strLocation);

            TreeNode objLocation = new TreeNode();
            objLocation.Tag = strLocation;
            objLocation.Text = strLocation;
            objLocation.ContextMenuStrip = cmsVehicleLocation;
            treVehicles.SelectedNode.Nodes.Add(objLocation);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdAddPet_Click(object sender, EventArgs e)
        {
            Contact objContact = new Contact(_objCharacter);
            objContact.EntityType = ContactType.Pet;
            _objCharacter.Contacts.Add(objContact);

            PetControl objContactControl = new PetControl();
            objContactControl.ContactObject = objContact;

            // Attach an EventHandler for the DeleteContact and FileNameChanged Events.
            objContactControl.DeleteContact += objPet_DeleteContact;
            objContactControl.FileNameChanged += objPet_FileNameChanged;

            // Add the control to the Panel.
            panPets.Controls.Add(objContactControl);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdQuickenSpell_Click(object sender, EventArgs e)
        {
            if (treSpells.SelectedNode == null || treSpells.SelectedNode.Level != 1)
                return;

            frmSelectNumber frmPickNumber = new frmSelectNumber(0);
            frmPickNumber.Description = LanguageManager.GetString("String_QuickeningKarma").Replace("{0}", treSpells.SelectedNode.Text);
            frmPickNumber.Minimum = 1;
            frmPickNumber.ShowDialog(this);

            if (frmPickNumber.DialogResult == DialogResult.Cancel)
                return;

            // Make sure the character has enough Karma to improve the CharacterAttribute.
            int intKarmaCost = decimal.ToInt32(frmPickNumber.SelectedValue);
            if (intKarmaCost > _objCharacter.Karma)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseQuickeningMetamagic").Replace("{0}", intKarmaCost.ToString()).Replace("{1}", treSpells.SelectedNode.Text)))
                return;

            // Create the Karma expense.
            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_ExpenseQuickenMetamagic") + " " + treSpells.SelectedNode.Text, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Karma -= intKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.QuickeningMetamagic, string.Empty);
            objExpense.Undo = objUndo;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region ContextMenu Events
        private void ContextMenu_Opening(object sender, CancelEventArgs e)
        {
            foreach (ToolStripItem objItem in ((ContextMenuStrip)sender).Items)
            {
                if (objItem.Tag != null)
                    objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
            }
        }

        private void InitiationContextMenu_Opening(object sender, CancelEventArgs e)
        {
            foreach (ToolStripItem objItem in ((ContextMenuStrip)sender).Items)
            {
                if (objItem.Tag != null)
                    objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
            }

            // Enable and disable menu items
            if (treMetamagic.SelectedNode.Level == 0)
            {
                bool blnHasArt = false;
                bool blnHasBonus = false;
                int intGrade = 0;
                foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                {
                    if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                    {
                        intGrade = objGrade.Grade;
                        break;
                    }
                }
                foreach (Art objGradeArt in _objCharacter.Arts)
                {
                    if (objGradeArt.Grade == intGrade)
                    {
                        blnHasArt = true;
                        break;
                    }
                }
                foreach (Metamagic objGradeMetamagic in _objCharacter.Metamagics)
                {
                    if (objGradeMetamagic.Grade == intGrade)
                    {
                        blnHasBonus = true;
                        break;
                    }
                }
                foreach (Spell objGradeSpell in _objCharacter.Spells)
                {
                    if (objGradeSpell.Grade == intGrade)
                    {
                        blnHasBonus = true;
                        break;
                    }
                }
                if (blnHasArt)
                    tsMetamagicAddArt.Enabled = false;
                else
                    tsMetamagicAddArt.Enabled = true;
                if (blnHasBonus)
                    tsMetamagicAddMetamagic.Enabled = false;
                else
                    tsMetamagicAddMetamagic.Enabled = true;
            }

        }

        private void ContextMenu_DropDownOpening(object sender, EventArgs e)
        {
            foreach (ToolStripItem objItem in ((ToolStripDropDownItem)sender).DropDownItems)
            {
                if (objItem.Tag != null)
                    objItem.Text = LanguageManager.GetString(objItem.Tag.ToString());
            }
        }

        private void tsCyberwareAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Cyberware window.
            if (treCyberware.SelectedNode == null || treCyberware.SelectedNode.Level == 0 || (treCyberware.Nodes.Count > 1 && treCyberware.SelectedNode.Parent == treCyberware.Nodes[1]))
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectCyberware"), LanguageManager.GetString("MessageTitle_SelectCyberware"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            
            if (PickCyberware())
            {
                treCyberware.SelectedNode = treCyberware.SelectedNode.Parent;
                tsCyberwareAddAsPlugin_Click(sender, e);
            }
        }

        private void tsWeaponAddAccessory_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected, then open the Select Accessory window.
            if (treWeapons.SelectedNode == null || treWeapons.SelectedNode.Level <= 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectWeaponAccessory"), LanguageManager.GetString("MessageTitle_SelectWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Locate the Weapon that is selected in the Tree.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            // Accessories cannot be added to Cyberweapons.
            if (objWeapon.Cyberware)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CyberweaponNoAccessory"), LanguageManager.GetString("MessageTitle_CyberweaponNoAccessory"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Make sure the Weapon allows Accessories to be added to it.
            if (!objWeapon.AllowAccessory)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotModifyWeapon"), LanguageManager.GetString("MessageTitle_CannotModifyWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Open the Weapons XML file and locate the selected Weapon.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");

            XmlNode objXmlWeapon = objWeapon.MyXmlNode;
            if (objXmlWeapon == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotFindWeapon"), LanguageManager.GetString("MessageTitle_CannotModifyWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectWeaponAccessory frmPickWeaponAccessory = new frmSelectWeaponAccessory(_objCharacter, true);

            XmlNodeList objXmlMountList = objXmlWeapon.SelectNodes("accessorymounts/mount");
            string strMounts = string.Empty;
            foreach (XmlNode objXmlMount in objXmlMountList)
            {
                bool blnFound = false;
                foreach (WeaponAccessory objMod in objWeapon.WeaponAccessories)
                {
                    if ((objMod.Mount == objXmlMount.InnerText) || (objMod.ExtraMount == objXmlMount.InnerText))
                    {
                        blnFound = true;
                        break;
                    }
                }
                if (!blnFound)
                {
                    strMounts += objXmlMount.InnerText + "/";
                }
            }

            // Remove the trailing /
            if (!string.IsNullOrEmpty(strMounts) && strMounts.Contains('/'))
                strMounts = strMounts.Substring(0, strMounts.Length - 1);

            frmPickWeaponAccessory.AllowedMounts = strMounts;

            frmPickWeaponAccessory.CurrentWeaponName = objWeapon.Name;
            frmPickWeaponAccessory.WeaponCost = objWeapon.Cost;
            frmPickWeaponAccessory.AccessoryMultiplier = objWeapon.AccessoryMultiplier;
            frmPickWeaponAccessory.InstalledAccessories = objWeapon.WeaponAccessories;
            frmPickWeaponAccessory.ShowDialog();

            if (frmPickWeaponAccessory.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected piece.
            objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/accessories/accessory[name = \"" + frmPickWeaponAccessory.SelectedAccessory + "\"]");

            TreeNode objNode = new TreeNode();
            WeaponAccessory objAccessory = new WeaponAccessory(_objCharacter);
            objAccessory.Create(objXmlWeapon, objNode, frmPickWeaponAccessory.SelectedMount, Convert.ToInt32(frmPickWeaponAccessory.SelectedRating), cmsWeaponAccessoryGear);
            objAccessory.Parent = objWeapon;

            if (objAccessory.Cost.StartsWith("Variable"))
            {
                decimal decMin = 0;
                decimal decMax = decimal.MaxValue;
                string strCost = objAccessory.Cost.TrimStart("Variable", true).Trim("()".ToCharArray());
                if (strCost.Contains('-'))
                {
                    string[] strValues = strCost.Split('-');
                    decMin = Convert.ToDecimal(strValues[0], GlobalOptions.InvariantCultureInfo);
                    decMax = Convert.ToDecimal(strValues[1], GlobalOptions.InvariantCultureInfo);
                }
                else
                    decMin = Convert.ToDecimal(strCost.FastEscape('+'), GlobalOptions.InvariantCultureInfo);

                if (decMin != 0 || decMax != decimal.MaxValue)
                {
                    string strNuyenFormat = _objCharacter.Options.NuyenFormat;
                    int intDecimalPlaces = strNuyenFormat.IndexOf('.');
                    if (intDecimalPlaces == -1)
                        intDecimalPlaces = 0;
                    else
                        intDecimalPlaces = strNuyenFormat.Length - intDecimalPlaces - 1;
                    frmSelectNumber frmPickNumber = new frmSelectNumber(intDecimalPlaces);
                    if (decMax > 1000000)
                        decMax = 1000000;
                    frmPickNumber.Minimum = decMin;
                    frmPickNumber.Maximum = decMax;
                    frmPickNumber.Description = LanguageManager.GetString("String_SelectVariableCost").Replace("{0}", objAccessory.DisplayNameShort);
                    frmPickNumber.AllowCancel = false;
                    frmPickNumber.ShowDialog();
                    objAccessory.Cost = frmPickNumber.SelectedValue.ToString();
                }
            }

            // Check the item's Cost and make sure the character can afford it.
            decimal decOriginalCost = objWeapon.TotalCost;
            objWeapon.WeaponAccessories.Add(objAccessory);

            decimal decCost = objWeapon.TotalCost - decOriginalCost;
            // Apply a markup if applicable.
            if (frmPickWeaponAccessory.Markup != 0)
            {
                decCost *= 1 + (frmPickWeaponAccessory.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            if (!frmPickWeaponAccessory.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    objWeapon.WeaponAccessories.Remove(objAccessory);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeaponAccessory.AddAgain)
                        tsWeaponAddAccessory_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeaponAccessory") + " " + objAccessory.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeaponAccessory, objAccessory.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            objNode.ContextMenuStrip = cmsWeaponAccessory;
            treWeapons.SelectedNode.Nodes.Add(objNode);
            treWeapons.SelectedNode.Expand();

            ScheduleCharacterUpdate();
            RefreshSelectedWeapon();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickWeaponAccessory.AddAgain)
                tsWeaponAddAccessory_Click(sender, e);
        }

        private void tsArmorLocationAddArmor_Click(object sender, EventArgs e)
        {
            frmSelectArmor frmPickArmor = new frmSelectArmor(_objCharacter, true);
            frmPickArmor.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickArmor.DialogResult == DialogResult.Cancel)
                return;

            // Open the Armor XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("armor.xml");

            XmlNode objXmlArmor = objXmlDocument.SelectSingleNode("/chummer/armors/armor[name = \"" + frmPickArmor.SelectedArmor + "\"]");

            TreeNode objNode = new TreeNode();
            Armor objArmor = new Armor(_objCharacter);
            List<Weapon> objWeapons = new List<Weapon>();
            objArmor.Create(objXmlArmor, objNode, cmsArmorMod, cmsArmorGear, frmPickArmor.Rating, objWeapons);
            objArmor.DiscountCost = frmPickArmor.BlackMarketDiscount;

            if (objArmor.InternalId == Guid.Empty.ToString())
                return;

            decimal decCost = objArmor.TotalCost;
            // Apply a markup if applicable.
            if (frmPickArmor.Markup != 0)
            {
                decCost *= 1 + (frmPickArmor.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objArmor.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objArmor.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickArmor.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove the Improvements created by the Armor.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId);
                    if (frmPickArmor.AddAgain)
                        cmdAddArmor_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseArmor") + " " + objArmor.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddArmor, objArmor.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            _objCharacter.Armor.Add(objArmor);

            objNode.ContextMenuStrip = cmsArmor;
            treArmor.SelectedNode.Nodes.Add(objNode);
            treArmor.SelectedNode.Expand();
            treArmor.SelectedNode = objNode;

            foreach (Weapon objWeapon in objWeapons)
            {
                _objCharacter.Weapons.Add(objWeapon);
                CommonFunctions.CreateWeaponTreeNode(objWeapon, treWeapons.Nodes[0], cmsWeapon, cmsWeaponAccessory, cmsWeaponAccessoryGear, objArmor.WeaponID);
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickArmor.AddAgain)
                cmdAddArmor_Click(sender, e);
        }

        private void tsAddArmorMod_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected, then open the Select Accessory window.
            if (treArmor.SelectedNode == null || treArmor.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectArmor"), LanguageManager.GetString("MessageTitle_SelectArmor"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treArmor.SelectedNode.Level > 1)
                treArmor.SelectedNode = treArmor.SelectedNode.Parent;

            // Locate the Armor that is selected in the tree.
            Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

            // Open the Armor XML file and locate the selected Armor.
            XmlDocument objXmlDocument = XmlManager.Load("armor.xml");

            XmlNode objXmlArmor = objXmlDocument.SelectSingleNode("/chummer/armors/armor[name = \"" + objArmor.Name + "\"]");

            frmSelectArmorMod frmPickArmorMod = new frmSelectArmorMod(_objCharacter, true);
            frmPickArmorMod.ArmorCost = objArmor.Cost;
            frmPickArmorMod.AllowedCategories = objArmor.Category + "," + objArmor.Name;
            frmPickArmorMod.CapacityDisplayStyle = objArmor.CapacityDisplayStyle;
            if (objXmlArmor.InnerXml.Contains("<addmodcategory>"))
                frmPickArmorMod.AllowedCategories += "," + objXmlArmor["addmodcategory"].InnerText;

            frmPickArmorMod.ShowDialog(this);

            if (frmPickArmorMod.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected piece.
            objXmlArmor = objXmlDocument.SelectSingleNode("/chummer/mods/mod[name = \"" + frmPickArmorMod.SelectedArmorMod + "\"]");

            TreeNode objNode = new TreeNode();
            ArmorMod objMod = new ArmorMod(_objCharacter);
            List<Weapon> lstWeapons = new List<Weapon>();
            List<TreeNode> lstWeaponNodes = new List<TreeNode>();
            int intRating = 0;
            if (Convert.ToInt32(objXmlArmor["maxrating"].InnerText) > 1)
                intRating = frmPickArmorMod.SelectedRating;

            objMod.Create(objXmlArmor, objNode, cmsArmorGear, intRating, lstWeapons, lstWeaponNodes);
            objMod.Parent = objArmor;
            objNode.ContextMenuStrip = string.IsNullOrEmpty(objMod.GearCapacity) ? cmsArmorMod : cmsArmorGear;
            if (objMod.InternalId == Guid.Empty.ToString())
                return;

            // Check the item's Cost and make sure the character can afford it.
            decimal decOriginalCost = objArmor.TotalCost;
            objArmor.ArmorMods.Add(objMod);

            // Do not allow the user to add a new piece of Armor if its Capacity has been reached.
            if (_objOptions.EnforceCapacity && objArmor.CapacityRemaining < 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                objArmor.ArmorMods.Remove(objMod);
                if (frmPickArmorMod.AddAgain)
                    tsAddArmorMod_Click(sender, e);
                return;
            }

            decimal decCost = objArmor.TotalCost - decOriginalCost;
            // Apply a markup if applicable.
            if (frmPickArmorMod.Markup != 0)
            {
                decCost *= 1 + (frmPickArmorMod.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objMod.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objMod.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            if (!frmPickArmorMod.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    objArmor.ArmorMods.Remove(objMod);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove the Improvements created by the Armor Mod.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId);
                    if (frmPickArmorMod.AddAgain)
                        tsAddArmorMod_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseArmorMod") + " " + objMod.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddArmorMod, objMod.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            treArmor.SelectedNode.Nodes.Add(objNode);
            treArmor.SelectedNode.Expand();
            treArmor.SelectedNode = objNode;

            // Add any Weapons created by the Mod.
            foreach (Weapon objWeapon in lstWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in lstWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            ScheduleCharacterUpdate();
            RefreshSelectedArmor();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickArmorMod.AddAgain)
                tsAddArmorMod_Click(sender, e);
        }

        private void tsGearAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treGear.SelectedNode == null || treGear.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectGear"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            
            bool blnAddAgain = PickGear();
            if (blnAddAgain)
                tsGearAddAsPlugin_Click(sender, e);
        }

        private void tsVehicleAddMod_Click(object sender, EventArgs e)
        {
            while (treVehicles.SelectedNode != null && treVehicles.SelectedNode.Level > 1)
                treVehicles.SelectedNode = treVehicles.SelectedNode.Parent;

            // Make sure a parent items is selected, then open the Select Vehicle Mod window.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level <= 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectVehicle"), LanguageManager.GetString("MessageTitle_SelectVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            Vehicle objSelectedVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            frmSelectVehicleMod frmPickVehicleMod = new frmSelectVehicleMod(_objCharacter, true);
            // Pass the selected vehicle on to the form.
            frmPickVehicleMod.SelectedVehicle = objSelectedVehicle;
            frmPickVehicleMod.InstalledMods = objSelectedVehicle.Mods;

            frmPickVehicleMod.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickVehicleMod.DialogResult == DialogResult.Cancel)
                return;

            // Open the Vehicles XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("vehicles.xml");
            
            XmlNode objXmlMod = objXmlDocument.SelectSingleNode("/chummer/mods/mod[id = \"" + frmPickVehicleMod.SelectedMod + "\"]");

            TreeNode objNode = new TreeNode();
            VehicleMod objMod = new VehicleMod(_objCharacter);
            objMod.Create(objXmlMod, objNode, frmPickVehicleMod.SelectedRating, objSelectedVehicle, frmPickVehicleMod.Markup);
            // Make sure that the Armor Rating does not exceed the maximum allowed by the Vehicle.
            if (objMod.Name.StartsWith("Armor"))
            {
                if (objMod.Rating > objSelectedVehicle.MaxArmor)
                {
                    objMod.Rating = objSelectedVehicle.MaxArmor;
                    objNode.Text = objMod.DisplayName;
                }
            }
            else if (objMod.Category == "Handling")
            {
                if (objMod.Rating > objSelectedVehicle.MaxHandling)
                {
                    objMod.Rating = objSelectedVehicle.MaxHandling;
                    objNode.Text = objMod.DisplayName;
                }
            }
            else if (objMod.Category == "Speed")
            {
                if (objMod.Rating > objSelectedVehicle.MaxSpeed)
                {
                    objMod.Rating = objSelectedVehicle.MaxSpeed;
                    objNode.Text = objMod.DisplayName;
                }
            }
            else if (objMod.Category == "Acceleration")
            {
                if (objMod.Rating > objSelectedVehicle.MaxAcceleration)
                {
                    objMod.Rating = objSelectedVehicle.MaxAcceleration;
                    objNode.Text = objMod.DisplayName;
                }
            }
            else if (objMod.Category == "Sensor")
            {
                if (objMod.Rating > objSelectedVehicle.MaxSensor)
                {
                    objMod.Rating = objSelectedVehicle.MaxSensor;
                    objNode.Text = objMod.DisplayName;
                }
            }
            else if (objMod.Name.StartsWith("Pilot Program"))
            {
                if (objMod.Rating > objSelectedVehicle.MaxPilot)
                {
                    objMod.Rating = objSelectedVehicle.MaxPilot;
                    objNode.Text = objMod.DisplayName;
                }
            }

            // Check the item's Cost and make sure the character can afford it.
            decimal decOriginalCost = objSelectedVehicle.TotalCost;
            if (frmPickVehicleMod.FreeCost)
                objMod.Cost = "0";

            objSelectedVehicle.Mods.Add(objMod);

            // Do not allow the user to add a new Vehicle Mod if the Vehicle's Capacity has been reached.
            if (_objOptions.EnforceCapacity)
            {
                bool blnOverCapacity = false;
                if (_objOptions.BookEnabled("R5"))
                {
                    if (objSelectedVehicle.IsDrone && GlobalOptions.Dronemods)
                    {
                        if (objSelectedVehicle.DroneModSlotsUsed > objSelectedVehicle.DroneModSlots)
                            blnOverCapacity = true;
                    }
                    else
                    {
                        int intUsed = objSelectedVehicle.CalcCategoryUsed(objMod.Category);
                        int intAvail = objSelectedVehicle.CalcCategoryAvail(objMod.Category);
                        if (intUsed > intAvail)
                            blnOverCapacity = true;
                    }
                }
                else if (objSelectedVehicle.Slots < objSelectedVehicle.SlotsUsed)
                {
                    blnOverCapacity = true;
                }

                if(blnOverCapacity)
                { 
                    MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    objSelectedVehicle.Mods.Remove(objMod);
                    if (frmPickVehicleMod.AddAgain)
                        tsVehicleAddMod_Click(sender, e);
                    return;
                }
            }

            decimal decCost = objSelectedVehicle.TotalCost - decOriginalCost;

            // Multiply the cost if applicable.
            if (objMod.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objMod.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

                if (decCost > _objCharacter.Nuyen)
                {
                    objSelectedVehicle.Mods.Remove(objMod);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickVehicleMod.AddAgain)
                        tsVehicleAddMod_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleMod") + " " + objMod.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleMod, objMod.InternalId);
                    objExpense.Undo = objUndo;
                }

            objNode.ContextMenuStrip = cmsVehicle;
            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();

            // Check for Improved Sensor bonus.
            if (objMod.Bonus != null)
            {
                if (objMod.Bonus["selecttext"] != null)
                {
                    frmSelectText frmPickText = new frmSelectText();
                    frmPickText.Description = LanguageManager.GetString("String_Improvement_SelectText").Replace("{0}", objMod.DisplayNameShort);
                    frmPickText.ShowDialog(this);
                    objMod.Extra = frmPickText.SelectedValue;
                    objNode.Text = objMod.DisplayName;
                }
                if (objMod.Bonus["improvesensor"] != null)
                {
                    ChangeVehicleSensor(objSelectedVehicle, true);
                }
            }

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickVehicleMod.AddAgain)
                tsVehicleAddMod_Click(sender, e);
        }

        private void tsVehicleAddWeaponWeapon_Click(object sender, EventArgs e)
        {
            // Make sure that a Weapon Mount has been selected.
            // Attempt to locate the selected VehicleMod.
            WeaponMount wm = CommonFunctions.FindVehicleWeaponMount(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out Vehicle v);
            if (wm == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotAddWeapon"), LanguageManager.GetString("MessageTitle_CannotAddWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectWeapon frmPickWeapon = new frmSelectWeapon(_objCharacter, true);
            frmPickWeapon.LimitToCategories = wm.WeaponMountCategories;
            frmPickWeapon.ShowDialog();
                
            if (frmPickWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Open the Weapons XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");

            XmlNode objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/weapons/weapon[id = \"" + frmPickWeapon.SelectedWeapon + "\"]");

            List<TreeNode> lstNodes = new List<TreeNode>();
            Weapon objWeapon = new Weapon(_objCharacter);
            objWeapon.Create(objXmlWeapon, lstNodes, cmsVehicleWeapon, cmsVehicleWeaponAccessory, wm.Weapons, cmsVehicleWeaponAccessoryGear);
            objWeapon.VehicleMounted = true;

            decimal decCost = objWeapon.TotalCost;
            // Apply a markup if applicable.
            if (frmPickWeapon.Markup != 0)
            {
                decCost *= 1 + (frmPickWeapon.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            if (!frmPickWeapon.FreeCost)
            {
                // Check the item's Cost and make sure the character can afford it.
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeapon.AddAgain)
                        tsVehicleAddWeaponWeapon_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleWeapon, objWeapon.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            wm.Weapons.Add(objWeapon);

            foreach (TreeNode objLoopNode in lstNodes)
            {
                objLoopNode.ContextMenuStrip = cmsVehicleWeapon;
                treVehicles.SelectedNode.Nodes.Add(objLoopNode);
            }
            treVehicles.SelectedNode.Expand();

            if (frmPickWeapon.AddAgain)
                tsVehicleAddWeaponWeapon_Click(sender, e);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleAddWeaponMount_Click(object sender, EventArgs e)
        {
            Vehicle v = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            frmCreateWeaponMount frmPickVehicleMod = new frmCreateWeaponMount(v, _objCharacter);
            frmPickVehicleMod.ShowDialog(this);

            if (frmPickVehicleMod.DialogResult != DialogResult.Cancel)
            {
                // Check the item's Cost and make sure the character can afford it.
                decimal decCost = frmPickVehicleMod.WeaponMount.TotalCost;
                // Apply a markup if applicable.
                /*if (frmPickWeaponAccessory.Markup != 0)
                {
                    decCost *= 1 + (frmPickWeaponAccessory.Markup / 100.0m);
                }

                // Multiply the cost if applicable.
                if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                    decCost *= _objOptions.RestrictedCostMultiplier;
                if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                    decCost *= _objOptions.ForbiddenCostMultiplier;
                */
                //if (!frmPickWeaponAccessory.FreeCost)
                //{
                if (decCost > _objCharacter.Nuyen)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }
                    else
                    {
                        // Create the Expense Log Entry.
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleWeaponAccessory") + " " + frmPickVehicleMod.WeaponMount.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen -= decCost;

                        ExpenseUndo objUndo = new ExpenseUndo();
                        objUndo.CreateNuyen(NuyenExpenseType.AddVehicleWeaponAccessory, frmPickVehicleMod.WeaponMount.InternalId);
                        objExpense.Undo = objUndo;
                    }
                //}

                v.WeaponMounts.Add(frmPickVehicleMod.WeaponMount);
                TreeNode node = new TreeNode();
                foreach (TreeNode t in treVehicles.SelectedNode.Nodes)
                {
                    if (t.Tag.ToString() == "String_WeaponMounts")
                    {
                        node = t;
                        break;
                    }
                }
                if (node.Tag == null)
                {
                    node.Tag = "String_WeaponMounts";
                    node.Text = LanguageManager.GetString("String_WeaponMounts");
                    treVehicles.SelectedNode.Nodes.Add(node);
                }
                TreeNode tn = new TreeNode
                {
                    Tag = frmPickVehicleMod.WeaponMount.InternalId.ToString(),
                    Text = frmPickVehicleMod.WeaponMount.DisplayName,
                    ContextMenuStrip = cmsWeaponMount
                };
                node.Nodes.Add(tn);
                treVehicles.SelectedNode.ExpandAll();
            }
        }

        private void tsVehicleAddWeaponAccessory_Click(object sender, EventArgs e)
        {
            // Attempt to locate the selected VehicleWeapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objWeapon == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_VehicleWeaponAccessories"), LanguageManager.GetString("MessageTitle_VehicleWeaponAccessories"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Make sure the Weapon allows Accessories to be added to it.
            if (!objWeapon.AllowAccessory)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotModifyWeapon"), LanguageManager.GetString("MessageTitle_CannotModifyWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Open the Weapons XML file and locate the selected Weapon.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");
            XmlNode objXmlWeapon = objWeapon.MyXmlNode;
            if (objXmlWeapon == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotFindWeapon"), LanguageManager.GetString("MessageTitle_CannotModifyWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectWeaponAccessory frmPickWeaponAccessory = new frmSelectWeaponAccessory(_objCharacter, true);

            XmlNodeList objXmlMountList = objXmlWeapon.SelectNodes("accessorymounts/mount");
            string strMounts = string.Empty;
            foreach (XmlNode objXmlMount in objXmlMountList)
            {
                // Run through the Weapon's currenct Accessories and filter out any used up Mount points.
                bool blnFound = false;
                foreach (WeaponAccessory objCurrentAccessory in objWeapon.WeaponAccessories)
                {
                    if ((objCurrentAccessory.Mount == objXmlMount.InnerText) || (objCurrentAccessory.ExtraMount == objXmlMount.InnerText))
                    {
                        blnFound = true;
                        break;
                    }
                }
                if (!blnFound)
                    strMounts += objXmlMount.InnerText + "/";
            }
            frmPickWeaponAccessory.AllowedMounts = strMounts;

            frmPickWeaponAccessory.CurrentWeaponName = objWeapon.Name;
            frmPickWeaponAccessory.WeaponCost = objWeapon.Cost;
            frmPickWeaponAccessory.AccessoryMultiplier = objWeapon.AccessoryMultiplier;
            frmPickWeaponAccessory.InstalledAccessories = objWeapon.WeaponAccessories;
            frmPickWeaponAccessory.ShowDialog();

            if (frmPickWeaponAccessory.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected piece.
            objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/accessories/accessory[name = \"" + frmPickWeaponAccessory.SelectedAccessory + "\"]");

            TreeNode objNode = new TreeNode();
            WeaponAccessory objAccessory = new WeaponAccessory(_objCharacter);
            objAccessory.Create(objXmlWeapon, objNode, frmPickWeaponAccessory.SelectedMount, Convert.ToInt32(frmPickWeaponAccessory.SelectedRating), cmsWeaponAccessoryGear);
            objAccessory.Parent = objWeapon;

            // Check the item's Cost and make sure the character can afford it.
            decimal intOriginalCost = objWeapon.TotalCost;
            objWeapon.WeaponAccessories.Add(objAccessory);

            decimal decCost = objWeapon.TotalCost - intOriginalCost;
            // Apply a markup if applicable.
            if (frmPickWeaponAccessory.Markup != 0)
            {
                decCost *= 1 + (frmPickWeaponAccessory.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objAccessory.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            if (!frmPickWeaponAccessory.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    objWeapon.WeaponAccessories.Remove(objAccessory);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeaponAccessory.AddAgain)
                        tsVehicleAddWeaponAccessory_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleWeaponAccessory") + " " + objAccessory.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleWeaponAccessory, objAccessory.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            objNode.ContextMenuStrip = cmsVehicleWeaponAccessory;
            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();

            if (frmPickWeaponAccessory.AddAgain)
                tsVehicleAddWeaponAccessory_Click(sender, e);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleAddUnderbarrelWeapon_Click(object sender, EventArgs e)
        {
            // Attempt to locate the selected VehicleWeapon.
            Weapon objSelectedWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objSelectedWeapon == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_VehicleWeaponUnderbarrel"), LanguageManager.GetString("MessageTitle_VehicleWeaponUnderbarrel"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (objSelectedWeapon.UnderbarrelWeapons.Count > 0)
            {
                return;
            }

            frmSelectWeapon frmPickWeapon = new frmSelectWeapon(_objCharacter);
            frmPickWeapon.LimitToCategories = "Underbarrel Weapons";
            frmPickWeapon.Mounts = objSelectedWeapon.AccessoryMounts;

            frmPickWeapon.Underbarrel = true;

            frmPickWeapon.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Open the Weapons XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");

            XmlNode objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/weapons/weapon[id = \"" + frmPickWeapon.SelectedWeapon + "\"]");

            List<TreeNode> lstNodes = new List<TreeNode>();
            Weapon objWeapon = new Weapon(_objCharacter);
            objWeapon.Create(objXmlWeapon, lstNodes, cmsWeapon, cmsWeaponAccessory, objSelectedWeapon.UnderbarrelWeapons, cmsWeaponAccessoryGear);
            objWeapon.DiscountCost = frmPickWeapon.BlackMarketDiscount;
            objWeapon.VehicleMounted = true;
            objWeapon.Parent = objSelectedWeapon;
            if (objSelectedWeapon.AllowAccessory == false)
                objWeapon.AllowAccessory = false;

            decimal decCost = objWeapon.TotalCost;
            // Apply a markup if applicable.
            if (frmPickWeapon.Markup != 0)
            {
                decCost *= 1 + (frmPickWeapon.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickWeapon.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeapon.AddAgain)
                        cmdAddWeapon_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleWeapon, objWeapon.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            objSelectedWeapon.UnderbarrelWeapons.Add(objWeapon);

            foreach (TreeNode objLoopNode in lstNodes)
            {
                objLoopNode.ContextMenuStrip = cmsVehicleWeapon;
                treVehicles.SelectedNode.Nodes.Add(objLoopNode);
            }
            treVehicles.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleAddWeaponAccessoryAlt_Click(object sender, EventArgs e)
        {
            tsVehicleAddWeaponAccessory_Click(sender, e);
        }

        private void tsVehicleAddUnderbarrelWeaponAlt_Click(object sender, EventArgs e)
        {
            tsVehicleAddUnderbarrelWeapon_Click(sender, e);
        }

        private void tsMartialArtsAddAdvantage_Click(object sender, EventArgs e)
        {
            if (treMartialArts.SelectedNode != null)
            {
                // Select the Martial Arts node if we're currently on a child.
                if (treMartialArts.SelectedNode.Level > 1)
                    treMartialArts.SelectedNode = treMartialArts.SelectedNode.Parent;

                MartialArt objMartialArt = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);

                frmSelectMartialArtAdvantage frmPickMartialArtAdvantage = new frmSelectMartialArtAdvantage(_objCharacter);
                frmPickMartialArtAdvantage.MartialArt = objMartialArt.Name;
                frmPickMartialArtAdvantage.ShowDialog(this);

                if (frmPickMartialArtAdvantage.DialogResult == DialogResult.Cancel)
                    return;

                // Open the Martial Arts XML file and locate the selected piece.
                XmlDocument objXmlDocument = XmlManager.Load("martialarts.xml");

                XmlNode objXmlAdvantage = objXmlDocument.SelectSingleNode("/chummer/techniques/technique[name = \"" + frmPickMartialArtAdvantage.SelectedAdvantage + "\"]");

                // Create the Improvements for the Advantage if there are any.
                TreeNode objNode = new TreeNode();
                MartialArtAdvantage objAdvantage = new MartialArtAdvantage(_objCharacter);
                objAdvantage.Create(objXmlAdvantage, objNode);
                if (objAdvantage.InternalId == Guid.Empty.ToString())
                    return;

                objMartialArt.Advantages.Add(objAdvantage);

                objNode.ContextMenuStrip = cmsTechnique;
                treMartialArts.SelectedNode.Nodes.Add(objNode);
                treMartialArts.SelectedNode.Expand();

                // Create the Expense Log Entry.
                if (treMartialArts.SelectedNode.Nodes.Count > 1)
                {
                    ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                    objEntry.Create(_objOptions.KarmaManeuver * -1, LanguageManager.GetString("String_ExpenseLearnTechnique") + " " + frmPickMartialArtAdvantage.SelectedAdvantage, ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objEntry);
                    _objCharacter.Karma -= _objOptions.KarmaManeuver;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.AddMartialArtManeuver, frmPickMartialArtAdvantage.SelectedAdvantage);
                    objEntry.Undo = objUndo;
                }

                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
            else
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectMartialArtAdvantage"), LanguageManager.GetString("MessageTitle_SelectMartialArtAdvantage"), MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void tsVehicleAddGear_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectGearVehicle"), LanguageManager.GetString("MessageTitle_SelectGearVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treVehicles.SelectedNode.Level > 1)
                treVehicles.SelectedNode = treVehicles.SelectedNode.Parent;

            // Locate the selected Vehicle.
            Vehicle objSelectedVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objSelectedVehicle?.MyXmlNode);
            frmPickGear.ShowPositiveCapacityOnly = false;
            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Gear objGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating, false);
                objCommlink.Quantity = frmPickGear.SelectedQty;

                objGear = objCommlink;
            }
            else
            {
                Gear objNewGear = new Gear(_objCharacter);
                objNewGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, false, true, frmPickGear.Aerodynamic);
                objNewGear.Quantity = frmPickGear.SelectedQty;

                objGear = objNewGear;
            }

            if (objGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objGear.Cost = (Convert.ToDouble(objGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objGear.Cost))
                    objGear.Cost = "(" + objGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objGear.Extra))
                    objGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objGear.Cost = "0";
            }

            objGear.Quantity = frmPickGear.SelectedQty;
            objNode.Text = objGear.DisplayName;

            // Change the cost of the Sensor itself to 0.
            //if (frmPickGear.SelectedCategory == "Sensors")
            //{
            //    objGear.Cost = "0";
            //    objGear.DictionaryCostN = new Tuple<int, Dictionary<int, string>>(-1, new Dictionary<int, string>());
            //}

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleAddGear_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleGear, objGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            objNode.ContextMenuStrip = cmsVehicleGear;

            bool blnMatchFound = false;
            // If this is Ammunition, see if the character already has it on them.
            if (objGear.Category == "Ammunition")
            {
                foreach (Gear objVehicleGear in objSelectedVehicle.Gear)
                {
                    if (objVehicleGear.Name == objGear.Name && objVehicleGear.Category == objGear.Category && objVehicleGear.Rating == objGear.Rating && objVehicleGear.Extra == objGear.Extra)
                    {
                        // A match was found, so increase the quantity instead.
                        objVehicleGear.Quantity += objGear.Quantity;
                        blnMatchFound = true;

                        foreach (TreeNode objGearNode in treVehicles.SelectedNode.Nodes)
                        {
                            if (objVehicleGear.InternalId == objGearNode.Tag.ToString())
                            {
                                objGearNode.Text = objVehicleGear.DisplayName;
                                break;
                            }
                        }

                        break;
                    }
                }
            }

            if (!blnMatchFound)
            {
                treVehicles.SelectedNode.Nodes.Add(objNode);
                treVehicles.SelectedNode.Expand();

                // Add the Gear to the Vehicle.
                objSelectedVehicle.Gear.Add(objGear);
            }

            if (frmPickGear.AddAgain)
                tsVehicleAddGear_Click(sender, e);

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleSensorAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level < 2)
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_ModifyVehicleGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treVehicles.SelectedNode.Level > 3)
                treVehicles.SelectedNode = treVehicles.SelectedNode.Parent;

            // Locate the Vehicle Sensor Gear.
            Gear objSensor = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objSensor == null)
            // Make sure the Sensor was found.
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_ModifyVehicleGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            XmlNode objXmlGear = objSensor.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objXmlGear);
            //frmPickGear.ShowNegativeCapacityOnly = true;

            if (objXmlGear != null)
            {
                if (objXmlGear.InnerXml.Contains("<addoncategory>"))
                {
                    string strCategories = string.Empty;
                    foreach (XmlNode objXmlCategory in objXmlGear.SelectNodes("addoncategory"))
                        strCategories += objXmlCategory.InnerText + ",";
                    // Remove the trailing comma.
                    strCategories = strCategories.Substring(0, strCategories.Length - 1);
                    frmPickGear.AllowedCategories = strCategories;
                }
            }

            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Gear objGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating, false);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objGear = objCommlink;
            }
            else
            {
                Gear objNewGear = new Gear(_objCharacter);
                objNewGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, false, true, frmPickGear.Aerodynamic);
                objNewGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objNewGear.DisplayName;

                objGear = objNewGear;
            }

            if (objGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objGear.Cost = (Convert.ToDouble(objGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objGear.Cost))
                    objGear.Cost = "(" + objGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objGear.Extra))
                    objGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objGear.Cost = "0";
            }

            objNode.Text = objGear.DisplayName;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleSensorAddAsPlugin_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleGear, objGear.InternalId, frmPickGear.SelectedQty);
                    objExpense.Undo = objUndo;
                }
            }

            objGear.Parent = objSensor;
            objNode.ContextMenuStrip = cmsVehicleGear;

            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();

            objSensor.Children.Add(objGear);
            Commlink objSensorCommlink = objSensor as Commlink;
            if (objSensorCommlink?.CanSwapAttributes == true)
            {
                objSensorCommlink.RefreshCyberdeckArray();
            }

            if (frmPickGear.AddAgain)
                tsVehicleSensorAddAsPlugin_Click(sender, e);

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleGearAddAsPlugin_Click(object sender, EventArgs e)
        {
            tsVehicleSensorAddAsPlugin_Click(sender, e);
        }

        private void tsVehicleGearNotes_Click(object sender, EventArgs e)
        {
            Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objGear != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objGear.Notes;
                string strOldValue = objGear.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objGear.Notes = frmItemNotes.Notes;
                    if (objGear.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objGear.Notes))
                    treVehicles.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objGear.IncludedInParent)
                    treVehicles.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                    treVehicles.SelectedNode.ForeColor = SystemColors.WindowText;
                treVehicles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objGear.Notes, 100);
            }
        }

        private void cmsAmmoSingleShot_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                objWeapon.AmmoRemaining -= 1;
                lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsAmmoShortBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= 3)
                {
                    objWeapon.AmmoRemaining -= 3;
                }
                else
                {
                    if (objWeapon.AmmoRemaining == 1)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSingleShot"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                }
                lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsAmmoLongBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= 6)
                {
                    objWeapon.AmmoRemaining -= 6;
                }
                else
                {
                    if (objWeapon.AmmoRemaining == 1)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSingleShot"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else if (objWeapon.AmmoRemaining > 3)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoLongBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else if (objWeapon.AmmoRemaining == 3)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurst"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                }
                lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsAmmoFullBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= objWeapon.FullBurst)
                {
                    objWeapon.AmmoRemaining -= objWeapon.FullBurst;
                }
                else
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoFullBurst"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsAmmoSuppressiveFire_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            if (objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= objWeapon.Suppressive)
                {
                    objWeapon.AmmoRemaining -= objWeapon.Suppressive;
                }
                else
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSuppressiveFire"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsVehicleAmmoSingleShot_Click(object sender, EventArgs e)
        {
            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            if (objWeapon == null || objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                objWeapon.AmmoRemaining -= 1;
                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsVehicleAmmoShortBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            if (objWeapon == null || objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= 3)
                {
                    objWeapon.AmmoRemaining -= 3;
                }
                else
                {
                    if (objWeapon.AmmoRemaining == 1)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSingleShot"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                }
                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsVehicleAmmoLongBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            if (objWeapon == null || objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= 6)
                {
                    objWeapon.AmmoRemaining -= 6;
                }
                else
                {
                    if (objWeapon.AmmoRemaining == 1)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSingleShot"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else if (objWeapon.AmmoRemaining > 3)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoLongBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else if (objWeapon.AmmoRemaining == 3)
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurst"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                    else
                    {
                        if (MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoShortBurstShort"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation) == DialogResult.Yes)
                            objWeapon.AmmoRemaining = 0;
                    }
                }
                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsVehicleAmmoFullBurst_Click(object sender, EventArgs e)
        {
            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            if (objWeapon == null || objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= objWeapon.FullBurst)
                {
                    objWeapon.AmmoRemaining -= objWeapon.FullBurst;
                }
                else
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoFullBurst"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmsVehicleAmmoSuppressiveFire_Click(object sender, EventArgs e)
        {
            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            if (objWeapon == null || objWeapon.AmmoRemaining == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmo"), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                if (objWeapon.AmmoRemaining >= objWeapon.Suppressive)
                {
                    objWeapon.AmmoRemaining -= objWeapon.Suppressive;
                }
                else
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughAmmoSuppressiveFire"), LanguageManager.GetString("MessageTitle_NotEnoughAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsCyberwareSell_Click(object sender, EventArgs e)
        {
            if (treCyberware.SelectedNode != null)
            {
                if (treCyberware.SelectedNode.Level > 0)
                {
                    // Locate the piece of Cyberware that is selected in the tree.
                    Cyberware objCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);
                    Cyberware objParent = objCyberware?.Parent;

                    if (objCyberware != null)
                    {
                        if (objCyberware.Capacity == "[*]" && treCyberware.SelectedNode.Level == 2)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveCyberware"), LanguageManager.GetString("MessageTitle_CannotRemoveCyberware"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Create the Expense Log Entry for the sale.
                        decimal decAmount = objCyberware.TotalCost * frmSell.SellPercent;
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        string strEntry = string.Empty;
                        if (objCyberware.SourceType == Improvement.ImprovementSource.Cyberware)
                            strEntry = LanguageManager.GetString("String_ExpenseSoldCyberware");
                        else
                            strEntry = LanguageManager.GetString("String_ExpenseSoldBioware");
                        decAmount += CommonFunctions.DeleteCyberware(_objCharacter, objCyberware, treWeapons, treVehicles) * frmSell.SellPercent;
                        objExpense.Create(decAmount, strEntry + " " + objCyberware.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;

                        // Remove the Children.
                        objCyberware.Children.Clear();

                        // Remove any Improvements created by the piece of Cyberware.
                        ImprovementManager.RemoveImprovements(_objCharacter, objCyberware.SourceType, objCyberware.InternalId);
                        _objCharacter.Cyberware.Remove(objCyberware);

                        IncreaseEssenceHole((int)(objCyberware.CalculatedESS() * 100));

                        // Remove the item from the TreeView.
                        treCyberware.Nodes.Remove(treCyberware.SelectedNode);

                        // If the Parent is populated, remove the item from its Parent.
                        objParent?.Children.Remove(objCyberware);
                    }
                    else
                    {
                        // Locate the selected piece of Gear.
                        Gear objGear = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children), out objCyberware);

                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Create the Expense Log Entry for the sale.
                        decimal decAmount = objGear.TotalCost * frmSell.SellPercent;
                        decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        string strEntry = LanguageManager.GetString("String_ExpenseSoldCyberwareGear");
                        objExpense.Create(decAmount, strEntry + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;

                        if (objGear.Parent == null)
                            objCyberware.Gear.Remove(objGear);
                        else
                        {
                            objGear.Parent.Children.Remove(objGear);
                            Commlink objParentCommlink = objGear.Parent as Commlink;
                            if (objParentCommlink?.CanSwapAttributes == true)
                            {
                                objParentCommlink.RefreshCyberdeckArray();
                            }
                        }
                        
                        treCyberware.SelectedNode.Remove();
                    }

                    ScheduleCharacterUpdate();
                    RefreshSelectedCyberware();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void tsArmorSell_Click(object sender, EventArgs e)
        {
            // Delete the selected piece of Armor.
            if (treArmor.SelectedNode != null)
            {
                if (treArmor.SelectedNode.Level == 1)
                {
                    // Locate the piece of Armor that is selected in the tree.
                    Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

                    frmSellItem frmSell = new frmSellItem();
                    frmSell.ShowDialog(this);

                    if (frmSell.DialogResult == DialogResult.Cancel)
                        return;

                    // Create the Expense Log Entry for the sale.
                    decimal decAmount = objArmor.TotalCost * frmSell.SellPercent;
                    decAmount += CommonFunctions.DeleteArmor(_objCharacter, treArmor, treWeapons, treVehicles) * frmSell.SellPercent;
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldArmor") + " " + objArmor.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen += decAmount;
                }
                else if (treArmor.SelectedNode.Level == 2)
                {
                    // Locate the ArmorMod that is selected in the tree.
                    ArmorMod objMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                    if (objMod != null)
                    {
                        // Record the cost of the Armor with the ArmorMod.
                        decimal decOriginal = objMod.Parent.TotalCost;

                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Create the Expense Log Entry for the sale.
                        decimal decAmount = (decOriginal - objMod.Parent.TotalCost) * frmSell.SellPercent;
                        decAmount += CommonFunctions.DeleteArmor(_objCharacter, treArmor, treWeapons, treVehicles) * frmSell.SellPercent;
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldArmorMod") + " " + objMod.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;
                    }
                    else
                    {
                        Armor objArmor = null;
                        ArmorMod objArmorMod = null;
                        Gear objGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor, out objArmor, out objArmorMod);

                        // Record the cost of the Armor with the ArmorMod.
                        decimal decOriginal = 0.0m;
                        if (objArmorMod != null)
                            decOriginal = objArmorMod.TotalCost;
                        else
                            decOriginal = objArmor.TotalCost;

                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Create the Expense Log Entry for the sale.
                        decimal decNewCost = 0.0m;
                        if (objArmorMod != null)
                            decNewCost = objArmorMod.TotalCost;
                        else
                            decNewCost = objArmor.TotalCost;
                        decimal decAmount = (decOriginal - decNewCost) * frmSell.SellPercent;
                        decAmount += CommonFunctions.DeleteArmor(_objCharacter, treArmor, treWeapons, treVehicles) * frmSell.SellPercent;
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldArmorGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;
                    }
                }
                else if (treArmor.SelectedNode.Level > 2)
                {
                    Armor objArmor = null;
                    ArmorMod objArmorMod = null;
                    Gear objGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor, out objArmor, out objArmorMod);
                    Gear objParent = objGear.Parent;

                    // Record the cost of the Armor with the ArmorMod.
                    decimal decOriginal = 0.0m;
                    if (objArmorMod != null)
                        decOriginal = objArmorMod.TotalCost;
                    else
                        decOriginal = objArmor.TotalCost;

                    frmSellItem frmSell = new frmSellItem();
                    frmSell.ShowDialog(this);

                    if (frmSell.DialogResult == DialogResult.Cancel)
                        return;

                    // Create the Expense Log Entry for the sale.
                    decimal decNewCost = 0.0m;
                    if (objArmorMod != null)
                        decNewCost = objArmorMod.TotalCost;
                    else
                        decNewCost = objArmor.TotalCost;
                    decimal decAmount = (decOriginal - decNewCost) * frmSell.SellPercent;
                    decAmount += CommonFunctions.DeleteArmor(_objCharacter, treArmor, treWeapons, treVehicles) * frmSell.SellPercent;
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldArmorGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen += decAmount;
                }
                ScheduleCharacterUpdate();
                RefreshSelectedArmor();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void tsWeaponSell_Click(object sender, EventArgs e)
        {
            // Delete the selected Weapon.
            if (treWeapons.SelectedNode != null)
            {
                if (treWeapons.SelectedNode.Level == 1)
                {
                    Weapon objWeapon = null;
                    // Locate the Weapon that is selected in the tree.
                    foreach (Weapon objCharacterWeapon in _objCharacter.Weapons)
                    {
                        if (objCharacterWeapon.InternalId == treWeapons.SelectedNode.Tag.ToString())
                        {
                            objWeapon = objCharacterWeapon;
                            break;
                        }
                    }

                    // Cyberweapons cannot be removed through here and must be done by removing the piece of Cyberware.
                    if (objWeapon.Cyberware)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveCyberweapon"), LanguageManager.GetString("MessageTitle_CannotRemoveCyberweapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }
                    if (objWeapon.Category == "Gear")
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveGearWeapon"), LanguageManager.GetString("MessageTitle_CannotRemoveGearWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }
                    if (objWeapon.Category.StartsWith("Quality"))
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveQualityWeapon"), LanguageManager.GetString("MessageTitle_CannotRemoveQualityWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    frmSellItem frmSell = new frmSellItem();
                    frmSell.ShowDialog(this);

                    if (frmSell.DialogResult == DialogResult.Cancel)
                        return;

                    // Create the Expense Log Entry for the sale.
                    decimal decAmount = (objWeapon.TotalCost + CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles)) * frmSell.SellPercent;
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen += decAmount;

                    _objCharacter.Weapons.Remove(objWeapon);
                    treWeapons.SelectedNode.Remove();
                }
                else if (treWeapons.SelectedNode.Level > 1)
                {
                    Weapon objWeapon = null;
                    // Locate the Weapon that is selected in the tree.
                    foreach (Weapon objCharacterWeapon in _objCharacter.Weapons)
                    {
                        if (objCharacterWeapon.InternalId == treWeapons.SelectedNode.Parent.Tag.ToString())
                        {
                            objWeapon = objCharacterWeapon;
                            break;
                        }
                    }

                    WeaponAccessory objAccessory = null;
                    // Locate the Accessory that is selected in the tree.
                    foreach (WeaponAccessory objCharacterAccessory in objWeapon.WeaponAccessories)
                    {
                        if (objCharacterAccessory.InternalId == treWeapons.SelectedNode.Tag.ToString())
                        {
                            objAccessory = objCharacterAccessory;
                            break;
                        }
                    }

                    if (!string.IsNullOrEmpty(objAccessory.Name))
                    {
                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Record the Weapon's original cost.
                        decimal decOriginal = objWeapon.TotalCost;

                        objWeapon.WeaponAccessories.Remove(objAccessory);
                        treWeapons.SelectedNode.Remove();

                        decimal decAmount = (decOriginal - objWeapon.TotalCost) * frmSell.SellPercent;
                        foreach (Gear objGear in objAccessory.Gear)
                        {
                            decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                        }
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldWeaponAccessory") + " " + objAccessory.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;
                    }
                    else
                    {
                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Find the selected Gear.
                        Gear objGear = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons, out objAccessory);
                        if (objGear.Parent == null)
                            objAccessory.Gear.Remove(objGear);
                        else
                        {
                            objGear.Parent.Children.Remove(objGear);
                            Commlink objParentCommlink = objGear.Parent as Commlink;
                            if (objParentCommlink?.CanSwapAttributes == true)
                            {
                                objParentCommlink.RefreshCyberdeckArray();
                            }
                        }
                        treWeapons.SelectedNode.Remove();

                        decimal decAmount = objGear.TotalCost * frmSell.SellPercent;
                        decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldWeaponGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;
                    }
                }
                ScheduleCharacterUpdate();
                RefreshSelectedWeapon();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void sellItemToolStripMenuItem_Click(object sender, EventArgs e)
        {
            // Delete the selected Gear.
            if (treGear.SelectedNode != null)
            {
                if (treGear.SelectedNode.Level > 0)
                {
                    Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
                    if (objGear == null)
                        return;
                    Gear objParent = objGear.Parent;

                    frmSellItem frmSell = new frmSellItem();
                    frmSell.ShowDialog(this);

                    if (frmSell.DialogResult == DialogResult.Cancel)
                        return;

                    // Create the Expense Log Entry for the sale.
                    decimal decAmount = objGear.TotalCost * frmSell.SellPercent;
                    decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen += decAmount;

                    _objCharacter.Gear.Remove(objGear);
                    treGear.SelectedNode.Remove();

                    // If the Parent is populated, remove the item from its Parent.
                    if (objParent != null)
                    {
                        objParent.Children.Remove(objGear);
                        Commlink objCommlink = objParent as Commlink;
                        if (objCommlink?.CanSwapAttributes == true)
                        {
                            objCommlink.RefreshCyberdeckArray();
                        }
                    }
                }
                CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
                ScheduleCharacterUpdate();
                RefreshSelectedGear();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void tsVehicleSell_Click(object sender, EventArgs e)
        {
            // Delete the selected Vehicle.
            if (treVehicles.SelectedNode != null)
            {
                // Locate the Weapon that is selected in the tree.
                foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
                {
                    foreach (Weapon objWeapon in objCharacterVehicle.Weapons)
                    {
                        if (objWeapon.InternalId == treVehicles.SelectedNode.Tag.ToString())
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveGearWeaponVehicle"), LanguageManager.GetString("MessageTitle_CannotRemoveGearWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            break;
                        }
                    }
                }

                // Locate the Vehicle that is selected in the tree.
                Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

                // Selling a Vehicle
                if (objVehicle != null)
                {
                    frmSellItem frmSell = new frmSellItem();
                    frmSell.ShowDialog(this);

                    if (frmSell.DialogResult == DialogResult.Cancel)
                        return;

                    // Create the Expense Log Entry for the sale.
                    decimal decAmount = objVehicle.TotalCost * frmSell.SellPercent;
                    // Remove any Gear Improvements from the character (primarily those provided by an Emotitoy).
                    foreach (Gear objGear in objVehicle.Gear)
                    {
                        decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                    }

                    foreach (Weapon objLoopWeapon in objVehicle.Weapons)
                    {
                        decAmount += CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles) * frmSell.SellPercent;
                    }
                    foreach (VehicleMod objLoopMod in objVehicle.Mods)
                    {
                        foreach (Weapon objLoopWeapon in objLoopMod.Weapons)
                        {
                            decAmount += CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles) * frmSell.SellPercent;
                        }
                        foreach (Cyberware objLoopCyberware in objLoopMod.Cyberware)
                        {
                            decAmount += CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles) * frmSell.SellPercent;
                        }
                    }
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicle") + " " + objVehicle.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen += decAmount;
                    _objCharacter.Vehicles.Remove(objVehicle);
                    treVehicles.SelectedNode.Remove();
                }
                else
                {
                    // Locate the VehicleMod that is selected in the tree.
                    VehicleMod objMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle);
                    // Selling a Vehicle Mod
                    if (objMod != null)
                    {
                        if (objMod.IncludedInVehicle)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CannotRemoveVehicleMod"), LanguageManager.GetString("MessageTitle_CannotRemoveVehicleMod"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        frmSellItem frmSell = new frmSellItem();
                        frmSell.ShowDialog(this);

                        if (frmSell.DialogResult == DialogResult.Cancel)
                            return;

                        // Record the original value of the Vehicle.
                        decimal decOriginal = objVehicle.TotalCost;

                        // Check for Improved Sensor bonus.
                        if (objMod.Bonus?["improvesensor"] != null || (objMod.WirelessOn && objMod.WirelessBonus?["improvesensor"] != null))
                        {
                            ChangeVehicleSensor(objVehicle, false);
                        }

                        // Create the Expense Log Entry for the sale.
                        decimal decAmount = (decOriginal - objVehicle.TotalCost) * frmSell.SellPercent;
                        foreach (Weapon objLoopWeapon in objMod.Weapons)
                        {
                            decAmount += CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles) * frmSell.SellPercent;
                        }
                        foreach (Cyberware objLoopCyberware in objMod.Cyberware)
                        {
                            decAmount += CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles) * frmSell.SellPercent;
                        }
                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicleMod") + " " + objMod.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                        _objCharacter.ExpenseEntries.Add(objExpense);
                        _objCharacter.Nuyen += decAmount;

                        objVehicle.Mods.Remove(objMod);
                        treVehicles.SelectedNode.Remove();
                    }
                    else
                    {
                        Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle, out WeaponMount wm, out VehicleMod vm);
                        // Removing a Weapon
                        if (objWeapon != null)
                        {
                            frmSellItem frmSell = new frmSellItem();
                            frmSell.ShowDialog(this);

                            if (frmSell.DialogResult == DialogResult.Cancel)
                                return;

                            // Record the original value of the Vehicle.
                            decimal decOriginal = objVehicle.TotalCost + CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                            if (objWeapon.Parent == null)
                            {
                                if (wm != null)
                                    wm.Weapons.Remove(objWeapon);
                                // This bit here should never be reached, but I'm adding it for future-proofing in case we want people to be able to remove weapons attached directly to vehicles
                                else
                                    objVehicle.Weapons.Remove(objWeapon);
                            }
                            else
                            {
                                objWeapon.Parent.Children.Remove(objWeapon);
                            }

                            // Create the Expense Log Entry for the sale.
                            decimal decAmount = (decOriginal - objVehicle.TotalCost) * frmSell.SellPercent;
                            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                            objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicleWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                            _objCharacter.ExpenseEntries.Add(objExpense);
                            _objCharacter.Nuyen += decAmount;
                            treVehicles.SelectedNode.Remove();
                        }
                        else
                        {
                            WeaponAccessory objWeaponAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objWeapon);
                            // Removing a weapon accessory
                            if (objWeaponAccessory != null)
                            {
                                frmSellItem frmSell = new frmSellItem();
                                frmSell.ShowDialog(this);

                                if (frmSell.DialogResult == DialogResult.Cancel)
                                    return;

                                // Record the original value of the Vehicle.
                                decimal decOriginal = objWeapon.TotalCost;
                                objWeapon.WeaponAccessories.Remove(objWeaponAccessory);
                                
                                treVehicles.SelectedNode.Remove();

                                // Create the Expense Log Entry for the sale.
                                decimal decAmount = (decOriginal - objVehicle.TotalCost) * frmSell.SellPercent;
                                foreach (Gear objLoopGear in objWeaponAccessory.Gear)
                                {
                                    decAmount += CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles) * frmSell.SellPercent;
                                }
                                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                                objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicleWeaponAccessory") + " " + objWeaponAccessory.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                                _objCharacter.ExpenseEntries.Add(objExpense);
                                _objCharacter.Nuyen += decAmount;
                            }
                            else
                            {
                                Cyberware objCyberware = CommonFunctions.FindVehicleCyberware(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objMod);
                                // Removing Cyberware
                                if (objCyberware != null)
                                {
                                    frmSellItem frmSell = new frmSellItem();
                                    frmSell.ShowDialog(this);

                                    if (frmSell.DialogResult == DialogResult.Cancel)
                                        return;

                                    // Record the original value of the Vehicle.
                                    decimal decOriginal = objMod.TotalCost;
                                    if (objCyberware.Parent == null)
                                    {
                                        objMod.Cyberware.Remove(objCyberware);
                                    }
                                    else
                                    {
                                        objCyberware.Parent.Children.Remove(objCyberware);
                                    }
                                    treVehicles.SelectedNode.Remove();

                                    // Create the Expense Log Entry for the sale.
                                    decimal decAmount = (decOriginal - objVehicle.TotalCost) * frmSell.SellPercent;
                                    decAmount += CommonFunctions.DeleteCyberware(_objCharacter, objCyberware, treWeapons, treVehicles) * frmSell.SellPercent;
                                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                                    objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicleCyberware") + " " + objCyberware.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                                    _objCharacter.ExpenseEntries.Add(objExpense);
                                    _objCharacter.Nuyen += decAmount;
                                }
                                else
                                {
                                    objVehicle = null;
                                    objWeaponAccessory = null;
                                    objCyberware = null;
                                    Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle, out objWeaponAccessory, out objCyberware);
                                    if (objGear != null)
                                    {
                                        frmSellItem frmSell = new frmSellItem();
                                        frmSell.ShowDialog(this);

                                        if (frmSell.DialogResult == DialogResult.Cancel)
                                            return;

                                        // Record the original value of the vehicle.
                                        decimal decOriginal = objVehicle.TotalCost;
                                        if (objGear.Parent == null)
                                        {
                                            if (objCyberware != null)
                                                objCyberware.Gear.Remove(objGear);
                                            else if (objWeaponAccessory != null)
                                                objWeaponAccessory.Gear.Remove(objGear);
                                            else
                                                objVehicle.Gear.Remove(objGear);
                                        }
                                        else
                                        {
                                            objGear.Parent.Children.Remove(objGear);
                                            Commlink objParentCommlink = objGear.Parent as Commlink;
                                            if (objParentCommlink?.CanSwapAttributes == true)
                                            {
                                                objParentCommlink.RefreshCyberdeckArray();
                                            }
                                        }
                                        treVehicles.SelectedNode.Remove();

                                        // Create the Expense Log Entry for the sale.
                                        decimal decAmount = (decOriginal - objVehicle.TotalCost) * frmSell.SellPercent;
                                        decAmount += CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles) * frmSell.SellPercent;
                                        ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                                        objExpense.Create(decAmount, LanguageManager.GetString("String_ExpenseSoldVehicleGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                                        _objCharacter.ExpenseEntries.Add(objExpense);
                                        _objCharacter.Nuyen += decAmount;
                                    }
                                }
                            }
                        }
                    }
                }
                ScheduleCharacterUpdate();
                RefreshSelectedVehicle();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void tsAdvancedLifestyle_Click(object sender, EventArgs e)
        {
            Lifestyle objNewLifestyle = new Lifestyle(_objCharacter);
            frmSelectLifestyleAdvanced frmPickLifestyle = new frmSelectLifestyleAdvanced(objNewLifestyle, _objCharacter);
            frmPickLifestyle.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                return;

            objNewLifestyle.StyleType = LifestyleType.Advanced;

            _objCharacter.Lifestyles.Add(objNewLifestyle);

            TreeNode objNode = new TreeNode();
            objNode.Text = objNewLifestyle.Name;
            objNode.Tag = objNewLifestyle.InternalId;
            objNode.ContextMenuStrip = cmsAdvancedLifestyle;
            treLifestyles.Nodes[0].Nodes.Add(objNode);
            treLifestyles.Nodes[0].Expand();

            if (frmPickLifestyle.AddAgain)
                tsAdvancedLifestyle_Click(sender, e);

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsBoltHole_Click(object sender, EventArgs e)
        {
            Lifestyle objNewLifestyle = new Lifestyle(_objCharacter);
            frmSelectLifestyleAdvanced frmPickLifestyle = new frmSelectLifestyleAdvanced(objNewLifestyle, _objCharacter);
            frmPickLifestyle.StyleType = LifestyleType.BoltHole;
            frmPickLifestyle.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                return;

            objNewLifestyle.Months = 0;
            _objCharacter.Lifestyles.Add(objNewLifestyle);

            TreeNode objNode = new TreeNode();
            objNode.Text = objNewLifestyle.Name;
            objNode.Tag = objNewLifestyle.InternalId;
            objNode.ContextMenuStrip = cmsAdvancedLifestyle;
            treLifestyles.Nodes[0].Nodes.Add(objNode);
            treLifestyles.Nodes[0].Expand();

            if (frmPickLifestyle.AddAgain)
                tsAdvancedLifestyle_Click(sender, e);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsSafehouse_Click(object sender, EventArgs e)
        {
            Lifestyle objNewLifestyle = new Lifestyle(_objCharacter);
            frmSelectLifestyleAdvanced frmPickLifestyle = new frmSelectLifestyleAdvanced(objNewLifestyle, _objCharacter);
            frmPickLifestyle.StyleType = LifestyleType.Safehouse;
            frmPickLifestyle.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                return;

            objNewLifestyle.Months = 0;
            _objCharacter.Lifestyles.Add(objNewLifestyle);

            TreeNode objNode = new TreeNode();
            objNode.Text = objNewLifestyle.Name;
            objNode.Tag = objNewLifestyle.InternalId;
            objNode.ContextMenuStrip = cmsAdvancedLifestyle;
            treLifestyles.Nodes[0].Nodes.Add(objNode);
            treLifestyles.Nodes[0].Expand();

            if (frmPickLifestyle.AddAgain)
                tsAdvancedLifestyle_Click(sender, e);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsWeaponName_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected, then open the Select Accessory window.
            if (treWeapons.SelectedNode == null || treWeapons.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectWeaponName"), LanguageManager.GetString("MessageTitle_SelectWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treWeapons.SelectedNode.Level > 1)
                treWeapons.SelectedNode = treWeapons.SelectedNode.Parent;

            // Get the information for the currently selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objWeapon == null)
                return;

            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_WeaponName");
            frmPickText.DefaultString = objWeapon.WeaponName;
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            objWeapon.WeaponName = frmPickText.SelectedValue;
            treWeapons.SelectedNode.Text = objWeapon.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsGearName_Click(object sender, EventArgs e)
        {
            if (treGear.SelectedNode == null || treGear.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectGearName"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Get the information for the currently selected Gear.
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objGear == null)
                return;

            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_GearName");
            frmPickText.DefaultString = objGear.GearName;
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            objGear.GearName = frmPickText.SelectedValue;
            treGear.SelectedNode.Text = objGear.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsWeaponAddUnderbarrel_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected, then open the Select Accessory window.
            if (treWeapons.SelectedNode == null || treWeapons.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectWeaponAccessory"), LanguageManager.GetString("MessageTitle_SelectWeapon"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treWeapons.SelectedNode.Level > 1)
                treWeapons.SelectedNode = treWeapons.SelectedNode.Parent;

            // Get the information for the currently selected Weapon.
            foreach (Weapon objCharacterWeapon in _objCharacter.Weapons)
            {
                if (treWeapons.SelectedNode.Tag.ToString() == objCharacterWeapon.InternalId)
                {
                    if (objCharacterWeapon.InternalId == treWeapons.SelectedNode.Tag.ToString())
                    {
                        if (objCharacterWeapon.Cyberware)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CyberwareUnderbarrel"), LanguageManager.GetString("MessageTitle_WeaponUnderbarrel"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                    }
                }
            }

            // Locate the Weapon that is selected in the tree.
            Weapon objSelectedWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objSelectedWeapon == null)
                return;

            if (objSelectedWeapon.UnderbarrelWeapons.Count > 0)
            {
                return;
            }

            frmSelectWeapon frmPickWeapon = new frmSelectWeapon(_objCharacter);
            frmPickWeapon.LimitToCategories = "Underbarrel Weapons";
            frmPickWeapon.Mounts = objSelectedWeapon.AccessoryMounts;
            frmPickWeapon.Underbarrel = true;

            frmPickWeapon.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Open the Weapons XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("weapons.xml");

            XmlNode objXmlWeapon = objXmlDocument.SelectSingleNode("/chummer/weapons/weapon[id = \"" + frmPickWeapon.SelectedWeapon + "\"]");

            List<TreeNode> lstNodes = new List<TreeNode>();
            Weapon objWeapon = new Weapon(_objCharacter);
            objWeapon.Create(objXmlWeapon, lstNodes, cmsWeapon, cmsWeaponAccessory, objSelectedWeapon.UnderbarrelWeapons, cmsWeaponAccessoryGear);
            objWeapon.DiscountCost = frmPickWeapon.BlackMarketDiscount;
            objWeapon.Parent = objSelectedWeapon;
            if (objSelectedWeapon.AllowAccessory == false)
                objWeapon.AllowAccessory = false;

            decimal decCost = objWeapon.TotalCost;
            // Apply a markup if applicable.
            if (frmPickWeapon.Markup != 0)
            {
                decCost *= 1 + (frmPickWeapon.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objWeapon.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickWeapon.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickWeapon.AddAgain)
                        cmdAddWeapon_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeapon") + " " + objWeapon.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeapon, objWeapon.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            objSelectedWeapon.UnderbarrelWeapons.Add(objWeapon);
            
            foreach (TreeNode objLoopNode in lstNodes)
            {
                objLoopNode.ContextMenuStrip = cmsWeapon;
                treWeapons.SelectedNode.Nodes.Add(objLoopNode);
            }
            treWeapons.SelectedNode.Expand();
            treWeapons.SelectedNode = lstNodes[0];//

            ScheduleCharacterUpdate();
            RefreshSelectedWeapon();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsGearAddNexus_Click(object sender, EventArgs e)
        {
            treGear.SelectedNode = treGear.Nodes[0];

            frmSelectNexus frmPickNexus = new frmSelectNexus(_objCharacter);
            frmPickNexus.ShowDialog(this);

            if (frmPickNexus.DialogResult == DialogResult.Cancel)
                return;

            Gear objGear = frmPickNexus.SelectedNexus;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickNexus.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddGear, objGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            TreeNode nodNexus = new TreeNode();
            nodNexus.Text = objGear.Name;
            nodNexus.Tag = objGear.InternalId;
            nodNexus.ContextMenuStrip = cmsGear;

            foreach (Gear objChild in objGear.Children)
            {
                TreeNode nodModule = new TreeNode();
                nodModule.Text = objChild.Name;
                nodModule.Tag = objChild.InternalId;
                nodModule.ContextMenuStrip = cmsGear;
                nodNexus.Nodes.Add(nodModule);
                nodNexus.Expand();
            }

            treGear.Nodes[0].Nodes.Add(nodNexus);
            treGear.Nodes[0].Expand();

            _objCharacter.Gear.Add(objGear);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsGearButtonAddAccessory_Click(object sender, EventArgs e)
        {
            tsGearAddAsPlugin_Click(sender, e);
        }

        private void tsVehicleAddNexus_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectGearVehicle"), LanguageManager.GetString("MessageTitle_SelectGearVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treVehicles.SelectedNode.Level > 1)
                treVehicles.SelectedNode = treVehicles.SelectedNode.Parent;

            // Attempt to locate the selected Vehicle.
            Vehicle objSelectedVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            frmSelectNexus frmPickNexus = new frmSelectNexus(_objCharacter);
            frmPickNexus.ShowDialog(this);

            if (frmPickNexus.DialogResult == DialogResult.Cancel)
                return;

            Gear objGear = frmPickNexus.SelectedNexus;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickNexus.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseVehicleGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleGear, objGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            TreeNode nodNexus = new TreeNode();
            nodNexus.Text = objGear.Name;
            nodNexus.Tag = objGear.InternalId;
            nodNexus.ContextMenuStrip = cmsVehicleGear;

            foreach (Gear objChild in objGear.Children)
            {
                TreeNode nodModule = new TreeNode();
                nodModule.Text = objChild.Name;
                nodModule.Tag = objChild.InternalId;
                nodModule.ContextMenuStrip = cmsVehicleGear;
                nodNexus.Nodes.Add(nodModule);
                nodNexus.Expand();
            }

            treVehicles.SelectedNode.Nodes.Add(nodNexus);
            treVehicles.SelectedNode.Expand();

            objSelectedVehicle.Gear.Add(objGear);

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsUndoKarmaExpense_Click(object sender, EventArgs e)
        {
            ListViewItem objItem;

            if (lstKarma.SelectedItems != null && lstKarma.SelectedItems.Count > 0)
            {
                objItem = lstKarma.SelectedItems[0];
            }
            else
            {
                return;
            }

            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objItem = lstKarma.SelectedItems[0];

            // Find the selected Karma Expense.
            foreach (ExpenseLogEntry objCharacterEntry in _objCharacter.ExpenseEntries)
            {
                if (objCharacterEntry.InternalId == objItem.SubItems[3].Text)
                {
                    objEntry = objCharacterEntry;
                    break;
                }
            }

            if (objEntry.Undo == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_UndoNoHistory"), LanguageManager.GetString("MessageTitle_NoUndoHistory"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            else if (objEntry.Undo.KarmaType == KarmaExpenseType.ImproveInitiateGrade)
            {
                // Get the grade of the item we're undoing and make sure it's the highest grade
                int intMaxGrade = 0;
                foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                {
                    intMaxGrade = Math.Max(intMaxGrade, objGrade.Grade);
                }
                foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                {
                    if (objGrade.InternalId == objEntry.Undo.ObjectId)
                    {
                        if (objGrade.Grade < intMaxGrade)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_UndoNotHighestGrade"), LanguageManager.GetString("MessageTitle_NotHighestGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                        break;
                    }
                }
                if (MessageBox.Show(LanguageManager.GetString("Message_UndoExpense"), LanguageManager.GetString("MessageTitle_UndoExpense"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }
            else
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_UndoExpense"), LanguageManager.GetString("MessageTitle_UndoExpense"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }

            switch (objEntry.Undo.KarmaType)
            {
                case KarmaExpenseType.ImproveAttribute:
                    _objCharacter.GetAttribute(objEntry.Undo.ObjectId).Degrade(1);
                    break;
                case KarmaExpenseType.AddPowerPoint:
                    _objCharacter.MysticAdeptPowerPoints -= 1;
                    break;
                case KarmaExpenseType.AddQuality:
                    // Locate the Quality that was added.
                    foreach (Quality objQuality in _objCharacter.Qualities)
                    {
                        if (objQuality.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove any Improvements that it created.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Quality, objQuality.InternalId);
                            
                            // Remove the Quality from thc character.
                            _objCharacter.Qualities.Remove(objQuality);

                            // Remove any Weapons created by the Quality if applicable.
                            if (objQuality.WeaponID != Guid.Empty.ToString())
                            {
                                List<string> lstNodesToRemoveIds = new List<string>();
                                foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objQuality.InternalId))
                                {
                                    lstNodesToRemoveIds.Add(objWeapon.InternalId);
                                    CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                                    // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                                    if (objWeapon.Parent != null)
                                        objWeapon.Parent.Children.Remove(objWeapon);
                                    else
                                        _objCharacter.Weapons.Remove(objWeapon);
                                }
                                foreach (string strNodeId in lstNodesToRemoveIds)
                                {
                                    // Remove the Weapons from the TreeView.
                                    CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                                }
                            }

                            // If entry already exists in tree, just update the rating
                            if (_objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objQuality.QualityId && objExistingQuality.Extra == objQuality.Extra))
                            {
                                RefreshQualityNames(treQualities);
                            }
                            else
                            {
                                // Remove the Quality from the Tree.
                                foreach (TreeNode objNode in treQualities.Nodes[0].Nodes)
                                {
                                    if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                    {
                                        objNode.Remove();
                                        break;
                                    }
                                }
                                foreach (TreeNode objNode in treQualities.Nodes[1].Nodes)
                                {
                                    if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                    {
                                        objNode.Remove();
                                        break;
                                    }
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.AddSpell:
                    // Locate the Spell that was added.
                    foreach (Spell objSpell in _objCharacter.Spells)
                    {
                        if (objSpell.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove any Improvements that it created.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Spell, objSpell.InternalId);

                            // Remove the Spell from the character.
                            _objCharacter.Spells.Remove(objSpell);

                            // Remove the Spell from the Tree.
                            for (int i = 0; i <= treSpells.Nodes.Count; i++)
                            {
                                foreach (TreeNode objNode in treSpells.Nodes[i].Nodes)
                                {
                                    if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                    {
                                        objNode.Remove();
                                        break;
                                    }
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.SkillSpec:  //I am resonable sure those 2 are the same. Was written looking at old AddSpecialization code
                case KarmaExpenseType.AddSpecialization:
                    {
                        Skill ContainingSkill = _objCharacter.SkillsSection.KnowledgeSkills.FirstOrDefault(x => x.Specializations.Any(s => s.InternalId == objEntry.Undo.ObjectId));
                        if (ContainingSkill == null)
                            ContainingSkill = _objCharacter.SkillsSection.Skills.FirstOrDefault(x => x.Specializations.Any(s => s.InternalId == objEntry.Undo.ObjectId));

                        if (ContainingSkill != null)
                            ContainingSkill.Specializations.Remove(ContainingSkill.Specializations.FirstOrDefault(x => x.InternalId == objEntry.Undo.ObjectId));
                    }
                    break;
                case KarmaExpenseType.ImproveSkillGroup:
                    // Locate the Skill Group that was affected.
                    SkillGroup group = _objCharacter.SkillsSection.SkillGroups.FirstOrDefault(g => g.Id.ToString() == objEntry.Undo.ObjectId);
                    if (group != null) group.Karma--;
                    break;
                case KarmaExpenseType.AddSkill:
                case KarmaExpenseType.ImproveSkill:
                    // Locate the Skill that was affected.
                    Skill skill = _objCharacter.SkillsSection.Skills.FirstOrDefault(s => s.Id.ToString() == objEntry.Undo.ObjectId) ??
                                  _objCharacter.SkillsSection.KnowledgeSkills.FirstOrDefault(s => s.Id.ToString() == objEntry.Undo.ObjectId);

                    if (skill != null)
                    {
                        skill.Karma--;
                    }

                    break;
                case KarmaExpenseType.AddMetamagic:
                    // Locate the Metamagic that was affected.
                    foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                    {
                        if (objMetamagic.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove any Improvements created by the Metamagic.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                            
                            // Remove the Metamagic from the character.
                            _objCharacter.Metamagics.Remove(objMetamagic);

                            // Remove the Metamagic from the Tree.
                            foreach (TreeNode objNode in treMetamagic.Nodes)
                            {
                                if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                {
                                    objNode.Remove();
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.ImproveInitiateGrade:
                    // Locate the Initiate Grade that was affected.
                    foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                    {
                        if (objGrade.InternalId == objEntry.Undo.ObjectId)
                        {
                            if (_objCharacter.MAGEnabled)
                            {
                                // Remove any Improvements created by the Grade.
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Initiation, objGrade.InternalId);

                                List<Art> lstArts = new List<Art>();
                                foreach (Art objArt in _objCharacter.Arts)
                                {
                                    if (objArt.Grade == objGrade.Grade)
                                    {
                                        lstArts.Add(objArt);
                                    }
                                }
                                foreach (Art objArt in lstArts)
                                {
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Art, objArt.InternalId);
                                    _objCharacter.Arts.Remove(objArt);
                                }

                                List<Metamagic> lstMetamagic = new List<Metamagic>();
                                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                                {
                                    if (objMetamagic.Grade == objGrade.Grade)
                                    {
                                        lstMetamagic.Add(objMetamagic);
                                    }
                                }
                                foreach (Metamagic objMetamagic in lstMetamagic)
                                {
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                                    _objCharacter.Metamagics.Remove(objMetamagic);
                                }

                                List<Spell> lstSpells = new List<Spell>();
                                foreach (Spell objSpell in _objCharacter.Spells)
                                {
                                    if (objSpell.Grade == objGrade.Grade)
                                    {
                                        lstSpells.Add(objSpell);
                                    }
                                }
                                foreach (Spell objSpell in lstSpells)
                                {
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Spell, objSpell.InternalId);
                                    _objCharacter.Spells.Remove(objSpell);
                                }

                                // Remove the Grade from the character.
                                _objCharacter.InitiationGrades.Remove(objGrade);
                                _objCharacter.InitiateGrade -= 1;

                                // Update any Metamagic Improvements the character might have.
                                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                                {
                                    if (objMetamagic.Bonus != null)
                                    {
                                        // If the Bonus contains "Rating", remove the existing Improvement and create new ones.
                                        if (objMetamagic.Bonus.InnerXml.Contains("Rating"))
                                        {
                                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId, objMetamagic.Bonus, false, _objCharacter.InitiateGrade, objMetamagic.DisplayNameShort);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                // Remove any Improvements created by the Grade.
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Submersion, objGrade.InternalId);

                                // Remove the Grade from the character.
                                _objCharacter.InitiationGrades.Remove(objGrade);
                                _objCharacter.SubmersionGrade -= 1;

                                List<Metamagic> lstMetamagic = new List<Metamagic>();
                                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                                {
                                    if (objMetamagic.Grade == objGrade.Grade)
                                    {
                                        lstMetamagic.Add(objMetamagic);
                                    }
                                }
                                foreach (Metamagic objMetamagic in lstMetamagic)
                                {
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                                    _objCharacter.Metamagics.Remove(objMetamagic);
                                }
                            }

                            // Refresh the Initiation Grade List.
                            UpdateInitiationGradeTree();
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.AddMartialArt:
                    // Locate the Martial Art that was affected.
                    foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
                    {
                        if (objMartialArt.Name == objEntry.Undo.ObjectId)
                        {
                            // Remove the Martial Art from the character.
                            _objCharacter.MartialArts.Remove(objMartialArt);

                            // Remove the Martial Art from the Tree.
                            foreach (TreeNode objNode in treMartialArts.Nodes[0].Nodes)
                            {
                                if (objNode.Text == objEntry.Undo.ObjectId)
                                {
                                    objNode.Remove();
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.AddMartialArtManeuver:
                    // Locate the Martial Art Maneuver that was affected.
                    foreach (MartialArtManeuver objManeuver in _objCharacter.MartialArtManeuvers)
                    {
                        if (objManeuver.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove the Maneuver from the character.
                            _objCharacter.MartialArtManeuvers.Remove(objManeuver);

                            // Remove the Maneuver from the Tree.
                            foreach (TreeNode objNode in treMartialArts.Nodes[1].Nodes)
                            {
                                if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                {
                                    objNode.Remove();
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.AddComplexForm:
                    // Locate the Complex Form that was affected.
                    foreach (ComplexForm objProgram in _objCharacter.ComplexForms)
                    {
                        if (objProgram.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove any Improvements created by the Complex Form.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ComplexForm, objProgram.InternalId);

                            // Remove the Complex Form from the character.
                            _objCharacter.ComplexForms.Remove(objProgram);

                            // Remove the Complex Form from the Tree.
                            foreach (TreeNode objParent in treComplexForms.Nodes)
                            {
                                foreach (TreeNode objNode in objParent.Nodes)
                                {
                                    if (objNode.Tag.ToString() == objEntry.Undo.ObjectId)
                                    {
                                        objNode.Remove();
                                        break;
                                    }
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.BindFocus:
                    // Locate the Focus that was bound.
                    foreach (Focus objFocus in _objCharacter.Foci)
                    {
                        if (objFocus.GearId == objEntry.Undo.ObjectId)
                        {
                            foreach (TreeNode objNode in treFoci.Nodes)
                            {
                                if (objFocus.GearId == objNode.Tag.ToString())
                                {
                                    _blnSkipRefresh = true;
                                    objNode.Checked = false;
                                    _blnSkipRefresh = false;
                                    break;
                                }
                            }
                            _objCharacter.Foci.Remove(objFocus);
                            break;
                        }
                    }

                    // Locate the Stacked Focus that was bound.
                    foreach (StackedFocus objStack in _objCharacter.StackedFoci)
                    {
                        if (objStack.InternalId == objEntry.Undo.ObjectId)
                        {
                            foreach (TreeNode objNode in treFoci.Nodes)
                            {
                                if (objStack.InternalId == objNode.Tag.ToString())
                                {
                                    _blnSkipRefresh = true;
                                    objNode.Checked = false;
                                    objStack.Bonded = false;
                                    _blnSkipRefresh = false;
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    break;
                case KarmaExpenseType.JoinGroup:
                    // Remove the character from their Group.
                    _blnSkipRefresh = true;
                    chkJoinGroup.Checked = false;
                    _objCharacter.GroupMember = false;
                    _blnSkipRefresh = false;
                    break;
                case KarmaExpenseType.LeaveGroup:
                    // Put the character back in their Group.
                    _blnSkipRefresh = true;
                    chkJoinGroup.Checked = true;
                    _objCharacter.GroupMember = true;
                    _blnSkipRefresh = false;
                    break;
                case KarmaExpenseType.RemoveQuality:
                    // Add the Quality back to the character.
                    TreeNode objQualityNode = new TreeNode();
                    List<Weapon> objWeapons = new List<Weapon>();
                    List<TreeNode> objWeaponNodes = new List<TreeNode>();

                    Quality objAddQuality = new Quality(_objCharacter);
                    XmlDocument objXmlQualityDocument = XmlManager.Load("qualities.xml");
                    XmlNode objXmlQualityNode = objXmlQualityDocument.SelectSingleNode("/chummer/qualities/quality[name = \"" + objEntry.Undo.ObjectId + "\"]");
                    objAddQuality.Create(objXmlQualityNode, _objCharacter, QualitySource.Selected, objQualityNode, objWeapons, objWeaponNodes, objEntry.Undo.Extra);

                    objQualityNode.ContextMenuStrip = cmsQuality;

                    // If entry already exists in tree, just update the rating
                    if (_objCharacter.Qualities.Any(objExistingQuality => objExistingQuality.QualityId == objAddQuality.QualityId && objExistingQuality.Extra == objAddQuality.Extra))
                    {
                        RefreshQualityNames(treQualities);
                    }
                    else
                    {
                        // Add the Quality to the appropriate parent node.
                        if (objAddQuality.Type == QualityType.Positive)
                        {
                            treQualities.Nodes[0].Nodes.Add(objQualityNode);
                            treQualities.Nodes[0].Expand();
                        }
                        else
                        {
                            treQualities.Nodes[1].Nodes.Add(objQualityNode);
                            treQualities.Nodes[1].Expand();
                        }
                    }
                    _objCharacter.Qualities.Add(objAddQuality);

                    // Add any created Weapons to the character.
                    foreach (Weapon objWeapon in objWeapons)
                        _objCharacter.Weapons.Add(objWeapon);

                    // Create the Weapon Node if one exists.
                    foreach (TreeNode objWeaponNode in objWeaponNodes)
                    {
                        objWeaponNode.ContextMenuStrip = cmsWeapon;
                        treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                        treWeapons.Nodes[0].Expand();
                    }

                    treQualities.SortCustom();
                    break;
                case KarmaExpenseType.ManualAdd:
                case KarmaExpenseType.ManualSubtract:
                case KarmaExpenseType.QuickeningMetamagic:
                    break;
                case KarmaExpenseType.AddCritterPower:
                    foreach (CritterPower objPower in _objCharacter.CritterPowers.Where(objPower => objPower.InternalId == objEntry.Undo.ObjectId))
                    {
                        _objCharacter.CritterPowers.Remove(objPower);
                    }
                    break;

            }
            // Refund the Karma amount and remove the Expense Entry.
            _objCharacter.Karma -= decimal.ToInt32(objEntry.Amount);
            _objCharacter.ExpenseEntries.Remove(objEntry);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsUndoNuyenExpense_Click(object sender, EventArgs e)
        {
            ListViewItem objItem = new ListViewItem();

            if (lstNuyen.SelectedItems != null && lstNuyen.SelectedItems.Count > 0)
            {
                objItem = lstNuyen.SelectedItems[0];
            }
            else
            {
                return;
            }

            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objItem = lstNuyen.SelectedItems[0];

            // Find the selected Nuyen Expense.
            foreach (ExpenseLogEntry objCharacterEntry in _objCharacter.ExpenseEntries)
            {
                if (objCharacterEntry.InternalId == objItem.SubItems[3].Text)
                {
                    objEntry = objCharacterEntry;
                    break;
                }
            }

            if (objEntry.Undo == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_UndoNoHistory"), LanguageManager.GetString("MessageTitle_NoUndoHistory"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            else if (objEntry.Undo.KarmaType == KarmaExpenseType.ImproveInitiateGrade)
            {
                // Get the grade of the item we're undoing and make sure it's the highest grade
                int intMaxGrade = 0;
                foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                {
                    intMaxGrade = Math.Max(intMaxGrade, objGrade.Grade);
                }
                foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
                {
                    if (objGrade.InternalId == objEntry.Undo.ObjectId)
                    {
                        if (objGrade.Grade < intMaxGrade)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_UndoNotHighestGrade"), LanguageManager.GetString("MessageTitle_NotHighestGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                        break;
                    }
                }
                if (MessageBox.Show(LanguageManager.GetString("Message_UndoExpense"), LanguageManager.GetString("MessageTitle_UndoExpense"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }
            else
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_UndoExpense"), LanguageManager.GetString("MessageTitle_UndoExpense"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return;
            }

            switch (objEntry.Undo.NuyenType)
            {
                case NuyenExpenseType.AddCyberware:
                    // Locate the Cyberware that was added.
                    //int intOldPenalty = 0;
                    //int intNewPenalty = 0;
                    Cyberware objAddCyberware = _objCharacter.Cyberware.DeepFirstOrDefault(x => x.Children, x => x.InternalId == objEntry.Undo.ObjectId);
                    if (objAddCyberware != null)
                    {
                        CommonFunctions.DeleteCyberware(_objCharacter, objAddCyberware, treWeapons, treVehicles);

                        // Determine the character's Essence penalty before removing the Cyberware.
                        //intOldPenalty = _objCharacter.EssencePenalty;
                        // Remove the Cyberware.
                        if (objAddCyberware.Parent == null)
                            _objCharacter.Cyberware.Remove(objAddCyberware);
                        else
                            objAddCyberware.Parent.Children.Remove(objAddCyberware);
                        // Determine the character's Essence penalty after removing the Cyberware.
                        //intNewPenalty = _objCharacter.EssencePenalty;

                        // Restore the character's MAG/RES if they have it.
                        //if (!_objCharacter.OverrideSpecialAttributeEssenceLoss && !_objCharacter.OverrideSpecialAttributeEssenceLoss)
                        //{
                        //    if (intOldPenalty != intNewPenalty)
                        //    {
                        //        if (_objCharacter.MAGEnabled)
                        //            _objCharacter.MAG.Value += (intOldPenalty - intNewPenalty);
                        //        if (_objCharacter.RESEnabled)
                        //            _objCharacter.RES.Value += (intOldPenalty - intNewPenalty);
                        //    }
                        //}

                        // Remove the item from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treCyberware)?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddGear:
                    // Locate the Gear that was added.
                    //If the gear was already deleted manually we will not be able to locate it here
                    Gear objGear = CommonFunctions.DeepFindById(objEntry.Undo.ObjectId, _objCharacter.Gear);
                    if (objGear == null)
                        break;
                    objGear.Quantity -= objEntry.Undo.Qty;
                    TreeNode objAddGearNode = CommonFunctions.FindNode(objGear.InternalId, treGear);

                    if (objGear.Quantity <= 0)
                    {
                        if (objGear.Parent != null)
                        {
                            objGear.Parent.Children.Remove(objGear);
                            Commlink objCommlink = objGear.Parent as Commlink;
                            if (objCommlink?.CanSwapAttributes == true)
                            {
                                objCommlink.RefreshCyberdeckArray();
                            }
                        }
                        else
                            _objCharacter.Gear.Remove(objGear);

                        CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                        objAddGearNode.Remove();
                    }
                    else
                    {
                        objAddGearNode.Text = objGear.DisplayName;
                    }

                    CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
                    break;
                case NuyenExpenseType.AddVehicle:
                    // Locate the Vehicle that was added.
                    foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                    {
                        if (objVehicle.InternalId == objEntry.Undo.ObjectId)
                        {
                            // Remove the Vehicle.
                            _objCharacter.Vehicles.Remove(objVehicle);

                            foreach (Gear objLoopGear in objVehicle.Gear)
                            {
                                CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles);
                            }
                            foreach (Weapon objLoopWeapon in objVehicle.Weapons)
                            {
                                CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                            }
                            foreach (VehicleMod objLoopMod in objVehicle.Mods)
                            {
                                foreach (Weapon objLoopWeapon in objLoopMod.Weapons)
                                {
                                    CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                                }
                                foreach (Cyberware objLoopCyberware in objLoopMod.Cyberware)
                                {
                                    CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles);
                                }
                            }

                            CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles)?.Remove();
                        }
                    }
                    break;
                case NuyenExpenseType.AddVehicleMod:
                    // Locate the Vehicle Mod that was added.
                    Vehicle objAddVehicleModVehicle = null;
                    VehicleMod objAddVehicleMod = CommonFunctions.FindVehicleMod(objEntry.Undo.ObjectId, _objCharacter.Vehicles, out objAddVehicleModVehicle);
                    if (objAddVehicleMod != null)
                    {
                        // Check for Improved Sensor bonus.
                        if (objAddVehicleMod.Bonus?["improvesensor"] != null || (objAddVehicleMod.WirelessOn && objAddVehicleMod.WirelessBonus?["improvesensor"] != null))
                        {
                            ChangeVehicleSensor(objAddVehicleModVehicle, false);
                        }

                        foreach (Weapon objLoopWeapon in objAddVehicleMod.Weapons)
                        {
                            CommonFunctions.DeleteWeapon(_objCharacter, objLoopWeapon, treWeapons, treVehicles);
                        }
                        foreach (Cyberware objLoopCyberware in objAddVehicleMod.Cyberware)
                        {
                            CommonFunctions.DeleteCyberware(_objCharacter, objLoopCyberware, treWeapons, treVehicles);
                        }

                        // Remove the Vehicle Mod.
                        objAddVehicleModVehicle.Mods.Remove(objAddVehicleMod);

                        // Remove the Vehicle Mod from the tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles)?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddVehicleGear:
                    // Locate the Gear that was added.
                    Vehicle objAddVehicleGearVehicle = null;
                    WeaponAccessory objAddVehicleGearWeaponAccessory = null;
                    Cyberware objAddVehicleGearCyberware = null;
                    Gear objAddVehicleGear = CommonFunctions.FindVehicleGear(objEntry.Undo.ObjectId, _objCharacter.Vehicles, out objAddVehicleGearVehicle, out objAddVehicleGearWeaponAccessory, out objAddVehicleGearCyberware);
                    if (objAddVehicleGear != null)
                    {
                        // Deduct the Qty from the Gear.
                        objAddVehicleGear.Quantity -= objEntry.Undo.Qty;
                        TreeNode objAddVehicleGearNode = CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles.Nodes[0]);

                        // Remove the Gear if its Qty has been reduced to 0.
                        if (objAddVehicleGear.Quantity <= 0)
                        {
                            if (objAddVehicleGear.Parent == null)
                            {
                                if (objAddVehicleGearWeaponAccessory != null)
                                    objAddVehicleGearWeaponAccessory.Gear.Remove(objAddVehicleGear);
                                else if (objAddVehicleGearCyberware != null)
                                    objAddVehicleGearCyberware.Gear.Remove(objAddVehicleGear);
                                else
                                    objAddVehicleGearVehicle.Gear.Remove(objAddVehicleGear);
                            }
                            else
                            {
                                objAddVehicleGear.Parent.Children.Remove(objAddVehicleGear);
                                Commlink objCommlink = objAddVehicleGear.Parent as Commlink;
                                if (objCommlink?.CanSwapAttributes == true)
                                {
                                    objCommlink.RefreshCyberdeckArray();
                                }
                            }

                            CommonFunctions.DeleteGear(_objCharacter, objAddVehicleGear, treWeapons, treVehicles);
                            objAddVehicleGearNode.Remove();
                        }
                        else
                        {
                            objAddVehicleGearNode.Text = objAddVehicleGear.DisplayName;
                        }
                    }
                    break;
                case NuyenExpenseType.AddVehicleWeapon:
                    // Locate the Weapon that was added.
                    Weapon objAddVehicleWeapon = CommonFunctions.FindVehicleWeapon(objEntry.Undo.ObjectId, _objCharacter.Vehicles, out Vehicle objAddVehicleWeaponVehicle, out WeaponMount wm, out VehicleMod vm);
                    if (objAddVehicleWeapon != null)
                    {
                        CommonFunctions.DeleteWeapon(_objCharacter, objAddVehicleWeapon, treWeapons, treVehicles);

                        // Remove the Weapon.
                        if (wm != null)
                            wm.Weapons.Remove(objAddVehicleWeapon);
                        else
                            objAddVehicleWeaponVehicle.Weapons.Remove(objAddVehicleWeapon);

                        // Remove the Weapon from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles)?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddVehicleWeaponAccessory:
                    // Locate the Weapon Accessory that was added.
                    Weapon objAddVehicleWeaponAccessoryWeapon = null;
                    WeaponAccessory objAddVehicleWeaponAccessory = CommonFunctions.FindVehicleWeaponAccessory(objEntry.Undo.ObjectId, _objCharacter.Vehicles, out objAddVehicleWeaponAccessoryWeapon);
                    if (objAddVehicleWeaponAccessory != null)
                    {
                        // Remove the Weapon Accessory.
                        objAddVehicleWeaponAccessoryWeapon.WeaponAccessories.Remove(objAddVehicleWeaponAccessory);

                        foreach(Gear objLoopGear in objAddVehicleWeaponAccessory.Gear)
                            CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles);

                        // Remove the Weapon Accessory from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles)?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddArmor:
                    // Locate the Armor that was added.
                    Armor objAddArmor = CommonFunctions.FindByIdWithNameCheck(objEntry.Undo.ObjectId, _objCharacter.Armor);

                    if (objAddArmor != null)
                    {
                        // Remove the Improvements for any child items.
                        foreach (ArmorMod objMod in objAddArmor.ArmorMods)
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId);

                            // Remove the Cyberweapon created by the Mod if applicable.
                            if (objMod.WeaponID != Guid.Empty.ToString())
                            {
                                // Remove the Weapons from the Character.
                                List<string> lstNodesToRemoveIds = new List<string>();
                                foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objMod.InternalId))
                                {
                                    lstNodesToRemoveIds.Add(objWeapon.InternalId);
                                    CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                                    // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                                    if (objWeapon.Parent != null)
                                        objWeapon.Parent.UnderbarrelWeapons.Remove(objWeapon);
                                    else
                                        _objCharacter.Weapons.Remove(objWeapon);
                                }
                                foreach (string strNodeId in lstNodesToRemoveIds)
                                {
                                    // Remove the Weapons from the TreeView.
                                    CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                                }
                            }
                        }
                        foreach (Gear objLoopGear in objAddArmor.Gear)
                        {
                            CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles);
                        }

                        // Remove the Improvements for the Armor.
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objAddArmor.InternalId);

                        // Remove the Armor from the character.
                        _objCharacter.Armor.Remove(objAddArmor);

                        // Remove the Armor from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treArmor)?.Remove();
                    }

                    break;
                case NuyenExpenseType.AddArmorMod:
                    // Locate the Armor Mod that was added.
                    ArmorMod objAddArmorMod = CommonFunctions.FindArmorMod(objEntry.Undo.ObjectId, _objCharacter.Armor);
                    if (objAddArmorMod != null)
                    {
                        // Remove the Improtements for the Armor Mod.
                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objAddArmorMod.InternalId);

                        // Remove the Armor Mod from the Armor.
                        objAddArmorMod.Parent?.ArmorMods.Remove(objAddArmorMod);

                        // Remove the Cyberweapon created by the Mod if applicable.
                        if (objAddArmorMod.WeaponID != Guid.Empty.ToString())
                        {
                            // Remove the Weapons from the Character.
                            List<string> lstNodesToRemoveIds = new List<string>();
                            foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objAddArmorMod.InternalId))
                            {
                                lstNodesToRemoveIds.Add(objWeapon.InternalId);
                                CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                                // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                                if (objWeapon.Parent != null)
                                    objWeapon.Parent.Children.Remove(objWeapon);
                                else
                                    _objCharacter.Weapons.Remove(objWeapon);
                            }
                            foreach (string strNodeId in lstNodesToRemoveIds)
                            {
                                // Remove the Weapons from the TreeView.
                                CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                            }
                        }

                        // Remove the Armor Mod from the Tree.
                        CommonFunctions.FindNode(objAddArmorMod.InternalId, treArmor.Nodes[0])?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddWeapon:
                    // Locate the Weapon that was added.
                    Weapon objAddWeapon = CommonFunctions.DeepFindById(objEntry.Undo.ObjectId, _objCharacter.Weapons);
                    if (objAddWeapon != null)
                    {
                        CommonFunctions.DeleteWeapon(_objCharacter, objAddWeapon, treWeapons, treVehicles);
                        // Remove the Weapn from the character.
                        if (objAddWeapon.Parent != null)
                            objAddWeapon.Parent.Children.Remove(objAddWeapon);
                        else
                            _objCharacter.Weapons.Remove(objAddWeapon);

                        // Remove the Weapon from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treWeapons.Nodes[0])?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddWeaponAccessory:
                    // Locate the Weapon Accessory that was added.
                    WeaponAccessory objAddWeaponAccessory = CommonFunctions.FindWeaponAccessory(objEntry.Undo.ObjectId, _objCharacter.Weapons);
                    if (objAddWeaponAccessory != null)
                    {
                        // Remove the Weapon Accessory.
                        objAddWeaponAccessory.Parent.WeaponAccessories.Remove(objAddWeaponAccessory);

                        foreach (Gear objLoopGear in objAddWeaponAccessory.Gear)
                        {
                            CommonFunctions.DeleteGear(_objCharacter, objLoopGear, treWeapons, treVehicles);
                        }

                        // Remove the Weapon Accessory from the tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treWeapons.Nodes[0])?.Remove();
                    }
                    break;
                case NuyenExpenseType.IncreaseLifestyle:
                    // Locate the Lifestyle that was increased.
                    foreach (Lifestyle objLifestyle in _objCharacter.Lifestyles)
                    {
                        if (objLifestyle.Name == objEntry.Undo.ObjectId)
                        {
                            objLifestyle.Months -= 1;
                            RefreshSelectedLifestyle();
                            break;
                        }
                    }
                    break;
                case NuyenExpenseType.AddArmorGear:
                    // Locate the Armor Gear that was added.
                    Armor objFoundArmor = null;
                    ArmorMod objFoundArmorMod = null;
                    Gear objAddArmorGear = CommonFunctions.FindArmorGear(objEntry.Undo.ObjectId, _objCharacter.Armor, out objFoundArmor, out objFoundArmorMod);
                    if (objAddArmorGear != null)
                    {
                        // Deduct the Qty from the Gear.
                        objAddArmorGear.Quantity -= objEntry.Undo.Qty;
                        TreeNode objNode = CommonFunctions.FindNode(objEntry.Undo.ObjectId, treWeapons.Nodes[0]);
                        if (objNode != null)
                        {
                            // Remove the Node if its Qty has been reduced to 0.
                            if (objAddArmorGear.Quantity <= 0)
                                objNode.Remove();
                            else
                                objNode.Text = objAddArmorGear.DisplayName;
                        }

                        // Remove the Gear if its Qty has been reduced to 0.
                        if (objAddArmorGear.Quantity <= 0)
                        {
                            // Remove any Improvements created by the Gear.
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objAddArmorGear.InternalId);
                            if (objFoundArmorMod != null)
                                objFoundArmorMod.Gear.Remove(objAddArmorGear);
                            else
                                objFoundArmor.Gear.Remove(objAddArmorGear);

                            // Remove any Weapons created by the Gear.
                            List<string> lstNodesToRemoveIds = new List<string>();
                            foreach (Weapon objWeapon in _objCharacter.Weapons.DeepWhere(x => x.Children, x => x.ParentID == objAddArmorGear.InternalId))
                            {
                                lstNodesToRemoveIds.Add(objWeapon.InternalId);
                                CommonFunctions.DeleteWeapon(_objCharacter, objWeapon, treWeapons, treVehicles);
                                // We can remove here because GetAllDescendants creates a new IEnumerable, different from these two
                                if (objWeapon.Parent != null)
                                    objWeapon.Parent.Children.Remove(objWeapon);
                                else
                                    _objCharacter.Weapons.Remove(objWeapon);
                            }
                            foreach (string strNodeId in lstNodesToRemoveIds)
                            {
                                // Remove the Weapons from the TreeView.
                                CommonFunctions.FindNode(strNodeId, treWeapons)?.Remove();
                            }
                        }
                    }
                    break;
                case NuyenExpenseType.AddVehicleModCyberware:
                    // Locate the Cyberware that was added.
                    VehicleMod objAddVehicleModCyberwareMod = null;
                    Cyberware objAddVehicleModCyberware = CommonFunctions.FindVehicleCyberware(objEntry.Undo.ObjectId, _objCharacter.Vehicles, out objAddVehicleModCyberwareMod);
                    if (objAddVehicleModCyberware != null)
                    {
                        CommonFunctions.DeleteCyberware(_objCharacter, objAddVehicleModCyberware, treWeapons, treVehicles);
                        // Remove the Cyberware.
                        objAddVehicleModCyberwareMod.Cyberware.Remove(objAddVehicleModCyberware);

                        // Remove the Cyberware from the Tree.
                        CommonFunctions.FindNode(objEntry.Undo.ObjectId, treVehicles.Nodes[0])?.Remove();
                    }
                    break;
                case NuyenExpenseType.AddCyberwareGear:
                    // Locate the Gear that was added.
                    Cyberware objFoundCyberware = null;
                    Gear objFoundGear = CommonFunctions.FindCyberwareGear(objEntry.Undo.ObjectId, _objCharacter.Cyberware.GetAllDescendants(x => x.Children), out objFoundCyberware);
                    CommonFunctions.DeleteGear(_objCharacter, objFoundGear, treWeapons, treVehicles);
                    if (objFoundGear.Parent == null)
                        objFoundCyberware.Gear.Remove(objFoundGear);
                    else
                    {
                        objFoundGear.Parent.Children.Remove(objFoundGear);
                        Commlink objCommlink = objFoundGear.Parent as Commlink;
                        if (objCommlink?.CanSwapAttributes == true)
                        {
                            objCommlink.RefreshCyberdeckArray();
                        }
                    }
                    CommonFunctions.FindNode(objFoundGear.InternalId, treCyberware)?.Remove();
                    break;
                case NuyenExpenseType.AddWeaponGear:
                    // Locate the Gear that was added.
                    WeaponAccessory objFoundAccessory = null;
                    Gear objFoundAccGear = CommonFunctions.FindWeaponGear(objEntry.Undo.ObjectId, _objCharacter.Weapons, out objFoundAccessory);
                    CommonFunctions.DeleteGear(_objCharacter, objFoundAccGear, treWeapons, treVehicles);
                    if (objFoundAccGear.Parent == null)
                        objFoundAccessory.Gear.Remove(objFoundAccGear);
                    else
                    {
                        objFoundAccGear.Parent.Children.Remove(objFoundAccGear);
                        Commlink objCommlink = objFoundAccGear.Parent as Commlink;
                        if (objCommlink?.CanSwapAttributes == true)
                        {
                            objCommlink.RefreshCyberdeckArray();
                        }
                    }
                    CommonFunctions.FindNode(objFoundAccGear.InternalId, treWeapons)?.Remove();
                    break;
                case NuyenExpenseType.ManualAdd:
                case NuyenExpenseType.ManualSubtract:
                    break;
            }
            // Refund the Nuyen amount and remove the Expense Entry.
            _objCharacter.Nuyen -= objEntry.Amount;
            _objCharacter.ExpenseEntries.Remove(objEntry);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsEditNuyenExpense_Click(object sender, EventArgs e)
        {
            cmdNuyenEdit_Click(sender, e);
        }

        private void tsEditKarmaExpense_Click(object sender, EventArgs e)
        {
            cmdKarmaEdit_Click(sender, e);
        }

        private void tsAddArmorGear_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treArmor.SelectedNode == null || treArmor.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectArmor"), LanguageManager.GetString("MessageTitle_SelectArmor"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Select the root Gear node then open the Select Gear window.
            bool blnAddAgain = PickArmorGear(true);
            if (blnAddAgain)
                tsAddArmorGear_Click(sender, e);
        }

        private void tsArmorGearAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treArmor.SelectedNode == null || treArmor.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectArmor"), LanguageManager.GetString("MessageTitle_SelectArmor"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Make sure the selected item is another piece of Gear.
            ArmorMod objMod = null;
            Gear objGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            if (objGear == null)
            {
                objMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                if (objMod == null || string.IsNullOrEmpty(objMod.GearCapacity))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_SelectArmor"), LanguageManager.GetString("MessageTitle_SelectArmor"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
            }

            bool blnAddAgain = PickArmorGear(objMod != null);
            if (blnAddAgain)
                tsArmorGearAddAsPlugin_Click(sender, e);
        }

        private void tsArmorNotes_Click(object sender, EventArgs e)
        {
            if (treArmor.SelectedNode == null)
                return;
            Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                if (objArmor != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objArmor.Notes;
                    string strOldValue = objArmor.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objArmor.Notes = frmItemNotes.Notes;
                        if (objArmor.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objArmor.Notes))
                        treArmor.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treArmor.SelectedNode.ForeColor = SystemColors.WindowText;
                    treArmor.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objArmor.Notes, 100);
                }
            }

        private void tsArmorModNotes_Click(object sender, EventArgs e)
        {
            if (treArmor.SelectedNode == null)
                return;
            ArmorMod objArmorMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                if (objArmorMod != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objArmorMod.Notes;
                    string strOldValue = objArmorMod.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objArmorMod.Notes = frmItemNotes.Notes;
                        if (objArmorMod.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objArmorMod.Notes))
                        treArmor.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objArmorMod.IncludedInArmor)
                    treArmor.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                        treArmor.SelectedNode.ForeColor = SystemColors.WindowText;
                    treArmor.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objArmorMod.Notes, 100);
                }
            }

        private void tsArmorGearNotes_Click(object sender, EventArgs e)
        {
            if (treArmor.SelectedNode == null)
                return;
            Gear objArmorGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            if (objArmorGear != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objArmorGear.Notes;
                string strOldValue = objArmorGear.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objArmorGear.Notes = frmItemNotes.Notes;
                    if (objArmorGear.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objArmorGear.Notes))
                    treArmor.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objArmorGear.IncludedInParent)
                    treArmor.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                    treArmor.SelectedNode.ForeColor = SystemColors.WindowText;
                treArmor.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objArmorGear.Notes, 100);
            }
        }

        private void tsWeaponNotes_Click(object sender, EventArgs e)
        {
            if (treWeapons.SelectedNode == null)
                return;
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objWeapon != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objWeapon.Notes;
                string strOldValue = objWeapon.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objWeapon.Notes = frmItemNotes.Notes;
                    if (objWeapon.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objWeapon.Notes))
                    treWeapons.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objWeapon.Cyberware || objWeapon.Category == "Gear" || !string.IsNullOrEmpty(objWeapon.ParentID))
                    treWeapons.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                    treWeapons.SelectedNode.ForeColor = SystemColors.WindowText;
                treWeapons.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objWeapon.Notes, 100);
            }
        }

        private void tsWeaponAccessoryNotes_Click(object sender, EventArgs e)
        {
            if (treWeapons.SelectedNode == null)
                return;
            WeaponAccessory objAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            frmNotes frmItemNotes = new frmNotes();
            frmItemNotes.Notes = objAccessory.Notes;
            string strOldValue = objAccessory.Notes;
            frmItemNotes.ShowDialog(this);

            if (frmItemNotes.DialogResult == DialogResult.OK)
            {
                objAccessory.Notes = frmItemNotes.Notes;
                if (objAccessory.Notes != strOldValue)
                {
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            if (!string.IsNullOrEmpty(objAccessory.Notes))
                treWeapons.SelectedNode.ForeColor = Color.SaddleBrown;
            else if (objAccessory.IncludedInWeapon)
                treWeapons.SelectedNode.ForeColor = SystemColors.GrayText;
            else
                treWeapons.SelectedNode.ForeColor = SystemColors.WindowText;
            treWeapons.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objAccessory.Notes, 100);
        }

        private void tsCyberwareNotes_Click(object sender, EventArgs e)
        {
            if (treCyberware.SelectedNode == null)
                return;
            Cyberware objCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);
                if (objCyberware != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objCyberware.Notes;
                    string strOldValue = objCyberware.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objCyberware.Notes = frmItemNotes.Notes;
                        if (objCyberware.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objCyberware.Notes))
                        treCyberware.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objCyberware.Capacity == "[*]" || !string.IsNullOrEmpty(objCyberware.ParentID))
                            treCyberware.SelectedNode.ForeColor = SystemColors.GrayText;
                        else
                            treCyberware.SelectedNode.ForeColor = SystemColors.WindowText;
                    treCyberware.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objCyberware.Notes, 100);
                }
            }

        private void tsQualityNotes_Click(object sender, EventArgs e)
        {
            if (treQualities.SelectedNode == null)
                return;
            Quality objQuality = CommonFunctions.FindByIdWithNameCheck(treQualities.SelectedNode.Tag.ToString(), _objCharacter.Qualities);
                if (objQuality != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objQuality.Notes;
                    string strOldValue = objQuality.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objQuality.Notes = frmItemNotes.Notes;
                        if (objQuality.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objQuality.Notes))
                        treQualities.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objQuality.OriginSource == QualitySource.Metatype || objQuality.OriginSource == QualitySource.MetatypeRemovable || objQuality.OriginSource == QualitySource.Improvement)
                            treQualities.SelectedNode.ForeColor = SystemColors.GrayText;
                        else
                            treQualities.SelectedNode.ForeColor = SystemColors.WindowText;
                    treQualities.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objQuality.Notes, 100);
                }
            }

        private void tsMartialArtsNotes_Click(object sender, EventArgs e)
        {
            if (treMartialArts.SelectedNode == null)
                return;
            MartialArt objMartialArt = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);
            if (objMartialArt != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objMartialArt.Notes;
                string strOldValue = objMartialArt.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objMartialArt.Notes = frmItemNotes.Notes;
                    if (objMartialArt.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objMartialArt.Notes))
                    treMartialArts.SelectedNode.ForeColor = Color.SaddleBrown;
                else
                    treMartialArts.SelectedNode.ForeColor = SystemColors.WindowText;
                treMartialArts.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objMartialArt.Notes, 100);
            }
            else
            {
                MartialArtAdvantage objTechnique = CommonFunctions.FindMartialArtAdvantage(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);
                if (objTechnique != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objTechnique.Notes;
                    string strOldValue = objTechnique.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objTechnique.Notes = frmItemNotes.Notes;
                        if (objTechnique.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objTechnique.Notes))
                        treMartialArts.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMartialArts.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMartialArts.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objTechnique.Notes, 100);
                }
            }
        }

        private void tsMartialArtManeuverNotes_Click(object sender, EventArgs e)
        {
            if (treMartialArts.SelectedNode == null)
                return;
            MartialArtManeuver objMartialArtManeuver = CommonFunctions.FindByIdWithNameCheck(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArtManeuvers);
                if (objMartialArtManeuver != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objMartialArtManeuver.Notes;
                    string strOldValue = objMartialArtManeuver.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objMartialArtManeuver.Notes = frmItemNotes.Notes;
                        if (objMartialArtManeuver.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objMartialArtManeuver.Notes))
                        treMartialArts.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMartialArts.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMartialArts.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objMartialArtManeuver.Notes, 100);
                }
            }

        private void tsSpellNotes_Click(object sender, EventArgs e)
        {
            if (treSpells.SelectedNode == null)
                return;
            Spell objSpell = CommonFunctions.FindByIdWithNameCheck(treSpells.SelectedNode.Tag.ToString(), _objCharacter.Spells);
                if (objSpell != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objSpell.Notes;
                    string strOldValue = objSpell.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objSpell.Notes = frmItemNotes.Notes;
                        if (objSpell.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objSpell.Notes))
                        treSpells.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treSpells.SelectedNode.ForeColor = SystemColors.WindowText;
                    treSpells.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objSpell.Notes, 100);
                }
            }

        private void tsComplexFormNotes_Click(object sender, EventArgs e)
        {
            if (treComplexForms.SelectedNode == null)
                return;
            ComplexForm objComplexForm = CommonFunctions.FindByIdWithNameCheck(treComplexForms.SelectedNode.Tag.ToString(), _objCharacter.ComplexForms);
                if (objComplexForm != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objComplexForm.Notes;
                    string strOldValue = objComplexForm.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objComplexForm.Notes = frmItemNotes.Notes;
                        if (objComplexForm.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objComplexForm.Notes))
                        treComplexForms.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treComplexForms.SelectedNode.ForeColor = SystemColors.WindowText;
                    treComplexForms.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objComplexForm.Notes, 100);
                }
            }

        private void tsCritterPowersNotes_Click(object sender, EventArgs e)
        {
            if (treCritterPowers.SelectedNode == null)
                return;
            CritterPower objCritterPower = CommonFunctions.FindByIdWithNameCheck(treCritterPowers.SelectedNode.Tag.ToString(), _objCharacter.CritterPowers);
                if (objCritterPower != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objCritterPower.Notes;
                    string strOldValue = objCritterPower.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objCritterPower.Notes = frmItemNotes.Notes;
                        if (objCritterPower.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objCritterPower.Notes))
                        treCritterPowers.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treCritterPowers.SelectedNode.ForeColor = SystemColors.WindowText;
                    treCritterPowers.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objCritterPower.Notes, 100);
                }
            }

        private void tsMetamagicNotes_Click(object sender, EventArgs e)
        {
            if (treMetamagic.SelectedNode == null)
                return;
            InitiationGrade objGrade = CommonFunctions.FindById(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.InitiationGrades);
                if (objGrade != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objGrade.Notes;
                    string strOldValue = objGrade.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objGrade.Notes = frmItemNotes.Notes;
                        if (objGrade.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objGrade.Notes))
                        treMetamagic.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMetamagic.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMetamagic.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objGrade.Notes, 100);
                }
            }

        private void tsGearNotes_Click(object sender, EventArgs e)
        {
            if (treGear.SelectedNode == null)
                return;
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
                if (objGear != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objGear.Notes;
                    string strOldValue = objGear.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objGear.Notes = frmItemNotes.Notes;
                        if (objGear.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objGear.Notes))
                        treGear.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objGear.IncludedInParent)
                    treGear.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                        treGear.SelectedNode.ForeColor = SystemColors.WindowText;
                    treGear.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objGear.Notes, 100);
                }
            }

        private void tsGearPluginNotes_Click(object sender, EventArgs e)
        {
            if (treGear.SelectedNode == null)
                return;
            Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
                if (objGear != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objGear.Notes;
                    string strOldValue = objGear.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objGear.Notes = frmItemNotes.Notes;
                        if (objGear.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                if (!string.IsNullOrEmpty(objGear.Notes))
                        treGear.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objGear.IncludedInParent)
                    treGear.SelectedNode.ForeColor = SystemColors.GrayText;
                else
                        treGear.SelectedNode.ForeColor = SystemColors.WindowText;
                    treGear.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objGear.Notes, 100);
                }
            }

        private void tsVehicleNotes_Click(object sender, EventArgs e)
        {
            if (treVehicles.SelectedNode == null)
                return;
            Vehicle objVehicle = _objCharacter.Vehicles.FirstOrDefault(x => x.InternalId == treVehicles.SelectedNode.Tag.ToString());

            if (objVehicle != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objVehicle.Notes;
                string strOldValue = objVehicle.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objVehicle.Notes = frmItemNotes.Notes;
                    if (objVehicle.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objVehicle.Notes))
                    treVehicles.SelectedNode.ForeColor = Color.SaddleBrown;
                else
                    treVehicles.SelectedNode.ForeColor = SystemColors.WindowText;
                treVehicles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objVehicle.Notes, 100);
            }
            else
            {
                VehicleMod objMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objMod != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objMod.Notes;
                    string strOldValue = objMod.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objMod.Notes = frmItemNotes.Notes;
                        if (objMod.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objMod.Notes))
                        treVehicles.SelectedNode.ForeColor = Color.SaddleBrown;
                    else if (objMod.IncludedInVehicle)
                        treVehicles.SelectedNode.ForeColor = SystemColors.GrayText;
                    else
                        treVehicles.SelectedNode.ForeColor = SystemColors.WindowText;
                    treVehicles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objMod.Notes, 100);
                }
            }
        }

        private void tsLifestyleNotes_Click(object sender, EventArgs e)
        {
            if (treLifestyles.SelectedNode != null)
            {
                Lifestyle objLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);
                if (objLifestyle != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objLifestyle.Notes;
                    string strOldValue = objLifestyle.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objLifestyle.Notes = frmItemNotes.Notes;
                        if (objLifestyle.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objLifestyle.Notes))
                        treLifestyles.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treLifestyles.SelectedNode.ForeColor = SystemColors.WindowText;
                    treLifestyles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objLifestyle.Notes, 100);
                }
            }
        }

        private void tsVehicleWeaponNotes_Click(object sender, EventArgs e)
        {
            if (treVehicles.SelectedNode != null)
                return;
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objWeapon != null)
            {
                frmNotes frmItemNotes = new frmNotes();
                frmItemNotes.Notes = objWeapon.Notes;
                string strOldValue = objWeapon.Notes;
                frmItemNotes.ShowDialog(this);

                if (frmItemNotes.DialogResult == DialogResult.OK)
                {
                    objWeapon.Notes = frmItemNotes.Notes;
                    if (objWeapon.Notes != strOldValue)
                    {
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                if (!string.IsNullOrEmpty(objWeapon.Notes))
                    treVehicles.SelectedNode.ForeColor = Color.SaddleBrown;
                else if (objWeapon.Cyberware || objWeapon.Category == "Gear" || !string.IsNullOrEmpty(objWeapon.ParentID))
                        treVehicles.SelectedNode.ForeColor = SystemColors.GrayText;
                    else
                        treVehicles.SelectedNode.ForeColor = SystemColors.WindowText;
                treVehicles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objWeapon.Notes, 100);
            }
        }

        private void tsVehicleName_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected.
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectVehicleName"), LanguageManager.GetString("MessageTitle_SelectVehicle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            while (treVehicles.SelectedNode.Level > 1)
            {
                treVehicles.SelectedNode = treVehicles.SelectedNode.Parent;
            }

            // Get the information for the currently selected Vehicle.
            Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_VehicleName");
            frmPickText.DefaultString = objVehicle.VehicleName;
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            objVehicle.VehicleName = frmPickText.SelectedValue;
            treVehicles.SelectedNode.Text = objVehicle.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsVehicleAddCyberware_Click(object sender, EventArgs e)
        {
            Vehicle objVehicle = null;
            Cyberware objCyberwareParent = null;
            VehicleMod objMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle);
            if (objMod == null)
                objCyberwareParent = CommonFunctions.FindVehicleCyberware(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objMod);

            if (objCyberwareParent == null && (objMod == null || !objMod.AllowCyberware))
            {
                MessageBox.Show(LanguageManager.GetString("Message_VehicleCyberwarePlugin"), LanguageManager.GetString("MessageTitle_NoCyberware"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectCyberware frmPickCyberware = new frmSelectCyberware(_objCharacter, Improvement.ImprovementSource.Cyberware, true, objCyberwareParent?.MyXmlNode ?? objMod.MyXmlNode);
            if (objCyberwareParent == null)
            {
                frmPickCyberware.SetGrade = "Standard";
                frmPickCyberware.MaximumCapacity = objMod.CapacityRemaining;
                frmPickCyberware.Subsystems = objMod.Subsystems;
                HashSet<string> setDisallowedMounts = new HashSet<string>();
                HashSet<string> setHasMounts = new HashSet<string>();
                foreach (Cyberware objLoopCyberware in objMod.Cyberware.DeepWhere(x => x.Children, x => string.IsNullOrEmpty(x.PlugsIntoModularMount)))
                {
                    string[] strLoopDisallowedMounts = objLoopCyberware.BlocksMounts.Split(',');
                    foreach (string strLoop in strLoopDisallowedMounts)
                        if (!setDisallowedMounts.Contains(strLoop + objLoopCyberware.Location))
                            setDisallowedMounts.Add(strLoop + objLoopCyberware.Location);
                    string strLoopHasModularMount = objLoopCyberware.HasModularMount;
                    if (!string.IsNullOrEmpty(strLoopHasModularMount))
                        if (!setHasMounts.Contains(strLoopHasModularMount))
                            setHasMounts.Add(strLoopHasModularMount);
                }
                string strDisallowedMounts = string.Empty;
                foreach (string strLoop in setDisallowedMounts)
                    if (!strLoop.EndsWith("Right") && (!strLoop.EndsWith("Left") || setDisallowedMounts.Contains(strLoop.Substring(0, strLoop.Length - 4) + "Right")))
                        strDisallowedMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strDisallowedMounts))
                    strDisallowedMounts = strDisallowedMounts.Substring(0, strDisallowedMounts.Length - 1);
                frmPickCyberware.DisallowedMounts = strDisallowedMounts;
                string strHasMounts = string.Empty;
                foreach (string strLoop in setHasMounts)
                    strHasMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strHasMounts))
                    strHasMounts = strHasMounts.Substring(0, strHasMounts.Length - 1);
                frmPickCyberware.HasModularMounts = strHasMounts;
            }
            else
            {
                frmPickCyberware.SetGrade = objCyberwareParent.Grade.Name;
                // If the Cyberware has a Capacity with no brackets (meaning it grants Capacity), show only Subsystems (those that conume Capacity).
                if (!objCyberwareParent.Capacity.Contains('['))
                {
                    frmPickCyberware.MaximumCapacity = objCyberwareParent.CapacityRemaining;

                    // Do not allow the user to add a new piece of Cyberware if its Capacity has been reached.
                    if (_objOptions.EnforceCapacity && objCyberwareParent.CapacityRemaining < 0)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }
                }

                frmPickCyberware.CyberwareParent = objCyberwareParent;
                frmPickCyberware.Subsystems = objCyberwareParent.AllowedSubsystems;

                HashSet<string> setDisallowedMounts = new HashSet<string>();
                HashSet<string> setHasMounts = new HashSet<string>();
                string[] strLoopDisallowedMounts = objCyberwareParent.BlocksMounts.Split(',');
                foreach (string strLoop in strLoopDisallowedMounts)
                    setDisallowedMounts.Add(strLoop + objCyberwareParent.Location);
                string strLoopHasModularMount = objCyberwareParent.HasModularMount;
                if (!string.IsNullOrEmpty(strLoopHasModularMount))
                    setHasMounts.Add(strLoopHasModularMount);
                foreach (Cyberware objLoopCyberware in objCyberwareParent.Children.DeepWhere(x => x.Children, x => string.IsNullOrEmpty(x.PlugsIntoModularMount)))
                {
                    strLoopDisallowedMounts = objLoopCyberware.BlocksMounts.Split(',');
                    foreach (string strLoop in strLoopDisallowedMounts)
                        if (!setDisallowedMounts.Contains(strLoop + objLoopCyberware.Location))
                            setDisallowedMounts.Add(strLoop + objLoopCyberware.Location);
                    strLoopHasModularMount = objLoopCyberware.HasModularMount;
                    if (!string.IsNullOrEmpty(strLoopHasModularMount))
                        if (!setHasMounts.Contains(strLoopHasModularMount))
                            setHasMounts.Add(strLoopHasModularMount);
                }
                string strDisallowedMounts = string.Empty;
                foreach (string strLoop in setDisallowedMounts)
                    if (!strLoop.EndsWith("Right") && (!strLoop.EndsWith("Left") || setDisallowedMounts.Contains(strLoop.Substring(0, strLoop.Length - 4) + "Right")))
                        strDisallowedMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strDisallowedMounts))
                    strDisallowedMounts = strDisallowedMounts.Substring(0, strDisallowedMounts.Length - 1);
                frmPickCyberware.DisallowedMounts = strDisallowedMounts;
                string strHasMounts = string.Empty;
                foreach (string strLoop in setHasMounts)
                    strHasMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strHasMounts))
                    strHasMounts = strHasMounts.Substring(0, strHasMounts.Length - 1);
                frmPickCyberware.HasModularMounts = strHasMounts;
            }
            frmPickCyberware.LockGrade();
            frmPickCyberware.ParentVehicle = objVehicle ?? objMod.Parent;
            frmPickCyberware.ShowDialog(this);

            if (frmPickCyberware.DialogResult == DialogResult.Cancel)
                return;

            // Open the Cyberware XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("cyberware.xml");

            XmlNode objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/cyberwares/cyberware[name = \"" + frmPickCyberware.SelectedCyberware + "\"]");

            // Create the Cyberware object.
            Cyberware objCyberware = new Cyberware(_objCharacter);
            List<Weapon> objWeapons = new List<Weapon>();
            TreeNode objNode = new TreeNode();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            List<Vehicle> objVehicles = new List<Vehicle>();
            List<TreeNode> objVehicleNodes = new List<TreeNode>();
            objCyberware.Create(objXmlCyberware, _objCharacter, frmPickCyberware.SelectedGrade, Improvement.ImprovementSource.Cyberware, frmPickCyberware.SelectedRating, objNode, objWeapons, objWeaponNodes, objVehicles, objVehicleNodes, false, true, string.Empty, null, objVehicle);
            if (objCyberware.InternalId == Guid.Empty.ToString())
                return;

            if (frmPickCyberware.FreeCost)
                objCyberware.Cost = "0";

            decimal decCost = objCyberware.TotalCost;

            // Multiply the cost if applicable.
            if (objCyberware.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objCyberware.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Apply a markup if applicable.
            if (frmPickCyberware.Markup != 0 && !frmPickCyberware.FreeCost)
            {
                decCost *= 1 + (frmPickCyberware.Markup / 100.0m);
            }

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickCyberware.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    string strEntry = string.Empty;
                    strEntry = LanguageManager.GetString("String_ExpensePurchaseVehicleCyberware");
                    objExpense.Create(decCost * -1, strEntry + " " + objCyberware.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddVehicleModCyberware, objCyberware.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();
            objMod.Cyberware.Add(objCyberware);

            foreach (Weapon objWeapon in objWeapons)
            {
                objWeapon.VehicleMounted = true;
                objVehicle.Weapons.Add(objWeapon);
            }

            // Create the Weapon Node if one exists.
            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsVehicleWeapon;
                treVehicles.SelectedNode.Parent.Nodes.Add(objWeaponNode);
                treVehicles.SelectedNode.Parent.Expand();
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickCyberware.AddAgain)
                tsVehicleAddCyberware_Click(sender, e);
        }

        private void tsArmorName_Click(object sender, EventArgs e)
        {
            // Make sure a parent item is selected, then open the Select Accessory window.
            if (treArmor.SelectedNode == null || treArmor.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectArmorName"), LanguageManager.GetString("MessageTitle_SelectArmor"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treArmor.SelectedNode.Level > 1)
                treArmor.SelectedNode = treArmor.SelectedNode.Parent;

            // Get the information for the currently selected Armor.
            Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_ArmorName");
            frmPickText.DefaultString = objArmor.ArmorName;
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            objArmor.ArmorName = frmPickText.SelectedValue;
            treArmor.SelectedNode.Text = objArmor.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsEditAdvancedLifestyle_Click(object sender, EventArgs e)
        {
            treLifestyles_DoubleClick(sender, e);
        }

        private void tsAdvancedLifestyleNotes_Click(object sender, EventArgs e)
        {
            tsLifestyleNotes_Click(sender, e);
        }

        private void tsEditLifestyle_Click(object sender, EventArgs e)
        {
            treLifestyles_DoubleClick(sender, e);
        }

        private void tsLifestyleName_Click(object sender, EventArgs e)
        {
            if (treLifestyles.SelectedNode == null || treLifestyles.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectLifestyleName"), LanguageManager.GetString("MessageTitle_SelectLifestyle"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // Get the information for the currently selected Lifestyle.
            Lifestyle objLifestyle = null;
            foreach (Lifestyle objSelectedLifestyle in _objCharacter.Lifestyles)
            {
                if (objSelectedLifestyle.InternalId == treLifestyles.SelectedNode.Tag.ToString())
                {
                    objLifestyle = objSelectedLifestyle;
                    break;
                }
            }

            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_LifestyleName");
            frmPickText.DefaultString = objLifestyle.LifestyleName;
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            objLifestyle.LifestyleName = frmPickText.SelectedValue;
            treLifestyles.SelectedNode.Text = objLifestyle.DisplayName;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsGearRenameLocation_Click(object sender, EventArgs e)
        {
            string strNewLocation = string.Empty;
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            strNewLocation = frmPickText.SelectedValue;

            int i = -1;
            foreach (string strLocation in _objCharacter.Locations)
            {
                i++;
                if (strLocation == treGear.SelectedNode.Text)
                {
                    foreach (Gear objGear in _objCharacter.Gear)
                    {
                        if (objGear.Location == strLocation)
                            objGear.Location = strNewLocation;
                    }

                    _objCharacter.Locations[i] = strNewLocation;
                    treGear.SelectedNode.Text = strNewLocation;
                    break;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsWeaponRenameLocation_Click(object sender, EventArgs e)
        {
            string strNewLocation = string.Empty;
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            strNewLocation = frmPickText.SelectedValue;

            int i = -1;
            foreach (string strLocation in _objCharacter.WeaponLocations)
            {
                i++;
                if (strLocation == treWeapons.SelectedNode.Text)
                {
                    foreach (Weapon objWeapon in _objCharacter.Weapons)
                    {
                        if (objWeapon.Location == strLocation)
                            objWeapon.Location = strNewLocation;
                    }

                    _objCharacter.WeaponLocations[i] = strNewLocation;
                    treWeapons.SelectedNode.Text = strNewLocation;
                    break;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsCreateSpell_Click(object sender, EventArgs e)
        {
            int intSpellKarmaCost = _objCharacter.SpellKarmaCost;
            // Make sure the character has enough Karma before letting them select a Spell.
            if (_objCharacter.Karma < intSpellKarmaCost)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // The character is still allowed to add Spells, so show the Create Spell window.
            frmCreateSpell frmSpell = new frmCreateSpell(_objCharacter);
            frmSpell.ShowDialog(this);

            if (frmSpell.DialogResult == DialogResult.Cancel)
                return;

            Spell objSpell = frmSpell.SelectedSpell;
            TreeNode objNode = new TreeNode();
            objNode.Text = objSpell.DisplayName;
            objNode.Tag = objSpell.InternalId;
            objNode.ContextMenuStrip = cmsSpell;

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", objSpell.DisplayName).Replace("{1}", intSpellKarmaCost.ToString())))
                return;

            _objCharacter.Spells.Add(objSpell);

            switch (objSpell.Category)
            {
                case "Combat":
                    treSpells.Nodes[0].Nodes.Add(objNode);
                    treSpells.Nodes[0].Expand();
                    break;
                case "Detection":
                    treSpells.Nodes[1].Nodes.Add(objNode);
                    treSpells.Nodes[1].Expand();
                    break;
                case "Health":
                    treSpells.Nodes[2].Nodes.Add(objNode);
                    treSpells.Nodes[2].Expand();
                    break;
                case "Illusion":
                    treSpells.Nodes[3].Nodes.Add(objNode);
                    treSpells.Nodes[3].Expand();
                    break;
                case "Manipulation":
                    treSpells.Nodes[4].Nodes.Add(objNode);
                    treSpells.Nodes[4].Expand();
                    break;
                case "Rituals":
                    /*
                    int intNode = 5;
                    if (_objCharacter.AdeptEnabled && !_objCharacter.MagicianEnabled)
                        intNode = 0;
                    treSpells.Nodes[intNode].Nodes.Add(objNode);
                    treSpells.Nodes[intNode].Expand();
                    */
                    treSpells.Nodes[5].Nodes.Add(objNode);
                    treSpells.Nodes[5].Expand();
                    break;
                case "Enchantments":
                    treSpells.Nodes[6].Nodes.Add(objNode);
                    treSpells.Nodes[6].Expand();
                    break;
            }

            treSpells.SelectedNode = objNode;

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create(intSpellKarmaCost * -1, LanguageManager.GetString("String_ExpenseLearnSpell") + " " + objSpell.Name, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objEntry);
            _objCharacter.Karma -= intSpellKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.AddSpell, objSpell.InternalId);
            objEntry.Undo = objUndo;


            treSpells.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsImprovementNotes_Click(object sender, EventArgs e)
        {
            if (treImprovements.SelectedNode != null)
            {
                if (treImprovements.SelectedNode.Level > 0)
                {
                    Improvement objImprovement = null;
                    foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                    {
                        if (objCharacterImprovement.SourceName == treImprovements.SelectedNode.Tag.ToString())
                        {
                            objImprovement = objCharacterImprovement;
                            break;
                        }
                    }

                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objImprovement.Notes;
                    string strOldValue = objImprovement.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objImprovement.Notes = frmItemNotes.Notes;
                        if (objImprovement.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objImprovement.Notes))
                    {
                        if (objImprovement.Enabled)
                            treImprovements.SelectedNode.ForeColor = Color.SaddleBrown;
                        else
                            treImprovements.SelectedNode.ForeColor = Color.SandyBrown;
                    }
                    else if (objImprovement.Enabled)
                            treImprovements.SelectedNode.ForeColor = SystemColors.WindowText;
                        else
                            treImprovements.SelectedNode.ForeColor = SystemColors.GrayText;
                    treImprovements.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objImprovement.Notes, 100);
                }
            }
        }

        private void tsArmorRenameLocation_Click(object sender, EventArgs e)
        {
            string strNewLocation = string.Empty;
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            strNewLocation = frmPickText.SelectedValue;

            int i = -1;
            foreach (string strLocation in _objCharacter.ArmorBundles)
            {
                i++;
                if (strLocation == treArmor.SelectedNode.Text)
                {
                    foreach (Armor objArmor in _objCharacter.Armor)
                    {
                        if (objArmor.Location == strLocation)
                            objArmor.Location = strNewLocation;
                    }

                    _objCharacter.ArmorBundles[i] = strNewLocation;
                    treArmor.SelectedNode.Text = strNewLocation;
                    break;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsImprovementRenameLocation_Click(object sender, EventArgs e)
        {
            string strNewLocation = string.Empty;
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            strNewLocation = frmPickText.SelectedValue;

            int i = -1;
            foreach (string strLocation in _objCharacter.ImprovementGroups)
            {
                i++;
                if (strLocation == treImprovements.SelectedNode.Text)
                {
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.CustomGroup == strLocation)
                            objImprovement.CustomGroup = strNewLocation;
                    }

                    _objCharacter.ImprovementGroups[i] = strNewLocation;
                    treImprovements.SelectedNode.Text = strNewLocation;
                    break;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsCyberwareAddGear_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treCyberware.SelectedNode == null || treCyberware.SelectedNode.Level == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectCyberware"), LanguageManager.GetString("MessageTitle_SelectCyberware"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            Cyberware objCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);

            // Make sure the Cyberware is allowed to accept Gear.
            if (objCyberware.AllowGear == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CyberwareGear"), LanguageManager.GetString("MessageTitle_CyberwareGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objCyberware.MyXmlNode);
            string strCategories = string.Empty;
            foreach (XmlNode objXmlCategory in objCyberware.AllowGear)
                strCategories += objXmlCategory.InnerText + ",";
            frmPickGear.AllowedCategories = strCategories;
            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            TreeNode objNode = new TreeNode();

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            Gear objNewGear = null;
            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objNewGear = objCommlink;
            }
            else
            {
                Gear objGear = new Gear(_objCharacter);
                objGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objGear.DisplayName;

                objNewGear = objGear;
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objNewGear.Cost = (Convert.ToDouble(objNewGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objNewGear.Cost))
                    objNewGear.Cost = "(" + objNewGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objNewGear.Extra))
                    objNewGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objNewGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objNewGear.Cost = "0";
            }

            decimal decCost = objNewGear.TotalCost;

            // Multiply the cost if applicable.
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objNewGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsCyberwareAddGear_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseCyberwearGear") + " " + objNewGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddCyberwareGear, objNewGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            // Create any Weapons that came with this Gear.
            foreach (Weapon objWeapon in objWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            objCyberware.Gear.Add(objNewGear);

            objNode.ContextMenuStrip = cmsCyberwareGear;
            treCyberware.SelectedNode.Nodes.Add(objNode);
            treCyberware.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            if (frmPickGear.AddAgain)
                tsCyberwareAddGear_Click(sender, e);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsCyberwareGearMenuAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Make sure a parent items is selected, then open the Select Gear window.
            if (treCyberware.SelectedNode == null || treCyberware.SelectedNode.Level < 2)
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (treCyberware.SelectedNode.Level > 3)
                treCyberware.SelectedNode = treCyberware.SelectedNode.Parent;

            // Locate the Vehicle Sensor Gear.
            bool blnFound = false;
            Cyberware objFoundCyber = null;
            Gear objSensor = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children), out objFoundCyber);
            if (objSensor != null)
                blnFound = true;

            // Make sure the Gear was found.
            if (!blnFound)
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            XmlNode objXmlGear = objSensor.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objXmlGear);
            //frmPickGear.ShowNegativeCapacityOnly = true;

            if (objXmlGear.InnerXml.Contains("<addoncategory>"))
            {
                string strCategories = string.Empty;
                foreach (XmlNode objXmlCategory in objXmlGear.SelectNodes("addoncategory"))
                    strCategories += objXmlCategory.InnerText + ",";
                // Remove the trailing comma.
                strCategories = strCategories.Substring(0, strCategories.Length - 1);
                frmPickGear.AllowedCategories = strCategories;
            }

            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Gear objGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objGear = objCommlink;
            }
            else
            {
                Gear objNewGear = new Gear(_objCharacter);
                objNewGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objNewGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objNewGear.DisplayName;

                objGear = objNewGear;
            }

            if (objGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objGear.Cost = (Convert.ToDouble(objGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objGear.Cost))
                    objGear.Cost = "(" + objGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objGear.Extra))
                    objGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objGear.Cost = "0";
            }

            objNode.Text = objGear.DisplayName;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleSensorAddAsPlugin_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseCyberwearGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddCyberwareGear, objGear.InternalId, frmPickGear.SelectedQty);
                    objExpense.Undo = objUndo;
                }
            }

            if (treCyberware.SelectedNode.Level < 3)
                objNode.ContextMenuStrip = cmsCyberwareGear;

            treCyberware.SelectedNode.Nodes.Add(objNode);
            treCyberware.SelectedNode.Expand();

            objGear.Parent = objSensor;
            objSensor.Children.Add(objGear);
            Commlink objSensorCommlink = objSensor as Commlink;
            if (objSensorCommlink?.CanSwapAttributes == true)
            {
                objSensorCommlink.RefreshCyberdeckArray();
            }

            if (frmPickGear.AddAgain)
                tsCyberwareGearMenuAddAsPlugin_Click(sender, e);

            ScheduleCharacterUpdate();
            RefreshSelectedCyberware();
        }

        private void tsWeaponAccessoryAddGear_Click(object sender, EventArgs e)
        {
            WeaponAccessory objAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            // Make sure the Weapon Accessory is allowed to accept Gear.
            if (objAccessory.AllowGear == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_WeaponGear"), LanguageManager.GetString("MessageTitle_CyberwareGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objAccessory.MyXmlNode);
            string strCategories = string.Empty;
            foreach (XmlNode objXmlCategory in objAccessory.AllowGear)
                strCategories += objXmlCategory.InnerText + ",";
            frmPickGear.AllowedCategories = strCategories;
            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            TreeNode objNode = new TreeNode();

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            Gear objNewGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objNewGear = objCommlink;
            }
            else
            {
                Gear objGear = new Gear(_objCharacter);
                objGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objGear.DisplayName;

                objNewGear = objGear;
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objNewGear.Cost = (Convert.ToDouble(objNewGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objNewGear.Cost))
                    objNewGear.Cost = "(" + objNewGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objNewGear.Extra))
                    objNewGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objNewGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objNewGear.Cost = "0";
            }

            decimal decCost = objNewGear.TotalCost;

            // Multiply the cost if applicable.
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objNewGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsWeaponAccessoryAddGear_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeaponGear") + " " + objNewGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeaponGear, objNewGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            // Create any Weapons that came with this Gear.
            foreach (Weapon objWeapon in objWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeaponAccessoryGear;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            objAccessory.Gear.Add(objNewGear);

            objNode.ContextMenuStrip = cmsWeaponAccessoryGear;
            treWeapons.SelectedNode.Nodes.Add(objNode);
            treWeapons.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            if (frmPickGear.AddAgain)
                tsWeaponAccessoryAddGear_Click(sender, e);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsWeaponAccessoryGearMenuAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Locate the Vehicle Sensor Gear.
            Gear objSensor = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objSensor == null)
            // Make sure the Gear was found.
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            XmlNode objXmlGear = objSensor.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objXmlGear);
            //frmPickGear.ShowNegativeCapacityOnly = true;

            if (objXmlGear.InnerXml.Contains("<addoncategory>"))
            {
                string strCategories = string.Empty;
                foreach (XmlNode objXmlCategory in objXmlGear.SelectNodes("addoncategory"))
                    strCategories += objXmlCategory.InnerText + ",";
                // Remove the trailing comma.
                strCategories = strCategories.Substring(0, strCategories.Length - 1);
                frmPickGear.AllowedCategories = strCategories;
            }

            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Gear objGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objGear = objCommlink;
            }
            else
            {
                Gear objNewGear = new Gear(_objCharacter);
                objNewGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objNewGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objNewGear.DisplayName;

                objGear = objNewGear;
            }

            if (objGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objGear.Cost = (Convert.ToDouble(objGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objGear.Cost))
                    objGear.Cost = "(" + objGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objGear.Extra))
                    objGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objGear.Cost = "0";
            }

            objNode.Text = objGear.DisplayName;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleSensorAddAsPlugin_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeaponGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeaponGear, objGear.InternalId, frmPickGear.SelectedQty);
                    objExpense.Undo = objUndo;
                }
            }

            objNode.ContextMenuStrip = cmsCyberwareGear;

            treWeapons.SelectedNode.Nodes.Add(objNode);
            treWeapons.SelectedNode.Expand();

            objGear.Parent = objSensor;
            objSensor.Children.Add(objGear);
            Commlink objSensorCommlink = objSensor as Commlink;
            if (objSensorCommlink?.CanSwapAttributes == true)
            {
                objSensorCommlink.RefreshCyberdeckArray();
            }

            if (frmPickGear.AddAgain)
                tsWeaponAccessoryGearMenuAddAsPlugin_Click(sender, e);

            ScheduleCharacterUpdate();
            RefreshSelectedWeapon();
        }

        private void tsVehicleRenameLocation_Click(object sender, EventArgs e)
        {
            string strNewLocation = string.Empty;
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel)
                return;

            // Determine if this is a Location.
            TreeNode objVehicleNode = treVehicles.SelectedNode;
            do
            {
                objVehicleNode = objVehicleNode.Parent;
            } while (objVehicleNode.Level > 1);

            // Get a reference to the affected Vehicle.
            Vehicle objVehicle = null;
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                if (objCharacterVehicle.InternalId == objVehicleNode.Tag.ToString())
                {
                    objVehicle = objCharacterVehicle;
                    break;
                }
            }

            strNewLocation = frmPickText.SelectedValue;

            int i = -1;
            foreach (string strLocation in objVehicle.Locations)
            {
                i++;
                if (strLocation == treVehicles.SelectedNode.Text)
                {
                    foreach (Gear objGear in objVehicle.Gear)
                    {
                        if (objGear.Location == strLocation)
                            objGear.Location = strNewLocation;
                    }

                    objVehicle.Locations[i] = strNewLocation;
                    treVehicles.SelectedNode.Text = strNewLocation;
                    break;
                }
            }
        }

        private void tsCreateNaturalWeapon_Click(object sender, EventArgs e)
        {
            frmNaturalWeapon frmCreateNaturalWeapon = new frmNaturalWeapon(_objCharacter);
            frmCreateNaturalWeapon.ShowDialog(this);

            if (frmCreateNaturalWeapon.DialogResult == DialogResult.Cancel)
                return;

            Weapon objWeapon = frmCreateNaturalWeapon.SelectedWeapon;
            _objCharacter.Weapons.Add(objWeapon);
            CommonFunctions.CreateWeaponTreeNode(objWeapon, treWeapons.Nodes[0], cmsWeapon, cmsWeaponAccessory, cmsWeaponAccessoryGear);

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        private void tsVehicleWeaponAccessoryNotes_Click(object sender, EventArgs e)
        {
            WeaponAccessory objAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            frmNotes frmItemNotes = new frmNotes();
            frmItemNotes.Notes = objAccessory.Notes;
            string strOldValue = objAccessory.Notes;
            frmItemNotes.ShowDialog(this);

            if (frmItemNotes.DialogResult == DialogResult.OK)
            {
                objAccessory.Notes = frmItemNotes.Notes;
                if (objAccessory.Notes != strOldValue)
                {
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            if (!string.IsNullOrEmpty(objAccessory.Notes))
                treVehicles.SelectedNode.ForeColor = Color.SaddleBrown;
            else if (objAccessory.IncludedInWeapon)
                treVehicles.SelectedNode.ForeColor = SystemColors.GrayText;
            else
                treVehicles.SelectedNode.ForeColor = SystemColors.WindowText;
            treVehicles.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objAccessory.Notes, 100);
        }

        private void tsVehicleWeaponAccessoryGearMenuAddAsPlugin_Click(object sender, EventArgs e)
        {
            // Locate the Vehicle Sensor Gear.
            Gear objSensor = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objSensor == null)
            // Make sure the Gear was found.
            {
                MessageBox.Show(LanguageManager.GetString("Message_ModifyVehicleGear"), LanguageManager.GetString("MessageTitle_SelectGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            XmlNode objXmlGear = objSensor.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objXmlGear);
            //frmPickGear.ShowNegativeCapacityOnly = true;

            if (objXmlGear.InnerXml.Contains("<addoncategory>"))
            {
                string strCategories = string.Empty;
                foreach (XmlNode objXmlCategory in objXmlGear.SelectNodes("addoncategory"))
                    strCategories += objXmlCategory.InnerText + ",";
                // Remove the trailing comma.
                strCategories = strCategories.Substring(0, strCategories.Length - 1);
                frmPickGear.AllowedCategories = strCategories;
            }

            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Gear objGear = null;

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating, false);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objGear = objCommlink;
            }
            else
            {
                Gear objNewGear = new Gear(_objCharacter);
                objNewGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, false, true, frmPickGear.Aerodynamic);
                objNewGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objNewGear.DisplayName;

                objGear = objNewGear;
            }

            if (objGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objGear.Cost = (Convert.ToDouble(objGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objGear.Cost))
                    objGear.Cost = "(" + objGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objGear.Extra))
                    objGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objGear.Cost = "0";
            }

            objNode.Text = objGear.DisplayName;

            decimal decCost = objGear.TotalCost;

            // Multiply the cost if applicable.
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleSensorAddAsPlugin_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeaponGear") + " " + objGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeaponGear, objGear.InternalId, frmPickGear.SelectedQty);
                    objExpense.Undo = objUndo;
                }
            }

            objNode.ContextMenuStrip = cmsCyberwareGear;

            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();

            objGear.Parent = objSensor;
            objSensor.Children.Add(objGear);
            Commlink objSensorCommlink = objSensor as Commlink;
            if (objSensorCommlink?.CanSwapAttributes == true)
            {
                objSensorCommlink.RefreshCyberdeckArray();
            }

            if (frmPickGear.AddAgain)
                tsVehicleWeaponAccessoryGearMenuAddAsPlugin_Click(sender, e);

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();
        }

        private void tsVehicleWeaponAccessoryAddGear_Click(object sender, EventArgs e)
        {
            WeaponAccessory objAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            // Make sure the Weapon Accessory is allowed to accept Gear.
            if (objAccessory.AllowGear == null)
            {
                MessageBox.Show(LanguageManager.GetString("Message_WeaponGear"), LanguageManager.GetString("MessageTitle_CyberwareGear"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objAccessory.MyXmlNode);
            string strCategories = string.Empty;
            foreach (XmlNode objXmlCategory in objAccessory.AllowGear)
                strCategories += objXmlCategory.InnerText + ",";
            frmPickGear.AllowedCategories = strCategories;
            frmPickGear.ShowDialog(this);

            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return;

            TreeNode objNode = new TreeNode();

            // Open the Gear XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            Gear objNewGear = null;
            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating, false);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objNewGear = objCommlink;
            }
            else
            {
                Gear objGear = new Gear(_objCharacter);
                objGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, false, true, frmPickGear.Aerodynamic);
                objGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objGear.DisplayName;

                objNewGear = objGear;
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objNewGear.Cost = (Convert.ToDouble(objNewGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);
            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objNewGear.Cost))
                    objNewGear.Cost = "(" + objNewGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objNewGear.Extra))
                    objNewGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objNewGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }
            // If the item was marked as free, change its cost.
            if (frmPickGear.FreeCost)
            {
                objNewGear.Cost = "0";
            }

            decimal decCost = objNewGear.TotalCost;

            // Multiply the cost if applicable.
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    CommonFunctions.DeleteGear(_objCharacter, objNewGear, treWeapons, treVehicles);
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    if (frmPickGear.AddAgain)
                        tsVehicleWeaponAccessoryAddGear_Click(sender, e);

                    return;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseWeaponGear") + " " + objNewGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddWeaponGear, objNewGear.InternalId, 1);
                    objExpense.Undo = objUndo;
                }
            }

            objAccessory.Gear.Add(objNewGear);

            objNode.ContextMenuStrip = cmsVehicleWeaponAccessoryGear;
            treVehicles.SelectedNode.Nodes.Add(objNode);
            treVehicles.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            if (frmPickGear.AddAgain)
                tsVehicleWeaponAccessoryAddGear_Click(sender, e);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Additional Common Tab Control Events
        private void treQualities_AfterSelect(object sender, TreeViewEventArgs e)
        {
            // Locate the selected Quality.
            lblQualitySource.Text = string.Empty;
            tipTooltip.SetToolTip(lblQualitySource, null);
            if (treQualities.SelectedNode == null || treQualities.SelectedNode.Level == 0)
            {
                    return;
            }

            Quality objQuality = CommonFunctions.FindByIdWithNameCheck(treQualities.SelectedNode.Tag.ToString(), _objCharacter.Qualities);

            string strBook = _objOptions.LanguageBookShort(objQuality.Source);
            string strPage = objQuality.Page;
            lblQualitySource.Text = strBook + " " + strPage;
            tipTooltip.SetToolTip(lblQualitySource, _objOptions.LanguageBookLong(objQuality.Source) + " " + LanguageManager.GetString("String_Page") + " " + objQuality.Page);
            lblQualityBP.Text = (objQuality.BP * _objOptions.KarmaQuality).ToString() + " " + LanguageManager.GetString("String_Karma");
        }
#endregion

#region Additional Cyberware Tab Control Events
        private void treCyberware_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedCyberware();
        }
#endregion

#region Additional Street Gear Tab Control Events
        private void treWeapons_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedWeapon();
            RefreshPasteStatus();
        }

        private void treWeapons_ItemDrag(object sender, ItemDragEventArgs e)
        {
            if (treWeapons.SelectedNode == null)
                return;

                if (treWeapons.SelectedNode.Level != 1 && treWeapons.SelectedNode.Level != 0)
                    return;

                // Do not allow the root element to be moved.
                if (treWeapons.SelectedNode.Tag.ToString() == "Node_SelectedWeapons")
                    return;

            _intDragLevel = treWeapons.SelectedNode.Level;
            DoDragDrop(e.Item, DragDropEffects.Move);
        }

        private void treWeapons_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treWeapons_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treWeapons.Nodes.Count > 0)
            {
                intNewIndex = treWeapons.Nodes[treWeapons.Nodes.Count - 1].Nodes.Count;
                nodDestination = treWeapons.Nodes[treWeapons.Nodes.Count - 1];
            }

            if (treWeapons.SelectedNode.Level == 1)
                CommonFunctions.MoveWeaponNode(_objCharacter, intNewIndex, nodDestination, treWeapons);
            else
                CommonFunctions.MoveWeaponRoot(_objCharacter, intNewIndex, nodDestination, treWeapons);

            // Clear the background color for all Nodes.
            treWeapons.ClearNodeBackground(null);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treWeapons_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (objNode.Level <= _intDragLevel)
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treWeapons.ClearNodeBackground(objNode);
        }

        private void treArmor_AfterSelect(object sender, TreeViewEventArgs e)
        {
            if (treArmor.SelectedNode.Level == 0)
            {
                cmdArmorEquipAll.Visible = true;
                cmdArmorUnEquipAll.Visible = true;
            }
            else
            {
                cmdArmorEquipAll.Visible = false;
                cmdArmorUnEquipAll.Visible = false;
            }

            if (treArmor.SelectedNode.Level == 1)
            {
                cmdArmorDecrease.Enabled = true;
                cmdArmorIncrease.Enabled = true;
            }
            else if (treArmor.SelectedNode.Level == 2)
            {
                cmdArmorDecrease.Enabled = false;
                cmdArmorIncrease.Enabled = false;
            }

            RefreshSelectedArmor();
            RefreshPasteStatus();
        }

        private void treArmor_ItemDrag(object sender, ItemDragEventArgs e)
        {
            if (treArmor.SelectedNode == null || treArmor.SelectedNode.Level != 1)
                    return;

            _intDragLevel = treArmor.SelectedNode.Level;
            DoDragDrop(e.Item, DragDropEffects.Move);
        }

        private void treArmor_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treArmor_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treArmor.Nodes.Count > 0)
            {
                intNewIndex = treArmor.Nodes[treArmor.Nodes.Count - 1].Nodes.Count;
                nodDestination = treArmor.Nodes[treArmor.Nodes.Count - 1];
            }

            CommonFunctions.MoveArmorNode(_objCharacter, intNewIndex, nodDestination, treArmor);

            // Clear the background color for all Nodes.
            treArmor.ClearNodeBackground(null);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treArmor_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (objNode.Level <= _intDragLevel)
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treArmor.ClearNodeBackground(objNode);
        }

        private void treLifestyles_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedLifestyle();
            RefreshPasteStatus();
        }

        private void treLifestyles_DoubleClick(object sender, EventArgs e)
        {
            if (treLifestyles.SelectedNode == null || treLifestyles.SelectedNode.Level == 0)
            {
                return;
            }

            // Locate the selected Lifestyle.
            Lifestyle objLifestyle = null;
            string strGuid = string.Empty;
            int intMonths = 0;
            int intPosition = -1;
            foreach (Lifestyle objCharacterLifestyle in _objCharacter.Lifestyles)
            {
                intPosition++;
                if (objCharacterLifestyle.InternalId == treLifestyles.SelectedNode.Tag.ToString())
                {
                    objLifestyle = objCharacterLifestyle;
                    strGuid = objLifestyle.InternalId;
                    intMonths = objLifestyle.Months;
                    break;
                }
            }
            if (objLifestyle == null)
                return;

            Lifestyle objNewLifestyle = new Lifestyle(_objCharacter);
            if (objLifestyle.StyleType.ToString() != "Standard")
            {
                // Edit Advanced Lifestyle.
                frmSelectLifestyleAdvanced frmPickLifestyle = new frmSelectLifestyleAdvanced(objNewLifestyle, _objCharacter);
                frmPickLifestyle.SetLifestyle(objLifestyle);
                frmPickLifestyle.ShowDialog(this);

                if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                    return;

                // Update the selected Lifestyle and refresh the list.
                objLifestyle = frmPickLifestyle.SelectedLifestyle;
            }
            else
            {
                // Edit Basic Lifestyle.
                frmSelectLifestyle frmPickLifestyle = new frmSelectLifestyle(objNewLifestyle, _objCharacter);
                frmPickLifestyle.SetLifestyle(objLifestyle);
                frmPickLifestyle.ShowDialog(this);

                if (frmPickLifestyle.DialogResult == DialogResult.Cancel)
                    return;

                // Update the selected Lifestyle and refresh the list.
                objLifestyle = frmPickLifestyle.SelectedLifestyle;
            }
            objLifestyle.SetInternalId(strGuid);
            objLifestyle.Months = intMonths;
            _objCharacter.Lifestyles[intPosition] = objLifestyle;
            treLifestyles.SelectedNode.Text = objLifestyle.DisplayName;
            RefreshSelectedLifestyle();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treLifestyles_ItemDrag(object sender, ItemDragEventArgs e)
        {
            if (treLifestyles.SelectedNode == null || treLifestyles.SelectedNode.Level != 1)
            {
                    return;
            }
            _intDragLevel = treLifestyles.SelectedNode.Level;
            DoDragDrop(e.Item, DragDropEffects.Move);
        }

        private void treLifestyles_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treLifestyles_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treLifestyles.Nodes.Count > 0)
            {
                intNewIndex = treLifestyles.Nodes[treLifestyles.Nodes.Count - 1].Nodes.Count;
                nodDestination = treLifestyles.Nodes[treLifestyles.Nodes.Count - 1];
            }

            CommonFunctions.MoveLifestyleNode(_objCharacter, intNewIndex, nodDestination, treLifestyles);

            // Clear the background color for all Nodes.
            treLifestyles.ClearNodeBackground(null);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treLifestyles_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (objNode.Level <= _intDragLevel)
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treLifestyles.ClearNodeBackground(objNode);
        }

        private void treGear_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedGear();
            RefreshPasteStatus();
        }

        private void chkArmorEquipped_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // Locate the selected Armor or Armor Mod.
            if (treArmor.SelectedNode != null)
            {
                if (treArmor.SelectedNode.Level == 1)
                {
                    Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                    if (objArmor != null)
                    {
                        objArmor.Equipped = chkArmorEquipped.Checked;
                        if (chkArmorEquipped.Checked)
                        {
                            // Add the Armor's Improevments to the character.
                            if (objArmor.Bonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId, objArmor.Bonus, false, 1, objArmor.DisplayNameShort);
                            if (objArmor.WirelessOn && objArmor.WirelessBonus != null)
                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId, objArmor.WirelessBonus, false, 1, objArmor.DisplayNameShort);
                            // Add the Improvements from any Armor Mods in the Armor.
                            foreach (ArmorMod objMod in objArmor.ArmorMods)
                            {
                                if (objMod.Equipped)
                                {
                                    if (objMod.Bonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.Bonus, false, objMod.Rating, objMod.DisplayNameShort);
                                    if (objMod.WirelessOn && objMod.WirelessBonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.WirelessBonus, false, objMod.Rating, objMod.DisplayNameShort);
                                    // Add the Improvements from any Gear in the Armor.
                                    foreach (Gear objGear in objMod.Gear)
                                    {
                                        if (objGear.Equipped)
                                        {
                                            if (objGear.Bonus != null)
                                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort);
                                            if (objGear.WirelessOn && objGear.WirelessBonus != null)
                                                ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort);
                                        }
                                    }
                                }
                            }
                            // Add the Improvements from any Gear in the Armor.
                            foreach (Gear objGear in objArmor.Gear)
                            {
                                if (objGear.Equipped)
                                {
                                    if (objGear.Bonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort);
                                    if (objGear.WirelessOn && objGear.WirelessBonus != null)
                                        ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort);
                                }
                            }
                        }
                        else
                        {
                            // Remove any Improvements the Armor created.
                            if (objArmor.Bonus != null || (objArmor.WirelessOn && objArmor.WirelessBonus != null))
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Armor, objArmor.InternalId);
                            // Remove any Improvements from any Armor Mods in the Armor.
                            foreach (ArmorMod objMod in objArmor.ArmorMods)
                            {
                                if (objMod.Bonus != null || (objMod.WirelessOn && objMod.WirelessBonus != null))
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId);
                                // Remove any Improvements from any Gear in the Armor.
                                foreach (Gear objGear in objMod.Gear)
                                {
                                    if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
                                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                                }
                            }
                            // Remove any Improvements from any Gear in the Armor.
                            foreach (Gear objGear in objArmor.Gear)
                            {
                                if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
                                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                            }
                        }
                    }
                }
                else if (treArmor.SelectedNode.Level > 1)
                {
                    ArmorMod objMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                    if (objMod != null)
                    {
                        objMod.Equipped = chkArmorEquipped.Checked;
                        if (chkArmorEquipped.Checked)
                        {
                            if (objMod.Parent.Equipped)
                            {
                                // Add the Mod's Improevments to the character.
                                if (objMod.Bonus != null)
                                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.Bonus, false, objMod.Rating, objMod.DisplayNameShort);
                                if (objMod.WirelessOn && objMod.WirelessBonus != null)
                                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId, objMod.WirelessBonus, false, objMod.Rating, objMod.DisplayNameShort);
                            }
                        }
                        else
                        {
                            // Remove any Improvements the Mod created.
                            if (objMod.Bonus != null || (objMod.WirelessOn && objMod.WirelessBonus != null))
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ArmorMod, objMod.InternalId);
                        }
                    }

                    Armor objFoundArmor = null;
                    ArmorMod objFoundArmorMod = null;
                    Gear objGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor, out objFoundArmor, out objFoundArmorMod);
                    if (objGear != null)
                    {
                        objGear.Equipped = chkArmorEquipped.Checked;
                        if (chkArmorEquipped.Checked)
                        {
                            if (objFoundArmor.Equipped && (objFoundArmorMod == null || objFoundArmorMod.Equipped))
                            {
                                // Add the Gear's Improevments to the character.
                                if (objGear.Bonus != null)
                                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort);
                                if (objGear.WirelessOn && objGear.WirelessBonus != null)
                                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort);
                            }
                        }
                        else
                        {
                            // Remove any Improvements the Gear created.
                            if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
                                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                        }
                    }
                }
                RefreshSelectedArmor();
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cmdFireWeapon_Click(object sender, EventArgs e)
        {
            // "Click" the first menu item available.
            if (cmsAmmoSingleShot.Enabled)
                cmsAmmoSingleShot_Click(sender, e);
            else
            {
                if (cmsAmmoShortBurst.Enabled)
                    cmsAmmoShortBurst_Click(sender, e);
                else
                    cmsAmmoLongBurst_Click(sender, e);
            }
        }

        private void cmdReloadWeapon_Click(object sender, EventArgs e)
        {
            List<Gear> lstAmmo = new List<Gear>();
            List<string> lstCount = new List<string>();
            bool blnExternalSource = false;
            Gear objExternalSource = new Gear(_objCharacter);
            objExternalSource.Name = "External Source";

            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (!objWeapon.RequireAmmo)
            {
                // If the Weapon does not require Ammo, just use External Source.
                lstAmmo.Add(objExternalSource);
            }
            else
            {
                string ammoString = objWeapon.CalculatedAmmo(true);
                // Determine which loading methods are available to the Weapon.
                if (ammoString.Contains(" or ") || ammoString.Contains('x') || ammoString.Contains("Special") || ammoString.Contains('+'))
                {
                    string strWeaponAmmo = ammoString.ToLower();
                    if (strWeaponAmmo.Contains("external source"))
                        blnExternalSource = true;
                    // Get rid of external source, special, or belt, and + energy.
                    strWeaponAmmo = strWeaponAmmo.Replace("external source", "100");
                    strWeaponAmmo = strWeaponAmmo.Replace("special", "100");
                    strWeaponAmmo = strWeaponAmmo.Replace(" + energy", string.Empty);
                    strWeaponAmmo = strWeaponAmmo.Replace(" or belt", " or 250(belt)");


                    string[] strAmmos = strWeaponAmmo.Split(new[] { " or " }, StringSplitOptions.RemoveEmptyEntries);

                    foreach (string strAmmo in strAmmos)
                    {
                        string strThisAmmo = strAmmo;
                        if (strThisAmmo.StartsWith("2x") || strThisAmmo.StartsWith("3x") || strThisAmmo.StartsWith("4x"))
                            strThisAmmo = strThisAmmo.Substring(2, strThisAmmo.Length - 2);
                        if (strThisAmmo.EndsWith("x2") || strThisAmmo.EndsWith("x3") || strThisAmmo.EndsWith("x4"))
                            strThisAmmo = strThisAmmo.Substring(0, strThisAmmo.Length - 2);

                        if (strThisAmmo.Contains('('))
                            strThisAmmo = strThisAmmo.Substring(0, strThisAmmo.IndexOf('('));

                        lstCount.Add(strThisAmmo);
                    }
                }
                else
                {
                    // Nothing weird in the ammo string, so just use the number given.
                    string strAmmo = ammoString;
                    if (strAmmo.Contains('('))
                        strAmmo = strAmmo.Substring(0, strAmmo.IndexOf('('));
                    lstCount.Add(strAmmo);
                }

                // Load ammo for flare guns
                if (objWeapon.Spec == "Flare Launcher" && objWeapon.Name == "Micro Flare Launcher")
                {
                    lstAmmo.AddRange(_objCharacter.Gear.DeepWhere(x => x.Children, x => x.Name == "Micro Flares" && x.Category == "Survival Gear" && x.Quantity > 0));
                }
                // Find all of the Ammo for the current Weapon that the character is carrying.
                if (objWeapon.AmmoCategory != "Grenade Launchers" && objWeapon.AmmoCategory != "Missile Launchers" && objWeapon.AmmoCategory != "Mortar Launchers")
                {
                    // This is a standard Weapon, so consume traditional Ammunition.
                    lstAmmo.AddRange(_objCharacter.Gear.DeepWhere(x => x.Children, x => x.Category == "Ammunition" && x.Quantity > 0 && (x.Extra == objWeapon.AmmoCategory || (objWeapon.UseSkill == "Throwing Weapons" && objWeapon.Name == x.Name))));
                }
                else if (objWeapon.AmmoCategory == "Grenade Launchers")
                {
                    // Grenade Launchers can only use Grenades.
                    lstAmmo.AddRange(_objCharacter.Gear.DeepWhere(x => x.Children, x => x.Category == "Ammunition" && x.Quantity > 0 && x.Name.StartsWith("Minigrenade:")));
                }
                else if (objWeapon.AmmoCategory == "Missile Launchers")
                {
                    // Missile Launchers can only use Missiles and Rockets.
                    lstAmmo.AddRange(_objCharacter.Gear.DeepWhere(x => x.Children, x => x.Category == "Ammunition" && x.Quantity > 0 && (x.Name.StartsWith("Missile:") || x.Name.StartsWith("Rocket:"))));
                }
                else if (objWeapon.AmmoCategory == "Mortar Launchers")
                {
                    // Mortar Launchers can only use Mortars.
                    lstAmmo.AddRange(_objCharacter.Gear.DeepWhere(x => x.Children, x => x.Category == "Ammunition" && x.Quantity > 0 && x.Name.StartsWith("Mortar Round:")));
                }

                // If the Weapon is allowed to use an External Source, put in an External Source item.
                if (blnExternalSource)
                {
                    lstAmmo.Add(objExternalSource);
                }

                // Make sure the character has some form of Ammunition for this Weapon.
                if (lstAmmo.Count == 0)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmoType").Replace("{0}", objWeapon.DisplayAmmoCategory), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    return;
                }
            }

            // Show the Ammunition Selection window.
            frmReload frmReloadWeapon = new frmReload();
            frmReloadWeapon.Ammo = lstAmmo;
            frmReloadWeapon.Count = lstCount;
            frmReloadWeapon.ShowDialog(this);

            if (frmReloadWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Return any unspent rounds to the Ammo.
            if (objWeapon.AmmoRemaining > 0)
            {
                foreach (Gear objAmmo in _objCharacter.Gear)
                {
                    if (objAmmo.InternalId == objWeapon.AmmoLoaded)
                    {
                        objAmmo.Quantity += objWeapon.AmmoRemaining;

                        // Refresh the Gear tree.
                        TreeNode objNode = CommonFunctions.FindNode(objAmmo.InternalId, treGear);
                        if (objNode != null)
                        {
                            objNode.Text = objAmmo.DisplayName;
                        }

                        break;
                    }
                    foreach (Gear objChild in objAmmo.Children.GetAllDescendants(x => x.Children))
                    {
                        if (objChild.InternalId == objWeapon.AmmoLoaded)
                        {
                            // If this is a plugin for a Spare Clip, move any extra rounds to the character instead of messing with the Clip amount.
                            if (objChild.Parent.Name.StartsWith("Spare Clip") || objChild.Parent.Name.StartsWith("Speed Loader"))
                            {
                                TreeNode objNewNode = new TreeNode();
                                List<Weapon> lstWeapons = new List<Weapon>();
                                List<TreeNode> lstWeaponNodes = new List<TreeNode>();
                                Gear objNewGear = new Gear(_objCharacter);
                                objNewGear.Copy(objChild, objNewNode, lstWeapons, lstWeaponNodes);
                                objNewGear.Quantity = objWeapon.AmmoRemaining;
                                objNewNode.Text = objNewGear.DisplayName;
                                _objCharacter.Gear.Add(objNewGear);
                                treGear.Nodes[0].Nodes.Add(objNewNode);
                                goto EndLoop;
                            }
                            else
                                objChild.Quantity += objWeapon.AmmoRemaining;

                            // Refresh the Gear tree.
                            TreeNode objNode = CommonFunctions.FindNode(objChild.InternalId, treGear);
                            if (objNode != null)
                            {
                                objNode.Text = objAmmo.DisplayName;
                            }
                            break;
                        }
                    }
                }
                EndLoop:;
            }

            Gear objSelectedAmmo = null;
            decimal decQty = frmReloadWeapon.SelectedCount;
            // If an External Source is not being used, consume ammo.
            if (frmReloadWeapon.SelectedAmmo != objExternalSource.InternalId)
            {
                objSelectedAmmo = CommonFunctions.DeepFindById(frmReloadWeapon.SelectedAmmo, _objCharacter.Gear);

                if (objSelectedAmmo.Quantity == decQty && objSelectedAmmo.Parent != null)
                {
                    // If the Ammo is coming from a Spare Clip, reduce the container quantity instead of the plugin quantity.
                    if (objSelectedAmmo.Parent.Name.StartsWith("Spare Clip") || objSelectedAmmo.Parent.Name.StartsWith("Speed Loader"))
                    {
                        if (objSelectedAmmo.Parent.Quantity > 0)
                            objSelectedAmmo.Parent.Quantity--;
                        TreeNode objNode = CommonFunctions.FindNode(objSelectedAmmo.Parent.InternalId, treGear);
                        objNode.Text = objSelectedAmmo.Parent.DisplayName;
                    }
                }
                else
                {
                    // Deduct the ammo qty from the ammo. If there isn't enough remaining, use whatever is left.
                    if (objSelectedAmmo.Quantity > decQty)
                        objSelectedAmmo.Quantity -= decQty;
                    else
                    {
                        decQty = objSelectedAmmo.Quantity;
                        objSelectedAmmo.Quantity = 0;
                    }
                }

                // Refresh the Gear tree.
                TreeNode objSelectedNode = CommonFunctions.FindNode(objSelectedAmmo.InternalId, treGear);
                if (objSelectedNode != null)
                    objSelectedNode.Text = objSelectedAmmo.DisplayName;
            }
            else
            {
                objSelectedAmmo = objExternalSource;
            }

            objWeapon.AmmoRemaining = decimal.ToInt32(decQty);
            objWeapon.AmmoLoaded = objSelectedAmmo.InternalId;
            lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();

            ScheduleCharacterUpdate();
            RefreshSelectedWeapon();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkWeaponAccessoryInstalled_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;
            // Locate the selected Weapon Accessory or Modification.
            WeaponAccessory objAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objAccessory != null)
            {
                objAccessory.Installed = chkWeaponAccessoryInstalled.Checked;
            }
            else
            {
                // Determine if this is an Underbarrel Weapon.
                Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
                if (objWeapon != null)
                {
                    objWeapon.Installed = chkWeaponAccessoryInstalled.Checked;
                }
                else
                {
                    // Find the selected Gear.
                    Gear objSelectedGear = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

                    if (objSelectedGear != null)
                    {
                        objSelectedGear.Equipped = chkWeaponAccessoryInstalled.Checked;

                        CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedGear, chkWeaponAccessoryInstalled.Checked);
                    }
                }
            }
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkIncludedInWeapon_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;
            // Locate the selected Weapon Accessory or Modification.
            WeaponAccessory objAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
            if (objAccessory != null)
            {
                objAccessory.IncludedInWeapon = chkIncludedInWeapon.Checked;

                _blnIsDirty = true;
                UpdateWindowTitle();
                ScheduleCharacterUpdate();
            }
        }

        private void treGear_ItemDrag(object sender, ItemDragEventArgs e)
        {
            if (treGear.SelectedNode != null)
            {
                if (e.Button == MouseButtons.Left)
                {
                    if (treGear.SelectedNode.Level != 1 && treGear.SelectedNode.Level != 0)
                        return;
                    _objDragButton = MouseButtons.Left;
                }
                else
                {
                    if (treGear.SelectedNode.Level == 0)
                        return;
                    _objDragButton = MouseButtons.Right;
                }

                // Do not allow the root element to be moved.
                if (treGear.SelectedNode.Tag.ToString() == "Node_SelectedGear")
                    return;

            _intDragLevel = treGear.SelectedNode.Level;
            DoDragDrop(e.Item, DragDropEffects.Move);
        }
        }

        private void treGear_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treGear_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treGear.Nodes.Count > 0)
            {
                intNewIndex = treGear.Nodes[treGear.Nodes.Count - 1].Nodes.Count;
                nodDestination = treGear.Nodes[treGear.Nodes.Count - 1];
            }

            // If the item was moved using the left mouse button, change the order of things.
            if (_objDragButton == MouseButtons.Left)
            {
                if (treGear.SelectedNode.Level == 1)
                    CommonFunctions.MoveGearNode(_objCharacter, intNewIndex, nodDestination, treGear);
                else
                    CommonFunctions.MoveGearRoot(_objCharacter, intNewIndex, nodDestination, treGear);
            }
            if (_objDragButton == MouseButtons.Right)
                CommonFunctions.MoveGearParent(_objCharacter, nodDestination, treGear, cmsGear);

            // Clear the background color for all Nodes.
            treGear.ClearNodeBackground(null);

            _objDragButton = MouseButtons.None;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treGear_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (_objDragButton == MouseButtons.Left)
            {
                if (objNode.Level <= _intDragLevel)
                    objNode.BackColor = SystemColors.ControlDark;
            }
            else
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treGear.ClearNodeBackground(objNode);
        }

        private void chkGearEquipped_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || treGear.SelectedNode == null)
                return;

            // Attempt to locate the selected piece of Gear.
            Gear objSelectedGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objSelectedGear != null)
            {
                objSelectedGear.Equipped = chkGearEquipped.Checked;

                CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedGear, chkGearEquipped.Checked);

                RefreshSelectedGear();
                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void cboWeaponAmmo_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (treWeapons.SelectedNode == null || treWeapons.SelectedNode.Level == 0)
                    return;

            if (_blnSkipRefresh)
                return;

            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            objWeapon.ActiveAmmoSlot = Convert.ToInt32(cboWeaponAmmo.SelectedValue.ToString());
            ScheduleCharacterUpdate();
            RefreshSelectedWeapon();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkGearHomeNode_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;
            string strGuid = treGear.SelectedNode?.Tag.ToString() ?? string.Empty;
            if (!string.IsNullOrEmpty(strGuid))
            {
                Commlink objCommlink = CommonFunctions.FindCommlink(strGuid, _objCharacter.Gear.GetAllDescendants(x => x.Children));
                if (objCommlink != null)
                {
                    objCommlink.HomeNode = chkGearHomeNode.Checked;
                    RefreshSelectedGear();
                    if (chkVehicleHomeNode.Checked)
                        RefreshSelectedVehicle();
                    ScheduleCharacterUpdate();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void cmdWeaponBuyAmmo_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

            bool blnAddAgain = PickGear(true, null, objWeapon.AmmoCategory);
            if (blnAddAgain)
                cmdWeaponBuyAmmo_Click(sender, e);
        }

        private void cmdWeaponMoveToVehicle_Click(object sender, EventArgs e)
        {
            // Locate the selected Weapon.
            Weapon objWeapon = null;
            foreach (Weapon objCharacterWeapon in _objCharacter.Weapons)
            {
                if (objCharacterWeapon.InternalId == treWeapons.SelectedNode.Tag.ToString())
                {
                    objWeapon = objCharacterWeapon;
                    break;
                }
            }

            List<Vehicle> lstVehicles = new List<Vehicle>();
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                foreach (VehicleMod objVehicleMod in objCharacterVehicle.Mods)
                {
                    // Only add a Vehicle to the list if it has a Weapon Mount or Mechanical Arm.
                    if (objVehicleMod.Name.Contains("Weapon Mount") || objVehicleMod.Name.StartsWith("Mechanical Arm") || (!string.IsNullOrEmpty(objVehicleMod.WeaponMountCategories) && objVehicleMod.WeaponMountCategories.Contains(objWeapon.Category)))
                    {
                        lstVehicles.Add(objCharacterVehicle);
                        break;
                    }
                }
            }

            // Cannot continue if there are no Vehicles with a Weapon Mount or Mechanical Arm.
            if (lstVehicles.Count == 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotMoveWeapons"), LanguageManager.GetString("MessageTitle_CannotMoveWeapons"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectItem frmPickItem = new frmSelectItem();
            frmPickItem.Vehicles = lstVehicles;
            frmPickItem.ShowDialog(this);

            if (frmPickItem.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected Vehicle.
            Vehicle objVehicle = null;
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                if (objCharacterVehicle.InternalId == frmPickItem.SelectedItem)
                {
                    objVehicle = objCharacterVehicle;
                    break;
                }
            }

            // Now display a list of the acceptable mounting points for the Weapon.
            List<VehicleMod> lstMods = new List<VehicleMod>();
            foreach (VehicleMod objVehicleMod in objVehicle.Mods)
            {
                if (objVehicleMod.Name.Contains("Weapon Mount") || objVehicleMod.Name.StartsWith("Mechanical Arm") || (!string.IsNullOrEmpty(objVehicleMod.WeaponMountCategories) && objVehicleMod.WeaponMountCategories.Contains(objWeapon.Category)))
                    lstMods.Add(objVehicleMod);
            }

            frmPickItem.VehicleMods = lstMods;
            frmPickItem.ShowDialog(this);

            if (frmPickItem.DialogResult == DialogResult.Cancel)
                return;

            // Locate the selected Vehicle Mod.
            VehicleMod objMod = null;
            foreach (VehicleMod objCharacterMod in objVehicle.Mods)
            {
                if (objCharacterMod.InternalId == frmPickItem.SelectedItem)
                {
                    objMod = objCharacterMod;
                    break;
                }
            }

            // Remove the Weapon from the character and add it to the Vehicle Mod.
            _objCharacter.Weapons.Remove(objWeapon);
            objMod.Weapons.Add(objWeapon);
            objWeapon.VehicleMounted = true;
            objWeapon.Location = string.Empty;

            // Move the TreeNode to the Vehicle Mod.
            TreeNode objNode = new TreeNode();
            objNode = treWeapons.SelectedNode;
            treWeapons.SelectedNode.Remove();

            foreach (TreeNode objVehicleNode in treVehicles.Nodes[0].Nodes)
            {
                foreach (TreeNode objModNode in objVehicleNode.Nodes)
                {
                    if (objModNode.Tag.ToString() == objMod.InternalId)
                    {
                        objModNode.Nodes.Add(objNode);
                        objModNode.Expand();
                        objNode.Expand();
                        break;
                    }
                }
            }

            // Remove any Improvements from the Character.
            foreach (WeaponAccessory objAccessory in objWeapon.WeaponAccessories)
            {
                foreach (Gear objGear in objAccessory.Gear)
                    CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
            }
            if (objWeapon.UnderbarrelWeapons.Count > 0)
            {
                foreach (Weapon objUnderbarrelWeapon in objWeapon.UnderbarrelWeapons)
                {
                    foreach (WeaponAccessory objAccessory in objUnderbarrelWeapon.WeaponAccessories)
                    {
                        foreach (Gear objGear in objAccessory.Gear)
                            CommonFunctions.DeleteGear(_objCharacter, objGear, treWeapons, treVehicles);
                    }
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdArmorIncrease_Click(object sender, EventArgs e)
        {
            Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            if (objArmor == null)
                return;

            objArmor.ArmorDamage--;
            RefreshSelectedArmor();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdArmorDecrease_Click(object sender, EventArgs e)
        {
            Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            if (objArmor == null)
                return;

            objArmor.ArmorDamage++;
            RefreshSelectedArmor();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkIncludedInArmor_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // Locate the selected Armor Modification.
            ArmorMod objMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            if (objMod != null)
                objMod.IncludedInArmor = chkIncludedInArmor.Checked;

            _blnIsDirty = true;
            UpdateWindowTitle();
            ScheduleCharacterUpdate();
        }

        private void chkCommlinks_CheckedChanged(object sender, EventArgs e)
        {
            PopulateGearList();
        }

        private void chkActiveCommlink_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // Attempt to locate the selected piece of Gear.
            if (treGear.SelectedNode != null)
            {
                Commlink objSelectedCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
                if (objSelectedCommlink != null)
                {
                    objSelectedCommlink.IsActive = chkActiveCommlink.Checked;

                    RefreshSelectedGear();
                    ScheduleCharacterUpdate();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }

        private void cboGearAttack_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboGearAttack.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objCommlink == null)
                return;
            int intCurrentIndex = cboGearAttack.SelectedIndex;

            _blnLoading = true;
            string strTemp = objCommlink.Attack;
            bool blnRefreshCBOs = true;
            // Find the combo with the same value as this one and change it to the missing value.
            if (cboGearSleaze.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Attack = objCommlink.Sleaze;
                objCommlink.Sleaze = strTemp;
            }
            else if (cboGearDataProcessing.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Attack = objCommlink.DataProcessing;
                objCommlink.DataProcessing = strTemp;
            }
            else if (cboGearFirewall.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Attack = objCommlink.Firewall;
                objCommlink.Firewall = strTemp;
            }
            else
                blnRefreshCBOs = false;
            if (blnRefreshCBOs)
            {
                objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
                if (objCommlink.IsActive || objCommlink.HomeNode)
                {
                    ScheduleCharacterUpdate();
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            _blnLoading = false;
        }
        private void cboGearSleaze_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboGearSleaze.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objCommlink == null)
                return;
            int intCurrentIndex = cboGearSleaze.SelectedIndex;

            _blnLoading = true;
            string strTemp = objCommlink.Sleaze;
            bool blnRefreshCBOs = true;
            // Find the combo with the same value as this one and change it to the missing value.
            if (cboGearAttack.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Sleaze = objCommlink.Attack;
                objCommlink.Attack = strTemp;
            }
            else if (cboGearDataProcessing.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Sleaze = objCommlink.DataProcessing;
                objCommlink.DataProcessing = strTemp;
            }
            else if (cboGearFirewall.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Sleaze = objCommlink.Firewall;
                objCommlink.Firewall = strTemp;
            }
            else
                blnRefreshCBOs = false;
            if (blnRefreshCBOs)
            {
                objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
                if (objCommlink.IsActive || objCommlink.HomeNode)
                {
                    ScheduleCharacterUpdate();
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            _blnLoading = false;
        }
        private void cboGearDataProcessing_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboGearDataProcessing.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objCommlink == null)
                return;
            int intCurrentIndex = cboGearDataProcessing.SelectedIndex;

            _blnLoading = true;
            string strTemp = objCommlink.DataProcessing;
            bool blnRefreshCBOs = true;
            // Find the combo with the same value as this one and change it to the missing value.
            if (cboGearSleaze.SelectedIndex == intCurrentIndex)
            {
                objCommlink.DataProcessing = objCommlink.Sleaze;
                objCommlink.Sleaze = strTemp;
            }
            else if (cboGearAttack.SelectedIndex == intCurrentIndex)
            {
                objCommlink.DataProcessing = objCommlink.Attack;
                objCommlink.Attack = strTemp;
            }
            else if (cboGearFirewall.SelectedIndex == intCurrentIndex)
            {
                objCommlink.DataProcessing = objCommlink.Firewall;
                objCommlink.Firewall = strTemp;
            }
            else
                blnRefreshCBOs = false;
            if (blnRefreshCBOs)
            {
                objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
                if (objCommlink.IsActive || objCommlink.HomeNode)
                {
                    ScheduleCharacterUpdate();
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            _blnLoading = false;
        }
        private void cboGearFirewall_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboGearFirewall.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objCommlink == null)
                return;
            int intCurrentIndex = cboGearFirewall.SelectedIndex;

            _blnLoading = true;
            string strTemp = objCommlink.Firewall;
            bool blnRefreshCBOs = true;
            // Find the combo with the same value as this one and change it to the missing value.
            if (cboGearAttack.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Firewall = objCommlink.Attack;
                objCommlink.Attack = strTemp;
            }
            else if (cboGearSleaze.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Firewall = objCommlink.Sleaze;
                objCommlink.Sleaze = strTemp;
            }
            else if (cboGearDataProcessing.SelectedIndex == intCurrentIndex)
            {
                objCommlink.Firewall = objCommlink.DataProcessing;
                objCommlink.DataProcessing = strTemp;
            }
            else
                blnRefreshCBOs = false;
            if (blnRefreshCBOs)
            {
                objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
                if (objCommlink.IsActive || objCommlink.HomeNode)
                {
                    ScheduleCharacterUpdate();
                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }

            _blnLoading = false;
        }

        private void cboVehicleGearAttack_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboVehicleGearAttack.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboVehicleGearAttack.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Attack;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboVehicleGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboVehicleGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboVehicleGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboVehicleGearSleaze_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboVehicleGearSleaze.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboVehicleGearSleaze.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Sleaze;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboVehicleGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboVehicleGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboVehicleGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboVehicleGearFirewall_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboVehicleGearFirewall.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboVehicleGearFirewall.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Firewall;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboVehicleGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboVehicleGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboVehicleGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboVehicleGearDataProcessing_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboVehicleGearDataProcessing.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboVehicleGearDataProcessing.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.DataProcessing;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboVehicleGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboVehicleGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboVehicleGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }

        private void cboCyberwareGearAttack_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboCyberwareGearAttack.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children)) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboCyberwareGearAttack.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Attack;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboCyberwareGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboCyberwareGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboCyberwareGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboCyberwareGearSleaze_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboCyberwareGearSleaze.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children)) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboCyberwareGearSleaze.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Sleaze;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboCyberwareGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboCyberwareGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboCyberwareGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboCyberwareGearDataProcessing_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboCyberwareGearDataProcessing.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children)) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboCyberwareGearDataProcessing.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.DataProcessing;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboCyberwareGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboCyberwareGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboCyberwareGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboCyberwareGearFirewall_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboCyberwareGearFirewall.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware.GetAllDescendants(x => x.Children)) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboCyberwareGearFirewall.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Firewall;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboCyberwareGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboCyberwareGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboCyberwareGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }

        private void cboWeaponGearAttack_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboWeaponGearAttack.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboWeaponGearAttack.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Attack;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboWeaponGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboWeaponGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboWeaponGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Attack = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboWeaponGearAttack, cboWeaponGearSleaze, cboWeaponGearDataProcessing, cboWeaponGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboWeaponGearSleaze_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboWeaponGearSleaze.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboWeaponGearSleaze.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Sleaze;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboWeaponGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboWeaponGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else if (cboWeaponGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Sleaze = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboWeaponGearAttack, cboWeaponGearSleaze, cboWeaponGearDataProcessing, cboWeaponGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboWeaponGearDataProcessing_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboWeaponGearDataProcessing.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboWeaponGearDataProcessing.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.DataProcessing;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboWeaponGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboWeaponGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboWeaponGearFirewall.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.DataProcessing = objCommlink.Firewall;
                    objCommlink.Firewall = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboWeaponGearAttack, cboWeaponGearSleaze, cboWeaponGearDataProcessing, cboWeaponGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
        private void cboWeaponGearFirewall_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || !cboWeaponGearFirewall.Enabled)
                return;
            Commlink objCommlink = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons) as Commlink;
            if (objCommlink != null)
            {
                int intCurrentIndex = cboWeaponGearFirewall.SelectedIndex;

                _blnLoading = true;
                string strTemp = objCommlink.Firewall;
                bool blnRefreshCBOs = true;
                // Find the combo with the same value as this one and change it to the missing value.
                if (cboWeaponGearAttack.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Attack;
                    objCommlink.Attack = strTemp;
                }
                else if (cboWeaponGearSleaze.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.Sleaze;
                    objCommlink.Sleaze = strTemp;
                }
                else if (cboWeaponGearDataProcessing.SelectedIndex == intCurrentIndex)
                {
                    objCommlink.Firewall = objCommlink.DataProcessing;
                    objCommlink.DataProcessing = strTemp;
                }
                else
                    blnRefreshCBOs = false;
                if (blnRefreshCBOs)
                {
                    objCommlink.RefreshCommlinkCBOs(cboWeaponGearAttack, cboWeaponGearSleaze, cboWeaponGearDataProcessing, cboWeaponGearFirewall);
                    if (objCommlink.IsActive || objCommlink.HomeNode)
                    {
                        ScheduleCharacterUpdate();
                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }

                _blnLoading = false;
            }
        }
#endregion

#region Additional Vehicle Tab Control Events
        private void treVehicles_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedVehicle();
            RefreshPasteStatus();
        }

        private void treVehicles_ItemDrag(object sender, ItemDragEventArgs e)
        {
            if (treVehicles.SelectedNode != null)
            {
                if (treVehicles.SelectedNode.Level != 1)
                {
                    // Determine if this is a piece of Gear. If not, don't let the user drag the Node.
                    Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                    if (objGear != null)
                    {
                        _objDragButton = e.Button;
                        _blnDraggingGear = true;
                        _intDragLevel = treVehicles.SelectedNode.Level;
                        DoDragDrop(e.Item, DragDropEffects.Move);
                    }
                }
            }
        }

        private void treVehicles_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treVehicles_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treVehicles.Nodes.Count > 0)
            {
                intNewIndex = treVehicles.Nodes[treVehicles.Nodes.Count - 1].Nodes.Count;
                nodDestination = treVehicles.Nodes[treVehicles.Nodes.Count - 1];
            }

            if (!_blnDraggingGear)
            {
                CommonFunctions.MoveVehicleNode(_objCharacter, intNewIndex, nodDestination, treVehicles);
            }
            else
            {
                if (_objDragButton == MouseButtons.Left)
                    return;
                else
                    CommonFunctions.MoveVehicleGearParent(_objCharacter, nodDestination, treVehicles, cmsVehicleGear);
            }

            // Clear the background color for all Nodes.
            treVehicles.ClearNodeBackground(null);

            _blnDraggingGear = false;

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treVehicles_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (_objDragButton == MouseButtons.Left)
            {
                if (objNode.Level <= _intDragLevel)
                    objNode.BackColor = SystemColors.ControlDark;
            }
            else
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treVehicles.ClearNodeBackground(objNode);
        }

        private void cmdFireVehicleWeapon_Click(object sender, EventArgs e)
        {
            // "Click" the first menu item available.
            if (cmsVehicleAmmoSingleShot.Enabled)
                cmsVehicleAmmoSingleShot_Click(sender, e);
            else
            {
                if (cmsVehicleAmmoShortBurst.Enabled)
                    cmsVehicleAmmoShortBurst_Click(sender, e);
                else
                    cmsVehicleAmmoLongBurst_Click(sender, e);
            }
        }

        private void cmdReloadVehicleWeapon_Click(object sender, EventArgs e)
        {
            Vehicle objVehicle = null;

            List<Gear> lstAmmo = new List<Gear>();
            List<string> lstCount = new List<string>();
            bool blnExternalSource = false;

            Gear objExternalSource = new Gear(_objCharacter);
            objExternalSource.Name = "External Source";

            // Locate the selected Vehicle Weapon.
            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objVehicle);

            // Determine which loading methods are available to the Weapon.
            string ammoString = objWeapon.CalculatedAmmo();
            if (ammoString.Contains(" or ") || ammoString.Contains('x') || ammoString.Contains("Special") || ammoString.Contains('+'))
            {
                string strWeaponAmmo = ammoString.ToLower();
                if (strWeaponAmmo.Contains("external source"))
                    blnExternalSource = true;
                // Get rid of external source, special, or belt, and + energy.
                strWeaponAmmo = strWeaponAmmo.Replace("external source", "100");
                strWeaponAmmo = strWeaponAmmo.Replace("special", "100");
                strWeaponAmmo = strWeaponAmmo.Replace(" + energy", string.Empty);
                strWeaponAmmo = strWeaponAmmo.Replace(" or belt", string.Empty);

                string[] strSplit = new string[] { " or " };
                string[] strAmmos = strWeaponAmmo.Split(strSplit, StringSplitOptions.RemoveEmptyEntries);

                foreach (string strAmmo in strAmmos)
                {
                    string strThisAmmo = strAmmo;
                    if (strThisAmmo.StartsWith("2x") || strThisAmmo.StartsWith("3x") || strThisAmmo.StartsWith("4x"))
                        strThisAmmo = strThisAmmo.Substring(2, strThisAmmo.Length - 2);
                    if (strThisAmmo.EndsWith("x2") || strThisAmmo.EndsWith("x3") || strThisAmmo.EndsWith("x4"))
                        strThisAmmo = strThisAmmo.Substring(0, strThisAmmo.Length - 2);

                    if (strThisAmmo.Contains('('))
                        strThisAmmo = strThisAmmo.Substring(0, strThisAmmo.IndexOf('('));

                    lstCount.Add(strThisAmmo);
                }
            }
            else
            {
                // Nothing weird in the ammo string, so just use the number given.
                if (ammoString.Contains('('))
                    ammoString = ammoString.Substring(0, ammoString.IndexOf('('));
                lstCount.Add(ammoString);
            }

            // Find all of the Ammo for the current Weapon that the character is carrying.
            if (objWeapon.AmmoCategory != "Grenade Launchers" && objWeapon.AmmoCategory != "Missile Launchers" && objWeapon.AmmoCategory != "Mortar Launchers")
            {
                // This is a standard Weapon, so consume traditional Ammunition.
                foreach (Gear objAmmo in objVehicle.Gear)
                {
                    if (objAmmo.Quantity > 0)
                    {
                        if (objAmmo.Category == "Ammunition" && objAmmo.Extra == objWeapon.AmmoCategory)
                            lstAmmo.Add(objAmmo);
                    }
                }
            }
            else
            {
                if (objWeapon.AmmoCategory == "Grenade Launchers")
                {
                    // Grenade Launchers can only use Grenades.
                    foreach (Gear objAmmo in objVehicle.Gear)
                    {
                        if (objAmmo.Quantity > 0)
                        {
                            if (objAmmo.Category == "Ammunition" && objAmmo.Name.StartsWith("Minigrenade:"))
                                lstAmmo.Add(objAmmo);
                        }
                    }
                }
                if (objWeapon.AmmoCategory == "Missile Launchers")
                {
                    // Missile Launchers can only use Missiles and Rockets.
                    foreach (Gear objAmmo in objVehicle.Gear)
                    {
                        if (objAmmo.Quantity > 0)
                        {
                            if (objAmmo.Category == "Ammunition" && (objAmmo.Name.StartsWith("Missile:") || objAmmo.Name.StartsWith("Rocket:")))
                                lstAmmo.Add(objAmmo);
                        }
                    }
                }
                if (objWeapon.AmmoCategory == "Mortar Launchers")
                {
                    // Mortar Launchers can only use Mortars.
                    foreach (Gear objAmmo in objVehicle.Gear)
                    {
                        if (objAmmo.Quantity > 0)
                        {
                            if (objAmmo.Category == "Ammunition" && objAmmo.Name.StartsWith("Mortar Round:"))
                                lstAmmo.Add(objAmmo);
                        }
                    }
                }
            }

            // If the Weapon is allowed to use an External Source, put in an External Source item.
            if (blnExternalSource)
                lstAmmo.Add(objExternalSource);

            // Make sure the character has some form of Ammunition for this Weapon.
            if (lstAmmo.Count == 0 && objWeapon.RequireAmmo)
            {
                MessageBox.Show(LanguageManager.GetString("Message_OutOfAmmoType").Replace("{0}", objWeapon.DisplayAmmoCategory), LanguageManager.GetString("MessageTitle_OutOfAmmo"), MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            if (!objWeapon.RequireAmmo)
            {
                // If the Weapon does not require Ammo, clear the Ammo list and just use External Source.
                lstAmmo.Clear();
                lstAmmo.Add(objExternalSource);
            }

            // Show the Ammunition Selection window.
            frmReload frmReloadWeapon = new frmReload();
            frmReloadWeapon.Ammo = lstAmmo;
            frmReloadWeapon.Count = lstCount;
            frmReloadWeapon.ShowDialog(this);

            if (frmReloadWeapon.DialogResult == DialogResult.Cancel)
                return;

            // Return any unspent rounds to the Ammo.
            if (objWeapon.AmmoRemaining > 0)
            {
                foreach (Gear objAmmo in objVehicle.Gear)
                {
                    if (objAmmo.InternalId == objWeapon.AmmoLoaded)
                    {
                        objAmmo.Quantity += objWeapon.AmmoRemaining;

                        TreeNode objSelectedNode = CommonFunctions.FindNode(objAmmo.InternalId, treVehicles);
                        if (objSelectedNode != null)
                            objSelectedNode.Text = objAmmo.DisplayName;
                        break;
                    }
                }
            }

            Gear objSelectedAmmo = null;
            decimal decQty = frmReloadWeapon.SelectedCount;
            // If an External Source is not being used, consume ammo.
            if (frmReloadWeapon.SelectedAmmo != objExternalSource.InternalId)
            {
                foreach (Gear objGear in objVehicle.Gear)
                {
                    if (objGear.InternalId == frmReloadWeapon.SelectedAmmo)
                    {
                        objSelectedAmmo = objGear;
                        break;
                    }
                }

                // Deduct the ammo qty from the ammo. If there isn't enough remaining, use whatever is left.
                if (objSelectedAmmo.Quantity > decQty)
                    objSelectedAmmo.Quantity -= decQty;
                else
                {
                    decQty = objSelectedAmmo.Quantity;
                    objSelectedAmmo.Quantity = 0;
                }

                // Refresh the Vehicle tree.
                TreeNode objSelectedNode = CommonFunctions.FindNode(objSelectedAmmo.InternalId, treVehicles);
                if (objSelectedNode != null)
                    objSelectedNode.Text = objSelectedAmmo.DisplayName;
            }
            else
            {
                objSelectedAmmo = objExternalSource;
            }

            objWeapon.AmmoRemaining = decimal.ToInt32(decQty);
            objWeapon.AmmoLoaded = objSelectedAmmo.InternalId;
            lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkVehicleWeaponAccessoryInstalled_CheckedChanged(object sender, EventArgs e)
        {
            // Locate the the Selected Vehicle Weapon Accessory of Modification.
            WeaponAccessory objAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objAccessory != null)
                objAccessory.Installed = chkVehicleWeaponAccessoryInstalled.Checked;
            else
            {
                // If this isn't a Weapon Mod, then it must be a Vehicle Mod.
                VehicleMod objVehicleMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objVehicleMod != null)
                    objVehicleMod.Installed = chkVehicleWeaponAccessoryInstalled.Checked;
                else
                {
                    // If everything else has failed, we're left with a Vehicle Weapon.
                    Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                    objWeapon.Installed = chkVehicleWeaponAccessoryInstalled.Checked;
                }
            }

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cboVehicleWeaponAmmo_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level < 2)
            {
                return;
            }

            if (_blnSkipRefresh)
                return;

            Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);

            objWeapon.ActiveAmmoSlot = Convert.ToInt32(cboVehicleWeaponAmmo.SelectedValue.ToString());
            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkVehicleHomeNode_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;
            string strGuid = treVehicles.SelectedNode?.Tag.ToString() ?? string.Empty;
            if (!string.IsNullOrEmpty(strGuid))
            {
                Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(strGuid, _objCharacter.Vehicles);
                if (objVehicle != null)
                {
                    objVehicle.HomeNode = chkVehicleHomeNode.Checked;
                    RefreshSelectedVehicle();
                    if (chkGearHomeNode.Checked)
                        RefreshSelectedGear();
                    ScheduleCharacterUpdate();

                    _blnIsDirty = true;
                    UpdateWindowTitle();
                }
            }
        }
#endregion

#region Additional Spells and Spirits Tab Control Events
        private void treSpells_AfterSelect(object sender, TreeViewEventArgs e)
        {
            _blnSkipRefresh = true;
            if (treSpells.SelectedNode.Level > 0)
            {
                // Locate the selected Spell.
                Spell objSpell = CommonFunctions.FindByIdWithNameCheck(e.Node.Tag.ToString(), _objCharacter.Spells);

                lblSpellDescriptors.Text = objSpell.DisplayDescriptors;
                lblSpellCategory.Text = objSpell.DisplayCategory;
                lblSpellType.Text = objSpell.DisplayType;
                lblSpellRange.Text = objSpell.DisplayRange;
                lblSpellDamage.Text = objSpell.DisplayDamage;
                lblSpellDuration.Text = objSpell.DisplayDuration;
                lblSpellDV.Text = objSpell.DisplayDV;
                string strBook = _objOptions.LanguageBookShort(objSpell.Source);
                string strPage = objSpell.Page;
                lblSpellSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblSpellSource, _objOptions.LanguageBookLong(objSpell.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSpell.Page);

                // Determine the size of the Spellcasting Dice Pool.
                lblSpellDicePool.Text = objSpell.DicePool.ToString();
                tipTooltip.SetToolTip(lblSpellDicePool, objSpell.DicePoolTooltip);

                // Build the DV tooltip.
                tipTooltip.SetToolTip(lblSpellDV, objSpell.DVTooltip);

                // Update the Drain CharacterAttribute Value.
                if (_objCharacter.MAGEnabled && !string.IsNullOrEmpty(lblDrainAttributes.Text))
                {
                    string strTip = string.Empty;

                    string strDrain = lblDrainAttributes.Text;

                    foreach (string strAttribute in AttributeSection.AttributeStrings)
                    {
                        CharacterAttrib objAttrib = _objCharacter.GetAttribute(strAttribute);
                        strDrain = strDrain.CheapReplace(objAttrib.DisplayAbbrev, () => objAttrib.TotalValue.ToString());
                    }
                    int intDrain = 0;
                    try
                    {
                        intDrain = Convert.ToInt32(CommonFunctions.EvaluateInvariantXPath(strDrain).ToString());
                    }
                    catch (XPathException)
                    {
                    }
                    intDrain += ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DrainResistance);

                    strTip = lblDrainAttributes.Text;

                    foreach (string strAttribute in AttributeSection.AttributeStrings)
                    {
                        CharacterAttrib objAttrib = _objCharacter.GetAttribute(strAttribute);
                        strTip = strTip.CheapReplace(objAttrib.DisplayAbbrev, () => objAttrib.DisplayAbbrev + " (" + objAttrib.TotalValue.ToString() + ")");
                    }

                    if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DrainResistance) != 0)
                        strTip += " + " + LanguageManager.GetString("Tip_Skill_DicePoolModifiers") + " (" + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DrainResistance).ToString() + ")";
                    //if (objSpell.Limited)
                    //{
                    //    intDrain += 2;
                    //    strTip += " + " + LanguageManager.GetString("String_SpellLimited") + " (2)";
                    //}
                    lblDrainAttributesValue.Text = intDrain.ToString();
                    tipTooltip.SetToolTip(lblDrainAttributesValue, strTip);
                }
            }
            else
            {
                lblSpellDescriptors.Text = string.Empty;
                lblSpellCategory.Text = string.Empty;
                lblSpellType.Text = string.Empty;
                lblSpellRange.Text = string.Empty;
                lblSpellDamage.Text = string.Empty;
                lblSpellDuration.Text = string.Empty;
                lblSpellDV.Text = string.Empty;
                lblSpellSource.Text = string.Empty;
                lblSpellDicePool.Text = string.Empty;
                tipTooltip.SetToolTip(lblSpellSource, null);
                tipTooltip.SetToolTip(lblSpellDV, null);
            }
            _blnSkipRefresh = false;
        }

        private void treFoci_AfterCheck(object sender, TreeViewEventArgs e)
        {
            if (!e.Node.Checked)
            {
                Focus objFocus = _objCharacter.Foci.FirstOrDefault(x => x.GearId == e.Node.Tag.ToString());

                // Mark the Gear as not Bonded and remove any Improvements.
                Gear objGear = objFocus != null ? CommonFunctions.DeepFindById(objFocus.GearId, _objCharacter.Gear) : null;

                if (objGear != null)
                {
                    objGear.Bonded = false;
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId);
                    _objCharacter.Foci.Remove(objFocus);
                }
                else
                {
                    // This is a Stacked Focus.
                    StackedFocus objStack = _objCharacter.StackedFoci.FirstOrDefault(x => x.InternalId == e.Node.Tag.ToString());

                    if (objStack != null)
                    {
                        objStack.Bonded = false;
                        foreach (Gear objFocusGear in objStack.Gear)
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.StackedFocus, objStack.InternalId);
                        }
                    }
                }
            }

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treFoci_BeforeCheck(object sender, TreeViewCancelEventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // If the item is being unchecked, confirm that the user wants to un-bind the Focus.
            if (e.Node.Checked)
            {
                if (MessageBox.Show(LanguageManager.GetString("Message_UnbindFocus"), LanguageManager.GetString("MessageTitle_UnbindFocus"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    e.Cancel = true;
                return;
            }

            // Locate the Focus that is being touched.
            Gear objSelectedFocus = CommonFunctions.DeepFindById(e.Node.Tag.ToString(), _objCharacter.Gear);

            // Set the Focus count to 1 and get its current Rating (Force). This number isn't used in the following loops because it isn't yet checked or unchecked.
            int intFociCount = 1;
            int intFociTotal = 0;

            if (objSelectedFocus != null)
                intFociTotal = objSelectedFocus.Rating;
            else
            {
                // This is a Stacked Focus.
                StackedFocus objStack = new StackedFocus(_objCharacter);
                foreach (StackedFocus objCharacterFocus in _objCharacter.StackedFoci)
                {
                    if (e.Node.Tag.ToString() == objCharacterFocus.InternalId)
                    {
                        objStack = objCharacterFocus;
                        break;
                    }
                }
                intFociTotal = objStack.TotalForce;
            }

            // Run through the list of items. Count the number of Foci the character would have bonded including this one, plus the total Force of all checked Foci.
            foreach (TreeNode objNode in treFoci.Nodes)
            {
                if (objNode.Checked)
                {
                    intFociCount++;
                    foreach (Gear objCharacterFocus in _objCharacter.Gear)
                    {
                        if (objNode.Tag.ToString() == objCharacterFocus.InternalId)
                        {
                            intFociTotal += objCharacterFocus.Rating;
                            break;
                        }
                    }

                    foreach (StackedFocus objStack in _objCharacter.StackedFoci)
                    {
                        if (objNode.Tag.ToString() == objStack.InternalId)
                        {
                            intFociTotal += objStack.TotalForce;
                            break;
                        }
                    }
                }
            }

            if (!_objCharacter.IgnoreRules)
            {
                if (intFociTotal > _objCharacter.MAG.TotalValue * 5 ||
                    (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && intFociTotal > _objCharacter.MAGAdept.TotalValue * 5))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_FocusMaximumForce"), LanguageManager.GetString("MessageTitle_FocusMaximum"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    e.Cancel = true;
                    return;
                }

                if (intFociCount > _objCharacter.MAG.TotalValue ||
                    (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && intFociCount > _objCharacter.MAGAdept.TotalValue))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_FocusMaximumNumber"), LanguageManager.GetString("MessageTitle_FocusMaximum"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    e.Cancel = true;
                    return;
                }
            }

            // If we've made it this far, everything is okay, so create a Karma Expense for the newly-bound Focus.

            if (objSelectedFocus != null)
            {
                bool blnOldEquipped = objSelectedFocus.Equipped;
                Focus objFocus = new Focus(_objCharacter);
                objFocus.Name = objSelectedFocus.Name;
                objFocus.DisplayName = objSelectedFocus.DisplayNameShort;
                objFocus.Rating = objSelectedFocus.Rating;
                objFocus.GearId = e.Node.Tag.ToString();
                if (objSelectedFocus.Bonus != null || (objSelectedFocus.WirelessOn && objSelectedFocus.WirelessBonus != null))
                {
                    if (!string.IsNullOrEmpty(objSelectedFocus.Extra))
                        ImprovementManager.ForcedValue = objSelectedFocus.Extra;
                    if (objSelectedFocus.Bonus != null)
                    {
                        if (!ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objSelectedFocus.InternalId, objSelectedFocus.Bonus, false, objSelectedFocus.Rating, objSelectedFocus.DisplayNameShort))
                        {
                            // Clear created improvements
                            CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, false);
                            if (blnOldEquipped)
                                CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, true);
                            e.Cancel = true;
                            return;
                        }
                        objSelectedFocus.Extra = ImprovementManager.SelectedValue;
                    }
                    if (objSelectedFocus.WirelessOn && objSelectedFocus.WirelessBonus != null)
                    {
                        if (!ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objSelectedFocus.InternalId, objSelectedFocus.WirelessBonus, false, objSelectedFocus.Rating, objSelectedFocus.DisplayNameShort))
                        {
                            // Clear created improvements
                            CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, false);
                            if (blnOldEquipped)
                                CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, true);
                            e.Cancel = true;
                            return;
                        }
                    }
                }

                // Determine how much Karma the Focus will cost to bind.
                string strFocusName = objSelectedFocus.Name;
                string strFocusExtra = objSelectedFocus.Extra;
                int intPosition = strFocusName.IndexOf('(');
                if (intPosition > -1)
                    strFocusName = strFocusName.Substring(0, intPosition - 1);
                intPosition = strFocusName.IndexOf(',');
                if (intPosition > -1)
                    strFocusName = strFocusName.Substring(0, intPosition - 1);
                int intKarmaMultiplier = 1;
                int intExtraKarmaCost = 0;
                switch (strFocusName)
                {
                    case "Qi Focus":
                        intKarmaMultiplier = _objOptions.KarmaQiFocus;
                        break;
                    case "Sustaining Focus":
                        intKarmaMultiplier = _objOptions.KarmaSustainingFocus;
                        break;
                    case "Counterspelling Focus":
                        intKarmaMultiplier = _objOptions.KarmaCounterspellingFocus;
                        break;
                    case "Banishing Focus":
                        intKarmaMultiplier = _objOptions.KarmaBanishingFocus;
                        break;
                    case "Binding Focus":
                        intKarmaMultiplier = _objOptions.KarmaBindingFocus;
                        break;
                    case "Weapon Focus":
                        intKarmaMultiplier = _objOptions.KarmaWeaponFocus;
                        break;
                    case "Spellcasting Focus":
                        intKarmaMultiplier = _objOptions.KarmaSpellcastingFocus;
                        break;
                    case "Ritual Spellcasting Focus":
                        intKarmaMultiplier = _objOptions.KarmaRitualSpellcastingFocus;
                        break;
                    case "Spell Shaping Focus":
                        intKarmaMultiplier = _objOptions.KarmaSpellShapingFocus;
                        break;
                    case "Summoning Focus":
                        intKarmaMultiplier = _objOptions.KarmaSummoningFocus;
                        break;
                    case "Alchemical Focus":
                        intKarmaMultiplier = _objOptions.KarmaAlchemicalFocus;
                        break;
                    case "Centering Focus":
                        intKarmaMultiplier = _objOptions.KarmaCenteringFocus;
                        break;
                    case "Masking Focus":
                        intKarmaMultiplier = _objOptions.KarmaMaskingFocus;
                        break;
                    case "Disenchanting Focus":
                        intKarmaMultiplier = _objOptions.KarmaDisenchantingFocus;
                        break;
                    case "Power Focus":
                        intKarmaMultiplier = _objOptions.KarmaPowerFocus;
                        break;
                    case "Flexible Signature Focus":
                        intKarmaMultiplier = _objOptions.KarmaFlexibleSignatureFocus;
                        break;
                }
                foreach (Improvement objLoopImprovement in _objCharacter.Improvements.Where(x => x.ImprovedName == strFocusName && (string.IsNullOrEmpty(x.Target) || strFocusExtra.Contains(x.Target)) && x.Enabled))
                {
                    if (objLoopImprovement.ImproveType == Improvement.ImprovementType.FocusBindingKarmaCost)
                        intExtraKarmaCost += objLoopImprovement.Value;
                    else if (objLoopImprovement.ImproveType == Improvement.ImprovementType.FocusBindingKarmaMultiplier)
                        intKarmaMultiplier += objLoopImprovement.Value;
                }
                int intKarmaExpense = objSelectedFocus.Rating * intKarmaMultiplier + intExtraKarmaCost;
                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Clear created improvements
                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, false);
                    if (blnOldEquipped)
                        CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, true);
                    e.Cancel = true;
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseFocus").Replace("{0}", intKarmaExpense.ToString()).Replace("{1}", objSelectedFocus.DisplayNameShort)))
                {
                    // Clear created improvements
                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, false);
                    if (blnOldEquipped)
                        CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, true);
                    e.Cancel = true;
                    return;
                }

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseBound") + " " + objSelectedFocus.DisplayNameShort, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.BindFocus, objSelectedFocus.InternalId);
                objExpense.Undo = objUndo;

                _objCharacter.Foci.Add(objFocus);
                objSelectedFocus.Bonded = true;
                if (!blnOldEquipped)
                {
                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objSelectedFocus, false);
                }
                CommonFunctions.PopulateFocusList(_objCharacter, treFoci);
            }
            else
            {
                // The Focus was not found in Gear, so this is a Stacked Focus.
                StackedFocus objStack = _objCharacter.StackedFoci.FirstOrDefault(x => x.InternalId == e.Node.Tag.ToString());
                if (objStack == null)
                {
                    e.Cancel = true;
                    return;
                }

                Gear objStackGear = CommonFunctions.DeepFindById(objStack.GearId, _objCharacter.Gear);
                if (objStackGear == null)
                {
                    e.Cancel = true;
                    return;
                }
                bool blnOldEquipped = objStackGear.Equipped;
                foreach (Gear objGear in objStack.Gear)
                {
                    if (objGear.Bonus != null || (objSelectedFocus.WirelessOn && objSelectedFocus.WirelessBonus != null))
                    {
                        if (!string.IsNullOrEmpty(objGear.Extra))
                            ImprovementManager.ForcedValue = objGear.Extra;
                        if (objGear.Bonus != null)
                        {
                            if (!ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.StackedFocus, objStack.InternalId, objGear.Bonus, false, objGear.Rating, objGear.DisplayNameShort))
                            {
                                // Clear created improvements
                                CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, false);
                                if (blnOldEquipped)
                                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, true);
                                e.Cancel = true;
                                return;
                            }
                            objGear.Extra = ImprovementManager.SelectedValue;
                        }
                        if (objSelectedFocus.WirelessOn && objSelectedFocus.WirelessBonus != null)
                        {
                            if (!ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.StackedFocus, objStack.InternalId, objGear.WirelessBonus, false, objGear.Rating, objGear.DisplayNameShort))
                            {
                                // Clear created improvements
                                CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, false);
                                if (blnOldEquipped)
                                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, true);
                                e.Cancel = true;
                                return;
                            }
                        }
                    }
                }

                int intKarmaExpense = objStack.BindingCost;
                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Clear created improvements
                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, false);
                    if (blnOldEquipped)
                        CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, true);
                    e.Cancel = true;
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseFocus").Replace("{0}", intKarmaExpense.ToString()).Replace("{1}", LanguageManager.GetString("String_StackedFocus") + " " + objStack.Name)))
                {
                    // Clear created improvements
                    CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, false);
                    if (blnOldEquipped)
                        CommonFunctions.ChangeGearEquippedStatus(_objCharacter, objStackGear, true);
                    e.Cancel = true;
                    return;
                }

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseBound") + " " + LanguageManager.GetString("String_StackedFocus") + " " + objStack.Name, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.BindFocus, objStack.InternalId);
                objExpense.Undo = objUndo;

                objStack.Bonded = true;
            }

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdImproveInitiation_Click(object sender, EventArgs e)
        {
            if (_objCharacter.MAGEnabled)
            {
                // Make sure that the Initiate Grade is not attempting to go above the character's MAG CharacterAttribute.
                if (_objCharacter.InitiateGrade + 1 > _objCharacter.MAG.TotalValue ||
                    (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept && _objCharacter.InitiateGrade + 1 > _objCharacter.MAGAdept.TotalValue))
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotIncreaseInitiateGrade"), LanguageManager.GetString("MessageTitle_CannotIncreaseInitiateGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // Make sure the character has enough Karma.
                decimal decMultiplier = 1.0m;

                int intKarmaExpense = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpense").Replace("{0}", LanguageManager.GetString("String_InitiateGrade")).Replace("{1}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{2}", intKarmaExpense.ToString())))
                    return;

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseInitiateGrade") + " " + _objCharacter.InitiateGrade.ToString() + " -> " + (_objCharacter.InitiateGrade + 1).ToString(), ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                // Create the Initiate Grade object.
                InitiationGrade objGrade = new InitiationGrade(_objCharacter);
                objGrade.Create(_objCharacter.InitiateGrade + 1, _objCharacter.RESEnabled, chkInitiationGroup.Checked, chkInitiationOrdeal.Checked, chkInitiationSchooling.Checked);
                _objCharacter.InitiationGrades.Add(objGrade);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ImproveInitiateGrade, objGrade.InternalId);
                objExpense.Undo = objUndo;

                // Set the character's Initiate Grade.
                _objCharacter.InitiateGrade += 1;

                // Remove any existing Initiation Improvements.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Initiation, "Initiation");

                // Create the replacement Improvement.
                ImprovementManager.CreateImprovement(_objCharacter, "MAG", Improvement.ImprovementSource.Initiation, "Initiation", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.InitiateGrade);
                ImprovementManager.CreateImprovement(_objCharacter, "MAGAdept", Improvement.ImprovementSource.Initiation, "Initiation", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.InitiateGrade);
                ImprovementManager.Commit(_objCharacter);

                // Update any Metamagic Improvements the character might have.
                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                {
                    if (objMetamagic.Bonus != null)
                    {
                        // If the Bonus contains "Rating", remove the existing Improvement and create new ones.
                        if (objMetamagic.Bonus.InnerXml.Contains("Rating"))
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId);
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Metamagic, objMetamagic.InternalId, objMetamagic.Bonus, false, _objCharacter.InitiateGrade, objMetamagic.DisplayNameShort);
                        }
                    }
                }

                int intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                string strInitTip = LanguageManager.GetString("Tip_ImproveInitiateGrade").Replace("{0}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
                tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
            }
            else if (_objCharacter.RESEnabled)
            {
                // Make sure that the Initiate Grade is not attempting to go above the character's RES CharacterAttribute.
                if (_objCharacter.SubmersionGrade + 1 > _objCharacter.RES.TotalValue)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotIncreaseSubmersionGrade"), LanguageManager.GetString("MessageTitle_CannotIncreaseSubmersionGrade"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // Make sure the character has enough Karma.
                decimal decMultiplier = 1.0m;

                int intKarmaExpense = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                if (intKarmaExpense > _objCharacter.Karma)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpense").Replace("{0}", LanguageManager.GetString("String_SubmersionGrade")).Replace("{1}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{2}", intKarmaExpense.ToString())))
                    return;

                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(intKarmaExpense * -1, LanguageManager.GetString("String_ExpenseSubmersionGrade") + " " + _objCharacter.SubmersionGrade.ToString() + " -> " + (_objCharacter.SubmersionGrade + 1).ToString(), ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Karma -= intKarmaExpense;

                // Create the Initiate Grade object.
                InitiationGrade objGrade = new InitiationGrade(_objCharacter);
                objGrade.Create(_objCharacter.SubmersionGrade + 1, _objCharacter.RESEnabled, chkInitiationGroup.Checked, chkInitiationOrdeal.Checked, chkInitiationSchooling.Checked);
                _objCharacter.InitiationGrades.Add(objGrade);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.ImproveInitiateGrade, objGrade.InternalId);
                objExpense.Undo = objUndo;

                // Set the character's Submersion Grade.
                _objCharacter.SubmersionGrade += 1;

                // Remove any existing Initiation Improvements.
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Submersion, "Submersion");

                // Create the replacement Improvement.
                ImprovementManager.CreateImprovement(_objCharacter, "RES", Improvement.ImprovementSource.Submersion, "Submersion", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, _objCharacter.SubmersionGrade);
                ImprovementManager.Commit(_objCharacter);

                // Update any Echo Improvements the character might have.
                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                {
                    if (objMetamagic.Bonus != null)
                    {
                        // If the Bonus contains "Rating", remove the existing Improvement and create new ones.
                        if (objMetamagic.Bonus.InnerXml.Contains("Rating"))
                        {
                            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Echo, objMetamagic.InternalId);
                            ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Echo, objMetamagic.InternalId, objMetamagic.Bonus, false, _objCharacter.SubmersionGrade, objMetamagic.DisplayNameShort);
                        }
                    }
                }

                int intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                string strInitTip = LanguageManager.GetString("Tip_ImproveSubmersionGrade").Replace("{0}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
                tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
            }

            UpdateInitiationGradeTree();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cboTradition_SelectedIndexChanged(object sender, EventArgs e)
        {
            //TODO: Why can't IsInitialised be used here? Throws an error when trying to use chummer.helpers.
            
            if (_blnLoading || string.IsNullOrEmpty(cboTradition.SelectedValue?.ToString()))
                return;

            XmlDocument objXmlDocument = XmlManager.Load("traditions.xml");
            XmlNode objXmlTradition = objXmlDocument.SelectSingleNode("/chummer/traditions/tradition[name = \"" + cboTradition.SelectedValue + "\"]");

            if (objXmlTradition == null)
            {
                _objCharacter.MagicTradition = cboTradition.SelectedValue.ToString();
                _objCharacter.TraditionDrain = string.Empty;
                cboDrain.Visible = false;
                lblTraditionName.Visible = false;
                txtTraditionName.Visible = false;
                lblSpiritCombat.Visible = false;
                lblSpiritDetection.Visible = false;
                lblSpiritHealth.Visible = false;
                lblSpiritIllusion.Visible = false;
                lblSpiritManipulation.Visible = false;
                lblTraditionSource.Visible = false;
                lblTraditionSourceLabel.Visible = false;
                cboSpiritCombat.Visible = false;
                cboSpiritDetection.Visible = false;
                cboSpiritHealth.Visible = false;
                cboSpiritIllusion.Visible = false;
                cboSpiritManipulation.Visible = false;
            }
            else if (objXmlTradition["name"].InnerText == "Custom")
            {
                cboDrain.Visible = true;
                lblTraditionName.Visible = true;
                txtTraditionName.Visible = true;
                lblSpiritCombat.Visible = true;
                lblSpiritDetection.Visible = true;
                lblSpiritHealth.Visible = true;
                lblSpiritIllusion.Visible = true;
                lblSpiritManipulation.Visible = true;
                lblTraditionSource.Visible = false;
                lblTraditionSourceLabel.Visible = false;
                cboSpiritCombat.Visible = true;
                cboSpiritDetection.Visible = true;
                cboSpiritHealth.Visible = true;
                cboSpiritIllusion.Visible = true;
                cboSpiritManipulation.Visible = true;

                if (string.IsNullOrEmpty(txtTraditionName.Text))
                    _objCharacter.MagicTradition = cboTradition.SelectedValue.ToString();
                else
                    _objCharacter.MagicTradition = txtTraditionName.Text;
            }
            else
            {
                cboDrain.Visible = false;
                lblTraditionName.Visible = false;
                txtTraditionName.Visible = false;
                lblSpiritCombat.Visible = false;
                lblSpiritDetection.Visible = false;
                lblSpiritHealth.Visible = false;
                lblSpiritIllusion.Visible = false;
                lblSpiritManipulation.Visible = false;
                lblTraditionSource.Visible = true;
                lblTraditionSourceLabel.Visible = true;
                cboSpiritCombat.Visible = false;
                cboSpiritDetection.Visible = false;
                cboSpiritHealth.Visible = false;
                cboSpiritIllusion.Visible = false;
                cboSpiritManipulation.Visible = false;

                lblTraditionSource.Text = objXmlTradition["source"].InnerText + " " + objXmlTradition["page"].InnerText;
                _objCharacter.MagicTradition = cboTradition.SelectedValue.ToString();
                _objCharacter.TraditionDrain = objXmlTradition["drain"].InnerText;
                foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                    objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());
            }

            CalculateTraditionDrain(_objCharacter.TraditionDrain, Improvement.ImprovementType.DrainResistance, lblDrainAttributes, lblDrainAttributesValue, tipTooltip);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Additional Sprites and Complex Forms Tab Control Events
        private void treComplexForms_AfterSelect(object sender, TreeViewEventArgs e)
        {
            RefreshSelectedComplexForm();
        }

        private void cboStream_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnLoading || string.IsNullOrEmpty(cboStream.SelectedValue.ToString()))
                return;

            XmlDocument objXmlDocument = XmlManager.Load("streams.xml");

            XmlNode objXmlTradition = objXmlDocument.SelectSingleNode("/chummer/traditions/tradition[name = \"" + cboStream.SelectedValue + "\"]");
            string strDrain = objXmlTradition["drain"].InnerText;
            foreach (string strAttribute in AttributeSection.AttributeStrings)
            {
                CharacterAttrib objAttrib = _objCharacter.GetAttribute(strAttribute);
                if (strDrain.Contains(objAttrib.DisplayAbbrev))
                    strDrain = strDrain.Replace(objAttrib.DisplayAbbrev, objAttrib.DisplayAbbrev + " (" + objAttrib.TotalValue.ToString() + ")");
            }
            lblFadingAttributes.Text = strDrain;
            _objCharacter.TechnomancerStream = cboStream.SelectedValue.ToString();

            foreach (SpiritControl objSpriteControl in panSprites.Controls)
                objSpriteControl.RebuildSpiritList(cboStream.SelectedValue.ToString());

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treComplexForms_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteComplexForm_Click(sender, e);
            }
        }
#endregion

#region Additional Initiation Tab Control Events
        private void chkInitiationGroup_CheckedChanged(object sender, EventArgs e)
        {
            UpdateInitiationCost();
        }

        private void chkInitiationOrdeal_CheckedChanged(object sender, EventArgs e)
        {
            UpdateInitiationCost();
        }

        private void chkInitiationSchooling_CheckedChanged(object sender, EventArgs e)
        {
            UpdateInitiationCost();
        }

        private void treMetamagic_AfterSelect(object sender, TreeViewEventArgs e)
        {
            // Locate the selected Metamagic.
            Metamagic objMetamagic = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Metamagics);

            if (objMetamagic != null)
            {
                string strBook = _objOptions.LanguageBookShort(objMetamagic.Source);
                string strPage = objMetamagic.Page;
                lblMetamagicSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblMetamagicSource, _objOptions.BookFromCode(objMetamagic.Source) + " " + LanguageManager.GetString("String_Page") + " " + objMetamagic.Page);
                return;
            }

            // Locate the selected Art.
            Art objArt = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Arts);

            if (objArt != null)
            {
                string strBook = _objOptions.LanguageBookShort(objArt.Source);
                string strPage = objArt.Page;
                lblMetamagicSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblMetamagicSource, _objOptions.BookFromCode(objArt.Source) + " " + LanguageManager.GetString("String_Page") + " " + objArt.Page);
                return;
            }

            // Locate the selected Spell.
            Spell objSpell = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Spells);

            if (objSpell != null)
            {
                string strBook = _objOptions.LanguageBookShort(objSpell.Source);
                string strPage = objSpell.Page;
                lblMetamagicSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblMetamagicSource, _objOptions.BookFromCode(objSpell.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSpell.Page);
                return;
            }

            // Locate the selected Enhancement.
            Enhancement objEnhancement = CommonFunctions.FindEnhancement(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter);

            if (objEnhancement != null)
            {
                string strBook = _objOptions.LanguageBookShort(objEnhancement.Source);
                string strPage = objEnhancement.Page;
                lblMetamagicSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblMetamagicSource, _objOptions.BookFromCode(objEnhancement.Source) + " " + LanguageManager.GetString("String_Page") + " " + objEnhancement.Page);
                return;
            }

            lblMetamagicSource.Text = string.Empty;
            tipTooltip.SetToolTip(lblMetamagicSource, string.Empty);
        }

        private void chkJoinGroup_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || _blnLoading)
                return;

            // Joining a Network does not cost Karma for Technomancers, so this only applies to Magicians/Adepts.
            if (_objCharacter.MAGEnabled)
            {
                if (chkJoinGroup.Checked)
                {
                    int intKarmaExpense = _objOptions.KarmaJoinGroup;

                    if (intKarmaExpense > _objCharacter.Karma)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        _blnSkipRefresh = true;
                        chkJoinGroup.Checked = false;
                        _blnSkipRefresh = false;
                        return;
                    }

                    string strMessage = string.Empty;
                    string strExpense = string.Empty;
                    if (_objCharacter.MAGEnabled)
                    {
                        strMessage = LanguageManager.GetString("Message_ConfirmKarmaExpenseJoinGroup");
                        strExpense = LanguageManager.GetString("String_ExpenseJoinGroup");
                    }
                    else
                    {
                        strMessage = LanguageManager.GetString("Message_ConfirmKarmaExpenseJoinNetwork");
                        strExpense = LanguageManager.GetString("String_ExpenseJoinNetwork");
                    }

                    if (!ConfirmKarmaExpense(strMessage.Replace("{0}", intKarmaExpense.ToString())))
                    {
                        _blnSkipRefresh = true;
                        chkJoinGroup.Checked = false;
                        _blnSkipRefresh = false;
                        return;
                    }

                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(intKarmaExpense * -1, strExpense, ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Karma -= intKarmaExpense;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.JoinGroup, string.Empty);
                    objExpense.Undo = objUndo;
                }
                else
                {
                    int intKarmaExpense = _objOptions.KarmaLeaveGroup;

                    if (intKarmaExpense > _objCharacter.Karma)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        _blnSkipRefresh = true;
                        chkJoinGroup.Checked = true;
                        _blnSkipRefresh = false;
                        return;
                    }

                    string strMessage = string.Empty;
                    string strExpense = string.Empty;
                    if (_objCharacter.MAGEnabled)
                    {
                        strMessage = LanguageManager.GetString("Message_ConfirmKarmaExpenseLeaveGroup");
                        strExpense = LanguageManager.GetString("String_ExpenseLeaveGroup");
                    }
                    else
                    {
                        strMessage = LanguageManager.GetString("Message_ConfirmKarmaExpenseLeaveNetwork");
                        strExpense = LanguageManager.GetString("String_ExpenseLeaveNetwork");
                    }

                    if (!ConfirmKarmaExpense(strMessage.Replace("{0}", intKarmaExpense.ToString())))
                    {
                        _blnSkipRefresh = true;
                        chkJoinGroup.Checked = true;
                        _blnSkipRefresh = false;
                        return;
                    }

                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(intKarmaExpense * -1, strExpense, ExpenseType.Karma, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Karma -= intKarmaExpense;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateKarma(KarmaExpenseType.LeaveGroup, string.Empty);
                    objExpense.Undo = objUndo;
                }
            }
            _objCharacter.GroupMember = chkJoinGroup.Checked;
            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtGroupName_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.GroupName = txtGroupName.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtNotes_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.A)
            {
                e.SuppressKeyPress = true;
                if (sender != null)
                    ((TextBox)sender).SelectAll();
            }
        }

        private void txtGroupNotes_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.GroupNotes = txtGroupNotes.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Additional Critter Powers Tab Control Events
        private void treCritterPowers_AfterSelect(object sender, TreeViewEventArgs e)
        {
            // Look for the selected Critter Power.
            lblCritterPowerName.Text = string.Empty;
            lblCritterPowerCategory.Text = string.Empty;
            lblCritterPowerType.Text = string.Empty;
            lblCritterPowerAction.Text = string.Empty;
            lblCritterPowerRange.Text = string.Empty;
            lblCritterPowerDuration.Text = string.Empty;
            lblCritterPowerSource.Text = string.Empty;
            tipTooltip.SetToolTip(lblCritterPowerSource, null);
            lblCritterPowerPointCost.Visible = false;
            lblCritterPowerPointCostLabel.Visible = false;
            if (treCritterPowers.SelectedNode != null)
            {
                if (treCritterPowers.SelectedNode.Level > 0)
                {
                    CritterPower objPower = CommonFunctions.FindByIdWithNameCheck(treCritterPowers.SelectedNode.Tag.ToString(), _objCharacter.CritterPowers);

                    if (objPower != null)
                    {
                    lblCritterPowerName.Text = objPower.DisplayName;
                    lblCritterPowerCategory.Text = objPower.DisplayCategory;
                    lblCritterPowerType.Text = objPower.DisplayType;
                    lblCritterPowerAction.Text = objPower.DisplayAction;
                    lblCritterPowerRange.Text = objPower.DisplayRange;
                    lblCritterPowerDuration.Text = objPower.DisplayDuration;
                    chkCritterPowerCount.Checked = objPower.CountTowardsLimit;
                    string strBook = _objOptions.LanguageBookShort(objPower.Source);
                    string strPage = objPower.Page;
                    lblCritterPowerSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblCritterPowerSource, _objOptions.LanguageBookLong(objPower.Source) + " " + LanguageManager.GetString("String_Page") + " " + objPower.Page);
                    if (objPower.PowerPoints > 0)
                    {
                            lblCritterPowerPointCost.Text = objPower.PowerPoints.ToString(GlobalOptions.CultureInfo);
                        lblCritterPowerPointCost.Visible = true;
                        lblCritterPowerPointCostLabel.Visible = true;
                    }
                }
            }
            }
        }

        private void chkCritterPowerCount_CheckedChanged(object sender, EventArgs e)
        {
            if (treCritterPowers.SelectedNode == null || treCritterPowers.SelectedNode.Level == 0)
            {
                return;
            }

            // Locate the selected Critter Power.
            CritterPower objPower = CommonFunctions.FindByIdWithNameCheck(treCritterPowers.SelectedNode.Tag.ToString(), _objCharacter.CritterPowers);

            objPower.CountTowardsLimit = chkCritterPowerCount.Checked;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Additional Karma and Nuyen Tab Control Events
        private void lstKarma_DoubleClick(object sender, EventArgs e)
        {
            ListViewItem objItem;
            if (lstKarma.SelectedItems != null && lstKarma.SelectedItems.Count > 0)
            {
                objItem = lstKarma.SelectedItems[0];
            }
            else
            {
                return;
            }

            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);

            // Find the selected Karma Expense.
            foreach (ExpenseLogEntry objCharacterEntry in _objCharacter.ExpenseEntries)
            {
                if (objCharacterEntry.InternalId == objItem.SubItems[3].Text)
                {
                    objEntry = objCharacterEntry;
                    break;
                }
            }

            // If this is a manual entry, let the player modify the amount.
            int intOldAmount = decimal.ToInt32(objEntry.Amount);
            bool blnAllowEdit = false;
            if (objEntry.Undo != null)
            {
                if (objEntry.Undo.KarmaType == KarmaExpenseType.ManualAdd || objEntry.Undo.KarmaType == KarmaExpenseType.ManualSubtract)
                    blnAllowEdit = true;
            }

            frmExpense frmEditExpense = new frmExpense();
            frmEditExpense.Reason = objEntry.Reason;
            frmEditExpense.Amount = objEntry.Amount;
            frmEditExpense.Refund = objEntry.Refund;
            frmEditExpense.SelectedDate = objEntry.Date;
            frmEditExpense.LockFields(blnAllowEdit);

            frmEditExpense.ShowDialog(this);

            if (frmEditExpense.DialogResult == DialogResult.Cancel)
                return;

            // If this is a manual entry, update the character's Karma total.
            int intNewAmount = decimal.ToInt32(frmEditExpense.Amount);
            if (blnAllowEdit && intOldAmount != intNewAmount)
            {
                objEntry.Amount = intNewAmount;
                _objCharacter.Karma += (intNewAmount - intOldAmount);
            }

            // Rename the Expense.
            objEntry.Reason = frmEditExpense.Reason;
            objEntry.Date = frmEditExpense.SelectedDate;

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void lstNuyen_DoubleClick(object sender, EventArgs e)
        {
            ListViewItem objItem;
            if (lstNuyen.SelectedItems != null && lstNuyen.SelectedItems.Count > 0)
            {
                objItem = lstNuyen.SelectedItems[0];
            }
            else
            {
                return;
            }

            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);

            // Find the selected Nuyen Expense.
            foreach (ExpenseLogEntry objCharacterEntry in _objCharacter.ExpenseEntries)
            {
                if (objCharacterEntry.InternalId == objItem.SubItems[3].Text)
                {
                    objEntry = objCharacterEntry;
                    break;
                }
            }

            // If this is a manual entry, let the player modify the amount.
            decimal decOldAmount = objEntry.Amount;
            bool blnAllowEdit = false;
            if (objEntry.Undo != null)
            {
                if (objEntry.Undo.NuyenType == NuyenExpenseType.ManualAdd || objEntry.Undo.NuyenType == NuyenExpenseType.ManualSubtract)
                    blnAllowEdit = true;
            }

            frmExpense frmEditExpense = new frmExpense();
            frmEditExpense.Mode = ExpenseType.Nuyen;
            frmEditExpense.Reason = objEntry.Reason;
            frmEditExpense.Amount = objEntry.Amount;
            frmEditExpense.Refund = objEntry.Refund;
            frmEditExpense.SelectedDate = objEntry.Date;
            frmEditExpense.LockFields(blnAllowEdit);

            frmEditExpense.ShowDialog(this);

            if (frmEditExpense.DialogResult == DialogResult.Cancel)
                return;

            // If this is a manual entry, update the character's Karma total.
            decimal decNewAmount = frmEditExpense.Amount;
            if (blnAllowEdit && decOldAmount != decNewAmount)
            {
                objEntry.Amount = decNewAmount;
                _objCharacter.Nuyen += (decNewAmount - decOldAmount);
            }

            // Rename the Expense.
            objEntry.Reason = frmEditExpense.Reason;
            objEntry.Date = frmEditExpense.SelectedDate;

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void lstKarma_ColumnClick(object sender, ColumnClickEventArgs e)
        {
            if (e.Column == _lvwKarmaColumnSorter.SortColumn)
            {
                if (_lvwKarmaColumnSorter.Order == SortOrder.Ascending)
                    _lvwKarmaColumnSorter.Order = SortOrder.Descending;
                else
                    _lvwKarmaColumnSorter.Order = SortOrder.Ascending;
            }
            else
            {
                _lvwKarmaColumnSorter.SortColumn = e.Column;
                _lvwKarmaColumnSorter.Order = SortOrder.Ascending;
            }
            lstKarma.Sort();
        }

        private void lstNuyen_ColumnClick(object sender, ColumnClickEventArgs e)
        {
            if (e.Column == _lvwNuyenColumnSorter.SortColumn)
            {
                if (_lvwNuyenColumnSorter.Order == SortOrder.Ascending)
                    _lvwNuyenColumnSorter.Order = SortOrder.Descending;
                else
                    _lvwNuyenColumnSorter.Order = SortOrder.Ascending;
            }
            else
            {
                _lvwNuyenColumnSorter.SortColumn = e.Column;
                _lvwNuyenColumnSorter.Order = SortOrder.Ascending;
            }
            lstNuyen.Sort();
        }
#endregion

#region Additional Calendar Tab Control Events
        private void lstCalendar_DoubleClick(object sender, EventArgs e)
        {
            cmdEditWeek_Click(sender, e);
        }
#endregion

#region Additional Improvements Tab Control Events
        private void treImprovements_AfterSelect(object sender, TreeViewEventArgs e)
        {
            lblImprovementType.Text = string.Empty;
            lblImprovementValue.Text = string.Empty;

            if (treImprovements.SelectedNode.Level == 0)
            {
                cmdImprovementsEnableAll.Visible = true;
                cmdImprovementsDisableAll.Visible = true;
            }
            else
            {
                cmdImprovementsEnableAll.Visible = false;
                cmdImprovementsDisableAll.Visible = false;
            }

            _blnSkipRefresh = true;
            if (treImprovements.SelectedNode != null)
            {
                if (treImprovements.SelectedNode.Level == 0)
                {
                    lblImprovementType.Text = string.Empty;
                    lblImprovementValue.Text = string.Empty;
                    chkImprovementActive.Checked = false;
                }
                else
                {
                    Improvement objImprovement = null;
                    foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                    {
                        if (objCharacterImprovement.SourceName == treImprovements.SelectedNode.Tag.ToString())
                        {
                            objImprovement = objCharacterImprovement;
                            break;
                        }
                    }

                    // Get the human-readable name of the Improvement from the Improvements file.
                    XmlDocument objXmlDocument = XmlManager.Load("improvements.xml");

                    XmlNode objNode = objXmlDocument.SelectSingleNode("/chummer/improvements/improvement[id = \"" + objImprovement.CustomId + "\"]");
                    if (objNode != null && objNode["name"] != null)
                    {
                        lblImprovementType.Text = objNode["translate"]?.InnerText ?? objNode["name"]?.InnerText;
                    }
                    

                    // Build a string that contains the value(s) of the Improvement.
                    string strValue = string.Empty;
                    if (objImprovement.Value != 0)
                        strValue += LanguageManager.GetString("Label_CreateImprovementValue") + " " + objImprovement.Value.ToString() + ", ";
                    if (objImprovement.Minimum != 0)
                        strValue += LanguageManager.GetString("Label_CreateImprovementMinimum") + " " + objImprovement.Minimum.ToString() + ", ";
                    if (objImprovement.Maximum != 0)
                        strValue += LanguageManager.GetString("Label_CreateImprovementMaximum") + " " + objImprovement.Maximum.ToString() + ", ";
                    if (objImprovement.Augmented != 0)
                        strValue += LanguageManager.GetString("Label_CreateImprovementAugmented") + " " + objImprovement.Augmented.ToString() + ", ";

                    // Remove the trailing comma.
                    if (!string.IsNullOrEmpty(strValue))
                        strValue = strValue.Substring(0, strValue.Length - 2);

                    lblImprovementValue.Text = strValue;
                    chkImprovementActive.Checked = objImprovement.Enabled;
                }
            }
            _blnSkipRefresh = false;
        }

        private void treImprovements_DoubleClick(object sender, EventArgs e)
        {
            if (treImprovements.SelectedNode != null)
            {
                if (treImprovements.SelectedNode.Level > 0)
                {
                    Improvement objImprovement = null;
                    foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                    {
                        if (objCharacterImprovement.SourceName == treImprovements.SelectedNode.Tag.ToString())
                        {
                            objImprovement = objCharacterImprovement;
                            break;
                        }
                    }

                    // Edit the selected Improvement.
                    frmCreateImprovement frmPickImprovement = new frmCreateImprovement(_objCharacter);
                    frmPickImprovement.EditImprovementObject = objImprovement;
                    frmPickImprovement.ShowDialog(this);

                    if (frmPickImprovement.DialogResult != DialogResult.Cancel)
                    {
                        ScheduleCharacterUpdate();

                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }
            }
        }

        private void chkImprovementActive_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            if (treImprovements.SelectedNode != null)
            {
                if (treImprovements.SelectedNode.Level > 0)
                {
                    Improvement objImprovement = null;
                    foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                    {
                        if (objCharacterImprovement.SourceName == treImprovements.SelectedNode.Tag.ToString())
                        {
                            objImprovement = objCharacterImprovement;
                            break;
                        }
                    }

                    if (objImprovement != null)
                    {
                        objImprovement.Enabled = chkImprovementActive.Checked;
                        _objCharacter.ImprovementHook(new List<Improvement>() { objImprovement });

                        _blnIsDirty = true;
                        ScheduleCharacterUpdate();
                        UpdateWindowTitle();
                    }
                }
            }
        }

        private void treImprovements_ItemDrag(object sender, ItemDragEventArgs e)
        {
                // Do not allow the root element to be moved.
            if (treImprovements.SelectedNode == null || treImprovements.SelectedNode.Tag.ToString() == "Node_SelectedImprovements")
                    return;
            _intDragLevel = treImprovements.SelectedNode.Level;
            DoDragDrop(e.Item, DragDropEffects.Move);
        }

        private void treImprovements_DragEnter(object sender, DragEventArgs e)
        {
            e.Effect = DragDropEffects.Move;
        }

        private void treImprovements_DragDrop(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode nodDestination = ((TreeView)sender).GetNodeAt(pt);

            int intNewIndex = 0;
            if (nodDestination != null)
            {
                intNewIndex = nodDestination.Index;
            }
            else if (treImprovements.Nodes.Count > 0)
            {
                intNewIndex = treImprovements.Nodes[treImprovements.Nodes.Count - 1].Nodes.Count;
                nodDestination = treImprovements.Nodes[treImprovements.Nodes.Count - 1];
            }

            if (treImprovements.SelectedNode.Level == 1)
                CommonFunctions.MoveImprovementNode(_objCharacter, intNewIndex, nodDestination, treImprovements);
            else
                CommonFunctions.MoveImprovementRoot(_objCharacter, intNewIndex, nodDestination, treImprovements);

            // Clear the background color for all Nodes.
            treImprovements.ClearNodeBackground(null);

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void treImprovements_DragOver(object sender, DragEventArgs e)
        {
            Point pt = ((TreeView)sender).PointToClient(new Point(e.X, e.Y));
            TreeNode objNode = ((TreeView)sender).GetNodeAt(pt);

            if (objNode == null)
                return;

            // Highlight the Node that we're currently dragging over, provided it is of the same level or higher.
            if (objNode.Level <= _intDragLevel)
                objNode.BackColor = SystemColors.ControlDark;

            // Clear the background colour for all other Nodes.
            treImprovements.ClearNodeBackground(objNode);
        }

        private void cmdAddImprovementGroup_Click(object sender, EventArgs e)
        {
            // Add a new location to the Improvements Tree.
            frmSelectText frmPickText = new frmSelectText();
            frmPickText.Description = LanguageManager.GetString("String_AddLocation");
            frmPickText.ShowDialog(this);

            if (frmPickText.DialogResult == DialogResult.Cancel || string.IsNullOrEmpty(frmPickText.SelectedValue))
                return;

            string strLocation = frmPickText.SelectedValue;
            _objCharacter.ImprovementGroups.Add(strLocation);

            TreeNode objLocation = new TreeNode();
            objLocation.Tag = strLocation;
            objLocation.Text = strLocation;
            objLocation.ContextMenuStrip = cmsImprovementLocation;
            treImprovements.Nodes.Add(objLocation);
            UpdateWindowTitle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Character Info Tab Event
        private void txtSex_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Sex = txtSex.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtAge_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Age = txtAge.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtEyes_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Eyes = txtEyes.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtHair_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Hair = txtHair.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtHeight_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Height = txtHeight.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtWeight_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Weight = txtWeight.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtSkin_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Skin = txtSkin.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtDescription_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Description = txtDescription.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtBackground_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Background = txtBackground.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtConcept_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Concept = txtConcept.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtNotes_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Notes = txtNotes.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtPlayerName_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.PlayerName = txtPlayerName.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtAlias_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Alias = txtAlias.Text;
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void nudStreetCred_ValueChanged(object sender, EventArgs e)
        {
            _objCharacter.StreetCred = decimal.ToInt32(nudStreetCred.Value);
            _blnIsDirty = true;
            UpdateReputation();
            UpdateWindowTitle();
        }

        private void nudNotoriety_ValueChanged(object sender, EventArgs e)
        {
            _objCharacter.Notoriety = decimal.ToInt32(nudNotoriety.Value);
            _blnIsDirty = true;
            UpdateReputation();
            UpdateWindowTitle();
        }

        private void nudPublicAware_ValueChanged(object sender, EventArgs e)
        {
            _objCharacter.PublicAwareness = decimal.ToInt32(nudPublicAware.Value);
            _blnIsDirty = true;
            UpdateReputation();
            UpdateWindowTitle();
        }
#endregion

#region Notes Tab Events
        private void txtGameNotes_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.GameNotes = txtGameNotes.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Tree KeyDown Events
        private void treQualities_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteQuality_Click(sender, e);
            }
        }

        private void treSpells_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteSpell_Click(sender, e);
            }
        }

        private void treCyberware_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteCyberware_Click(sender, e);
            }
        }

        private void treLifestyles_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteLifestyle_Click(sender, e);
            }
        }

        private void treArmor_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteArmor_Click(sender, e);
            }
        }

        private void treWeapons_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteWeapon_Click(sender, e);
            }
        }

        private void treGear_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteGear_Click(sender, e);
            }
        }

        private void treVehicles_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteVehicle_Click(sender, e);
            }
        }

        private void treMartialArts_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteMartialArt_Click(sender, e);
            }
        }

        private void treCritterPowers_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteCritterPower_Click(sender, e);
            }
        }

        private void treMetamagic_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteMetamagic_Click(sender, e);
            }
        }

        private void treImprovements_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteImprovement_Click(sender, e);
            }
        }
#endregion

#region Splitter Resize Events
        

        private void splitKarmaNuyen_Panel1_Resize(object sender, EventArgs e)
        {
            lstKarma.Width = splitKarmaNuyen.Panel1.Width;
            chtKarma.Width = splitKarmaNuyen.Panel1.Width;
            chtKarma.Height = 210;
            chtKarma.Top = splitKarmaNuyen.Panel1.Height - 6 - chtKarma.Height;
            lstKarma.Height = chtKarma.Top - 6 - lstKarma.Top;
            if (lstKarma.Columns.Count > 2)
            {
                if (lstKarma.Width > 409)
                {
                    lstKarma.Columns[2].Width = lstKarma.Width - 220;
                }
            }
            }

        private void splitKarmaNuyen_Panel2_Resize(object sender, EventArgs e)
        {
            lstNuyen.Width = splitKarmaNuyen.Panel2.Width;
            chtNuyen.Width = splitKarmaNuyen.Panel2.Width;
            chtNuyen.Height = 210;
            chtNuyen.Top = splitKarmaNuyen.Panel2.Height - 6 - chtNuyen.Height;
            lstNuyen.Height = chtNuyen.Top - 6 - lstNuyen.Top;
            if (lstNuyen.Columns.Count > 2)
            {
                if (lstNuyen.Width > 409)
                {
                    lstNuyen.Columns[2].Width = lstNuyen.Width - 220;
                }
            }
            }
#endregion

#region Other Control Events
        private void txtCharacterName_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.Name = txtCharacterName.Text;
            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdEdgeSpent_Click(object sender, EventArgs e)
        {
            int intEdgeUsed = 0;
            foreach (Improvement objImprovement in _objCharacter.Improvements)
            {
                if (objImprovement.ImproveType == Improvement.ImprovementType.Attribute && objImprovement.ImprovedName == "EDG" && objImprovement.ImproveSource == Improvement.ImprovementSource.EdgeUse && objImprovement.Enabled)
                    intEdgeUsed += objImprovement.Augmented * objImprovement.Rating;
            }

            if (intEdgeUsed - 1 < _objCharacter.EDG.Value * -1)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotSpendEdge"), LanguageManager.GetString("MessageTitle_CannotSpendEdge"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.EdgeUse, "edgeuse");
            intEdgeUsed -= 1;

            ImprovementManager.CreateImprovement(_objCharacter, "EDG", Improvement.ImprovementSource.EdgeUse, "edgeuse", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intEdgeUsed);
            ImprovementManager.Commit(_objCharacter);
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdEdgeGained_Click(object sender, EventArgs e)
        {
            int intEdgeUsed = 0;
            foreach (Improvement objImprovement in _objCharacter.Improvements)
            {
                if (objImprovement.ImproveType == Improvement.ImprovementType.Attribute && objImprovement.ImprovedName == "EDG" && objImprovement.ImproveSource == Improvement.ImprovementSource.EdgeUse && objImprovement.Enabled)
                    intEdgeUsed += objImprovement.Augmented * objImprovement.Rating;
            }

            if (intEdgeUsed + 1 > 0)
            {
                MessageBox.Show(LanguageManager.GetString("Message_CannotRegainEdge"), LanguageManager.GetString("MessageTitle_CannotRegainEdge"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.EdgeUse, "edgeuse");
            intEdgeUsed += 1;

            if (intEdgeUsed < 0)
            {
                ImprovementManager.CreateImprovement(_objCharacter, "EDG", Improvement.ImprovementSource.EdgeUse, "edgeuse", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intEdgeUsed);
                ImprovementManager.Commit(_objCharacter);
            }
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tabCharacterTabs_SelectedIndexChanged(object sender, EventArgs e)
        {
            RefreshPasteStatus();
        }

        private void tabStreetGearTabs_SelectedIndexChanged(object sender, EventArgs e)
        {
            RefreshPasteStatus();
        }
#endregion

#region Clear Tab Contents
        /// <summary>
        /// Clear the contents of the Spells and Spirits Tab.
        /// </summary>
        private void ClearSpellTab()
        {
            CommonFunctions.ClearSpellTab(_objCharacter, treSpells);

            // Remove the Spirits.
            panSpirits.Controls.Clear();

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        /// <summary>
        /// Clear the contents of the Sprites and Complex Forms Tab.
        /// </summary>
        private void ClearTechnomancerTab()
        {
            CommonFunctions.ClearTechnomancerTab(_objCharacter, treComplexForms);

            // Remove the Sprites.
            panSprites.Controls.Clear();

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        /// <summary>
        /// Clear the contents of the Advanced Programs Tab.
        /// </summary>
        private void ClearAdvancedProgramsTab()
        {
            CommonFunctions.ClearAdvancedProgramsTab(_objCharacter, treAIPrograms);

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        /// <summary>
        /// Clear the contents of the Cyberware Tab.
        /// </summary>
        private void ClearCyberwareTab()
        {
            CommonFunctions.ClearCyberwareTab(_objCharacter, treCyberware, treWeapons, treVehicles);

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        /// <summary>
        /// Clear the conents of the Critter Powers Tab.
        /// </summary>
        private void ClearCritterTab()
        {
            CommonFunctions.ClearCritterTab(_objCharacter, treCritterPowers);

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }

        /// <summary>
        /// Clear the content of the Initiation Tab.
        /// </summary>
        private void ClearInitiationTab()
        {
            CommonFunctions.ClearInitiations(_objCharacter);
            UpdateInitiationGradeTree();

            _blnIsDirty = true;
            ScheduleCharacterUpdate();
            UpdateWindowTitle();
        }
#endregion

#region Condition Monitors
        private void chkPhysicalCM_CheckedChanged(object sender, EventArgs e)
        {
            CheckBox box = (CheckBox)sender;
            bool stun = false;
            ProcessConditionMonitor(Convert.ToInt32(box.Tag), panPhysicalCM, _objCharacter.PhysicalCM, _objCharacter.PhysicalCMFilled, stun, out int penalty);
        }

        private void chkStunCM_CheckedChanged(object sender, EventArgs e)
        {
            CheckBox box = (CheckBox) sender;
            bool stun = true;
            ProcessConditionMonitor(Convert.ToInt32(box.Tag),panStunCM,_objCharacter.StunCM,_objCharacter.StunCMFilled, stun, out int penalty);
        }

        /// <summary>
        /// Manages the rendering of condition monitor checkboxes and associated improvements. 
        /// TODO: This method is disgusting and I hate it. Refactor into something better when we move to WPF.
        /// </summary>
        /// <param name="boxTag">Value of the largest entry that we're activating.</param>
        /// <param name="panel">Container panel for the condition monitor checkboxes.</param>
        /// <param name="conditionMax">Highest value of the condition monitor type.</param>
        /// <param name="conditionValueIn">Current value of the condition monitor type.</param>
        /// <param name="stun">Whether or not we're working on the Stun or Physical track. Stun track == true</param>
        /// <param name="penalty">Returns the total penalty for the condition monitor type. Expected values are 0 or a negative number.</param>
        private void ProcessConditionMonitor(int boxTag, Panel panel, int conditionMax, int conditionValueIn, bool stun, out int penalty, bool current = false)
        {
            penalty = 0;
            if (_blnSkipRefresh)
                return;

            int intCMOverflow = _objCharacter.CMOverflow;
            int intCMThreshold = _objCharacter.CMThreshold;
            int intFillCount = 0;

            // If this is being checked, make sure everything before it is checked off.
            _blnSkipRefresh = true;

            int intCurrentBoxTag = 0;
            foreach (CheckBox cmBox in panel.Controls.OfType<CheckBox>())
            {
                intCurrentBoxTag = Convert.ToInt32(cmBox.Tag.ToString());
                if (intCurrentBoxTag < boxTag)
                {
                    cmBox.Checked = true;
                }
                else if (intCurrentBoxTag > boxTag)
                {
                    cmBox.Checked = false;
                }
                else if (current && intCurrentBoxTag == boxTag)
                {
                    cmBox.Checked = true;
                }
                if (intCurrentBoxTag <= conditionMax)
                {
                    cmBox.Visible = true;
                    int intCMThresholdOffset = ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset);
                    if (intCurrentBoxTag > intCMThresholdOffset && (intCurrentBoxTag - intCMThresholdOffset) % intCMThreshold == 0)
                    {
                        int intModifiers = (intCurrentBoxTag - intCMThresholdOffset) / -intCMThreshold;
                        cmBox.Text = intModifiers.ToString();
                        if (intCurrentBoxTag == boxTag)
                        {
                            penalty = intModifiers;
                        }
                    }
                    else
                        cmBox.Text = string.Empty;
                }
                else if (!stun && intCurrentBoxTag <= conditionMax + intCMOverflow)
                {
                    cmBox.Visible = true;
                    cmBox.BackColor = SystemColors.ControlDark;
                    if (intCurrentBoxTag == conditionMax + intCMOverflow)
                        cmBox.Text = "D";
                    else
                        cmBox.Text = string.Empty;
                }
                else
                {
                    cmBox.Visible = false;
                    cmBox.Text = string.Empty;
                }
                if (cmBox.Checked)
                    intFillCount += 1;
            }
            if (stun)
            {
                _objCharacter.StunCMFilled = intFillCount;
            }
            else
            {
                _objCharacter.PhysicalCMFilled = intFillCount;
            }
            _blnSkipRefresh = false;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void chkCyberwareCM_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh || treCyberware.SelectedNode == null)
                return;

            // Locate the selected Cyberware.
            TreeNode objCyberwareNode = new TreeNode();
            objCyberwareNode = treCyberware.SelectedNode;
            if (treCyberware.SelectedNode.Level > 1)
            {
                while (objCyberwareNode.Level > 1)
                    objCyberwareNode = objCyberwareNode.Parent;
            }

            Cyberware objCyberware = CommonFunctions.DeepFindById(objCyberwareNode.Tag.ToString(), _objCharacter.Cyberware);

            int intFillCount = 0;
            CheckBox objCheck = (CheckBox)sender;
            {
                _blnSkipRefresh = true;
                bool blnChecked = objCheck.Checked;
                int intBoxCheckTag = Convert.ToInt32(objCheck.Tag.ToString());
                foreach (CheckBox objCyberwareCM in tabCyberwareMatrixCM.Controls.OfType<CheckBox>())
                {
                    int intLoopTag = Convert.ToInt32(objCyberwareCM.Tag.ToString());
                    // If this is being checked, make sure everything before it is checked off, and if unchecked, everything after it is checked off.
                    if ((intLoopTag < intBoxCheckTag) == blnChecked && intLoopTag != intBoxCheckTag)
                        objCyberwareCM.Checked = blnChecked;

                    if (objCyberwareCM.Checked)
                        intFillCount += 1;
                }
                _blnSkipRefresh = false;

                objCyberware.MatrixCMFilled = intFillCount;

                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void chkGearCM_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // Locate the selected Gear.
            TreeNode objGearNode = new TreeNode();
            objGearNode = treGear.SelectedNode;
            if (treGear.SelectedNode.Level > 1)
            {
                while (objGearNode.Level > 1)
                    objGearNode = objGearNode.Parent;
            }

            Gear objGear = null;
            foreach (Gear objCharacterGear in _objCharacter.Gear)
            {
                if (objCharacterGear.InternalId == objGearNode.Tag.ToString())
                {
                    objGear = objCharacterGear;
                    break;
                }
            }

            int intFillCount = 0;
            CheckBox objCheck = (CheckBox)sender;
            {
                _blnSkipRefresh = true;
                bool blnChecked = objCheck.Checked;
                int intBoxCheckTag = Convert.ToInt32(objCheck.Tag.ToString());
                foreach (CheckBox objGearCM in tabMatrixCM.Controls.OfType<CheckBox>())
                {
                    int intLoopTag = Convert.ToInt32(objGearCM.Tag.ToString());
                    // If this is being checked, make sure everything before it is checked off, and if unchecked, everything after it is checked off.
                    if ((intLoopTag < intBoxCheckTag) == blnChecked && intLoopTag != intBoxCheckTag)
                        objGearCM.Checked = blnChecked;

                    if (objGearCM.Checked)
                        intFillCount += 1;
                }
                _blnSkipRefresh = false;
                if (objGear.GetType() == typeof(Commlink))
                {
                    Commlink objCommlink = (Commlink)objGear;
                    objCommlink.MatrixCMFilled = intFillCount;
                }
                else
                {
                    objGear.MatrixCMFilled = intFillCount;
                }

                ScheduleCharacterUpdate();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void chkVehicleCM_CheckedChanged(object sender, EventArgs e)
        {
            if (_blnSkipRefresh)
                return;

            // Locate the selected Vehicle.
            TreeNode objVehicleNode = new TreeNode();
            objVehicleNode = treVehicles.SelectedNode;
            if (treVehicles.SelectedNode.Level > 1)
            {
                while (objVehicleNode.Level > 1)
                    objVehicleNode = objVehicleNode.Parent;
            }

            Vehicle objVehicle = null;
            foreach (Vehicle objCharacterVehicle in _objCharacter.Vehicles)
            {
                if (objCharacterVehicle.InternalId == objVehicleNode.Tag.ToString())
                {
                    objVehicle = objCharacterVehicle;
                    break;
                }
            }

            int intFillCount = 0;
            CheckBox objCheck = (CheckBox)sender;
            bool blnChecked = objCheck.Checked;
            int intBoxCheckTag = Convert.ToInt32(objCheck.Tag.ToString());
            if (panVehicleCM.SelectedIndex == 0)
            {
                _blnSkipRefresh = true;
                foreach (CheckBox objVehicleCM in tabVehiclePhysicalCM.Controls.OfType<CheckBox>())
                {
                    int intLoopTag = Convert.ToInt32(objVehicleCM.Tag.ToString());
                    // If this is being checked, make sure everything before it is checked off, and if unchecked, everything after it is checked off.
                    if ((intLoopTag < intBoxCheckTag) == blnChecked && intLoopTag != intBoxCheckTag)
                        objVehicleCM.Checked = blnChecked;

                    if (objVehicleCM.Checked)
                        intFillCount += 1;
                }
                _blnSkipRefresh = false;

                objVehicle.PhysicalCMFilled = intFillCount;
            }
            else 
            {
                _blnSkipRefresh = true;
                foreach (CheckBox objVehicleCM in tabVehicleMatrixCM.Controls.OfType<CheckBox>())
                {
                    int intLoopTag = Convert.ToInt32(objVehicleCM.Tag.ToString());
                    // If this is being checked, make sure everything before it is checked off, and if unchecked, everything after it is checked off.
                    if ((intLoopTag < intBoxCheckTag) == blnChecked && intLoopTag != intBoxCheckTag)
                        objVehicleCM.Checked = blnChecked;

                    if (objVehicleCM.Checked)
                        intFillCount += 1;
                }
                _blnSkipRefresh = false;

                objVehicle.MatrixCMFilled = intFillCount;
            }
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

#region Properties
        /// <summary>
        /// Character's name to use when loading them in a new tab.
        /// </summary>
        public string CharacterName
        {
            get
            {
                if (!string.IsNullOrWhiteSpace(_objCharacter.Alias))
                    return _objCharacter.Alias;
                if (!string.IsNullOrWhiteSpace(_objCharacter.Name))
                    return _objCharacter.Name;
                return LanguageManager.GetString("String_UnnamedCharacter");
            }
        }
#endregion

#region Sourcebook Label Events
        private void lblMetatypeSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblMetatypeSource.Text, _objCharacter);
        }

        private void lblQualitySource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblQualitySource.Text, _objCharacter);
        }

        private void lblMartialArtSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblMartialArtSource.Text, _objCharacter);
        }

        private void lblSpellSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblSpellSource.Text, _objCharacter);
        }

        private void lblTraditionSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblTraditionSource.Text, _objCharacter);
        }

        private void lblComplexFormSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblComplexFormSource.Text, _objCharacter);
        }

        private void lblCritterPowerSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblCritterPowerSource.Text, _objCharacter);
        }

        private void lblMetamagicSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblMetamagicSource.Text, _objCharacter);
        }

        private void lblCyberwareSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblCyberwareSource.Text, _objCharacter);
        }

        private void lblLifestyleSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblLifestyleSource.Text, _objCharacter);
        }

        private void lblArmorSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblArmorSource.Text, _objCharacter);
        }

        private void lblWeaponSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblWeaponSource.Text, _objCharacter);
        }

        private void lblGearSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblGearSource.Text, _objCharacter);
        }

        private void lblVehicleSource_Click(object sender, EventArgs e)
        {
            CommonFunctions.OpenPDF(lblVehicleSource.Text, _objCharacter);
        }
#endregion

#region Custom Methods
        public void RefreshContacts()
        {
            HashSet<Contact> existing = new HashSet<Contact>();
            for (int i = panContacts.Controls.Count - 1; i >= 0; i--)
            {
                Control contact = panContacts.Controls[i];
                ContactControl contactControl = (ContactControl)contact;

                if (contactControl != null)
                {
                    if (_objCharacter.Contacts.Contains(contactControl.ContactObject))
                    {
                        contactControl.LoyaltyRating = contactControl.LoyaltyRating; //Force refresh
                        existing.Add(contactControl.ContactObject);
                    }
                    else
                    {
                        objContact_DeleteContact(contactControl, true);
                    }

                }
            }

            //Sync panContacts to character.contacts
            //objContactControl.ConnectionRatingChanged += objContact_ConnectionRatingChanged;
            //objContactControl.LoyaltyRatingChanged += objContact_LoyaltyRatingChanged;
            //objContactControl.DeleteContact += objContact_DeleteContact;
            //objContactControl.FileNameChanged += objContact_FileNameChanged;

            var newcontacts = from contact in _objCharacter.Contacts
                              where contact.EntityType == ContactType.Contact
                              && !existing.Contains(contact)
                              select contact;

            foreach (Contact contact in newcontacts)
            {
                ContactControl ctrl = new ContactControl(_objCharacter);
                ctrl.ContactObject = contact;

                ctrl.ConnectionRatingChanged += objContact_ConnectionRatingChanged;
                ctrl.LoyaltyRatingChanged += objContact_LoyaltyRatingChanged;
                ctrl.DeleteContact += objContact_DeleteContact;
                ctrl.FileNameChanged += objContact_FileNameChanged;
                ctrl.BlackmailChanged += objContact_OtherCostChanged;
                ctrl.FamilyChanged += objContact_OtherCostChanged;

                panContacts.Controls.Add(ctrl);
            }
            foreach (Control contact in panContacts.Controls)
            {
                // Probably won't find subclass, but don't wan't to track
                // down bug about contacts in 4 months because i by some 
                // retarded version decided to overload ContactControl
                if (contact.GetType() == typeof(ContactControl) ||
                    contact.GetType().IsSubclassOf(typeof(ContactControl)))
                {
                    ContactControl contactControl = (ContactControl)contact;
                }
            }
        }

        public void ScheduleCharacterUpdate()
        {
            _blnRequestCharacterUpdate = true;
        }

        /// <summary>
        /// Update the Character information.
        /// </summary>
        public void UpdateCharacterInfo(object sender = null, EventArgs e = null)
        {
            if (_blnLoading || _blnSkipUpdate || !_blnRequestCharacterUpdate)
                return;
            
            _blnSkipUpdate = true;
            string strTip = string.Empty;

            if (!_objCharacter.RefreshRedliner())
                RefreshSelectedCyberware();

            decimal decESS = _objCharacter.Essence;
            decimal decRoundedESS = decimal.Round(decESS, _objCharacter.Options.EssenceDecimals, MidpointRounding.AwayFromZero);
            if (!_objCharacter.Options.DontRoundEssenceInternally)
                decESS = decRoundedESS;
            lblESSMax.Text = decRoundedESS.ToString(GlobalOptions.CultureInfo);
            tssEssence.Text = lblESSMax.Text;

            lblCyberwareESS.Text =
                decimal.Round(_objCharacter.CyberwareEssence, _objCharacter.Options.EssenceDecimals, MidpointRounding.AwayFromZero)
                    .ToString(GlobalOptions.CultureInfo);
            lblBiowareESS.Text =
                decimal.Round(_objCharacter.BiowareEssence, _objCharacter.Options.EssenceDecimals, MidpointRounding.AwayFromZero)
                    .ToString(GlobalOptions.CultureInfo);
            lblEssenceHoleESS.Text =
                decimal.Round(_objCharacter.EssenceHole, _objCharacter.Options.EssenceDecimals, MidpointRounding.AwayFromZero)
                    .ToString(GlobalOptions.CultureInfo);

            // Reduce a character's MAG and RES from Essence Loss.
            int intMetatypeMaximumESS = _objCharacter.ESS.MetatypeMaximum;
            int intReduction = intMetatypeMaximumESS - decimal.ToInt32(decimal.Floor(decESS));
            decimal decESSMag = _objCharacter.Essence + _objCharacter.EssencePenalty - _objCharacter.EssencePenaltyMAG;
            if (!_objCharacter.Options.DontRoundEssenceInternally)
                decESSMag = decimal.Round(decESSMag, _objCharacter.Options.EssenceDecimals, MidpointRounding.AwayFromZero);
            int intMagReduction = intMetatypeMaximumESS - decimal.ToInt32(decimal.Floor(decESSMag));

            // Remove any Improvements from MAG and RES from Essence Loss.
            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.EssenceLoss, "Essence Loss");

            // Create the Essence Loss Improvements.
            if (intReduction > 0)
            {
                if (_objCharacter.Options.SpecialKarmaCostBasedOnShownValue)
                {
                    ImprovementManager.CreateImprovement(_objCharacter, "RES", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intReduction * -1);
                    ImprovementManager.CreateImprovement(_objCharacter, "DEP", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intReduction * -1);
                }
                else
                {
                    ImprovementManager.CreateImprovement(_objCharacter, "RES", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intReduction * -1);
                    ImprovementManager.CreateImprovement(_objCharacter, "DEP", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intReduction * -1);
                }
            }
            if (intMagReduction > 0)
            {
                if (_objCharacter.Options.SpecialKarmaCostBasedOnShownValue)
                {
                    ImprovementManager.CreateImprovement(_objCharacter, "MAG", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intMagReduction * -1);
                    ImprovementManager.CreateImprovement(_objCharacter, "MAGAdept", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, 0, intMagReduction * -1);
                }
                else
                {
                    ImprovementManager.CreateImprovement(_objCharacter, "MAG", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intMagReduction * -1);
                    ImprovementManager.CreateImprovement(_objCharacter, "MAGAdept", Improvement.ImprovementSource.EssenceLoss, "Essence Loss", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intMagReduction * -1);
                }
            }

            // If the CharacterAttribute reaches 0, the character has burned out.
            if (_objCharacter.MAGEnabled)
            {
                if (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept)
                {
                    if ((!_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && _objCharacter.MAG.TotalMaximum < 1) ||
                    (_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && intMagReduction >= _objCharacter.MAG.TotalMaximum))
                    {
                        _objCharacter.MAG.Base = _objCharacter.MAGAdept.Base;
                        _objCharacter.MAG.Karma = _objCharacter.MAGAdept.Karma;
                        _objCharacter.MAG.MetatypeMinimum = _objCharacter.MAGAdept.MetatypeMinimum;
                        _objCharacter.MAG.MetatypeMaximum = _objCharacter.MAGAdept.MetatypeMaximum;
                        _objCharacter.MAG.MetatypeAugmentedMaximum = _objCharacter.MAGAdept.MetatypeAugmentedMaximum;
                        _objCharacter.MAGAdept.Base = 0;
                        _objCharacter.MAGAdept.Karma = 0;
                        _objCharacter.MAGAdept.MetatypeMinimum = 0;
                        _objCharacter.MAGAdept.MetatypeMaximum = 0;
                        _objCharacter.MAGAdept.MetatypeAugmentedMaximum = 0;

                        _objCharacter.MagicianEnabled = false;
                    }
                    if ((!_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && _objCharacter.MAGAdept.TotalMaximum < 1) ||
                    (_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && intMagReduction >= _objCharacter.MAGAdept.TotalMaximum))
                    {
                        _objCharacter.MAGAdept.Base = 0;
                        _objCharacter.MAGAdept.Karma = 0;
                        _objCharacter.MAGAdept.MetatypeMinimum = 0;
                        _objCharacter.MAGAdept.MetatypeMaximum = 0;
                        _objCharacter.MAGAdept.MetatypeAugmentedMaximum = 0;

                        _objCharacter.AdeptEnabled = false;
                    }
                    if (!_objCharacter.MagicianEnabled && !_objCharacter.AdeptEnabled)
                        _objCharacter.MAGEnabled = false;
                }
                else if ((!_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && _objCharacter.MAG.TotalMaximum < 1) ||
                    (_objCharacter.Options.SpecialKarmaCostBasedOnShownValue && intMagReduction >= _objCharacter.MAG.TotalMaximum))
                {
                    _objCharacter.MAG.Base = 0;
                    _objCharacter.MAG.Karma = 0;
                    _objCharacter.MAG.MetatypeMinimum = 0;
                    _objCharacter.MAG.MetatypeMaximum = 0;
                    _objCharacter.MAG.MetatypeAugmentedMaximum = 0;

                    _objCharacter.MagicianEnabled = false;
                    _objCharacter.AdeptEnabled = false;
                    _objCharacter.MAGEnabled = false;
                }
            }
            if (_objCharacter.RES.TotalMaximum < 1 && _objCharacter.RESEnabled && (!_objCharacter.Options.SpecialKarmaCostBasedOnShownValue || intReduction >= _objCharacter.RES.TotalMaximum))
            {
                _objCharacter.RES.Base = 0;
                _objCharacter.RES.Karma = 0;
                _objCharacter.RES.MetatypeMinimum = 0;
                _objCharacter.RES.MetatypeMinimum = 0;
                _objCharacter.RES.MetatypeAugmentedMaximum = 0;

                if (_objCharacter.RESEnabled)
                {
                    // Move all RES-linked Active Skills to Knowledge Skills.
                    //List<Skill> lstNewSkills = new List<Skill>();
                    //foreach (Skill objSkill in _objCharacter.Skills)
                    //{
                    //    if (objSkill.Attribute == "RES" && objSkill.Rating > 0)
                    //    {
                    //        int i = panKnowledgeSkills.Controls.Count;
                    //        Skill objKnowledge = new Skill(_objCharacter);

                    //        SkillControl objSkillControl = new SkillControl();
                    //        objKnowledge.Name = objSkill.Name;
                    //        objSkillControl.SkillObject = objKnowledge;

                    //        // Attach an EventHandler for the RatingChanged and SpecializationChanged Events.
                    //        objSkillControl.RatingChanged += objKnowledgeSkill_RatingChanged;
                    //        objSkillControl.SpecializationChanged += objSkill_SpecializationChanged;
                    //        objSkillControl.DeleteSkill += objKnowledgeSkill_DeleteSkill;
                    //        objSkillControl.SkillKarmaClicked += objKnowledgeSkill_KarmaClicked;
                    //        objSkillControl.DiceRollerClicked += objSkill_DiceRollerClicked;

                    //        objSkillControl.KnowledgeSkill = true;
                    //        objSkillControl.AllowDelete = true;
                    //        if (objSkill.Rating > 13)
                    //            objSkillControl.SkillRatingMaximum = objSkill.Rating;
                    //        else
                    //            objSkillControl.SkillRatingMaximum = 12;
                    //        objSkillControl.SkillRating = objSkill.Rating;
                    //        objSkillControl.SkillCategory = "Professional";
                    //        // Set the SkillControl's Location since scrolling the Panel causes it to actually change the child Controls' Locations.
                    //        objSkillControl.Location = new Point(0, objSkillControl.Height * i + panKnowledgeSkills.AutoScrollPosition.Y);
                    //        panKnowledgeSkills.Controls.Add(objSkillControl);

                    //        lstNewSkills.Add(objKnowledge);
                    //    }
                    //}
                    //foreach (Skill objSkill in lstNewSkills)
                    //    _objCharacter.Skills.Add(objSkill);
                }

                _objCharacter.RESEnabled = false;
                _objCharacter.TechnomancerEnabled = false;
            }

            // If the character is an A.I., set the Edge MetatypeMaximum to their Rating.
            if (_objCharacter.DEPEnabled)
                _objCharacter.EDG.MetatypeMaximum = _objCharacter.DEP.Value;

            // If the character is Cyberzombie, adjust their Attributes based on their Essence.
            if (_objCharacter.MetatypeCategory == "Cyberzombie")
            {
                int intESSModifier = _objCharacter.EssencePenalty - decimal.ToInt32(_objCharacter.EssenceMaximum);
                ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes");
                ImprovementManager.CreateImprovement(_objCharacter, "BOD", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "AGI", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "REA", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "STR", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "CHA", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "INT", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "LOG", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
                ImprovementManager.CreateImprovement(_objCharacter, "WIL", Improvement.ImprovementSource.Cyberzombie, "Cyberzombie Attributes", Improvement.ImprovementType.Attribute, string.Empty, 0, 1, 0, intESSModifier);
            }

            if (_objCharacter.AdeptEnabled)
            {
                tabPowerUc.MissingDatabindingsWorkaround();
            }

            Dictionary<string, int> dicAttributeValues = new Dictionary<string, int>(AttributeSection.AttributeStrings.Length);
            foreach (string strAttribute in AttributeSection.AttributeStrings)
            {
                dicAttributeValues.Add(strAttribute, _objCharacter.GetAttribute(strAttribute).Value);
            }
            Dictionary<string, int> dicAttributeTotalValues = new Dictionary<string, int>(AttributeSection.AttributeStrings.Length);
            foreach (string strAttribute in AttributeSection.AttributeStrings)
            {
                dicAttributeTotalValues.Add(strAttribute, _objCharacter.GetAttribute(strAttribute).TotalValue);
            }

            if (_objCharacter.MysticAdeptPowerPoints > dicAttributeTotalValues["MAG"])
                _objCharacter.MysticAdeptPowerPoints = dicAttributeTotalValues["MAG"];

            // Condition Monitor.
            UpdateConditionMonitor(lblCMPhysical, lblCMStun, tipTooltip);
            int intCMPhysical = _objCharacter.PhysicalCM;
            int intCMStun = _objCharacter.StunCM;
            int intCMOverflow = _objCharacter.CMOverflow;
            int intCMThreshold = _objCharacter.CMThreshold;
            int intPhysicalCMPenalty = 0;
            int intStunCMPenalty = 0;
            int intCMPenalty = 0;

            // Hide any unused Physical CM boxes.
            foreach (CheckBox objPhysicalCM in panPhysicalCM.Controls.OfType<CheckBox>())
            {
                int intBoxTag = Convert.ToInt32(objPhysicalCM.Tag.ToString());
                if (intBoxTag <= intCMPhysical + intCMOverflow)
                {
                    if (intBoxTag <= _objCharacter.PhysicalCMFilled)
                        objPhysicalCM.Checked = true;

                    objPhysicalCM.Visible = true;
                        
                    if (intBoxTag <= intCMPhysical)
                    {
                        // If this is within the Physical CM limits, act normally.
                        objPhysicalCM.BackColor = SystemColors.Control;
                        objPhysicalCM.UseVisualStyleBackColor = true;
                        if ((intBoxTag - ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset)) % intCMThreshold == 0 && intBoxTag > ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset))
                        {
                            int intModifiers = ((intBoxTag - ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset)) / intCMThreshold) * -1;
                            objPhysicalCM.Text = intModifiers.ToString();
                            if (objPhysicalCM.Checked)
                            {
                                if (intModifiers < intPhysicalCMPenalty)
                                    intPhysicalCMPenalty = intModifiers;
                            }
                        }
                        else
                            objPhysicalCM.Text = string.Empty;
                    }
                    else if (intBoxTag > intCMPhysical)
                    {
                        objPhysicalCM.BackColor = SystemColors.ControlDark;
                        if (intBoxTag == intCMPhysical + intCMOverflow)
                            objPhysicalCM.Text = "D";
                        else
                            objPhysicalCM.Text = string.Empty;
                    }
                }
                else
                {
                    objPhysicalCM.Visible = false;
                    objPhysicalCM.Text = string.Empty;
                }
            }

            // Hide any unused Stun CM boxes.
            foreach (CheckBox objStunCM in panStunCM.Controls.OfType<CheckBox>())
            {
                int intBoxTag = Convert.ToInt32(objStunCM.Tag.ToString());
                if (intBoxTag <= intCMStun)
                {
                    if (intBoxTag <= _objCharacter.StunCMFilled)
                        objStunCM.Checked = true;

                    objStunCM.Visible = true;
                    if ((intBoxTag - ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset)) % intCMThreshold == 0 && intBoxTag > ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset))
                    {
                        int intModifiers = ((intBoxTag - ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CMThresholdOffset)) / intCMThreshold) * -1;
                        objStunCM.Text = intModifiers.ToString();
                        if (objStunCM.Checked)
                        {
                            if (intModifiers < intStunCMPenalty)
                                intStunCMPenalty = intModifiers;
                        }
                    }
                    else
                        objStunCM.Text = string.Empty;
                }
                else
                {
                    objStunCM.Visible = false;
                    objStunCM.Text = string.Empty;
                }
            }

            // Reduce the CM Penalties to 0 if the character has Improvements to ignore them.
            if (_objCharacter.HasImprovement(Improvement.ImprovementType.IgnoreCMPenaltyStun, true))
                intStunCMPenalty = 0;
            if (_objCharacter.HasImprovement(Improvement.ImprovementType.IgnoreCMPenaltyPhysical, true))
                intPhysicalCMPenalty = 0;

            intCMPenalty = intPhysicalCMPenalty + intStunCMPenalty;
            lblCMPenalty.Text = intCMPenalty.ToString();

            // Discard any old Condition Monitor penalties.
            ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.ConditionMonitor, string.Empty);

            // Create the new Condition Monitor penalties.
            if (intCMPenalty < 0)
                ImprovementManager.CreateImprovement(_objCharacter, string.Empty, Improvement.ImprovementSource.ConditionMonitor, string.Empty,
                    Improvement.ImprovementType.ConditionMonitor, string.Empty, intCMPenalty);

            UpdateArmorRating(lblArmor, tipTooltip, lblCMArmor);

            //Update the Spell Defence tab.
            UpdateSpellDefence(dicAttributeTotalValues);

            // Update the CharacterAttribute information.

                /*// Character Attribute: BOD
                UpdateCharacterAttribute(_objCharacter.BOD, lblBODMetatype, lblBODAug, tipTooltip);

                // Character Attribute: AGI
                UpdateCharacterAttribute(_objCharacter.AGI,lblAGIMetatype,lblAGIAug,tipTooltip);

                // Character Attribute: REA
                UpdateCharacterAttribute(_objCharacter.REA, lblREAMetatype, lblREAAug, tipTooltip);

                // Character Attribute: STR
                UpdateCharacterAttribute(_objCharacter.STR, lblSTRMetatype, lblSTRAug, tipTooltip);

                // Character Attribute: CHA
                UpdateCharacterAttribute(_objCharacter.CHA, lblCHAMetatype, lblCHAAug, tipTooltip);

                // Character Attribute: INT
                UpdateCharacterAttribute(_objCharacter.INT, lblINTMetatype, lblINTAug, tipTooltip);

                // Character Attribute: AGI
                UpdateCharacterAttribute(_objCharacter.AGI, lblAGIMetatype, lblAGIAug, tipTooltip);

                // Character Attribute: LOG
                UpdateCharacterAttribute(_objCharacter.LOG, lblLOGMetatype, lblLOGAug, tipTooltip);

                // Character Attribute: WIL
                UpdateCharacterAttribute(_objCharacter.WIL, lblWILMetatype, lblWILAug, tipTooltip);

                // Character Attribute: EDG
                UpdateCharacterAttribute(_objCharacter.EDG, lblEDGMetatype, lblEDGAug, tipTooltip);

                // Character Attribute: MAG
                UpdateCharacterAttribute(_objCharacter.MAG, lblMAGMetatype, lblMAGAug, tipTooltip);

                // Character Attribute: RES
                UpdateCharacterAttribute(_objCharacter.RES, lblRESMetatype, lblRESAug, tipTooltip);

                // Character Attribute: DEP
                UpdateCharacterAttribute(_objCharacter.DEP, lblDEPMetatype, lblDEPAug, tipTooltip);*/

            // Update the MAG pseudo-Attributes if applicable.
            int intCharacterMAG = dicAttributeValues["MAG"];
            if (_objCharacter.AdeptEnabled && _objCharacter.MagicianEnabled)
            {
                lblMysticAdeptMAGAdept.Text = _objCharacter.MysticAdeptPowerPoints.ToString();
            }

            // Update the maximum Force for all Spirits.
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
            {
                if (_objOptions.SpiritForceBasedOnTotalMAG)
                    objSpiritControl.ForceMaximum = dicAttributeTotalValues["MAG"] * 2;
                else
                {
                    int intLocalMAG = intCharacterMAG;
                    if (intLocalMAG == 0)
                        intLocalMAG = 1;

                    objSpiritControl.ForceMaximum = intLocalMAG * 2;
                }
                objSpiritControl.RebuildSpiritList(_objCharacter.MagicTradition);
            }

            if (_objCharacter.AdeptEnabled)
            {
                tabPowerUc.MissingDatabindingsWorkaround();
            }

            // Update the Drain CharacterAttribute Value.
            if (_objCharacter.MAGEnabled && !string.IsNullOrEmpty(lblDrainAttributes.Text))
            {
                CalculateTraditionDrain(_objCharacter.TraditionDrain, Improvement.ImprovementType.DrainResistance, lblDrainAttributes, lblDrainAttributesValue, tipTooltip);
            }

            // Update the maximum Force for all Sprites.
            foreach (SpiritControl objSpiritControl in panSprites.Controls)
            {
                objSpiritControl.ForceMaximum = dicAttributeTotalValues["RES"] * 2;
                objSpiritControl.RebuildSpiritList(_objCharacter.TechnomancerStream);
            }

            // Update the Fading CharacterAttribute Value.
            if (_objCharacter.RESEnabled && !string.IsNullOrEmpty(lblFadingAttributes.Text))
            {
                CalculateTraditionDrain(_objCharacter.TechnomancerFading, Improvement.ImprovementType.FadingResistance, lblFadingAttributes, lblFadingAttributesValue, tipTooltip);
            }

            // Skill Limits
            RefreshLimits(lblPhysical, lblMental, lblSocial, lblAstral, tipTooltip);

            int intINTAttributeModifiers = _objCharacter.INT.AttributeModifiers;
            int intREAAttributeModifiers = _objCharacter.REA.AttributeModifiers;

            // Initiative.
            lblINI.Text = _objCharacter.Initiative;
            string strInitText = LanguageManager.GetString("String_Initiative");
            string strMatrixInitText = LanguageManager.GetString("String_MatrixInitiativeLong");
            string strModifiers = LanguageManager.GetString("Tip_Modifiers");
            string strInit =
                $"{_objCharacter.REA.DisplayAbbrev} ({dicAttributeValues["REA"]}) + {_objCharacter.INT.DisplayAbbrev} ({dicAttributeValues["INT"]})";
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.Initiative) > 0 ||
                intINTAttributeModifiers > 0 || intREAAttributeModifiers > 0)
                strInit += " + " + strModifiers + " (" +
                           (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.Initiative) +
                            intINTAttributeModifiers + intREAAttributeModifiers).ToString() + ")";
            tipTooltip.SetToolTip(lblINI,
                strInitText.Replace("{0}", strInit).Replace("{1}", _objCharacter.InitiativeDice.ToString()));

            // Astral Initiative.
            lblAstralINI.Visible = _objCharacter.MAGEnabled;
            if (_objCharacter.MAGEnabled)
            {
                lblAstralINI.Text = _objCharacter.AstralInitiative;
                strInit = $"{_objCharacter.INT.DisplayAbbrev} ({dicAttributeValues["INT"]}) x 2";
                if (intINTAttributeModifiers > 0)
                    strInit += $"{strModifiers} ({intINTAttributeModifiers})";
                tipTooltip.SetToolTip(lblAstralINI,
                    strInitText.Replace("{0}", strInit).Replace("{1}", _objCharacter.AstralInitiativeDice.ToString()));
            }

            // Matrix Initiative (AR).
            lblMatrixINI.Text = _objCharacter.MatrixInitiative;
            strInit =
                $"{_objCharacter.REA.DisplayAbbrev} ({dicAttributeValues["REA"]}) + {_objCharacter.INT.DisplayAbbrev} ({dicAttributeValues["INT"]})";
            if (intINTAttributeModifiers > 0 || intREAAttributeModifiers > 0)
                strInit += $"{strModifiers} ({intREAAttributeModifiers + intINTAttributeModifiers})";
            tipTooltip.SetToolTip(lblMatrixINI,
                strInitText.Replace("{0}", strInit).Replace("{1}", _objCharacter.InitiativeDice.ToString()));

            // Matrix Initiative (Cold).
            lblMatrixINICold.Text = _objCharacter.MatrixInitiativeCold;
            strInit = strMatrixInitText.Replace("{0}", dicAttributeValues["INT"].ToString())
                .Replace("{1}", _objCharacter.MatrixInitiativeColdDice.ToString());
            if (intINTAttributeModifiers > 0)
                strInit += $"{strModifiers} ({intINTAttributeModifiers})";
            tipTooltip.SetToolTip(lblMatrixINICold, strInit);

            // Matrix Initiative (Hot).
            lblMatrixINIHot.Text = _objCharacter.MatrixInitiativeHot;
            strInit = strMatrixInitText.Replace("{0}", dicAttributeValues["INT"].ToString())
                .Replace("{1}", _objCharacter.MatrixInitiativeHotDice.ToString());
            if (intINTAttributeModifiers > 0)
                strInit += $"{strModifiers} ({intINTAttributeModifiers})";
            tipTooltip.SetToolTip(lblMatrixINIHot, strInit);

            // Rigger Initiative.
            lblRiggingINI.Text = _objCharacter.Initiative;
            strInit =
                $"{_objCharacter.REA.DisplayAbbrev} ({dicAttributeValues["REA"]}) + {_objCharacter.INT.DisplayAbbrev} ({dicAttributeValues["INT"]})";
            if (intINTAttributeModifiers > 0 || intREAAttributeModifiers > 0)
                strInit += $"{strModifiers} ({intREAAttributeModifiers + intINTAttributeModifiers})";
            tipTooltip.SetToolTip(lblRiggingINI,
                strInitText.Replace("{0}", strInit).Replace("{1}", _objCharacter.InitiativeDice.ToString()));

            if ((_objCharacter.Metatype == "Free Spirit" && !_objCharacter.IsCritter) ||
                _objCharacter.MetatypeCategory.EndsWith("Spirits"))
            {
                lblCritterPowerPointsLabel.Visible = true;
                lblCritterPowerPoints.Visible = true;
                lblCritterPowerPoints.Text = CommonFunctions.CalculateFreeSpiritPowerPoints(_objCharacter);
            }
            else if (_objCharacter.IsFreeSprite)
            {
                lblCritterPowerPointsLabel.Visible = true;
                lblCritterPowerPoints.Visible = true;
                lblCritterPowerPoints.Text = CommonFunctions.CalculateFreeSpritePowerPoints(_objCharacter);
            }

            // Update the Nuyen and Karma for the character.
            tssNuyen.Text = _objCharacter.Nuyen.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
            lblRemainingNuyen.Text = _objCharacter.Nuyen.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';

            PopulateExpenseList();

            // Movement.
            lblMovement.Text = _objCharacter.GetMovement(GlobalOptions.CultureInfo);
            //strTip = _objCharacter.CalculatedMovementSpeed;
            //tipTooltip.SetToolTip(lblMovement, strTip);
            lblSwim.Text = _objCharacter.GetSwim(GlobalOptions.CultureInfo);
            lblFly.Text = _objCharacter.GetFly(GlobalOptions.CultureInfo);

            // Special CharacterAttribute-Only Test.
            lblComposure.Text = _objCharacter.Composure.ToString();
            strTip =
                $"{_objCharacter.WIL.DisplayAbbrev} ({dicAttributeTotalValues["WIL"]}) + {_objCharacter.CHA.DisplayAbbrev} ({dicAttributeTotalValues["CHA"]})";
            tipTooltip.SetToolTip(lblComposure, strTip);
            lblJudgeIntentions.Text = _objCharacter.JudgeIntentions.ToString();
            strTip =
                $"{_objCharacter.INT.DisplayAbbrev} ({dicAttributeTotalValues["INT"]}) + {_objCharacter.CHA.DisplayAbbrev} ({dicAttributeTotalValues["CHA"]})";
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.JudgeIntentions) != 0)
                strTip += " + " + LanguageManager.GetString("Tip_Modifiers") + " (" +
                          ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.JudgeIntentions).ToString() + ")";
            tipTooltip.SetToolTip(lblJudgeIntentions, strTip);
            lblLiftCarry.Text = _objCharacter.LiftAndCarry.ToString();
            strTip =
                $"{_objCharacter.STR.DisplayAbbrev} ({dicAttributeTotalValues["STR"]}) + {_objCharacter.BOD.DisplayAbbrev} ({dicAttributeTotalValues["BOD"]})";
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.LiftAndCarry) != 0)
                strTip += " + " + LanguageManager.GetString("Tip_Modifiers") + " (" +
                          ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.LiftAndCarry).ToString() + ")";
            strTip += "\n" +
                      LanguageManager.GetString("Tip_LiftAndCarry")
                          .Replace("{0}", (dicAttributeTotalValues["STR"] * 15).ToString())
                          .Replace("{1}", (dicAttributeTotalValues["STR"] * 10).ToString());
            tipTooltip.SetToolTip(lblLiftCarry, strTip);
            lblMemory.Text = _objCharacter.Memory.ToString();
            strTip =
                $"{_objCharacter.WIL.DisplayAbbrev} ({dicAttributeTotalValues["WIL"]}) + {_objCharacter.LOG.DisplayAbbrev} ({dicAttributeTotalValues["LOG"]})";
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.Memory) != 0)
                strTip += " + " + LanguageManager.GetString("Tip_Modifiers") + " (" +
                          ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.Memory).ToString() + ")";
            tipTooltip.SetToolTip(lblMemory, strTip);

            // Career Karma.
            lblCareerKarma.Text = _objCharacter.CareerKarma.ToString();

            // Career Nuyen.
            lblCareerNuyen.Text = _objCharacter.CareerNuyen.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';

            // Update Damage Resistance Pool.
            lblCMDamageResistancePool.Text =
            (dicAttributeTotalValues["BOD"] + ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DamageResistance) +
             _objCharacter.TotalArmorRating).ToString();
            strTip = $"{_objCharacter.BOD.DisplayAbbrev} + {LanguageManager.GetString("Tip_Armor")}";
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DamageResistance) != 0)
                strTip += " + " + LanguageManager.GetString("Tip_Modifiers") + " (" +
                          ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.DamageResistance).ToString() + ")";
            tipTooltip.SetToolTip(lblCMDamageResistancePool, strTip);

            // Update EDG Remaining Info on the Condition Monitor tab.
            string strEDG = dicAttributeTotalValues["EDG"].ToString() + " " + LanguageManager.GetString("String_Of") +
                            " " + dicAttributeValues["EDG"].ToString() + " " +
                            LanguageManager.GetString("String_Remaining");
            lblEDGInfo.Text = strEDG;

            ImprovementManager.Commit(_objCharacter);

            // If the Viewer window is open for this character, call its RefreshView method which updates it asynchronously
            if (_objCharacter.PrintWindow != null)
                _objCharacter.PrintWindow.RefreshView();
            if (GlobalOptions.MainForm.PrintMultipleCharactersForm?.CharacterList?.Contains(_objCharacter) == true)
                GlobalOptions.MainForm.PrintMultipleCharactersForm.PrintViewForm?.RefreshView();

            cmdQuickenSpell.Visible = _objCharacter.HasImprovement(Improvement.ImprovementType.QuickeningMetamagic, true);
            cmdAddBioware.Enabled = !_objCharacter.HasImprovement(Improvement.ImprovementType.DisableBioware, true);
            cmdAddCyberware.Enabled = !_objCharacter.HasImprovement(Improvement.ImprovementType.DisableCyberware, true);
            RefreshLimitModifiers();
            RefreshImprovements();
            UpdateReputation();

            if (Autosave_StopWatch.Elapsed.Minutes >= 5 && _blnIsDirty)
            {
                AutoSaveCharacter();
            }
            _blnSkipUpdate = false;
            _blnRequestCharacterUpdate = false;
        }

        /// <summary>
        /// Refresh the information for the currently displayed piece of Cyberware.
        /// </summary>
        public void RefreshSelectedCyberware()
        {
            _blnSkipRefresh = true;
            cboCyberwareGearAttack.Visible = false;
            cboCyberwareGearSleaze.Visible = false;
            cboCyberwareGearDataProcessing.Visible = false;
            cboCyberwareGearFirewall.Visible = false;
            cboCyberwareGearOverclocker.Visible = false;
            lblCyberDeviceRating.Visible = false;
            lblCyberDeviceRatingLabel.Visible = false;
            lblCyberAttackLabel.Visible = false;
            lblCyberSleazeLabel.Visible = false;
            lblCyberDataProcessingLabel.Visible = false;
            lblCyberFirewallLabel.Visible = false;
            cmdDeleteCyberware.Enabled = treCyberware.SelectedNode != null;
            cmdCyberwareChangeMount.Visible = false;

            if (treCyberware.SelectedNode == null || treCyberware.SelectedNode.Level == 0)
            {
                lblCyberwareName.Text = string.Empty;
                lblCyberwareCategory.Text = string.Empty;
                lblCyberwareRating.Text = string.Empty;
                lblCyberwareAvail.Text = string.Empty;
                lblCyberwareCost.Text = string.Empty;
                lblCyberwareCapacity.Text = string.Empty;
                lblCyberwareEssence.Text = string.Empty;
                lblCyberwareSource.Text = string.Empty;
                tipTooltip.SetToolTip(lblCyberwareSource, null);
                lblCyberlimbAGI.Visible = false;
                lblCyberlimbAGILabel.Visible = false;
                lblCyberlimbSTR.Visible = false;
                lblCyberlimbSTRLabel.Visible = false;
                _blnSkipRefresh = false;
                return;
            }
            Cyberware objCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(),
                _objCharacter.Cyberware);
            // Locate the selected piece of Cyberware.
            if (objCyberware != null)
            {
                if (!string.IsNullOrEmpty(objCyberware.ParentID))
                    cmdDeleteCyberware.Enabled = false;
                cmdCyberwareChangeMount.Visible = !string.IsNullOrEmpty(objCyberware.PlugsIntoModularMount);
                lblCyberwareName.Text = objCyberware.DisplayNameShort;
                lblCyberwareCategory.Text = objCyberware.DisplayCategory;
                string strBook = _objOptions.LanguageBookShort(objCyberware.Source);
                string strPage = objCyberware.Page;
                lblCyberwareSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblCyberwareSource,
                    _objOptions.LanguageBookLong(objCyberware.Source) + " " +
                    LanguageManager.GetString("String_Page") + " " + objCyberware.Page);
                lblCyberwareRating.Text = objCyberware.Rating.ToString();

                lblCyberwareGrade.Text = objCyberware.Grade.DisplayName;

                if (objCyberware.Category.Equals("Cyberlimb"))
                {
                    lblCyberlimbAGI.Visible = true;
                    lblCyberlimbAGILabel.Visible = true;
                    lblCyberlimbSTR.Visible = true;
                    lblCyberlimbSTRLabel.Visible = true;

                    lblCyberlimbAGI.Text = objCyberware.TotalAgility.ToString();
                    lblCyberlimbSTR.Text = objCyberware.TotalStrength.ToString();
                }
                else
                {
                    lblCyberlimbAGI.Visible = false;
                    lblCyberlimbAGILabel.Visible = false;
                    lblCyberlimbSTR.Visible = false;
                    lblCyberlimbSTRLabel.Visible = false;
                }

                if (objCyberware.SourceType == Improvement.ImprovementSource.Cyberware)
                {
                    // Locate the selected Cyberware.
                    TreeNode objCyberwareNode = new TreeNode();
                    objCyberwareNode = treCyberware.SelectedNode;
                    tabCyberwareCM.Visible = true;
                    if (treCyberware.SelectedNode.Level > 1)
                    {
                        while (objCyberwareNode.Level > 1)
                        {
                            objCyberwareNode = objCyberwareNode.Parent;
                            tabCyberwareCM.Visible = false;
                        }
                    }
                    else
                    {
                        tabCyberwareCM.Visible = true;
                    }

                    // Hide any unused CM boxes.
                    foreach (CheckBox objMatrixCM in tabCyberwareMatrixCM.Controls.OfType<CheckBox>())
                    {
                        if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objCyberware.MatrixCM)
                        {
                            if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objCyberware.MatrixCMFilled)
                                objMatrixCM.Checked = true;
                            else
                                objMatrixCM.Checked = false;

                            objMatrixCM.Visible = true;
                        }
                        else
                        {
                            objMatrixCM.Checked = false;
                            objMatrixCM.Visible = false;
                            objMatrixCM.Text = string.Empty;
                        }
                    }
                }
                else
                {
                    tabCyberwareCM.Visible = false;
                }

                lblCyberwareAvail.Text = objCyberware.TotalAvail;
                lblCyberwareCost.Text = objCyberware.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                lblCyberwareCapacity.Text = objCyberware.CalculatedCapacity + " (" +
                                            objCyberware.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " +
                                            LanguageManager.GetString("String_Remaining") + ")";
                lblCyberwareEssence.Text = objCyberware.CalculatedESS().ToString(GlobalOptions.CultureInfo);
                if (objCyberware.AddToParentESS)
                    lblCyberwareEssence.Text = "+" + lblCyberwareEssence.Text;
            }
            else
            {
                // Locate the selected piece of Gear.
                Gear objGear = CommonFunctions.FindCyberwareGear(treCyberware.SelectedNode.Tag.ToString(),
                    _objCharacter.Cyberware.GetAllDescendants(x => x.Children));

                if (objGear != null)
                {
                    if (objGear.IncludedInParent)
                        cmdDeleteCyberware.Enabled = false;
                    if (objGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink) objGear;
                        lblGearDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();
                        chkActiveCommlink.Checked = objCommlink.IsActive;

                        objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);

                        lblCyberDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();

                        cboCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblCyberDeviceRating.Visible = true;
                        lblCyberDeviceRatingLabel.Visible = true;
                        lblCyberAttackLabel.Visible = true;
                        lblCyberSleazeLabel.Visible = true;
                        lblCyberDataProcessingLabel.Visible = true;
                        lblCyberFirewallLabel.Visible = true;

                        if (objCommlink.Category != "Commlink Upgrade")
                            chkActiveCommlink.Visible = true;
                    }
                    else
                    {
                        lblCyberDeviceRating.Text = objGear.GetTotalMatrixAttribute("Device Rating").ToString();
                        chkActiveCommlink.Visible = false;
                        cboCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        cboCyberwareGearAttack.Visible = false;
                        cboCyberwareGearSleaze.Visible = false;
                        cboCyberwareGearDataProcessing.Visible = false;
                        cboCyberwareGearFirewall.Visible = false;
                        lblCyberDeviceRatingLabel.Visible = true;
                        lblGearAttackLabel.Visible = false;
                        lblGearSleazeLabel.Visible = false;
                        lblGearDataProcessingLabel.Visible = false;
                        lblGearFirewallLabel.Visible = false;
                    }

                    lblCyberwareName.Text = objGear.DisplayNameShort;
                    lblCyberwareCategory.Text = objGear.DisplayCategory;
                    lblCyberwareAvail.Text = objGear.TotalAvail(true);
                    lblCyberwareCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    lblCyberwareCapacity.Text = objGear.CalculatedCapacity + " (" + objGear.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) +
                                                " " + LanguageManager.GetString("String_Remaining") + ")";
                    lblCyberwareEssence.Text = "0";
                    lblCyberwareGrade.Text = string.Empty;
                    lblCyberwareRating.Text = objGear.Rating.ToString();
                    string strBook = _objOptions.LanguageBookShort(objGear.Source);
                    string strPage = objGear.Page;
                    lblCyberwareSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblCyberwareSource,
                        _objOptions.LanguageBookLong(objGear.Source) + " " +
                        LanguageManager.GetString("String_Page") + " " + objGear.Page);
                }
            }
            _blnSkipRefresh = false;
        }

        public void RefreshAIPrograms()
        {
            treAIPrograms.Nodes[0].Nodes.Clear();

            // Populate AI Programs.
            foreach (AIProgram objAIProgram in _objCharacter.AIPrograms)
            {
                TreeNode objNode = new TreeNode();
                objNode.Text = objAIProgram.DisplayName;
                objNode.Tag = objAIProgram.InternalId;
                if (!string.IsNullOrEmpty(objAIProgram.Notes))
                    objNode.ForeColor = Color.SaddleBrown;
                else if (!objAIProgram.CanDelete)
                    objNode.ForeColor = SystemColors.GrayText;
                else
                    objNode.ForeColor = SystemColors.WindowText;
                objNode.ToolTipText = CommonFunctions.WordWrap(objAIProgram.Notes, 100);
                objNode.ContextMenuStrip = cmsAdvancedProgram;
                treAIPrograms.Nodes[0].Nodes.Add(objNode);
            }
            treAIPrograms.Nodes[0].Expand();
        }

        public void RefreshMartialArts()
        {
            treMartialArts.Nodes[0].Nodes.Clear();
            treMartialArts.Nodes[1].Nodes.Clear();

            // Populate Martial Arts.
            foreach (MartialArt objMartialArt in _objCharacter.MartialArts)
            {
                treMartialArts.Add(objMartialArt, cmsMartialArts);
            }
        }

        public void RefreshLimitModifiers()
        {
            treLimit.Nodes[0].Nodes.Clear();
            treLimit.Nodes[1].Nodes.Clear();
            treLimit.Nodes[2].Nodes.Clear();

            // Populate Limit Modifiers.
            foreach (LimitModifier objLimitModifier in _objCharacter.LimitModifiers)
            {
                treLimit.Add(objLimitModifier, cmsLimitModifier);
            }

            // Populate Limit Modifiers from Improvements
            foreach (Improvement objImprovement in _objCharacter.Improvements)
            {
                if (objImprovement.ImproveType == Improvement.ImprovementType.LimitModifier)
                {
                    treLimit.Add(objImprovement, cmsLimitModifier);
                }
            }
        }

        /// <summary>
        /// Refresh the information for the currently displayed Weapon.
        /// </summary>
        public void RefreshSelectedWeapon()
        {
            _blnSkipRefresh = true;
            lblWeaponDeviceRating.Text = string.Empty;
            lblWeaponFirewallLabel.Visible = false;
            lblWeaponDataProcessingLabel.Visible = false;
            lblWeaponSleazeLabel.Visible = false;
            lblWeaponAttackLabel.Visible = false;
            cboCyberwareGearAttack.Visible = false;
            cboCyberwareGearDataProcessing.Visible = false;
            cboCyberwareGearFirewall.Visible = false;
            cboCyberwareGearSleaze.Visible = false;
            cmdDeleteWeapon.Enabled = treWeapons.SelectedNode != null;
            // Hide Weapon Ranges.
            lblWeaponRangeMain.Text = string.Empty;
            lblWeaponRangeAlternate.Text = string.Empty;
            lblWeaponRangeShort.Text = string.Empty;
            lblWeaponRangeMedium.Text = string.Empty;
            lblWeaponRangeLong.Text = string.Empty;
            lblWeaponRangeExtreme.Text = string.Empty;
            lblWeaponAlternateRangeShort.Text = string.Empty;
            lblWeaponAlternateRangeMedium.Text = string.Empty;
            lblWeaponAlternateRangeLong.Text = string.Empty;
            lblWeaponAlternateRangeExtreme.Text = string.Empty;

            if (treWeapons.SelectedNode == null || treWeapons.SelectedNode.Level == 0)
            {
                lblWeaponName.Text = string.Empty;
                lblWeaponCategory.Text = string.Empty;
                lblWeaponAvail.Text = string.Empty;
                lblWeaponCost.Text = string.Empty;
                lblWeaponConceal.Text = string.Empty;
                lblWeaponAccuracy.Text = string.Empty;
                lblWeaponDamage.Text = string.Empty;
                lblWeaponRC.Text = string.Empty;
                lblWeaponAP.Text = string.Empty;
                lblWeaponReach.Text = string.Empty;
                lblWeaponMode.Text = string.Empty;
                lblWeaponAmmo.Text = string.Empty;
                lblWeaponRating.Text = string.Empty;
                lblWeaponSource.Text = string.Empty;
                cboWeaponAmmo.Enabled = false;
                tipTooltip.SetToolTip(lblWeaponSource, null);
                chkWeaponAccessoryInstalled.Enabled = false;
                chkIncludedInWeapon.Enabled = false;
                chkIncludedInWeapon.Checked = false;

                // Disable the fire button.
                cmdFireWeapon.Enabled = false;
                cmdReloadWeapon.Enabled = false;
                cmdWeaponBuyAmmo.Enabled = false;
                cboWeaponAmmo.Enabled = false;
                _blnSkipRefresh = false;
                return;
            }

            lblWeaponDicePool.Text = string.Empty;
            tipTooltip.SetToolTip(lblWeaponDicePool, string.Empty);
            cmdWeaponMoveToVehicle.Enabled = false;

            // Locate the selected Weapon.
            if (treWeapons.SelectedNode.Level == 1)
            {
                Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
                if (objWeapon == null)
                    return;

                if (objWeapon.Cyberware || objWeapon.Category == "Gear" || objWeapon.Category.StartsWith("Quality") || objWeapon.IncludedInWeapon || !string.IsNullOrEmpty(objWeapon.ParentID))
                    cmdDeleteWeapon.Enabled = false;
                lblWeaponName.Text = objWeapon.DisplayNameShort;
                lblWeaponCategory.Text = objWeapon.DisplayCategory;
                string strBook = _objOptions.LanguageBookShort(objWeapon.Source);
                string strPage = objWeapon.Page;
                lblWeaponSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblWeaponSource, _objOptions.LanguageBookLong(objWeapon.Source) + " " + LanguageManager.GetString("String_Page") + " " + objWeapon.Page);
                chkWeaponAccessoryInstalled.Enabled = false;
                chkIncludedInWeapon.Enabled = false;
                chkIncludedInWeapon.Checked = false;

                // Do not allow Cyberware of Gear Weapons to be moved.
                if (!objWeapon.Cyberware && objWeapon.Category != "Gear")
                {
                    if (_objCharacter.Vehicles.Count > 0)
                        cmdWeaponMoveToVehicle.Enabled = true;
                    else
                        cmdWeaponMoveToVehicle.Enabled = false;
                }

                // Enable the fire button if the Weapon is Ranged.
                if (objWeapon.WeaponType == "Ranged" || (objWeapon.WeaponType == "Melee" && objWeapon.Ammo != "0"))
                {
                    cmdFireWeapon.Enabled = true;
                    cmdReloadWeapon.Enabled = true;
                    cmdWeaponBuyAmmo.Enabled = true;
                    lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
                    //lblWeaponAmmoType.Text = "External Source";

                    cmsAmmoSingleShot.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeSingleShot")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeSemiAutomatic"));
                    cmsAmmoShortBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeBurstFire")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoLongBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoFullBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoSuppressiveFire.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));

                    // Melee Weapons with Ammo are considered to be Single Shot.
                    if (objWeapon.WeaponType == "Melee" && objWeapon.Ammo != "0")
                        cmsAmmoSingleShot.Enabled = true;

                    if (cmsAmmoFullBurst.Enabled)
                        cmsAmmoFullBurst.Text = LanguageManager.GetString("String_FullBurst").Replace("{0}", objWeapon.FullBurst.ToString());
                    if (cmsAmmoSuppressiveFire.Enabled)
                        cmsAmmoSuppressiveFire.Text = LanguageManager.GetString("String_SuppressiveFire").Replace("{0}", objWeapon.Suppressive.ToString());

                    List<ListItem> lstAmmo = new List<ListItem>();
                    int intCurrentSlot = objWeapon.ActiveAmmoSlot;
                    for (int i = 1; i <= objWeapon.AmmoSlots; i++)
                    {
                        ListItem objAmmo = new ListItem();
                        objWeapon.ActiveAmmoSlot = i;
                        Gear objGear = CommonFunctions.DeepFindById(objWeapon.AmmoLoaded, _objCharacter.Gear);
                        objAmmo.Value = i.ToString();

                        string strPlugins = string.Empty;
                        if (objGear != null)
                        {
                            foreach (Gear objChild in objGear.Children)
                            {
                                strPlugins += objChild.DisplayNameShort + ", ";
                            }
                        }
                        // Remove the trailing comma.
                        if (!string.IsNullOrEmpty(strPlugins))
                            strPlugins = strPlugins.Substring(0, strPlugins.Length - 2);

                        if (objGear == null)
                        {
                            if (objWeapon.AmmoRemaining == 0)
                                objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_Empty");
                            else
                                objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_ExternalSource");
                        }
                        else
                            objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + objGear.DisplayNameShort;
                        if (!string.IsNullOrEmpty(strPlugins))
                            objAmmo.Name += " [" + strPlugins + "]";
                        lstAmmo.Add(objAmmo);
                    }
                    objWeapon.ActiveAmmoSlot = intCurrentSlot;
                    cboWeaponAmmo.BeginUpdate();
                    cboWeaponAmmo.Enabled = true;
                    cboWeaponAmmo.ValueMember = "Value";
                    cboWeaponAmmo.DisplayMember = "Name";
                    cboWeaponAmmo.DataSource = lstAmmo;
                    cboWeaponAmmo.SelectedValue = objWeapon.ActiveAmmoSlot.ToString();
                    if (cboWeaponAmmo.SelectedIndex == -1)
                        cboWeaponAmmo.SelectedIndex = 0;
                    cboWeaponAmmo.EndUpdate();
                }
                else
                {
                    cmdFireWeapon.Enabled = false;
                    cmdReloadWeapon.Enabled = false;
                    cmdWeaponBuyAmmo.Enabled = false;
                    lblWeaponAmmoRemaining.Text = string.Empty;
                    cboWeaponAmmo.Enabled = false;
                }

                // If this is a Cyberweapon, grab the STR of the limb.
                int intUseSTR = 0;
                if (objWeapon.Cyberware)
                {
                    intUseSTR = _objCharacter.Cyberware.DeepFirstOrDefault(x => x.Children, x => x.WeaponID == objWeapon.InternalId)?.TotalStrength ?? 0;
                }

                // Show the Weapon Ranges.
                lblWeaponRangeMain.Text = objWeapon.Range;
                lblWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                lblWeaponRangeShort.Text = dictionaryRanges["short"];
                lblWeaponRangeMedium.Text = dictionaryRanges["medium"];
                lblWeaponRangeLong.Text = dictionaryRanges["long"];
                lblWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                lblWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                lblWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                lblWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                lblWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];

                lblWeaponAvail.Text = objWeapon.TotalAvail;
                lblWeaponCost.Text = objWeapon.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                lblWeaponConceal.Text = objWeapon.CalculatedConcealability(GlobalOptions.CultureInfo);
                lblWeaponDamage.Text = objWeapon.CalculatedDamage(intUseSTR);
                lblWeaponAccuracy.Text = objWeapon.TotalAccuracy.ToString();
                lblWeaponRC.Text = objWeapon.TotalRC;
                lblWeaponAP.Text = objWeapon.TotalAP;
                lblWeaponReach.Text = objWeapon.TotalReach.ToString();
                lblWeaponMode.Text = objWeapon.CalculatedMode;
                lblWeaponAmmo.Text = objWeapon.CalculatedAmmo();
                lblWeaponRating.Text = string.Empty;
                if (GlobalOptions.Language != GlobalOptions.DefaultLanguage)
                {
                    string strSlotsText = string.Empty;
                    foreach (string strMount in objWeapon.AccessoryMounts.Split('/'))
                    {
                        strSlotsText += LanguageManager.GetString("String_Mount" + strMount) + '/';
                    }
                    lblWeaponSlots.Text = strSlotsText.TrimEnd('/');
                }
                else
                    lblWeaponSlots.Text = objWeapon.AccessoryMounts;
                lblWeaponDicePool.Text = objWeapon.GetDicePool(GlobalOptions.CultureInfo);
                tipTooltip.SetToolTip(lblWeaponDicePool, objWeapon.DicePoolTooltip);
                tipTooltip.SetToolTip(lblWeaponRC, objWeapon.RCToolTip);
            }
            else
            {
                // See if this is an Underbarrel Weapon.
                Weapon objWeapon = CommonFunctions.DeepFindById(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);

                if (objWeapon != null)
                {
                    if (objWeapon.Cyberware || objWeapon.Category == "Gear" || objWeapon.Category.StartsWith("Quality") || objWeapon.IncludedInWeapon || !string.IsNullOrEmpty(objWeapon.ParentID))
                        cmdDeleteWeapon.Enabled = false;
                    cmdFireWeapon.Enabled = true;
                    cmdReloadWeapon.Enabled = true;
                    cmdWeaponBuyAmmo.Enabled = true;

                    if (!string.IsNullOrEmpty(objWeapon.ParentID))
                    {
                        cmdDeleteWeapon.Enabled = false;
                        if (string.IsNullOrEmpty(objWeapon.Notes))
                            treWeapons.SelectedNode.ForeColor = SystemColors.GrayText;
                    }

                    // If this is a Cyberweapon, grab the STR of the limb.
                    int intUseSTR = 0;
                    if (objWeapon.Cyberware)
                    {
                        intUseSTR = _objCharacter.Cyberware.DeepFirstOrDefault(x => x.Children, x => x.WeaponID == objWeapon.InternalId)?.TotalStrength ?? 0;
                    }

                    lblWeaponAvail.Text = objWeapon.TotalAvail;
                    lblWeaponCost.Text = objWeapon.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    lblWeaponConceal.Text = objWeapon.CalculatedConcealability(GlobalOptions.CultureInfo);
                    lblWeaponDamage.Text = objWeapon.CalculatedDamage(intUseSTR);
                    lblWeaponRC.Text = objWeapon.TotalRC;
                    lblWeaponAccuracy.Text = objWeapon.TotalAccuracy.ToString();
                    lblWeaponAP.Text = objWeapon.TotalAP;
                    lblWeaponReach.Text = objWeapon.TotalReach.ToString();
                    lblWeaponMode.Text = objWeapon.CalculatedMode;
                    lblWeaponAmmo.Text = objWeapon.CalculatedAmmo();
                    lblWeaponRating.Text = string.Empty;
                    if (GlobalOptions.Language != GlobalOptions.DefaultLanguage)
                    {
                        string strSlotsText = string.Empty;
                        foreach (string strMount in objWeapon.AccessoryMounts.Split('/'))
                        {
                            strSlotsText += LanguageManager.GetString("String_Mount" + strMount) + '/';
                        }
                        lblWeaponSlots.Text = strSlotsText.TrimEnd('/');
                    }
                    else
                        lblWeaponSlots.Text = objWeapon.AccessoryMounts;
                    lblWeaponDicePool.Text = objWeapon.GetDicePool(GlobalOptions.CultureInfo);
                    tipTooltip.SetToolTip(lblWeaponDicePool, objWeapon.DicePoolTooltip);

                    cmsAmmoSingleShot.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeSingleShot")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeSemiAutomatic"));
                    cmsAmmoShortBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeBurstFire")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoLongBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoFullBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                    cmsAmmoSuppressiveFire.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));

                    // Melee Weapons with Ammo are considered to be Single Shot.
                    if (objWeapon.WeaponType == "Melee" && objWeapon.Ammo != "0")
                        cmsAmmoSingleShot.Enabled = true;

                    if (cmsAmmoFullBurst.Enabled)
                        cmsAmmoFullBurst.Text = LanguageManager.GetString("String_FullBurst").Replace("{0}", objWeapon.FullBurst.ToString());
                    if (cmsAmmoSuppressiveFire.Enabled)
                        cmsAmmoSuppressiveFire.Text = LanguageManager.GetString("String_SuppressiveFire").Replace("{0}", objWeapon.Suppressive.ToString());

                    List<ListItem> lstAmmo = new List<ListItem>();
                    int intCurrentSlot = objWeapon.ActiveAmmoSlot;
                    for (int i = 1; i <= objWeapon.AmmoSlots; i++)
                    {
                        ListItem objAmmo = new ListItem();
                        objWeapon.ActiveAmmoSlot = i;
                        Gear objGear = CommonFunctions.DeepFindById(objWeapon.AmmoLoaded, _objCharacter.Gear);
                        objAmmo.Value = i.ToString();

                        string strPlugins = string.Empty;
                        if (objGear != null)
                        {
                            foreach (Gear objChild in objGear.Children)
                            {
                                strPlugins += objChild.DisplayNameShort + ", ";
                            }
                        }
                        // Remove the trailing comma.
                        if (!string.IsNullOrEmpty(strPlugins))
                            strPlugins = strPlugins.Substring(0, strPlugins.Length - 2);

                        if (objGear == null)
                            objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_Empty");
                        else
                            objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + objGear.DisplayNameShort;
                        if (!string.IsNullOrEmpty(strPlugins))
                            objAmmo.Name += " [" + strPlugins + "]";
                        lstAmmo.Add(objAmmo);
                    }
                    chkWeaponAccessoryInstalled.Enabled = true;
                    chkWeaponAccessoryInstalled.Checked = objWeapon.Installed;
                    chkIncludedInWeapon.Enabled = false;
                    chkIncludedInWeapon.Checked = objWeapon.IncludedInWeapon;
                    objWeapon.ActiveAmmoSlot = intCurrentSlot;
                    cboWeaponAmmo.BeginUpdate();
                    cboWeaponAmmo.Enabled = true;
                    cboWeaponAmmo.ValueMember = "Value";
                    cboWeaponAmmo.DisplayMember = "Name";
                    cboWeaponAmmo.DataSource = lstAmmo;
                    cboWeaponAmmo.SelectedValue = objWeapon.ActiveAmmoSlot.ToString();
                    if (cboWeaponAmmo.SelectedIndex == -1)
                        cboWeaponAmmo.SelectedIndex = 0;
                    cboWeaponAmmo.EndUpdate();

                    // Show the Weapon Ranges.
                    lblWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();
                    lblWeaponRangeMain.Text = objWeapon.Range;
                    lblWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                    Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                    lblWeaponRangeShort.Text = dictionaryRanges["short"];
                    lblWeaponRangeMedium.Text = dictionaryRanges["medium"];
                    lblWeaponRangeLong.Text = dictionaryRanges["long"];
                    lblWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                    lblWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                    lblWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                    lblWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                    lblWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];
                }
                else
                {
                    cmdFireWeapon.Enabled = false;
                    cmdReloadWeapon.Enabled = false;
                    cmdWeaponBuyAmmo.Enabled = false;
                    cboWeaponAmmo.Enabled = false;

                    Weapon objSelectedWeapon = null;
                    WeaponAccessory objSelectedAccessory = CommonFunctions.FindWeaponAccessory(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons);
                    if (objSelectedAccessory != null)
                    {
                        if (objSelectedAccessory.IncludedInWeapon)
                            cmdDeleteWeapon.Enabled = false;
                        objSelectedWeapon = objSelectedAccessory.Parent;
                        lblWeaponName.Text = objSelectedAccessory.DisplayNameShort;
                        lblWeaponCategory.Text = LanguageManager.GetString("String_WeaponAccessory");
                        lblWeaponAvail.Text = objSelectedAccessory.TotalAvail;
                        lblWeaponAccuracy.Text = objSelectedWeapon.TotalAccuracy.ToString();
                        lblWeaponCost.Text = objSelectedAccessory.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblWeaponConceal.Text = objSelectedAccessory.Concealability.ToString();
                        lblWeaponDamage.Text = string.Empty;
                        lblWeaponRC.Text = objSelectedAccessory.RC;
                        lblWeaponAP.Text = string.Empty;
                        lblWeaponReach.Text = string.Empty;
                        lblWeaponMode.Text = string.Empty;
                        lblWeaponAmmo.Text = string.Empty;
                        lblWeaponRating.Text = objSelectedAccessory.Rating.ToString();

                        string[] strMounts = objSelectedAccessory.Mount.Split('/');
                        string strMount = string.Empty;
                        foreach (string strCurrentMount in strMounts)
                        {
                            if (!string.IsNullOrEmpty(strCurrentMount))
                                strMount += LanguageManager.GetString("String_Mount" + strCurrentMount) + "/";
                        }
                        // Remove the trailing /
                        if (!string.IsNullOrEmpty(strMount) && strMount.Contains('/'))
                            strMount = strMount.Substring(0, strMount.Length - 1);
                        if (!string.IsNullOrEmpty(objSelectedAccessory.ExtraMount) && (objSelectedAccessory.ExtraMount != "None"))
                        {
                            bool boolHaveAddedItem = false;
                            string[] strExtraMounts = objSelectedAccessory.ExtraMount.Split('/');
                            foreach (string strCurrentExtraMount in strExtraMounts)
                            {
                                if (!string.IsNullOrEmpty(strCurrentExtraMount))
                                {
                                    if (!boolHaveAddedItem)
                                    {
                                        strMount += " + ";
                                        boolHaveAddedItem = true;
                                    }
                                    strMount += LanguageManager.GetString("String_Mount" + strCurrentExtraMount) + "/";
                                }
                            }
                            // Remove the trailing /
                            if (boolHaveAddedItem)
                                strMount = strMount.Substring(0, strMount.Length - 1);
                        }

                        lblWeaponSlots.Text = strMount;
                        string strBook = _objOptions.LanguageBookShort(objSelectedAccessory.Source);
                        string strPage = objSelectedAccessory.Page;
                        lblWeaponSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblWeaponSource, _objOptions.LanguageBookLong(objSelectedAccessory.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSelectedAccessory.Page);
                        chkWeaponAccessoryInstalled.Enabled = true;
                        chkWeaponAccessoryInstalled.Checked = objSelectedAccessory.Installed;
                        chkIncludedInWeapon.Enabled = _objOptions.AllowEditPartOfBaseWeapon;
                        chkIncludedInWeapon.Checked = objSelectedAccessory.IncludedInWeapon;
                    }
                    else
                    {
                        // Find the selected Gear.
                        Gear objGear = CommonFunctions.FindWeaponGear(treWeapons.SelectedNode.Tag.ToString(), _objCharacter.Weapons, out objSelectedAccessory);
                        if (objGear != null)
                        {
                            objSelectedWeapon = objSelectedAccessory.Parent;
                            if (objGear.IncludedInParent)
                                cmdDeleteWeapon.Enabled = false;
                            lblWeaponName.Text = objGear.DisplayNameShort;
                            lblWeaponCategory.Text = objGear.DisplayCategory;
                            lblWeaponAvail.Text = objGear.TotalAvail(true);
                            lblWeaponCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                            lblWeaponAccuracy.Text = objSelectedWeapon.TotalAccuracy.ToString();
                            lblWeaponConceal.Text = string.Empty;
                            lblWeaponDamage.Text = string.Empty;
                            lblWeaponRC.Text = string.Empty;
                            lblWeaponAP.Text = string.Empty;
                            lblWeaponReach.Text = string.Empty;
                            lblWeaponMode.Text = string.Empty;
                            lblWeaponAmmo.Text = string.Empty;
                            lblWeaponRating.Text = string.Empty;
                            lblWeaponSlots.Text = string.Empty;
                            string strBook = _objOptions.LanguageBookShort(objGear.Source);
                            string strPage = objGear.Page;
                            lblWeaponSource.Text = strBook + " " + strPage;
                            tipTooltip.SetToolTip(lblWeaponSource, _objOptions.BookFromCode(objGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objGear.Page);
                            chkWeaponAccessoryInstalled.Enabled = true;
                            chkWeaponAccessoryInstalled.Checked = objGear.Equipped;
                            chkIncludedInWeapon.Enabled = false;
                            chkIncludedInWeapon.Checked = false;

                            if (objGear.GetType() == typeof(Commlink))
                            {
                                Commlink objCommlink = (Commlink)objGear;

                                objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
                                lblWeaponDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();
                                lblWeaponAttackLabel.Visible = true;
                                lblWeaponSleazeLabel.Visible = true;
                                lblWeaponDataProcessingLabel.Visible = true;
                                lblWeaponFirewallLabel.Visible = true;
                            }
                            else
                            {
                                cboCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                                lblCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                                lblWeaponAttackLabel.Visible = false;
                                cboWeaponGearAttack.Visible = false;
                                lblWeaponDataProcessingLabel.Visible = false;
                                cboWeaponGearDataProcessing.Visible = false;
                                lblWeaponFirewallLabel.Visible = false;
                                cboWeaponGearFirewall.Visible = false;
                                lblWeaponSleazeLabel.Visible = false;
                                cboWeaponGearSleaze.Visible = false;
                            }
                        }
                    }

                    // Show the Weapon Ranges.
                    if (objSelectedWeapon != null)
                    {
                        lblWeaponRangeMain.Text = objSelectedWeapon.Range;
                        lblWeaponRangeAlternate.Text = objSelectedWeapon.AlternateRange;
                        Dictionary<string, string> dictionaryRanges = objSelectedWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                        lblWeaponRangeShort.Text = dictionaryRanges["short"];
                        lblWeaponRangeMedium.Text = dictionaryRanges["medium"];
                        lblWeaponRangeLong.Text = dictionaryRanges["long"];
                        lblWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                        lblWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                        lblWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                        lblWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                        lblWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];
                    }
                }
            }
            _blnSkipRefresh = false;
        }

        /// <summary>
        /// Refresh the information for the currently displayed Armor.
        /// </summary>
        public void RefreshSelectedArmor()
        {
            _blnSkipRefresh = true;
            lblArmorDeviceRating.Text = string.Empty;
            lblArmorAttack.Text = string.Empty;
            lblArmorSleaze.Text = string.Empty;
            lblArmorDataProcessing.Text = string.Empty;
            lblArmorFirewall.Text = string.Empty;
            cmdDeleteArmor.Enabled = treArmor.SelectedNode != null;
            chkArmorEquipped.Enabled = false;

            if (treArmor.SelectedNode.Level == 0)
            {
                lblArmorEquipped.Text = string.Empty;
                foreach (Armor objArmor in _objCharacter.Armor)
                {
                    if (objArmor.Equipped && (objArmor.Location == treArmor.SelectedNode.Text || string.IsNullOrEmpty(objArmor.Location) && treArmor.SelectedNode == treArmor.Nodes[0]))
                        lblArmorEquipped.Text += objArmor.DisplayName + " (" + objArmor.TotalArmor.ToString() +  ")\n";
                }
                if (string.IsNullOrEmpty(lblArmorEquipped.Text))
                    lblArmorEquipped.Text = LanguageManager.GetString("String_None");
                
                lblArmorEquipped.Visible = true;

                chkIncludedInArmor.Enabled = false;
                chkIncludedInArmor.Checked = false;
            }
            else
                lblArmorEquipped.Visible = false;

            if (treArmor.SelectedNode.Level == 1)
            {
                // Loclate the selected Armor
                Armor objArmor = CommonFunctions.FindByIdWithNameCheck(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                if (objArmor == null)
                    return;

                lblArmorValue.Text = objArmor.TotalArmor.ToString();
                lblArmorAvail.Text = objArmor.TotalAvail;
                lblArmorCapacity.Text = objArmor.CalculatedCapacity + " (" + objArmor.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                lblArmorRating.Text = string.Empty;
                lblArmorCost.Text = objArmor.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                string strBook = _objOptions.LanguageBookShort(objArmor.Source);
                string strPage = objArmor.Page;
                lblArmorSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblArmorSource, _objOptions.LanguageBookLong(objArmor.Source) + " " + LanguageManager.GetString("String_Page") + " " + objArmor.Page);
                chkArmorEquipped.Checked = objArmor.Equipped;
                chkArmorEquipped.Enabled = true;
                chkIncludedInArmor.Enabled = false;
                chkIncludedInArmor.Checked = false;
            }
            else if (treArmor.SelectedNode.Level == 2)
            {
                Armor objSelectedArmor = null;
                ArmorMod objSelectedMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
                if (objSelectedMod != null)
                {
                    objSelectedArmor = objSelectedMod.Parent;
                    if (objSelectedMod.IncludedInArmor)
                        cmdDeleteArmor.Enabled = false;
                    lblArmorValue.Text = objSelectedMod.Armor.ToString();
                    lblArmorAvail.Text = objSelectedMod.TotalAvail;
                    if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.Standard)
                        lblArmorCapacity.Text = objSelectedMod.CalculatedCapacity;
                    else if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.Zero)
                        lblArmorCapacity.Text = "[0]";
                    else if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.PerRating)
                    {
                        if (objSelectedMod.Rating > 0)
                            lblArmorCapacity.Text = "[" + objSelectedMod.Rating.ToString() + "]";
                        else
                            lblArmorCapacity.Text = "[1]";
                    }
                    if (!string.IsNullOrEmpty(objSelectedMod.GearCapacity))
                        lblArmorCapacity.Text = objSelectedMod.GearCapacity + "/" + lblArmorCapacity.Text + " (" + objSelectedMod.GearCapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                    lblArmorCost.Text = objSelectedMod.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';

                    string strBook = _objOptions.LanguageBookShort(objSelectedMod.Source);
                    string strPage = objSelectedMod.Page;
                    lblArmorSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblArmorSource, _objOptions.LanguageBookLong(objSelectedMod.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSelectedMod.Page);
                    chkArmorEquipped.Checked = objSelectedMod.Equipped;
                    chkArmorEquipped.Enabled = true;
                    lblArmorRating.Text = objSelectedMod.Rating.ToString();
                    chkIncludedInArmor.Enabled = true;
                    chkIncludedInArmor.Checked = objSelectedMod.IncludedInArmor;
                }
                else
                {
                    Gear objSelectedGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor, out objSelectedArmor, out objSelectedMod);

                    if (objSelectedGear.IncludedInParent)
                        cmdDeleteArmor.Enabled = false;
                    lblArmorValue.Text = string.Empty;
                    lblArmorAvail.Text = objSelectedGear.TotalAvail(true);
                    if (objSelectedMod != null)
                    {
                        lblArmorCapacity.Text = objSelectedGear.CalculatedCapacity;
                    }
                    else
                    {
                        if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.Standard)
                            lblArmorCapacity.Text = objSelectedGear.CalculatedArmorCapacity;
                        else if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.Zero)
                            lblArmorCapacity.Text = "[0]";
                        else if (objSelectedArmor.CapacityDisplayStyle == CapacityStyle.PerRating)
                        {
                            if (objSelectedGear.Rating > 0)
                                lblArmorCapacity.Text = "[" + objSelectedGear.Rating.ToString() + "]";
                            else
                                lblArmorCapacity.Text = "[1]";
                        }
                    }
                    lblArmorCost.Text = objSelectedGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    string strBook = _objOptions.LanguageBookShort(objSelectedGear.Source);
                    string strPage = objSelectedGear.Page;
                    lblArmorSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblArmorSource, _objOptions.LanguageBookLong(objSelectedGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSelectedGear.Page);
                    chkArmorEquipped.Checked = objSelectedGear.Equipped;
                    chkArmorEquipped.Enabled = true;
                    lblArmorRating.Text = objSelectedGear.Rating.ToString();

                    if (objSelectedGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink)objSelectedGear;
                        lblArmorDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();
                        lblArmorAttack.Text = objCommlink.GetTotalMatrixAttribute("Attack").ToString();
                        lblArmorSleaze.Text = objCommlink.GetTotalMatrixAttribute("Sleaze").ToString();
                        lblArmorDataProcessing.Text = objCommlink.GetTotalMatrixAttribute("Data Processing").ToString();
                        lblArmorFirewall.Text = objCommlink.GetTotalMatrixAttribute("Firewall").ToString();
                    }
                }
            }
            else if (treArmor.SelectedNode.Level > 2)
            {
                Gear objSelectedGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);

                if (objSelectedGear.IncludedInParent)
                    cmdDeleteArmor.Enabled = false;
                lblArmorValue.Text = string.Empty;
                lblArmorAvail.Text = objSelectedGear.TotalAvail(true);
                lblArmorCapacity.Text = objSelectedGear.CalculatedArmorCapacity;
                lblArmorCost.Text = objSelectedGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                string strBook = _objOptions.LanguageBookShort(objSelectedGear.Source);
                string strPage = objSelectedGear.Page;
                lblArmorSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblArmorSource, _objOptions.LanguageBookLong(objSelectedGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objSelectedGear.Page);
                chkArmorEquipped.Checked = objSelectedGear.Equipped;
                chkArmorEquipped.Enabled = true;
                lblArmorRating.Text = objSelectedGear.Rating.ToString();

                if (objSelectedGear.GetType() == typeof(Commlink))
                {
                    Commlink objCommlink = (Commlink)objSelectedGear;
                    lblArmorDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();
                    lblArmorAttack.Text = objCommlink.GetTotalMatrixAttribute("Attack").ToString();
                    lblArmorSleaze.Text = objCommlink.GetTotalMatrixAttribute("Sleaze").ToString();
                    lblArmorDataProcessing.Text = objCommlink.GetTotalMatrixAttribute("Data Processing").ToString();
                    lblArmorFirewall.Text = objCommlink.GetTotalMatrixAttribute("Firewall").ToString();
                }
            }
            else
            {
                lblArmorValue.Text = string.Empty;
                lblArmorAvail.Text = string.Empty;
                lblArmorCost.Text = string.Empty;
                lblArmorSource.Text = string.Empty;
                tipTooltip.SetToolTip(lblArmorSource, null);
                lblArmorRating.Text = string.Empty;
                chkArmorEquipped.Enabled = false;
            }
            _blnSkipRefresh = false;
        }

        /// <summary>
        /// Refresh the information for the currently displayed Gear.
        /// </summary>
        public void RefreshSelectedGear()
        {
            _blnSkipRefresh = true;
            cmdDeleteGear.Enabled = treGear.SelectedNode != null;
            if (treGear.SelectedNode == null || treGear.SelectedNode.Level == 0)
            {
                lblGearRating.Text = string.Empty;
                lblGearQty.Text = string.Empty;
                cmdGearIncreaseQty.Enabled = false;
                cmdGearReduceQty.Enabled = false;
                chkGearEquipped.Text = LanguageManager.GetString("Checkbox_Equipped");
                chkGearEquipped.Visible = false;
                chkActiveCommlink.Visible = false;
                cmdGearSplitQty.Enabled = false;
                cmdGearMergeQty.Enabled = false;
                cmdGearMoveToVehicle.Enabled = false;
                tabGearMatrixCM.Visible = false;
                return;
            }
            chkGearHomeNode.Visible = false;

            if (treGear.SelectedNode.Level > 0)
            {
                Gear objGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);

                if (objGear != null)
                {
                    if (objGear.IncludedInParent)
                        cmdDeleteGear.Enabled = false;
                    lblGearName.Text = objGear.DisplayNameShort;
                    lblGearCategory.Text = objGear.DisplayCategory;
                    lblGearAvail.Text = objGear.TotalAvail(true);
                    try
                    {
                        lblGearCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    }
                    catch (FormatException)
                    {
                        lblGearCost.Text = objGear.Cost + "¥";
                    }
                    lblGearCapacity.Text = objGear.CalculatedCapacity + " (" + objGear.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                    string strBook = _objOptions.LanguageBookShort(objGear.Source);
                    string strPage = objGear.Page;
                    lblGearSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblGearSource, _objOptions.LanguageBookLong(objGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objGear.Page);
                    
                    if (objGear.GetTotalMatrixAttribute("Device Rating") > 0)
                    {
                        tabGearMatrixCM.Visible = true;
                        foreach (CheckBox objMatrixCM in tabMatrixCM.Controls.OfType<CheckBox>())
                        {
                            if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objGear.MatrixCM)
                            {
                                if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objGear.MatrixCMFilled)
                                    objMatrixCM.Checked = true;
                                else
                                    objMatrixCM.Checked = false;

                                objMatrixCM.Visible = true;
                            }
                            else
                            {
                                objMatrixCM.Checked = false;
                                objMatrixCM.Visible = false;
                                objMatrixCM.Text = string.Empty;
                            }
                        }
                    }
                    else
                    {
                        tabGearMatrixCM.Visible = false;
                    }

                    cboGearOverclocker.BeginUpdate();
                    if (objGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink)objGear;
                        lblGearDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();
                        chkActiveCommlink.Checked = objCommlink.IsActive;

                        cboGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblGearOverclocker.Visible = _objCharacter.Overclocker;
                        ArrayList lstOverclocker = new ArrayList();
                        ListItem objAttribute = new ListItem();
                        objAttribute.Value = "None";
                        objAttribute.Name = LanguageManager.GetString("String_None");
                        lstOverclocker.Add(objAttribute);
                        if (_objCharacter.Overclocker)
                        {
                            objAttribute = new ListItem();
                            objAttribute.Value = "Attack";
                            objAttribute.Name = LanguageManager.GetString("String_Attack");
                            lstOverclocker.Add(objAttribute);
                            objAttribute = new ListItem();
                            objAttribute.Value = "Sleaze";
                            objAttribute.Name = LanguageManager.GetString("String_Sleaze");
                            lstOverclocker.Add(objAttribute);
                            objAttribute = new ListItem();
                            objAttribute.Value = "DataProc";
                            objAttribute.Name = LanguageManager.GetString("String_DataProcessing");
                            lstOverclocker.Add(objAttribute);
                            objAttribute = new ListItem();
                            objAttribute.Value = "Firewall";
                            objAttribute.Name = LanguageManager.GetString("String_Firewall");
                        }
                        lstOverclocker.Add(objAttribute);
                        cboGearOverclocker.BindingContext = new BindingContext();
                        cboGearOverclocker.DisplayMember = "Name";
                        cboGearOverclocker.ValueMember = "Value";
                        cboGearOverclocker.DataSource = lstOverclocker;
                        cboGearOverclocker.SelectedIndex = 0;

                        objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);

                        lblGearDeviceRating.Text = objCommlink.GetTotalMatrixAttribute("Device Rating").ToString();

                        cboCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblGearDeviceRating.Visible = true;
                        lblGearDeviceRatingLabel.Visible = true;
                        lblGearAttackLabel.Visible = true;
                        lblGearSleazeLabel.Visible = true;
                        lblGearDataProcessingLabel.Visible = true;
                        lblGearFirewallLabel.Visible = true;
                        if (objCommlink.Category != "Commlink Upgrade")
                            chkActiveCommlink.Visible = true;
                        if (_objCharacter.Metatype == "A.I.")
                        {
                            chkGearHomeNode.Visible = true;
                            chkGearHomeNode.Checked = objCommlink.HomeNode;
                        }
                    }
                    else
                    {
                        cboCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblCyberwareGearOverclocker.Visible = _objCharacter.Overclocker;
                        lblGearDeviceRating.Text = objGear.GetTotalMatrixAttribute("Device Rating").ToString();
                        chkActiveCommlink.Visible = false;
                        cboGearAttack.Visible = false;
                        cboGearSleaze.Visible = false;
                        cboGearDataProcessing.Visible = false;
                        cboGearFirewall.Visible = false;
                        lblGearAttackLabel.Visible = false;
                        lblGearSleazeLabel.Visible = false;
                        lblGearDataProcessingLabel.Visible = false;
                        lblGearFirewallLabel.Visible = false;
                    }
                    cboGearOverclocker.EndUpdate();

                    if (objGear.MaxRating > 0)
                    {
                        lblGearRating.Text = objGear.Rating.ToString();
                    }
                    else
                    {
                        lblGearRating.Text = string.Empty;
                    }

                    lblGearQty.Text = objGear.Quantity.ToString();

                    if (treGear.SelectedNode.Level == 1)
                    {
                        lblGearQty.Text = objGear.Quantity.ToString();
                        chkGearEquipped.Visible = true;
                        chkGearEquipped.Checked = objGear.Equipped;
                    }
                    else
                    {
                        lblGearQty.Text = "1";
                        chkGearEquipped.Visible = true;
                        chkGearEquipped.Checked = objGear.Equipped;

                        // If this is a Program, determine if its parent Gear (if any) is a Commlink. If so, show the Equipped checkbox.
                        if (objGear.IsProgram && _objOptions.CalculateCommlinkResponse)
                        {
                            Gear objParent = objGear?.Parent;
                            if (!string.IsNullOrEmpty(objParent.Category))
                            {
                                if (objParent.Category == "Commlink" || objParent.Category == "Nexus")
                                    chkGearEquipped.Text = LanguageManager.GetString("Checkbox_SoftwareRunning");
                            }
                        }
                    }

                    // Show the Weapon Bonus information if it's available.
                    if (objGear.WeaponBonus != null)
                    {
                        lblGearDamageLabel.Visible = true;
                        lblGearDamage.Visible = true;
                        lblGearAPLabel.Visible = true;
                        lblGearAP.Visible = true;
                        lblGearDamage.Text = objGear.WeaponBonusDamage();
                        lblGearAP.Text = objGear.WeaponBonusAP;
                    }
                    else
                    {
                        lblGearDamageLabel.Visible = false;
                        lblGearDamage.Visible = false;
                        lblGearAPLabel.Visible = false;
                        lblGearAP.Visible = false;
                    }

                    cmdGearIncreaseQty.Enabled = !objGear.DisableQuantity;
                    cmdGearReduceQty.Enabled = !objGear.DisableQuantity;

                    treGear.SelectedNode.Text = objGear.DisplayName;
                }

                // Enable or disable the Split/Merge buttons as needed.
                if (treGear.SelectedNode.Level == 1)
                {
                    cmdGearSplitQty.Enabled = !objGear.DisableQuantity;
                    cmdGearMergeQty.Enabled = !objGear.DisableQuantity;
                    if (_objCharacter.Vehicles.Count > 0)
                        cmdGearMoveToVehicle.Enabled = !objGear.DisableQuantity;
                    else
                        cmdGearMoveToVehicle.Enabled = false;
                }
                else
                {
                    cmdGearSplitQty.Enabled = false;
                    cmdGearMergeQty.Enabled = false;
                    cmdGearMoveToVehicle.Enabled = false;
                }
            }
            _blnSkipRefresh = false;
        }

        /// <summary>
        /// Update the Window title to show the Character's name and unsaved changes status.
        /// </summary>
        private void UpdateWindowTitle(bool blnCanSkip = true)
        {
            if (Text.EndsWith('*') && blnCanSkip)
                return;

            Text = string.Empty;
            if (!string.IsNullOrEmpty(txtAlias.Text))
                Text += txtAlias.Text + " - ";
            Text += LanguageManager.GetString("Title_CareerMode");
            Text += " (" + _objCharacter.Options.Name + ")";
            if (_blnIsDirty)
                Text += "*";
        }

        /// <summary>
        /// Save the Character.
        /// </summary>
        private bool SaveCharacter()
        {
            // If the Character does not have a file name, trigger the Save As menu item instead.
            if (string.IsNullOrEmpty(_objCharacter.FileName))
                return SaveCharacterAs();

            Cursor = Cursors.WaitCursor;
            if (_objCharacter.Save())
            {
                _blnIsDirty = false;
                GlobalOptions.AddToMRUList(_objCharacter.FileName);
                UpdateWindowTitle(false);
                Cursor = Cursors.Default;
                return true;
            }
            Cursor = Cursors.Default;
            return false;
        }

        /// <summary>
        /// Save the Character using the Save As dialogue box.
        /// </summary>
        private bool SaveCharacterAs()
        {
            SaveFileDialog saveFileDialog = new SaveFileDialog();
            saveFileDialog.Filter = "Chummer5 Files (*.chum5)|*.chum5|All Files (*.*)|*.*";

            string strShowFileName = Path.GetFileName(_objCharacter.FileName);

            if (string.IsNullOrEmpty(strShowFileName))
                strShowFileName = _objCharacter.Alias;

            saveFileDialog.FileName = strShowFileName;

            if (saveFileDialog.ShowDialog(this) == DialogResult.OK)
            {
                _objCharacter.FileName = saveFileDialog.FileName;
                return SaveCharacter();
            }

            return false;
        }

        /// <summary>
        /// Open the Select Cyberware window and handle adding to the Tree and Character.
        /// </summary>
        private bool PickCyberware(Improvement.ImprovementSource objSource = Improvement.ImprovementSource.Cyberware)
        {
            // Determine the lowest whole number for the character's current Essence.
            decimal decStartingESS = decimal.Floor(_objCharacter.Essence);

            Cyberware objSelectedCyberware = null;
            int intNode = 0;
            if (objSource == Improvement.ImprovementSource.Bioware)
                intNode = 1;

            // Attempt to locate the selected piece of Cyberware.
            if (treCyberware.SelectedNode != null && treCyberware.SelectedNode.Level > 0)
                objSelectedCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);

            frmSelectCyberware frmPickCyberware = new frmSelectCyberware(_objCharacter, objSource, true, objSelectedCyberware?.MyXmlNode);
            decimal decMultiplier = 1.0m;
            // Apply the character's Cyberware Essence cost multiplier if applicable.
            if (objSource == Improvement.ImprovementSource.Cyberware)
            {
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CyberwareEssCost) != 0)
                {
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.CyberwareEssCost && objImprovement.Enabled)
                            decMultiplier -= (1 - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                    }
                    frmPickCyberware.CharacterESSMultiplier *= decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CyberwareTotalEssMultiplier) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.CyberwareTotalEssMultiplier && objImprovement.Enabled)
                            decMultiplier *= (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m);
                    }
                    frmPickCyberware.CharacterTotalESSMultiplier *= decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CyberwareEssCostNonRetroactive) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.CyberwareEssCostNonRetroactive && objImprovement.Enabled)
                            decMultiplier -= (1 - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                    }
                    frmPickCyberware.CharacterESSMultiplier *= decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.CyberwareTotalEssMultiplierNonRetroactive) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.CyberwareTotalEssMultiplierNonRetroactive && objImprovement.Enabled)
                            decMultiplier *= (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m);
                    }
                    frmPickCyberware.CharacterTotalESSMultiplier *= decMultiplier;
                }
            }
            // Apply the character's Bioware Essence cost multiplier if applicable.
            else if (objSource == Improvement.ImprovementSource.Bioware)
            {
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.BiowareEssCost) != 0)
                {
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.BiowareEssCost && objImprovement.Enabled)
                            decMultiplier -= (1.0m - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                    }
                    frmPickCyberware.CharacterESSMultiplier = decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.BiowareTotalEssMultiplier) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.BiowareTotalEssMultiplier && objImprovement.Enabled)
                            decMultiplier *= (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m);
                    }
                    frmPickCyberware.CharacterTotalESSMultiplier *= decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.BiowareEssCostNonRetroactive) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.BiowareEssCostNonRetroactive && objImprovement.Enabled)
                            decMultiplier -= (1 - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100));
                    }
                    frmPickCyberware.CharacterESSMultiplier = decMultiplier;
                }
                if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.BiowareTotalEssMultiplierNonRetroactive) != 0)
                {
                    decMultiplier = 1.0m;
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.BiowareTotalEssMultiplierNonRetroactive && objImprovement.Enabled)
                            decMultiplier *= (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m);
                    }
                    frmPickCyberware.CharacterTotalESSMultiplier *= decMultiplier;
                }
            }

            // Apply the character's Basic Bioware Essence cost multiplier if applicable.
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.BasicBiowareEssCost) != 0 && objSource == Improvement.ImprovementSource.Bioware)
            {
                decMultiplier = 1.0m;
                foreach (Improvement objImprovement in _objCharacter.Improvements)
                {
                    if (objImprovement.ImproveType == Improvement.ImprovementType.BasicBiowareEssCost && objImprovement.Enabled)
                        decMultiplier -= (1.0m - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                }
                frmPickCyberware.BasicBiowareESSMultiplier = decMultiplier;
            }

            // Genetech Cost multiplier.
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.GenetechCostMultiplier) != 0 && objSource == Improvement.ImprovementSource.Bioware)
            {
                decMultiplier = 1.0m;
                foreach (Improvement objImprovement in _objCharacter.Improvements)
                {
                    if (objImprovement.ImproveType == Improvement.ImprovementType.GenetechCostMultiplier && objImprovement.Enabled)
                        decMultiplier -= (1.0m - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                }
                frmPickCyberware.GenetechCostMultiplier = decMultiplier;
            }

            // Transgenics Cost multiplier.
            if (ImprovementManager.ValueOf(_objCharacter, Improvement.ImprovementType.TransgenicsBiowareCost) != 0 && objSource == Improvement.ImprovementSource.Bioware)
            {
                decMultiplier = 1.0m;
                foreach (Improvement objImprovement in _objCharacter.Improvements)
                {
                    if (objImprovement.ImproveType == Improvement.ImprovementType.TransgenicsBiowareCost && objImprovement.Enabled)
                        decMultiplier -= (1.0m - (Convert.ToDecimal(objImprovement.Value, GlobalOptions.InvariantCultureInfo) / 100.0m));
                }
                frmPickCyberware.TransgenicsBiowareCostMultiplier = decMultiplier;
            }

            if (objSelectedCyberware != null)
            {
                if (treCyberware.SelectedNode.Level > 0)
                {
                    frmPickCyberware.SetGrade = lblCyberwareGrade.Text;
                    frmPickCyberware.LockGrade();
                    // If the Cyberware has a Capacity with no brackets (meaning it grants Capacity), show only Subsystems (those that conume Capacity).
                    if (!objSelectedCyberware.Capacity.Contains('['))
                    {
                        frmPickCyberware.Subsystems = objSelectedCyberware.AllowedSubsystems;
                        frmPickCyberware.MaximumCapacity = objSelectedCyberware.CapacityRemaining;

                        // Do not allow the user to add a new piece of Cyberware if its Capacity has been reached.
                        if (_objOptions.EnforceCapacity && objSelectedCyberware.CapacityRemaining < 0)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return false;
                        }
                    }
                }

                frmPickCyberware.CyberwareParent = objSelectedCyberware;
                frmPickCyberware.Subsystems = objSelectedCyberware.AllowedSubsystems;

                HashSet<string> setDisallowedMounts = new HashSet<string>();
                HashSet<string> setHasMounts = new HashSet<string>();
                string[] strLoopDisallowedMounts = objSelectedCyberware.BlocksMounts.Split(',');
                foreach (string strLoop in strLoopDisallowedMounts)
                    setDisallowedMounts.Add(strLoop + objSelectedCyberware.Location);
                string strLoopHasModularMount = objSelectedCyberware.HasModularMount;
                if (!string.IsNullOrEmpty(strLoopHasModularMount))
                    setHasMounts.Add(strLoopHasModularMount);
                foreach (Cyberware objLoopCyberware in objSelectedCyberware.Children.DeepWhere(x => x.Children, x => string.IsNullOrEmpty(x.PlugsIntoModularMount)))
                {
                    strLoopDisallowedMounts = objLoopCyberware.BlocksMounts.Split(',');
                    foreach (string strLoop in strLoopDisallowedMounts)
                        if (!setDisallowedMounts.Contains(strLoop + objLoopCyberware.Location))
                            setDisallowedMounts.Add(strLoop + objLoopCyberware.Location);
                    strLoopHasModularMount = objLoopCyberware.HasModularMount;
                    if (!string.IsNullOrEmpty(strLoopHasModularMount))
                        if (!setHasMounts.Contains(strLoopHasModularMount))
                            setHasMounts.Add(strLoopHasModularMount);
                }
                string strDisallowedMounts = string.Empty;
                foreach (string strLoop in setDisallowedMounts)
                    if (!strLoop.EndsWith("Right") && (!strLoop.EndsWith("Left") || setDisallowedMounts.Contains(strLoop.Substring(0, strLoop.Length - 4) + "Right")))
                        strDisallowedMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strDisallowedMounts))
                    strDisallowedMounts = strDisallowedMounts.Substring(0, strDisallowedMounts.Length - 1);
                frmPickCyberware.DisallowedMounts = strDisallowedMounts;
                string strHasMounts = string.Empty;
                foreach (string strLoop in setHasMounts)
                    strHasMounts += strLoop + ",";
                // Remove trailing ","
                if (!string.IsNullOrEmpty(strHasMounts))
                    strHasMounts = strHasMounts.Substring(0, strHasMounts.Length - 1);
                frmPickCyberware.HasModularMounts = strHasMounts;
            }

            frmPickCyberware.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickCyberware.DialogResult == DialogResult.Cancel)
                return false;

            // Open the Cyberware XML file and locate the selected piece.
            XmlDocument objXmlDocument = null;
            if (objSource == Improvement.ImprovementSource.Bioware)
                objXmlDocument = XmlManager.Load("bioware.xml");
            else
                objXmlDocument = XmlManager.Load("cyberware.xml");

            XmlNode objXmlCyberware = null;
            if (objSource == Improvement.ImprovementSource.Bioware)
                objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/biowares/bioware[name = \"" + frmPickCyberware.SelectedCyberware + "\"]");
            else
                objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/cyberwares/cyberware[name = \"" + frmPickCyberware.SelectedCyberware + "\"]");

            // Create the Cyberware object.
            Cyberware objCyberware = new Cyberware(_objCharacter);
            List<Weapon> objWeapons = new List<Weapon>();
            TreeNode objNode = new TreeNode();
            objNode.ContextMenuStrip = cmsCyberware;
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            List<Vehicle> objVehicles = new List<Vehicle>();
            List<TreeNode> objVehicleNodes = new List<TreeNode>();
            objCyberware.Create(objXmlCyberware, _objCharacter, frmPickCyberware.SelectedGrade, objSource, frmPickCyberware.SelectedRating, objNode, objWeapons, objWeaponNodes, objVehicles, objVehicleNodes, true, true, string.Empty, objSelectedCyberware);
            if (objCyberware.InternalId == Guid.Empty.ToString())
                return false;


            // Adjust for Black Market Pipeline Discount
            objCyberware.DiscountCost = frmPickCyberware.BlackMarketDiscount;

            // Force the item to be Transgenic if selected.
            if (frmPickCyberware.ForceTransgenic)
                objCyberware.Category = "Genetech: Transgenics";

            // Apply the ESS discount if applicable.
            if (_objOptions.AllowCyberwareESSDiscounts)
                objCyberware.ESSDiscount = frmPickCyberware.SelectedESSDiscount;

            decimal decCost = objCyberware.TotalCost;

            // Multiply the cost if applicable.
            if (objCyberware.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objCyberware.TotalAvail.EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickCyberware.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove any Improvements created by the Cyberware.
                    ImprovementManager.RemoveImprovements(_objCharacter, objCyberware.SourceType, objCyberware.InternalId);
                    return frmPickCyberware.AddAgain;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    string strEntry = string.Empty;
                    if (objCyberware.SourceType == Improvement.ImprovementSource.Cyberware)
                        strEntry = LanguageManager.GetString("String_ExpensePurchaseCyberware");
                    else
                        strEntry = LanguageManager.GetString("String_ExpensePurchaseBioware");
                    objExpense.Create(decCost * -1, strEntry + " " + objCyberware.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    ExpenseUndo objUndo = new ExpenseUndo();
                    objUndo.CreateNuyen(NuyenExpenseType.AddCyberware, objCyberware.InternalId);
                    objExpense.Undo = objUndo;
                }
            }

            DecreaseEssenceHole((int)(objCyberware.CalculatedESS() * 100));

            if (treCyberware.SelectedNode != null && treCyberware.SelectedNode.Level > 0)
                {
                    treCyberware.SelectedNode.Nodes.Add(objNode);
                    treCyberware.SelectedNode.Expand();
                    objSelectedCyberware.Children.Add(objCyberware);
                }
                else
                {
                    treCyberware.Nodes[intNode].Nodes.Add(objNode);
                    treCyberware.Nodes[intNode].Expand();
                    _objCharacter.Cyberware.Add(objCyberware);
                }

            foreach (Weapon objWeapon in objWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            // Create the Weapon Node if one exists.
            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            foreach (Vehicle objVehicle in objVehicles)
                _objCharacter.Vehicles.Add(objVehicle);

            // Create the Vehicle Node if one exists.
            foreach (TreeNode objVehicleNode in objVehicleNodes)
            {
                objVehicleNode.ContextMenuStrip = cmsVehicle;
                treVehicles.Nodes[0].Nodes.Add(objVehicleNode);
                treVehicles.Nodes[0].Expand();
            }
            if (frmPickCyberware.DialogResult != DialogResult.Cancel)
            {
                treCyberware.SortCustom();
                treCyberware.SelectedNode = objNode;
                ScheduleCharacterUpdate();
                RefreshSelectedCyberware();
                PopulateGearList();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }

            return frmPickCyberware.AddAgain;
        }

        /// <summary>
        /// Select a piece of Gear to be added to the character.
        /// </summary>
        /// <param name="blnAmmoOnly">Whether or not only Ammunition should be shown in the window.</param>
        /// <param name="objStackGear">Whether or not the selected item should stack with a matching item on the character.</param>
        /// <param name="strForceItemValue">Force the user to select an item with the passed name..</param>
        private bool PickGear(bool blnAmmoOnly = false, Gear objStackGear = null, string strForceItemValue = "")
        {
            bool blnNullParent = false;
            Gear objSelectedGear = null;
            if (treGear.SelectedNode != null)
                objSelectedGear = CommonFunctions.DeepFindById(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            if (objSelectedGear == null)
            {
                objSelectedGear = new Gear(_objCharacter);
                blnNullParent = true;
            }

            ExpenseUndo objUndo = new ExpenseUndo();

            // Open the Gear XML file and locate the selected Gear.
            XmlNode objXmlGear = blnNullParent ? null : objSelectedGear.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, objSelectedGear.ChildAvailModifier, objSelectedGear.ChildCostMultiplier, objXmlGear);
            if (treGear.SelectedNode != null)
            {
                if (treGear.SelectedNode.Level > 0)
                {
                    if (objXmlGear?.InnerXml.Contains("<addoncategory>") == true)
                    {
                        string strCategories = string.Empty;
                        foreach (XmlNode objXmlCategory in objXmlGear.SelectNodes("addoncategory"))
                            strCategories += objXmlCategory.InnerText + ",";
                        // Remove the trailing comma.
                        strCategories = strCategories.Substring(0, strCategories.Length - 1);
                        frmPickGear.AllowedCategories = strCategories;
                    }

                    // If the Gear has a Capacity with no brackets (meaning it grants Capacity), show only Subsystems (those that conume Capacity).
                    if (!objSelectedGear.Capacity.Contains('['))
                    {
                        frmPickGear.MaximumCapacity = objSelectedGear.CapacityRemaining;

                        // Do not allow the user to add a new piece of Gear if its Capacity has been reached.
                        if (_objOptions.EnforceCapacity && objSelectedGear.CapacityRemaining < 0)
                        {
                            MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return false;
                        }
                    }

                    if (objSelectedGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = objSelectedGear as Commlink;
                        // If a Commlink has just been added, see if the character already has one. If not, make it the active Commlink.
                        if (objCommlink != null && _objCharacter.ActiveCommlink == null)
                        {
                            objCommlink.IsActive = true;
                        }
                    }
                }
            }
            
            frmPickGear.DefaultSearchText = strForceItemValue;

            if (blnAmmoOnly)
            {
                frmPickGear.AllowedCategories = "Ammunition";
                frmPickGear.SelectedGear = objSelectedGear.Name;
            }

            frmPickGear.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return false;

            TreeNode objNode = new TreeNode();

            // Open the Cyberware XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            Gear objNewGear = null;
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objNewGear = objCommlink;
            }
            else
            {
                string strForceValue = string.Empty;
                if (blnAmmoOnly)
                {
                    strForceValue = objSelectedGear.Extra;
                    if (treGear.SelectedNode != null)
                    {
                        treGear.SelectedNode = treGear.SelectedNode.Parent;
                    }
                }
                if (!string.IsNullOrEmpty(strForceItemValue))
                    strForceValue = strForceItemValue;
                Gear objGear = new Gear(_objCharacter);
                objGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, strForceValue, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objGear.DisplayName;

                objNewGear = objGear;
            }

            objNewGear.Parent = objSelectedGear;
            if (blnNullParent)
                objNewGear.Parent = null;

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return false;

            //Reduce the Cost for Black Market Pipelin
            objNewGear.DiscountCost = frmPickGear.BlackMarketDiscount;
            
            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objNewGear.Cost = (Convert.ToDouble(objNewGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);

            // Reduce the cost to 10% for Hacked programs.
            if (frmPickGear.Hacked)
            {
                if (!string.IsNullOrEmpty(objNewGear.Cost))
                    objNewGear.Cost = "(" + objNewGear.Cost + ") * 0.1";
                if (string.IsNullOrEmpty(objNewGear.Extra))
                    objNewGear.Extra = LanguageManager.GetString("Label_SelectGear_Hacked");
                else
                    objNewGear.Extra += ", " + LanguageManager.GetString("Label_SelectGear_Hacked");
            }

            decimal decCost = 0;
            if (objNewGear.Cost.Contains("Gear Cost"))
            {
                string strCost = objNewGear.Cost.Replace("Gear Cost", objSelectedGear.CalculatedCost.ToString());
                decCost = Convert.ToDecimal(CommonFunctions.EvaluateInvariantXPath(strCost).ToString(), GlobalOptions.InvariantCultureInfo);
            }
            else
            {
                decCost = objNewGear.TotalCost;
            }

            Gear objStackWith = null;
            // See if the character already has the item on them if they chose to stack.
            if (frmPickGear.Stack)
            {
                if (objStackGear != null)
                {
                    objStackWith = objStackGear;
                }
                else
                {
                    objStackWith = _objCharacter.Gear.FirstOrDefault(x => objNewGear.IsIdenticalToOtherGear(x));
                }
            }
            
            if (objStackWith != null)
            {
                // If a match was found, we need to use the cost of a single item in the stack which can include plugins.
                foreach (Gear objPlugin in objStackWith.Children)
                    decCost += (objPlugin.TotalCost * frmPickGear.SelectedQty);
            }
            if (!blnNullParent && !blnAmmoOnly)
                decCost *= objSelectedGear.Quantity;

            // Apply a markup if applicable.
            if (frmPickGear.Markup != 0)
            {
                decCost *= 1 + (frmPickGear.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Do not allow the user to add a new piece of Cyberware if its Capacity has been reached.
            // This is wrapped in a try statement since the character may not have a piece of Gear selected and has clicked the Buy Additional Ammo button for a Weapon.
            if (treGear.SelectedNode != null)
            {
                if (objStackWith == null && treGear.SelectedNode.Level > 0)
                {
                    if (_objOptions.EnforceCapacity && objSelectedGear.CapacityRemaining - objNewGear.PluginCapacity < 0)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return false;
                    }
                }
            }

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove any Improvements created by the Gear.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objNewGear.InternalId);
                    return frmPickGear.AddAgain;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseGear") + " " + objNewGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    objUndo.CreateNuyen(NuyenExpenseType.AddGear, objNewGear.InternalId, objNewGear.Quantity);
                    objExpense.Undo = objUndo;
                }
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return false;

            if (objStackWith != null)
            {
                // A match was found, so increase the quantity instead.
                objStackWith.Quantity += objNewGear.Quantity;

                if (!string.IsNullOrEmpty(objUndo.ObjectId))
                    objUndo.ObjectId = objStackWith.InternalId;

                TreeNode objGearNode = CommonFunctions.FindNode(objStackWith.InternalId, treGear);
                if (objGearNode != null)
                {
                    objGearNode.Text = objStackWith.DisplayName;
                    treGear.SelectedNode = objGearNode;
                }
            }
            // Add the Gear.
            else
            {
                // Create any Weapons that came with this Gear.
                foreach (Weapon objWeapon in objWeapons)
                    _objCharacter.Weapons.Add(objWeapon);

                foreach (TreeNode objWeaponNode in objWeaponNodes)
                {
                    objWeaponNode.ContextMenuStrip = cmsWeapon;
                    treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                    treWeapons.Nodes[0].Expand();
                }

                if (treGear.SelectedNode != null && treGear.SelectedNode.Level > 0 && !blnNullParent)
                {
                    objNode.ContextMenuStrip = cmsGear;
                    treGear.SelectedNode.Nodes.Add(objNode);
                    treGear.SelectedNode.Expand();
                    objSelectedGear.Children.Add(objNewGear);
                    Commlink objSelectedCommlink = objSelectedGear as Commlink;
                    if (objSelectedCommlink?.CanSwapAttributes == true)
                    {
                        objSelectedCommlink.RefreshCyberdeckArray();
                    }
                }
                else
                {
                    objNode.ContextMenuStrip = cmsGear;
                    treGear.Nodes[0].Nodes.Add(objNode);
                    treGear.Nodes[0].Expand();
                    _objCharacter.Gear.Add(objNewGear);
                }

                // Select the node that was just added.
                lblGearQty.Text = objNewGear.Quantity.ToString();
                if (objNode.Level < 2)
                    treGear.SelectedNode = objNode;
            }
            if (frmPickGear.DialogResult != DialogResult.Cancel)
            {
                ScheduleCharacterUpdate();
                RefreshSelectedGear();
                _blnIsDirty = true;
                UpdateWindowTitle();
            }

            return frmPickGear.AddAgain;
        }

        /// <summary>
        /// Select a piece of Gear and add it to a piece of Armor.
        /// </summary>
        /// <param name="blnShowArmorCapacityOnly">Whether or not only items that consume capacity should be shown.</param>
        private bool PickArmorGear(bool blnShowArmorCapacityOnly = false)
        {
            Gear objSelectedGear = null;
            Armor objSelectedArmor = CommonFunctions.FindById(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            ArmorMod objSelectedMod = null;
            ExpenseUndo objUndo = new ExpenseUndo();

            if (treArmor.SelectedNode.Level > 1)
            {
                objSelectedGear = CommonFunctions.FindArmorGear(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor, out objSelectedArmor, out objSelectedMod);
                if (objSelectedGear == null)
                    objSelectedMod = CommonFunctions.FindArmorMod(treArmor.SelectedNode.Tag.ToString(), _objCharacter.Armor);
            }

            // Open the Gear XML file and locate the selected Gear.
            XmlNode objXmlGear = objSelectedGear?.MyXmlNode;
            XmlNode objXmlParent = objXmlGear;
            if (objXmlParent == null && objSelectedMod != null)
                objXmlParent = objSelectedMod.MyXmlNode;
            if (objXmlParent == null)
                objXmlParent = objSelectedArmor.MyXmlNode;

            frmSelectGear frmPickGear = new frmSelectGear(_objCharacter, true, 0, 1, objXmlParent);
            frmPickGear.EnableStack = false;
            frmPickGear.ShowArmorCapacityOnly = blnShowArmorCapacityOnly;
            if (objSelectedMod != null)
                frmPickGear.CapacityDisplayStyle = CapacityStyle.Standard;
            else
                frmPickGear.CapacityDisplayStyle = objSelectedArmor.CapacityDisplayStyle;
            if (treArmor.SelectedNode != null)
            {
                if (objXmlParent?.InnerXml.Contains("<addoncategory>") == true)
                {
                    string strCategories = string.Empty;
                    foreach (XmlNode objXmlCategory in objXmlParent.SelectNodes("addoncategory"))
                        strCategories += objXmlCategory.InnerText + ",";
                    // Remove the trailing comma.
                    if (strCategories.Length > 0)
                        strCategories = strCategories.Substring(0, strCategories.Length - 1);
                    frmPickGear.AllowedCategories = strCategories;
                }

                // If the Gear has a Capacity with no brackets (meaning it grants Capacity), show only Subsystems (those that conume Capacity).
                if (objSelectedGear?.Capacity.Contains('[') == false)
                {
                    frmPickGear.MaximumCapacity = objSelectedGear.CapacityRemaining;

                    // Do not allow the user to add a new piece of Gear if its Capacity has been reached.
                    if (_objOptions.EnforceCapacity && objSelectedGear.CapacityRemaining < 0)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return false;
                    }
                }
                else if (objSelectedMod != null)
                {
                    frmPickGear.MaximumCapacity = objSelectedMod.GearCapacityRemaining;

                    // Do not allow the user to add a new piece of Gear if its Capacity has been reached.
                    if (_objOptions.EnforceCapacity && objSelectedMod.GearCapacityRemaining < 0)
                    {
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return false;
                    }
                }
            }

            frmPickGear.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickGear.DialogResult == DialogResult.Cancel)
                return false;

            TreeNode objNode = new TreeNode();

            // Open the Cyberware XML file and locate the selected piece.
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            objXmlGear = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"" + frmPickGear.SelectedGear + "\" and category = \"" + frmPickGear.SelectedCategory + "\"]");

            // Create the new piece of Gear.
            Gear objNewGear = null;
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();

            if (!string.IsNullOrEmpty(objXmlGear["devicerating"]?.InnerText))
            {
                Commlink objCommlink = new Commlink(_objCharacter);
                objCommlink.Create(objXmlGear, objNode, frmPickGear.SelectedRating);
                objCommlink.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objCommlink.DisplayName;

                objNewGear = objCommlink;
            }
            else
            {
                Gear objGear = new Gear(_objCharacter);
                objGear.Create(objXmlGear, objNode, frmPickGear.SelectedRating, objWeapons, objWeaponNodes, string.Empty, frmPickGear.Hacked, frmPickGear.InherentProgram, true, true, frmPickGear.Aerodynamic);
                objGear.Quantity = frmPickGear.SelectedQty;
                objNode.Text = objGear.DisplayName;

                objNewGear = objGear;
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return false;

            if (objSelectedGear != null)
                objNewGear.Parent = objSelectedGear;

            // Reduce the cost for Do It Yourself components.
            if (frmPickGear.DoItYourself)
                objNewGear.Cost = (Convert.ToDouble(objNewGear.Cost, GlobalOptions.InvariantCultureInfo) * 0.5).ToString(GlobalOptions.InvariantCultureInfo);

            // Apply a markup if applicable.
            decimal decCost = objNewGear.TotalCost;
            if (frmPickGear.Markup != 0)
            {
                decCost *= 1 + (frmPickGear.Markup / 100.0m);
            }

            // Multiply the cost if applicable.
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailRestricted")) && _objOptions.MultiplyRestrictedCost)
                decCost *= _objOptions.RestrictedCostMultiplier;
            if (objNewGear.TotalAvail().EndsWith(LanguageManager.GetString("String_AvailForbidden")) && _objOptions.MultiplyForbiddenCost)
                decCost *= _objOptions.ForbiddenCostMultiplier;

            // Do not allow the user to add new Gear if the Armor's Capacity has been reached.
            if (_objOptions.EnforceCapacity && objSelectedGear != null)
            {
                objSelectedArmor.Gear.Add(objSelectedGear);
                if (treArmor.SelectedNode.Level > 1)
                {
                    if (objSelectedGear.CapacityRemaining < 0)
                    {
                        objSelectedArmor.Gear.Remove(objSelectedGear);
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return frmPickGear.AddAgain;
                    }
                    else
                        objSelectedArmor.Gear.Remove(objSelectedGear);
                }
                else
                {
                    if (objSelectedArmor.CapacityRemaining < 0)
                    {
                        objSelectedArmor.Gear.Remove(objSelectedGear);
                        MessageBox.Show(LanguageManager.GetString("Message_CapacityReached"), LanguageManager.GetString("MessageTitle_CapacityReached"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return frmPickGear.AddAgain;
                    }
                    else
                        objSelectedArmor.Gear.Remove(objSelectedGear);
                }
            }

            // Check the item's Cost and make sure the character can afford it.
            if (!frmPickGear.FreeCost)
            {
                if (decCost > _objCharacter.Nuyen)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    // Remove any Improvements created by the Gear.
                    ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objNewGear.InternalId);
                    return frmPickGear.AddAgain;
                }
                else
                {
                    // Create the Expense Log Entry.
                    ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                    objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseArmorGear") + " " + objNewGear.DisplayNameShort, ExpenseType.Nuyen, DateTime.Now);
                    _objCharacter.ExpenseEntries.Add(objExpense);
                    _objCharacter.Nuyen -= decCost;

                    objUndo.CreateNuyen(NuyenExpenseType.AddArmorGear, objNewGear.InternalId, objNewGear.Quantity);
                    objExpense.Undo = objUndo;
                }
            }

            if (objNewGear.InternalId == Guid.Empty.ToString())
                return false;

            // Create any Weapons that came with this Gear.
            foreach (Weapon objWeapon in objWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                objWeaponNode.ContextMenuStrip = cmsWeapon;
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            Gear objMatchingGear = null;
            // If this is Ammunition, see if the character already has it on them.
            if (objNewGear.Category == "Ammunition")
            {
                IList<Gear> lstToSearch = string.IsNullOrEmpty(objSelectedGear?.Name) ? objSelectedArmor.Gear : objSelectedGear.Children;
                objMatchingGear = lstToSearch.FirstOrDefault(x => objNewGear.IsIdenticalToOtherGear(x));
            }

            if (objMatchingGear != null)
            {
                // A match was found, so increase the quantity instead.
                objMatchingGear.Quantity += objNewGear.Quantity;

                if (!string.IsNullOrEmpty(objUndo.ObjectId))
                    objUndo.ObjectId = objMatchingGear.InternalId;

                TreeNode objGearNode = CommonFunctions.FindNode(objMatchingGear.InternalId, treArmor);
                if (objGearNode != null)
                {
                    objGearNode.Text = objMatchingGear.DisplayName;
                    treArmor.SelectedNode = objGearNode;
                }
            }
            // Add the Gear.
            else
            {
                objNode.ContextMenuStrip = cmsArmorGear;
                treArmor.SelectedNode.Nodes.Add(objNode);
                treArmor.SelectedNode.Expand();
                if (!string.IsNullOrEmpty(objSelectedGear?.Name))
                {
                    objSelectedGear.Children.Add(objNewGear);
                    Commlink objCommlink = objSelectedGear as Commlink;
                    if (objCommlink?.CanSwapAttributes == true)
                    {
                        objCommlink.RefreshCyberdeckArray();
                    }
                }
                else if (!string.IsNullOrEmpty(objSelectedMod?.Name))
                {
                    objSelectedMod.Gear.Add(objNewGear);
                }
                else
                {
                    objSelectedArmor.Gear.Add(objNewGear);
                }

                // Select the node that was just added.
                treArmor.SelectedNode = objNode;
            }

            ScheduleCharacterUpdate();
            RefreshSelectedArmor();

            _blnIsDirty = true;
            UpdateWindowTitle();

            return frmPickGear.AddAgain;
        }

        /// <summary>
        /// Refresh the currently-selected Lifestyle.
        /// </summary>
        private void RefreshSelectedLifestyle()
        {
            _blnSkipRefresh = true;
            if (treLifestyles.SelectedNode == null || treLifestyles.SelectedNode.Level == 0)
            {
                lblLifestyleCost.Text = string.Empty;
                lblLifestyleMonths.Text = string.Empty;
                lblLifestyleSource.Text = string.Empty;
                tipTooltip.SetToolTip(lblLifestyleSource, null);
                lblBaseLifestyle.Text = string.Empty;
                lblLifestyleQualities.Text = string.Empty;
                cmdIncreaseLifestyleMonths.Enabled = false;
                cmdDecreaseLifestyleMonths.Enabled = false;
            }

            if (treLifestyles.SelectedNode.Level > 0)
            {
                // Locate the selected Lifestyle.
                Lifestyle objLifestyle = CommonFunctions.FindByIdWithNameCheck(treLifestyles.SelectedNode.Tag.ToString(), _objCharacter.Lifestyles);
                if (objLifestyle == null)
                    return;

                lblLifestyleCost.Text = objLifestyle.TotalMonthlyCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                lblLifestyleMonths.Text = Convert.ToDecimal(objLifestyle.Months, GlobalOptions.InvariantCultureInfo).ToString(GlobalOptions.CultureInfo);
                string strBook = _objOptions.LanguageBookShort(objLifestyle.Source);
                string strPage = objLifestyle.Page;
                lblLifestyleSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblLifestyleSource, _objOptions.LanguageBookLong(objLifestyle.Source) + " " + LanguageManager.GetString("String_Page") + " " + objLifestyle.Page);
                //lblLifestyleTotalCost.Text = "= " + objLifestyle.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';

                // Change the Cost/Month label.
                if (objLifestyle.StyleType == LifestyleType.Safehouse)
                    lblLifestyleCostLabel.Text = LanguageManager.GetString("Label_SelectLifestyle_CostPerWeek");
                else
                    lblLifestyleCostLabel.Text = LanguageManager.GetString("Label_SelectLifestyle_CostPerMonth");

                if (!string.IsNullOrEmpty(objLifestyle.BaseLifestyle))
                {
                    string strQualities = string.Join(", ", objLifestyle.LifestyleQualities.Select(r => r.FormattedDisplayName));

                    lblLifestyleQualities.Text = string.Empty;

                    foreach (Improvement objImprovement in _objCharacter.Improvements.Where(objImprovement => objImprovement.ImproveType == Improvement.ImprovementType.LifestyleCost))
                    {
                        if (strQualities.Length > 0)
                            strQualities += ", ";

                        strQualities += objImprovement.Value > 0
                            ? objImprovement.ImproveSource + " [+" + objImprovement.Value.ToString() + "%]"
                            : objImprovement.ImproveSource + " [" + objImprovement.Value.ToString() + "%]";
                    }

                    if (strQualities.Length > 0)
                        strQualities += ", ";

                    strQualities += string.Join(", ", objLifestyle.FreeGrids.Select(r => r.DisplayName));

                    lblBaseLifestyle.Text = objLifestyle.BaseLifestyle;
                    lblLifestyleQualities.Text += strQualities;

                    cmdIncreaseLifestyleMonths.Enabled = true;
                    cmdDecreaseLifestyleMonths.Enabled = true;
                }
                else
                {
                    lblBaseLifestyle.Text = "Error in lifestyle;\nplease edit to fix.";
                    lblLifestyleQualities.Text = string.Empty;
                }
            }
            _blnSkipRefresh = false;
        }

        /// <summary>
        /// Switches the visibility of Weapon attributes on the Vehicles and Drones form.
        /// </summary>
        /// <param name="blnDisplay">Whether to hide or show the objects.</param>
        private void DisplayVehicleWeaponStats(bool blnDisplay)
        {
            lblVehicleWeaponName.Visible = blnDisplay;
            lblVehicleWeaponCategory.Visible = blnDisplay;
            lblVehicleWeaponAP.Visible = blnDisplay;
            lblVehicleWeaponDamage.Visible = blnDisplay;
            lblVehicleWeaponMode.Visible = blnDisplay;
            lblVehicleWeaponAmmo.Visible = blnDisplay;

            lblVehicleWeaponRangeShort.Visible = blnDisplay;
            lblVehicleWeaponRangeMedium.Visible = blnDisplay;
            lblVehicleWeaponRangeLong.Visible = blnDisplay;
            lblVehicleWeaponRangeExtreme.Visible = blnDisplay;

            lblVehicleWeaponNameLabel.Visible = blnDisplay;
            lblVehicleWeaponCategoryLabel.Visible = blnDisplay;
            lblVehicleWeaponAPLabel.Visible = blnDisplay;
            lblVehicleWeaponDamageLabel.Visible = blnDisplay;
            lblVehicleWeaponModeLabel.Visible = blnDisplay;
            lblVehicleWeaponAmmoLabel.Visible = blnDisplay;
            lblVehicleWeaponRangeLabel.Visible = blnDisplay;

            lblVehicleWeaponRangeMain.Visible = blnDisplay;
            lblVehicleWeaponRangeAlternate.Visible = blnDisplay;
            lblVehicleWeaponRangeShortLabel.Visible = blnDisplay;
            lblVehicleWeaponRangeMediumLabel.Visible = blnDisplay;
            lblVehicleWeaponRangeLongLabel.Visible = blnDisplay;
            lblVehicleWeaponRangeExtremeLabel.Visible = blnDisplay;
            lblVehicleWeaponAlternateRangeShort.Visible = blnDisplay;
            lblVehicleWeaponAlternateRangeMedium.Visible = blnDisplay;
            lblVehicleWeaponAlternateRangeLong.Visible = blnDisplay;
            lblVehicleWeaponAlternateRangeExtreme.Visible = blnDisplay;
        }

        /// <summary>
        /// Switches the visibility of Commlink attributes on the Vehicles and Drones form.
        /// </summary>
        /// <param name="blnDisplay">Whether to hide or show the objects.</param>
        private void DisplayVehicleCommlinkStats(bool blnDisplay)
        {
            cboVehicleGearAttack.Visible = blnDisplay;
            cboVehicleGearSleaze.Visible = blnDisplay;
            cboVehicleGearDataProcessing.Visible = blnDisplay;
            cboVehicleGearFirewall.Visible = blnDisplay;
            lblVehicleAttackLabel.Visible = blnDisplay;
            lblVehicleSleazeLabel.Visible = blnDisplay;
            lblVehicleDataProcessingLabel.Visible = blnDisplay;
            lblVehicleFirewallLabel.Visible = blnDisplay;
            lblVehicleDevice.Visible = blnDisplay;
            lblVehicleDeviceLabel.Visible = blnDisplay;
        }

        /// <summary>
        /// Switches the visibility of Commlink attributes on the Vehicles and Drones form.
        /// </summary>
        /// <param name="blnDisplay">Whether to hide or show the objects.</param>
        private void DisplayVehicleStats(bool blnDisplay)
        {
            lblVehicleHandling.Visible = blnDisplay;
            lblVehicleAccel.Visible = blnDisplay;
            lblVehicleSpeed.Visible = blnDisplay;
            lblVehicleDevice.Visible = blnDisplay;
            lblVehiclePilot.Visible = blnDisplay;
            lblVehicleBody.Visible = blnDisplay;
            lblVehicleArmor.Visible = blnDisplay;
            lblVehicleSensor.Visible = blnDisplay;
            lblVehicleHandlingLabel.Visible = blnDisplay;
            lblVehicleAccelLabel.Visible = blnDisplay;
            lblVehicleSpeedLabel.Visible = blnDisplay;
            lblVehicleDeviceLabel.Visible = blnDisplay;
            lblVehiclePilotLabel.Visible = blnDisplay;
            lblVehicleBodyLabel.Visible = blnDisplay;
            lblVehicleArmorLabel.Visible = blnDisplay;
            lblVehicleSensorLabel.Visible = blnDisplay;
            lblVehiclePowertrainLabel.Visible = blnDisplay;
            lblVehiclePowertrain.Visible = blnDisplay;
            lblVehicleCosmeticLabel.Visible = blnDisplay;
            lblVehicleCosmetic.Visible = blnDisplay;
            lblVehicleElectromagneticLabel.Visible = blnDisplay;
            lblVehicleElectromagnetic.Visible = blnDisplay;
            lblVehicleBodymodLabel.Visible = blnDisplay;
            lblVehicleBodymod.Visible = blnDisplay;
            lblVehicleWeaponsmodLabel.Visible = blnDisplay;
            lblVehicleWeaponsmod.Visible = blnDisplay;
            lblVehicleProtectionLabel.Visible = blnDisplay;
            lblVehicleProtection.Visible = blnDisplay;
            lblVehicleDroneModSlotsLabel.Visible = blnDisplay;
            lblVehicleDroneModSlots.Visible = blnDisplay;
            lblVehicleSeatsLabel.Visible = blnDisplay;
            lblVehicleSeats.Visible = blnDisplay;
        }

        /// <summary>
        /// Switches the visibility of Vehicle (non-drone) Mods on the Vehicles and Drones form.
        /// </summary>
        /// <param name="blnDisplay">Whether to hide or show the objects.</param>
        private void DisplayVehicleMods(bool blnDisplay)
        {
            lblVehiclePowertrainLabel.Visible = blnDisplay;
            lblVehiclePowertrain.Visible = blnDisplay;
            lblVehicleCosmeticLabel.Visible = blnDisplay;
            lblVehicleCosmetic.Visible = blnDisplay;
            lblVehicleElectromagneticLabel.Visible = blnDisplay;
            lblVehicleElectromagnetic.Visible = blnDisplay;
            lblVehicleBodymodLabel.Visible = blnDisplay;
            lblVehicleBodymod.Visible = blnDisplay;
            lblVehicleWeaponsmodLabel.Visible = blnDisplay;
            lblVehicleWeaponsmod.Visible = blnDisplay;
            lblVehicleProtectionLabel.Visible = blnDisplay;
            lblVehicleProtection.Visible = blnDisplay;
        }

        /// <summary>
        /// Switches the visibility of Drone Mods on the Vehicles and Drones form.
        /// </summary>
        /// <param name="blnDisplay">Whether to hide or show the objects.</param>
        private void DisplayVehicleDroneMods(bool blnDisplay)
        {
            lblVehicleDroneModSlotsLabel.Visible = blnDisplay;
            lblVehicleDroneModSlots.Visible = blnDisplay;
        }

        /// <summary>
        /// Refresh the currently-selected Vehicle.
        /// </summary>
        private void RefreshSelectedVehicle()
        {
            _blnSkipRefresh = true;
            cboVehicleGearAttack.Visible = false;
            cboVehicleGearDataProcessing.Visible = false;

            lblVehicleGearQty.Text = string.Empty;
            cmdVehicleGearReduceQty.Enabled = false;
            cboVehicleWeaponAmmo.Enabled = false;

            lblVehicleSeatsLabel.Visible = false;
            lblVehicleSeats.Visible = false;
            cmdDeleteVehicle.Enabled = treVehicles.SelectedNode != null;
            cmdVehicleCyberwareChangeMount.Visible = false;

            if (treVehicles.SelectedNode == null || treVehicles.SelectedNode.Level <= 0 || treVehicles.SelectedNode.Tag.ToString() == "String_WeaponMounts")
            {
                DisplayVehicleWeaponStats(false);
                DisplayVehicleCommlinkStats(false);
                DisplayVehicleStats(false);
                lblVehicleCategory.Text = string.Empty;
                lblVehicleName.Text = string.Empty;
                lblVehicleAvail.Text = string.Empty;
                lblVehicleCost.Text = string.Empty;
                lblVehicleSource.Text = string.Empty;

                chkVehicleWeaponAccessoryInstalled.Enabled = false;
                _blnSkipRefresh = false;
                return;
            }
            chkVehicleHomeNode.Visible = false;
            cmdVehicleMoveToInventory.Enabled = false;

            if (treVehicles.SelectedNode.Level != 0)
            {
                // Locate the selected Vehicle.
                TreeNode objVehicleNode = new TreeNode();
                objVehicleNode = treVehicles.SelectedNode;
                if (treVehicles.SelectedNode.Level > 1)
                {
                    while (objVehicleNode.Level > 1)
                        objVehicleNode = objVehicleNode.Parent;
                }

                Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(objVehicleNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objVehicle == null)
                {
                    _blnSkipRefresh = false;
                    return;
                }

                // Hide any unused Physical CM boxes.
                panVehicleCM.Visible = true;
                if (!string.IsNullOrEmpty(objVehicle.ParentID))
                    cmdDeleteVehicle.Enabled = false;
                foreach (CheckBox objPhysicalCM in tabVehiclePhysicalCM.Controls.OfType<CheckBox>())
                {
                    if (Convert.ToInt32(objPhysicalCM.Tag.ToString()) <= objVehicle.PhysicalCM)
                    {
                        if (Convert.ToInt32(objPhysicalCM.Tag.ToString()) <= objVehicle.PhysicalCMFilled)
                            objPhysicalCM.Checked = true;
                        else
                            objPhysicalCM.Checked = false;

                        objPhysicalCM.Visible = true;
                    }
                    else
                    {
                        objPhysicalCM.Checked = false;
                        objPhysicalCM.Visible = false;
                        objPhysicalCM.Text = string.Empty;
                    }
                }
                foreach (CheckBox objMatrixCM in tabVehicleMatrixCM.Controls.OfType<CheckBox>())
                {
                    if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objVehicle.MatrixCM)
                    {
                        if (Convert.ToInt32(objMatrixCM.Tag.ToString()) <= objVehicle.MatrixCMFilled)
                            objMatrixCM.Checked = true;
                        else
                            objMatrixCM.Checked = false;

                        objMatrixCM.Visible = true;
                    }
                    else
                    {
                        objMatrixCM.Checked = false;
                        objMatrixCM.Visible = false;
                        objMatrixCM.Text = string.Empty;
                    }
                }
            }

            // Locate the selected Vehicle.
            if (treVehicles.SelectedNode.Level == 1)
            {
                Vehicle objVehicle = CommonFunctions.FindByIdWithNameCheck(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objVehicle == null)
                {
                    _blnSkipRefresh = false;
                    return;
                }

                if (!string.IsNullOrEmpty(objVehicle.ParentID))
                    cmdDeleteVehicle.Enabled = false;
                lblVehicleRatingLabel.Text = LanguageManager.GetString("Label_Rating");
                lblVehicleRating.Text = string.Empty;

                lblVehicleName.Text = objVehicle.DisplayNameShort;
                lblVehicleCategory.Text = objVehicle.DisplayCategory;
                lblVehicleAvail.Text = objVehicle.CalculatedAvail;
                lblVehicleCost.Text = objVehicle.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                lblVehicleHandling.Text = objVehicle.TotalHandling.ToString();
                lblVehicleAccel.Text = objVehicle.TotalAccel.ToString();
                lblVehicleSpeed.Text = objVehicle.TotalSpeed.ToString();
                lblVehicleDevice.Text = objVehicle.DeviceRating.ToString();
                lblVehiclePilot.Text = objVehicle.Pilot.ToString();
                lblVehicleBody.Text = objVehicle.TotalBody.ToString();
                lblVehicleArmor.Text = objVehicle.TotalArmor.ToString();
                lblVehicleSeats.Text = objVehicle.TotalSeats.ToString();

                lblVehicleSeatsLabel.Visible = true;
                lblVehicleSeats.Visible = true;

                // Update the vehicle mod slots
                if (_objOptions.BookEnabled("R5"))
                {
                    lblVehicleSlots.Text = string.Empty;
                    lblVehicleSlotsLabel.Visible = false;

                    if (objVehicle.IsDrone && GlobalOptions.Dronemods)
                    {
                        lblVehicleDroneModSlots.Text = objVehicle.DroneModSlotsUsed + "/" + objVehicle.DroneModSlots;
                        lblVehicleDroneModSlots.Visible = true;
                        lblVehicleDroneModSlotsLabel.Visible = true;
                        lblVehiclePowertrain.Visible = false;
                        lblVehicleCosmetic.Visible = false;
                        lblVehicleElectromagnetic.Visible = false;
                        lblVehicleBodymod.Visible = false;
                        lblVehicleWeaponsmod.Visible = false;
                        lblVehicleProtection.Visible = false;
                        lblVehiclePowertrainLabel.Visible = false;
                        lblVehicleCosmeticLabel.Visible = false;
                        lblVehicleElectromagneticLabel.Visible = false;
                        lblVehicleBodymodLabel.Visible = false;
                        lblVehicleWeaponsmodLabel.Visible = false;
                        lblVehicleProtectionLabel.Visible = false;
                    }
                    else
                    {
                        lblVehiclePowertrain.Text = objVehicle.PowertrainModSlotsUsed();
                        lblVehicleCosmetic.Text = objVehicle.CosmeticModSlotsUsed();
                        lblVehicleElectromagnetic.Text = objVehicle.ElectromagneticModSlotsUsed();
                        lblVehicleBodymod.Text = objVehicle.BodyModSlotsUsed();
                        lblVehicleWeaponsmod.Text = objVehicle.WeaponModSlotsUsed();
                        lblVehicleProtection.Text = objVehicle.ProtectionModSlotsUsed();

                        tipTooltip.SetToolTip(lblVehiclePowertrainLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));
                        tipTooltip.SetToolTip(lblVehicleCosmeticLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));
                        tipTooltip.SetToolTip(lblVehicleElectromagneticLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));
                        tipTooltip.SetToolTip(lblVehicleBodymodLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));
                        tipTooltip.SetToolTip(lblVehicleWeaponsmodLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));
                        tipTooltip.SetToolTip(lblVehicleProtectionLabel, LanguageManager.GetString("Tip_TotalVehicleModCapacity"));

                        lblVehicleDroneModSlots.Visible = false;
                        lblVehicleDroneModSlotsLabel.Visible = false;
                        lblVehiclePowertrain.Visible = true;
                        lblVehicleCosmetic.Visible = true;
                        lblVehicleElectromagnetic.Visible = true;
                        lblVehicleBodymod.Visible = true;
                        lblVehicleWeaponsmod.Visible = true;
                        lblVehicleProtection.Visible = true;
                        lblVehiclePowertrainLabel.Visible = true;
                        lblVehicleCosmeticLabel.Visible = true;
                        lblVehicleElectromagneticLabel.Visible = true;
                        lblVehicleBodymodLabel.Visible = true;
                        lblVehicleWeaponsmodLabel.Visible = true;
                        lblVehicleProtectionLabel.Visible = true;
                    }
                }
                else
                {
                    lblVehicleDroneModSlots.Text = string.Empty;
                    lblVehicleDroneModSlots.Visible = false;
                    lblVehicleDroneModSlotsLabel.Visible = false;
                    lblVehiclePowertrain.Visible = false;
                    lblVehicleCosmetic.Visible = false;
                    lblVehicleElectromagnetic.Visible = false;
                    lblVehicleBodymod.Visible = false;
                    lblVehicleWeaponsmod.Visible = false;
                    lblVehicleProtection.Visible = false;
                    lblVehiclePowertrainLabel.Visible = false;
                    lblVehicleCosmeticLabel.Visible = false;
                    lblVehicleElectromagneticLabel.Visible = false;
                    lblVehicleBodymodLabel.Visible = false;
                    lblVehicleWeaponsmodLabel.Visible = false;
                    lblVehicleProtectionLabel.Visible = false;
                    lblVehicleSlotsLabel.Visible = true;
                    lblVehicleSlots.Text = objVehicle.Slots.ToString() + " (" + (objVehicle.Slots - objVehicle.SlotsUsed).ToString() + " " + LanguageManager.GetString("String_Remaining") + ")";
                }

                lblVehicleSensor.Text = objVehicle.CalculatedSensor.ToString();
                UpdateSensor(objVehicle);
                string strBook = _objOptions.LanguageBookShort(objVehicle.Source);
                string strPage = objVehicle.Page;
                lblVehicleSource.Text = strBook + " " + strPage;
                tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objVehicle.Source) + " " + LanguageManager.GetString("String_Page") + " " + objVehicle.Page);
                chkVehicleWeaponAccessoryInstalled.Enabled = false;
                chkVehicleIncludedInWeapon.Checked = false;

                if (_objCharacter.Metatype.Contains("A.I.") || _objCharacter.MetatypeCategory == "Protosapients")
                {
                    chkVehicleHomeNode.Visible = true;
                    chkVehicleHomeNode.Checked = objVehicle.HomeNode;
                }
            }
            else if (treVehicles.SelectedNode.Level == 2)
            {
                panVehicleCM.Visible = true;
                bool blnVehicleMod = false;

                // If this is a Vehicle Location, don't do anything.
                foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                {
                    if (objVehicle.InternalId == treVehicles.SelectedNode.Parent.Tag.ToString())
                    {
                        foreach (string strLocation in objVehicle.Locations)
                        {
                            if (strLocation == treVehicles.SelectedNode.Tag.ToString())
                            {
                                lblVehicleName.Text = string.Empty;
                                lblVehicleCategory.Text = string.Empty;
                                lblVehicleSource.Text = string.Empty;
                                lblVehicleHandling.Text = string.Empty;
                                lblVehicleAccel.Text = string.Empty;
                                lblVehicleSpeed.Text = string.Empty;
                                lblVehicleDevice.Text = string.Empty;
                                lblVehiclePilot.Text = string.Empty;
                                lblVehicleBody.Text = string.Empty;
                                lblVehicleArmor.Text = string.Empty;
                                lblVehicleSensor.Text = string.Empty;
                                lblVehicleAvail.Text = string.Empty;
                                lblVehicleCost.Text = string.Empty;
                                lblVehicleSlots.Text = string.Empty;
                                _blnSkipRefresh = false;
                                return;
                            }
                        }
                    }
                }

                // Locate the selected VehicleMod.
                Vehicle objSelectedVehicle = null;
                VehicleMod objMod = CommonFunctions.FindVehicleMod(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objSelectedVehicle);
                if (objMod != null)
                {
                    blnVehicleMod = true;
                    if (objMod.IncludedInVehicle)
                        cmdDeleteVehicle.Enabled = false;
                    if (objMod.MaxRating != "qty")
                    {
                        if (objMod.MaxRating == "Seats")
                        {
                            objMod.MaxRating = objSelectedVehicle.Seats.ToString();
                        }
                        if (objMod.MaxRating == "body")
                        {
                            objMod.MaxRating = objSelectedVehicle.Body.ToString();
                        }
                        if (Convert.ToInt32(objMod.MaxRating) > 0)
                        {
                            lblVehicleRatingLabel.Text = LanguageManager.GetString("Label_Rating");
                            lblVehicleRating.Text = objMod.Rating.ToString();
                        }
                        else
                        {
                            lblVehicleRatingLabel.Text = LanguageManager.GetString("Label_Rating");
                            lblVehicleRating.Text = string.Empty;
                        }
                    }
                    else
                    {
                        lblVehicleRatingLabel.Text = LanguageManager.GetString("Label_Qty");
                        lblVehicleRating.Text = objMod.Rating.ToString();
                    }

                    lblVehicleName.Text = objMod.DisplayNameShort;
                    lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleModification");
                    lblVehicleAvail.Text = objMod.TotalAvail;
                    lblVehicleCost.Text = objMod.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    lblVehicleHandling.Text = string.Empty;
                    lblVehicleAccel.Text = string.Empty;
                    lblVehicleSpeed.Text = string.Empty;
                    lblVehicleDevice.Text = string.Empty;
                    lblVehiclePilot.Text = string.Empty;
                    lblVehicleBody.Text = string.Empty;
                    lblVehicleArmor.Text = string.Empty;
                    lblVehicleSensor.Text = string.Empty;
                    lblVehicleSlots.Text = objMod.CalculatedSlots.ToString();
                    string strBook = _objOptions.LanguageBookShort(objMod.Source);
                    string strPage = objMod.Page;
                    lblVehicleSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objMod.Source) + " " + LanguageManager.GetString("String_Page") + " " + objMod.Page);
                }
                else
                {
                    // If it's not a Vehicle Mod then it must be a Sensor.
                    Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                    if (objGear != null)
                    {
                        if (objGear.IncludedInParent)
                            cmdDeleteVehicle.Enabled = false;
                        lblVehicleRating.Text = string.Empty;
                        if (objGear.InternalId == treVehicles.SelectedNode.Tag.ToString())
                        {
                            lblVehicleGearQty.Text = objGear.Quantity.ToString();
                            cmdVehicleGearReduceQty.Enabled = !objGear.DisableQuantity;

                            if (objGear.Rating > 0)
                                lblVehicleRating.Text = objGear.Rating.ToString();
                        }

                        lblVehicleName.Text = objGear.DisplayNameShort;
                        lblVehicleCategory.Text = objGear.DisplayCategory;
                        lblVehicleAvail.Text = objGear.TotalAvail(true);
                        lblVehicleCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblVehicleHandling.Text = string.Empty;
                        lblVehicleAccel.Text = string.Empty;
                        lblVehicleSpeed.Text = string.Empty;
                        lblVehicleDevice.Text = string.Empty;
                        lblVehiclePilot.Text = string.Empty;
                        lblVehicleBody.Text = string.Empty;
                        lblVehicleArmor.Text = string.Empty;
                        lblVehicleSensor.Text = string.Empty;
                        lblVehicleSlots.Text = objGear.CalculatedCapacity + " (" + objGear.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                        string strBook = _objOptions.LanguageBookShort(objGear.Source);
                        string strPage = objGear.Page;
                        lblVehicleSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objGear.Page);

                        cmdVehicleMoveToInventory.Enabled = true;

                        if (objGear.GetType() == typeof(Commlink))
                        {
                            Commlink objCommlink = (Commlink)objGear;
                            lblVehicleDevice.Text = objCommlink.DeviceRating.ToString();
                            objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                            if (_objCharacter.Metatype == "A.I.")
                            {
                                chkVehicleHomeNode.Visible = true;
                                chkVehicleHomeNode.Checked = objCommlink.HomeNode;
                            }
                        }
                    }
                    else
                    {
                        // Look for the selected Vehicle Weapon.
                        Weapon objWeapon = null;
                        Vehicle objCurrentVehicle = null;

                        foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                        {
                            objWeapon = CommonFunctions.DeepFindById(treVehicles.SelectedNode.Tag.ToString(), objVehicle.Weapons);
                            if (objWeapon != null)
                            {
                                objCurrentVehicle = objVehicle;
                                break;
                            }
                        }

                        if (objWeapon.Cyberware || objWeapon.Category == "Gear" || objWeapon.Category.StartsWith("Quality") || objWeapon.IncludedInWeapon || !string.IsNullOrEmpty(objWeapon.ParentID))
                            cmdDeleteVehicle.Enabled = false;
                        lblVehicleWeaponName.Text = objWeapon.DisplayNameShort;
                        lblVehicleWeaponCategory.Text = objWeapon.DisplayCategory;
                        lblVehicleWeaponDamage.Text = objWeapon.CalculatedDamage();
                        lblVehicleWeaponAP.Text = objWeapon.TotalAP;
                        lblVehicleWeaponAmmo.Text = objWeapon.CalculatedAmmo();
                        lblVehicleWeaponMode.Text = objWeapon.CalculatedMode;
                        if (objWeapon.WeaponType == "Ranged" || (objWeapon.WeaponType == "Melee" && objWeapon.Ammo != "0"))
                        {
                            cmdFireVehicleWeapon.Enabled = true;
                            cmdReloadVehicleWeapon.Enabled = true;
                            lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();

                            cmsVehicleAmmoSingleShot.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeSingleShot")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeSemiAutomatic"));
                            cmsVehicleAmmoShortBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeBurstFire")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoLongBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoFullBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoSuppressiveFire.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));

                            // Melee Weapons with Ammo are considered to be Single Shot.
                            if (objWeapon.WeaponType == "Melee" && objWeapon.Ammo != "0")
                                cmsVehicleAmmoSingleShot.Enabled = true;

                            if (cmsVehicleAmmoFullBurst.Enabled)
                                cmsVehicleAmmoFullBurst.Text = LanguageManager.GetString("String_FullBurst").Replace("{0}", objWeapon.FullBurst.ToString());
                            if (cmsVehicleAmmoSuppressiveFire.Enabled)
                                cmsVehicleAmmoSuppressiveFire.Text = LanguageManager.GetString("String_SuppressiveFire").Replace("{0}", objWeapon.Suppressive.ToString());

                            List<ListItem> lstAmmo = new List<ListItem>();
                            int intCurrentSlot = objWeapon.ActiveAmmoSlot;
                            for (int i = 1; i <= objWeapon.AmmoSlots; i++)
                            {
                                ListItem objAmmo = new ListItem();
                                objWeapon.ActiveAmmoSlot = i;
                                Gear objVehicleGear = CommonFunctions.DeepFindById(objWeapon.AmmoLoaded, objCurrentVehicle.Gear);
                                objAmmo.Value = i.ToString();

                                string strPlugins = string.Empty;
                                foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                                {
                                    foreach (Gear objCurrentAmmo in objVehicle.Gear)
                                    {
                                        if (objCurrentAmmo.InternalId == objWeapon.AmmoLoaded)
                                        {
                                            foreach (Gear objChild in objCurrentAmmo.Children)
                                            {
                                                strPlugins += objChild.DisplayNameShort + ", ";
                                            }
                                        }
                                    }
                                }
                                // Remove the trailing comma.
                                if (!string.IsNullOrEmpty(strPlugins))
                                    strPlugins = strPlugins.Substring(0, strPlugins.Length - 2);

                                if (objVehicleGear == null)
                                {
                                    if (objWeapon.AmmoRemaining == 0)
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_Empty");
                                    else
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_ExternalSource");
                                }
                                else
                                    objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + objVehicleGear.DisplayNameShort;

                                if (!string.IsNullOrEmpty(strPlugins))
                                    objAmmo.Name += " [" + strPlugins + "]";
                                lstAmmo.Add(objAmmo);
                            }
                            objWeapon.ActiveAmmoSlot = intCurrentSlot;
                            cboVehicleWeaponAmmo.BeginUpdate();
                            cboVehicleWeaponAmmo.Enabled = true;
                            cboVehicleWeaponAmmo.ValueMember = "Value";
                            cboVehicleWeaponAmmo.DisplayMember = "Name";
                            cboVehicleWeaponAmmo.DataSource = lstAmmo;
                            cboVehicleWeaponAmmo.SelectedValue = objWeapon.ActiveAmmoSlot.ToString();
                            if (cboVehicleWeaponAmmo.SelectedIndex == -1)
                                cboVehicleWeaponAmmo.SelectedIndex = 0;
                            cboVehicleWeaponAmmo.EndUpdate();
                        }
                        lblVehicleWeaponRangeMain.Text = objWeapon.Range;
                        lblVehicleWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                        Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                        lblVehicleWeaponRangeShort.Text = dictionaryRanges["short"];
                        lblVehicleWeaponRangeMedium.Text = dictionaryRanges["medium"];
                        lblVehicleWeaponRangeLong.Text = dictionaryRanges["long"];
                        lblVehicleWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                        lblVehicleWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                        lblVehicleWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                        lblVehicleWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                        lblVehicleWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];

                        lblVehicleName.Text = objWeapon.DisplayNameShort;
                        lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleWeapon");
                        lblVehicleAvail.Text = objWeapon.TotalAvail;
                        lblVehicleCost.Text = objWeapon.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblVehicleHandling.Text = string.Empty;
                        lblVehicleAccel.Text = string.Empty;
                        lblVehicleSpeed.Text = string.Empty;
                        lblVehicleDevice.Text = string.Empty;
                        lblVehiclePilot.Text = string.Empty;
                        lblVehicleBody.Text = string.Empty;
                        lblVehicleArmor.Text = string.Empty;
                        lblVehicleSensor.Text = string.Empty;
                        lblVehicleSlots.Text = string.Empty;
                        string strBook = _objOptions.LanguageBookShort(objWeapon.Source);
                        string strPage = objWeapon.Page;
                        lblVehicleSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objWeapon.Source) + " " + LanguageManager.GetString("String_Page") + " " + objWeapon.Page);

                        cmdVehicleMoveToInventory.Enabled = true;

                        // Determine the Dice Pool size.
                        int intPilot = objCurrentVehicle.Pilot;
                        int intAutosoft = 0;
                        foreach (Gear objAutosoft in objCurrentVehicle.Gear)
                        {
                            if (objAutosoft.Extra == objWeapon.DisplayCategory && (objAutosoft.Name == "[Weapon] Targeting Autosoft" || objAutosoft.Name == "[Weapon] Melee Autosoft"))
                            {
                                if (objAutosoft.Rating > intAutosoft)
                                {
                                    intAutosoft = objAutosoft.Rating;
                                }
                            }
                        }
                        if (intAutosoft == 0)
                            intPilot -= 1;
                        lblVehicleWeaponDicePool.Text = (intPilot + intAutosoft).ToString();
                    }
                }
                if (blnVehicleMod)
                {
                    chkVehicleWeaponAccessoryInstalled.Enabled = true;
                    chkVehicleWeaponAccessoryInstalled.Checked = objMod.Installed;
                }
                else
                    chkVehicleWeaponAccessoryInstalled.Enabled = false;
                chkVehicleIncludedInWeapon.Checked = false;
            }
            else if (treVehicles.SelectedNode.Level == 3)
            {
                panVehicleCM.Visible = true;
                Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objGear != null)
                {
                    if (objGear.IncludedInParent)
                        cmdDeleteVehicle.Enabled = false;
                    lblVehicleRating.Text = string.Empty;
                    if (objGear.InternalId == treVehicles.SelectedNode.Tag.ToString())
                    {
                        lblVehicleGearQty.Text = objGear.Quantity.ToString();
                        cmdVehicleGearReduceQty.Enabled = !objGear.DisableQuantity;

                        if (objGear.Rating > 0)
                            lblVehicleRating.Text = objGear.Rating.ToString();
                    }

                    lblVehicleName.Text = objGear.DisplayNameShort;
                    lblVehicleCategory.Text = objGear.DisplayCategory;
                    lblVehicleAvail.Text = objGear.TotalAvail(true);
                    lblVehicleCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    lblVehicleHandling.Text = string.Empty;
                    lblVehicleAccel.Text = string.Empty;
                    lblVehicleSpeed.Text = string.Empty;
                    lblVehicleDevice.Text = string.Empty;
                    lblVehiclePilot.Text = string.Empty;
                    lblVehicleBody.Text = string.Empty;
                    lblVehicleArmor.Text = string.Empty;
                    lblVehicleSensor.Text = string.Empty;
                    lblVehicleSlots.Text = objGear.CalculatedCapacity + " (" + objGear.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                    string strBook = _objOptions.LanguageBookShort(objGear.Source);
                    string strPage = objGear.Page;
                    lblVehicleSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objGear.Page);

                    if (objGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink)objGear;
                        lblVehicleDevice.Text = objCommlink.DeviceRating.ToString();
                        objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                        if (_objCharacter.Metatype == "A.I.")
                        {
                            chkVehicleHomeNode.Visible = true;
                            chkVehicleHomeNode.Checked = objCommlink.HomeNode;
                        }
                    }
                }
                else
                {
                    // Look for the selected Vehicle Weapon.
                    Vehicle objCurrentVehicle = null;

                    Weapon objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objCurrentVehicle);
                    if (objWeapon != null)
                    {
                        if (objWeapon.Cyberware || objWeapon.Category == "Gear" || objWeapon.Category.StartsWith("Quality") || objWeapon.IncludedInWeapon || !string.IsNullOrEmpty(objWeapon.ParentID))
                            cmdDeleteVehicle.Enabled = false;
                        lblVehicleWeaponName.Text = objWeapon.DisplayNameShort;
                        lblVehicleWeaponCategory.Text = objWeapon.DisplayCategory;
                        lblVehicleWeaponDamage.Text = objWeapon.CalculatedDamage();
                        lblVehicleWeaponAP.Text = objWeapon.TotalAP;
                        lblVehicleWeaponAmmo.Text = objWeapon.CalculatedAmmo();
                        lblVehicleWeaponMode.Text = objWeapon.CalculatedMode;
                        if (objWeapon.WeaponType == "Ranged")
                        {
                            cmdFireVehicleWeapon.Enabled = true;
                            cmdReloadVehicleWeapon.Enabled = true;
                            lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();

                            cmsVehicleAmmoSingleShot.Enabled = objWeapon.AllowMode("SS") || objWeapon.AllowMode("SA");
                            cmsVehicleAmmoShortBurst.Enabled = objWeapon.AllowMode("BF");
                            cmsVehicleAmmoLongBurst.Enabled = objWeapon.AllowMode("FA");
                            cmsVehicleAmmoFullBurst.Enabled = objWeapon.AllowMode("FA");
                            cmsVehicleAmmoSuppressiveFire.Enabled = objWeapon.AllowMode("FA");
                            if (cmsVehicleAmmoFullBurst.Enabled)
                                cmsVehicleAmmoFullBurst.Text = LanguageManager.GetString("String_FullBurst").Replace("{0}", objWeapon.FullBurst.ToString());
                            if (cmsVehicleAmmoSuppressiveFire.Enabled)
                                cmsVehicleAmmoSuppressiveFire.Text = LanguageManager.GetString("String_SuppressiveFire").Replace("{0}", objWeapon.Suppressive.ToString());

                            List<ListItem> lstAmmo = new List<ListItem>();
                            int intCurrentSlot = objWeapon.ActiveAmmoSlot;
                            for (int i = 1; i <= objWeapon.AmmoSlots; i++)
                            {
                                ListItem objAmmo = new ListItem();
                                objWeapon.ActiveAmmoSlot = i;
                                Gear objVehicleGear = CommonFunctions.DeepFindById(objWeapon.AmmoLoaded, objCurrentVehicle.Gear);
                                objAmmo.Value = i.ToString();

                                string strPlugins = string.Empty;
                                foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                                {
                                    foreach (Gear objCurrentAmmo in objVehicle.Gear)
                                    {
                                        if (objCurrentAmmo.InternalId == objWeapon.AmmoLoaded)
                                        {
                                            foreach (Gear objChild in objCurrentAmmo.Children)
                                            {
                                                strPlugins += objChild.DisplayNameShort + ", ";
                                            }
                                        }
                                    }
                                }
                                // Remove the trailing comma.
                                if (!string.IsNullOrEmpty(strPlugins))
                                    strPlugins = strPlugins.Substring(0, strPlugins.Length - 2);

                                if (objVehicleGear == null)
                                {
                                    if (objWeapon.AmmoRemaining == 0)
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_Empty");
                                    else
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_ExternalSource");
                                }
                                else
                                    objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + objVehicleGear.DisplayNameShort;
                                if (!string.IsNullOrEmpty(strPlugins))
                                    objAmmo.Name += " [" + strPlugins + "]";
                                lstAmmo.Add(objAmmo);
                            }
                            objWeapon.ActiveAmmoSlot = intCurrentSlot;
                            cboVehicleWeaponAmmo.BeginUpdate();
                            cboVehicleWeaponAmmo.Enabled = true;
                            cboVehicleWeaponAmmo.ValueMember = "Value";
                            cboVehicleWeaponAmmo.DisplayMember = "Name";
                            cboVehicleWeaponAmmo.DataSource = lstAmmo;
                            cboVehicleWeaponAmmo.SelectedValue = objWeapon.ActiveAmmoSlot.ToString();
                            if (cboVehicleWeaponAmmo.SelectedIndex == -1)
                                cboVehicleWeaponAmmo.SelectedIndex = 0;
                            cboVehicleWeaponAmmo.EndUpdate();
                        }
                        lblVehicleWeaponRangeMain.Text = objWeapon.Range;
                        lblVehicleWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                        Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                        lblVehicleWeaponRangeShort.Text = dictionaryRanges["short"];
                        lblVehicleWeaponRangeMedium.Text = dictionaryRanges["medium"];
                        lblVehicleWeaponRangeLong.Text = dictionaryRanges["long"];
                        lblVehicleWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                        lblVehicleWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                        lblVehicleWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                        lblVehicleWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                        lblVehicleWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];

                        lblVehicleName.Text = objWeapon.DisplayNameShort;
                        lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleWeapon");
                        lblVehicleAvail.Text = objWeapon.TotalAvail;
                        lblVehicleCost.Text = objWeapon.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblVehicleHandling.Text = string.Empty;
                        lblVehicleAccel.Text = string.Empty;
                        lblVehicleSpeed.Text = string.Empty;
                        lblVehicleDevice.Text = string.Empty;
                        lblVehiclePilot.Text = string.Empty;
                        lblVehicleBody.Text = string.Empty;
                        lblVehicleArmor.Text = string.Empty;
                        lblVehicleSensor.Text = string.Empty;
                        lblVehicleSlots.Text = string.Empty;
                        string strBook = _objOptions.LanguageBookShort(objWeapon.Source);
                        string strPage = objWeapon.Page;
                        lblVehicleSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objWeapon.Source) + " " + LanguageManager.GetString("String_Page") + " " + objWeapon.Page);

                        cmdVehicleMoveToInventory.Enabled = true;

                        // Determine the Dice Pool size.
                        int intPilot = objCurrentVehicle.Pilot;
                        int intAutosoft = 0;
                        foreach (Gear objAutosoft in objCurrentVehicle.Gear)
                        {
                            if (objAutosoft.Extra == objWeapon.DisplayCategory && (objAutosoft.Name == "[Weapon] Targeting Autosoft" || objAutosoft.Name == "[Weapon] Melee Autosoft"))
                            {
                                if (objAutosoft.Rating > intAutosoft)
                                {
                                    intAutosoft = objAutosoft.Rating;
                                }
                            }
                        }
                        if (intAutosoft == 0)
                            intPilot -= 1;
                        lblVehicleWeaponDicePool.Text = (intPilot + intAutosoft).ToString();
                    }
                    else
                    {
                        // See if this is a piece of Cyberware.
                        Cyberware objCyberware = CommonFunctions.FindVehicleCyberware(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                        if (objCyberware != null)
                        {
                            if (!string.IsNullOrEmpty(objCyberware.ParentID))
                                cmdDeleteCyberware.Enabled = false;
                            lblVehicleName.Text = objCyberware.DisplayNameShort;
                            lblVehicleRatingLabel.Text = LanguageManager.GetString("Label_Rating");
                            lblVehicleRating.Text = objCyberware.Rating.ToString();

                            cmdVehicleCyberwareChangeMount.Visible = !string.IsNullOrEmpty(objCyberware.PlugsIntoModularMount);
                            lblVehicleName.Text = objCyberware.DisplayNameShort;
                            lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleModification");
                            lblVehicleAvail.Text = objCyberware.TotalAvail;
                            lblVehicleCost.Text = objCyberware.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                            lblVehicleHandling.Text = string.Empty;
                            lblVehicleAccel.Text = string.Empty;
                            lblVehicleSpeed.Text = string.Empty;
                            lblVehicleDevice.Text = string.Empty;
                            lblVehiclePilot.Text = string.Empty;
                            lblVehicleBody.Text = string.Empty;
                            lblVehicleArmor.Text = string.Empty;
                            lblVehicleSensor.Text = string.Empty;
                            lblVehicleSlots.Text = string.Empty;
                            string strBook = _objOptions.LanguageBookShort(objCyberware.Source);
                            string strPage = objCyberware.Page;
                            lblVehicleSource.Text = strBook + " " + strPage;
                            tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objCyberware.Source) + " " + LanguageManager.GetString("String_Page") + " " + objCyberware.Page);
                        }
                    }
                }
                chkVehicleWeaponAccessoryInstalled.Enabled = false;
                chkVehicleIncludedInWeapon.Checked = false;
            }
            else if (treVehicles.SelectedNode.Level >= 4)
            {
                panVehicleCM.Visible = true;
                Gear objGear = CommonFunctions.FindVehicleGear(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                if (objGear != null)
                {
                    if (objGear.IncludedInParent)
                        cmdDeleteVehicle.Enabled = false;
                    lblVehicleRating.Text = string.Empty;
                    if (objGear.InternalId == treVehicles.SelectedNode.Tag.ToString())
                    {
                        lblVehicleGearQty.Text = objGear.Quantity.ToString();
                        cmdVehicleGearReduceQty.Enabled = !objGear.DisableQuantity;

                        if (objGear.Rating > 0)
                            lblVehicleRating.Text = objGear.Rating.ToString();
                    }

                    lblVehicleName.Text = objGear.DisplayNameShort;
                    lblVehicleCategory.Text = objGear.DisplayCategory;
                    lblVehicleAvail.Text = objGear.TotalAvail(true);
                    lblVehicleCost.Text = objGear.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                    lblVehicleHandling.Text = string.Empty;
                    lblVehicleAccel.Text = string.Empty;
                    lblVehicleSpeed.Text = string.Empty;
                    lblVehicleDevice.Text = string.Empty;
                    lblVehiclePilot.Text = string.Empty;
                    lblVehicleBody.Text = string.Empty;
                    lblVehicleArmor.Text = string.Empty;
                    lblVehicleSensor.Text = string.Empty;
                    lblVehicleSlots.Text = objGear.CalculatedCapacity + " (" + objGear.CapacityRemaining.ToString("#,0.##", GlobalOptions.CultureInfo) + " " + LanguageManager.GetString("String_Remaining") + ")";
                    string strBook = _objOptions.LanguageBookShort(objGear.Source);
                    string strPage = objGear.Page;
                    lblVehicleSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objGear.Source) + " " + LanguageManager.GetString("String_Page") + " " + objGear.Page);

                    if (objGear.GetType() == typeof(Commlink))
                    {
                        Commlink objCommlink = (Commlink)objGear;
                        lblVehicleDevice.Text = objCommlink.DeviceRating.ToString();
                        objCommlink.RefreshCommlinkCBOs(cboVehicleGearAttack, cboVehicleGearSleaze, cboVehicleGearDataProcessing, cboVehicleGearFirewall);
                        if (_objCharacter.Metatype == "A.I.")
                        {
                            chkVehicleHomeNode.Visible = true;
                            chkVehicleHomeNode.Checked = objCommlink.HomeNode;
                        }
                    }
                }
                else
                {
                    // Locate the the Selected Vehicle Weapon Accessory of Modification.
                    Weapon objWeapon = null;
                    WeaponAccessory objAccessory = CommonFunctions.FindVehicleWeaponAccessory(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
                    if (objAccessory != null)
                    {
                        objWeapon = objAccessory.Parent;
                        if (objAccessory.IncludedInWeapon)
                            cmdDeleteVehicle.Enabled = false;
                        lblVehicleName.Text = objAccessory.DisplayNameShort;
                        lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleWeaponAccessory");
                        lblVehicleAvail.Text = objAccessory.TotalAvail;
                        lblVehicleCost.Text = objAccessory.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblVehicleHandling.Text = string.Empty;
                        lblVehicleAccel.Text = string.Empty;
                        lblVehicleSpeed.Text = string.Empty;
                        lblVehicleDevice.Text = string.Empty;
                        lblVehiclePilot.Text = string.Empty;
                        lblVehicleBody.Text = string.Empty;
                        lblVehicleArmor.Text = string.Empty;
                        lblVehicleSensor.Text = string.Empty;

                        string[] strMounts = objAccessory.Mount.Split('/');
                        string strMount = string.Empty;
                        foreach (string strCurrentMount in strMounts)
                        {
                            if (!string.IsNullOrEmpty(strCurrentMount))
                                strMount += LanguageManager.GetString("String_Mount" + strCurrentMount) + "/";
                        }
                        // Remove the trailing /
                        if (!string.IsNullOrEmpty(strMount) && strMount.Contains('/'))
                            strMount = strMount.Substring(0, strMount.Length - 1);
                        if (!string.IsNullOrEmpty(objAccessory.ExtraMount) && (objAccessory.ExtraMount != "None"))
                        {
                            bool boolHaveAddedItem = false;
                            string[] strExtraMounts = objAccessory.ExtraMount.Split('/');
                            foreach (string strCurrentExtraMount in strExtraMounts)
                            {
                                if (!string.IsNullOrEmpty(strCurrentExtraMount))
                                {
                                    if (!boolHaveAddedItem)
                                    {
                                        strMount += " + ";
                                        boolHaveAddedItem = true;
                                    }
                                    strMount += LanguageManager.GetString("String_Mount" + strCurrentExtraMount) + "/";
                                }
                            }
                            // Remove the trailing /
                            if (boolHaveAddedItem)
                            strMount = strMount.Substring(0, strMount.Length - 1);
                        }

                        lblVehicleSlots.Text = strMount;
                        string strBook = _objOptions.LanguageBookShort(objAccessory.Source);
                        string strPage = objAccessory.Page;
                        lblVehicleSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objAccessory.Source) + " " + LanguageManager.GetString("String_Page") + " " + objAccessory.Page);
                        chkVehicleWeaponAccessoryInstalled.Enabled = true;
                        chkVehicleWeaponAccessoryInstalled.Checked = objAccessory.Installed;
                        chkVehicleIncludedInWeapon.Checked = objAccessory.IncludedInWeapon;

                        lblVehicleWeaponRangeMain.Text = objWeapon.Range;
                        lblVehicleWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                        Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                        lblVehicleWeaponRangeShort.Text = dictionaryRanges["short"];
                        lblVehicleWeaponRangeMedium.Text = dictionaryRanges["medium"];
                        lblVehicleWeaponRangeLong.Text = dictionaryRanges["long"];
                        lblVehicleWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                        lblVehicleWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                        lblVehicleWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                        lblVehicleWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                        lblVehicleWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];

                        cmdFireVehicleWeapon.Enabled = false;
                        cmdReloadVehicleWeapon.Enabled = false;
                        cboVehicleWeaponAmmo.Enabled = false;
                    }
                    else
                    {
                            // If it's none of these, it must be an Underbarrel Weapon.
                            Vehicle objCurrentVehicle = null;
                        objWeapon = CommonFunctions.FindVehicleWeapon(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles, out objCurrentVehicle);

                        if (objWeapon.Cyberware || objWeapon.Category == "Gear" || objWeapon.Category.StartsWith("Quality") || objWeapon.IncludedInWeapon || !string.IsNullOrEmpty(objWeapon.ParentID))
                            cmdDeleteVehicle.Enabled = false;
                        lblVehicleWeaponName.Text = objWeapon.DisplayNameShort;
                            lblVehicleWeaponCategory.Text = objWeapon.DisplayCategory;
                            lblVehicleWeaponDamage.Text = objWeapon.CalculatedDamage();
                            lblVehicleWeaponAP.Text = objWeapon.TotalAP;
                            lblVehicleWeaponAmmo.Text = objWeapon.CalculatedAmmo();
                            lblVehicleWeaponMode.Text = objWeapon.CalculatedMode;
                            if (objWeapon.WeaponType == "Ranged")
                            {
                                cmdFireVehicleWeapon.Enabled = true;
                                cmdReloadVehicleWeapon.Enabled = true;
                                lblVehicleWeaponAmmoRemaining.Text = objWeapon.AmmoRemaining.ToString();

                            cmsVehicleAmmoSingleShot.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeSingleShot")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeSemiAutomatic"));
                            cmsVehicleAmmoShortBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeBurstFire")) || objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoLongBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoFullBurst.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));
                            cmsVehicleAmmoSuppressiveFire.Enabled = objWeapon.AllowMode(LanguageManager.GetString("String_ModeFullAutomatic"));

                            if (cmsVehicleAmmoFullBurst.Enabled)
                                    cmsVehicleAmmoFullBurst.Text = LanguageManager.GetString("String_FullBurst").Replace("{0}", objWeapon.FullBurst.ToString());
                                if (cmsVehicleAmmoSuppressiveFire.Enabled)
                                    cmsVehicleAmmoSuppressiveFire.Text = LanguageManager.GetString("String_SuppressiveFire").Replace("{0}", objWeapon.Suppressive.ToString());
                            }

                            List<ListItem> lstAmmo = new List<ListItem>();
                            int intCurrentSlot = objWeapon.ActiveAmmoSlot;
                            for (int i = 1; i <= objWeapon.AmmoSlots; i++)
                            {
                                ListItem objAmmo = new ListItem();
                                objWeapon.ActiveAmmoSlot = i;
                            Gear objVehicleGear = CommonFunctions.DeepFindById(objWeapon.AmmoLoaded, objCurrentVehicle.Gear);
                                objAmmo.Value = i.ToString();

                            string strPlugins = string.Empty;
                                foreach (Vehicle objVehicle in _objCharacter.Vehicles)
                                {
                                    foreach (Gear objCurrentAmmo in objVehicle.Gear)
                                    {
                                        if (objCurrentAmmo.InternalId == objWeapon.AmmoLoaded)
                                        {
                                            foreach (Gear objChild in objCurrentAmmo.Children)
                                            {
                                                strPlugins += objChild.DisplayNameShort + ", ";
                                            }
                                        }
                                    }
                                }
                                // Remove the trailing comma.
                            if (!string.IsNullOrEmpty(strPlugins))
                                    strPlugins = strPlugins.Substring(0, strPlugins.Length - 2);

                                if (objVehicleGear == null)
                                {
                                    if (objWeapon.AmmoRemaining == 0)
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_Empty");
                                    else
                                        objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + LanguageManager.GetString("String_ExternalSource");
                                }
                                else
                                    objAmmo.Name = LanguageManager.GetString("String_SlotNumber").Replace("{0}", i.ToString()) + " " + objVehicleGear.DisplayNameShort;

                            if (!string.IsNullOrEmpty(strPlugins))
                                    objAmmo.Name += " [" + strPlugins + "]";
                                lstAmmo.Add(objAmmo);
                            }
                            objWeapon.ActiveAmmoSlot = intCurrentSlot;
                        cboVehicleWeaponAmmo.BeginUpdate();
                            cboVehicleWeaponAmmo.Enabled = true;
                            cboVehicleWeaponAmmo.ValueMember = "Value";
                            cboVehicleWeaponAmmo.DisplayMember = "Name";
                            cboVehicleWeaponAmmo.DataSource = lstAmmo;
                            cboVehicleWeaponAmmo.SelectedValue = objWeapon.ActiveAmmoSlot.ToString();
                            if (cboVehicleWeaponAmmo.SelectedIndex == -1)
                                cboVehicleWeaponAmmo.SelectedIndex = 0;
                        cboVehicleWeaponAmmo.EndUpdate();

                        lblVehicleWeaponRangeMain.Text = objWeapon.Range;
                        lblVehicleWeaponRangeAlternate.Text = objWeapon.AlternateRange;
                        Dictionary<string, string> dictionaryRanges = objWeapon.GetRangeStrings(GlobalOptions.CultureInfo);
                        lblVehicleWeaponRangeShort.Text = dictionaryRanges["short"];
                        lblVehicleWeaponRangeMedium.Text = dictionaryRanges["medium"];
                        lblVehicleWeaponRangeLong.Text = dictionaryRanges["long"];
                        lblVehicleWeaponRangeExtreme.Text = dictionaryRanges["extreme"];
                        lblVehicleWeaponAlternateRangeShort.Text = dictionaryRanges["alternateshort"];
                        lblVehicleWeaponAlternateRangeMedium.Text = dictionaryRanges["alternatemedium"];
                        lblVehicleWeaponAlternateRangeLong.Text = dictionaryRanges["alternatelong"];
                        lblVehicleWeaponAlternateRangeExtreme.Text = dictionaryRanges["alternateextreme"];

                        lblVehicleName.Text = objWeapon.DisplayNameShort;
                            lblVehicleCategory.Text = LanguageManager.GetString("String_VehicleWeapon");
                            lblVehicleAvail.Text = objWeapon.TotalAvail;
                        lblVehicleCost.Text = objWeapon.TotalCost.ToString(_objCharacter.Options.NuyenFormat, GlobalOptions.CultureInfo) + '¥';
                        lblVehicleHandling.Text = string.Empty;
                        lblVehicleAccel.Text = string.Empty;
                        lblVehicleSpeed.Text = string.Empty;
                        lblVehicleDevice.Text = string.Empty;
                        lblVehiclePilot.Text = string.Empty;
                        lblVehicleBody.Text = string.Empty;
                        lblVehicleArmor.Text = string.Empty;
                        lblVehicleSensor.Text = string.Empty;
                        lblVehicleSlots.Text = string.Empty;
                            string strBook = _objOptions.LanguageBookShort(objWeapon.Source);
                            string strPage = objWeapon.Page;
                            lblVehicleSource.Text = strBook + " " + strPage;
                            chkVehicleWeaponAccessoryInstalled.Enabled = true;
                            chkVehicleWeaponAccessoryInstalled.Checked = objWeapon.Installed;
                            tipTooltip.SetToolTip(lblVehicleSource, _objOptions.LanguageBookLong(objWeapon.Source) + " " + LanguageManager.GetString("String_Page") + " " + objWeapon.Page);

                            // Determine the Dice Pool size.
                            int intPilot = objCurrentVehicle.Pilot;
                            int intAutosoft = 0;
                        foreach (Gear objAutosoft in objCurrentVehicle.Gear)
                        {
                            if (objAutosoft.Extra == objWeapon.DisplayCategory && (objAutosoft.Name == "[Weapon] Targeting Autosoft" || objAutosoft.Name == "[Weapon] Melee Autosoft"))
                            {
                                if (objAutosoft.Rating > intAutosoft)
                                {
                                    intAutosoft = objAutosoft.Rating;
                                }
                            }
                        }
                        if (intAutosoft == 0)
                            intPilot -= 1;
                        lblVehicleWeaponDicePool.Text = (intPilot + intAutosoft).ToString();
                    }
                }
            }
            else
                panVehicleCM.Visible = false;
            _blnSkipRefresh = false;
        }

        /// <summary>
        /// Populate the Expense Log Lists.
        /// </summary>
        public void PopulateExpenseList()
        {
            lstKarma.Items.Clear();
            lstNuyen.Items.Clear();
            lstKarma.ContextMenuStrip = null;
            lstNuyen.ContextMenuStrip = null;
            foreach (ExpenseLogEntry objExpense in _objCharacter.ExpenseEntries)
            {
                bool blnAdd = true;
                if (objExpense.Amount == 0)
                {
                    if (objExpense.Type == ExpenseType.Nuyen)
                    {
                        blnAdd = chkShowFreeNuyen.Checked;
                    }
                    else if (objExpense.Type == ExpenseType.Karma)
                    {
                        blnAdd = chkShowFreeKarma.Checked;
                    }
                }
                if (blnAdd)
                {
                    ListViewItem objItem = new ListViewItem();
                    objItem.Text = objExpense.Date.ToShortDateString() + " " + objExpense.Date.ToShortTimeString();
                    ListViewItem.ListViewSubItem objAmountItem = new ListViewItem.ListViewSubItem();
                    objAmountItem.Text = objExpense.Amount.ToString(objExpense.Type == ExpenseType.Nuyen ? _objCharacter.Options.NuyenFormat : "#,0.##", GlobalOptions.CultureInfo);
                    ListViewItem.ListViewSubItem objReasonItem = new ListViewItem.ListViewSubItem();
                    objReasonItem.Text = objExpense.Reason;
                    ListViewItem.ListViewSubItem objInternalIdItem = new ListViewItem.ListViewSubItem();
                    objInternalIdItem.Text = objExpense.InternalId;

                    if (objExpense.Type == ExpenseType.Nuyen)
                    {
                        objAmountItem.Text += "¥";
                    }

                    objItem.SubItems.Add(objAmountItem);
                    objItem.SubItems.Add(objReasonItem);
                    objItem.SubItems.Add(objInternalIdItem);

                    if (objExpense.Type == ExpenseType.Nuyen)
                    {
                        lstNuyen.Items.Add(objItem);
                        if (objExpense.Undo != null)
                            lstNuyen.ContextMenuStrip = cmsUndoNuyenExpense;
                    }
                    else
                    {
                        lstKarma.Items.Add(objItem);
                        if (objExpense.Undo != null)
                            lstKarma.ContextMenuStrip = cmsUndoKarmaExpense;
                    }
                }
            }
            lstKarma.Sort();
            lstNuyen.Sort();

            // Charting test for Expenses.
            chtKarma.Series.Clear();
            chtNuyen.Series.Clear();

            // Setup the series used for charts.
            Series objKarmaSeries = new Series
            {
                Name = "Series1",
                Color = Color.Blue,
                IsVisibleInLegend = false,
                IsXValueIndexed = false,
                ChartType = SeriesChartType.Area
            };
            Series objNuyenSeries = new Series
            {
                Name = "Series1",
                Color = Color.Green,
                IsVisibleInLegend = false,
                IsXValueIndexed = false,
                ChartType = SeriesChartType.Area
            };

            // Configure the Karma chart.
            chtKarma.Series.Add(objKarmaSeries);
            chtKarma.ChartAreas[0].AxisX.LabelStyle.Enabled = false;
            chtKarma.ChartAreas[0].AxisY.Title = "Karma Remaining";
            chtKarma.ChartAreas[0].AxisX.Minimum = 0;

            // Configure the Nuyen chart.
            chtNuyen.Series.Add(objNuyenSeries);
            chtNuyen.ChartAreas[0].AxisX.LabelStyle.Enabled = false;
            chtNuyen.ChartAreas[0].AxisY.Title = "Nuyen Remaining";
            chtNuyen.ChartAreas[0].AxisX.Minimum = 0;


            //Find the first karma/nuyen entry
            DateTime KarmaFirst = DateTime.MaxValue;
            DateTime NuyenFirst = DateTime.MaxValue;
            foreach (ExpenseLogEntry objExpense in _objCharacter.ExpenseEntries)
            {
                if (objExpense.Type == ExpenseType.Karma)
                {
                    if (objExpense.Date.CompareTo(KarmaFirst) < 0)
                    {
                        KarmaFirst = objExpense.Date;
                    }
                }
                else
                {
                    if (objExpense.Date.CompareTo(NuyenFirst) < 0)
                    {
                        NuyenFirst = objExpense.Date;
                    }
                }
            }

            //Problem data isen't ordered so we have to sort it anyway
            _objCharacter.ExpenseEntries.Sort(delegate(ExpenseLogEntry e1, ExpenseLogEntry e2)
            {
                if (e1 == null && e2 == null) return 0;
                if (e1 == null) return -1;
                if (e2 == null) return 1;

                if (e1.Date == null && e2.Date == null) return 0;
                if (e1.Date == null) return -1;
                if (e2.Date == null) return 1;

                return e1.Date.CompareTo(e2.Date);
            });

            double doubleKarmaX = 0;
            double doubleNuyenX = 0;
            double dblKarmaValue = 0;
            double dblNuyenValue = 0;
            foreach (ExpenseLogEntry objExpense in _objCharacter.ExpenseEntries)
            {
                if (objExpense.Type == ExpenseType.Karma)
                {
                    double seconds = (objExpense.Date - KarmaFirst).TotalDays;
                    if (seconds > doubleKarmaX) doubleKarmaX = seconds;
                    dblKarmaValue += decimal.ToDouble(objExpense.Amount);
                    objKarmaSeries.Points.AddXY(seconds, dblKarmaValue);
                }
                else
                {
                    double seconds = (objExpense.Date - NuyenFirst).TotalDays;
                    if (seconds > doubleNuyenX) doubleNuyenX = seconds;
                    dblNuyenValue += decimal.ToDouble(objExpense.Amount);
                    objNuyenSeries.Points.AddXY(seconds, dblNuyenValue);
                }
            }
            

            chtKarma.ChartAreas[0].AxisX.Maximum = doubleKarmaX;
            chtNuyen.ChartAreas[0].AxisX.Maximum = doubleNuyenX;
            //chtKarma.ChartAreas[0].AxisX.MaximumAutoSize = 100;
            chtKarma.Invalidate();
            chtNuyen.Invalidate();
        }

        /// <summary>
        /// Populate the Calendar List.
        /// </summary>
        public void PopulateCalendar()
        {
            lstCalendar.Items.Clear();
            for (int i = _objCharacter.Calendar.Count - 1; i >= 0; i--)
            {
                CalendarWeek objWeek = _objCharacter.Calendar[i];
                ListViewItem objItem = new ListViewItem();
                objItem.Text = objWeek.DisplayName;
                ListViewItem.ListViewSubItem objNoteItem = new ListViewItem.ListViewSubItem();
                objNoteItem.Text = objWeek.Notes;
                ListViewItem.ListViewSubItem objInternalIdItem = new ListViewItem.ListViewSubItem();
                objInternalIdItem.Text = objWeek.InternalId;

                objItem.SubItems.Add(objNoteItem);
                objItem.SubItems.Add(objInternalIdItem);

                lstCalendar.Items.Add(objItem);
            }
        }

        /// <summary>
        /// Verify that the user wants to spend their Karma and did not accidentally click the button.
        /// </summary>
        public bool ConfirmKarmaExpense(string strMessage)
        {
            if (!_objOptions.ConfirmKarmaExpense)
                return true;
            else
            {
                if (MessageBox.Show(strMessage, LanguageManager.GetString("MessageTitle_ConfirmKarmaExpense"), MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                    return false;
                else
                    return true;
            }
        }

        /// <summary>
        /// Dummy method to trap the Options MRUChanged Event.
        /// </summary>
        public void PopulateMRU()
        {
        }

        /// <summary>
        /// Update the contents of the Initiation Grade list.
        /// </summary>
        public void UpdateInitiationGradeTree()
        {
            treMetamagic.Nodes.Clear();
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                TreeNode nodGrade = treMetamagic.Nodes.Add(objGrade.Grade.ToString(), objGrade.Text);
                nodGrade.Tag = objGrade.InternalId;
                nodGrade.ContextMenuStrip = cmsMetamagic;
                if (!string.IsNullOrEmpty(objGrade.Notes))
                    nodGrade.ForeColor = Color.SaddleBrown;
                nodGrade.ToolTipText = CommonFunctions.WordWrap(objGrade.Notes, 100);

                foreach (Art objArt in _objCharacter.Arts)
                {
                    if (objArt.Grade == objGrade.Grade)
                    {
                        TreeNode nodArt = nodGrade.Nodes.Add(objArt.InternalId, LanguageManager.GetString("Label_Art") + " " + objArt.DisplayName);
                        nodArt.Tag = objArt.InternalId;
                        nodArt.ContextMenuStrip = cmsInitiationNotes;
                        if (!string.IsNullOrEmpty(objArt.Notes))
                            nodArt.ForeColor = Color.SaddleBrown;
                        nodArt.ToolTipText = CommonFunctions.WordWrap(objArt.Notes, 100);
                    }
                }
                foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
                {
                    if (objMetamagic.Grade == objGrade.Grade)
                    {
                        string strName = string.Empty;
                        if (_objCharacter.MAGEnabled)
                            strName = LanguageManager.GetString("Label_Metamagic") + " " + objMetamagic.DisplayName;
                        else
                            strName = LanguageManager.GetString("Label_Echo") + " " + objMetamagic.DisplayName;
                        TreeNode nodMetamagic = nodGrade.Nodes.Add(objMetamagic.InternalId, strName);
                        nodMetamagic.Tag = objMetamagic.InternalId;
                        nodMetamagic.ContextMenuStrip = cmsInitiationNotes;
                        if (!string.IsNullOrEmpty(objMetamagic.Notes))
                            nodMetamagic.ForeColor = Color.SaddleBrown;
                        nodMetamagic.ToolTipText = CommonFunctions.WordWrap(objMetamagic.Notes, 100);
                    }
                }
                foreach (Spell objSpell in _objCharacter.Spells)
                {
                    if (objSpell.Grade == objGrade.Grade)
                    {
                        string strCategory = string.Empty;
                        if (objSpell.Category == "Rituals")
                            strCategory = LanguageManager.GetString("Label_Ritual") + " ";
                        if (objSpell.Category == "Enchantments")
                            strCategory = LanguageManager.GetString("Label_Enchantment") + " ";
                        TreeNode nodSpell = nodGrade.Nodes.Add(objSpell.InternalId, strCategory + " " + objSpell.DisplayName);
                        nodSpell.Tag = objSpell.InternalId;
                        nodSpell.ContextMenuStrip = cmsInitiationNotes;
                        if (!string.IsNullOrEmpty(objSpell.Notes))
                            nodSpell.ForeColor = Color.SaddleBrown;
                        nodSpell.ToolTipText = CommonFunctions.WordWrap(objSpell.Notes, 100);
                    }
                }
                foreach (Enhancement objEnhancement in _objCharacter.Enhancements)
                {
                    if (objEnhancement.Grade == objGrade.Grade)
                    {
                        TreeNode nodEnhancement = nodGrade.Nodes.Add(objEnhancement.InternalId, LanguageManager.GetString("Label_Enhancement") + " " + objEnhancement.DisplayName);
                        nodEnhancement.Tag = objEnhancement.InternalId;
                        nodEnhancement.ContextMenuStrip = cmsInitiationNotes;
                        if (!string.IsNullOrEmpty(objEnhancement.Notes))
                            nodEnhancement.ForeColor = Color.SaddleBrown;
                        nodEnhancement.ToolTipText = CommonFunctions.WordWrap(objEnhancement.Notes, 100);
                    }
                }
                foreach (Power objPower in _objCharacter.Powers)
                {
                    foreach (Enhancement objEnhancement in objPower.Enhancements)
                    {
                        if (objEnhancement.Grade == objGrade.Grade)
                        {
                            TreeNode nodEnhancement = nodGrade.Nodes.Add(objEnhancement.InternalId, LanguageManager.GetString("Label_Enhancement") + " " + objEnhancement.DisplayName);
                            nodEnhancement.Tag = objEnhancement.InternalId;
                            nodEnhancement.ContextMenuStrip = cmsInitiationNotes;
                            if (!string.IsNullOrEmpty(objEnhancement.Notes))
                                nodEnhancement.ForeColor = Color.SaddleBrown;
                            nodEnhancement.ToolTipText = CommonFunctions.WordWrap(objEnhancement.Notes, 100);
                        }
                    }
                }
            }
            foreach (Metamagic objMetamagic in _objCharacter.Metamagics.Where(x => x.Grade < 0))
            {
                string strName = string.Empty;
                if (_objCharacter.MAGEnabled)
                    strName = LanguageManager.GetString("Label_Metamagic") + " " + objMetamagic.DisplayName;
                else
                    strName = LanguageManager.GetString("Label_Echo") + " " + objMetamagic.DisplayName;
                TreeNode nodMetamagic = treMetamagic.Nodes.Add(objMetamagic.InternalId, strName);
                nodMetamagic.Tag = objMetamagic.InternalId;
                nodMetamagic.ContextMenuStrip = cmsInitiationNotes;
                if (!string.IsNullOrEmpty(objMetamagic.Notes))
                    nodMetamagic.ForeColor = Color.SaddleBrown;
                else
                    nodMetamagic.ForeColor = SystemColors.GrayText;
                nodMetamagic.ToolTipText = CommonFunctions.WordWrap(objMetamagic.Notes, 100);
            }
            treMetamagic.ExpandAll();
            UpdateInitiationCost();
        }

        /// <summary>
        /// Update the karma cost tooltip for Initiation/Submersion.
        /// </summary>
        private void UpdateInitiationCost()
        {
            decimal decMultiplier = 1.0m;
            int intAmount = 0;
            string strInitTip = string.Empty;

            if (_objCharacter.MAGEnabled)
            {
                if (chkInitiationGroup.Checked)
                    decMultiplier -= 0.1m;
                if (chkInitiationOrdeal.Checked)
                    decMultiplier -= 0.1m;
                if (chkInitiationSchooling.Checked)
                    decMultiplier -= 0.1m;
                intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.InitiateGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                strInitTip = LanguageManager.GetString("Tip_ImproveInitiateGrade").Replace("{0}", (_objCharacter.InitiateGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
            }
            else
            {
                if (chkInitiationGroup.Checked)
                    decMultiplier -= 0.2m;
                if (chkInitiationOrdeal.Checked)
                    decMultiplier -= 0.2m;
                if (chkInitiationSchooling.Checked)
                    decMultiplier -= 0.1m;
                intAmount = decimal.ToInt32(decimal.Ceiling(Convert.ToDecimal(_objOptions.KarmaInititationFlat + (_objCharacter.SubmersionGrade + 1) * _objOptions.KarmaInitiation, GlobalOptions.InvariantCultureInfo) * decMultiplier));

                strInitTip = LanguageManager.GetString("Tip_ImproveSubmersionGrade").Replace("{0}", (_objCharacter.SubmersionGrade + 1).ToString()).Replace("{1}", intAmount.ToString());
            }

            tipTooltip.SetToolTip(cmdAddMetamagic, strInitTip);
        }

        /// <summary>
        /// Update the character's Mentor Spirit/Paragon information.
        /// </summary>
        private void UpdateMentorSpirits()
        {
            MentorSpirit objMentor = _objCharacter.MentorSpirits.FirstOrDefault();

            if (objMentor == null)
            {
                lblMentorSpiritLabel.Visible = false;
                lblMentorSpirit.Visible = false;
                lblMentorSpiritInformation.Visible = false;
            }
            else
            {
                lblMentorSpiritLabel.Visible = true;
                lblMentorSpirit.Visible = true;
                lblMentorSpiritInformation.Visible = true;
                lblMentorSpirit.Text = objMentor.DisplayName;
                lblMentorSpiritInformation.Text = LanguageManager.GetString("Label_SelectMentorSpirit_Advantage") + " " +
                                   objMentor.DisplayAdvantage + "\n\n" +
                                   LanguageManager.GetString("Label_SelectMetamagic_Disadvantage") + " " +
                                   objMentor.Disadvantage;
            }
        }

        /// <summary>
        /// Set the ToolTips from the Language file.
        /// </summary>
        private void SetTooltips()
        {
            // Spells Tab.
            tipTooltip.SetToolTip(cmdRollSpell, LanguageManager.GetString("Tip_DiceRoller"));
            tipTooltip.SetToolTip(cmdRollDrain, LanguageManager.GetString("Tip_DiceRoller"));
            // Complex Forms Tab.
            tipTooltip.SetToolTip(cmdRollFading, LanguageManager.GetString("Tip_DiceRoller"));
            // Lifestyle Tab.
            tipTooltip.SetToolTip(cmdIncreaseLifestyleMonths, LanguageManager.GetString("Tab_IncreaseLifestyleMonths"));
            tipTooltip.SetToolTip(cmdDecreaseLifestyleMonths, LanguageManager.GetString("Tab_DecreaseLifestyleMonths"));
            // Armor Tab.
            tipTooltip.SetToolTip(chkArmorEquipped, LanguageManager.GetString("Tip_ArmorEquipped"));
            // tipTooltip.SetToolTip(cmdArmorIncrease, LanguageManager.GetString("Tip_ArmorDegradationAPlus"));
            // tipTooltip.SetToolTip(cmdArmorDecrease, LanguageManager.GetString("Tip_ArmorDegradationAMinus"));
            // Weapon Tab.
            tipTooltip.SetToolTip(chkWeaponAccessoryInstalled, LanguageManager.GetString("Tip_WeaponInstalled"));
            tipTooltip.SetToolTip(cmdWeaponBuyAmmo, LanguageManager.GetString("Tip_BuyAmmo"));
            tipTooltip.SetToolTip(cmdWeaponMoveToVehicle, LanguageManager.GetString("Tip_TransferToVehicle"));
            tipTooltip.SetToolTip(cmdRollWeapon, LanguageManager.GetString("Tip_DiceRoller"));
            // Gear Tab.
            tipTooltip.SetToolTip(cmdGearIncreaseQty, LanguageManager.GetString("Tip_IncreaseGearQty"));
            tipTooltip.SetToolTip(cmdGearReduceQty, LanguageManager.GetString("Tip_DecreaseGearQty"));
            tipTooltip.SetToolTip(cmdGearSplitQty, LanguageManager.GetString("Tip_SplitGearQty"));
            tipTooltip.SetToolTip(cmdGearMergeQty, LanguageManager.GetString("Tip_MergeGearQty"));
            tipTooltip.SetToolTip(cmdGearMoveToVehicle, LanguageManager.GetString("Tip_TransferToVehicle"));
            tipTooltip.SetToolTip(chkActiveCommlink, LanguageManager.GetString("Tip_ActiveCommlink"));
            // Vehicles Tab.
            tipTooltip.SetToolTip(chkVehicleWeaponAccessoryInstalled, LanguageManager.GetString("Tip_WeaponInstalled"));
            tipTooltip.SetToolTip(cmdVehicleGearReduceQty, LanguageManager.GetString("Tip_DecreaseGearQty"));
            tipTooltip.SetToolTip(cmdVehicleMoveToInventory, LanguageManager.GetString("Tip_TransferToInventory"));
            tipTooltip.SetToolTip(cmdRollVehicleWeapon, LanguageManager.GetString("Tip_DiceRoller"));
            // Other Info Tab.
            tipTooltip.SetToolTip(lblCMPhysicalLabel, LanguageManager.GetString("Tip_OtherCMPhysical"));
            tipTooltip.SetToolTip(lblCMStunLabel, LanguageManager.GetString("Tip_OtherCMStun"));
            tipTooltip.SetToolTip(lblINILabel, LanguageManager.GetString("Tip_OtherInitiative"));
            tipTooltip.SetToolTip(lblMatrixINILabel, LanguageManager.GetString("Tip_OtherMatrixInitiative"));
            tipTooltip.SetToolTip(lblAstralINILabel, LanguageManager.GetString("Tip_OtherAstralInitiative"));
            tipTooltip.SetToolTip(lblArmorLabel, LanguageManager.GetString("Tip_OtherArmor"));
            tipTooltip.SetToolTip(lblESS, LanguageManager.GetString("Tip_OtherEssence"));
            tipTooltip.SetToolTip(lblRemainingNuyenLabel, LanguageManager.GetString("Tip_OtherNuyen"));
            tipTooltip.SetToolTip(lblCareerKarmaLabel, LanguageManager.GetString("Tip_OtherCareerKarma"));
            tipTooltip.SetToolTip(lblMovementLabel, LanguageManager.GetString("Tip_OtherMovement"));
            tipTooltip.SetToolTip(lblSwimLabel, LanguageManager.GetString("Tip_OtherSwim"));
            tipTooltip.SetToolTip(lblFlyLabel, LanguageManager.GetString("Tip_OtherFly"));
            tipTooltip.SetToolTip(lblComposureLabel, LanguageManager.GetString("Tip_OtherComposure"));
            tipTooltip.SetToolTip(lblJudgeIntentionsLabel, LanguageManager.GetString("Tip_OtherJudgeIntentions"));
            tipTooltip.SetToolTip(lblLiftCarryLabel, LanguageManager.GetString("Tip_OtherLiftAndCarry"));
            tipTooltip.SetToolTip(lblMemoryLabel, LanguageManager.GetString("Tip_OtherMemory"));
            // Condition Monitor Tab.
            tipTooltip.SetToolTip(lblCMPenaltyLabel, LanguageManager.GetString("Tip_CMCMPenalty"));
            tipTooltip.SetToolTip(lblCMArmorLabel, LanguageManager.GetString("Tip_OtherArmor"));
            tipTooltip.SetToolTip(lblCMDamageResistancePoolLabel, LanguageManager.GetString("Tip_CMDamageResistance"));
            tipTooltip.SetToolTip(cmdEdgeGained, LanguageManager.GetString("Tip_CMRegainEdge"));
            tipTooltip.SetToolTip(cmdEdgeSpent, LanguageManager.GetString("Tip_CMSpendEdge"));
            // Common Info Tab.
            tipTooltip.SetToolTip(lblStreetCred, LanguageManager.GetString("Tip_StreetCred"));
            tipTooltip.SetToolTip(lblNotoriety, LanguageManager.GetString("Tip_Notoriety"));
            if (_objOptions.UseCalculatedPublicAwareness)
            {
                tipTooltip.SetToolTip(lblPublicAware, LanguageManager.GetString("Tip_PublicAwareness"));
            }
            tipTooltip.SetToolTip(cmdBurnStreetCred, LanguageManager.GetString("Tip_BurnStreetCred"));

            // Reposition controls based on their new sizes.
            // Common Tab.
            txtAlias.Left = lblAlias.Left + lblAlias.Width + 6;
            txtAlias.Width = lblMetatypeLabel.Left - 6 - txtAlias.Left;
            cmdSwapQuality.Left = cmdAddQuality.Left + cmdAddQuality.Width + 6;
            cmdDeleteQuality.Left = cmdSwapQuality.Left + cmdSwapQuality.Width + 6;
            // Martial Arts Tab.
            cmdDeleteMartialArt.Left = cmdAddMartialArt.Left + cmdAddMartialArt.Width + 6;
            // Magician Tab.
            cmdDeleteSpell.Left = cmdAddSpell.Left + cmdAddSpell.Width + 6;
            // Technomancer Tab.
            cmdDeleteComplexForm.Left = cmdAddComplexForm.Left + cmdAddComplexForm.Width + 6;
            // Critter Powers Tab.
            cmdDeleteCritterPower.Left = cmdAddCritterPower.Left + cmdAddCritterPower.Width + 6;
            // Initiation Tab.
            // Cyberware Tab.
            cmdAddBioware.Left = cmdAddCyberware.Left + cmdAddCyberware.Width + 6;
            cmdDeleteCyberware.Left = cmdAddBioware.Left + cmdAddBioware.Width + 6;
            // Lifestyle Tab.
            cmdDeleteLifestyle.Left = cmdAddLifestyle.Left + cmdAddLifestyle.Width + 6;
            // Armor Tab.
            cmdDeleteArmor.Left = cmdAddArmor.Left + cmdAddArmor.Width + 6;
            cmdAddArmorBundle.Left = cmdDeleteArmor.Left + cmdDeleteArmor.Width + 6;
            cmdArmorEquipAll.Left = chkArmorEquipped.Left + chkArmorEquipped.Width + 6;
            cmdArmorUnEquipAll.Left = cmdArmorEquipAll.Left + cmdArmorEquipAll.Width + 6;
            // Weapons Tab.
            cmdDeleteWeapon.Left = cmdAddWeapon.Left + cmdAddWeapon.Width + 6;
            cmdAddWeaponLocation.Left = cmdDeleteWeapon.Left + cmdDeleteWeapon.Width + 6;
            // Gear Tab.
            cmdDeleteGear.Left = cmdAddGear.Left + cmdAddGear.Width + 6;
            cmdAddLocation.Left = cmdDeleteGear.Left + cmdDeleteGear.Width + 6;
            // Vehicle Tab.
            cmdDeleteVehicle.Left = cmdAddVehicle.Left + cmdAddVehicle.Width + 6;
            cmdAddVehicleLocation.Left = cmdDeleteVehicle.Left + cmdDeleteVehicle.Width + 6;
            // Expense Tab.
            cmdKarmaSpent.Left = cmdKarmaGained.Left + cmdKarmaGained.Width + 6;
            cmdNuyenSpent.Left = cmdNuyenGained.Left + cmdNuyenGained.Width + 6;
            // Improvements Tab.
            cmdImprovementsEnableAll.Left = chkImprovementActive.Left + chkImprovementActive.Width + 6;
            cmdImprovementsDisableAll.Left = cmdImprovementsEnableAll.Left + cmdImprovementsEnableAll.Width + 6;
        }

        /// <summary>
        /// Refresh the list of Improvements.
        /// </summary>
        private void RefreshImprovements()
        {
            treImprovements.Nodes.Clear();

            TreeNode objRoot = new TreeNode();
            objRoot.Tag = null;
            objRoot.Text = LanguageManager.GetString("Node_SelectedImprovements");
            treImprovements.Nodes.Add(objRoot);

            // Populate the Locations.
            foreach (string strGroup in _objCharacter.ImprovementGroups)
            {
                TreeNode objGroup = new TreeNode();
                objGroup.Tag = strGroup;
                objGroup.Text = strGroup;
                objGroup.ContextMenuStrip = cmsImprovementLocation;
                treImprovements.Nodes.Add(objGroup);
            }

            List<ListItem> lstImprovements = new List<ListItem>();
            foreach (Improvement objImprovement in _objCharacter.Improvements)
            {
                if (objImprovement.ImproveSource == Improvement.ImprovementSource.Custom)
                {
                    string strName = "000000";
                    strName = strName.Substring(0, 6 - objImprovement.SortOrder.ToString().Length) + objImprovement.SortOrder.ToString();
                    ListItem objItem = new ListItem();
                    objItem.Value = objImprovement.SourceName;
                    objItem.Name = strName;
                    lstImprovements.Add(objItem);
                }
            }

            // Populate the Improvements TreeView.
            int i = -1;
            foreach (ListItem objItem in lstImprovements)
            {
                i++;
                Improvement objImprovement = null;
                foreach (Improvement objCharacterImprovement in _objCharacter.Improvements)
                {
                    if (objCharacterImprovement.SourceName == objItem.Value)
                    {
                        objImprovement = objCharacterImprovement;
                        break;
                    }
                }

                TreeNode nodImprovement = new TreeNode();
                nodImprovement.Tag = objImprovement.SourceName;
                nodImprovement.Text = objImprovement.CustomName;
                if (!string.IsNullOrEmpty(objImprovement.Notes))
                {
                    if (objImprovement.Enabled)
                        nodImprovement.ForeColor = Color.SaddleBrown;
                    else
                        nodImprovement.ForeColor = Color.SandyBrown;
                }
                else if (objImprovement.Enabled)
                        nodImprovement.ForeColor = SystemColors.WindowText;
                    else
                        nodImprovement.ForeColor = SystemColors.GrayText;
                nodImprovement.ToolTipText = CommonFunctions.WordWrap(objImprovement.Notes, 100);
                nodImprovement.ContextMenuStrip = cmsImprovement;

                TreeNode objParent = new TreeNode();
                if (string.IsNullOrEmpty(objImprovement.CustomGroup))
                    objParent = treImprovements.Nodes[0];
                else
                {
                    foreach (TreeNode objFind in treImprovements.Nodes)
                    {
                        if (objFind.Text == objImprovement.CustomGroup)
                        {
                            objParent = objFind;
                            break;
                        }
                    }
                }

                objParent.Nodes.Add(nodImprovement);
                objParent.Expand();
            }

            // Sort the list of Custom Improvements in alphabetical order based on their Custom Name within each Group.
            treImprovements.SortCustom();
        }

        private void MoveControls()
        {
            int intWidth = 0;

            // Common tab.
            lblAlias.Left = Math.Max(288, cmdDeleteQuality.Left + cmdDeleteQuality.Width + 6);
            txtAlias.Left = lblAlias.Left + lblAlias.Width + 6;
            txtAlias.Width = lblMetatypeLabel.Left - txtAlias.Left - 6;

            // Skills tab.

            // Martial Arts tab.
            lblMartialArtSource.Left = lblMartialArtSourceLabel.Left + lblMartialArtSourceLabel.Width + 6;

            // Spells and Spirits tab.
            intWidth = Math.Max(lblSpellDescriptorsLabel.Width, lblSpellCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblSpellRangeLabel.Width);
            intWidth = Math.Max(intWidth, lblSpellDurationLabel.Width);
            intWidth = Math.Max(intWidth, lblSpellSourceLabel.Width);
            intWidth = Math.Max(intWidth, lblSpellDicePoolLabel.Width);

            lblSpellDescriptors.Left = lblSpellDescriptorsLabel.Left + intWidth + 6;
            lblSpellCategory.Left = lblSpellCategoryLabel.Left + intWidth + 6;
            lblSpellRange.Left = lblSpellRangeLabel.Left + intWidth + 6;
            lblSpellDuration.Left = lblSpellDurationLabel.Left + intWidth + 6;
            lblSpellSource.Left = lblSpellSourceLabel.Left + intWidth + 6;
            lblSpellDicePool.Left = lblSpellDicePoolLabel.Left + intWidth + 6;

            intWidth = Math.Max(lblSpellTypeLabel.Width, lblSpellDamageLabel.Width);
            intWidth = Math.Max(intWidth, lblSpellDVLabel.Width);
            lblSpellTypeLabel.Left = lblSpellCategoryLabel.Left + 179;
            lblSpellType.Left = lblSpellTypeLabel.Left + intWidth + 6;
            lblSpellDamageLabel.Left = lblSpellRangeLabel.Left + 179;
            lblSpellDamage.Left = lblSpellDamageLabel.Left + intWidth + 6;
            lblSpellDVLabel.Left = lblSpellDurationLabel.Left + 179;
            lblSpellDV.Left = lblSpellDVLabel.Left + intWidth + 6;
            cmdQuickenSpell.Left = lblSpellDVLabel.Left;

            intWidth = Math.Max(lblTraditionLabel.Width, lblDrainAttributesLabel.Width);
            intWidth = Math.Max(intWidth, lblMentorSpiritLabel.Width);
            cboTradition.Left = lblTraditionLabel.Left + intWidth + 6;
            lblDrainAttributes.Left = lblDrainAttributesLabel.Left + intWidth + 6;
            lblTraditionSource.Left = lblTraditionSourceLabel.Left + intWidth + 6;
            lblDrainAttributesValue.Left = lblDrainAttributes.Left + 91;
            lblMentorSpirit.Left = lblMentorSpiritLabel.Left + intWidth + 6;

            cmdRollSpell.Left = lblSpellDicePool.Left + lblSpellDicePool.Width + 6;
            cmdRollDrain.Left = lblDrainAttributesValue.Left + lblDrainAttributesValue.Width + 6;
            cmdRollSpell.Visible = _objOptions.AllowSkillDiceRolling;
            cmdRollDrain.Visible = _objOptions.AllowSkillDiceRolling;

            // Sprites and Complex Forms tab.
            int intLeft = lblDurationLabel.Width;
            intLeft = Math.Max(intLeft, lblTargetLabel.Width);
            intLeft = Math.Max(intLeft, lblFV.Width);
            intLeft = Math.Max(intLeft, lblComplexFormSource.Width);

            lblTarget.Left = lblTargetLabel.Left + intLeft + 6;
            lblDuration.Left = lblDurationLabel.Left + intLeft + 6;
            lblFV.Left = lblFVLabel.Left + intLeft + 6;
            lblComplexFormSource.Left = lblComplexFormSourceLabel.Left + intLeft + 6;

            intWidth = lblFadingAttributesLabel.Width;
            lblFadingAttributes.Left = lblFadingAttributesLabel.Left + intWidth + 6;
            lblFadingAttributesValue.Left = lblFadingAttributes.Left + 91;

            cmdRollFading.Left = lblFadingAttributesValue.Left + lblFadingAttributesValue.Width + 6;
            cmdRollFading.Visible = _objOptions.AllowSkillDiceRolling;

            // Critter Powers tab.
            lblCritterPowerPointsLabel.Left = cmdDeleteCritterPower.Left + cmdDeleteCritterPower.Width + 16;
            lblCritterPowerPoints.Left = lblCritterPowerPointsLabel.Left + lblCritterPowerPointsLabel.Width + 6;

            intWidth = Math.Max(lblCritterPowerNameLabel.Width, lblCritterPowerCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerTypeLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerActionLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerRangeLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerDurationLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerSourceLabel.Width);
            intWidth = Math.Max(intWidth, lblCritterPowerPointCostLabel.Width);

            lblCritterPowerName.Left = lblCritterPowerNameLabel.Left + intWidth + 6;
            lblCritterPowerCategory.Left = lblCritterPowerCategoryLabel.Left + intWidth + 6;
            lblCritterPowerType.Left = lblCritterPowerTypeLabel.Left + intWidth + 6;
            lblCritterPowerAction.Left = lblCritterPowerActionLabel.Left + intWidth + 6;
            lblCritterPowerRange.Left = lblCritterPowerRangeLabel.Left + intWidth + 6;
            lblCritterPowerDuration.Left = lblCritterPowerDurationLabel.Left + intWidth + 6;
            lblCritterPowerSource.Left = lblCritterPowerSourceLabel.Left + intWidth + 6;
            lblCritterPowerPointCost.Left = lblCritterPowerPointCostLabel.Left + intWidth + 6;

            // Initiation and Submersion tab.

            // Cyberware and Bioware tab.
            intWidth = Math.Max(lblCyberwareNameLabel.Width, lblCyberwareCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberwareGradeLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberwareEssenceLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberwareAvailLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberwareSourceLabel.Width);

            lblCyberwareName.Left = lblCyberwareNameLabel.Left + intWidth + 6;
            lblCyberwareCategory.Left = lblCyberwareCategoryLabel.Left + intWidth + 6;
            lblCyberwareGrade.Left = lblCyberwareGradeLabel.Left + intWidth + 6;
            lblCyberwareEssence.Left = lblCyberwareEssenceLabel.Left + intWidth + 6;
            lblCyberwareAvail.Left = lblCyberwareAvailLabel.Left + intWidth + 6;
            lblCyberwareSource.Left = lblCyberwareSourceLabel.Left + intWidth + 6;

            intWidth = lblEssenceHoleESSLabel.Width;
            lblCyberwareESS.Left = lblEssenceHoleESSLabel.Left + intWidth + 6;
            lblBiowareESS.Left = lblEssenceHoleESSLabel.Left + intWidth + 6;
            lblEssenceHoleESS.Left = lblEssenceHoleESSLabel.Left + intWidth + 6;

            intWidth = Math.Max(lblCyberwareRatingLabel.Width, lblCyberwareCapacityLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberwareCostLabel.Width);
            intWidth = Math.Max(intWidth, lblCyberlimbSTRLabel.Width);

            lblCyberAttackLabel.Left = lblCyberDeviceRating.Left + lblCyberDeviceRating.Width + 20;
            cboCyberwareGearAttack.Left = lblCyberAttackLabel.Left + lblCyberAttackLabel.Width + 6;
            lblCyberSleazeLabel.Left = cboCyberwareGearAttack.Left + cboCyberwareGearAttack.Width + 20;
            cboCyberwareGearSleaze.Left = lblCyberSleazeLabel.Left + lblCyberSleazeLabel.Width + 6;
            lblCyberDataProcessingLabel.Left = cboCyberwareGearSleaze.Left + cboCyberwareGearSleaze.Width + 20;
            cboCyberwareGearDataProcessing.Left = lblCyberDataProcessingLabel.Left + lblCyberDataProcessingLabel.Width + 6;
            lblCyberFirewallLabel.Left = cboCyberwareGearDataProcessing.Left + cboCyberwareGearDataProcessing.Width + 20;
            cboCyberwareGearFirewall.Left = lblCyberFirewallLabel.Left + lblCyberFirewallLabel.Width + 6;

            lblCyberwareRatingLabel.Left = lblCyberwareName.Left + 208;
            lblCyberwareRating.Left = lblCyberwareRatingLabel.Left + intWidth + 6;
            lblCyberwareCapacityLabel.Left = lblCyberwareName.Left + 208;
            lblCyberwareCapacity.Left = lblCyberwareCapacityLabel.Left + intWidth + 6;
            lblCyberwareCostLabel.Left = lblCyberwareName.Left + 208;
            lblCyberwareCost.Left = lblCyberwareCostLabel.Left + intWidth + 6;
            lblCyberlimbAGILabel.Left = lblCyberwareName.Left + 208;
            lblCyberlimbAGI.Left = lblCyberlimbAGILabel.Left + intWidth + 6;
            lblCyberlimbSTRLabel.Left = lblCyberwareName.Left + 208;
            lblCyberlimbSTR.Left = lblCyberlimbSTRLabel.Left + intWidth + 6;

            // Street Gear tab.
            // Lifestyles tab.
            lblLifestyleCost.Left = lblLifestyleCostLabel.Left + lblLifestyleCostLabel.Width + 6;
            lblLifestyleSource.Left = lblLifestyleSourceLabel.Left + lblLifestyleSourceLabel.Width + 6;

            intWidth = lblLifestyleComfortsLabel.Width;

            lblBaseLifestyle.Left = lblLifestyleComfortsLabel.Left + intWidth + 6;

            lblLifestyleQualitiesLabel.Left = lblBaseLifestyle.Left + 132;
            lblLifestyleQualities.Left = lblLifestyleQualitiesLabel.Left + 14;
            lblLifestyleQualities.Width = tabLifestyle.Width - lblLifestyleQualities.Left - 10;

            // Armor tab.
            intWidth = lblArmorValueLabel.Width;
            intWidth = Math.Max(intWidth, lblArmorRatingLabel.Width);
            intWidth = Math.Max(intWidth, lblArmorCapacityLabel.Width);
            intWidth = Math.Max(intWidth, lblArmorSourceLabel.Width);

            lblArmorValue.Left = lblArmorValueLabel.Left + intWidth + 6;
            lblArmorRating.Left = lblArmorRatingLabel.Left + intWidth + 6;
            lblArmorCapacity.Left = lblArmorCapacityLabel.Left + intWidth + 6;
            lblArmorSource.Left = lblArmorSourceLabel.Left + intWidth + 6;

            lblArmorAvailLabel.Left = lblArmorRating.Left + lblArmorRating.Width + 6;
            lblArmorAvail.Left = lblArmorAvailLabel.Left + lblArmorAvailLabel.Width + 6;

            lblArmorCostLabel.Left = lblArmorAvail.Left + lblArmorAvail.Width + 6;
            lblArmorCost.Left = lblArmorCostLabel.Left + lblArmorCostLabel.Width + 6;

            cmdArmorIncrease.Left = lblArmorValue.Left + 45;
            cmdArmorDecrease.Left = cmdArmorIncrease.Left + cmdArmorIncrease.Width + 6;

            lblArmorAttackLabel.Left = lblArmorDeviceRating.Left + lblArmorDeviceRating.Width + 20;
            lblArmorAttack.Left = lblArmorAttackLabel.Left + lblArmorAttackLabel.Width + 6;
            lblArmorSleazeLabel.Left = lblArmorAttack.Left + lblArmorAttack.Width + 20;
            lblArmorSleaze.Left = lblArmorSleazeLabel.Left + lblArmorSleazeLabel.Width + 6;
            lblArmorDataProcessingLabel.Left = lblArmorSleaze.Left + lblArmorSleaze.Width + 20;
            lblArmorDataProcessing.Left = lblArmorDataProcessingLabel.Left + lblArmorDataProcessingLabel.Width + 6;
            lblArmorFirewallLabel.Left = lblArmorDataProcessing.Left + lblArmorDataProcessing.Width + 20;
            lblArmorFirewall.Left = lblArmorFirewallLabel.Left + lblArmorFirewallLabel.Width + 6;

            // Weapons tab.
            lblWeaponName.Left = lblWeaponNameLabel.Left + lblWeaponNameLabel.Width + 6;
            lblWeaponCategory.Left = lblWeaponCategoryLabel.Left + lblWeaponCategoryLabel.Width + 6;

            intWidth = Math.Max(lblWeaponNameLabel.Width, lblWeaponCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponDamageLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponReachLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponAvailLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponSlotsLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponSourceLabel.Width);

            lblWeaponName.Left = lblWeaponNameLabel.Left + intWidth + 6;
            lblWeaponCategory.Left = lblWeaponCategoryLabel.Left + intWidth + 6;
            lblWeaponDamage.Left = lblWeaponDamageLabel.Left + intWidth + 6;
            lblWeaponReach.Left = lblWeaponReachLabel.Left + intWidth + 6;
            lblWeaponAvail.Left = lblWeaponAvailLabel.Left + intWidth + 6;
            lblWeaponSlots.Left = lblWeaponSlotsLabel.Left + intWidth + 6;
            lblWeaponSource.Left = lblWeaponSourceLabel.Left + intWidth + 6;

            intWidth = Math.Max(lblWeaponRCLabel.Width, lblWeaponModeLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponCostLabel.Width);

            lblWeaponRCLabel.Left = lblWeaponDamageLabel.Left + 176;
            lblWeaponRC.Left = lblWeaponRCLabel.Left + intWidth + 6;
            lblWeaponModeLabel.Left = lblWeaponDamageLabel.Left + 176;
            lblWeaponMode.Left = lblWeaponModeLabel.Left + intWidth + 6;
            lblWeaponCostLabel.Left = lblWeaponDamageLabel.Left + 176;
            lblWeaponCost.Left = lblWeaponCostLabel.Left + intWidth + 6;
            chkIncludedInWeapon.Left = lblWeaponDamageLabel.Left + 176;
            cmdWeaponMoveToVehicle.Left = lblWeaponDamageLabel.Left + 176;
            lblWeaponAccuracy.Left = lblWeaponAccuracyLabel.Left + lblWeaponAccuracyLabel.Width + 6;

            intWidth = Math.Max(lblWeaponAPLabel.Width, lblWeaponAmmoLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponConcealLabel.Width);

            lblWeaponAPLabel.Left = lblWeaponRC.Left + 95;
            lblWeaponAP.Left = lblWeaponAPLabel.Left + intWidth + 6;
            lblWeaponAmmoLabel.Left = lblWeaponRC.Left + 95;
            lblWeaponAmmo.Left = lblWeaponAmmoLabel.Left + intWidth + 6;
            lblWeaponConcealLabel.Left = lblWeaponRC.Left + 95;
            lblWeaponConceal.Left = lblWeaponConcealLabel.Left + intWidth + 6;
            chkWeaponAccessoryInstalled.Left = lblWeaponRC.Left + 95;

            intWidth = Math.Max(lblWeaponAmmoRemainingLabel.Width, lblWeaponAmmoTypeLabel.Width);
            intWidth = Math.Max(intWidth, lblWeaponDicePoolLabel.Width);

            lblWeaponAmmoRemaining.Left = lblWeaponAmmoRemainingLabel.Left + intWidth + 6;
            cboWeaponAmmo.Left = lblWeaponAmmoTypeLabel.Left + intWidth + 6;
            lblWeaponDicePool.Left = lblWeaponDicePoolLabel.Left + intWidth + 6;

            cmdFireWeapon.Left = lblWeaponAmmoRemaining.Left + 123;
            cmdReloadWeapon.Left = cmdFireWeapon.Left + cmdFireWeapon.Width + 6;
            cmdWeaponBuyAmmo.Left = cmdReloadWeapon.Left + cmdReloadWeapon.Width + 6;

            cmdRollWeapon.Left = lblWeaponDicePool.Left + lblWeaponDicePool.Width + 6;
            cmdRollWeapon.Visible = _objOptions.AllowSkillDiceRolling;

            lblWeaponAttackLabel.Left = lblWeaponDeviceRating.Left + lblWeaponDeviceRating.Width + 20;
            cboWeaponGearAttack.Left = lblWeaponAttackLabel.Left + lblWeaponAttackLabel.Width + 6;
            lblWeaponSleazeLabel.Left = cboWeaponGearAttack.Left + cboWeaponGearAttack.Width + 20;
            cboWeaponGearSleaze.Left = lblWeaponSleazeLabel.Left + lblWeaponSleazeLabel.Width + 6;
            lblWeaponDataProcessingLabel.Left = cboWeaponGearSleaze.Left + cboWeaponGearSleaze.Width + 20;
            cboWeaponGearDataProcessing.Left = lblWeaponDataProcessingLabel.Left + lblWeaponDataProcessingLabel.Width + 6;
            lblWeaponFirewallLabel.Left = cboWeaponGearDataProcessing.Left + cboWeaponGearDataProcessing.Width + 20;
            cboWeaponGearFirewall.Left = lblWeaponFirewallLabel.Left + lblWeaponFirewallLabel.Width + 6;

            // Gear tab.
            intWidth = Math.Max(lblGearNameLabel.Width, lblGearCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblGearRatingLabel.Width);
            intWidth = Math.Max(intWidth, lblGearCapacityLabel.Width);
            intWidth = Math.Max(intWidth, lblGearQtyLabel.Width);

            chkCommlinks.Left = cmdAddLocation.Left + cmdAddLocation.Width + 16;

            lblGearName.Left = lblGearNameLabel.Left + intWidth + 6;
            lblGearCategory.Left = lblGearCategoryLabel.Left + intWidth + 6;
            lblGearRating.Left = lblGearRatingLabel.Left + intWidth + 6;
            lblGearCapacity.Left = lblGearCapacityLabel.Left + intWidth + 6;
            lblGearQty.Left = lblGearQtyLabel.Left + intWidth + 6;

            cmdGearIncreaseQty.Left = lblGearQty.Left + 57;
            cmdGearReduceQty.Left = cmdGearIncreaseQty.Left + cmdGearIncreaseQty.Width + 6;
            cmdGearSplitQty.Left = cmdGearReduceQty.Left + 79;
            cmdGearMergeQty.Left = cmdGearSplitQty.Left + cmdGearSplitQty.Width + 6;
            cmdGearMoveToVehicle.Left = cmdGearMergeQty.Left + 56;

            intWidth = lblGearDamageLabel.Width;
            lblGearDamage.Left = lblGearDamageLabel.Left + intWidth + 6;

            intWidth = lblGearAPLabel.Width;
            lblGearAP.Left = lblGearAPLabel.Left + intWidth + 6;

            lblGearSource.Left = lblGearSourceLabel.Left + lblGearSourceLabel.Width + 6;
            chkGearHomeNode.Left = chkGearEquipped.Left + chkGearEquipped.Width + 16;

            // Vehicles and Drones tab.
            intWidth = Math.Max(lblVehicleNameLabel.Width, lblVehicleCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleHandlingLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleAttackLabel.Width);
            intWidth = Math.Max(intWidth, lblVehiclePilotLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleFirewallLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleAvailLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleRatingLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleGearQtyLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleSourceLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleWeaponNameLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleWeaponCategoryLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleWeaponDamageLabel.Width);

            lblVehicleName.Left = lblVehicleNameLabel.Left + intWidth + 6;
            lblVehicleCategory.Left = lblVehicleCategoryLabel.Left + intWidth + 6;
            lblVehicleHandling.Left = lblVehicleHandlingLabel.Left + intWidth + 6;
            lblVehiclePilot.Left = lblVehiclePilotLabel.Left + intWidth + 6;
            cboVehicleGearAttack.Left = lblVehicleAttackLabel.Left + intWidth + 6;
            cboVehicleGearFirewall.Left = lblVehicleFirewallLabel.Left + intWidth + 6;
            lblVehicleAvail.Left = lblVehicleAvailLabel.Left + intWidth + 6;
            lblVehicleRating.Left = lblVehicleRatingLabel.Left + intWidth + 6;
            lblVehicleGearQty.Left = lblVehicleGearQtyLabel.Left + intWidth + 6;
            lblVehicleSource.Left = lblVehicleSourceLabel.Left + intWidth + 6;
            lblVehicleWeaponName.Left = lblVehicleWeaponNameLabel.Left + intWidth + 6;
            lblVehicleWeaponCategory.Left = lblVehicleWeaponCategoryLabel.Left + intWidth + 6;
            lblVehicleWeaponDamage.Left = lblVehicleWeaponDamageLabel.Left + intWidth + 6;

            intWidth = Math.Max(lblVehicleAccelLabel.Width, lblVehicleBodyLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleCostLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleProtectionLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleElectromagneticLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleSleazeLabel.Width);

            lblVehicleAccelLabel.Left = lblVehicleHandling.Left + 60;
            lblVehicleAccel.Left = lblVehicleAccelLabel.Left + intWidth + 6;
            lblVehicleBodyLabel.Left = lblVehicleHandling.Left + 60;
            lblVehicleBody.Left = lblVehicleBodyLabel.Left + intWidth + 6;
            lblVehicleCostLabel.Left = lblVehicleHandling.Left + 60;
            lblVehicleCost.Left = lblVehicleCostLabel.Left + intWidth + 6;
            lblVehicleProtectionLabel.Left = lblVehicleHandling.Left + 60;
            lblVehicleProtection.Left = lblVehicleProtectionLabel.Left + intWidth + 6;
            lblVehicleElectromagneticLabel.Left = lblVehicleHandling.Left + 60;
            lblVehicleElectromagnetic.Left = lblVehicleElectromagneticLabel.Left + intWidth + 6;
            lblVehicleSleazeLabel.Left = lblVehicleHandling.Left + 60;
            cboVehicleGearSleaze.Left = lblVehicleSleazeLabel.Left + intWidth + 6;

            cmdVehicleGearReduceQty.Left = lblVehicleGearQtyLabel.Left + 144;
            cmdVehicleMoveToInventory.Left = cmdVehicleGearReduceQty.Left + 29;
            chkVehicleIncludedInWeapon.Left = lblVehicleAccel.Left;

            intWidth = Math.Max(lblVehicleSpeedLabel.Width, lblVehicleArmorLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleDataProcessingLabel.Width);
            intWidth = Math.Max(intWidth, lblVehiclePowertrainLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleCosmeticLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleDeviceLabel.Width);

            lblVehicleSpeedLabel.Left = lblVehicleAccel.Left + 60;
            lblVehicleSpeed.Left = lblVehicleSpeedLabel.Left + intWidth + 6;
            lblVehicleArmorLabel.Left = lblVehicleAccel.Left + 60;
            lblVehicleArmor.Left = lblVehicleArmorLabel.Left + intWidth + 6;
            lblVehiclePowertrainLabel.Left = lblVehicleAccel.Left + 60;
            lblVehiclePowertrain.Left = lblVehiclePowertrainLabel.Left + intWidth + 6;
            lblVehicleCosmeticLabel.Left = lblVehicleAccel.Left + 60;
            lblVehicleCosmetic.Left = lblVehicleCosmeticLabel.Left + intWidth + 6;
            lblVehicleDataProcessingLabel.Left = lblVehicleAccel.Left + 60;
            cboVehicleGearDataProcessing.Left = lblVehicleDataProcessingLabel.Left + intWidth + 6;
            lblVehicleDeviceLabel.Left = lblVehicleAccel.Left + 60;
            lblVehicleDevice.Left = lblVehicleDeviceLabel.Left + intWidth + 6;

            intWidth = Math.Max(lblVehicleFirewallLabel.Width, lblVehicleSensorLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleSeatsLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleDroneModSlotsLabel.Width);
            intWidth = Math.Max(intWidth, lblVehicleSlotsLabel.Width);

            lblVehicleSensorLabel.Left = lblVehicleSpeed.Left + 60;
            lblVehicleSensor.Left = lblVehicleSensorLabel.Left + intWidth + 6;
            lblVehicleSeatsLabel.Left = lblVehicleSpeed.Left + 60;
            lblVehicleSeats.Left = lblVehicleSeatsLabel.Left + intWidth + 6;
            lblVehicleFirewallLabel.Left = lblVehicleSpeed.Left + 60;
            lblVehicleDroneModSlotsLabel.Left = lblVehicleSpeed.Left + 60;
            lblVehicleDroneModSlots.Left = lblVehicleDroneModSlotsLabel.Left + intWidth + 6;

            cboVehicleGearFirewall.Left = lblVehicleFirewallLabel.Left + intWidth + 6;

            lblVehicleSlotsLabel.Left = lblVehicleSpeed.Left + 60;
            lblVehicleSlots.Left = lblVehicleSlotsLabel.Left + intWidth + 6;

            chkVehicleHomeNode.Left = lblVehicleSlotsLabel.Left;
            chkVehicleWeaponAccessoryInstalled.Left = lblVehicleSlotsLabel.Left;

            // Character Info.
            intWidth = Math.Max(lblSex.Width, lblHeight.Width);
            txtSex.Left = lblSex.Left + intWidth + 6;
            txtSex.Width = lblAge.Left - txtSex.Left - 16;
            txtHeight.Left = lblHeight.Left + intWidth + 6;
            txtHeight.Width = lblWeight.Left - txtHeight.Left - 16;

            intWidth = Math.Max(lblAge.Width, lblWeight.Width);
            txtAge.Left = lblAge.Left + intWidth + 6;
            txtAge.Width = lblEyes.Left - txtAge.Left - 16;
            txtWeight.Left = lblWeight.Left + intWidth + 6;
            txtWeight.Width = lblSkin.Left - txtWeight.Left - 16;

            intWidth = Math.Max(lblEyes.Width, lblSkin.Width);
            txtEyes.Left = lblEyes.Left + intWidth + 6;
            txtEyes.Width = lblHair.Left - txtEyes.Left - 16;
            txtSkin.Left = lblSkin.Left + intWidth + 6;
            txtSkin.Width = lblCharacterName.Left - txtSkin.Left - 16;

            intWidth = Math.Max(lblHair.Width, lblCharacterName.Width);
            txtHair.Left = lblHair.Left + intWidth + 6;
            txtHair.Width = lblPlayerName.Left - txtHair.Left - 16;
            txtCharacterName.Left = lblCharacterName.Left + intWidth + 6;
            txtCharacterName.Width = lblPlayerName.Left - txtCharacterName.Left - 16;

            txtPlayerName.Left = lblPlayerName.Left + lblPlayerName.Width + 6;
            txtPlayerName.Width = tabCharacterInfo.Width - txtPlayerName.Left - 16;

            intWidth = Math.Max(lblStreetCred.Width, lblNotoriety.Width);
            intWidth = Math.Max(intWidth, lblPublicAware.Width);

            nudStreetCred.Left = lblStreetCred.Left + intWidth + 6;
            nudNotoriety.Left = lblNotoriety.Left + intWidth + 6;
            nudPublicAware.Left = lblPublicAware.Left + intWidth + 6;
            lblStreetCredTotal.Left = nudStreetCred.Left + nudStreetCred.Width + 6;
            lblNotorietyTotal.Left = nudNotoriety.Left + nudNotoriety.Width + 6;
            lblPublicAwareTotal.Left = nudPublicAware.Left + nudPublicAware.Width + 6;

            // Expense Tab.
            cmdKarmaSpent.Left = cmdKarmaGained.Left + cmdKarmaGained.Width + 6;
            cmdKarmaEdit.Left = cmdKarmaSpent.Left + cmdKarmaSpent.Width + 6;
            cmdNuyenSpent.Left = cmdNuyenGained.Left + cmdNuyenGained.Width + 6;
            cmdNuyenEdit.Left = cmdNuyenSpent.Left + cmdNuyenSpent.Width + 6;

            // Calendar Tab.
            cmdEditWeek.Left = cmdAddWeek.Left + cmdAddWeek.Width + 6;

            // Improvements tab.
            cmdEditImprovement.Left = cmdAddImprovement.Left + cmdAddImprovement.Width + 6;
            cmdDeleteImprovement.Left = cmdEditImprovement.Left + cmdEditImprovement.Width + 6;
            lblImprovementType.Left = lblImprovementTypeLabel.Left + lblImprovementTypeLabel.Width + 6;

            // Other Info tab.
            intWidth = Math.Max(lblCMPhysicalLabel.Width, lblCMStunLabel.Width);
            intWidth = Math.Max(intWidth, lblINILabel.Width);
            intWidth = Math.Max(intWidth, lblMatrixINILabel.Width);
            intWidth = Math.Max(intWidth, lblAstralINILabel.Width);
            intWidth = Math.Max(intWidth, lblRiggingINILabel.Width);
            intWidth = Math.Max(intWidth, lblMatrixINIColdLabel.Width);
            intWidth = Math.Max(intWidth, lblMatrixINIHotLabel.Width);
            intWidth = Math.Max(intWidth, lblArmorLabel.Width);
            intWidth = Math.Max(intWidth, lblESS.Width);
            intWidth = Math.Max(intWidth, lblRemainingNuyenLabel.Width);
            intWidth = Math.Max(intWidth, lblCareerKarmaLabel.Width);
            intWidth = Math.Max(intWidth, lblCareerNuyenLabel.Width);
            intWidth = Math.Max(intWidth, lblComposureLabel.Width);
            intWidth = Math.Max(intWidth, lblJudgeIntentionsLabel.Width);
            intWidth = Math.Max(intWidth, lblLiftCarryLabel.Width);
            intWidth = Math.Max(intWidth, lblMemoryLabel.Width);
            intWidth = Math.Max(intWidth, lblMovementLabel.Width);
            intWidth = Math.Max(intWidth, lblSwimLabel.Width);
            intWidth = Math.Max(intWidth, lblFlyLabel.Width);

            lblCMPhysical.Left = lblPhysicalCMLabel.Left + intWidth + 6;
            lblCMStun.Left = lblCMPhysical.Left;
            lblINI.Left = lblCMPhysical.Left;
            lblMatrixINI.Left = lblCMPhysical.Left;
            lblAstralINI.Left = lblCMPhysical.Left;
            lblRiggingINI.Left = lblCMPhysical.Left;
            lblMatrixINICold.Left = lblCMPhysical.Left;
            lblMatrixINIHot.Left = lblCMPhysical.Left;
            lblArmor.Left = lblCMPhysical.Left;
            lblESSMax.Left = lblCMPhysical.Left;
            lblRemainingNuyen.Left = lblCMPhysical.Left;
            lblCareerKarma.Left = lblCMPhysical.Left;
            lblCareerNuyen.Left = lblCMPhysical.Left;
            lblComposure.Left = lblCMPhysical.Left;
            lblJudgeIntentions.Left = lblCMPhysical.Left;
            lblLiftCarry.Left = lblCMPhysical.Left;
            lblMemory.Left = lblCMPhysical.Left;
            lblMovement.Left = lblCMPhysical.Left;
            lblSwim.Left = lblCMPhysical.Left;
            lblFly.Left = lblCMPhysical.Left;

            // Condition Monitor tab.
            intWidth = Math.Max(lblCMPenaltyLabel.Width, lblCMArmorLabel.Width);
            intWidth = Math.Max(intWidth, lblCMDamageResistancePoolLabel.Width);

            lblCMPenalty.Left = lblCMPenaltyLabel.Left + intWidth + 6;
            lblCMArmor.Left = lblCMPenalty.Left;
            lblCMDamageResistancePool.Left = lblCMPenalty.Left;
        }



        /// <summary>
        /// Recheck all mods to see if Sensor has changed. 
        /// </summary>
        /// <param name="objVehicle">Vehicle to modify.</param>
        private void UpdateSensor(Vehicle objVehicle)
        {
            foreach (Gear objGear in objVehicle.Gear)
            {
                if (objGear.Category == "Sensors" && objGear.Name == "Sensor Array" && objGear.IncludedInParent)
                {
                    // Update the name of the item in the TreeView.
                    TreeNode objNode = CommonFunctions.FindNode(objGear.InternalId, treVehicles);
                    objNode.Text = objGear.DisplayName;
                }
            }
        }


        /// <summary>
        /// Change the size of a Vehicle's Sensor -- Obsolete code
        /// </summary>
        /// <param name="objVehicle">Vehicle to modify.</param>
        /// <param name="blnIncrease">True if the Sensor should increase in size, False if it should decrease.</param>
        private void ChangeVehicleSensor(Vehicle objVehicle, bool blnIncrease)
        {
            XmlDocument objXmlDocument = XmlManager.Load("gear.xml");
            XmlNode objNewNode;

            Gear objSensor = null;
            Gear objNewSensor = new Gear(_objCharacter);

            TreeNode objTreeNode = new TreeNode();
            List<Weapon> lstWeapons = new List<Weapon>();
            List<TreeNode> lstWeaponNodes = new List<TreeNode>();
            foreach (Gear objCurrentGear in objVehicle.Gear)
            {
                if (objCurrentGear.Name == "Microdrone Sensor")
                {
                    if (blnIncrease)
                    {
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Minidrone Sensor\" and category = \"Sensors\"]");
                        objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                        objSensor = objCurrentGear;
                    }
                    break;
                }
                else if (objCurrentGear.Name == "Minidrone Sensor")
                {
                    if (blnIncrease)
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Small Drone Sensor\" and category = \"Sensors\"]");
                    else
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Microdrone Sensor\" and category = \"Sensors\"]");
                    objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                    objSensor = objCurrentGear;
                    break;
                }
                else if (objCurrentGear.Name == "Small Drone Sensor")
                {
                    if (blnIncrease)
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Medium Drone Sensor\" and category = \"Sensors\"]");
                    else
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Minidrone Sensor\" and category = \"Sensors\"]");
                    objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                    objSensor = objCurrentGear;
                    break;
                }
                else if (objCurrentGear.Name == "Medium Drone Sensor")
                {
                    if (blnIncrease)
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Large Drone Sensor\" and category = \"Sensors\"]");
                    else
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Small Drone Sensor\" and category = \"Sensors\"]");
                    objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                    objSensor = objCurrentGear;
                    break;
                }
                else if (objCurrentGear.Name == "Large Drone Sensor")
                {
                    if (blnIncrease)
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Vehicle Sensor\" and category = \"Sensors\"]");
                    else
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Medium Drone Sensor\" and category = \"Sensors\"]");
                    objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                    objSensor = objCurrentGear;
                    break;
                }
                else if (objCurrentGear.Name == "Vehicle Sensor")
                {
                    if (blnIncrease)
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Extra-Large Vehicle Sensor\" and category = \"Sensors\"]");
                    else
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Large Drone Sensor\" and category = \"Sensors\"]");
                    objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                    objSensor = objCurrentGear;
                    break;
                }
                else if (objCurrentGear.Name == "Extra-Large Vehicle Sensor")
                {
                    if (!blnIncrease)
                    {
                        objNewNode = objXmlDocument.SelectSingleNode("/chummer/gears/gear[name = \"Vehicle Sensor\" and category = \"Sensors\"]");
                        objNewSensor.Create(objNewNode, objTreeNode, 0, lstWeapons, lstWeaponNodes);
                        objSensor = objCurrentGear;
                    }
                    break;
                }
            }

            // If the item was found, update the Vehicle Sensor information.
            if (objSensor != null)
            {
                objSensor.Name = objNewSensor.Name;
                objSensor.Rating = objNewSensor.Rating;
                objSensor.Capacity = objNewSensor.Capacity;
                objSensor.DeviceRating = objNewSensor.DeviceRating;
                objSensor.Avail = objNewSensor.Avail;
                objSensor.Cost = objNewSensor.Cost;
                objSensor.Source = objNewSensor.Source;
                objSensor.Page = objNewSensor.Page;

                // Update the name of the item in the TreeView.
                TreeNode objNode = CommonFunctions.FindNode(objSensor.InternalId, treVehicles);
                objNode.Text = objSensor.DisplayNameShort;
            }
        }

        /// <summary>
        /// Update the Reputation fields.
        /// </summary>
        private void UpdateReputation()
        {
            lblStreetCredTotal.Text = " + " + _objCharacter.CalculatedStreetCred.ToString() + " = " + _objCharacter.TotalStreetCred.ToString();
            lblNotorietyTotal.Text = " + " + _objCharacter.CalculatedNotoriety.ToString() + " = " + _objCharacter.TotalNotoriety.ToString();
            lblPublicAwareTotal.Text = " + " + _objCharacter.CalculatedPublicAwareness.ToString() + " = " + (_objCharacter.TotalPublicAwareness + _objCharacter.CalculatedPublicAwareness).ToString();
            cmdBurnStreetCred.Left = lblStreetCredTotal.Left + lblStreetCredTotal.Width + 6;
            cmdBurnStreetCred.Enabled = _objCharacter.TotalStreetCred >= 2;

            tipTooltip.SetToolTip(lblStreetCredTotal, _objCharacter.StreetCredTooltip);
            tipTooltip.SetToolTip(lblNotorietyTotal, _objCharacter.NotorietyTooltip);
            tipTooltip.SetToolTip(lblPublicAwareTotal, _objCharacter.PublicAwarenessTooltip);
        }

        /// <summary>
        /// Copy the Improvements from a piece of Armor on one character to another.
        /// </summary>
        /// <param name="objSource">Source character.</param>
        /// <param name="objDestination">Destination character.</param>
        /// <param name="objArmor">Armor to copy.</param>
        private void CopyArmorImprovements(Character objSource, Character objDestination, Armor objArmor)
        {
            foreach (Improvement objImproevment in objSource.Improvements)
            {
                if (objImproevment.SourceName == objArmor.InternalId)
                {
                    objDestination.Improvements.Add(objImproevment);
                }
            }
            // Look through any Armor Mods and add the Improvements as well.
            foreach (ArmorMod objMod in objArmor.ArmorMods)
            {
                foreach (Improvement objImproevment in objSource.Improvements)
                {
                    if (objImproevment.SourceName == objMod.InternalId)
                    {
                        objDestination.Improvements.Add(objImproevment);
                    }
                }
                // Look through any children and add their Improvements as well.
                foreach (Gear objChild in objMod.Gear)
                    CopyGearImprovements(objSource, objDestination, objChild);
            }
            // Look through any children and add their Improvements as well.
            foreach (Gear objChild in objArmor.Gear)
                CopyGearImprovements(objSource, objDestination, objChild);
        }

        /// <summary>
        /// Copy the Improvements from a piece of Gear on one character to another.
        /// </summary>
        /// <param name="objSource">Source character.</param>
        /// <param name="objDestination">Destination character.</param>
        /// <param name="objGear">Gear to copy.</param>
        private void CopyGearImprovements(Character objSource, Character objDestination, Gear objGear)
        {
            foreach (Improvement objImproevment in objSource.Improvements)
            {
                if (objImproevment.SourceName == objGear.InternalId)
                {
                    objDestination.Improvements.Add(objImproevment);
                }
            }
            // Look through any children and add their Improvements as well.
            foreach (Gear objChild in objGear.Children)
                CopyGearImprovements(objSource, objDestination, objChild);
        }

        /// <summary>
        /// Copy the Improvements from a piece of Cyberware on one character to another.
        /// </summary>
        /// <param name="objSource">Source character.</param>
        /// <param name="objDestination">Destination character.</param>
        /// <param name="objCyberware">Cyberware to copy.</param>
        private void CopyCyberwareImprovements(Character objSource, Character objDestination, Cyberware objCyberware)
        {
            foreach (Improvement objImproevment in objSource.Improvements)
            {
                if (objImproevment.SourceName == objCyberware.InternalId)
                {
                    objDestination.Improvements.Add(objImproevment);
                }
            }
            // Look through any children and add their Improvements as well.
            foreach (Cyberware objChild in objCyberware.Children)
                CopyCyberwareImprovements(objSource, objDestination, objChild);
        }

        /// <summary>
        /// Recursive method to add a Gear's Improvements to a character when moving them from a Vehicle.
        /// </summary>
        /// <param name="objGear">Gear to create Improvements for.
        /// </param>
        private void AddGearImprovements(Gear objGear)
        {
            string strForce = string.Empty;
            if (objGear.Bonus != null || (objGear.WirelessOn && objGear.WirelessBonus != null))
            {
                if (!string.IsNullOrEmpty(objGear.Extra))
                    strForce = objGear.Extra;
                ImprovementManager.ForcedValue = strForce;
                if (objGear.Bonus != null)
                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.Bonus, true, objGear.Rating, objGear.DisplayNameShort);
                if (objGear.WirelessOn && objGear.WirelessBonus != null)
                    ImprovementManager.CreateImprovements(_objCharacter, Improvement.ImprovementSource.Gear, objGear.InternalId, objGear.WirelessBonus, true, objGear.Rating, objGear.DisplayNameShort);
            }
            foreach (Gear objChild in objGear.Children)
                AddGearImprovements(objChild);
        }

        /// <summary>
        /// Enable/Disable the Paste Menu and ToolStrip items as appropriate.
        /// </summary>
        private void RefreshPasteStatus()
        {
        }

        /// <summary>
        /// Refresh the information for the currently selected Complex Form.
        /// </summary>
        private void RefreshSelectedComplexForm()
        {
            if (_blnSkipRefresh)
                return;

            if (treComplexForms.SelectedNode != null)
            {
                if (treComplexForms.SelectedNode.Level == 1)
                {
                    // Locate the Program that is selected in the tree.
                    ComplexForm objProgram = CommonFunctions.FindByIdWithNameCheck(treComplexForms.SelectedNode.Tag.ToString(), _objCharacter.ComplexForms);
                    string strDuration = objProgram.Duration;
                    string strTarget = objProgram.Target;
                    string strFV = objProgram.FV;

                    lblDuration.Text = strDuration;
                    lblTarget.Text = strTarget;
                    lblFV.Text = strFV;

                    string strBook = _objOptions.LanguageBookShort(objProgram.Source);
                    string strPage = objProgram.Page;
                    lblComplexFormSource.Text = strBook + " " + strPage;
                    tipTooltip.SetToolTip(lblComplexFormSource, _objOptions.LanguageBookLong(objProgram.Source) + " " + LanguageManager.GetString("String_Page") + " " + objProgram.Page);
                }
            }
        }

        /// <summary>
        /// Populate the TreeView that contains all of the character's Gear.
        /// </summary>
        private void PopulateGearList()
        {
            // Populate Gear.
            // Create the root node.
            treGear.Nodes.Clear();
            TreeNode objRoot = new TreeNode();
            objRoot.Tag = "Node_SelectedGear";
            objRoot.Text = LanguageManager.GetString("Node_SelectedGear");
            treGear.Nodes.Add(objRoot);

            // Start by populating Locations.
            foreach (string strLocation in _objCharacter.Locations)
            {
                TreeNode objLocation = new TreeNode();
                objLocation.Tag = strLocation;
                objLocation.Text = strLocation;
                objLocation.ContextMenuStrip = cmsGearLocation;
                treGear.Nodes.Add(objLocation);
            }

            // Add Locations for the character's bits that can hold Commlinks.
            /* Populate the list of Commlink Locations.
            foreach (Cyberware objCyberware in _objCharacter.Cyberware)
            {
                if (objCyberware.AllowGear != null)
                {
                    if (objCyberware.AllowGear["gearcategory"] != null)
                    {
                        if (objCyberware.AllowGear["gearcategory"].InnerText == "Commlinks" || objCyberware.AllowGear["gearcategory"].InnerText == "Cyberdecks")
                        {
                            TreeNode objNode = new TreeNode();
                            objNode.Tag = objCyberware.InternalId.ToString();
                            objNode.Text = objCyberware.DisplayCategory + ": " + objCyberware.DisplayName;
                            bool blnFound = false;
                            foreach (string objLocation in _objCharacter.Locations)
                            {
                                if (objLocation == objNode.Text)
                                {
                                    blnFound = true;
                                }
                            }
                            if (!blnFound)
                            {
                                treGear.Nodes.Add(objNode);
                                _objCharacter.Locations.Add(objNode.Text);
                            }
                        }
                    }
                }
                foreach (Cyberware objPlugin in objCyberware.Children)
                {
                    if (objPlugin.AllowGear != null)
                    {
                        if (objPlugin.AllowGear["gearcategory"] != null)
                        {
                            TreeNode objNode = new TreeNode();
                            objNode.Tag = objPlugin.InternalId.ToString();
                            objNode.Text = objPlugin.DisplayCategory + ": " + objPlugin.DisplayName;
                            bool blnFound = false;
                            foreach (string objLocation in _objCharacter.Locations)
                            {
                                if (objLocation == objNode.Text)
                                {
                                    blnFound = true;
                                }
                            }
                            if (!blnFound)
                            {
                                treGear.Nodes.Add(objNode);
                                _objCharacter.Locations.Add(objNode.Text);
                            }
                        }
                    }
                }
            }
            foreach (Weapon objWeapon in _objCharacter.Weapons)
            {
                foreach (WeaponAccessory objAccessory in objWeapon.WeaponAccessories)
                {
                    if (objAccessory.AllowGear != null)
                    {
                        if (objAccessory.AllowGear["gearcategory"] != null)
                        {
                            if (objAccessory.AllowGear["gearcategory"].InnerText == "Commlinks" || objAccessory.AllowGear["gearcategory"].InnerText == "Cyberdecks")
                            {
                                TreeNode objNode = new TreeNode();
                                objNode.Tag = objAccessory.InternalId.ToString();
                                objNode.Text = objWeapon.DisplayName + ": " + objAccessory.DisplayName;
                                bool blnFound = false;
                                foreach (string objLocation in _objCharacter.Locations)
                                {
                                    if (objLocation == objNode.Text)
                                    {
                                        blnFound = true;
                                    }
                                }
                                if (!blnFound)
                                {
                                    _objCharacter.Locations.Add(objNode.Text);
                                    treGear.Nodes.Add(objNode);
                                }
                            }
                        }
                    }
                }
                foreach (Weapon objUnderbarrel in objWeapon.Children)
                {
                    foreach (WeaponAccessory objUnderbarrelAccessory in objUnderbarrel.WeaponAccessories)
                    {
                        if (objUnderbarrelAccessory.AllowGear != null)
                        {
                            if (objUnderbarrelAccessory.AllowGear["gearcategory"] != null)
                            {
                                if (objUnderbarrelAccessory.AllowGear["gearcategory"].InnerText == "Commlinks" || objUnderbarrelAccessory.AllowGear["gearcategory"].InnerText == "Cyberdecks")
                                {
                                    TreeNode objNode = new TreeNode();
                                    objNode.Tag = objUnderbarrelAccessory.InternalId.ToString();
                                    objNode.Text = objUnderbarrel.DisplayName + ": " + objUnderbarrelAccessory.DisplayName;
                                    bool blnFound = false;
                                    foreach (string objLocation in _objCharacter.Locations)
                                    {
                                        if (objLocation == objNode.Text)
                                        {
                                            blnFound = true;
                                        }
                                    }
                                    if (!blnFound)
                                    {
                                        _objCharacter.Locations.Add(objNode.Text);
                                        treGear.Nodes.Add(objNode);
                                    }
                                }
                            }
                        }
                    }
                }
            }*/

            foreach (Gear objGear in _objCharacter.Gear)
            {
                bool blnAdd = !(chkCommlinks.Checked && (objGear.Category != "Commlinks" && objGear.Category != "Cyberdecks"));

                if (blnAdd)
                {
                    TreeNode objNode = new TreeNode();
                    objNode.Text = objGear.DisplayName;
                    objNode.Tag = objGear.InternalId;
                    if (!string.IsNullOrEmpty(objGear.Notes))
                        objNode.ForeColor = Color.SaddleBrown;
                    else if (objGear.IncludedInParent)
                        objNode.ForeColor = SystemColors.GrayText;
                    objNode.ToolTipText = CommonFunctions.WordWrap(objGear.Notes, 100);
                    if (!string.IsNullOrEmpty(objGear.Notes))
                        objNode.ForeColor = Color.SaddleBrown;
                    else if (objGear.IncludedInParent)
                        objNode.ForeColor = SystemColors.GrayText;

                    CommonFunctions.BuildGearTree(objGear, objNode, cmsGear);

                    objNode.ContextMenuStrip = cmsGear;

                    TreeNode objParent = new TreeNode();
                    if (string.IsNullOrEmpty(objGear.Location))
                        objParent = treGear.Nodes[0];
                    else
                    {
                        foreach (TreeNode objFind in treGear.Nodes)
                        {
                            if (objFind.Text == objGear.Location)
                            {
                                objParent = objFind;
                                break;
                            }
                        }
                    }
                    objParent.Nodes.Add(objNode);
                    objParent.Expand();
                }
            }
        }

        /// <summary>
        /// Populate the TreeView that contains all of the character's Cyberware and Bioware.
        /// </summary>
        private void PopulateCyberware()
        {
            Guid sid = Guid.Parse("b57eadaa-7c3b-4b80-8d79-cbbd922c1196");
            foreach (Cyberware objCyberware in _objCharacter.Cyberware)
            {
                if (objCyberware.SourceID == sid)
                {
                    TreeNode nHole = new TreeNode(objCyberware.DisplayName);
                    nHole.Tag = objCyberware.InternalId;
                    treCyberware.Nodes.Add(nHole);
                }
                // Populate Cyberware.
                else if (objCyberware.SourceType == Improvement.ImprovementSource.Cyberware)
                {
                    CommonFunctions.BuildCyberwareTree(objCyberware, treCyberware.Nodes[0], cmsCyberware, cmsCyberwareGear);
                }
                // Populate Bioware.
                else if (objCyberware.SourceType == Improvement.ImprovementSource.Bioware)
                {
                    CommonFunctions.BuildCyberwareTree(objCyberware, treCyberware.Nodes[1], cmsCyberware, cmsCyberwareGear);
                }
            }
        }

        /// <summary>
        /// Create Cyberware from a Cyberware Suite.
        /// </summary>
        /// <param name="objXmlNode">XmlNode for the Cyberware to add.</param>
        /// <param name="objGrade">CyberwareGrade to add the item as.</param>
        /// <param name="intRating">Rating of the Cyberware.</param>
        /// <param name="blnAddToCharacter">Whether or not the Cyberware should be added directly to the character.</param>
        /// <param name="objParent">Parent Cyberware if the item is not being added directly to the character.</param>
        private TreeNode CreateSuiteCyberware(XmlNode objXmlItem, XmlNode objXmlNode, Grade objGrade, int intRating, bool blnAddToCharacter, Improvement.ImprovementSource objSource, string strType, Cyberware objParent = null)
        {
            // Create the Cyberware object.
            List<Weapon> objWeapons = new List<Weapon>();
            List<TreeNode> objWeaponNodes = new List<TreeNode>();
            List<Vehicle> objVehicles = new List<Vehicle>();
            List<TreeNode> objVehicleNodes = new List<TreeNode>();
            TreeNode objNode = new TreeNode();
            Cyberware objCyberware = new Cyberware(_objCharacter);
            string strForced = string.Empty;

            if (objXmlItem["name"].Attributes["select"] != null)
                strForced = objXmlItem["name"].Attributes["select"].InnerText;

            objCyberware.Create(objXmlNode, _objCharacter, objGrade, objSource, intRating, objNode, objWeapons, objWeaponNodes, objVehicles, objVehicleNodes, true, true, strForced);
            objCyberware.Suite = true;

            foreach (Weapon objWeapon in objWeapons)
                _objCharacter.Weapons.Add(objWeapon);

            foreach (TreeNode objWeaponNode in objWeaponNodes)
            {
                treWeapons.Nodes[0].Nodes.Add(objWeaponNode);
                treWeapons.Nodes[0].Expand();
            }

            foreach (Vehicle objVehicle in objVehicles)
                _objCharacter.Vehicles.Add(objVehicle);

            foreach (TreeNode objVehicleNode in objVehicleNodes)
            {
                treVehicles.Nodes[0].Nodes.Add(objVehicleNode);
                treVehicles.Nodes[0].Expand();
            }

            if (blnAddToCharacter)
                _objCharacter.Cyberware.Add(objCyberware);
            else
                objParent.Children.Add(objCyberware);

            foreach (XmlNode objXmlChild in objXmlItem.SelectNodes(strType + "s/" + strType))
            {
                XmlDocument objXmlDocument = XmlManager.Load(strType + ".xml");
                XmlNode objXmlChildCyberware = objXmlDocument.SelectSingleNode("/chummer/" + strType + "s/" + strType + "[name = \"" + objXmlChild["name"].InnerText + "\"]");
                TreeNode objChildNode = new TreeNode();
                int intChildRating = 0;

                if (objXmlChild["rating"] != null)
                    intChildRating = Convert.ToInt32(objXmlChild["rating"].InnerText);

                objChildNode = CreateSuiteCyberware(objXmlChild, objXmlChildCyberware, objGrade, intChildRating, false, objSource, strType, objCyberware);
                objNode.Nodes.Add(objChildNode);
                objNode.Expand();
            }

            return objNode;
        }

        private void AddCyberwareSuite(Improvement.ImprovementSource objSource)
        {
            frmSelectCyberwareSuite frmPickCyberwareSuite = new frmSelectCyberwareSuite(objSource, _objCharacter);
            frmPickCyberwareSuite.ShowDialog(this);

            if (frmPickCyberwareSuite.DialogResult == DialogResult.Cancel)
                return;

            decimal decCost = frmPickCyberwareSuite.TotalCost;
            if (decCost > _objCharacter.Nuyen)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughNuyen"), LanguageManager.GetString("MessageTitle_NotEnoughNuyen"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            else
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
                objExpense.Create(decCost * -1, LanguageManager.GetString("String_ExpensePurchaseCyberwareSuite") + " " + frmPickCyberwareSuite.SelectedSuite, ExpenseType.Nuyen, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objExpense);
                _objCharacter.Nuyen -= decCost;
            }

            string strType = string.Empty;
            int intParentNode = 0;
            if (objSource == Improvement.ImprovementSource.Cyberware)
            {
                strType = "cyberware";
                intParentNode = 0;
            }
            else
            {
                strType = "bioware";
                intParentNode = 1;
            }
            XmlDocument objXmlDocument = XmlManager.Load(strType + ".xml");

            XmlNode objXmlSuite = objXmlDocument.SelectSingleNode("/chummer/suites/suite[name = \"" + frmPickCyberwareSuite.SelectedSuite + "\"]");
            Grade objGrade = Cyberware.ConvertToCyberwareGrade(objXmlSuite["grade"].InnerText, objSource, _objCharacter.Options);

            // Run through each of the items in the Suite and add them to the character.
            foreach (XmlNode objXmlItem in objXmlSuite.SelectNodes(strType + "s/" + strType))
            {
                XmlNode objXmlCyberware = objXmlDocument.SelectSingleNode("/chummer/" + strType + "s/" + strType + "[name = \"" + objXmlItem["name"].InnerText + "\"]");
                TreeNode objNode = new TreeNode();
                int intRating = 0;

                if (objXmlItem["rating"] != null)
                    intRating = Convert.ToInt32(objXmlItem["rating"].InnerText);

                objNode = CreateSuiteCyberware(objXmlItem, objXmlCyberware, objGrade, intRating, true, objSource, strType, null);

                objNode.Expand();
                treCyberware.Nodes[intParentNode].Nodes.Add(objNode);
                treCyberware.Nodes[intParentNode].Expand();
            }

            RefreshSelectedCyberware();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
#endregion

        private void cmdAddLimitModifier_Click(object sender, EventArgs e)
        {
            if (treLimit.SelectedNode != null)
            {
                // Select the Limit node if we're currently on a child.
                if (treLimit.SelectedNode.Level > 1)
                    treLimit.SelectedNode = treLimit.SelectedNode.Parent;

                frmSelectLimitModifier frmPickLimitModifier = new frmSelectLimitModifier();
                frmPickLimitModifier.ShowDialog(this);

                if (frmPickLimitModifier.DialogResult == DialogResult.Cancel)
                    return;

                // Create the new limit modifier.
                TreeNode objNode = new TreeNode();
                LimitModifier objLimitModifier = new LimitModifier(_objCharacter);
                string strLimit = treLimit.SelectedNode.Text;
                string strCondition = frmPickLimitModifier.SelectedCondition;
                objLimitModifier.Create(frmPickLimitModifier.SelectedName, frmPickLimitModifier.SelectedBonus, strLimit, strCondition, objNode);
                if (objLimitModifier.InternalId == Guid.Empty.ToString())
                    return;

                objNode.ContextMenuStrip = cmsLimitModifier;
                _objCharacter.LimitModifiers.Add(objLimitModifier);

                treLimit.SelectedNode.Nodes.Add(objNode);
                treLimit.SelectedNode.Expand();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
            else
            {
                MessageBox.Show(LanguageManager.GetString("Message_SelectLimitModifier"), LanguageManager.GetString("MessageTitle_SelectLimitModifier"), MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void cmdDeleteLimitModifier_Click(object sender, EventArgs e)
        {
            if (treLimit.SelectedNode != null)
            {
                if (treLimit.SelectedNode.Level == 0)
                    return;

                LimitModifier objLimit = CommonFunctions.FindByIdWithNameCheck(treLimit.SelectedNode.Tag.ToString(), _objCharacter.LimitModifiers);
                if (objLimit == null)
                {
                    MessageBox.Show(LanguageManager.GetString("Message_CannotDeleteLimitModifier"), LanguageManager.GetString("MessageTitle_CannotDeleteLimitModifier"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteLimitModifier")))
                    return;

                string strLimit = treLimit.SelectedNode.Parent.Text;

                // Delete the selected Martial Art.
                LimitModifier objLimitModifier = CommonFunctions.FindByIdWithNameCheck(treLimit.SelectedNode.Tag.ToString(), _objCharacter.LimitModifiers);

                _objCharacter.LimitModifiers.Remove(objLimitModifier);
                treLimit.SelectedNode.Remove();

                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void tssLimitModifierNotes_Click(object sender, EventArgs e)
        {
            if (treLimit.SelectedNode != null)
            {
                LimitModifier obLimitModifier = CommonFunctions.FindByIdWithNameCheck(treLimit.SelectedNode.Tag.ToString(), _objCharacter.LimitModifiers);
                if (obLimitModifier != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = obLimitModifier.Notes;
                    string strOldValue = obLimitModifier.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        obLimitModifier.Notes = frmItemNotes.Notes;
                        if (obLimitModifier.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(obLimitModifier.Notes))
                        treLimit.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treLimit.SelectedNode.ForeColor = SystemColors.WindowText;
                    treLimit.SelectedNode.ToolTipText = CommonFunctions.WordWrap(obLimitModifier.Notes, 100);
                }
                else
                {
                    // the limit modifier has a source
                    foreach (Improvement objImprovement in _objCharacter.Improvements)
                    {
                        if (objImprovement.ImproveType == Improvement.ImprovementType.LimitModifier && objImprovement.SourceName == treLimit.SelectedNode.Tag.ToString())
                        {
                            frmNotes frmItemNotes = new frmNotes();
                            frmItemNotes.Notes = objImprovement.Notes;
                            string strOldValue = objImprovement.Notes;
                            frmItemNotes.ShowDialog(this);

                            if (frmItemNotes.DialogResult == DialogResult.OK)
                            {
                                objImprovement.Notes = frmItemNotes.Notes;
                                if (objImprovement.Notes != strOldValue)
                                {
                                    _blnIsDirty = true;
                                    UpdateWindowTitle();
                                }
                            }

                            if (!string.IsNullOrEmpty(objImprovement.Notes))
                                treLimit.SelectedNode.ForeColor = Color.SaddleBrown;
                            else
                                treLimit.SelectedNode.ForeColor = SystemColors.WindowText;
                            treLimit.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objImprovement.Notes, 100);
                        }
                    }
                }
            }
        }

        private void cmdIncreasePowerPoints_Click(object sender, EventArgs e)
        {
            // Make sure the character has enough Karma to improve the CharacterAttribute.
            int intKarmaCost = 5;
            if (intKarmaCost > _objCharacter.Karma)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (_objCharacter.MysticAdeptPowerPoints + 1 > _objCharacter.MAG.TotalValue)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughMagic"), LanguageManager.GetString("MessageTitle_NotEnoughMagic"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_PowerPoint")).Replace("{1}", (intKarmaCost).ToString())))
                return;

            // Create the Karma expense.
            ExpenseLogEntry objExpense = new ExpenseLogEntry(_objCharacter);
            objExpense.Create(intKarmaCost * -1, LanguageManager.GetString("String_PowerPoint"), ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objExpense);
            _objCharacter.Karma -= intKarmaCost;

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma(KarmaExpenseType.AddPowerPoint, string.Empty);
            objExpense.Undo = objUndo;

            _objCharacter.MysticAdeptPowerPoints += 1;

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsMetamagicAddMetamagic_Click(object sender, EventArgs e)
        {
            // Character can only have a number of Metamagics/Echoes equal to their Initiate Grade. Additional ones cost Karma.
            bool blnPayWithKarma = false;
            string strType = string.Empty;

            if (treMetamagic.SelectedNode.Level != 0)
                return;

            int intGrade = 0;
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                {
                    intGrade = objGrade.Grade;
                    break;
                }
            }

            // Evaluate each object 
            foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
            {
                if (objMetamagic.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            foreach (Spell objSpell in _objCharacter.Spells)
            {
                if (objSpell.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            // Additional Metamagics beyond the standard 1 per Grade cost additional Karma, so ask if the user wants to spend the additional Karma.
            if (blnPayWithKarma && _objCharacter.Karma < _objOptions.KarmaMetamagic)
            {
                // Make sure the Karma expense would not put them over the limit.
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (_objCharacter.MAGEnabled && blnPayWithKarma)
            {
                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_Metamagic")).Replace("{1}", _objOptions.KarmaMetamagic.ToString())))
                    return;
            }
            else if (blnPayWithKarma)
            {
                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_Echo")).Replace("{1}", _objOptions.KarmaMetamagic.ToString())))
                    return;
            }

            frmSelectMetamagic frmPickMetamagic = new frmSelectMetamagic(_objCharacter, _objCharacter.RESEnabled ? frmSelectMetamagic.Mode.Echo : frmSelectMetamagic.Mode.Metamagic);
            frmPickMetamagic.ShowDialog(this);

            // Make sure a value was selected.
            if (frmPickMetamagic.DialogResult == DialogResult.Cancel)
                return;

            string strMetamagic = frmPickMetamagic.SelectedMetamagic;

            XmlDocument objXmlDocument = null;
            XmlNode objXmlMetamagic;

            TreeNode objNode = new TreeNode();
            Metamagic objNewMetamagic = new Metamagic(_objCharacter);
            Improvement.ImprovementSource objSource;

            if (_objCharacter.MAGEnabled)
            {
                objXmlDocument = XmlManager.Load("metamagic.xml");
                objXmlMetamagic = objXmlDocument.SelectSingleNode("/chummer/metamagics/metamagic[name = \"" + strMetamagic + "\"]");
                objSource = Improvement.ImprovementSource.Metamagic;
            }
            else
            {
                objXmlDocument = XmlManager.Load("echoes.xml");
                objXmlMetamagic = objXmlDocument.SelectSingleNode("/chummer/echoes/echo[name = \"" + strMetamagic + "\"]");
                objSource = Improvement.ImprovementSource.Echo;
            }

            objNewMetamagic.Create(objXmlMetamagic, objNode, objSource);
            objNewMetamagic.Grade = intGrade;
            objNode.ContextMenuStrip = cmsInitiationNotes;
            if (objNewMetamagic.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.Metamagics.Add(objNewMetamagic);

            if (blnPayWithKarma)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(_objOptions.KarmaMetamagic * -1, strType + " " + frmPickMetamagic.SelectedMetamagic, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddMetamagic, objNewMetamagic.InternalId);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma -= _objOptions.KarmaMetamagic;
            }

            treMetamagic.SelectedNode.Nodes.Add(objNode);
            treMetamagic.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            if (frmPickMetamagic.AddAgain)
                cmdAddMetamagic_Click(sender, e);
        }

        private void tsMetamagicAddArt_Click(object sender, EventArgs e)
        {
            // Character can only have a number of Metamagics/Echoes equal to their Initiate Grade. Additional ones cost Karma.
            bool blnPayWithKarma = false;
            string strType = string.Empty;

            if (treMetamagic.SelectedNode.Level != 0)
                return;

            int intGrade = 0;
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                {
                    intGrade = objGrade.Grade;
                    break;
                }
            }

            if (blnPayWithKarma && _objCharacter.Karma < _objOptions.KarmaMetamagic)
            {
                // Make sure the Karma expense would not put them over the limit.
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            frmSelectArt frmPickArt = new frmSelectArt(_objCharacter, frmSelectArt.Mode.Art);
            frmPickArt.ShowDialog(this);

            // Make sure a value was selected.
            if (frmPickArt.DialogResult == DialogResult.Cancel)
                return;

            string strArt = frmPickArt.SelectedItem;

            XmlDocument objXmlDocument = XmlManager.Load("metamagic.xml");
            XmlNode objXmlArt = objXmlDocument.SelectSingleNode("/chummer/arts/art[name = \"" + strArt + "\"]");

            TreeNode objNode = new TreeNode();
            Art objArt = new Art(_objCharacter);
            Improvement.ImprovementSource objSource = Improvement.ImprovementSource.Metamagic;

            objArt.Create(objXmlArt, objNode, objSource);
            objArt.Grade = intGrade;
            objNode.ContextMenuStrip = cmsInitiationNotes;
            if (objArt.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.Arts.Add(objArt);

            if (blnPayWithKarma)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(_objOptions.KarmaMetamagic * -1, strType + " " + frmPickArt.SelectedItem, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddMetamagic, objArt.InternalId);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma -= _objOptions.KarmaMetamagic;
            }

            treMetamagic.SelectedNode.Nodes.Add(objNode);
            treMetamagic.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsMetamagicAddEnchantment_Click(object sender, EventArgs e)
        {
            // Character can only have a number of Metamagics/Echoes equal to their Initiate Grade. Additional ones cost Karma.
            bool blnPayWithKarma = false;
            string strType = string.Empty;

            if (treMetamagic.SelectedNode.Level != 0)
                return;

            int intGrade = 0;
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                {
                    intGrade = objGrade.Grade;
                    break;
                }
            }

            // Evaluate each object 
            foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
            {
                if (objMetamagic.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            foreach (Spell objSpell in _objCharacter.Spells)
            {
                if (objSpell.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            int intSpellKarmaCost = _objCharacter.SpellKarmaCost;
            if (blnPayWithKarma && _objCharacter.Karma < intSpellKarmaCost)
            {
                // Make sure the Karma expense would not put them over the limit.
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (blnPayWithKarma)
                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_Enchantment")).Replace("{1}", intSpellKarmaCost.ToString())))
                    return;

            frmSelectArt frmPickArt = new frmSelectArt(_objCharacter, frmSelectArt.Mode.Enchantment);
            frmPickArt.ShowDialog(this);

            // Make sure a value was selected.
            if (frmPickArt.DialogResult == DialogResult.Cancel)
                return;

            string strEnchantment = frmPickArt.SelectedItem;

            XmlDocument objXmlDocument = XmlManager.Load("spells.xml");
            XmlNode objXmlArt = objXmlDocument.SelectSingleNode("/chummer/spells/spell[name = \"" + strEnchantment + "\"]");

            TreeNode objNode = new TreeNode();
            Spell objNewSpell = new Spell(_objCharacter);
            Improvement.ImprovementSource objSource = Improvement.ImprovementSource.Initiation;

            objNewSpell.Create(objXmlArt, objNode, string.Empty, false, false, false, objSource);
            objNewSpell.Grade = intGrade;
            objNode.ContextMenuStrip = cmsInitiationNotes;
            if (objNewSpell.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.Spells.Add(objNewSpell);

            if (blnPayWithKarma)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(-intSpellKarmaCost, strType + " " + frmPickArt.SelectedItem, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddSpell, objNewSpell.InternalId);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma -= intSpellKarmaCost;
            }

            TreeNode objSpellNode = new TreeNode();
            objSpellNode.Text = objNode.Text;
            objSpellNode.Tag = objNode.Tag;

            string strCategory = string.Empty;
            if (objNewSpell.Category == "Rituals")
                strCategory = LanguageManager.GetString("Label_Ritual") + " ";
            if (objNewSpell.Category == "Enchantments")
                strCategory = LanguageManager.GetString("Label_Enchantment") + " ";
            objNode.Text = strCategory + objNode.Text;
            treMetamagic.SelectedNode.Nodes.Add(objNode);
            treMetamagic.SelectedNode.Expand();

            treSpells.Nodes[6].Nodes.Add(objSpellNode);
            treSpells.Nodes[6].Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsMetamagicAddRitual_Click(object sender, EventArgs e)
        {
            // Character can only have a number of Metamagics/Echoes equal to their Initiate Grade. Additional ones cost Karma.
            bool blnPayWithKarma = false;
            string strType = string.Empty;

            if (treMetamagic.SelectedNode.Level != 0)
                return;

            int intGrade = 0;
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                {
                    intGrade = objGrade.Grade;
                    break;
                }
            }

            // Evaluate each object 
            foreach (Metamagic objMetamagic in _objCharacter.Metamagics)
            {
                if (objMetamagic.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            foreach (Spell objSpell in _objCharacter.Spells)
            {
                if (objSpell.Grade == intGrade)
                    blnPayWithKarma = true;
            }

            int intSpellKarmaCost = _objCharacter.SpellKarmaCost;
            if (blnPayWithKarma && _objCharacter.Karma < intSpellKarmaCost)
            {
                // Make sure the Karma expense would not put them over the limit.
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (blnPayWithKarma)
                if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_Ritual")).Replace("{1}", intSpellKarmaCost.ToString())))
                    return;

            frmSelectArt frmPickArt = new frmSelectArt(_objCharacter, frmSelectArt.Mode.Ritual);
            frmPickArt.ShowDialog(this);

            // Make sure a value was selected.
            if (frmPickArt.DialogResult == DialogResult.Cancel)
                return;

            string strEnchantment = frmPickArt.SelectedItem;

            XmlDocument objXmlDocument = XmlManager.Load("spells.xml");
            XmlNode objXmlArt = objXmlDocument.SelectSingleNode("/chummer/spells/spell[name = \"" + strEnchantment + "\"]");

            TreeNode objNode = new TreeNode();
            Spell objNewSpell = new Spell(_objCharacter);
            Improvement.ImprovementSource objSource = Improvement.ImprovementSource.Initiation;

            objNewSpell.Create(objXmlArt, objNode, string.Empty, false, false, false, objSource);
            objNewSpell.Grade = intGrade;
            objNode.ContextMenuStrip = cmsInitiationNotes;
            if (objNewSpell.InternalId == Guid.Empty.ToString())
                return;

            _objCharacter.Spells.Add(objNewSpell);

            if (blnPayWithKarma)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(-intSpellKarmaCost, strType + " " + frmPickArt.SelectedItem, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddSpell, objNewSpell.InternalId);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma -= intSpellKarmaCost;
            }

            TreeNode objSpellNode = new TreeNode();
            objSpellNode.Text = objNode.Text;
            objSpellNode.Tag = objNode.Tag;

            string strCategory = string.Empty;
            if (objNewSpell.Category == "Rituals")
                strCategory = LanguageManager.GetString("Label_Ritual") + " ";
            if (objNewSpell.Category == "Enchantments")
                strCategory = LanguageManager.GetString("Label_Enchantment") + " ";
            objNode.Text = strCategory + objNode.Text;
            treMetamagic.SelectedNode.Nodes.Add(objNode);
            treMetamagic.SelectedNode.Expand();

            int intNode = 5;
            treSpells.Nodes[intNode].Nodes.Add(objSpellNode);
            treSpells.Nodes[intNode].Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void tsInitiationNotes_Click(object sender, EventArgs e)
        {
            if (treMetamagic.SelectedNode != null)
            {
                // Locate the selected Metamagic.
                Metamagic objMetamagic = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Metamagics);
                if (objMetamagic != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objMetamagic.Notes;
                    string strOldValue = objMetamagic.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objMetamagic.Notes = frmItemNotes.Notes;
                        if (objMetamagic.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objMetamagic.Notes))
                        treMetamagic.SelectedNode.ForeColor = Color.SaddleBrown;
                    else if (objMetamagic.Grade < 0)
                        treMetamagic.SelectedNode.ForeColor = SystemColors.GrayText;
                    else
                        treMetamagic.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMetamagic.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objMetamagic.Notes, 100);
                    return;
                }

                // Locate the selected Art.
                Art objArt = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Arts);
                if (objArt != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objArt.Notes;
                    string strOldValue = objArt.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objArt.Notes = frmItemNotes.Notes;
                        if (objArt.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objArt.Notes))
                        treMetamagic.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMetamagic.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMetamagic.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objArt.Notes, 100);
                    return;
                }

                // Locate the selected Spell.
                Spell objSpell = CommonFunctions.FindByIdWithNameCheck(treMetamagic.SelectedNode.Tag.ToString(), _objCharacter.Spells);
                if (objSpell != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objSpell.Notes;
                    string strOldValue = objSpell.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objSpell.Notes = frmItemNotes.Notes;
                        if (objSpell.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objSpell.Notes))
                        treMetamagic.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMetamagic.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMetamagic.SelectedNode.ToolTipText = objSpell.Notes;

                    foreach (TreeNode nodSchool in treSpells.Nodes)
                    {
                        foreach (TreeNode nodSpell in nodSchool.Nodes)
                        {
                            if (nodSpell.Tag.ToString() == treMetamagic.SelectedNode.Tag.ToString())
                            {
                                if (!string.IsNullOrEmpty(objSpell.Notes))
                                    nodSpell.ForeColor = Color.SaddleBrown;
                                else
                                    nodSpell.ForeColor = SystemColors.WindowText;
                                nodSpell.ToolTipText = CommonFunctions.WordWrap(objSpell.Notes, 100);
                            }
                        }
                }
            }
            }
        }

        private void tsMetamagicAddEnhancement_Click(object sender, EventArgs e)
        {
            bool blnPayWithKarma = false;
            string strType = string.Empty;

            if (treMetamagic.SelectedNode.Level != 0)
                return;

            int intGrade = 0;
            foreach (InitiationGrade objGrade in _objCharacter.InitiationGrades)
            {
                if (objGrade.InternalId == treMetamagic.SelectedNode.Tag.ToString())
                {
                    intGrade = objGrade.Grade;
                    break;
                }
            }

            blnPayWithKarma = true;
            if (blnPayWithKarma && _objCharacter.Karma < _objOptions.KarmaEnhancement)
            {
                // Make sure the Karma expense would not put them over the limit.
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", LanguageManager.GetString("String_Enhancement")).Replace("{1}", _objOptions.KarmaEnhancement.ToString())))
                return;

            frmSelectArt frmPickArt = new frmSelectArt(_objCharacter, frmSelectArt.Mode.Enhancement);
            frmPickArt.ShowDialog(this);

            // Make sure a value was selected.
            if (frmPickArt.DialogResult == DialogResult.Cancel)
                return;

            string strEnhancement = frmPickArt.SelectedItem;

            XmlDocument objXmlDocument = XmlManager.Load("powers.xml");
            XmlNode objXmlArt = objXmlDocument.SelectSingleNode("/chummer/enhancements/enhancement[name = \"" + strEnhancement + "\"]");

            TreeNode objNode = new TreeNode();
            Enhancement objEnhancement = new Enhancement(_objCharacter);
            Improvement.ImprovementSource objSource = Improvement.ImprovementSource.Initiation;

            // Find the associated Power
            string strPower = objXmlArt["power"].InnerText.ToString();

            objEnhancement.Create(objXmlArt, objNode, objSource);
            objEnhancement.Grade = intGrade;
            objNode.ContextMenuStrip = cmsInitiationNotes;
            if (objEnhancement.InternalId == Guid.Empty.ToString())
                return;

            Power objPower = new Power(_objCharacter);
            bool blnPowerFound = false;
            foreach (Power objExistingPower in _objCharacter.Powers)
            {
                if (objExistingPower.Name == strPower)
                {
                    objPower = objExistingPower;
                    objPower.Enhancements.Add(objEnhancement);
                    blnPowerFound = true;
                    break;
                }
            }

            if (!blnPowerFound)
            {
                // Add it to the character instead
                _objCharacter.Enhancements.Add(objEnhancement);
            }

            if (blnPayWithKarma)
            {
                // Create the Expense Log Entry.
                ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
                objEntry.Create(_objOptions.KarmaEnhancement * -1, strType + " " + frmPickArt.SelectedItem, ExpenseType.Karma, DateTime.Now);
                _objCharacter.ExpenseEntries.Add(objEntry);

                ExpenseUndo objUndo = new ExpenseUndo();
                objUndo.CreateKarma(KarmaExpenseType.AddSpell, objEnhancement.InternalId);
                objEntry.Undo = objUndo;

                // Adjust the character's Karma total.
                _objCharacter.Karma -= _objOptions.KarmaEnhancement;
            }

            treMetamagic.SelectedNode.Nodes.Add(objNode);
            treMetamagic.SelectedNode.Expand();

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void panContacts_Click(object sender, EventArgs e)
        {
            panContacts.Focus();
        }

        private void panEnemies_Click(object sender, EventArgs e)
        {
            panEnemies.Focus();
        }

        private void tsAddTechniqueNotes_Click(object sender, EventArgs e)
        {
            if (treMartialArts.SelectedNode != null)
            {
                MartialArtAdvantage objTechnique = CommonFunctions.FindMartialArtAdvantage(treMartialArts.SelectedNode.Tag.ToString(), _objCharacter.MartialArts);
                if (objTechnique != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objTechnique.Notes;
                    string strOldValue = objTechnique.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objTechnique.Notes = frmItemNotes.Notes;
                        if (objTechnique.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objTechnique.Notes))
                        treMartialArts.SelectedNode.ForeColor = Color.SaddleBrown;
                    else
                        treMartialArts.SelectedNode.ForeColor = SystemColors.WindowText;
                    treMartialArts.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objTechnique.Notes, 100);
                }
            }
        }

        private void cboDrain_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnLoading || string.IsNullOrEmpty(cboDrain.SelectedValue?.ToString()))
                return;

            _objCharacter.TraditionDrain = cboDrain.SelectedValue.ToString();

            CalculateTraditionDrain(_objCharacter.TraditionDrain, Improvement.ImprovementType.DrainResistance, lblDrainAttributes, lblDrainAttributesValue, tipTooltip);

            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void txtTraditionName_TextChanged(object sender, EventArgs e)
        {
            _objCharacter.TraditionName = txtTraditionName.Text;
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboSpiritCombat_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cboSpiritCombat.SelectedValue == null)
                return;
            if (_blnLoading || string.IsNullOrEmpty(cboSpiritCombat.SelectedValue.ToString()))
                return;

            _objCharacter.SpiritCombat = cboSpiritCombat.SelectedValue.ToString();
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboSpiritDetection_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cboSpiritDetection.SelectedValue == null)
                return;
            if (_blnLoading || string.IsNullOrEmpty(cboSpiritDetection.SelectedValue.ToString()))
                return;

            _objCharacter.SpiritDetection = cboSpiritDetection.SelectedValue.ToString();
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboSpiritHealth_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cboSpiritHealth.SelectedValue == null)
                return;
            if (_blnLoading || string.IsNullOrEmpty(cboSpiritHealth.SelectedValue.ToString()))
                return;

            _objCharacter.SpiritHealth = cboSpiritHealth.SelectedValue.ToString();
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboSpiritIllusion_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cboSpiritIllusion.SelectedValue == null)
                return;
            if (_blnLoading || string.IsNullOrEmpty(cboSpiritIllusion.SelectedValue.ToString()))
                return;

            _objCharacter.SpiritIllusion = cboSpiritIllusion.SelectedValue.ToString();
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboSpiritManipulation_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cboSpiritManipulation.SelectedValue == null)
                return;
            if (_blnLoading || string.IsNullOrEmpty(cboSpiritManipulation.SelectedValue.ToString()))
                return;

            _objCharacter.SpiritManipulation = cboSpiritManipulation.SelectedValue.ToString();
            foreach (SpiritControl objSpiritControl in panSpirits.Controls)
                objSpiritControl.RebuildSpiritList(cboTradition.SelectedValue.ToString());

            ScheduleCharacterUpdate();
            _blnIsDirty = true;
            UpdateWindowTitle(false);
        }

        private void cboGearOverclocker_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnLoading || !_objCharacter.Overclocker)
                return;
            Commlink objCommlink = CommonFunctions.FindCommlink(treGear.SelectedNode.Tag.ToString(), _objCharacter.Gear);
            objCommlink.Overclocked = cboGearOverclocker.SelectedValue.ToString();
            objCommlink.RefreshCommlinkCBOs(cboGearAttack, cboGearSleaze, cboGearDataProcessing, cboGearFirewall);
        }

        private void cboCyberwareGearOverclocker_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnLoading || !_objCharacter.Overclocker)
                return;
            List<Gear> lstGearToSearch = new List<Gear>(_objCharacter.Gear);
            foreach (Cyberware objCyberware in _objCharacter.Cyberware.DeepWhere(x => x.Children, x => x.Gear.Count > 0))
            {
                lstGearToSearch.AddRange(objCyberware.Gear);
            }
            Commlink objCommlink = CommonFunctions.FindCommlink(treCyberware.SelectedNode.Tag.ToString(), lstGearToSearch);
            objCommlink.Overclocked = cboCyberwareGearOverclocker.SelectedValue.ToString();
            objCommlink.RefreshCommlinkCBOs(cboCyberwareGearAttack, cboCyberwareGearSleaze, cboCyberwareGearDataProcessing, cboCyberwareGearFirewall);
        }

        private void tssLimitModifierEdit_Click(object sender, EventArgs e)
        {
            if (treLimit.SelectedNode.Level > 0)
            {
                UpdateLimitModifier(treLimit, cmsLimitModifier);
                _blnIsDirty = true;
                UpdateWindowTitle();
            }
        }

        private void chkShowFreeKarma_CheckedChanged(object sender, EventArgs e)
        {
            PopulateExpenseList();
        }

        private void chkShowFreeNuyen_CheckedChanged(object sender, EventArgs e)
        {
            PopulateExpenseList();
        }

        private void cmdAddAIProgram_Click(object sender, EventArgs e)
        {
            int intNewAIProgramCost = _objCharacter.AIProgramKarmaCost;
            int intNewAIAdvancedProgramCost = _objCharacter.AIAdvancedProgramKarmaCost;
            // Make sure the character has enough Karma before letting them select a Spell.
            if (_objCharacter.Karma < intNewAIProgramCost && _objCharacter.Karma < intNewAIAdvancedProgramCost)
            {
                MessageBox.Show(LanguageManager.GetString("Message_NotEnoughKarma"), LanguageManager.GetString("MessageTitle_NotEnoughKarma"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            // Let the user select a Program.
            frmSelectAIProgram frmPickProgram = new frmSelectAIProgram(_objCharacter, _objCharacter.Karma >= intNewAIAdvancedProgramCost);
            frmPickProgram.ShowDialog(this);

            // Make sure the dialogue window was not canceled.
            if (frmPickProgram.DialogResult == DialogResult.Cancel)
                return;

            XmlDocument objXmlDocument = XmlManager.Load("programs.xml");

            XmlNode objXmlProgram = objXmlDocument.SelectSingleNode("/chummer/programs/program[name = \"" + frmPickProgram.SelectedProgram + "\"]");
            bool boolIsAdvancedProgram = objXmlProgram["category"].InnerText == "Advanced Programs";

            // Check for SelectText.
            string strExtra = string.Empty;
            if (objXmlProgram["bonus"] != null)
            {
                if (objXmlProgram["bonus"]["selecttext"] != null)
                {
                    frmSelectText frmPickText = new frmSelectText();
                    frmPickText.Description = LanguageManager.GetString("String_Improvement_SelectText").Replace("{0}", frmPickProgram.SelectedProgram);
                    frmPickText.ShowDialog(this);
                    strExtra = frmPickText.SelectedValue;
                }
            }


            TreeNode objNode = new TreeNode();
            AIProgram objProgram = new AIProgram(_objCharacter);
            objProgram.Create(objXmlProgram, objNode, boolIsAdvancedProgram, strExtra);
            if (objProgram.InternalId == Guid.Empty.ToString())
                return;

            if (!ConfirmKarmaExpense(LanguageManager.GetString("Message_ConfirmKarmaExpenseSpend").Replace("{0}", objProgram.DisplayName).Replace("{1}", (boolIsAdvancedProgram ? intNewAIAdvancedProgramCost : intNewAIProgramCost).ToString())))
                return;

            _objCharacter.AIPrograms.Add(objProgram);
            objNode.Text = objProgram.DisplayName;
            objNode.Tag = objProgram.InternalId;
            if (!string.IsNullOrEmpty(objProgram.Notes))
                objNode.ForeColor = Color.SaddleBrown;
            else if (!objProgram.CanDelete)
                objNode.ForeColor = SystemColors.GrayText;
            else
                objNode.ForeColor = SystemColors.WindowText;
            objNode.ToolTipText = CommonFunctions.WordWrap(objProgram.Notes, 100);
            objNode.ContextMenuStrip = cmsAdvancedProgram;
            treAIPrograms.Nodes[0].Nodes.Add(objNode);
            treAIPrograms.Nodes[0].Expand();

            // Create the Expense Log Entry.
            ExpenseLogEntry objEntry = new ExpenseLogEntry(_objCharacter);
            objEntry.Create((boolIsAdvancedProgram ? intNewAIAdvancedProgramCost : intNewAIProgramCost) * -1, LanguageManager.GetString("String_ExpenseLearnProgram") + " " + objProgram.Name, ExpenseType.Karma, DateTime.Now);
            _objCharacter.ExpenseEntries.Add(objEntry);
            _objCharacter.Karma -= (boolIsAdvancedProgram ? intNewAIAdvancedProgramCost : intNewAIProgramCost);

            ExpenseUndo objUndo = new ExpenseUndo();
            objUndo.CreateKarma((boolIsAdvancedProgram ? KarmaExpenseType.AddAIAdvancedProgram : KarmaExpenseType.AddAIProgram), objProgram.InternalId);
            objEntry.Undo = objUndo;

            treAIPrograms.SortCustom();
            ScheduleCharacterUpdate();

            _blnIsDirty = true;
            UpdateWindowTitle();

            /*
            int intComplexForms = 0;
            foreach (ComplexForm tp in _objCharacter.ComplexForms)
            {
                intComplexForms++;
            }

            //if (_objCharacter.CFPLimit - intComplexForms < 0)
            //    lblPBuildComplexForms.Text = String.Format("{0} " + LanguageManager.GetString("String_Of") + " {1}", (0).ToString(), _objCharacter.CFPLimit.ToString());
            //else
            lblPBuildComplexForms.Text = String.Format("{0} " + LanguageManager.GetString("String_Of") + " {1}", (_objCharacter.CFPLimit - intComplexForms).ToString(), _objCharacter.CFPLimit.ToString());
            */

            if (frmPickProgram.AddAgain)
                cmdAddAIProgram_Click(sender, e);
        }

        private void cmdDeleteAIProgram_Click(object sender, EventArgs e)
        {
            // Delete the selected AI Program.
            if (treAIPrograms.SelectedNode != null)
            {
                if (treAIPrograms.SelectedNode.Level == 1)
                {
                    // Locate the Program that is selected in the tree.
                    AIProgram objProgram = CommonFunctions.FindByIdWithNameCheck(treAIPrograms.SelectedNode.Tag.ToString(), _objCharacter.AIPrograms);

                    if (objProgram != null && objProgram.CanDelete)
                    {
                        if (!CommonFunctions.ConfirmDelete(_objCharacter, LanguageManager.GetString("Message_DeleteAIProgram")))
                            return;

                        ImprovementManager.RemoveImprovements(_objCharacter, Improvement.ImprovementSource.AIProgram, objProgram.InternalId);

                        _objCharacter.AIPrograms.Remove(objProgram);
                        treAIPrograms.SelectedNode.Remove();
                        /*
                        int intComplexForms = 0;
                        foreach (ComplexForm tp in _objCharacter.ComplexForms)
                        {
                            intComplexForms++;
                        }
                        lblPBuildComplexForms.Text = String.Format("{0} " + LanguageManager.GetString("String_Of") + " {1}", (_objCharacter.CFPLimit - intComplexForms).ToString(), _objCharacter.CFPLimit.ToString());
                        */

                        ScheduleCharacterUpdate();

                        _blnIsDirty = true;
                        UpdateWindowTitle();
                    }
                }
            }
        }

        private void treAIPrograms_AfterSelect(object sender, TreeViewEventArgs e)
        {
            if (treAIPrograms.SelectedNode != null)
            {
                if (treAIPrograms.SelectedNode.Level == 1)
                {
                    // Locate the Program that is selected in the tree.
                    AIProgram objProgram = CommonFunctions.FindByIdWithNameCheck(treAIPrograms.SelectedNode.Tag.ToString(), _objCharacter.AIPrograms);

                    if (objProgram != null)
                    {
                        string strRequires = objProgram.DisplayRequiresProgram;

                        lblAIProgramsRequires.Text = strRequires;

                        string strBook = _objOptions.LanguageBookShort(objProgram.Source);
                        string strPage = objProgram.Page;
                        lblAIProgramsSource.Text = strBook + " " + strPage;
                        tipTooltip.SetToolTip(lblAIProgramsSource, _objOptions.LanguageBookLong(objProgram.Source) + " " + LanguageManager.GetString("String_Page") + " " + objProgram.Page);
                    }
                }
            }
        }

        private void treAIPrograms_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                cmdDeleteAIProgram_Click(sender, e);
            }
        }

        private void tsAIProgramNotes_Click(object sender, EventArgs e)
        {
            if (treAIPrograms.SelectedNode != null)
            {
                AIProgram objAIProgram = CommonFunctions.FindByIdWithNameCheck(treAIPrograms.SelectedNode.Tag.ToString(), _objCharacter.AIPrograms);
                if (objAIProgram != null)
                {
                    frmNotes frmItemNotes = new frmNotes();
                    frmItemNotes.Notes = objAIProgram.Notes;
                    string strOldValue = objAIProgram.Notes;
                    frmItemNotes.ShowDialog(this);

                    if (frmItemNotes.DialogResult == DialogResult.OK)
                    {
                        objAIProgram.Notes = frmItemNotes.Notes;
                        if (objAIProgram.Notes != strOldValue)
                        {
                            _blnIsDirty = true;
                            UpdateWindowTitle();
                        }
                    }

                    if (!string.IsNullOrEmpty(objAIProgram.Notes))
                        treAIPrograms.SelectedNode.ForeColor = Color.SaddleBrown;
                    else if (!objAIProgram.CanDelete)
                        treAIPrograms.SelectedNode.ForeColor = SystemColors.GrayText;
                    else
                        treAIPrograms.SelectedNode.ForeColor = SystemColors.WindowText;
                    treAIPrograms.SelectedNode.ToolTipText = CommonFunctions.WordWrap(objAIProgram.Notes, 100);
                }
            }
        }

        private void cboPrimaryArm_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_blnLoading) return;
            _objCharacter.PrimaryArm = cboPrimaryArm.SelectedValue.ToString();
        }

        private void BuildAttributePanel()
        {
			pnlAttributes.Controls.Clear();
            lstPrimaryAttributes.Clear();
            lstSpecialAttributes.Clear();
            lstPrimaryAttributes.Add(_objCharacter.BOD);
            lstPrimaryAttributes.Add(_objCharacter.AGI);
            lstPrimaryAttributes.Add(_objCharacter.REA);
            lstPrimaryAttributes.Add(_objCharacter.STR);
            lstPrimaryAttributes.Add(_objCharacter.CHA);
            lstPrimaryAttributes.Add(_objCharacter.INT);
            lstPrimaryAttributes.Add(_objCharacter.LOG);
            lstPrimaryAttributes.Add(_objCharacter.WIL);

            lstSpecialAttributes.Add(_objCharacter.EDG);
            if (_objCharacter.MAGEnabled)
            {
                lstSpecialAttributes.Add(_objCharacter.MAG);
                if (_objOptions.MysAdeptSecondMAGAttribute && _objCharacter.IsMysticAdept)
                    lstSpecialAttributes.Add(_objCharacter.MAGAdept);
            }
            if (_objCharacter.RESEnabled)
            {
                lstSpecialAttributes.Add(_objCharacter.RES);
            }
            if (_objCharacter.Metatype == "A.I.")
            {
                lstSpecialAttributes.Add(_objCharacter.DEP);
            }
        }

        private void picMugshot_SizeChanged(object sender, EventArgs e)
        {
            if (picMugshot.Image != null && picMugshot.Height >= picMugshot.Image.Height && picMugshot.Width >= picMugshot.Image.Width)
                picMugshot.SizeMode = PictureBoxSizeMode.CenterImage;
            else
                picMugshot.SizeMode = PictureBoxSizeMode.Zoom;
        }

        private void cmdCyberwareChangeMount_Click(object sender, EventArgs e)
        {
            if (treCyberware.SelectedNode == null)
                return;
            Cyberware objModularCyberware = CommonFunctions.DeepFindById(treCyberware.SelectedNode.Tag.ToString(), _objCharacter.Cyberware);
            if (objModularCyberware == null)
                return;
            frmSelectItem frmPickMount = new frmSelectItem();
            frmPickMount.GeneralItems = CommonFunctions.ConstructModularCyberlimbList(_objCharacter, objModularCyberware);
            frmPickMount.Description = LanguageManager.GetString("MessageTitle_SelectCyberware");
            frmPickMount.ShowDialog();

            // Make sure the dialogue window was not canceled.
            if (frmPickMount.DialogResult == DialogResult.Cancel)
            {
                return;
            }

            if (objModularCyberware.Parent != null)
                objModularCyberware.ChangeModularEquip(false);
            string strSelectedParentID = frmPickMount.SelectedItem;
            if (strSelectedParentID == "None")
            {
                CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, _objCharacter.Cyberware, treCyberware.Nodes[0], treCyberware);
                objModularCyberware.Parent = null;
            }
            else
            {
                Cyberware objNewParent = CommonFunctions.DeepFindById(strSelectedParentID, _objCharacter.Cyberware);
                TreeNode objNewNode = CommonFunctions.FindNode(strSelectedParentID, treCyberware);
                if (objNewParent != null && objNewNode != null)
                {
                    CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, objNewParent.Children, objNewNode, treCyberware);
                    objModularCyberware.Parent = objNewParent;
                    objModularCyberware.ChangeModularEquip(true);
                }
                else
                {
                    VehicleMod objNewVehicleModParent = CommonFunctions.FindVehicleMod(strSelectedParentID, _objCharacter.Vehicles);
                    if (objNewVehicleModParent == null)
                        objNewParent = CommonFunctions.FindVehicleCyberware(strSelectedParentID, _objCharacter.Vehicles, out objNewVehicleModParent);
                    else
                        objNewParent = null;
                    objNewNode = CommonFunctions.FindNode(strSelectedParentID, treVehicles);
                    if ((objNewVehicleModParent != null || objNewParent != null) && objNewNode != null)
                    {
                        CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, objNewParent == null ? objNewVehicleModParent.Cyberware : objNewParent.Children, objNewNode, treCyberware);
                        objModularCyberware.Parent = objNewParent;
                        RefreshSelectedVehicle();
                    }
                    else
                    {
                        CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, _objCharacter.Cyberware, treCyberware.Nodes[0], treCyberware);
                        objModularCyberware.Parent = null;
                    }
                }
            }

            ScheduleCharacterUpdate();
            RefreshSelectedCyberware();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }

        private void cmdVehicleCyberwareChangeMount_Click(object sender, EventArgs e)
        {
            if (treVehicles.SelectedNode == null)
                return;
            Cyberware objModularCyberware = CommonFunctions.FindVehicleCyberware(treVehicles.SelectedNode.Tag.ToString(), _objCharacter.Vehicles);
            if (objModularCyberware == null)
                return;
            frmSelectItem frmPickMount = new frmSelectItem();
            frmPickMount.GeneralItems = CommonFunctions.ConstructModularCyberlimbList(_objCharacter, objModularCyberware);
            frmPickMount.Description = LanguageManager.GetString("MessageTitle_SelectCyberware");
            frmPickMount.ShowDialog();

            // Make sure the dialogue window was not canceled.
            if (frmPickMount.DialogResult == DialogResult.Cancel)
            {
                return;
            }

            if (objModularCyberware.Parent != null)
                objModularCyberware.ChangeModularEquip(false);
            string strSelectedParentID = frmPickMount.SelectedItem;
            if (strSelectedParentID == "None")
            {
                CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, _objCharacter.Cyberware, treCyberware.Nodes[0], treVehicles);
                objModularCyberware.Parent = null;
                RefreshSelectedCyberware();
            }
            else
            {
                Cyberware objNewParent = CommonFunctions.DeepFindById(strSelectedParentID, _objCharacter.Cyberware);
                TreeNode objNewNode = CommonFunctions.FindNode(strSelectedParentID, treCyberware);
                if (objNewParent != null && objNewNode != null)
                {
                    CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, objNewParent.Children, objNewNode, treVehicles);
                    objModularCyberware.Parent = objNewParent;
                    objModularCyberware.ChangeModularEquip(true);
                    RefreshSelectedCyberware();
                }
                else
                {
                    VehicleMod objNewVehicleModParent = CommonFunctions.FindVehicleMod(strSelectedParentID, _objCharacter.Vehicles);
                    if (objNewVehicleModParent == null)
                        objNewParent = CommonFunctions.FindVehicleCyberware(strSelectedParentID, _objCharacter.Vehicles, out objNewVehicleModParent);
                    else
                        objNewParent = null;
                    objNewNode = CommonFunctions.FindNode(strSelectedParentID, treVehicles);
                    if ((objNewVehicleModParent != null || objNewParent != null) && objNewNode != null)
                    {
                        CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, objNewParent == null ? objNewVehicleModParent.Cyberware : objNewParent.Children, objNewNode, treVehicles);
                        objModularCyberware.Parent = objNewParent;
                    }
                    else
                    {
                        CommonFunctions.MoveCyberwareNode(_objCharacter, int.MaxValue, _objCharacter.Cyberware, treCyberware.Nodes[0], treVehicles);
                        objModularCyberware.Parent = null;
                        RefreshSelectedCyberware();
                    }
                }
            }

            ScheduleCharacterUpdate();
            RefreshSelectedVehicle();

            _blnIsDirty = true;
            UpdateWindowTitle();
        }
        private void cboAttributeCategory_SelectedIndexChanged(object sender, EventArgs e)
        {
            _objCharacter.AttributeSection.AttributeCategory = _objCharacter.AttributeSection.ConvertAttributeCategory(cboAttributeCategory.SelectedValue.ToString());
            _objCharacter.AttributeSection.ForceAttributePropertyChangedNotificationAll(nameof(CharacterAttrib.TotalAugmentedMaximum));
            _objCharacter.AttributeSection.ResetBindings();

            objAttribute_ValueChanged(null, null);
        }
    }
}
